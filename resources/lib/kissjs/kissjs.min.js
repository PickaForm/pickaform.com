const kiss={$KissJS:"KissJS - Keep It Simple Stupid Javascript",version:4605,isClient:true,db:{},ux:{},doc:{},app:{},acl:{},ajax:{},cache:{},tools:{},views:{},theme:{},global:{},fields:{},screen:{},router:{},loader:{},pubsub:{},plugins:{},context:{},session:{},formula:{},undoRedo:{},webfonts:{},language:{},directory:{},selection:{},templates:{},websocket:{},loadingSpinner:{},lib:{formula:{}},addToModule(moduleName,methods){Object.assign(kiss[moduleName],methods)},ui:{},ux:{},data:{Model:{},Collection:{},Record:{},Transaction:{},trash:{},addMethodToAllModels(methodName,method){Object.values(kiss.data.Record).forEach((recordClass=>{recordClass.prototype[methodName]=method}))},addPropertyToAllModels(propertyName,getter){Object.values(kiss.data.Record).forEach((recordClass=>{Object.defineProperty(recordClass.prototype,propertyName,{get:function(){try{return getter(this)}catch(err){log("kiss.data.Model - addPropertyToAllModels",4,err);return"Formula error"}},set:function(value){try{this.value=value}catch(err){log("kiss.data.Model - addPropertyToAllModels",4,err)}},configurable:true})}))}},loader:{core:{scripts:["modules/dataTrash","modules/ajax","modules/context","modules/session","modules/fields","modules/acl","modules/undoRedo","modules/directory","modules/pubsub","modules/websocket","modules/router","modules/views","modules/theme","modules/language","modules/plugins","modules/selection","modules/screen","modules/webfonts"]},db:{scripts:["db/offline","db/memory","db/online","db/faker"]},models:{scripts:["account","apiClient","file","group","link","trash","user","view"]},ui:{scripts:["containers/block","containers/panel","data/datatable","data/calendar","data/kanban","data/gallery","data/timeline","data/mapview","data/chartview","data/dashboard","elements/spacer","elements/html","elements/image","elements/button","elements/menu","elements/tip","elements/notification","elements/dialog","fields/field","fields/checkbox","fields/rating","fields/slider","fields/select","fields/icon","fields/iconPicker","fields/color","fields/colorPicker","fields/attachment","form/form","form/formTabBar","form/formActions","form/formSideBar","form/formContent","form/formFeatureDescription","helpers/data/dataFilter","helpers/data/dataFilterGroup","helpers/data/dataFilterWindow","helpers/data/dataSort","helpers/data/dataSortWindow","helpers/data/dataFieldsWindow","helpers/data/recordSelectionWindow","helpers/files/fileUploadLocal","helpers/files/fileUploadLink","helpers/files/fileUploadDropbox","helpers/files/fileUploadBox","helpers/files/fileUploadGoogleDrive","helpers/files/fileUploadOneDrive","helpers/files/fileUploadInstagram","helpers/files/fileUploadTakePhoto","helpers/files/fileUploadinstagramSession","helpers/files/fileUploadBoxSession","helpers/files/fileUploadWebSearch","helpers/files/fileUploadWindow","helpers/files/filePreviewWindow","helpers/files/fileLibraryWindow","views/common/matrix","views/authentication/error","views/authentication/invite","views/authentication/login","views/authentication/register","views/authentication/resetPassword","views/authentication/templates"],styles:["styles/base","styles/colors/light","styles/geometry/default","styles/animations/animate","abstract/component","abstract/dataComponent","containers/block","containers/panel","data/datatable","data/calendar","data/kanban","data/gallery","data/timeline","data/mapview","data/chartview","data/dashboard","elements/button","elements/html","elements/image","elements/menu","elements/tip","elements/notification","elements/dialog","fields/field","fields/checkbox","fields/rating","fields/slider","fields/select","fields/icon","fields/iconPicker","fields/color","fields/colorPicker","fields/attachment","form/form","helpers/data/dataSort","helpers/data/dataFilter","helpers/data/dataFilterGroup","helpers/data/dataFieldsWindow","helpers/files/fileUpload","helpers/files/filePreviewWindow","views/authentication/styles"]},ux:{scripts:["aiImage/aiImage","aiTextarea/aiTextarea","chart/chart","codeEditor/codeEditor","directory/directory","link/link","map/map","mapField/mapField","qrcode/qrcode","richTextField/richTextField","selectViewColumn/selectViewColumn","selectViewColumns/selectViewColumns","wizardPanel/wizardPanel"],styles:["codeEditor/codeEditor","directory/directory","link/link","map/map","mapField/mapField","richTextField/richTextField"]},loadScript(path,config={}){return new Promise((function(resolve,reject){const script=document.createElement("script");script.type="text/javascript";script.async=true;const autoAddExtension=config.autoAddExtension===false?"":".js";script.src=path+autoAddExtension+"?build="+kiss.version;if(config.options){Object.keys(config.options).forEach((key=>{script.setAttribute(key,config.options[key])}))}const head=document.getElementsByTagName("head")[0];head.appendChild(script);script.onload=resolve;script.onerror=reject}))},loadStyle(path){return new Promise((function(resolve,reject){const style=document.createElement("link");style.rel="stylesheet";style.type="text/css";style.async=true;style.href=path+".css?build="+kiss.version;const head=document.getElementsByTagName("head")[0];head.appendChild(style);style.onload=resolve;style.onerror=reject}))},async loadScripts(paths){await Promise.allSettled(paths.map(kiss.loader.loadScript))},async loadStyles(paths){await Promise.allSettled(paths.map(kiss.loader.loadStyle))},async loadLibrary(config={}){const useDb=config.useDb===false?false:true;const useUx=config.useUx===false?false:true;const libraryPath=kiss.loader.getLibraryPath();await kiss.loader.loadScript(libraryPath+"/core/modules/app");await kiss.loader.loadScript(libraryPath+"/ui/abstract/component");await kiss.loader.loadScript(libraryPath+"/ui/abstract/container");await kiss.loader.loadScript(libraryPath+"/ui/abstract/dataComponent");if(useDb){await kiss.loader.loadScript(libraryPath+"/core/db/nedb");await kiss.loader.loadScript(libraryPath+"/core/db/api")}await kiss.loader.loadScript(libraryPath+"/core/modules/logger");await kiss.loader.loadScript(libraryPath+"/core/modules/tools");await kiss.loader.loadScript(libraryPath+"/core/modules/loadingSpinner");await kiss.loader.loadScript(libraryPath+"/../common/global");await kiss.loader.loadScript(libraryPath+"/../common/prototypes");await kiss.loader.loadScript(libraryPath+"/../common/formula");await kiss.loader.loadScript(libraryPath+"/../common/formulaParser");await kiss.loader.loadScript(libraryPath+"/../common/formulaParserOperators");await kiss.loader.loadScript(libraryPath+"/../common/tools");if(useDb){await kiss.loader.loadScript(libraryPath+"/../common/dataModel");await kiss.loader.loadScript(libraryPath+"/../common/dataRecord");await kiss.loader.loadScript(libraryPath+"/../common/dataCollection");await kiss.loader.loadScript(libraryPath+"/../common/dataRelations");await kiss.loader.loadScript(libraryPath+"/../common/dataTransaction")}const dbScripts=useDb?kiss.loader.db.scripts.map((path=>libraryPath+"/core/"+path)):[];const coreScripts=kiss.loader.core.scripts.map((path=>libraryPath+"/core/"+path));const uiScripts=kiss.loader.ui.scripts.map((path=>libraryPath+"/ui/"+path));const styles=kiss.loader.ui.styles.map((path=>libraryPath+"/ui/"+path));const models=kiss.loader.models.scripts.map((path=>libraryPath+"/../common/models/"+path));try{await Promise.all([kiss.loader.loadScripts(dbScripts),kiss.loader.loadScripts(coreScripts),kiss.loader.loadScripts(uiScripts),kiss.loader.loadScripts(models),kiss.loader.loadStyles(styles)]);if(useUx){const uxScripts=kiss.loader.ux.scripts.map((path=>libraryPath+"/ux/"+path));const uxStyles=kiss.loader.ux.styles.map((path=>libraryPath+"/ux/"+path));await Promise.all([kiss.loader.loadScripts(uxScripts),kiss.loader.loadStyles(uxStyles)])}await kiss.language.init(true)}catch(err){console.log("kiss.loader - loadLibrary",4,err)}},getLibraryPath(){let libraryPath="";const scripts=document.getElementsByTagName("script");for(let script of scripts){if(script.src&&(script.src.includes("kissjs.min.js")||script.src.includes("kissjs.js"))){libraryPath=script.src.substring(0,script.src.lastIndexOf("/"));break}else if(script.src.includes("kiss.js")){libraryPath=script.src.substring(0,script.src.lastIndexOf("/core"));break}}return libraryPath}},serviceWorker:{serviceWorkerFile:"./serviceWorker.js",setFile(path){if(!path)return;kiss.serviceWorker.serviceWorkerFile=path;return kiss.serviceWorker},async init(){if("serviceWorker"in navigator){try{const registration=await navigator.serviceWorker.register(kiss.serviceWorker.serviceWorkerFile);log("kiss.serviceWorker - Registered with scope",1,registration.scope)}catch(err){log("kiss.serviceWorker - Registration failed",3,err)}}}}};kiss.db={memory:{},offline:{},online:{},faker:{},mode:"online",setMode(mode){if(!mode)return;if(mode!="memory"&&mode!="offline"&&mode!="online")return;kiss.db.mode=mode;for(modelId in kiss.app.models){const model=kiss.app.models[modelId];model.mode=mode;model.db=kiss.db[mode]}for(modelId in kiss.app.collections){const collection=kiss.app.collections[modelId];collection.mode=mode;collection.db=kiss.db[mode]}},async insertOne(modelId,record){return await kiss.db[this.mode].insertOne(modelId,record)},async insertMany(modelId,records){return await kiss.db[this.mode].insertMany(modelId,records)},async insertFakeRecords(modelId,fields,numberOfRecords){let records=kiss.db.faker.generate(fields,numberOfRecords);return await kiss.db[this.mode].insertMany(modelId,records)},async deleteFakeRecords(modelId){return await kiss.db[this.mode].deleteMany(modelId,{isFake:true})},async updateOne(modelId,recordId,update){return await kiss.db[this.mode].updateOne(modelId,recordId,update)},async updateOneDeep(modelId,recordId,update){return await kiss.db[this.mode].updateOneDeep(modelId,recordId,update)},async updateLink(link){return await kiss.db[this.mode].updateLink(link)},async updateMany(modelId,query,update){return await kiss.db[this.mode].updateMany(modelId,query,update)},async updateBulk(operations=[]){if(operations.length==0)return false;return await kiss.db[this.mode].updateBulk(operations)},async findOne(modelId,recordId){return await kiss.db[this.mode].findOne(modelId,recordId)},async findById(modelId,ids,sort=[],sortSyntax="normalized"){return await kiss.db[this.mode].findById(modelId,ids,sort,sortSyntax)},async find(modelId,query){if(!query)return await kiss.db[this.mode].find(modelId);let search={operation:"search",filter:query.filter||{},filterSyntax:query.filterSyntax||"normalized",sort:query.sort||{},sortSyntax:query.sortSyntax||"normalized",group:query.group||[],projection:query.projection||{},skip:query.skip,limit:query.limit,groupUnwind:query.groupUnwind};return await kiss.db[this.mode].find(modelId,search)},async deleteOne(modelId,recordId,sendToTrash){return await kiss.db[this.mode].deleteOne(modelId,recordId,sendToTrash)},async deleteMany(modelId,query,sendToTrash){return await kiss.db[this.mode].deleteMany(modelId,query,sendToTrash)},async count(modelId,query){return await kiss.db[this.mode].count(modelId,query)},mongo:{convertSort(sortArray){let mongoSort={};for(let i=0,length=sortArray.length;i<length;i++){let sortOption=sortArray[i];let sortField=Object.keys(sortOption)[0];let sortDirection=sortOption[sortField];mongoSort[sortField]=sortDirection=="asc"?1:-1}return mongoSort},convertFilter(filterConfig){let query={};let filter={};Object.assign(filter,filterConfig);let isUserTest;if(filter.value=="$userId"){isUserTest=true;filter.value=kiss.session.getACL()}else if(filter.value=="$today"){filter.value=kiss.formula.TODAY()}else if(filter.fieldType=="date"){if(filter.dateOperator=="today"){filter.value=kiss.formula.TODAY()}else if(filter.dateOperator=="days from now"){const today=new Date;const adjustedDate=kiss.formula.ADJUST_DATE(today,0,0,filter.value);filter.value=adjustedDate}else if(filter.dateOperator=="days ago"){const today=new Date;const adjustedDate=kiss.formula.ADJUST_DATE(today,0,0,-filter.value);filter.value=adjustedDate}}switch(filter.operator){case"=":if(!isUserTest){query[filter.fieldId]=filter.value}else{query[filter.fieldId]={$in:filter.value}}break;case"<>":if(!isUserTest){query[filter.fieldId]={$ne:filter.value}}else{query[filter.fieldId]={$nin:filter.value}}break;case"<":query[filter.fieldId]={$lt:filter.value};break;case">":query[filter.fieldId]={$gt:filter.value};break;case"<=":query[filter.fieldId]={$lte:filter.value};break;case">=":query[filter.fieldId]={$gte:filter.value};break;case"contains":if(!isUserTest){query[filter.fieldId]=new RegExp(filter.value,"i")}else{query[filter.fieldId]={$in:filter.value}}break;case"does not contain":if(!isUserTest){query={[filter.fieldId]:{$not:new RegExp(filter.value,"i")}}}else{query[filter.fieldId]={$nin:filter.value}}break;case"is empty":query={$or:[{[filter.fieldId]:""},{[filter.fieldId]:null},{[filter.fieldId]:[]},{[filter.fieldId]:{$exists:false}}]};break;case"is not empty":query={$and:[{[filter.fieldId]:{$ne:""}},{[filter.fieldId]:{$ne:null}},{[filter.fieldId]:{$ne:[]}},{[filter.fieldId]:{$exists:true}}]};break}return query},convertFilterGroup(filterGroup){if(filterGroup.type!="group")return kiss.db.mongo.convertFilter(filterGroup);let filters=[];filterGroup.filters.forEach((filter=>{if(filter){if(filter.type=="group"){filters.push(kiss.db.mongo.convertFilterGroup(filter))}else{filters.push(kiss.db.mongo.convertFilter(filter))}}}));let mongoFilter={};mongoFilter["$"+filterGroup.operator]=filters;return mongoFilter},getFilterFields(filter){if(!filter)return[];let fields=[];if(filter.type=="filter"){fields.push(filter.fieldId)}else if(filter.type=="group"){filter.filters.forEach((filter=>{fields=fields.concat(kiss.db.mongo.getFilterFields(filter))}))}return fields.unique()}}};kiss.db.faker=function(field){if(["block","panel","link","lookup","summary","attachment","aiImage","password","selectViewColumn","selectViewColumns"].indexOf(field.type)!=-1)return null;let sourceArray=[];let mockupName=typeof field==="object"?field.label.toLowerCase():field.toLowerCase();switch(mockupName){case"text":sourceArray=kiss.db.faker.text;if(field.validationType=="url")return"https://en.pickaform.fr";if(field.validationType=="email")return kiss.db.faker("email");if(field.value=="unid")return kiss.tools.shortUid().toUpperCase();return sourceArray[Math.floor(Math.random()*sourceArray.length)];case"textarea":case"aitextarea":case"richtextfield":return kiss.db.faker("description");case"select":if(field.template=="time")return("0"+Math.round(Math.random()*23)).slice(-2)+":00";if(field.options){sourceArray=field.options.map((option=>option.value));return sourceArray[Math.floor(Math.random()*sourceArray.length)]}return["A","B","C"];case"checkbox":let value=Math.random()*100;return value>50;case"date":let year=field.year||1980+Math.floor(Math.random()*45);let month=field.month||1+Math.floor(Math.random()*12);let day=field.day||1+Math.floor(Math.random()*28);let date=year.toString()+"-"+("0"+month.toString()).slice(-2)+"-"+("0"+day.toString()).slice(-2);return date;case"integer":return Math.floor(kiss.db.faker(Object.assign({},field,{label:"float",precision:0})));case"number":case"float":let min=field.min||0;let max=field.max||100;let precision=field.precision===0?0:2;let val=(min+Math.random()*(max-min)).toFixed(precision);if(mockupName=="number")return Math.floor(val);return val;case"slider":return Math.floor((Math.random()*100).toFixed(0));case"rating":let minRate=field.min||0;let maxRate=field.max||10;let rate=(minRate+Math.random()*(maxRate-minRate)).toFixed(0);return Math.floor(rate);case"directory":return kiss.session.getUserId();case"color":case"colorpicker":return"#"+kiss.global.palette[Math.round(Math.random()*59)];case"icon":case"iconpicker":return kiss.webfonts.all[Math.round(Math.random()*1040)];case"mapfield":return"-20.992914, 55.389535";case"username":case"fullname":case"full name":case"nom complet":case"utilisateur":return kiss.db.faker({label:"first name"})+" "+kiss.db.faker({label:"last name"});case"prénom":return kiss.db.faker({label:"first name"});case"nom":return kiss.db.faker({label:"last name"});case"email":return(kiss.db.faker({label:"first name"})+"."+kiss.db.faker({label:"last name"})+"@"+kiss.db.faker({label:"company name"}).toLowerCase()+"."+kiss.db.faker({label:"domain"})).toLowerCase();case"phone":case"mobile":case"mobile phone":case"téléphone":case"telephone":return kiss.db.faker({label:"integer",min:1e9,max:99e8});case"company":case"société":return kiss.db.faker({label:"company name"});case"address":case"adresse":return kiss.db.faker({label:"address 1"})+", "+kiss.db.faker({label:"address 2"})+", "+kiss.db.faker({label:"zip code"})+", "+kiss.db.faker({label:"city"})+", "+kiss.db.faker({label:"country"});case"address 1":case"addresse 1":return kiss.db.faker({label:"company name"})+" building";case"address 2":case"addresse 2":return kiss.db.faker({label:"integer",min:1})+" "+kiss.db.faker({label:"last name"})+" "+kiss.db.faker({label:"street"});case"zip code":case"code postal":return kiss.db.faker({label:"integer",min:1e3,max:9e4});case"description":return"Lorem ipsum dolor sit amet. Vel animi quia aut deserunt quos qui quia quaerat ut internos ipsa.";case"title":case"titre":return kiss.db.faker({label:"description.adjectives"}).toTitleCase()+" "+kiss.db.faker({label:"description.adjectives"})+" "+kiss.db.faker({label:"description.subjects"});default:if(typeof field==="object"){sourceArray=field.label.indexOf("description")!=-1?kiss.db.faker.description[field.label.split(".")[1]]:kiss.db.faker[mockupName];if(!sourceArray){return kiss.db.faker(Object.assign({},field,{label:field.type}))}}else{sourceArray=kiss.db.faker[mockupName];if(!sourceArray)return kiss.db.faker("text")}return sourceArray[Math.floor(Math.random()*sourceArray.length)]}};kiss.db.faker["priority"]=["1 - Critical","2 - High","3 - Normal","4 - Low"];kiss.db.faker["first name"]=["Mihaela","Johanna","Julia","Christian","Brigitte","Erwin","Maurice","Lydia","Adrian","Lucienne","John","Robert","Bob","Will","Stephen","Pavel","Robin","Gad","Arnold","Sylvester","Dolph","Robbie","Flavien"];kiss.db.faker["last name"]=["Clinciu","Giordini","Cvejzek","Ponzini","Collat","Romell","Lanoix","Mikevskaia","Smith","Dupont","Romero","De Rosa","Wilson","Smith","King","Yurgen","Lundgren","Al'Shadar","Gad'Nayé","Bouliama","Legendre"];kiss.db.faker["department"]=["Head office","Sales","IT","Support","Marketing","Communication","Accounting","Back office","Human resources","Quality"];kiss.db.faker["company name"]=["Google","Amazon","Facebook","Apple","IBM","Microsoft","Sony","Nintendo","SpaceX","Toyota","Ford","Ferrari","Renault","Epic","Ubisoft","Quantic Dream","Valve","Stripe","PickaForm","Exauce","The-Data-Box","Infinity"];kiss.db.faker["domain"]=["net","com","org","eu","fr","re"];kiss.db.faker["city"]=["Paris","New York","Tokyo","London","Ajaccio","Saint-Denis","Sydney","Marseilles","Lyon"];kiss.db.faker["street"]=["street","avenue","boulevard","road"];kiss.db.faker["country"]=["Gaulle","Germanistan","Corsica","Bhukistan","Wessex","Africanistan","Americanistan","Paradisistan"];kiss.db.faker["text"]=["Sample text","This is an example","Lorem ipsum"];kiss.db.faker["description"]={starts:["example","story","book","example","use case","case","article"],adjectives:["green","blue","red","purple","big","small","giant","slick","clever","stupid","wonderful","serious","shy","dangerous","hilarious","not so serious","really cool","strange","perfect","moody"],subjects:["man","woman","gorilla","flying saucer","donkey","cat","kiwi","dog","mouse","wolf","mammoth","banana","peanut","zombie","monster","frog","bird","chair","laptop","planet"],auxiliaries:["can","can't","could","couldn't","will","won't","did","didn't","may","may not","might","might not","shall"],verbs:["talk to","jump over","sing with","eat","reprogram","brain-wash","help","paint","study","invite"],adverbs:["gracefully","peacefully","gently","heavily","slightly","deeply","silently","carefully","nicely","easily","electronically"],ends:["is funny","is a bit weird","doesn't make any sense","hurts a little bit","should never happen","remains to proof","is nonsense","might or might not be the truth","makes me wonder","invites to meditation"]};kiss.db.faker.generate=function(fields,numberOfRecords){let records=[];let max=numberOfRecords||50;let activeFields=fields.filter((field=>field.deleted!=true));for(let index=0;index<max;index++){let newRecord={};activeFields.forEach((field=>{if(field.primary==true){newRecord[field.id]=field.label.toTitleCase()+" "+("0000"+(index+1)).slice(-5)}else if(field.label.toLowerCase()=="name"){newRecord[field.id]="Name "+("0000"+(index+1)).slice(-5)}else{let generatedValue=kiss.db.faker(field);if(generatedValue!=="")newRecord[field.id]=generatedValue}}));newRecord.id=uid();newRecord.isFake=true;records.push(newRecord)}return records};kiss.db.memory={mode:"memory",collections:{},deleteCollection:async modelId=>await kiss.db.offline.deleteCollection(modelId,"memory"),insertOne:async(modelId,record)=>await kiss.db.offline.insertOne(modelId,record,"memory"),insertMany:async(modelId,records)=>await kiss.db.offline.insertMany(modelId,records,"memory"),updateOne:async(modelId,recordId,update)=>await kiss.db.offline.updateOne(modelId,recordId,update,"memory"),updateOneDeep:async(modelId,recordId,update)=>await kiss.db.offline.updateOneDeep(modelId,recordId,update,"memory"),updateLink:async link=>await kiss.db.offline.updateLink(link,"memory"),updateMany:async(modelId,query,update)=>await kiss.db.offline.updateMany(modelId,query,update,"memory"),updateBulk:async operations=>await kiss.db.offline.updateBulk(operations,"memory"),findOne:async(modelId,recordId)=>await kiss.db.offline.findOne(modelId,recordId,"memory"),findById:async(modelId,ids,sort,sortSyntax)=>await kiss.db.offline.findById(modelId,ids,sort,sortSyntax,"memory"),find:async(modelId,query={})=>await kiss.db.offline.find(modelId,query,"memory"),deleteOne:async(modelId,recordId,sendToTrash)=>await kiss.db.offline.deleteOne(modelId,recordId,sendToTrash,"memory"),deleteMany:async(modelId,query,sendToTrash)=>await kiss.db.offline.deleteMany(modelId,query,sendToTrash,"memory"),count:async(modelId,query)=>await kiss.db.offline.count(modelId,query,"memory")};!function(t){if("function"==typeof bootstrap)bootstrap("nedb",t);else if("object"==typeof exports)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeNedb=t}else"undefined"!=typeof window?window.Nedb=t():global.Nedb=t()}((function(){var t;return function(t,e,n){function r(n,o){if(!e[n]){if(!t[n]){var a="function"==typeof require&&require;if(!o&&a)return a(n,!0);if(i)return i(n,!0);throw new Error("Cannot find module '"+n+"'")}var u=e[n]={exports:{}};t[n][0].call(u.exports,(function(e){var i=t[n][1][e];return r(i?i:e)}),u,u.exports)}return e[n].exports}for(var i="function"==typeof require&&require,o=0;o<n.length;o++)r(n[o]);return r}({1:[function(t,e,n){function r(t,e){if(t.indexOf)return t.indexOf(e);for(var n=0;n<t.length;n++)if(e===t[n])return n;return-1}var i=t("__browserify_process");i.EventEmitter||(i.EventEmitter=function(){});var o=n.EventEmitter=i.EventEmitter,a="function"==typeof Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},u=10;o.prototype.setMaxListeners=function(t){this._events||(this._events={}),this._events.maxListeners=t},o.prototype.emit=function(t){if("error"===t&&(!this._events||!this._events.error||a(this._events.error)&&!this._events.error.length))throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var e=this._events[t];if(!e)return!1;if("function"==typeof e){switch(arguments.length){case 1:e.call(this);break;case 2:e.call(this,arguments[1]);break;case 3:e.call(this,arguments[1],arguments[2]);break;default:var n=Array.prototype.slice.call(arguments,1);e.apply(this,n)}return!0}if(a(e)){for(var n=Array.prototype.slice.call(arguments,1),r=e.slice(),i=0,o=r.length;o>i;i++)r[i].apply(this,n);return!0}return!1},o.prototype.addListener=function(t,e){if("function"!=typeof e)throw new Error("addListener only takes instances of Function");if(this._events||(this._events={}),this.emit("newListener",t,e),this._events[t])if(a(this._events[t])){if(!this._events[t].warned){var n;n=void 0!==this._events.maxListeners?this._events.maxListeners:u,n&&n>0&&this._events[t].length>n&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),console.trace())}this._events[t].push(e)}else this._events[t]=[this._events[t],e];else this._events[t]=e;return this},o.prototype.on=o.prototype.addListener,o.prototype.once=function(t,e){var n=this;return n.on(t,(function r(){n.removeListener(t,r),e.apply(this,arguments)})),this},o.prototype.removeListener=function(t,e){if("function"!=typeof e)throw new Error("removeListener only takes instances of Function");if(!this._events||!this._events[t])return this;var n=this._events[t];if(a(n)){var i=r(n,e);if(0>i)return this;n.splice(i,1),0==n.length&&delete this._events[t]}else this._events[t]===e&&delete this._events[t];return this},o.prototype.removeAllListeners=function(t){return 0===arguments.length?(this._events={},this):(t&&this._events&&this._events[t]&&(this._events[t]=null),this)},o.prototype.listeners=function(t){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),a(this._events[t])||(this._events[t]=[this._events[t]]),this._events[t]},o.listenerCount=function(t,e){var n;return n=t._events&&t._events[e]?"function"==typeof t._events[e]?1:t._events[e].length:0}},{__browserify_process:4}],2:[function(t,e,n){function r(t,e){for(var n=[],r=0;r<t.length;r++)e(t[r],r,t)&&n.push(t[r]);return n}function i(t,e){for(var n=0,r=t.length;r>=0;r--){var i=t[r];"."==i?t.splice(r,1):".."===i?(t.splice(r,1),n++):n&&(t.splice(r,1),n--)}if(e)for(;n--;n)t.unshift("..");return t}var o=t("__browserify_process"),a=/^(.+\/(?!$)|\/)?((?:.+?)?(\.[^.]*)?)$/;n.resolve=function(){for(var t="",e=!1,n=arguments.length;n>=-1&&!e;n--){var a=n>=0?arguments[n]:o.cwd();"string"==typeof a&&a&&(t=a+"/"+t,e="/"===a.charAt(0))}return t=i(r(t.split("/"),(function(t){return!!t})),!e).join("/"),(e?"/":"")+t||"."},n.normalize=function(t){var e="/"===t.charAt(0),n="/"===t.slice(-1);return t=i(r(t.split("/"),(function(t){return!!t})),!e).join("/"),t||e||(t="."),t&&n&&(t+="/"),(e?"/":"")+t},n.join=function(){var t=Array.prototype.slice.call(arguments,0);return n.normalize(r(t,(function(t){return t&&"string"==typeof t})).join("/"))},n.dirname=function(t){var e=a.exec(t)[1]||"",n=!1;return e?1===e.length||n&&e.length<=3&&":"===e.charAt(1)?e:e.substring(0,e.length-1):"."},n.basename=function(t,e){var n=a.exec(t)[2]||"";return e&&n.substr(-1*e.length)===e&&(n=n.substr(0,n.length-e.length)),n},n.extname=function(t){return a.exec(t)[3]||""},n.relative=function(t,e){function r(t){for(var e=0;e<t.length&&""===t[e];e++);for(var n=t.length-1;n>=0&&""===t[n];n--);return e>n?[]:t.slice(e,n-e+1)}t=n.resolve(t).substr(1),e=n.resolve(e).substr(1);for(var i=r(t.split("/")),o=r(e.split("/")),a=Math.min(i.length,o.length),u=a,s=0;a>s;s++)if(i[s]!==o[s]){u=s;break}for(var c=[],s=u;s<i.length;s++)c.push("..");return c=c.concat(o.slice(u)),c.join("/")},n.sep="/"},{__browserify_process:4}],3:[function(t,e,n){function r(t){return Array.isArray(t)||"object"==typeof t&&"[object Array]"===Object.prototype.toString.call(t)}function i(t){"object"==typeof t&&"[object RegExp]"===Object.prototype.toString.call(t)}function o(t){return"object"==typeof t&&"[object Date]"===Object.prototype.toString.call(t)}t("events"),n.isArray=r,n.isDate=function(t){return"[object Date]"===Object.prototype.toString.call(t)},n.isRegExp=function(t){return"[object RegExp]"===Object.prototype.toString.call(t)},n.print=function(){},n.puts=function(){},n.debug=function(){},n.inspect=function(t,e,s,c){function f(t,s){if(t&&"function"==typeof t.inspect&&t!==n&&(!t.constructor||t.constructor.prototype!==t))return t.inspect(s);switch(typeof t){case"undefined":return h("undefined","undefined");case"string":var c="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return h(c,"string");case"number":return h(""+t,"number");case"boolean":return h(""+t,"boolean")}if(null===t)return h("null","null");var p=a(t),d=e?u(t):p;if("function"==typeof t&&0===d.length){if(i(t))return h(""+t,"regexp");var y=t.name?": "+t.name:"";return h("[Function"+y+"]","special")}if(o(t)&&0===d.length)return h(t.toUTCString(),"date");var v,g,m;if(r(t)?(g="Array",m=["[","]"]):(g="Object",m=["{","}"]),"function"==typeof t){var b=t.name?": "+t.name:"";v=i(t)?" "+t:" [Function"+b+"]"}else v="";if(o(t)&&(v=" "+t.toUTCString()),0===d.length)return m[0]+v+m[1];if(0>s)return i(t)?h(""+t,"regexp"):h("[Object]","special");l.push(t);var w=d.map((function(e){var n,i;if(t.__lookupGetter__&&(t.__lookupGetter__(e)?i=t.__lookupSetter__(e)?h("[Getter/Setter]","special"):h("[Getter]","special"):t.__lookupSetter__(e)&&(i=h("[Setter]","special"))),p.indexOf(e)<0&&(n="["+e+"]"),i||(l.indexOf(t[e])<0?(i=null===s?f(t[e]):f(t[e],s-1),i.indexOf("\n")>-1&&(i=r(t)?i.split("\n").map((function(t){return"  "+t})).join("\n").substr(2):"\n"+i.split("\n").map((function(t){return"   "+t})).join("\n"))):i=h("[Circular]","special")),"undefined"==typeof n){if("Array"===g&&e.match(/^\d+$/))return i;n=JSON.stringify(""+e),n.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(n=n.substr(1,n.length-2),n=h(n,"name")):(n=n.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),n=h(n,"string"))}return n+": "+i}));l.pop();var _=0,k=w.reduce((function(t,e){return _++,e.indexOf("\n")>=0&&_++,t+e.length+1}),0);return w=k>50?m[0]+(""===v?"":v+"\n ")+" "+w.join(",\n  ")+" "+m[1]:m[0]+v+" "+w.join(", ")+" "+m[1]}var l=[],h=function(t,e){var n={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},r={special:"cyan",number:"blue",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"}[e];return r?"["+n[r][0]+"m"+t+"["+n[r][1]+"m":t};return c||(h=function(t){return t}),f(t,"undefined"==typeof s?2:s)},n.log=function(){},n.pump=null;var a=Object.keys||function(t){var e=[];for(var n in t)e.push(n);return e},u=Object.getOwnPropertyNames||function(t){var e=[];for(var n in t)Object.hasOwnProperty.call(t,n)&&e.push(n);return e},s=Object.create||function(t,e){var n;if(null===t)n={__proto__:null};else{if("object"!=typeof t)throw new TypeError("typeof prototype["+typeof t+"] != 'object'");var r=function(){};r.prototype=t,n=new r,n.__proto__=t}return"undefined"!=typeof e&&Object.defineProperties&&Object.defineProperties(n,e),n};n.inherits=function(t,e){t.super_=e,t.prototype=s(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})};var c=/%[sdj%]/g;n.format=function(t){if("string"!=typeof t){for(var e=[],r=0;r<arguments.length;r++)e.push(n.inspect(arguments[r]));return e.join(" ")}for(var r=1,i=arguments,o=i.length,a=String(t).replace(c,(function(t){if("%%"===t)return"%";if(r>=o)return t;switch(t){case"%s":return String(i[r++]);case"%d":return Number(i[r++]);case"%j":return JSON.stringify(i[r++]);default:return t}})),u=i[r];o>r;u=i[++r])a+=null===u||"object"!=typeof u?" "+u:" "+n.inspect(u);return a}},{events:1}],4:[function(t,e){var n=e.exports={};n.nextTick=function(){var t="undefined"!=typeof window&&window.setImmediate,e="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(t)return function(t){return window.setImmediate(t)};if(e){var n=[];return window.addEventListener("message",(function(t){var e=t.source;if((e===window||null===e)&&"process-tick"===t.data&&(t.stopPropagation(),n.length>0)){var r=n.shift();r()}}),!0),function(t){n.push(t),window.postMessage("process-tick","*")}}return function(t){setTimeout(t,0)}}(),n.title="browser",n.browser=!0,n.env={},n.argv=[],n.binding=function(){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(){throw new Error("process.chdir is not supported")}},{}],5:[function(t,e){function n(t,e,n){this.db=t,this.query=e||{},n&&(this.execFn=n)}var r=t("./model"),i=t("underscore");n.prototype.limit=function(t){return this._limit=t,this},n.prototype.skip=function(t){return this._skip=t,this},n.prototype.sort=function(t){return this._sort=t,this},n.prototype.projection=function(t){return this._projection=t,this},n.prototype.project=function(t){var e,n,o,a=[],u=this;return void 0===this._projection||0===Object.keys(this._projection).length?t:(e=0===this._projection._id?!1:!0,this._projection=i.omit(this._projection,"_id"),o=Object.keys(this._projection),o.forEach((function(t){if(void 0!==n&&u._projection[t]!==n)throw new Error("Can't both keep and omit fields except for _id");n=u._projection[t]})),t.forEach((function(t){var i;1===n?(i={$set:{}},o.forEach((function(e){i.$set[e]=r.getDotValue(t,e),void 0===i.$set[e]&&delete i.$set[e]})),i=r.modify({},i)):(i={$unset:{}},o.forEach((function(t){i.$unset[t]=!0})),i=r.modify(t,i)),e?i._id=t._id:delete i._id,a.push(i)})),a)},n.prototype._exec=function(t){function e(e,n){return c.execFn?c.execFn(e,n,t):t(e,n)}var n,i,o,a=[],u=0,s=0,c=this,f=null;this.db.getCandidates(this.query,(function(t,l){if(t)return e(t);try{for(n=0;n<l.length;n+=1)if(r.match(l[n],c.query))if(c._sort)a.push(l[n]);else if(c._skip&&c._skip>s)s+=1;else if(a.push(l[n]),u+=1,c._limit&&c._limit<=u)break}catch(t){return e(t)}if(c._sort){i=Object.keys(c._sort);var h=[];for(n=0;n<i.length;n++)o=i[n],h.push({key:o,direction:c._sort[o]});a.sort((function(t,e){var n,i,o;for(o=0;o<h.length;o++)if(n=h[o],i=n.direction*r.compareThings(r.getDotValue(t,n.key),r.getDotValue(e,n.key),c.db.compareStrings),0!==i)return i;return 0}));var p=c._limit||a.length,d=c._skip||0;a=a.slice(d,d+p)}try{a=c.project(a)}catch(y){f=y,a=void 0}return e(f,a)}))},n.prototype.exec=function(){this.db.executor.push({this:this,fn:this._exec,arguments:arguments})},e.exports=n},{"./model":10,underscore:19}],6:[function(t,e){function n(t){for(var e,e,n=new Array(t),r=0;t>r;r++)0==(3&r)&&(e=4294967296*Math.random()),n[r]=255&e>>>((3&r)<<3);return n}function r(t){function e(t){return o[63&t>>18]+o[63&t>>12]+o[63&t>>6]+o[63&t]}var n,r,i,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=t.length%3,u="";for(i=0,r=t.length-a;r>i;i+=3)n=(t[i]<<16)+(t[i+1]<<8)+t[i+2],u+=e(n);switch(a){case 1:n=t[t.length-1],u+=o[n>>2],u+=o[63&n<<4],u+="==";break;case 2:n=(t[t.length-2]<<8)+t[t.length-1],u+=o[n>>10],u+=o[63&n>>4],u+=o[63&n<<2],u+="="}return u}function i(t){return r(n(Math.ceil(Math.max(8,2*t)))).replace(/[+\/]/g,"").slice(0,t)}e.exports.uid=i},{}],7:[function(t,e){function n(t){var e;"string"==typeof t?(e=t,this.inMemoryOnly=!1):(t=t||{},e=t.filename,this.inMemoryOnly=t.inMemoryOnly||!1,this.autoload=t.autoload||!1,this.timestampData=t.timestampData||!1),e&&"string"==typeof e&&0!==e.length?this.filename=e:(this.filename=null,this.inMemoryOnly=!0),this.compareStrings=t.compareStrings,this.persistence=new f({db:this,nodeWebkitAppName:t.nodeWebkitAppName,afterSerialization:t.afterSerialization,beforeDeserialization:t.beforeDeserialization,corruptAlertThreshold:t.corruptAlertThreshold}),this.executor=new a,this.inMemoryOnly&&(this.executor.ready=!0),this.indexes={},this.indexes._id=new u({fieldName:"_id",unique:!0}),this.ttlIndexes={},this.autoload&&this.loadDatabase(t.onload||function(t){if(t)throw t})}var r=t("./customUtils"),i=t("./model"),o=t("async"),a=t("./executor"),u=t("./indexes"),s=t("util"),c=t("underscore"),f=t("./persistence"),l=t("./cursor");s.inherits(n,t("events").EventEmitter),n.prototype.loadDatabase=function(){this.executor.push({this:this.persistence,fn:this.persistence.loadDatabase,arguments:arguments},!0)},n.prototype.getAllData=function(){return this.indexes._id.getAll()},n.prototype.resetIndexes=function(t){var e=this;Object.keys(this.indexes).forEach((function(n){e.indexes[n].reset(t)}))},n.prototype.ensureIndex=function(t,e){var n,r=e||function(){};if(t=t||{},!t.fieldName)return n=new Error("Cannot create an index without a fieldName"),n.missingFieldName=!0,r(n);if(this.indexes[t.fieldName])return r(null);this.indexes[t.fieldName]=new u(t),void 0!==t.expireAfterSeconds&&(this.ttlIndexes[t.fieldName]=t.expireAfterSeconds);try{this.indexes[t.fieldName].insert(this.getAllData())}catch(i){return delete this.indexes[t.fieldName],r(i)}this.persistence.persistNewState([{$$indexCreated:t}],(function(t){return t?r(t):r(null)}))},n.prototype.removeIndex=function(t,e){var n=e||function(){};delete this.indexes[t],this.persistence.persistNewState([{$$indexRemoved:t}],(function(t){return t?n(t):n(null)}))},n.prototype.addToIndexes=function(t){var e,n,r,i=Object.keys(this.indexes);for(e=0;e<i.length;e+=1)try{this.indexes[i[e]].insert(t)}catch(o){n=e,r=o;break}if(r){for(e=0;n>e;e+=1)this.indexes[i[e]].remove(t);throw r}},n.prototype.removeFromIndexes=function(t){var e=this;Object.keys(this.indexes).forEach((function(n){e.indexes[n].remove(t)}))},n.prototype.updateIndexes=function(t,e){var n,r,i,o=Object.keys(this.indexes);for(n=0;n<o.length;n+=1)try{this.indexes[o[n]].update(t,e)}catch(a){r=n,i=a;break}if(i){for(n=0;r>n;n+=1)this.indexes[o[n]].revertUpdate(t,e);throw i}},n.prototype.getCandidates=function(t,e,n){var r,i=Object.keys(this.indexes),a=this;"function"==typeof e&&(n=e,e=!1),o.waterfall([function(e){return r=[],Object.keys(t).forEach((function(e){("string"==typeof t[e]||"number"==typeof t[e]||"boolean"==typeof t[e]||s.isDate(t[e])||null===t[e])&&r.push(e)})),r=c.intersection(r,i),r.length>0?e(null,a.indexes[r[0]].getMatching(t[r[0]])):(r=[],Object.keys(t).forEach((function(e){t[e]&&t[e].hasOwnProperty("$in")&&r.push(e)})),r=c.intersection(r,i),r.length>0?e(null,a.indexes[r[0]].getMatching(t[r[0]].$in)):(r=[],Object.keys(t).forEach((function(e){t[e]&&(t[e].hasOwnProperty("$lt")||t[e].hasOwnProperty("$lte")||t[e].hasOwnProperty("$gt")||t[e].hasOwnProperty("$gte"))&&r.push(e)})),r=c.intersection(r,i),r.length>0?e(null,a.indexes[r[0]].getBetweenBounds(t[r[0]])):e(null,a.getAllData())))},function(t){if(e)return n(null,t);var r=[],i=[],u=Object.keys(a.ttlIndexes);t.forEach((function(t){var e=!0;u.forEach((function(n){void 0!==t[n]&&s.isDate(t[n])&&Date.now()>t[n].getTime()+1e3*a.ttlIndexes[n]&&(e=!1)})),e?i.push(t):r.push(t._id)})),o.eachSeries(r,(function(t,e){a._remove({_id:t},{},(function(t){return t?n(t):e()}))}),(function(){return n(null,i)}))}])},n.prototype._insert=function(t,e){var n,r=e||function(){};try{n=this.prepareDocumentForInsertion(t),this._insertInCache(n)}catch(o){return r(o)}this.persistence.persistNewState(s.isArray(n)?n:[n],(function(t){return t?r(t):r(null,i.deepCopy(n))}))},n.prototype.createNewId=function(){var t=r.uid(16);return this.indexes._id.getMatching(t).length>0&&(t=this.createNewId()),t},n.prototype.prepareDocumentForInsertion=function(t){var e,n=this;if(s.isArray(t))e=[],t.forEach((function(t){e.push(n.prepareDocumentForInsertion(t))}));else{e=i.deepCopy(t),void 0===e._id&&(e._id=this.createNewId());var r=new Date;this.timestampData&&void 0===e.createdAt&&(e.createdAt=r),this.timestampData&&void 0===e.updatedAt&&(e.updatedAt=r),i.checkObject(e)}return e},n.prototype._insertInCache=function(t){s.isArray(t)?this._insertMultipleDocsInCache(t):this.addToIndexes(t)},n.prototype._insertMultipleDocsInCache=function(t){var e,n,r;for(e=0;e<t.length;e+=1)try{this.addToIndexes(t[e])}catch(i){r=i,n=e;break}if(r){for(e=0;n>e;e+=1)this.removeFromIndexes(t[e]);throw r}},n.prototype.insert=function(){this.executor.push({this:this,fn:this._insert,arguments:arguments})},n.prototype.count=function(t,e){var n=new l(this,t,(function(t,e,n){return t?n(t):n(null,e.length)}));return"function"!=typeof e?n:(n.exec(e),void 0)},n.prototype.find=function(t,e,n){switch(arguments.length){case 1:e={};break;case 2:"function"==typeof e&&(n=e,e={})}var r=new l(this,t,(function(t,e,n){var r,o=[];if(t)return n(t);for(r=0;r<e.length;r+=1)o.push(i.deepCopy(e[r]));return n(null,o)}));return r.projection(e),"function"!=typeof n?r:(r.exec(n),void 0)},n.prototype.findOne=function(t,e,n){switch(arguments.length){case 1:e={};break;case 2:"function"==typeof e&&(n=e,e={})}var r=new l(this,t,(function(t,e,n){return t?n(t):1===e.length?n(null,i.deepCopy(e[0])):n(null,null)}));return r.projection(e).limit(1),"function"!=typeof n?r:(r.exec(n),void 0)},n.prototype._update=function(t,e,n,r){var a,u,s,f,h=this,p=0;"function"==typeof n&&(r=n,n={}),a=r||function(){},u=void 0!==n.multi?n.multi:!1,s=void 0!==n.upsert?n.upsert:!1,o.waterfall([function(n){if(!s)return n();var r=new l(h,t);r.limit(1)._exec((function(r,o){if(r)return a(r);if(1===o.length)return n();var u;try{i.checkObject(e),u=e}catch(s){try{u=i.modify(i.deepCopy(t,!0),e)}catch(r){return a(r)}}return h._insert(u,(function(t,e){return t?a(t):a(null,1,e,!0)}))}))},function(){var r,o,s=[];h.getCandidates(t,(function(l,d){if(l)return a(l);try{for(f=0;f<d.length;f+=1)i.match(d[f],t)&&(u||0===p)&&(p+=1,h.timestampData&&(o=d[f].createdAt),r=i.modify(d[f],e),h.timestampData&&(r.createdAt=o,r.updatedAt=new Date),s.push({oldDoc:d[f],newDoc:r}))}catch(l){return a(l)}try{h.updateIndexes(s)}catch(l){return a(l)}var y=c.pluck(s,"newDoc");h.persistence.persistNewState(y,(function(t){if(t)return a(t);if(n.returnUpdatedDocs){var e=[];return y.forEach((function(t){e.push(i.deepCopy(t))})),u||(e=e[0]),a(null,p,e)}return a(null,p)}))}))}])},n.prototype.update=function(){this.executor.push({this:this,fn:this._update,arguments:arguments})},n.prototype._remove=function(t,e,n){var r,o,a=this,u=0,s=[];"function"==typeof e&&(n=e,e={}),r=n||function(){},o=void 0!==e.multi?e.multi:!1,this.getCandidates(t,!0,(function(e,n){if(e)return r(e);try{n.forEach((function(e){i.match(e,t)&&(o||0===u)&&(u+=1,s.push({$$deleted:!0,_id:e._id}),a.removeFromIndexes(e))}))}catch(e){return r(e)}a.persistence.persistNewState(s,(function(t){return t?r(t):r(null,u)}))}))},n.prototype.remove=function(){this.executor.push({this:this,fn:this._remove,arguments:arguments})},e.exports=n},{"./cursor":5,"./customUtils":6,"./executor":8,"./indexes":9,"./model":10,"./persistence":11,async:13,events:1,underscore:19,util:3}],8:[function(t,e){function n(){this.buffer=[],this.ready=!1,this.queue=i.queue((function(t,e){for(var n=[],i=0;i<t.arguments.length;i+=1)n.push(t.arguments[i]);var o=t.arguments[t.arguments.length-1];"function"==typeof o?n[n.length-1]=function(){"function"==typeof setImmediate?setImmediate(e):r.nextTick(e),o.apply(null,arguments)}:o||0===t.arguments.length?n.push((function(){e()})):n[n.length-1]=function(){e()},t.fn.apply(t.this,n)}),1)}var r=t("__browserify_process"),i=t("async");n.prototype.push=function(t,e){this.ready||e?this.queue.push(t):this.buffer.push(t)},n.prototype.processBuffer=function(){var t;for(this.ready=!0,t=0;t<this.buffer.length;t+=1)this.queue.push(this.buffer[t]);this.buffer=[]},e.exports=n},{__browserify_process:4,async:13}],9:[function(t,e){function n(t,e){return t===e}function r(t){return null===t?"$null":"string"==typeof t?"$string"+t:"boolean"==typeof t?"$boolean"+t:"number"==typeof t?"$number"+t:s.isArray(t)?"$date"+t.getTime():t}function i(t){this.fieldName=t.fieldName,this.unique=t.unique||!1,this.sparse=t.sparse||!1,this.treeOptions={unique:this.unique,compareKeys:a.compareThings,checkValueEquality:n},this.reset()}var o=t("binary-search-tree").AVLTree,a=t("./model"),u=t("underscore"),s=t("util");i.prototype.reset=function(t){this.tree=new o(this.treeOptions),t&&this.insert(t)},i.prototype.insert=function(t){var e,n,i,o,c;if(s.isArray(t))return this.insertMultipleDocs(t),void 0;if(e=a.getDotValue(t,this.fieldName),void 0!==e||!this.sparse)if(s.isArray(e)){for(n=u.uniq(e,r),i=0;i<n.length;i+=1)try{this.tree.insert(n[i],t)}catch(f){c=f,o=i;break}if(c){for(i=0;o>i;i+=1)this.tree.delete(n[i],t);throw c}}else this.tree.insert(e,t)},i.prototype.insertMultipleDocs=function(t){var e,n,r;for(e=0;e<t.length;e+=1)try{this.insert(t[e])}catch(i){n=i,r=e;break}if(n){for(e=0;r>e;e+=1)this.remove(t[e]);throw n}},i.prototype.remove=function(t){var e,n=this;return s.isArray(t)?(t.forEach((function(t){n.remove(t)})),void 0):(e=a.getDotValue(t,this.fieldName),void 0===e&&this.sparse||(s.isArray(e)?u.uniq(e,r).forEach((function(e){n.tree.delete(e,t)})):this.tree.delete(e,t)),void 0)},i.prototype.update=function(t,e){if(s.isArray(t))return this.updateMultipleDocs(t),void 0;this.remove(t);try{this.insert(e)}catch(n){throw this.insert(t),n}},i.prototype.updateMultipleDocs=function(t){var e,n,r;for(e=0;e<t.length;e+=1)this.remove(t[e].oldDoc);for(e=0;e<t.length;e+=1)try{this.insert(t[e].newDoc)}catch(i){r=i,n=e;break}if(r){for(e=0;n>e;e+=1)this.remove(t[e].newDoc);for(e=0;e<t.length;e+=1)this.insert(t[e].oldDoc);throw r}},i.prototype.revertUpdate=function(t,e){var n=[];s.isArray(t)?(t.forEach((function(t){n.push({oldDoc:t.newDoc,newDoc:t.oldDoc})})),this.update(n)):this.update(e,t)},i.prototype.getMatching=function(t){var e=this;if(s.isArray(t)){var n={},r=[];return t.forEach((function(t){e.getMatching(t).forEach((function(t){n[t._id]=t}))})),Object.keys(n).forEach((function(t){r.push(n[t])})),r}return e.tree.search(t)},i.prototype.getBetweenBounds=function(t){return this.tree.betweenBounds(t)},i.prototype.getAll=function(){var t=[];return this.tree.executeOnEveryNode((function(e){var n;for(n=0;n<e.data.length;n+=1)t.push(e.data[n])})),t},e.exports=i},{"./model":10,"binary-search-tree":14,underscore:19,util:3}],10:[function(t,e){function n(t,e){if("number"==typeof t&&(t=t.toString()),!("$"!==t[0]||"$$date"===t&&"number"==typeof e||"$$deleted"===t&&e===!0||"$$indexCreated"===t||"$$indexRemoved"===t))throw new Error("Field names cannot begin with the $ character");if(-1!==t.indexOf("."))throw new Error("Field names cannot contain a .")}function r(t){m.isArray(t)&&t.forEach((function(t){r(t)})),"object"==typeof t&&null!==t&&Object.keys(t).forEach((function(e){n(e,t[e]),r(t[e])}))}function i(t){var e;return e=JSON.stringify(t,(function(t,e){return n(t,e),void 0===e?void 0:null===e?null:"function"==typeof this[t].getTime?{$$date:this[t].getTime()}:e}))}function o(t){return JSON.parse(t,(function(t,e){return"$$date"===t?new Date(e):"string"==typeof e||"number"==typeof e||"boolean"==typeof e||null===e?e:e&&e.$$date?e.$$date:e}))}function a(t,e){var n;return"boolean"==typeof t||"number"==typeof t||"string"==typeof t||null===t||m.isDate(t)?t:m.isArray(t)?(n=[],t.forEach((function(t){n.push(a(t,e))})),n):"object"==typeof t?(n={},Object.keys(t).forEach((function(r){(!e||"$"!==r[0]&&-1===r.indexOf("."))&&(n[r]=a(t[r],e))})),n):void 0}function u(t){return"boolean"==typeof t||"number"==typeof t||"string"==typeof t||null===t||m.isDate(t)||m.isArray(t)}function s(t,e){return e>t?-1:t>e?1:0}function c(t,e){var n,r;for(n=0;n<Math.min(t.length,e.length);n+=1)if(r=f(t[n],e[n]),0!==r)return r;return s(t.length,e.length)}function f(t,e,n){var r,i,o,a,u=n||s;if(void 0===t)return void 0===e?0:-1;if(void 0===e)return void 0===t?0:1;if(null===t)return null===e?0:-1;if(null===e)return null===t?0:1;if("number"==typeof t)return"number"==typeof e?s(t,e):-1;if("number"==typeof e)return"number"==typeof t?s(t,e):1;if("string"==typeof t)return"string"==typeof e?u(t,e):-1;if("string"==typeof e)return"string"==typeof t?u(t,e):1;if("boolean"==typeof t)return"boolean"==typeof e?s(t,e):-1;if("boolean"==typeof e)return"boolean"==typeof t?s(t,e):1;if(m.isDate(t))return m.isDate(e)?s(t.getTime(),e.getTime()):-1;if(m.isDate(e))return m.isDate(t)?s(t.getTime(),e.getTime()):1;if(m.isArray(t))return m.isArray(e)?c(t,e):-1;if(m.isArray(e))return m.isArray(t)?c(t,e):1;for(r=Object.keys(t).sort(),i=Object.keys(e).sort(),a=0;a<Math.min(r.length,i.length);a+=1)if(o=f(t[r[a]],e[i[a]]),0!==o)return o;return s(r.length,i.length)}function l(t){return function(e,n,r){var i="string"==typeof n?n.split("."):n;if(1===i.length)_[t](e,n,r);else{if(void 0===e[i[0]]){if("$unset"===t)return;e[i[0]]={}}w[t](e[i[0]],i.slice(1),r)}}}function h(t,e){var n,i,o=Object.keys(e),u=b.map(o,(function(t){return t[0]})),s=b.filter(u,(function(t){return"$"===t}));if(-1!==o.indexOf("_id")&&e._id!==t._id)throw new Error("You cannot change a document's _id");if(0!==s.length&&s.length!==u.length)throw new Error("You cannot mix modifiers and normal fields");if(0===s.length?(n=a(e),n._id=t._id):(i=b.uniq(o),n=a(t),i.forEach((function(t){var r;if(!w[t])throw new Error("Unknown modifier "+t);if("object"!=typeof e[t])throw new Error("Modifier "+t+"'s argument must be an object");r=Object.keys(e[t]),r.forEach((function(r){w[t](n,r,e[t][r])}))}))),r(n),t._id!==n._id)throw new Error("You can't change a document's _id");return n}function p(t,e){var n,r,i="string"==typeof e?e.split("."):e;if(!t)return void 0;if(0===i.length)return t;if(1===i.length)return t[i[0]];if(m.isArray(t[i[0]])){if(n=parseInt(i[1],10),"number"==typeof n&&!isNaN(n))return p(t[i[0]][n],i.slice(2));for(r=new Array,n=0;n<t[i[0]].length;n+=1)r.push(p(t[i[0]][n],i.slice(1)));return r}return p(t[i[0]],i.slice(1))}function d(t,e){var n,r,i;if(null===t||"string"==typeof t||"boolean"==typeof t||"number"==typeof t||null===e||"string"==typeof e||"boolean"==typeof e||"number"==typeof e)return t===e;if(m.isDate(t)||m.isDate(e))return m.isDate(t)&&m.isDate(e)&&t.getTime()===e.getTime();if((!m.isArray(t)||!m.isArray(e))&&(m.isArray(t)||m.isArray(e))||void 0===t||void 0===e)return!1;try{n=Object.keys(t),r=Object.keys(e)}catch(o){return!1}if(n.length!==r.length)return!1;for(i=0;i<n.length;i+=1){if(-1===r.indexOf(n[i]))return!1;if(!d(t[n[i]],e[n[i]]))return!1}return!0}function y(t,e){return"string"==typeof t||"number"==typeof t||m.isDate(t)||"string"==typeof e||"number"==typeof e||m.isDate(e)?typeof t!=typeof e?!1:!0:!1}function v(t,e){var n,r,i,o;if(u(t)||u(e))return g({needAKey:t},"needAKey",e);for(n=Object.keys(e),o=0;o<n.length;o+=1)if(r=n[o],i=e[r],"$"===r[0]){if(!x[r])throw new Error("Unknown logical operator "+r);if(!x[r](t,i))return!1}else if(!g(t,r,i))return!1;return!0}function g(t,e,n,r){var i,o,a,u,s=p(t,e);if(m.isArray(s)&&!r){if(m.isArray(n))return g(t,e,n,!0);if(null!==n&&"object"==typeof n&&!m.isRegExp(n))for(o=Object.keys(n),i=0;i<o.length;i+=1)if(E[o[i]])return g(t,e,n,!0);for(i=0;i<s.length;i+=1)if(g({k:s[i]},"k",n))return!0;return!1}if(null!==n&&"object"==typeof n&&!m.isRegExp(n)&&!m.isArray(n)){if(o=Object.keys(n),a=b.map(o,(function(t){return t[0]})),u=b.filter(a,(function(t){return"$"===t})),0!==u.length&&u.length!==a.length)throw new Error("You cannot mix operators and normal fields");if(u.length>0){for(i=0;i<o.length;i+=1){if(!k[o[i]])throw new Error("Unknown comparison function "+o[i]);if(!k[o[i]](s,n[o[i]]))return!1}return!0}}return m.isRegExp(n)?k.$regex(s,n):d(s,n)?!0:!1}var m=t("util"),b=t("underscore"),w={},_={},k={},x={},E={};_.$set=function(t,e,n){t[e]=n},_.$unset=function(t,e){delete t[e]},_.$push=function(t,e,n){if(t.hasOwnProperty(e)||(t[e]=[]),!m.isArray(t[e]))throw new Error("Can't $push an element on non-array values");if(null!==n&&"object"==typeof n&&n.$slice&&void 0===n.$each&&(n.$each=[]),null!==n&&"object"==typeof n&&n.$each){if(Object.keys(n).length>=3||2===Object.keys(n).length&&void 0===n.$slice)throw new Error("Can only use $slice in cunjunction with $each when $push to array");if(!m.isArray(n.$each))throw new Error("$each requires an array value");if(n.$each.forEach((function(n){t[e].push(n)})),void 0===n.$slice||"number"!=typeof n.$slice)return;if(0===n.$slice)t[e]=[];else{var r,i,o=t[e].length;n.$slice<0?(r=Math.max(0,o+n.$slice),i=o):n.$slice>0&&(r=0,i=Math.min(o,n.$slice)),t[e]=t[e].slice(r,i)}}else t[e].push(n)},_.$addToSet=function(t,e,n){var r=!0;if(t.hasOwnProperty(e)||(t[e]=[]),!m.isArray(t[e]))throw new Error("Can't $addToSet an element on non-array values");if(null!==n&&"object"==typeof n&&n.$each){if(Object.keys(n).length>1)throw new Error("Can't use another field in conjunction with $each");if(!m.isArray(n.$each))throw new Error("$each requires an array value");n.$each.forEach((function(n){_.$addToSet(t,e,n)}))}else t[e].forEach((function(t){0===f(t,n)&&(r=!1)})),r&&t[e].push(n)},_.$pop=function(t,e,n){if(!m.isArray(t[e]))throw new Error("Can't $pop an element from non-array values");if("number"!=typeof n)throw new Error(n+" isn't an integer, can't use it with $pop");0!==n&&(t[e]=n>0?t[e].slice(0,t[e].length-1):t[e].slice(1))},_.$pull=function(t,e,n){var r,i;if(!m.isArray(t[e]))throw new Error("Can't $pull an element from non-array values");for(r=t[e],i=r.length-1;i>=0;i-=1)v(r[i],n)&&r.splice(i,1)},_.$inc=function(t,e,n){if("number"!=typeof n)throw new Error(n+" must be a number");if("number"!=typeof t[e]){if(b.has(t,e))throw new Error("Don't use the $inc modifier on non-number fields");t[e]=n}else t[e]+=n},_.$max=function(t,e,n){"undefined"==typeof t[e]?t[e]=n:n>t[e]&&(t[e]=n)},_.$min=function(t,e,n){"undefined"==typeof t[e]?t[e]=n:n<t[e]&&(t[e]=n)},Object.keys(_).forEach((function(t){w[t]=l(t)})),k.$lt=function(t,e){return y(t,e)&&e>t},k.$lte=function(t,e){return y(t,e)&&e>=t},k.$gt=function(t,e){return y(t,e)&&t>e},k.$gte=function(t,e){return y(t,e)&&t>=e},k.$ne=function(t,e){return void 0===t?!0:!d(t,e)},k.$in=function(t,e){var n;if(!m.isArray(e))throw new Error("$in operator called with a non-array");for(n=0;n<e.length;n+=1)if(d(t,e[n]))return!0;return!1},k.$nin=function(t,e){if(!m.isArray(e))throw new Error("$nin operator called with a non-array");return!k.$in(t,e)},k.$regex=function(t,e){if(!m.isRegExp(e))throw new Error("$regex operator called with non regular expression");return"string"!=typeof t?!1:e.test(t)},k.$exists=function(t,e){return e=e||""===e?!0:!1,void 0===t?!e:e},k.$size=function(t,e){if(!m.isArray(t))return!1;if(0!==e%1)throw new Error("$size operator called without an integer");return t.length==e},k.$elemMatch=function(t,e){if(!m.isArray(t))return!1;for(var n=t.length,r=!1;n--;)if(v(t[n],e)){r=!0;break}return r},E.$size=!0,E.$elemMatch=!0,x.$or=function(t,e){var n;if(!m.isArray(e))throw new Error("$or operator used without an array");for(n=0;n<e.length;n+=1)if(v(t,e[n]))return!0;return!1},x.$and=function(t,e){var n;if(!m.isArray(e))throw new Error("$and operator used without an array");for(n=0;n<e.length;n+=1)if(!v(t,e[n]))return!1;return!0},x.$not=function(t,e){return!v(t,e)},x.$where=function(t,e){var n;if(!b.isFunction(e))throw new Error("$where operator used without a function");if(n=e.call(t),!b.isBoolean(n))throw new Error("$where function must return boolean");return n},e.exports.serialize=i,e.exports.deserialize=o,e.exports.deepCopy=a,e.exports.checkObject=r,e.exports.isPrimitiveType=u,e.exports.modify=h,e.exports.getDotValue=p,e.exports.match=v,e.exports.areThingsEqual=d,e.exports.compareThings=f},{underscore:19,util:3}],11:[function(t,e){function n(t){var e,r,i;if(this.db=t.db,this.inMemoryOnly=this.db.inMemoryOnly,this.filename=this.db.filename,this.corruptAlertThreshold=void 0!==t.corruptAlertThreshold?t.corruptAlertThreshold:.1,!this.inMemoryOnly&&this.filename&&"~"===this.filename.charAt(this.filename.length-1))throw new Error("The datafile name can't end with a ~, which is reserved for crash safe backup files");if(t.afterSerialization&&!t.beforeDeserialization)throw new Error("Serialization hook defined but deserialization hook undefined, cautiously refusing to start NeDB to prevent dataloss");if(!t.afterSerialization&&t.beforeDeserialization)throw new Error("Serialization hook undefined but deserialization hook defined, cautiously refusing to start NeDB to prevent dataloss");for(this.afterSerialization=t.afterSerialization||function(t){return t},this.beforeDeserialization=t.beforeDeserialization||function(t){return t},e=1;30>e;e+=1)for(r=0;10>r;r+=1)if(i=s.uid(e),this.beforeDeserialization(this.afterSerialization(i))!==i)throw new Error("beforeDeserialization is not the reverse of afterSerialization, cautiously refusing to start NeDB to prevent dataloss");this.filename&&t.nodeWebkitAppName&&(console.log("=================================================================="),console.log("WARNING: The nodeWebkitAppName option is deprecated"),console.log("To get the path to the directory where Node Webkit stores the data"),console.log("for your app, use the internal nw.gui module like this"),console.log("require('nw.gui').App.dataPath"),console.log("See https://github.com/rogerwang/node-webkit/issues/500"),console.log("=================================================================="),this.filename=n.getNWAppFilename(t.nodeWebkitAppName,this.filename))}var r=t("__browserify_process"),i=t("./storage"),o=t("path"),a=t("./model"),u=t("async"),s=t("./customUtils"),c=t("./indexes");n.ensureDirectoryExists=function(t,e){var n=e||function(){};i.mkdirp(t,(function(t){return n(t)}))},n.getNWAppFilename=function(t,e){var n;switch(r.platform){case"win32":case"win64":if(n=r.env.LOCALAPPDATA||r.env.APPDATA,!n)throw new Error("Couldn't find the base application data folder");n=o.join(n,t);break;case"darwin":if(n=r.env.HOME,!n)throw new Error("Couldn't find the base application data directory");n=o.join(n,"Library","Application Support",t);break;case"linux":if(n=r.env.HOME,!n)throw new Error("Couldn't find the base application data directory");n=o.join(n,".config",t);break;default:throw new Error("Can't use the Node Webkit relative path for platform "+r.platform)}return o.join(n,"nedb-data",e)},n.prototype.persistCachedDatabase=function(t){var e=t||function(){},n="",r=this;return this.inMemoryOnly?e(null):(this.db.getAllData().forEach((function(t){n+=r.afterSerialization(a.serialize(t))+"\n"})),Object.keys(this.db.indexes).forEach((function(t){"_id"!=t&&(n+=r.afterSerialization(a.serialize({$$indexCreated:{fieldName:t,unique:r.db.indexes[t].unique,sparse:r.db.indexes[t].sparse}}))+"\n")})),i.crashSafeWriteFile(this.filename,n,(function(t){return t?e(t):(r.db.emit("compaction.done"),e(null))})),void 0)},n.prototype.compactDatafile=function(){this.db.executor.push({this:this,fn:this.persistCachedDatabase,arguments:[]})},n.prototype.setAutocompactionInterval=function(t){var e=this,n=5e3,r=Math.max(t||0,n);this.stopAutocompaction(),this.autocompactionIntervalId=setInterval((function(){e.compactDatafile()}),r)},n.prototype.stopAutocompaction=function(){this.autocompactionIntervalId&&clearInterval(this.autocompactionIntervalId)},n.prototype.persistNewState=function(t,e){var n=this,r="",o=e||function(){};return n.inMemoryOnly?o(null):(t.forEach((function(t){r+=n.afterSerialization(a.serialize(t))+"\n"})),0===r.length?o(null):(i.appendFile(n.filename,r,"utf8",(function(t){return o(t)})),void 0))},n.prototype.treatRawData=function(t){var e,n=t.split("\n"),r={},i=[],o={},u=-1;for(e=0;e<n.length;e+=1){var s;try{s=a.deserialize(this.beforeDeserialization(n[e])),s._id?s.$$deleted===!0?delete r[s._id]:r[s._id]=s:s.$$indexCreated&&void 0!=s.$$indexCreated.fieldName?o[s.$$indexCreated.fieldName]=s.$$indexCreated:"string"==typeof s.$$indexRemoved&&delete o[s.$$indexRemoved]}catch(c){u+=1}}if(n.length>0&&u/n.length>this.corruptAlertThreshold)throw new Error("More than "+Math.floor(100*this.corruptAlertThreshold)+"% of the data file is corrupt, the wrong beforeDeserialization hook may be used. Cautiously refusing to start NeDB to prevent dataloss");return Object.keys(r).forEach((function(t){i.push(r[t])})),{data:i,indexes:o}},n.prototype.loadDatabase=function(t){var e=t||function(){},r=this;return r.db.resetIndexes(),r.inMemoryOnly?e(null):(u.waterfall([function(t){n.ensureDirectoryExists(o.dirname(r.filename),(function(){i.ensureDatafileIntegrity(r.filename,(function(){i.readFile(r.filename,"utf8",(function(e,n){if(e)return t(e);try{var i=r.treatRawData(n)}catch(o){return t(o)}Object.keys(i.indexes).forEach((function(t){r.db.indexes[t]=new c(i.indexes[t])}));try{r.db.resetIndexes(i.data)}catch(o){return r.db.resetIndexes(),t(o)}r.db.persistence.persistCachedDatabase(t)}))}))}))}],(function(t){return t?e(t):(r.db.executor.processBuffer(),e(null))})),void 0)},e.exports=n},{"./customUtils":6,"./indexes":9,"./model":10,"./storage":12,__browserify_process:4,async:13,path:2}],12:[function(t,e){function n(t,e){f.getItem(t,(function(t,n){return null!==n?e(!0):e(!1)}))}function r(t,e,n){f.getItem(t,(function(r,i){null===i?f.removeItem(e,(function(){return n()})):f.setItem(e,i,(function(){f.removeItem(t,(function(){return n()}))}))}))}function i(t,e,n,r){"function"==typeof n&&(r=n),f.setItem(t,e,(function(){return r()}))}function o(t,e,n,r){"function"==typeof n&&(r=n),f.getItem(t,(function(n,i){i=i||"",i+=e,f.setItem(t,i,(function(){return r()}))}))}function a(t,e,n){"function"==typeof e&&(n=e),f.getItem(t,(function(t,e){return n(null,e||"")}))}function u(t,e){f.removeItem(t,(function(){return e()}))}function s(t,e){return e()}function c(t,e){return e(null)}var f=t("localforage");f.config({name:"NeDB",storeName:"nedbdata"}),e.exports.exists=n,e.exports.rename=r,e.exports.writeFile=i,e.exports.crashSafeWriteFile=i,e.exports.appendFile=o,e.exports.readFile=a,e.exports.unlink=u,e.exports.mkdirp=s,e.exports.ensureDatafileIntegrity=c},{localforage:18}],13:[function(e,n){var r=e("__browserify_process");!function(){function e(t){var e=!1;return function(){if(e)throw new Error("Callback was already called.");e=!0,t.apply(i,arguments)}}var i,o,a={};i=this,null!=i&&(o=i.async),a.noConflict=function(){return i.async=o,a};var u=function(t,e){if(t.forEach)return t.forEach(e);for(var n=0;n<t.length;n+=1)e(t[n],n,t)},s=function(t,e){if(t.map)return t.map(e);var n=[];return u(t,(function(t,r,i){n.push(e(t,r,i))})),n},c=function(t,e,n){return t.reduce?t.reduce(e,n):(u(t,(function(t,r,i){n=e(n,t,r,i)})),n)},f=function(t){if(Object.keys)return Object.keys(t);var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n);return e};"undefined"!=typeof r&&r.nextTick?(a.nextTick=r.nextTick,a.setImmediate="undefined"!=typeof setImmediate?function(t){setImmediate(t)}:a.nextTick):"function"==typeof setImmediate?(a.nextTick=function(t){setImmediate(t)},a.setImmediate=a.nextTick):(a.nextTick=function(t){setTimeout(t,0)},a.setImmediate=a.nextTick),a.each=function(t,n,r){if(r=r||function(){},!t.length)return r();var i=0;u(t,(function(o){n(o,e((function(e){e?(r(e),r=function(){}):(i+=1,i>=t.length&&r(null))})))}))},a.forEach=a.each,a.eachSeries=function(t,e,n){if(n=n||function(){},!t.length)return n();var r=0,i=function(){e(t[r],(function(e){e?(n(e),n=function(){}):(r+=1,r>=t.length?n(null):i())}))};i()},a.forEachSeries=a.eachSeries,a.eachLimit=function(t,e,n,r){var i=l(e);i.apply(null,[t,n,r])},a.forEachLimit=a.eachLimit;var l=function(t){return function(e,n,r){if(r=r||function(){},!e.length||0>=t)return r();var i=0,o=0,a=0;!function u(){if(i>=e.length)return r();for(;t>a&&o<e.length;)o+=1,a+=1,n(e[o-1],(function(t){t?(r(t),r=function(){}):(i+=1,a-=1,i>=e.length?r():u())}))}()}},h=function(t){return function(){var e=Array.prototype.slice.call(arguments);return t.apply(null,[a.each].concat(e))}},p=function(t,e){return function(){var n=Array.prototype.slice.call(arguments);return e.apply(null,[l(t)].concat(n))}},d=function(t){return function(){var e=Array.prototype.slice.call(arguments);return t.apply(null,[a.eachSeries].concat(e))}},y=function(t,e,n,r){var i=[];e=s(e,(function(t,e){return{index:e,value:t}})),t(e,(function(t,e){n(t.value,(function(n,r){i[t.index]=r,e(n)}))}),(function(t){r(t,i)}))};a.map=h(y),a.mapSeries=d(y),a.mapLimit=function(t,e,n,r){return v(e)(t,n,r)};var v=function(t){return p(t,y)};a.reduce=function(t,e,n,r){a.eachSeries(t,(function(t,r){n(e,t,(function(t,n){e=n,r(t)}))}),(function(t){r(t,e)}))},a.inject=a.reduce,a.foldl=a.reduce,a.reduceRight=function(t,e,n,r){var i=s(t,(function(t){return t})).reverse();a.reduce(i,e,n,r)},a.foldr=a.reduceRight;var g=function(t,e,n,r){var i=[];e=s(e,(function(t,e){return{index:e,value:t}})),t(e,(function(t,e){n(t.value,(function(n){n&&i.push(t),e()}))}),(function(){r(s(i.sort((function(t,e){return t.index-e.index})),(function(t){return t.value})))}))};a.filter=h(g),a.filterSeries=d(g),a.select=a.filter,a.selectSeries=a.filterSeries;var m=function(t,e,n,r){var i=[];e=s(e,(function(t,e){return{index:e,value:t}})),t(e,(function(t,e){n(t.value,(function(n){n||i.push(t),e()}))}),(function(){r(s(i.sort((function(t,e){return t.index-e.index})),(function(t){return t.value})))}))};a.reject=h(m),a.rejectSeries=d(m);var b=function(t,e,n,r){t(e,(function(t,e){n(t,(function(n){n?(r(t),r=function(){}):e()}))}),(function(){r()}))};a.detect=h(b),a.detectSeries=d(b),a.some=function(t,e,n){a.each(t,(function(t,r){e(t,(function(t){t&&(n(!0),n=function(){}),r()}))}),(function(){n(!1)}))},a.any=a.some,a.every=function(t,e,n){a.each(t,(function(t,r){e(t,(function(t){t||(n(!1),n=function(){}),r()}))}),(function(){n(!0)}))},a.all=a.every,a.sortBy=function(t,e,n){a.map(t,(function(t,n){e(t,(function(e,r){e?n(e):n(null,{value:t,criteria:r})}))}),(function(t,e){if(t)return n(t);var r=function(t,e){var n=t.criteria,r=e.criteria;return r>n?-1:n>r?1:0};n(null,s(e.sort(r),(function(t){return t.value})))}))},a.auto=function(t,e){e=e||function(){};var n=f(t);if(!n.length)return e(null);var r={},i=[],o=function(t){i.unshift(t)},s=function(t){for(var e=0;e<i.length;e+=1)if(i[e]===t)return i.splice(e,1),void 0},l=function(){u(i.slice(0),(function(t){t()}))};o((function(){f(r).length===n.length&&(e(null,r),e=function(){})})),u(n,(function(n){var i=t[n]instanceof Function?[t[n]]:t[n],h=function(t){var i=Array.prototype.slice.call(arguments,1);if(i.length<=1&&(i=i[0]),t){var o={};u(f(r),(function(t){o[t]=r[t]})),o[n]=i,e(t,o),e=function(){}}else r[n]=i,a.setImmediate(l)},p=i.slice(0,Math.abs(i.length-1))||[],d=function(){return c(p,(function(t,e){return t&&r.hasOwnProperty(e)}),!0)&&!r.hasOwnProperty(n)};if(d())i[i.length-1](h,r);else{var y=function(){d()&&(s(y),i[i.length-1](h,r))};o(y)}}))},a.waterfall=function(t,e){if(e=e||function(){},t.constructor!==Array){var n=new Error("First argument to waterfall must be an array of functions");return e(n)}if(!t.length)return e();var r=function(t){return function(n){if(n)e.apply(null,arguments),e=function(){};else{var i=Array.prototype.slice.call(arguments,1),o=t.next();o?i.push(r(o)):i.push(e),a.setImmediate((function(){t.apply(null,i)}))}}};r(a.iterator(t))()};var w=function(t,e,n){if(n=n||function(){},e.constructor===Array)t.map(e,(function(t,e){t&&t((function(t){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),e.call(null,t,n)}))}),n);else{var r={};t.each(f(e),(function(t,n){e[t]((function(e){var i=Array.prototype.slice.call(arguments,1);i.length<=1&&(i=i[0]),r[t]=i,n(e)}))}),(function(t){n(t,r)}))}};a.parallel=function(t,e){w({map:a.map,each:a.each},t,e)},a.parallelLimit=function(t,e,n){w({map:v(e),each:l(e)},t,n)},a.series=function(t,e){if(e=e||function(){},t.constructor===Array)a.mapSeries(t,(function(t,e){t&&t((function(t){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),e.call(null,t,n)}))}),e);else{var n={};a.eachSeries(f(t),(function(e,r){t[e]((function(t){var i=Array.prototype.slice.call(arguments,1);i.length<=1&&(i=i[0]),n[e]=i,r(t)}))}),(function(t){e(t,n)}))}},a.iterator=function(t){var e=function(n){var r=function(){return t.length&&t[n].apply(null,arguments),r.next()};return r.next=function(){return n<t.length-1?e(n+1):null},r};return e(0)},a.apply=function(t){var e=Array.prototype.slice.call(arguments,1);return function(){return t.apply(null,e.concat(Array.prototype.slice.call(arguments)))}};var _=function(t,e,n,r){var i=[];t(e,(function(t,e){n(t,(function(t,n){i=i.concat(n||[]),e(t)}))}),(function(t){r(t,i)}))};a.concat=h(_),a.concatSeries=d(_),a.whilst=function(t,e,n){t()?e((function(r){return r?n(r):(a.whilst(t,e,n),void 0)})):n()},a.doWhilst=function(t,e,n){t((function(r){return r?n(r):(e()?a.doWhilst(t,e,n):n(),void 0)}))},a.until=function(t,e,n){t()?n():e((function(r){return r?n(r):(a.until(t,e,n),void 0)}))},a.doUntil=function(t,e,n){t((function(r){return r?n(r):(e()?n():a.doUntil(t,e,n),void 0)}))},a.queue=function(t,n){function r(t,e,r,i){e.constructor!==Array&&(e=[e]),u(e,(function(e){var o={data:e,callback:"function"==typeof i?i:null};r?t.tasks.unshift(o):t.tasks.push(o),t.saturated&&t.tasks.length===n&&t.saturated(),a.setImmediate(t.process)}))}void 0===n&&(n=1);var i=0,o={tasks:[],concurrency:n,saturated:null,empty:null,drain:null,push:function(t,e){r(o,t,!1,e)},unshift:function(t,e){r(o,t,!0,e)},process:function(){if(i<o.concurrency&&o.tasks.length){var n=o.tasks.shift();o.empty&&0===o.tasks.length&&o.empty(),i+=1;var r=function(){i-=1,n.callback&&n.callback.apply(n,arguments),o.drain&&0===o.tasks.length+i&&o.drain(),o.process()},a=e(r);t(n.data,a)}},length:function(){return o.tasks.length},running:function(){return i}};return o},a.cargo=function(t,e){var n=!1,r=[],i={tasks:r,payload:e,saturated:null,empty:null,drain:null,push:function(t,n){t.constructor!==Array&&(t=[t]),u(t,(function(t){r.push({data:t,callback:"function"==typeof n?n:null}),i.saturated&&r.length===e&&i.saturated()})),a.setImmediate(i.process)},process:function o(){if(!n){if(0===r.length)return i.drain&&i.drain(),void 0;var a="number"==typeof e?r.splice(0,e):r.splice(0),c=s(a,(function(t){return t.data}));i.empty&&i.empty(),n=!0,t(c,(function(){n=!1;var t=arguments;u(a,(function(e){e.callback&&e.callback.apply(null,t)})),o()}))}},length:function(){return r.length},running:function(){return n}};return i};var k=function(t){return function(e){var n=Array.prototype.slice.call(arguments,1);e.apply(null,n.concat([function(e){var n=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(e?console.error&&console.error(e):console[t]&&u(n,(function(e){console[t](e)})))}]))}};a.log=k("log"),a.dir=k("dir"),a.memoize=function(t,e){var n={},r={};e=e||function(t){return t};var i=function(){var i=Array.prototype.slice.call(arguments),o=i.pop(),a=e.apply(null,i);a in n?o.apply(null,n[a]):a in r?r[a].push(o):(r[a]=[o],t.apply(null,i.concat([function(){n[a]=arguments;var t=r[a];delete r[a];for(var e=0,i=t.length;i>e;e++)t[e].apply(null,arguments)}])))};return i.memo=n,i.unmemoized=t,i},a.unmemoize=function(t){return function(){return(t.unmemoized||t).apply(null,arguments)}},a.times=function(t,e,n){for(var r=[],i=0;t>i;i++)r.push(i);return a.map(r,e,n)},a.timesSeries=function(t,e,n){for(var r=[],i=0;t>i;i++)r.push(i);return a.mapSeries(r,e,n)},a.compose=function(){var t=Array.prototype.reverse.call(arguments);return function(){var e=this,n=Array.prototype.slice.call(arguments),r=n.pop();a.reduce(t,n,(function(t,n,r){n.apply(e,t.concat([function(){var t=arguments[0],e=Array.prototype.slice.call(arguments,1);r(t,e)}]))}),(function(t,n){r.apply(e,[t].concat(n))}))}};var x=function(t,e){var n=function(){var n=this,r=Array.prototype.slice.call(arguments),i=r.pop();return t(e,(function(t,e){t.apply(n,r.concat([e]))}),i)};if(arguments.length>2){var r=Array.prototype.slice.call(arguments,2);return n.apply(this,r)}return n};a.applyEach=h(x),a.applyEachSeries=d(x),a.forever=function(t,e){function n(r){if(r){if(e)return e(r);throw r}t(n)}n()},"undefined"!=typeof t&&t.amd?t([],(function(){return a})):"undefined"!=typeof n&&n.exports?n.exports=a:i.async=a}()},{__browserify_process:4}],14:[function(t,e){e.exports.BinarySearchTree=t("./server/bst"),e.exports.AVLTree=t("./server/avltree")},{"./server/avltree":15,"./server/bst":16}],15:[function(t,e){function n(t){this.tree=new r(t)}function r(t){t=t||{},this.left=null,this.right=null,this.parent=void 0!==t.parent?t.parent:null,t.hasOwnProperty("key")&&(this.key=t.key),this.data=t.hasOwnProperty("value")?[t.value]:[],this.unique=t.unique||!1,this.compareKeys=t.compareKeys||o.defaultCompareKeysFunction,this.checkValueEquality=t.checkValueEquality||o.defaultCheckValueEquality}var i=t("./bst"),o=t("./customUtils"),a=t("util");t("underscore"),a.inherits(r,i),n._AVLTree=r,r.prototype.checkHeightCorrect=function(){var t,e;if(this.hasOwnProperty("key")){if(this.left&&void 0===this.left.height)throw new Error("Undefined height for node "+this.left.key);if(this.right&&void 0===this.right.height)throw new Error("Undefined height for node "+this.right.key);if(void 0===this.height)throw new Error("Undefined height for node "+this.key);if(t=this.left?this.left.height:0,e=this.right?this.right.height:0,this.height!==1+Math.max(t,e))throw new Error("Height constraint failed for node "+this.key);this.left&&this.left.checkHeightCorrect(),this.right&&this.right.checkHeightCorrect()}},r.prototype.balanceFactor=function(){var t=this.left?this.left.height:0,e=this.right?this.right.height:0;return t-e},r.prototype.checkBalanceFactors=function(){if(Math.abs(this.balanceFactor())>1)throw new Error("Tree is unbalanced at node "+this.key);this.left&&this.left.checkBalanceFactors(),this.right&&this.right.checkBalanceFactors()},r.prototype.checkIsAVLT=function(){r.super_.prototype.checkIsBST.call(this),this.checkHeightCorrect(),this.checkBalanceFactors()},n.prototype.checkIsAVLT=function(){this.tree.checkIsAVLT()},r.prototype.rightRotation=function(){var t,e,n,r,i=this,o=this.left;return o?(t=o.right,i.parent?(o.parent=i.parent,i.parent.left===i?i.parent.left=o:i.parent.right=o):o.parent=null,o.right=i,i.parent=o,i.left=t,t&&(t.parent=i),e=o.left?o.left.height:0,n=t?t.height:0,r=i.right?i.right.height:0,i.height=Math.max(n,r)+1,o.height=Math.max(e,i.height)+1,o):this},r.prototype.leftRotation=function(){var t,e,n,r,i=this,o=this.right;return o?(t=o.left,i.parent?(o.parent=i.parent,i.parent.left===i?i.parent.left=o:i.parent.right=o):o.parent=null,o.left=i,i.parent=o,i.right=t,t&&(t.parent=i),e=i.left?i.left.height:0,n=t?t.height:0,r=o.right?o.right.height:0,i.height=Math.max(e,n)+1,o.height=Math.max(r,i.height)+1,o):this},r.prototype.rightTooSmall=function(){return this.balanceFactor()<=1?this:(this.left.balanceFactor()<0&&this.left.leftRotation(),this.rightRotation())},r.prototype.leftTooSmall=function(){return this.balanceFactor()>=-1?this:(this.right.balanceFactor()>0&&this.right.rightRotation(),this.leftRotation())},r.prototype.rebalanceAlongPath=function(t){var e,n,r=this;if(!this.hasOwnProperty("key"))return delete this.height,this;for(n=t.length-1;n>=0;n-=1)t[n].height=1+Math.max(t[n].left?t[n].left.height:0,t[n].right?t[n].right.height:0),t[n].balanceFactor()>1&&(e=t[n].rightTooSmall(),0===n&&(r=e)),t[n].balanceFactor()<-1&&(e=t[n].leftTooSmall(),0===n&&(r=e));return r},r.prototype.insert=function(t,e){var n=[],r=this;if(!this.hasOwnProperty("key"))return this.key=t,this.data.push(e),this.height=1,this;for(;;){if(0===r.compareKeys(r.key,t)){if(r.unique){var i=new Error("Can't insert key "+t+", it violates the unique constraint");throw i.key=t,i.errorType="uniqueViolated",i}return r.data.push(e),this}if(n.push(r),r.compareKeys(t,r.key)<0){if(!r.left){n.push(r.createLeftChild({key:t,value:e}));break}r=r.left}else{if(!r.right){n.push(r.createRightChild({key:t,value:e}));break}r=r.right}}return this.rebalanceAlongPath(n)},n.prototype.insert=function(t,e){var n=this.tree.insert(t,e);n&&(this.tree=n)},r.prototype.delete=function(t,e){var n,r=[],i=this,o=[];if(!this.hasOwnProperty("key"))return this;for(;;){if(0===i.compareKeys(t,i.key))break;if(o.push(i),i.compareKeys(t,i.key)<0){if(!i.left)return this;i=i.left}else{if(!i.right)return this;i=i.right}}if(i.data.length>1&&e)return i.data.forEach((function(t){i.checkValueEquality(t,e)||r.push(t)})),i.data=r,this;if(!i.left&&!i.right)return i===this?(delete i.key,i.data=[],delete i.height,this):(i.parent.left===i?i.parent.left=null:i.parent.right=null,this.rebalanceAlongPath(o));if(!i.left||!i.right)return n=i.left?i.left:i.right,i===this?(n.parent=null,n):(i.parent.left===i?(i.parent.left=n,n.parent=i.parent):(i.parent.right=n,n.parent=i.parent),this.rebalanceAlongPath(o));if(o.push(i),n=i.left,!n.right)return i.key=n.key,i.data=n.data,i.left=n.left,n.left&&(n.left.parent=i),this.rebalanceAlongPath(o);for(;;){if(!n.right)break;o.push(n),n=n.right}return i.key=n.key,i.data=n.data,n.parent.right=n.left,n.left&&(n.left.parent=n.parent),this.rebalanceAlongPath(o)},n.prototype.delete=function(t,e){var n=this.tree.delete(t,e);n&&(this.tree=n)},["getNumberOfKeys","search","betweenBounds","prettyPrint","executeOnEveryNode"].forEach((function(t){n.prototype[t]=function(){return this.tree[t].apply(this.tree,arguments)}})),e.exports=n},{"./bst":16,"./customUtils":17,underscore:19,util:3}],16:[function(t,e){function n(t){t=t||{},this.left=null,this.right=null,this.parent=void 0!==t.parent?t.parent:null,t.hasOwnProperty("key")&&(this.key=t.key),this.data=t.hasOwnProperty("value")?[t.value]:[],this.unique=t.unique||!1,this.compareKeys=t.compareKeys||i.defaultCompareKeysFunction,this.checkValueEquality=t.checkValueEquality||i.defaultCheckValueEquality}function r(t,e){var n;for(n=0;n<e.length;n+=1)t.push(e[n])}var i=t("./customUtils");n.prototype.getMaxKeyDescendant=function(){return this.right?this.right.getMaxKeyDescendant():this},n.prototype.getMaxKey=function(){return this.getMaxKeyDescendant().key},n.prototype.getMinKeyDescendant=function(){return this.left?this.left.getMinKeyDescendant():this},n.prototype.getMinKey=function(){return this.getMinKeyDescendant().key},n.prototype.checkAllNodesFullfillCondition=function(t){this.hasOwnProperty("key")&&(t(this.key,this.data),this.left&&this.left.checkAllNodesFullfillCondition(t),this.right&&this.right.checkAllNodesFullfillCondition(t))},n.prototype.checkNodeOrdering=function(){var t=this;this.hasOwnProperty("key")&&(this.left&&(this.left.checkAllNodesFullfillCondition((function(e){if(t.compareKeys(e,t.key)>=0)throw new Error("Tree with root "+t.key+" is not a binary search tree")})),this.left.checkNodeOrdering()),this.right&&(this.right.checkAllNodesFullfillCondition((function(e){if(t.compareKeys(e,t.key)<=0)throw new Error("Tree with root "+t.key+" is not a binary search tree")})),this.right.checkNodeOrdering()))},n.prototype.checkInternalPointers=function(){if(this.left){if(this.left.parent!==this)throw new Error("Parent pointer broken for key "+this.key);this.left.checkInternalPointers()}if(this.right){if(this.right.parent!==this)throw new Error("Parent pointer broken for key "+this.key);this.right.checkInternalPointers()}},n.prototype.checkIsBST=function(){if(this.checkNodeOrdering(),this.checkInternalPointers(),this.parent)throw new Error("The root shouldn't have a parent")},n.prototype.getNumberOfKeys=function(){var t;return this.hasOwnProperty("key")?(t=1,this.left&&(t+=this.left.getNumberOfKeys()),this.right&&(t+=this.right.getNumberOfKeys()),t):0},n.prototype.createSimilar=function(t){return t=t||{},t.unique=this.unique,t.compareKeys=this.compareKeys,t.checkValueEquality=this.checkValueEquality,new this.constructor(t)},n.prototype.createLeftChild=function(t){var e=this.createSimilar(t);return e.parent=this,this.left=e,e},n.prototype.createRightChild=function(t){var e=this.createSimilar(t);return e.parent=this,this.right=e,e},n.prototype.insert=function(t,e){if(!this.hasOwnProperty("key"))return this.key=t,this.data.push(e),void 0;if(0===this.compareKeys(this.key,t)){if(this.unique){var n=new Error("Can't insert key "+t+", it violates the unique constraint");throw n.key=t,n.errorType="uniqueViolated",n}return this.data.push(e),void 0}this.compareKeys(t,this.key)<0?this.left?this.left.insert(t,e):this.createLeftChild({key:t,value:e}):this.right?this.right.insert(t,e):this.createRightChild({key:t,value:e})},n.prototype.search=function(t){return this.hasOwnProperty("key")?0===this.compareKeys(this.key,t)?this.data:this.compareKeys(t,this.key)<0?this.left?this.left.search(t):[]:this.right?this.right.search(t):[]:[]},n.prototype.getLowerBoundMatcher=function(t){var e=this;return t.hasOwnProperty("$gt")||t.hasOwnProperty("$gte")?t.hasOwnProperty("$gt")&&t.hasOwnProperty("$gte")?0===e.compareKeys(t.$gte,t.$gt)?function(n){return e.compareKeys(n,t.$gt)>0}:e.compareKeys(t.$gte,t.$gt)>0?function(n){return e.compareKeys(n,t.$gte)>=0}:function(n){return e.compareKeys(n,t.$gt)>0}:t.hasOwnProperty("$gt")?function(n){return e.compareKeys(n,t.$gt)>0}:function(n){return e.compareKeys(n,t.$gte)>=0}:function(){return!0}},n.prototype.getUpperBoundMatcher=function(t){var e=this;return t.hasOwnProperty("$lt")||t.hasOwnProperty("$lte")?t.hasOwnProperty("$lt")&&t.hasOwnProperty("$lte")?0===e.compareKeys(t.$lte,t.$lt)?function(n){return e.compareKeys(n,t.$lt)<0}:e.compareKeys(t.$lte,t.$lt)<0?function(n){return e.compareKeys(n,t.$lte)<=0}:function(n){return e.compareKeys(n,t.$lt)<0}:t.hasOwnProperty("$lt")?function(n){return e.compareKeys(n,t.$lt)<0}:function(n){return e.compareKeys(n,t.$lte)<=0}:function(){return!0}},n.prototype.betweenBounds=function(t,e,n){var i=[];return this.hasOwnProperty("key")?(e=e||this.getLowerBoundMatcher(t),n=n||this.getUpperBoundMatcher(t),e(this.key)&&this.left&&r(i,this.left.betweenBounds(t,e,n)),e(this.key)&&n(this.key)&&r(i,this.data),n(this.key)&&this.right&&r(i,this.right.betweenBounds(t,e,n)),i):[]},n.prototype.deleteIfLeaf=function(){return this.left||this.right?!1:this.parent?(this.parent.left===this?this.parent.left=null:this.parent.right=null,!0):(delete this.key,this.data=[],!0)},n.prototype.deleteIfOnlyOneChild=function(){var t;return this.left&&!this.right&&(t=this.left),!this.left&&this.right&&(t=this.right),t?this.parent?(this.parent.left===this?(this.parent.left=t,t.parent=this.parent):(this.parent.right=t,t.parent=this.parent),!0):(this.key=t.key,this.data=t.data,this.left=null,t.left&&(this.left=t.left,t.left.parent=this),this.right=null,t.right&&(this.right=t.right,t.right.parent=this),!0):!1},n.prototype.delete=function(t,e){var n,r=[],i=this;if(this.hasOwnProperty("key")){if(this.compareKeys(t,this.key)<0)return this.left&&this.left.delete(t,e),void 0;if(this.compareKeys(t,this.key)>0)return this.right&&this.right.delete(t,e),void 0;if(0!==!this.compareKeys(t,this.key))return this.data.length>1&&void 0!==e?(this.data.forEach((function(t){i.checkValueEquality(t,e)||r.push(t)})),i.data=r,void 0):(this.deleteIfLeaf()||this.deleteIfOnlyOneChild()||(Math.random()>=.5?(n=this.left.getMaxKeyDescendant(),this.key=n.key,this.data=n.data,this===n.parent?(this.left=n.left,n.left&&(n.left.parent=n.parent)):(n.parent.right=n.left,n.left&&(n.left.parent=n.parent))):(n=this.right.getMinKeyDescendant(),this.key=n.key,this.data=n.data,this===n.parent?(this.right=n.right,n.right&&(n.right.parent=n.parent)):(n.parent.left=n.right,n.right&&(n.right.parent=n.parent)))),void 0)}},n.prototype.executeOnEveryNode=function(t){this.left&&this.left.executeOnEveryNode(t),t(this),this.right&&this.right.executeOnEveryNode(t)},n.prototype.prettyPrint=function(t,e){e=e||"",console.log(e+"* "+this.key),t&&console.log(e+"* "+this.data),(this.left||this.right)&&(this.left?this.left.prettyPrint(t,e+"  "):console.log(e+"  *"),this.right?this.right.prettyPrint(t,e+"  "):console.log(e+"  *"))},e.exports=n},{"./customUtils":17}],17:[function(t,e){function n(t){var e,r;return 0===t?[]:1===t?[0]:(e=n(t-1),r=Math.floor(Math.random()*t),e.splice(r,0,t-1),e)}function r(t,e){if(e>t)return-1;if(t>e)return 1;if(t===e)return 0;var n=new Error("Couldn't compare elements");throw n.a=t,n.b=e,n}function i(t,e){return t===e}e.exports.getRandomArray=n,e.exports.defaultCompareKeysFunction=r,e.exports.defaultCheckValueEquality=i},{}],18:[function(e,n,r){var i=e("__browserify_process"),o=self;!function(){var t,e,n,r;!function(){var i={},o={};t=function(t,e,n){i[t]={deps:e,callback:n}},r=n=e=function(t){function n(e){if("."!==e.charAt(0))return e;for(var n=e.split("/"),r=t.split("/").slice(0,-1),i=0,o=n.length;o>i;i++){var a=n[i];if(".."===a)r.pop();else{if("."===a)continue;r.push(a)}}return r.join("/")}if(r._eak_seen=i,o[t])return o[t];if(o[t]={},!i[t])throw new Error("Could not find module "+t);for(var a,u=i[t],s=u.deps,c=u.callback,f=[],l=0,h=s.length;h>l;l++)"exports"===s[l]?f.push(a={}):f.push(e(n(s[l])));var p=c.apply(this,f);return o[t]=a||p}}(),t("promise/all",["./utils","exports"],(function(t,e){"use strict";function n(t){var e=this;if(!r(t))throw new TypeError("You must pass an array to all.");return new e((function(e,n){function r(t){return function(e){o(t,e)}}function o(t,n){u[t]=n,0===--s&&e(u)}var a,u=[],s=t.length;0===s&&e([]);for(var c=0;c<t.length;c++)a=t[c],a&&i(a.then)?a.then(r(c),n):o(c,a)}))}var r=t.isArray,i=t.isFunction;e.all=n})),t("promise/asap",["exports"],(function(t){"use strict";function e(){return function(){i.nextTick(a)}}function n(){var t=0,e=new f(a),n=document.createTextNode("");return e.observe(n,{characterData:!0}),function(){n.data=t=++t%2}}function r(){return function(){l.setTimeout(a,1)}}function a(){for(var t=0;t<h.length;t++){var e=h[t],n=e[0],r=e[1];n(r)}h=[]}function u(t,e){var n=h.push([t,e]);1===n&&s()}var s,c="undefined"!=typeof window?window:{},f=c.MutationObserver||c.WebKitMutationObserver,l="undefined"!=typeof o?o:void 0===this?window:this,h=[];s="undefined"!=typeof i&&"[object process]"==={}.toString.call(i)?e():f?n():r(),t.asap=u})),t("promise/config",["exports"],(function(t){"use strict";function e(t,e){return 2!==arguments.length?n[t]:(n[t]=e,void 0)}var n={instrument:!1};t.config=n,t.configure=e})),t("promise/polyfill",["./promise","./utils","exports"],(function(t,e,n){"use strict";function r(){var t;t="undefined"!=typeof o?o:"undefined"!=typeof window&&window.document?window:self;var e="Promise"in t&&"resolve"in t.Promise&&"reject"in t.Promise&&"all"in t.Promise&&"race"in t.Promise&&function(){var e;return new t.Promise((function(t){e=t})),a(e)}();e||(t.Promise=i)}var i=t.Promise,a=e.isFunction;n.polyfill=r})),t("promise/promise",["./config","./utils","./all","./race","./resolve","./reject","./asap","exports"],(function(t,e,n,r,i,o,a,u){"use strict";function s(t){if(!_(t))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof s))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],c(t,this)}function c(t,e){function n(t){d(e,t)}function r(t){v(e,t)}try{t(n,r)}catch(i){r(i)}}function f(t,e,n,r){var i,o,a,u,s=_(n);if(s)try{i=n(r),a=!0}catch(c){u=!0,o=c}else i=r,a=!0;p(e,i)||(s&&a?d(e,i):u?v(e,o):t===I?d(e,i):t===$&&v(e,i))}function l(t,e,n,r){var i=t._subscribers,o=i.length;i[o]=e,i[o+I]=n,i[o+$]=r}function h(t,e){for(var n,r,i=t._subscribers,o=t._detail,a=0;a<i.length;a+=3)n=i[a],r=i[a+e],f(e,n,r,o);t._subscribers=null}function p(t,e){var n,r=null;try{if(t===e)throw new TypeError("A promises callback cannot return that same promise.");if(w(e)&&(r=e.then,_(r)))return r.call(e,(function(r){return n?!0:(n=!0,e!==r?d(t,r):y(t,r),void 0)}),(function(e){return n?!0:(n=!0,v(t,e),void 0)})),!0}catch(i){return n?!0:(v(t,i),!0)}return!1}function d(t,e){t===e?y(t,e):p(t,e)||y(t,e)}function y(t,e){t._state===S&&(t._state=j,t._detail=e,b.async(g,t))}function v(t,e){t._state===S&&(t._state=j,t._detail=e,b.async(m,t))}function g(t){h(t,t._state=I)}function m(t){h(t,t._state=$)}var b=t.config;t.configure;var w=e.objectOrFunction,_=e.isFunction;e.now;var k=n.all,x=r.race,E=i.resolve,A=o.reject,O=a.asap;b.async=O;var S=void 0,j=0,I=1,$=2;s.prototype={constructor:s,_state:void 0,_detail:void 0,_subscribers:void 0,then:function(t,e){var n=this,r=new this.constructor((function(){}));if(this._state){var i=arguments;b.async((function(){f(n._state,r,i[n._state-1],n._detail)}))}else l(this,r,t,e);return r},catch:function(t){return this.then(null,t)}},s.all=k,s.race=x,s.resolve=E,s.reject=A,u.Promise=s})),t("promise/race",["./utils","exports"],(function(t,e){"use strict";function n(t){var e=this;if(!r(t))throw new TypeError("You must pass an array to race.");return new e((function(e,n){for(var r,i=0;i<t.length;i++)r=t[i],r&&"function"==typeof r.then?r.then(e,n):e(r)}))}var r=t.isArray;e.race=n})),t("promise/reject",["exports"],(function(t){"use strict";function e(t){var e=this;return new e((function(e,n){n(t)}))}t.reject=e})),t("promise/resolve",["exports"],(function(t){"use strict";function e(t){if(t&&"object"==typeof t&&t.constructor===this)return t;var e=this;return new e((function(e){e(t)}))}t.resolve=e})),t("promise/utils",["exports"],(function(t){"use strict";function e(t){return n(t)||"object"==typeof t&&null!==t}function n(t){return"function"==typeof t}function r(t){return"[object Array]"===Object.prototype.toString.call(t)}var i=Date.now||function(){return(new Date).getTime()};t.objectOrFunction=e,t.isFunction=n,t.isArray=r,t.now=i})),e("promise/polyfill").polyfill()}(),function(e,i){"object"==typeof r&&"object"==typeof n?n.exports=i():"function"==typeof t&&t.amd?t([],i):"object"==typeof r?r.localforage=i():e.localforage=i()}(this,(function(){return function(t){function e(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return t[r].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}e.__esModule=!0,function(){function t(t,e){t[e]=function(){var n=arguments;return t.ready().then((function(){return t[e].apply(t,n)}))}}function i(){for(var t=1;t<arguments.length;t++){var e=arguments[t];if(e)for(var n in e)e.hasOwnProperty(n)&&(arguments[0][n]=h(e[n])?e[n].slice():e[n])}return arguments[0]}function o(t){for(var e in u)if(u.hasOwnProperty(e)&&u[e]===t)return!0;return!1}var a={},u={INDEXEDDB:"asyncStorage",LOCALSTORAGE:"localStorageWrapper",WEBSQL:"webSQLStorage"},s=[u.INDEXEDDB,u.WEBSQL,u.LOCALSTORAGE],c=["clear","getItem","iterate","key","keys","length","removeItem","setItem"],f={description:"",driver:s.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1},l=function(t){var e=e||t.indexedDB||t.webkitIndexedDB||t.mozIndexedDB||t.OIndexedDB||t.msIndexedDB,n={};return n[u.WEBSQL]=!!t.openDatabase,n[u.INDEXEDDB]=!!function(){if("undefined"!=typeof t.openDatabase&&t.navigator&&t.navigator.userAgent&&/Safari/.test(t.navigator.userAgent)&&!/Chrome/.test(t.navigator.userAgent))return!1;try{return e&&"function"==typeof e.open&&"undefined"!=typeof t.IDBKeyRange}catch(n){return!1}}(),n[u.LOCALSTORAGE]=!!function(){try{return t.localStorage&&"setItem"in t.localStorage&&t.localStorage.setItem}catch(e){return!1}}(),n}(this),h=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},p=function(){function e(t){r(this,e),this.INDEXEDDB=u.INDEXEDDB,this.LOCALSTORAGE=u.LOCALSTORAGE,this.WEBSQL=u.WEBSQL,this._defaultConfig=i({},f),this._config=i({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver)}return e.prototype.config=function(t){if("object"==typeof t){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var e in t)"storeName"===e&&(t[e]=t[e].replace(/\W/g,"_")),this._config[e]=t[e];return"driver"in t&&t.driver&&this.setDriver(this._config.driver),!0}return"string"==typeof t?this._config[t]:this._config},e.prototype.defineDriver=function(t,e,n){var r=new Promise((function(e,n){try{var r=t._driver,i=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver"),u=new Error("Custom driver name already in use: "+t._driver);if(!t._driver)return n(i),void 0;if(o(t._driver))return n(u),void 0;for(var s=c.concat("_initStorage"),f=0;f<s.length;f++){var h=s[f];if(!h||!t[h]||"function"!=typeof t[h])return n(i),void 0}var p=Promise.resolve(!0);"_support"in t&&(p=t._support&&"function"==typeof t._support?t._support():Promise.resolve(!!t._support)),p.then((function(n){l[r]=n,a[r]=t,e()}),n)}catch(d){n(d)}}));return r.then(e,n),r},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(t,e,r){var i=this,u=function(){if(o(t))switch(t){case i.INDEXEDDB:return new Promise((function(t){t(n(1))}));case i.LOCALSTORAGE:return new Promise((function(t){t(n(2))}));case i.WEBSQL:return new Promise((function(t){t(n(4))}))}else if(a[t])return Promise.resolve(a[t]);return Promise.reject(new Error("Driver not found."))}();return u.then(e,r),u},e.prototype.getSerializer=function(t){var e=new Promise((function(t){t(n(3))}));return t&&"function"==typeof t&&e.then((function(e){t(e)})),e},e.prototype.ready=function(t){var e=this,n=e._driverSet.then((function(){return null===e._ready&&(e._ready=e._initDriver()),e._ready}));return n.then(t,t),n},e.prototype.setDriver=function(t,e,n){function r(){o._config.driver=o.driver()}function i(t){return function(){function e(){for(;n<t.length;){var i=t[n];return n++,o._dbInfo=null,o._ready=null,o.getDriver(i).then((function(t){return o._extend(t),r(),o._ready=o._initStorage(o._config),o._ready}))["catch"](e)}r();var a=new Error("No available storage method found.");return o._driverSet=Promise.reject(a),o._driverSet}var n=0;return e()}}var o=this;h(t)||(t=[t]);var a=this._getSupportedDrivers(t),u=null!==this._driverSet?this._driverSet["catch"]((function(){return Promise.resolve()})):Promise.resolve();return this._driverSet=u.then((function(){var t=a[0];return o._dbInfo=null,o._ready=null,o.getDriver(t).then((function(t){o._driver=t._driver,r(),o._wrapLibraryMethodsWithReady(),o._initDriver=i(a)}))}))["catch"]((function(){r();var t=new Error("No available storage method found.");return o._driverSet=Promise.reject(t),o._driverSet})),this._driverSet.then(e,n),this._driverSet},e.prototype.supports=function(t){return!!l[t]},e.prototype._extend=function(t){i(this,t)},e.prototype._getSupportedDrivers=function(t){for(var e=[],n=0,r=t.length;r>n;n++){var i=t[n];this.supports(i)&&e.push(i)}return e},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0;e<c.length;e++)t(this,c[e])},e.prototype.createInstance=function(t){return new e(t)},e}(),d=new p;e["default"]=d}.call("undefined"!=typeof window?window:self),t.exports=e["default"]},function(t,e){"use strict";e.__esModule=!0,function(){function t(t,e){t=t||[],e=e||{};try{return new Blob(t,e)}catch(n){if("TypeError"!==n.name)throw n;for(var r=x.BlobBuilder||x.MSBlobBuilder||x.MozBlobBuilder||x.WebKitBlobBuilder,i=new r,o=0;o<t.length;o+=1)i.append(t[o]);return i.getBlob(e.type)}}function n(t){for(var e=t.length,n=new ArrayBuffer(e),r=new Uint8Array(n),i=0;e>i;i++)r[i]=t.charCodeAt(i);return n}function r(t){return new Promise((function(e,n){var r=new XMLHttpRequest;r.open("GET",t),r.withCredentials=!0,r.responseType="arraybuffer",r.onreadystatechange=function(){return 4===r.readyState?200===r.status?e({response:r.response,type:r.getResponseHeader("Content-Type")}):(n({status:r.status,response:r.response}),void 0):void 0},r.send()}))}function i(e){return new Promise((function(n,i){var o=t([""],{type:"image/png"}),a=e.transaction([S],"readwrite");a.objectStore(S).put(o,"key"),a.oncomplete=function(){var t=e.transaction([S],"readwrite"),o=t.objectStore(S).get("key");o.onerror=i,o.onsuccess=function(t){var e=t.target.result,i=URL.createObjectURL(e);r(i).then((function(t){n(!(!t||"image/png"!==t.type))}),(function(){n(!1)})).then((function(){URL.revokeObjectURL(i)}))}}}))["catch"]((function(){return!1}))}function o(t){return"boolean"==typeof A?Promise.resolve(A):i(t).then((function(t){return A=t}))}function a(t){return new Promise((function(e,n){var r=new FileReader;r.onerror=n,r.onloadend=function(n){var r=btoa(n.target.result||"");e({__local_forage_encoded_blob:!0,data:r,type:t.type})},r.readAsBinaryString(t)}))}function u(e){var r=n(atob(e.data));return t([r],{type:e.type})}function s(t){return t&&t.__local_forage_encoded_blob}function c(t){function e(){return Promise.resolve()}var n=this,r={db:null};if(t)for(var i in t)r[i]=t[i];O||(O={});var o=O[r.name];o||(o={forages:[],db:null},O[r.name]=o),o.forages.push(this);for(var a=[],u=0;u<o.forages.length;u++){var s=o.forages[u];s!==this&&a.push(s.ready()["catch"](e))}var c=o.forages.slice(0);return Promise.all(a).then((function(){return r.db=o.db,f(r)})).then((function(t){return r.db=t,p(r,n._defaultConfig.version)?l(r):t})).then((function(t){r.db=o.db=t,n._dbInfo=r;for(var e in c){var i=c[e];i!==n&&(i._dbInfo.db=r.db,i._dbInfo.version=r.version)}}))}function f(t){return h(t,!1)}function l(t){return h(t,!0)}function h(t,e){return new Promise((function(n,r){if(t.db){if(!e)return n(t.db);t.db.close()}var i=[t.name];e&&i.push(t.version);var o=E.open.apply(E,i);e&&(o.onupgradeneeded=function(e){var n=o.result;try{n.createObjectStore(t.storeName),e.oldVersion<=1&&n.createObjectStore(S)}catch(r){if("ConstraintError"!==r.name)throw r;x.console.warn('The database "'+t.name+'"'+" has been upgraded from version "+e.oldVersion+" to version "+e.newVersion+', but the storage "'+t.storeName+'" already exists.')}}),o.onerror=function(){r(o.error)},o.onsuccess=function(){n(o.result)}}))}function p(t,e){if(!t.db)return!0;var n=!t.db.objectStoreNames.contains(t.storeName),r=t.version<t.db.version,i=t.version>t.db.version;if(r&&(t.version!==e&&x.console.warn('The database "'+t.name+'"'+" can't be downgraded from version "+t.db.version+" to version "+t.version+"."),t.version=t.db.version),i||n){if(n){var o=t.db.version+1;o>t.version&&(t.version=o)}return!0}return!1}function d(t,e){var n=this;"string"!=typeof t&&(x.console.warn(t+" used as a key, but it is not a string."),t=String(t));var r=new Promise((function(e,r){n.ready().then((function(){var i=n._dbInfo,o=i.db.transaction(i.storeName,"readonly").objectStore(i.storeName),a=o.get(t);a.onsuccess=function(){var t=a.result;void 0===t&&(t=null),s(t)&&(t=u(t)),e(t)},a.onerror=function(){r(a.error)}}))["catch"](r)}));return k(r,e),r}function y(t,e){var n=this,r=new Promise((function(e,r){n.ready().then((function(){var i=n._dbInfo,o=i.db.transaction(i.storeName,"readonly").objectStore(i.storeName),a=o.openCursor(),c=1;a.onsuccess=function(){var n=a.result;if(n){var r=n.value;s(r)&&(r=u(r));var i=t(r,n.key,c++);void 0!==i?e(i):n["continue"]()}else e()},a.onerror=function(){r(a.error)}}))["catch"](r)}));return k(r,e),r}function v(t,e,n){var r=this;"string"!=typeof t&&(x.console.warn(t+" used as a key, but it is not a string."),t=String(t));var i=new Promise((function(n,i){var u;r.ready().then((function(){return u=r._dbInfo,o(u.db)})).then((function(t){return!t&&e instanceof Blob?a(e):e})).then((function(e){var r=u.db.transaction(u.storeName,"readwrite"),o=r.objectStore(u.storeName);null===e&&(e=void 0);var a=o.put(e,t);r.oncomplete=function(){void 0===e&&(e=null),n(e)},r.onabort=r.onerror=function(){var t=a.error?a.error:a.transaction.error;i(t)}}))["catch"](i)}));return k(i,n),i}function g(t,e){var n=this;"string"!=typeof t&&(x.console.warn(t+" used as a key, but it is not a string."),t=String(t));var r=new Promise((function(e,r){n.ready().then((function(){var i=n._dbInfo,o=i.db.transaction(i.storeName,"readwrite"),a=o.objectStore(i.storeName),u=a["delete"](t);o.oncomplete=function(){e()},o.onerror=function(){r(u.error)},o.onabort=function(){var t=u.error?u.error:u.transaction.error;r(t)}}))["catch"](r)}));return k(r,e),r}function m(t){var e=this,n=new Promise((function(t,n){e.ready().then((function(){var r=e._dbInfo,i=r.db.transaction(r.storeName,"readwrite"),o=i.objectStore(r.storeName),a=o.clear();i.oncomplete=function(){t()},i.onabort=i.onerror=function(){var t=a.error?a.error:a.transaction.error;n(t)}}))["catch"](n)}));return k(n,t),n}function b(t){var e=this,n=new Promise((function(t,n){e.ready().then((function(){var r=e._dbInfo,i=r.db.transaction(r.storeName,"readonly").objectStore(r.storeName),o=i.count();o.onsuccess=function(){t(o.result)},o.onerror=function(){n(o.error)}}))["catch"](n)}));return k(n,t),n}function w(t,e){var n=this,r=new Promise((function(e,r){return 0>t?(e(null),void 0):(n.ready().then((function(){var i=n._dbInfo,o=i.db.transaction(i.storeName,"readonly").objectStore(i.storeName),a=!1,u=o.openCursor();u.onsuccess=function(){var n=u.result;return n?(0===t?e(n.key):a?e(n.key):(a=!0,n.advance(t)),void 0):(e(null),void 0)},u.onerror=function(){r(u.error)}}))["catch"](r),void 0)}));return k(r,e),r}function _(t){var e=this,n=new Promise((function(t,n){e.ready().then((function(){var r=e._dbInfo,i=r.db.transaction(r.storeName,"readonly").objectStore(r.storeName),o=i.openCursor(),a=[];o.onsuccess=function(){var e=o.result;return e?(a.push(e.key),e["continue"](),void 0):(t(a),void 0)},o.onerror=function(){n(o.error)}}))["catch"](n)}));return k(n,t),n}function k(t,e){e&&t.then((function(t){e(null,t)}),(function(t){e(t)}))}var x=this,E=E||this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.OIndexedDB||this.msIndexedDB;if(E){var A,O,S="local-forage-detect-blob-support",j={_driver:"asyncStorage",_initStorage:c,iterate:y,getItem:d,setItem:v,removeItem:g,clear:m,length:b,key:w,keys:_};e["default"]=j}}.call("undefined"!=typeof window?window:self),t.exports=e["default"]},function(t,e,n){"use strict";e.__esModule=!0,function(){function t(t){var e=this,r={};if(t)for(var i in t)r[i]=t[i];return r.keyPrefix=r.name+"/",r.storeName!==e._defaultConfig.storeName&&(r.keyPrefix+=r.storeName+"/"),e._dbInfo=r,new Promise((function(t){t(n(3))})).then((function(t){return r.serializer=t,Promise.resolve()}))}function r(t){var e=this,n=e.ready().then((function(){for(var t=e._dbInfo.keyPrefix,n=p.length-1;n>=0;n--){var r=p.key(n);0===r.indexOf(t)&&p.removeItem(r)}}));return l(n,t),n}function i(t,e){var n=this;"string"!=typeof t&&(h.console.warn(t+" used as a key, but it is not a string."),t=String(t));var r=n.ready().then((function(){var e=n._dbInfo,r=p.getItem(e.keyPrefix+t);return r&&(r=e.serializer.deserialize(r)),r}));return l(r,e),r}function o(t,e){var n=this,r=n.ready().then((function(){for(var e=n._dbInfo,r=e.keyPrefix,i=r.length,o=p.length,a=1,u=0;o>u;u++){var s=p.key(u);if(0===s.indexOf(r)){var c=p.getItem(s);if(c&&(c=e.serializer.deserialize(c)),c=t(c,s.substring(i),a++),void 0!==c)return c}}}));return l(r,e),r}function a(t,e){var n=this,r=n.ready().then((function(){var e,r=n._dbInfo;try{e=p.key(t)}catch(i){e=null}return e&&(e=e.substring(r.keyPrefix.length)),e}));return l(r,e),r}function u(t){var e=this,n=e.ready().then((function(){for(var t=e._dbInfo,n=p.length,r=[],i=0;n>i;i++)0===p.key(i).indexOf(t.keyPrefix)&&r.push(p.key(i).substring(t.keyPrefix.length));return r}));return l(n,t),n}function s(t){var e=this,n=e.keys().then((function(t){return t.length}));return l(n,t),n}function c(t,e){var n=this;"string"!=typeof t&&(h.console.warn(t+" used as a key, but it is not a string."),t=String(t));var r=n.ready().then((function(){var e=n._dbInfo;p.removeItem(e.keyPrefix+t)}));return l(r,e),r}function f(t,e,n){var r=this;"string"!=typeof t&&(h.console.warn(t+" used as a key, but it is not a string."),t=String(t));var i=r.ready().then((function(){void 0===e&&(e=null);var n=e;return new Promise((function(i,o){var a=r._dbInfo;a.serializer.serialize(e,(function(e,r){if(r)o(r);else try{p.setItem(a.keyPrefix+t,e),i(n)}catch(u){("QuotaExceededError"===u.name||"NS_ERROR_DOM_QUOTA_REACHED"===u.name)&&o(u),o(u)}}))}))}));return l(i,n),i}function l(t,e){e&&t.then((function(t){e(null,t)}),(function(t){e(t)}))}var h=this,p=null;try{if(!(this.localStorage&&"setItem"in this.localStorage))return;p=this.localStorage}catch(d){return}var y={_driver:"localStorageWrapper",_initStorage:t,iterate:o,getItem:i,setItem:f,removeItem:c,clear:r,length:s,key:a,keys:u};e["default"]=y}.call("undefined"!=typeof window?window:self),t.exports=e["default"]},function(t,e){"use strict";e.__esModule=!0,function(){function t(t,e){t=t||[],e=e||{};try{return new Blob(t,e)}catch(n){if("TypeError"!==n.name)throw n;for(var r=x.BlobBuilder||x.MSBlobBuilder||x.MozBlobBuilder||x.WebKitBlobBuilder,i=new r,o=0;o<t.length;o+=1)i.append(t[o]);return i.getBlob(e.type)}}function n(t,e){var n="";if(t&&(n=t.toString()),t&&("[object ArrayBuffer]"===t.toString()||t.buffer&&"[object ArrayBuffer]"===t.buffer.toString())){var r,i=c;t instanceof ArrayBuffer?(r=t,i+=l):(r=t.buffer,"[object Int8Array]"===n?i+=p:"[object Uint8Array]"===n?i+=d:"[object Uint8ClampedArray]"===n?i+=y:"[object Int16Array]"===n?i+=v:"[object Uint16Array]"===n?i+=m:"[object Int32Array]"===n?i+=g:"[object Uint32Array]"===n?i+=b:"[object Float32Array]"===n?i+=w:"[object Float64Array]"===n?i+=_:e(new Error("Failed to get type for BinaryArray"))),e(i+o(r))}else if("[object Blob]"===n){var a=new FileReader;a.onload=function(){var n=u+t.type+"~"+o(this.result);e(c+h+n)},a.readAsArrayBuffer(t)}else try{e(JSON.stringify(t))}catch(s){console.error("Couldn't convert value into a JSON string: ",t),e(null,s)}}function r(e){if(e.substring(0,f)!==c)return JSON.parse(e);var n,r=e.substring(k),o=e.substring(f,k);if(o===h&&s.test(r)){var a=r.match(s);n=a[1],r=r.substring(a[0].length)}var u=i(r);switch(o){case l:return u;case h:return t([u],{type:n});case p:return new Int8Array(u);case d:return new Uint8Array(u);case y:return new Uint8ClampedArray(u);case v:return new Int16Array(u);case m:return new Uint16Array(u);case g:return new Int32Array(u);case b:return new Uint32Array(u);case w:return new Float32Array(u);case _:return new Float64Array(u);default:throw new Error("Unkown type: "+o)}}function i(t){var e,n,r,i,o,u=.75*t.length,s=t.length,c=0;"="===t[t.length-1]&&(u--,"="===t[t.length-2]&&u--);var f=new ArrayBuffer(u),l=new Uint8Array(f);for(e=0;s>e;e+=4)n=a.indexOf(t[e]),r=a.indexOf(t[e+1]),i=a.indexOf(t[e+2]),o=a.indexOf(t[e+3]),l[c++]=n<<2|r>>4,l[c++]=(15&r)<<4|i>>2,l[c++]=(3&i)<<6|63&o;return f}function o(t){var e,n=new Uint8Array(t),r="";for(e=0;e<n.length;e+=3)r+=a[n[e]>>2],r+=a[(3&n[e])<<4|n[e+1]>>4],r+=a[(15&n[e+1])<<2|n[e+2]>>6],r+=a[63&n[e+2]];return 2===n.length%3?r=r.substring(0,r.length-1)+"=":1===n.length%3&&(r=r.substring(0,r.length-2)+"=="),r}var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",u="~~local_forage_type~",s=/^~~local_forage_type~([^~]+)~/,c="__lfsc__:",f=c.length,l="arbf",h="blob",p="si08",d="ui08",y="uic8",v="si16",g="si32",m="ur16",b="ui32",w="fl32",_="fl64",k=f+l.length,x=this,E={serialize:n,deserialize:r,stringToBuffer:i,bufferToString:o};e["default"]=E}.call("undefined"!=typeof window?window:self),t.exports=e["default"]},function(t,e,n){"use strict";e.__esModule=!0,function(){function t(t){var e=this,r={db:null};if(t)for(var i in t)r[i]="string"!=typeof t[i]?t[i].toString():t[i];var o=new Promise((function(n,i){try{r.db=p(r.name,String(r.version),r.description,r.size)}catch(o){return e.setDriver(e.LOCALSTORAGE).then((function(){return e._initStorage(t)})).then(n)["catch"](i)}r.db.transaction((function(t){t.executeSql("CREATE TABLE IF NOT EXISTS "+r.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],(function(){e._dbInfo=r,n()}),(function(t,e){i(e)}))}))}));return new Promise((function(t){t(n(3))})).then((function(t){return r.serializer=t,o}))}function r(t,e){var n=this;"string"!=typeof t&&(h.console.warn(t+" used as a key, but it is not a string."),t=String(t));var r=new Promise((function(e,r){n.ready().then((function(){var i=n._dbInfo;i.db.transaction((function(n){n.executeSql("SELECT * FROM "+i.storeName+" WHERE key = ? LIMIT 1",[t],(function(t,n){var r=n.rows.length?n.rows.item(0).value:null;r&&(r=i.serializer.deserialize(r)),e(r)}),(function(t,e){r(e)}))}))}))["catch"](r)}));return l(r,e),r}function i(t,e){var n=this,r=new Promise((function(e,r){n.ready().then((function(){var i=n._dbInfo;i.db.transaction((function(n){n.executeSql("SELECT * FROM "+i.storeName,[],(function(n,r){for(var o=r.rows,a=o.length,u=0;a>u;u++){var s=o.item(u),c=s.value;if(c&&(c=i.serializer.deserialize(c)),c=t(c,s.key,u+1),void 0!==c)return e(c),void 0}e()}),(function(t,e){r(e)}))}))}))["catch"](r)}));return l(r,e),r}function o(t,e,n){var r=this;"string"!=typeof t&&(h.console.warn(t+" used as a key, but it is not a string."),t=String(t));var i=new Promise((function(n,i){r.ready().then((function(){void 0===e&&(e=null);var o=e,a=r._dbInfo;a.serializer.serialize(e,(function(e,r){r?i(r):a.db.transaction((function(r){r.executeSql("INSERT OR REPLACE INTO "+a.storeName+" (key, value) VALUES (?, ?)",[t,e],(function(){n(o)}),(function(t,e){i(e)}))}),(function(t){t.code===t.QUOTA_ERR&&i(t)}))}))}))["catch"](i)}));return l(i,n),i}function a(t,e){var n=this;"string"!=typeof t&&(h.console.warn(t+" used as a key, but it is not a string."),t=String(t));var r=new Promise((function(e,r){n.ready().then((function(){var i=n._dbInfo;i.db.transaction((function(n){n.executeSql("DELETE FROM "+i.storeName+" WHERE key = ?",[t],(function(){e()}),(function(t,e){r(e)}))}))}))["catch"](r)}));return l(r,e),r}function u(t){var e=this,n=new Promise((function(t,n){e.ready().then((function(){var r=e._dbInfo;r.db.transaction((function(e){e.executeSql("DELETE FROM "+r.storeName,[],(function(){t()}),(function(t,e){n(e)}))}))}))["catch"](n)}));return l(n,t),n}function s(t){var e=this,n=new Promise((function(t,n){e.ready().then((function(){var r=e._dbInfo;r.db.transaction((function(e){e.executeSql("SELECT COUNT(key) as c FROM "+r.storeName,[],(function(e,n){var r=n.rows.item(0).c;t(r)}),(function(t,e){n(e)}))}))}))["catch"](n)}));return l(n,t),n}function c(t,e){var n=this,r=new Promise((function(e,r){n.ready().then((function(){var i=n._dbInfo;i.db.transaction((function(n){n.executeSql("SELECT key FROM "+i.storeName+" WHERE id = ? LIMIT 1",[t+1],(function(t,n){var r=n.rows.length?n.rows.item(0).key:null;e(r)}),(function(t,e){r(e)}))}))}))["catch"](r)}));return l(r,e),r}function f(t){var e=this,n=new Promise((function(t,n){e.ready().then((function(){var r=e._dbInfo;r.db.transaction((function(e){e.executeSql("SELECT key FROM "+r.storeName,[],(function(e,n){for(var r=[],i=0;i<n.rows.length;i++)r.push(n.rows.item(i).key);t(r)}),(function(t,e){n(e)}))}))}))["catch"](n)}));return l(n,t),n}function l(t,e){e&&t.then((function(t){e(null,t)}),(function(t){e(t)}))}var h=this,p=this.openDatabase;if(p){var d={_driver:"webSQLStorage",_initStorage:t,iterate:i,getItem:r,setItem:o,removeItem:a,clear:u,length:s,key:c,keys:f};e["default"]=d}}.call("undefined"!=typeof window?window:self),t.exports=e["default"]}])}))},{__browserify_process:4}],19:[function(t,e,n){!function(){var t=this,r=t._,i={},o=Array.prototype,a=Object.prototype,u=Function.prototype,s=o.push,c=o.slice,f=o.concat,l=a.toString,h=a.hasOwnProperty,p=o.forEach,d=o.map,y=o.reduce,v=o.reduceRight,g=o.filter,m=o.every,b=o.some,w=o.indexOf,_=o.lastIndexOf,k=Array.isArray,x=Object.keys,E=u.bind,A=function(t){return t instanceof A?t:this instanceof A?(this._wrapped=t,void 0):new A(t)};"undefined"!=typeof n?("undefined"!=typeof e&&e.exports&&(n=e.exports=A),n._=A):t._=A,A.VERSION="1.4.4";var O=A.each=A.forEach=function(t,e,n){if(null!=t)if(p&&t.forEach===p)t.forEach(e,n);else if(t.length===+t.length){for(var r=0,o=t.length;o>r;r++)if(e.call(n,t[r],r,t)===i)return}else for(var a in t)if(A.has(t,a)&&e.call(n,t[a],a,t)===i)return};A.map=A.collect=function(t,e,n){var r=[];return null==t?r:d&&t.map===d?t.map(e,n):(O(t,(function(t,i,o){r[r.length]=e.call(n,t,i,o)})),r)};var S="Reduce of empty array with no initial value";A.reduce=A.foldl=A.inject=function(t,e,n,r){var i=arguments.length>2;if(null==t&&(t=[]),y&&t.reduce===y)return r&&(e=A.bind(e,r)),i?t.reduce(e,n):t.reduce(e);if(O(t,(function(t,o,a){i?n=e.call(r,n,t,o,a):(n=t,i=!0)})),!i)throw new TypeError(S);return n},A.reduceRight=A.foldr=function(t,e,n,r){var i=arguments.length>2;if(null==t&&(t=[]),v&&t.reduceRight===v)return r&&(e=A.bind(e,r)),i?t.reduceRight(e,n):t.reduceRight(e);var o=t.length;if(o!==+o){var a=A.keys(t);o=a.length}if(O(t,(function(u,s,c){s=a?a[--o]:--o,i?n=e.call(r,n,t[s],s,c):(n=t[s],i=!0)})),!i)throw new TypeError(S);return n},A.find=A.detect=function(t,e,n){var r;return j(t,(function(t,i,o){return e.call(n,t,i,o)?(r=t,!0):void 0})),r},A.filter=A.select=function(t,e,n){var r=[];return null==t?r:g&&t.filter===g?t.filter(e,n):(O(t,(function(t,i,o){e.call(n,t,i,o)&&(r[r.length]=t)})),r)},A.reject=function(t,e,n){return A.filter(t,(function(t,r,i){return!e.call(n,t,r,i)}),n)},A.every=A.all=function(t,e,n){e||(e=A.identity);var r=!0;return null==t?r:m&&t.every===m?t.every(e,n):(O(t,(function(t,o,a){return(r=r&&e.call(n,t,o,a))?void 0:i})),!!r)};var j=A.some=A.any=function(t,e,n){e||(e=A.identity);var r=!1;return null==t?r:b&&t.some===b?t.some(e,n):(O(t,(function(t,o,a){return r||(r=e.call(n,t,o,a))?i:void 0})),!!r)};A.contains=A.include=function(t,e){return null==t?!1:w&&t.indexOf===w?-1!=t.indexOf(e):j(t,(function(t){return t===e}))},A.invoke=function(t,e){var n=c.call(arguments,2),r=A.isFunction(e);return A.map(t,(function(t){return(r?e:t[e]).apply(t,n)}))},A.pluck=function(t,e){return A.map(t,(function(t){return t[e]}))},A.where=function(t,e,n){return A.isEmpty(e)?n?null:[]:A[n?"find":"filter"](t,(function(t){for(var n in e)if(e[n]!==t[n])return!1;return!0}))},A.findWhere=function(t,e){return A.where(t,e,!0)},A.max=function(t,e,n){if(!e&&A.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.max.apply(Math,t);if(!e&&A.isEmpty(t))return-1/0;var r={computed:-1/0,value:-1/0};return O(t,(function(t,i,o){var a=e?e.call(n,t,i,o):t;a>=r.computed&&(r={value:t,computed:a})})),r.value},A.min=function(t,e,n){if(!e&&A.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.min.apply(Math,t);if(!e&&A.isEmpty(t))return 1/0;var r={computed:1/0,value:1/0};return O(t,(function(t,i,o){var a=e?e.call(n,t,i,o):t;a<r.computed&&(r={value:t,computed:a})})),r.value},A.shuffle=function(t){var e,n=0,r=[];return O(t,(function(t){e=A.random(n++),r[n-1]=r[e],r[e]=t})),r};var I=function(t){return A.isFunction(t)?t:function(e){return e[t]}};A.sortBy=function(t,e,n){var r=I(e);return A.pluck(A.map(t,(function(t,e,i){return{value:t,index:e,criteria:r.call(n,t,e,i)}})).sort((function(t,e){var n=t.criteria,r=e.criteria;if(n!==r){if(n>r||void 0===n)return 1;if(r>n||void 0===r)return-1}return t.index<e.index?-1:1})),"value")};var $=function(t,e,n,r){var i={},o=I(e||A.identity);return O(t,(function(e,a){var u=o.call(n,e,a,t);r(i,u,e)})),i};A.groupBy=function(t,e,n){return $(t,e,n,(function(t,e,n){(A.has(t,e)?t[e]:t[e]=[]).push(n)}))},A.countBy=function(t,e,n){return $(t,e,n,(function(t,e){A.has(t,e)||(t[e]=0),t[e]++}))},A.sortedIndex=function(t,e,n,r){n=null==n?A.identity:I(n);for(var i=n.call(r,e),o=0,a=t.length;a>o;){var u=o+a>>>1;n.call(r,t[u])<i?o=u+1:a=u}return o},A.toArray=function(t){return t?A.isArray(t)?c.call(t):t.length===+t.length?A.map(t,A.identity):A.values(t):[]},A.size=function(t){return null==t?0:t.length===+t.length?t.length:A.keys(t).length},A.first=A.head=A.take=function(t,e,n){return null==t?void 0:null==e||n?t[0]:c.call(t,0,e)},A.initial=function(t,e,n){return c.call(t,0,t.length-(null==e||n?1:e))},A.last=function(t,e,n){return null==t?void 0:null==e||n?t[t.length-1]:c.call(t,Math.max(t.length-e,0))},A.rest=A.tail=A.drop=function(t,e,n){return c.call(t,null==e||n?1:e)},A.compact=function(t){return A.filter(t,A.identity)};var D=function(t,e,n){return O(t,(function(t){A.isArray(t)?e?s.apply(n,t):D(t,e,n):n.push(t)})),n};A.flatten=function(t,e){return D(t,e,[])},A.without=function(t){return A.difference(t,c.call(arguments,1))},A.uniq=A.unique=function(t,e,n,r){A.isFunction(e)&&(r=n,n=e,e=!1);var i=n?A.map(t,n,r):t,o=[],a=[];return O(i,(function(n,r){(e?r&&a[a.length-1]===n:A.contains(a,n))||(a.push(n),o.push(t[r]))})),o},A.union=function(){return A.uniq(f.apply(o,arguments))},A.intersection=function(t){var e=c.call(arguments,1);return A.filter(A.uniq(t),(function(t){return A.every(e,(function(e){return A.indexOf(e,t)>=0}))}))},A.difference=function(t){var e=f.apply(o,c.call(arguments,1));return A.filter(t,(function(t){return!A.contains(e,t)}))},A.zip=function(){for(var t=c.call(arguments),e=A.max(A.pluck(t,"length")),n=new Array(e),r=0;e>r;r++)n[r]=A.pluck(t,""+r);return n},A.object=function(t,e){if(null==t)return{};for(var n={},r=0,i=t.length;i>r;r++)e?n[t[r]]=e[r]:n[t[r][0]]=t[r][1];return n},A.indexOf=function(t,e,n){if(null==t)return-1;var r=0,i=t.length;if(n){if("number"!=typeof n)return r=A.sortedIndex(t,e),t[r]===e?r:-1;r=0>n?Math.max(0,i+n):n}if(w&&t.indexOf===w)return t.indexOf(e,n);for(;i>r;r++)if(t[r]===e)return r;return-1},A.lastIndexOf=function(t,e,n){if(null==t)return-1;var r=null!=n;if(_&&t.lastIndexOf===_)return r?t.lastIndexOf(e,n):t.lastIndexOf(e);for(var i=r?n:t.length;i--;)if(t[i]===e)return i;return-1},A.range=function(t,e,n){arguments.length<=1&&(e=t||0,t=0),n=arguments[2]||1;for(var r=Math.max(Math.ceil((e-t)/n),0),i=0,o=new Array(r);r>i;)o[i++]=t,t+=n;return o},A.bind=function(t,e){if(t.bind===E&&E)return E.apply(t,c.call(arguments,1));var n=c.call(arguments,2);return function(){return t.apply(e,n.concat(c.call(arguments)))}},A.partial=function(t){var e=c.call(arguments,1);return function(){return t.apply(this,e.concat(c.call(arguments)))}},A.bindAll=function(t){var e=c.call(arguments,1);return 0===e.length&&(e=A.functions(t)),O(e,(function(e){t[e]=A.bind(t[e],t)})),t},A.memoize=function(t,e){var n={};return e||(e=A.identity),function(){var r=e.apply(this,arguments);return A.has(n,r)?n[r]:n[r]=t.apply(this,arguments)}},A.delay=function(t,e){var n=c.call(arguments,2);return setTimeout((function(){return t.apply(null,n)}),e)},A.defer=function(t){return A.delay.apply(A,[t,1].concat(c.call(arguments,1)))},A.throttle=function(t,e){var n,r,i,o,a=0,u=function(){a=new Date,i=null,o=t.apply(n,r)};return function(){var s=new Date,c=e-(s-a);return n=this,r=arguments,0>=c?(clearTimeout(i),i=null,a=s,o=t.apply(n,r)):i||(i=setTimeout(u,c)),o}},A.debounce=function(t,e,n){var r,i;return function(){var o=this,a=arguments,u=function(){r=null,n||(i=t.apply(o,a))},s=n&&!r;return clearTimeout(r),r=setTimeout(u,e),s&&(i=t.apply(o,a)),i}},A.once=function(t){var e,n=!1;return function(){return n?e:(n=!0,e=t.apply(this,arguments),t=null,e)}},A.wrap=function(t,e){return function(){var n=[t];return s.apply(n,arguments),e.apply(this,n)}},A.compose=function(){var t=arguments;return function(){for(var e=arguments,n=t.length-1;n>=0;n--)e=[t[n].apply(this,e)];return e[0]}},A.after=function(t,e){return 0>=t?e():function(){return--t<1?e.apply(this,arguments):void 0}},A.keys=x||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var n in t)A.has(t,n)&&(e[e.length]=n);return e},A.values=function(t){var e=[];for(var n in t)A.has(t,n)&&e.push(t[n]);return e},A.pairs=function(t){var e=[];for(var n in t)A.has(t,n)&&e.push([n,t[n]]);return e},A.invert=function(t){var e={};for(var n in t)A.has(t,n)&&(e[t[n]]=n);return e},A.functions=A.methods=function(t){var e=[];for(var n in t)A.isFunction(t[n])&&e.push(n);return e.sort()},A.extend=function(t){return O(c.call(arguments,1),(function(e){if(e)for(var n in e)t[n]=e[n]})),t},A.pick=function(t){var e={},n=f.apply(o,c.call(arguments,1));return O(n,(function(n){n in t&&(e[n]=t[n])})),e},A.omit=function(t){var e={},n=f.apply(o,c.call(arguments,1));for(var r in t)A.contains(n,r)||(e[r]=t[r]);return e},A.defaults=function(t){return O(c.call(arguments,1),(function(e){if(e)for(var n in e)null==t[n]&&(t[n]=e[n])})),t},A.clone=function(t){return A.isObject(t)?A.isArray(t)?t.slice():A.extend({},t):t},A.tap=function(t,e){return e(t),t};var N=function(t,e,n,r){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof A&&(t=t._wrapped),e instanceof A&&(e=e._wrapped);var i=l.call(t);if(i!=l.call(e))return!1;switch(i){case"[object String]":return t==String(e);case"[object Number]":return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if("object"!=typeof t||"object"!=typeof e)return!1;for(var o=n.length;o--;)if(n[o]==t)return r[o]==e;n.push(t),r.push(e);var a=0,u=!0;if("[object Array]"==i){if(a=t.length,u=a==e.length)for(;a--&&(u=N(t[a],e[a],n,r)););}else{var s=t.constructor,c=e.constructor;if(s!==c&&!(A.isFunction(s)&&s instanceof s&&A.isFunction(c)&&c instanceof c))return!1;for(var f in t)if(A.has(t,f)&&(a++,!(u=A.has(e,f)&&N(t[f],e[f],n,r))))break;if(u){for(f in e)if(A.has(e,f)&&!a--)break;u=!a}}return n.pop(),r.pop(),u};A.isEqual=function(t,e){return N(t,e,[],[])},A.isEmpty=function(t){if(null==t)return!0;if(A.isArray(t)||A.isString(t))return 0===t.length;for(var e in t)if(A.has(t,e))return!1;return!0},A.isElement=function(t){return!(!t||1!==t.nodeType)},A.isArray=k||function(t){return"[object Array]"==l.call(t)},A.isObject=function(t){return t===Object(t)},O(["Arguments","Function","String","Number","Date","RegExp"],(function(t){A["is"+t]=function(e){return l.call(e)=="[object "+t+"]"}})),A.isArguments(arguments)||(A.isArguments=function(t){return!(!t||!A.has(t,"callee"))}),"function"!=typeof/./&&(A.isFunction=function(t){return"function"==typeof t}),A.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},A.isNaN=function(t){return A.isNumber(t)&&t!=+t},A.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==l.call(t)},A.isNull=function(t){return null===t},A.isUndefined=function(t){return void 0===t},A.has=function(t,e){return h.call(t,e)},A.noConflict=function(){return t._=r,this},A.identity=function(t){return t},A.times=function(t,e,n){for(var r=Array(t),i=0;t>i;i++)r[i]=e.call(n,i);return r},A.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))};var P={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};P.unescape=A.invert(P.escape);var T={escape:new RegExp("["+A.keys(P.escape).join("")+"]","g"),unescape:new RegExp("("+A.keys(P.unescape).join("|")+")","g")};A.each(["escape","unescape"],(function(t){A[t]=function(e){return null==e?"":(""+e).replace(T[t],(function(e){return P[t][e]}))}})),A.result=function(t,e){if(null==t)return null;var n=t[e];return A.isFunction(n)?n.call(t):n},A.mixin=function(t){O(A.functions(t),(function(e){var n=A[e]=t[e];A.prototype[e]=function(){var t=[this._wrapped];return s.apply(t,arguments),R.call(this,n.apply(A,t))}}))};var C=0;A.uniqueId=function(t){var e=++C+"";return t?t+e:e},A.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var M=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028","\u2029":"u2029"},F=/\\|'|\r|\n|\t|\u2028|\u2029/g;A.template=function(t,e,n){var r;n=A.defaults({},n,A.templateSettings);var i=new RegExp([(n.escape||M).source,(n.interpolate||M).source,(n.evaluate||M).source].join("|")+"|$","g"),o=0,a="__p+='";t.replace(i,(function(e,n,r,i,u){return a+=t.slice(o,u).replace(F,(function(t){return"\\"+B[t]})),n&&(a+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),r&&(a+="'+\n((__t=("+r+"))==null?'':__t)+\n'"),i&&(a+="';\n"+i+"\n__p+='"),o=u+e.length,e})),a+="';\n",n.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{r=new Function(n.variable||"obj","_",a)}catch(u){throw u.source=a,u}if(e)return r(e,A);var s=function(t){return r.call(this,t,A)};return s.source="function("+(n.variable||"obj")+"){\n"+a+"}",s},A.chain=function(t){return A(t).chain()};var R=function(t){return this._chain?A(t).chain():t};A.mixin(A),O(["pop","push","reverse","shift","sort","splice","unshift"],(function(t){var e=o[t];A.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!=t&&"splice"!=t||0!==n.length||delete n[0],R.call(this,n)}})),O(["concat","join","slice"],(function(t){var e=o[t];A.prototype[t]=function(){return R.call(this,e.apply(this._wrapped,arguments))}})),A.extend(A.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}.call(this)},{}]},{},[7])(7)}));kiss.db.offline={mode:"offline",collections:{},toId(record){record.id=record._id;delete record._id;return record},toIds(records){records.forEach((record=>{record.id=record._id;delete record._id}));return records},toMongoId(record){record._id=record.id;delete record.id;return record},toMongoIds(records){records.forEach((record=>{record._id=record.id;delete record.id}));return records},async createCollection(modelId,dbMode="offline"){log(`kiss.db.offline - createCollection <${modelId}> in mode <${dbMode=="memory"?"memory":"offline"}>`);const newCollection=new Nedb({filename:modelId+".db",autoload:true,timestampData:true,inMemoryOnly:dbMode==="memory"});const collection=this.collections[modelId]=this.nedbWrapper.fromInstance(newCollection);await collection.loadDatabase();return collection},async getCollection(modelId,dbMode="offline"){if(!this.collections[modelId])await this.createCollection(modelId,dbMode);return this.collections[modelId]},async deleteCollection(modelId){const collection=this.collections[modelId];if(!collection)return;collection.remove({},{multi:true},(function(err,numRemoved){if(err){log("kiss.db.offline - deleteCollection - Error:",4,err)}else{log("kiss.db.offline - deleteCollection - Num removed: "+numRemoved,2)}}));this.collections[modelId]=null},async createCollectionIndex(modelId,fieldName,dbMode="offline"){const collection=await this.getCollection(modelId,dbMode);collection.ensureIndex({fieldName:fieldName})},async insertOne(modelId,record,dbMode="offline"){log("kiss.db - "+dbMode+" - insertOne - Model "+modelId,0,record);const collection=await this.getCollection(modelId,dbMode);record.createdBy=kiss.session.getUserId();this.toMongoId(record);const insertedRecord=await collection.insert(record);this.toId(record);const channel="EVT_DB_INSERT:"+modelId.toUpperCase();kiss.pubsub.publish(channel,{channel:channel,dbMode:dbMode,accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),modelId:modelId,id:record.id,data:record});return insertedRecord},async insertMany(modelId,records,dbMode="offline"){log("kiss.db - "+dbMode+" - insertMany - Model "+modelId+" / "+records.length+" record(s)",0,records);const collection=await this.getCollection(modelId,dbMode);const createdBy=kiss.session.getUserId();records.forEach((record=>record.createdBy=createdBy));this.toMongoIds(records);const insertedRecords=await collection.insert(records);this.toIds(records);const channel="EVT_DB_INSERT_MANY:"+modelId.toUpperCase();kiss.pubsub.publish(channel,{channel:channel,dbMode:dbMode,accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),modelId:modelId,data:records});return insertedRecords},async updateOneDeep(modelId,recordId,update,dbMode="offline"){log("kiss.db - "+dbMode+" - updateOneDeep - Model "+modelId+" / Record "+recordId,0,update);const model=kiss.app.models[modelId];const record=await model.collection.findOne(recordId);return await kiss.data.relations.updateOneDeep(model,record,update)},async updateLink(linkRecord){log("kiss.db - offline - updateLink: ",0,linkRecord);return await kiss.data.relations.updateLink(linkRecord)},async updateOne(modelId,recordId,update,dbMode="offline"){log("kiss.db - "+dbMode+" - updateOne - Model "+modelId+" / Record "+recordId,0,update);const collection=await this.getCollection(modelId,dbMode);update.updatedBy=kiss.session.getUserId();const response=await collection.update({_id:recordId},{$set:update},{upsert:false});const channel="EVT_DB_UPDATE:"+modelId.toUpperCase();kiss.pubsub.publish(channel,{channel:channel,dbMode:dbMode,accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),modelId:modelId,id:recordId,data:update});return response},async updateMany(modelId,query,update,dbMode="offline"){log("kiss.db - "+dbMode+" - updateMany - Model "+modelId,0,update);const collection=await this.getCollection(modelId,dbMode);update.updatedBy=kiss.session.getUserId();const response=await collection.update(query,{$set:update},{multi:true});const channel="EVT_DB_UPDATE_MANY:"+modelId.toUpperCase();kiss.pubsub.publish(channel,{channel:channel,dbMode:dbMode,accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),modelId:modelId,data:update});return response},async updateBulk(operations,dbMode="offline"){log("kiss.db - "+dbMode+" - updateBulk",0,operations);const updatedBy=kiss.session.getUserId();for(let operation of operations){const collection=await this.getCollection(operation.modelId,dbMode);operation.updates.updatedBy=updatedBy;await collection.update({_id:operation.recordId},{$set:operation.updates},{upsert:false})}const channel="EVT_DB_UPDATE_BULK";kiss.pubsub.publish(channel,{channel:channel,dbMode:dbMode,accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),data:operations});return{}},async findOne(modelId,recordId,dbMode="offline"){log("kiss.db - "+dbMode+" - findOne - Model "+modelId+" / Record "+recordId);const collection=await this.getCollection(modelId,dbMode);const record=await collection.findOne({_id:recordId});if(record)this.toId(record);return record},async findById(modelId,ids,sort=[],sortSyntax="normalized",dbMode="offline"){log("kiss.db - "+dbMode+" - findById - Model "+modelId+" / Records: "+ids.join());const collection=await this.getCollection(modelId,dbMode);let records;if(sortSyntax.length==0){records=await collection.find({_id:{$in:ids}})}else{const sortObject=sortSyntax=="normalized"?kiss.db.mongo.convertSort(sort):sort;records=await collection.cfind({_id:{$in:ids}}).sort(sortObject).exec()}return this.toIds(records)},async find(modelId,query,dbMode="offline"){log("kiss.db - "+dbMode+" - find - Model "+modelId+" / Query:",0,query);let records;const collection=await this.getCollection(modelId,dbMode);if(!query){records=await collection.find({});return this.toIds(records)}const search={operation:"search",filter:query.filter||{},filterSyntax:query.filterSyntax||"normalized",sort:query.sort||{},sortSyntax:query.sortSyntax||"normalized",group:query.group||[],projection:query.projection||{},skip:query.skip,limit:query.limit,groupUnwind:query.groupUnwind};if(search.filterSyntax=="normalized"){search.filter=kiss.db.mongo.convertFilterGroup(search.filter)}if(search.sortSyntax=="normalized"){search.sort=kiss.db.mongo.convertSort(search.sort)}if(search.limit&&search.limit>0){records=await collection.cfind(search.filter,search.projection).limit(search.limit).sort(search.sort).exec()}else{records=await collection.cfind(search.filter,search.projection).sort(search.sort).exec()}return this.toIds(records)},async deleteOne(modelId,recordId,sendToTrash,dbMode="offline"){log("kiss.db - "+dbMode+" - deleteOne - Model "+modelId+" / Record "+recordId);const collection=await this.getCollection(modelId,dbMode);if(sendToTrash){await this.copyOneToTrash(modelId,recordId,dbMode)}await collection.remove({_id:recordId});const channel="EVT_DB_DELETE:"+modelId.toUpperCase();kiss.pubsub.publish(channel,{channel:channel,dbMode:dbMode,accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),modelId:modelId,id:recordId});if(kiss.tools.isUid(modelId)){const operations=await kiss.data.relations.updateForeignRecords(modelId,recordId);if(operations.length>0){const channel="EVT_DB_UPDATE_BULK";kiss.pubsub.publish(channel,{channel:channel,dbMode:dbMode,accountId:kiss.session.getAccountId(),userId:kiss.session.getUserId(),data:operations})}}else if(modelId.startsWith("file")){}return true},async deleteMany(modelId,query,sendToTrash,dbMode="offline"){log("kiss.db - "+dbMode+" - deleteMany - Model "+modelId,0,query);const collection=await this.getCollection(modelId,dbMode);if(sendToTrash){await this.copyManyToTrash(modelId,query,dbMode)}const response=await collection.remove(query,{multi:true});const channel="EVT_DB_DELETE_MANY:"+modelId.toUpperCase();kiss.pubsub.publish(channel,{channel:channel,dbMode:dbMode,accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),modelId:modelId,data:query});return response},async count(modelId,query,dbMode){log("kiss.db - "+dbMode+" - count - Model "+modelId,0,query);const collection=await this.getCollection(modelId,dbMode);return await collection.count(query)},async copyOneToTrash(modelId,recordId,dbMode="offline"){const record=await this.findOne(modelId,recordId,dbMode);record.accountId="anonymous";record.sourceModelId=modelId;record.deletedAt=(new Date).toISOString();record.deletedBy="anonymous";await this.insertOne("trash",record,dbMode);return record},async copyManyToTrash(modelId,query,dbMode="offline"){const records=await this.find(modelId,query,dbMode);const data=[];for(record of records){record.accountId="anonymous";record.sourceModelId=modelId;record.deletedAt=(new Date).toISOString();record.deletedBy="anonymous";data.push(record)}await this.insertMany("trash",data,dbMode);return records},nedbWrapper:{fromInstance(nedbInstance){const newCollection={nedb:nedbInstance};const methods=["loadDatabase","insert","find","findOne","count","update","remove","ensureIndex","removeIndex"];for(let i=0;i<methods.length;++i){const method=methods[i];newCollection[method]=kiss.db.offline.nedbWrapper.thenify(nedbInstance[method].bind(nedbInstance))}newCollection.cfind=function(query,projections){const cursor=nedbInstance.find(query,projections);cursor.exec=kiss.db.offline.nedbWrapper.thenify(cursor.exec.bind(cursor));return cursor};newCollection.cfindOne=function(query,projections){const cursor=nedbInstance.findOne(query,projections);cursor.exec=kiss.db.offline.nedbWrapper.thenify(cursor.exec.bind(cursor));return cursor};newCollection.ccount=function(query){const cursor=nedbInstance.count(query);cursor.exec=kiss.db.offline.nedbWrapper.thenify(cursor.exec.bind(cursor));return cursor};return newCollection},create:function(name,options){name=(name||"").replace(/\s|bound(?!$)/g,"");options=options||{};var multiArgs=options.multiArgs!==undefined?options.multiArgs:true;multiArgs="var multiArgs = "+JSON.stringify(multiArgs)+"\n";var withCallback=options.withCallback?"var lastType = typeof arguments[len - 1]\n"+'if (lastType === "function") return $$__fn__$$.apply(self, arguments)\n':"";return"(function "+name+"() {\n"+"var self = this\n"+"var len = arguments.length\n"+multiArgs+withCallback+"var args = new Array(len + 1)\n"+"for (var i = 0; i < len; ++i) args[i] = arguments[i]\n"+"var lastIndex = i\n"+"return new Promise(function (resolve, reject) {\n"+"args[lastIndex] = kiss.db.offline.nedbWrapper.createCallback(resolve, reject, multiArgs)\n"+"$$__fn__$$.apply(self, args)\n"+"})\n"+"})"},thenify:function($$__fn__$$,options){return eval(this.create($$__fn__$$.name,options))},createCallback:function(resolve,reject,multiArgs){return function(err,value){if(err)return reject(err);const length=arguments.length;if(length<=2||!multiArgs)return resolve(value);if(Array.isArray(multiArgs)){let values={};for(let i=1;i<length;i++)values[multiArgs[i-1]]=arguments[i];return resolve(values)}let values=new Array(length-1);for(let i=1;i<length;++i)values[i-1]=arguments[i];resolve(values)}}}};kiss.db.offline.nedbWrapper.thenify.withCallback=function($$__fn__$$,options){options=options||{};options.withCallback=true;if(options.multiArgs===undefined)options.multiArgs=true;return eval(kiss.db.offline.nedbWrapper.create($$__fn__$$.name,options))};kiss.db.online={url:"",async insertOne(modelId,record){log("kiss.db - online - insertOne - Model "+modelId,0,record);const response=await kiss.ajax.request({url:"/"+modelId,method:"post",body:JSON.stringify(record)});const channel="EVT_DB_INSERT:"+modelId.toUpperCase();kiss.pubsub.publish(channel,{channel:channel,dbMode:"online",accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),modelId:modelId,id:record.id,data:record});return response},async insertMany(modelId,records){log("kiss.db - online - insertMany - Model "+modelId+" / "+records.length+" record(s)",0,records);const response=await kiss.ajax.request({url:"/"+modelId,method:"post",body:JSON.stringify(records)});const channel="EVT_DB_INSERT_MANY:"+modelId.toUpperCase();kiss.pubsub.publish(channel,{channel:channel,dbMode:"online",accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),modelId:modelId,data:records});return response},async updateOne(modelId,recordId,update){log("kiss.db - online - updateOne - Model "+modelId+" / Record "+recordId,0,update);const response=await kiss.ajax.request({url:"/"+modelId+"/"+recordId,method:"patch",body:JSON.stringify(update)});const channel="EVT_DB_UPDATE:"+modelId.toUpperCase();kiss.pubsub.publish(channel,{channel:channel,dbMode:"online",accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),modelId:modelId,id:recordId,data:update});return response},async updateMany(modelId,query,update){log("kiss.db - online - updateMany - Model "+modelId,0,update);const response=await kiss.ajax.request({url:"/"+modelId,method:"patch",body:JSON.stringify({query:query,update:update})});const channel="EVT_DB_UPDATE_MANY:"+modelId.toUpperCase();kiss.pubsub.publish(channel,{channel:channel,dbMode:"online",accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),modelId:modelId,data:update});return response},async updateOneDeep(modelId,recordId,update){log("kiss.db - online - updateOneDeep - Model "+modelId+" / Record "+recordId,0,update);const response=await kiss.ajax.request({url:"/"+modelId+"/"+recordId,method:"patch",body:JSON.stringify({operation:"updateOneDeep",update:update})});return response},async updateLink(link){log("kiss.db - online - updateLink: ",0,link);const response=await kiss.ajax.request({url:"/updateLink",method:"post",body:JSON.stringify(link)});return response},async updateBulk(operations){log("kiss.db - online - updateBulk",0,operations);const response=await kiss.ajax.request({url:"/bulk",method:"patch",body:JSON.stringify(operations)});const channel="EVT_DB_UPDATE_BULK";kiss.pubsub.publish(channel,{channel:channel,dbMode:"online",accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),data:operations});return response},async findOne(modelId,recordId){log("kiss.db - online - findOne - Model "+modelId+" / Record "+recordId);return await kiss.ajax.request({url:"/"+modelId+"/"+recordId,method:"get"})},async findById(modelId,ids,sort=[],sortSyntax="normalized"){log("kiss.db - online - findById - Model "+modelId+" / Records: "+ids.join());const search={operation:"search",ids:ids,sort:sort,sortSyntax:sortSyntax};return await kiss.ajax.request({url:"/"+modelId,method:"post",body:JSON.stringify(search)})},async find(modelId,query){log("kiss.db - online - find - Model "+modelId+" / Query:",0,query);if(!query){return await kiss.ajax.request({url:"/"+modelId,method:"get"})}const search={operation:"search",filter:query.filter||{},filterSyntax:query.filterSyntax||"normalized",sort:query.sort||[],sortSyntax:query.sortSyntax||"normalized",group:query.group||[],projection:query.projection||{},skip:query.skip,limit:query.limit,groupUnwind:query.groupUnwind};return await kiss.ajax.request({url:"/"+modelId,method:"post",body:JSON.stringify(search)})},async deleteOne(modelId,recordId,sendToTrash){log("kiss.db - online - deleteOne - Model "+modelId+" / Record "+recordId);const response=await kiss.ajax.request({url:"/"+modelId+"/"+recordId,method:"delete",body:JSON.stringify({sendToTrash:!!sendToTrash})});const channel="EVT_DB_DELETE:"+modelId.toUpperCase();kiss.pubsub.publish(channel,{channel:channel,dbMode:"online",accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),modelId:modelId,id:recordId});return response},async deleteMany(modelId,query,sendToTrash){log("kiss.db - online - deleteMany - Model "+modelId,0,query);const params={operation:"delete",filter:query||{},sendToTrash:!!sendToTrash};const response=await kiss.ajax.request({url:"/"+modelId,method:"post",body:JSON.stringify(params),showLoading:true});const channel="EVT_DB_DELETE_MANY:"+modelId.toUpperCase();kiss.pubsub.publish(channel,{channel:channel,dbMode:"online",accountId:kiss.session.getCurrentAccountId(),userId:kiss.session.getUserId(),modelId:modelId,data:query});return response},count(modelId,query){log("kiss.db - online - count - Model "+modelId,0,query);return 42}};kiss.acl={async check({action:action,record:record}){const userACL=kiss.session.getACL();let model=record.model;try{const acl=kiss.tools.isUid(model.id)?kiss.app.models?.dynamicModel?.acl:model.acl;if(!acl)return true;const permissions=acl.permissions;if(!permissions)return true;const permissionRules=permissions[action];if(!permissionRules)return true;for(let rule of permissionRules){let hasPermission=true;const validators=Object.keys(rule);for(let validator of validators){const ruleTestValue=rule[validator];const ruleFunction=acl.validators[validator];if(ruleFunction){const permissionCheck=await ruleFunction({userACL:userACL,model:model,record:record});if(permissionCheck!=ruleTestValue)hasPermission=false;log(`kiss.acl - check (client) - ${action} - Model: ${model.name} ${record.id.slice(0,7)}... Permission: ${validator} = ${permissionCheck} - Access ${hasPermission?"granted":"denied"}`,hasPermission?2:4)}else{log(`kiss.acl - check (client) - Error: validator function <${validator}> is not defined for model ${model.id}`,4)}}if(hasPermission)return true}return false}catch(err){log(`kiss.acl - check (client) - Validator error - Model: ${model.id}`,4,err);return false}},async filter({records:records}){const userACL=kiss.session.getACL();const firstRecord=records[0];const model=firstRecord.model;try{const acl=model.acl;if(!acl)return true;const permissions=acl.permissions;if(!permissions)return true;const permissionRules=permissions.read;if(!permissionRules)return true;let hasPermission;let result=[];for(record of records){for(let rule of permissionRules){const validators=Object.keys(rule);hasPermission=true;for(let validator of validators){const ruleTestValue=rule[validator];const ruleFunction=acl.validators[validator];if(ruleFunction){const permissionCheck=await ruleFunction({userACL:userACL,record:record});log("kiss.acl - filter (client) - Permission: "+validator+" / "+permissionCheck,permissionCheck?2:4);if(permissionCheck!=ruleTestValue){hasPermission=false;break}}}if(hasPermission)break}if(hasPermission)result.push(record)}return result}catch(err){log(`kiss.acl - filter (client) - Validator error - Model: ${model.id} / Validator: ${validator}`,4,err);return false}}};kiss.ajax={timeout:6e4,headers:{Accept:"application/json","Content-Type":"application/json; charset=UTF-8"},host:"",setHost(host=""){kiss.ajax.host=host},setHeaders(headers){kiss.ajax.headers=headers},async request(params){log(`kiss.ajax - request - ${params.method||"GET"}: ${params.url}`);let options={method:params?.method?.toUpperCase()||"GET",headers:kiss.ajax.headers};const token=kiss.session.getToken();if(token)options.headers["Authorization"]="Bearer "+token;if(params.accept)options.headers["Accept"]=params.accept;if(params.authorization)options.headers["Authorization"]=params.authorization;if(params.accessControlAllowOrigin)options.headers["Access-Control-Allow-Origin"]=params.accessControlAllowOrigin;if(params.accessControlAllowHeaders)options.headers["Access-Control-Allow-Headers"]=params.accessControlAllowHeaders;if(params.body)options.body=params.body;if(params.contentType){if(params.contentType=="multipart/form-data"){delete options.headers["Content-Type"]}else{options.headers["Content-Type"]=params.contentType}}else{if(params.contentType!==false){options.headers["Content-Type"]="application/json; charset=UTF-8"}}const timeout=params.timeout||kiss.ajax.timeout;const abortController=new AbortController;options.signal=abortController.signal;setTimeout((()=>abortController.abort()),timeout);let loadingId;if(params.showLoading){loadingId=kiss.loadingSpinner.show()}const url=params.host||params.host===""?params.host+params.url:kiss.ajax.host+params.url;return fetch(url,options).then((async response=>{if(params.showLoading){kiss.loadingSpinner.hide(loadingId)}switch(response.status){case 401:kiss.session.showLogin();return false;case 498:if(kiss.global.ajaxRetries>=kiss.global.ajaxMaxRetries){kiss.global.ajaxRetries=0;return false}kiss.global.ajaxRetries++;const newToken=await kiss.session.getNewToken();if(newToken){return await kiss.ajax.request(params)}break;case 403:const data=await response.json();if(data.error){createNotification(txtTitleCase(data.error))}else{createNotification(txtTitleCase("#not authorized"))}default:return response.json().then((data=>data)).catch((err=>response))}})).catch((err=>{if(err.name=="AbortError"){log("kiss.ajax - request - Timeout!",4,err);createNotification(txtTitleCase("#error slow connection"))}else{log("kiss.ajax - request - Error:",4,err);log("kiss.ajax - The original request was:",4,params)}if(params.showLoading){loadingId=kiss.loadingSpinner.hide(loadingId)}return false}))},setTimeout(timeout){if(typeof timeout==="number")kiss.ajax.timeout=timeout}};kiss.app={formTemplates:{},viewTemplates:{},models:{},collections:{},defineTexts(texts){if(texts){Object.assign(kiss.language.texts,texts);log.info(`kiss.language - Loaded ${Object.keys(texts).length} translated texts`)}},defineModel(model){if(kiss.app.models[model.id])return kiss.app.models[model.id];return new kiss.data.Model(model)},defineModelRelationships(){Object.values(kiss.app.models).forEach((model=>model._defineRelationships()))},getModel(modelId){const model=kiss.app.models[modelId];if(model)return model;return kiss.app.getModelByName(modelId)},getModelByName(modelName){const model=Object.values(kiss.app.models).find((model=>model.name.toLowerCase()==modelName.toLowerCase()));return model},getCollectionByModelName(modelName){return Object.values(kiss.app.collections).find((collection=>collection.model.name.toLowerCase()==modelName.toLowerCase()))},listCollections(){Object.values(kiss.app.collections).forEach((collection=>{console.log(`id: ${collection.id}, name: ${collection.model.name}, records: ${collection.records.length}`)}))},defineView({id:id,renderer:renderer,meta:meta}){kiss.views.addView({id:id,renderer:renderer,meta:meta})},defineViewController(id,viewController){kiss.views.addViewController(id,viewController)},definePlugin(plugin){kiss.plugins.add(plugin)},async init(config){if(!config)return false;kiss.app.name=config.name;kiss.app.logo=config.logo;kiss.app.useDirectory=!!config.useDirectory;kiss.app.useDynamicModels=!!config.useDirectory;kiss.app.useFormPlugins=!!config.useFormPlugins;kiss.app.loader=config.loader;await kiss.language.init();kiss.plugins.initTexts();const location=window.location.pathname;if(location.includes("demo")){kiss.global.mode="demo";kiss.db.setMode("memory")}else if(location.includes("memory")){kiss.global.mode="memory";kiss.db.setMode("memory")}else if(location.includes("offline")){kiss.global.mode="offline";kiss.db.setMode("offline")}else{kiss.global.mode=config.mode||"online";kiss.db.setMode(kiss.global.mode)}let categories=["😘"];if(config.debug){categories=categories.concat(["*"])}kiss.logger.init({data:true,types:[0,1,2,3,4],categories:categories});if(config.undoRedo)kiss.undoRedo.init(config.undoRedo);if(config.theme)kiss.theme.set(config.theme);kiss.theme.init();kiss.screen.init();kiss.router.init();if(config.publicRoutes){if(Array.isArray(config.publicRoutes)&&config.publicRoutes.length>0){kiss.router.addPublicRoutes(config.publicRoutes)}}if(config.routerGuards){if(Array.isArray(config.routerGuards)&&config.routerGuards.length>0){kiss.router.addRoutingGuards(config.routerGuards)}}if(config.routerActions){if(Array.isArray(config.routerActions)&&config.routerActions.length>0){kiss.router.addRoutingActions(config.routerActions)}}if(config.startRoute){let route=config.startRoute;if(typeof route==="string"){route={ui:config.startRoute}}kiss.router.updateUrlHash(route,true)}const newRoute=kiss.router.getRoute();if(config.host){let host=config.host;if(typeof host==="string"){host={host:config.host}}kiss.session.setHost(host);kiss.session.secure=config.https===false?false:true;let ajaxHost=kiss.session.getHttpHost();kiss.ajax.setHost(ajaxHost)}if(config.loginMethods){if(Array.isArray(config.loginMethods)&&config.loginMethods.length>0){kiss.session.setLoginMethods(config.loginMethods)}}if(!kiss.router.isPublicRoute())await kiss.session.restore();kiss.router.navigateTo(newRoute);if($("splash"))$("splash").remove();console.log("😘 Powered with ❤ by KissJS, Keep It Simple Stupid Javascript (version "+kiss.version+")")},async load(){if(kiss.app.useDirectory){let success=await kiss.app.loadDirectory();if(!success)return false}if(kiss.app.useDynamicModels){let success=await kiss.app.loadDynamicModels();if(!success)return false}kiss.app.defineModelRelationships();await kiss.app.collections.link.find();if(kiss.app.useFormPlugins){await kiss.plugins.init()}return true},async loadDirectory(){return await kiss.directory.init()},async loadDynamicModels(){if(!await kiss.app.collections.model)return true;const models=await kiss.app.collections.model.find();if(!models)return false;models.forEach((model=>{if(model.items)kiss.app.defineModel(model)}));kiss.pubsub.subscribe("EVT_DB_INSERT:MODEL",(msgData=>{kiss.app.defineModel(msgData.data)}));return true}};kiss.context={history:[],lastContext:{},changes:{},update(newContext){let{history:history,...currentContext}=kiss.tools.snapshot(kiss.context);kiss.context.lastContext=currentContext;kiss.context.history.push(currentContext);Object.assign(kiss.context,newContext)},hasChanged(contextName){let isNew=this.history.length<=1;let propertiesToCheck=Object.keys(kiss.tools.snapshot(this));let lastContext=kiss.context.history[kiss.context.history.length-1];propertiesToCheck.forEach((property=>{if(property!="history")this.changes[property]=isNew?false:kiss.context[property]!=lastContext[property]}));if(contextName)return this.changes[contextName];return this.changes}};kiss.data.trash={async getRecords(modelId){const query={sort:[{deleteAt:"desc"}]};if(modelId){query.filter={sourceModelId:this.modelId};query.filterSyntax="mongo"}return await kiss.app.collections.trash.find(query,true)},async showRecords(config){if(!config||!config.modelId)return;const model=kiss.app.models[config.modelId];if(!model)return;const temporaryCollection=new kiss.data.Collection({id:"temp_"+uid(),model:kiss.app.models.trash});Object.assign(temporaryCollection,{filter:config.filter||{type:"filter",fieldId:"sourceModelId",operator:"=",value:config.modelId},sort:config.sort||[{deletedAt:"desc"}],filterSyntax:config.filterSyntax||"normalized",sortSyntax:config.sortSyntax||"normalized"});const columns=[{id:"deletedAt",title:txtTitleCase("#deletedAt"),type:"date"},{id:"deletedBy",title:txtTitleCase("#deletedBy"),type:"directory"}];const tempPanelId=kiss.tools.shortUid();const datatable=createDatatable({type:"datatable",model:model,collection:temporaryCollection,columns:columns,canFilter:false,canGroup:false,color:model.color,showHeader:true,showToolbar:true,showActions:false,canSelect:false,canEdit:false,canAddField:false,canEditField:false,canCreateRecord:false,iconAction:"fas fa-recycle",buttons:[{position:1,text:txtTitleCase("empty the trash"),icon:"fas fa-trash",iconColor:"var(--red)",action:async()=>{if(temporaryCollection.records.length==0){return createNotification(txtTitleCase("#warning trash empty"))}const firstRecord=temporaryCollection.records[0];const canDelete=await kiss.acl.check({action:"delete",record:firstRecord});if(!canDelete){return createNotification(txtTitleCase("#not authorized"))}kiss.data.trash.empty(model.id)}}],subscriptions:{"EVT_DB_DELETE_MANY:TRASH":function(){this.reload()}},methods:{selectRecord:async record=>{createDialog({title:txtTitleCase("#restore"),icon:"fas fa-recycle",message:txtTitleCase("#restore confirm"),action:async()=>{const response=await kiss.data.trash.restoreRecord(record.id);if(!response.success)createNotification(txtTitleCase("#not authorized"));$(tempPanelId).close()}})}}});createPanel({id:tempPanelId,modal:true,draggable:true,closable:true,expandable:true,title:txtTitleCase("#deleted records")+" <b>"+model.namePlural+"</b>",icon:model.icon,headerBackgroundColor:model.color,display:"flex",layout:"vertical",width:()=>kiss.screen.current.width-200,height:()=>kiss.screen.current.height-200,align:"center",verticalAlign:"center",autoSize:true,padding:0,items:[{flex:1,layout:"vertical",items:[datatable]}],events:{onclose:()=>temporaryCollection.destroy()}}).render()},async restoreRecord(recordId){log("kiss.data.trash - Restore record "+recordId);const record=await kiss.app.collections.trash.findOne(recordId,true);const canDelete=await kiss.acl.check({action:"delete",record:record});if(!canDelete){return{success:false}}const recordData=record.getRawData();const model=kiss.app.models[recordData.sourceModelId];delete recordData.sourceModelId;const newRecord=model.create(recordData);const success=await newRecord.save();if(success){await record.delete();return{success:true}}return{success:false}},empty(modelId){createDialog({type:"danger",title:txtTitleCase("empty the trash"),message:txtTitleCase("#warning empty trash"),buttonOKPosition:"left",action:async()=>{await kiss.app.collections.trash.deleteMany({sourceModelId:modelId})}})}};kiss.directory={users:[],groups:[],collaborators:[],apiClients:[],roles:{},index:{},colors:{},async init(){this._initRoles();if(kiss.session.isOnline()){const success=await this._initUsersAndGroups();if(!success)return false;this._initSubscriptions()}else{this._initOfflineUsersAndGroups()}return true},async _initUsersAndGroups(){this.users=[];this.groups=[];this.collaborators=[];this.apiClients=[];await this._loadUsers();if(!this.users)return false;await this._loadGroups();if(!this.groups)return false;await this._loadCollaborators();if(!this.collaborators)return false;await this._loadApiClients();if(!this.apiClients)return false;this._buildIndex();return true},_initOfflineUsersAndGroups(){this.users=[{id:kiss.tools.uid(),email:"contact@pickaform.com",firstName:"Contact",lastName:"Pickaform",invitedBy:[],isCollaboratorOf:[],isInvite:false,active:true}];this.groups=[{id:kiss.tools.uid(),icon:"fas fa-users",color:"#00aaee",name:"Managers",users:["contact@pickaform.com"]}];this._buildIndex()},_buildIndex(){this.index={};this.users.forEach((user=>this.index[user.email]=user));this.groups.forEach((group=>this.index[group.id]=group));this.apiClients.forEach((client=>this.index[client.id]=client))},_initRoles(){kiss.directory.roles.everyone={type:"role",label:txtTitleCase("#everyone"),value:"*"};kiss.directory.roles.authenticated={type:"role",label:txtTitleCase("authenticated users"),value:"$authenticated"};kiss.directory.roles.creator={type:"role",label:txtTitleCase("the creator of the record"),value:"$creator"};kiss.directory.roles.userId={type:"role",label:txtTitleCase("connected user"),value:"$userId"};kiss.directory.roles.nobody={type:"role",label:txtTitleCase("#nobody"),value:"$nobody"}},_initSubscriptions(){if(this.subscriptions)return;this.subscriptions=[subscribe("EVT_DB_INSERT:USER",(msgData=>{this.addUser(msgData.data);this._buildIndex()})),subscribe("EVT_DB_UPDATE:USER",(msgData=>{this.updateUser(msgData.id,msgData.data)})),subscribe("EVT_DB_DELETE:USER",(msgData=>{this.deleteUser(msgData.id);this._buildIndex()})),subscribe("EVT_DB_INSERT:GROUP",(msgData=>{this.addGroup(msgData.data);this._buildIndex()})),subscribe("EVT_DB_UPDATE:GROUP",(msgData=>{this.updateGroup(msgData.id,msgData.data)})),subscribe("EVT_DB_DELETE:GROUP",(msgData=>{this.deleteGroup(msgData.id);this._buildIndex()})),subscribe("EVT_DB_INSERT:APICLIENT",(msgData=>{this.addApiClient(msgData.data);this._buildIndex()})),subscribe("EVT_DB_UPDATE:APICLIENT",(msgData=>{this.updateApiClient(msgData.id,msgData.data)})),subscribe("EVT_DB_DELETE:APICLIENT",(msgData=>{this.deleteApiClient(msgData.id);this._buildIndex()})),subscribe("EVT_COLLABORATION:SENT",(async()=>{await this._initUsersAndGroups();kiss.pubsub.publish("EVT_DIRECTORY_UPDATED")})),subscribe("EVT_COLLABORATION:RECEIVED",(async()=>{kiss.pubsub.publish("EVT_DIRECTORY_UPDATED")})),subscribe("EVT_COLLABORATION:ACCEPTED",(async()=>{await this._initUsersAndGroups();kiss.pubsub.publish("EVT_DIRECTORY_UPDATED")})),subscribe("EVT_COLLABORATION:REJECTED",(async()=>{await this._initUsersAndGroups();kiss.pubsub.publish("EVT_DIRECTORY_UPDATED")})),subscribe("EVT_COLLABORATION:STOPPED",(async()=>{await this._initUsersAndGroups();kiss.pubsub.publish("EVT_DIRECTORY_UPDATED")}))]},addUser(user){const hasUser=kiss.directory.users.find((existingUser=>existingUser.id==user.id));if(hasUser)return;kiss.directory.users.push(user)},updateUser(userId,update){let user=kiss.directory.users.get(userId);Object.assign(user,update)},deleteUser(userId){this.users=this.users.filter((user=>user.id!=userId))},addGroup(group){const hasGroup=kiss.directory.groups.find((existingGroup=>existingGroup.id==group.id));if(hasGroup)return;kiss.directory.groups.push(group)},updateGroup(groupId,update){let group=kiss.directory.groups.get(groupId);Object.assign(group,update)},deleteGroup(groupId){this.groups=this.groups.filter((group=>group.id!=groupId))},addApiClient(client){const hasClient=kiss.directory.apiClients.find((existingClient=>existingClient.id==client.id));if(hasClient)return;kiss.directory.apiClients.push(client)},updateApiClient(clientId,update){let client=kiss.directory.apiClients.get(clientId);Object.assign(client,update)},deleteApiClient(clientId){this.apiClients=this.apiClients.filter((client=>client.id!=clientId))},async _loadUsers(){this.users=await kiss.ajax.request({url:"/getUsers"});return this.users},async _loadGroups(){this.groups=await kiss.app.collections.group.find();return this.groups},async _loadCollaborators(){this.collaborators=await kiss.ajax.request({url:"/getCollaborators"});return this.collaborators},async _loadApiClients(){this.apiClients=await kiss.ajax.request({url:"/getApiClients"});return this.apiClients},getEntry(entryId){return this.index[entryId]},getEntries(entryIds){return entryIds.map((id=>kiss.directory.index[id])).filter((entry=>!!entry))},getEntryName(userId){const entry=kiss.directory.getEntry(userId);if(!entry)return userId;if(entry.firstName&&entry.lastName){return entry.firstName+" "+entry.lastName}else{if(entry.users){return entry.name}else if(entry.name){return entry.name}return entry.email}},getEntryNames(entryIds){entryIds=[].concat(entryIds);return entryIds.map(this.getEntryName)},getUserACL(userId){let userACL=["*"];if(kiss.session.isOnline()){userACL=userACL.concat(userId);if(kiss.session.isAuthenticated())userACL=userACL.concat("$authenticated")}else{userACL=userACL.concat("$authenticated","anonymous")}this.groups.forEach((group=>{if(group.users.includes(userId))userACL.push(group.id)}));return userACL},getUserInitials(user){if(!user.firstName||!user.lastName)return"??";return(user.firstName[0]+user.lastName[0]).toUpperCase()},getEntryColor(userId){let userColor=kiss.directory.colors[userId];if(userColor)return userColor;userColor=kiss.tools.getRandomColor(0,20);kiss.directory.colors[userId]=userColor;return userColor},getUsers(config={sortBy:"lastName",nameOrder:"lastName",sortOrder:"asc",onlyActiveUsers:false}){const compareFunction=config.sortBy=="firstName"?this._sortByFirstName:this._sortByLastName;const users=kiss.directory.users.filter((user=>{if(config.onlyActiveUsers==false)return true;return user.active!==false})).map((user=>({type:"user",id:user.email,isInvite:user.isInvite,isOwner:user.isOwner,firstName:user.firstName||"",lastName:user.lastName||"",email:user.email,name:user.firstName&&user.lastName?config.nameOrder=="firstName"?user.firstName+" "+user.lastName:user.lastName+" "+user.firstName:user.email}))).sort(compareFunction);if(config.sortOrder=="desc")return users.reverse();return users},getGroups(sortOrder="asc"){const groups=kiss.directory.groups.map((group=>({type:"group",id:group.id,name:group.name}))).sort(this._sortByName);if(sortOrder=="desc")return groups.reverse();return groups},getApiClients(){const apiClients=kiss.directory.apiClients.map((client=>({type:"api",id:client.id,name:client.name}))).sort(this._sortByName);return apiClients},_sortByFirstName(a,b){if(a.firstName.toLowerCase()<b.firstName.toLowerCase())return-1;if(a.firstName.toLowerCase()>b.firstName.toLowerCase())return 1;return 0},_sortByLastName(a,b){if(a.lastName.toLowerCase()<b.lastName.toLowerCase())return-1;if(a.lastName.toLowerCase()>b.lastName.toLowerCase())return 1;return 0},_sortByName(a,b){if(a.name.toLowerCase()<b.name.toLowerCase())return-1;if(a.name.toLowerCase()>b.name.toLowerCase())return 1;return 0},async editUsername(userId){const user=await kiss.app.collections.user.findOne(userId);const initialFirstName=user.firstName;const initialLastName=user.lastName;createPanel({id:"edit-user-infos",title:txtTitleCase("#title edit name"),icon:"fas fa-edit",layout:"vertical",align:"center",verticalAlign:"center",modal:true,closable:true,draggable:true,defaultConfig:{width:350,labelWidth:150,fieldWidth:200},items:[{id:"edit-firstName",type:"text",label:txtTitleCase("first name"),value:user.firstName,required:true,min:2,max:50},{id:"edit-lastName",type:"text",label:txtTitleCase("last name"),value:user.lastName,required:true,min:2,max:50},{type:"button",text:txtTitleCase("#button edit name"),icon:"fas fa-check",height:40,margin:"20px 0px 10px 0px",action:()=>{const success=$("edit-user-infos").validate();if(!success)return;const firstName=$("edit-firstName").getValue();const lastName=$("edit-lastName").getValue();if(initialFirstName==firstName&&initialLastName==lastName){$("edit-user-infos").close();return true}createDialog({type:"danger",title:txtTitleCase("#title edit name"),buttonOKPosition:"left",message:txtTitleCase("#confirm edit name",null,{firstName:firstName,lastName:lastName}),action:async()=>{$("edit-user-infos").close();await user.update({firstName:firstName,lastName:lastName});localStorage.setItem("session-firstName",firstName);localStorage.setItem("session-lastName",lastName);kiss.pubsub.publish("EVT_USERNAME_UPDATED")}})}}]}).render()},toEmail(recipients){const groups=this.groups;recipients=[].concat(recipients);recipients=recipients.map((recipient=>{if(!kiss.tools.isUid(recipient))return recipient;const group=groups.find((group=>group.id==recipient));if(!group)return[];const groupUsers=group.users;if(groupUsers)return groupUsers;return[]}));recipients=recipients.flat();recipients=recipients.unique();recipients=recipients.filter((recipient=>recipient!="*"));return recipients.join(",")}};kiss.fields={renderers:{},cachedOptionsForSelectFields:new Map,getFieldType(field){let type=field.type;if(type=="lookup")return field.lookup.type||field.type;if(type=="summary")return field.summary.type||field.type;return type},setRenderer(model,field){kiss.fields.renderers[model.id]=kiss.fields.renderers[model.id]||{};if(field.valueRenderer){kiss.fields.renderers[model.id][field.id]=field.valueRenderer;return}let renderer;const type=this.getFieldType(field);switch(type){case"number":renderer=this._setRendererForNumber(field);break;case"date":renderer=this._setRendererForDate(field);break;case"textarea":case"aiTextarea":renderer=this._setRendererForTextarea();break;case"richTextField":renderer=this._setRendererForRichText();break;case"select":renderer=this._setRendererForSelect(field);break;case"directory":renderer=this._setRendererForDirectory();break;case"checkbox":renderer=this._setRendererForCheckbox(model,field);break;case"slider":renderer=this._setRendererForSlider(field);break;case"rating":renderer=this._setRendererForRating(model,field);break;case"color":renderer=this._setRendererForColor();break;case"icon":renderer=this._setRendererForIcon();break;case"selectViewColumn":renderer=this._setRendererForSelectViewColumn();break;case"attachment":case"aiImage":renderer=this._setRendererForAttachments();break;case"password":renderer=this._setRendererForPassword();break;case"link":renderer=this._setRendererForLink(field);break;default:renderer=this.defaultRenderer;break}kiss.fields.renderers[model.id][field.id]=renderer},defaultRenderer({value:value}){try{return((value||"")+"").escapeHtml()}catch(err){log(err)}},_setRendererForNumber(field){const precision=field?field.precision:2;const unit=field.unit?" "+field.unit:"";return function({value:value,config:config={}}){try{if(value===undefined)return"";return Number(value).format(precision)+(config.unit!=false?unit:"")}catch(err){log.err("kiss.fields - Error rendering number field");return""}}},_setRendererForDate(field){return function({value:value}){try{if(!value)return"";return new Date(value).toLocaleDateString()}catch(err){log.err("kiss.fields - Error rendering date field");return""}}},_setRendererForTextarea(){return function({value:value,config:config}){try{if(!value)return"";if(config&&config.nobr)return value;return value.replaceAll("\n","<br>")}catch(err){log.err("kiss.fields - Error rendering textarea field");return""}}},_setRendererForRichText(){return function({value:value,config:config}){try{if(!value)return"";value=kiss.tools.convertHtmlToPlainText(value);if(config&&config.nobr)return value;return value.replaceAll("\n","<br>")}catch(err){log.err("kiss.fields - Error rendering rich text field");return""}}},_setRendererForSelect(field){if(field.valueRenderer)return field.valueRenderer;let options=typeof field.options=="function"?field.options():field.options;if(!options){return function({value:value}){try{return[].concat(value).map((val=>{if(!val)return"";return`<span class="field-select-value">${val}</span>`})).join("")}catch(err){log.err("kiss.fields - Error rendering select field");return""}}}if(field.template=="time"){options=kiss.ui.Select.prototype._generateTimes(field.min||0,field.max||24,field.interval||60,true)}else{options=options||[];if(field.optionsTranslations&&kiss.language.currentDynamic&&field.optionsTranslations[kiss.language.currentDynamic]){options=options.map(((option,index)=>{if(typeof option=="object"){let finalOption={label:field.optionsTranslations[kiss.language.currentDynamic][index].value,value:option.value};if(option.color)finalOption.color=option.color;return finalOption}else{return{label:field.optionsTranslations[kiss.language.currentDynamic][index].value,value:option}}}))}}let mapOptions={};options.forEach((option=>{mapOptions[option.value.toLowerCase()]={value:option.label||option.value,color:option.color}}));return function({value:value}){try{return[].concat(value).map((val=>{if(!val)return"";let option=mapOptions[(""+val).toLowerCase()];if(!option)option={value:val};if(!option.value||option.value==" ")return"";return`<span class="field-select-value" ${option.color?`style="color: #ffffff; background-color: ${option.color}"`:""}>${option.value}</span>`})).join("")}catch(err){log.err("kiss.fields - Error rendering select field");return""}}},_setRendererForDirectory(){return function({value:value}){try{return[].concat(value).map((val=>{if(!val)return"";let name;switch(val){case"*":name=kiss.directory.roles.everyone.label;break;case"$authenticated":name=kiss.directory.roles.authenticated.label;break;case"$creator":name=kiss.directory.roles.creator.label;break;case"$nobody":name=kiss.directory.roles.nobody.label;break;default:name=kiss.directory.getEntryName(val)}return name?`<span class="field-select-value">${name}</span>`:""})).join("")}catch(err){log.err("kiss.fields - Error rendering directory field");return""}}},_setRendererForCheckbox(model,field){let shape=field.shape||"square";let iconColorOn=field.iconColorOn||"#000000";try{if(field.type=="lookup"){const linkId=field.lookup.linkId;const linkField=model.getField(linkId);const foreignModelId=linkField.link.modelId;const foreignModel=kiss.app.models[foreignModelId];const sourceField=foreignModel.getField(field.lookup.fieldId);shape=sourceField.shape;iconColorOn=sourceField.iconColorOn}}catch(err){log("kiss.fields - Couldn't generate renderer for field "+model.name+"/"+field.label);return function({value:value}){return value}}const iconClasses=kiss.ui.Checkbox.prototype.getIconClasses();const defaultIconOn=iconClasses[shape]["on"];const defaultIconOff=iconClasses[shape]["off"];return function({value:value}){return`<span ${value===true?`style="color: ${iconColorOn}"`:""} class="${value===true?defaultIconOn+" data-type-checkbox-checked":defaultIconOff+" data-type-checkbox-unchecked"}"></span>`}},_setRendererForSlider(field){const min=field.min||0;const max=field.max||100;const step=field.step||5;const unit=field.unit||"";return function({value:value,config:config={}}){return`<span class="field-slider-container">\n                <input class="field-slider" type="range" value="${value||0}" min="${min}" max="${max}" step="${step}" style="pointer-events: none;">\n                <span class="field-slider-value">${value||0} ${config.unit!=false?unit:""}</span>\n            </span>`}},_setRendererForRating(model,field){let shape=field.shape||"star";let iconColorOn=field.iconColorOn||"#ffd139";let iconColorOff=field.iconColorOff||"#dddddd";try{if(field.type=="lookup"){const linkId=field.lookup.linkId;const linkField=model.getField(linkId);const foreignModelId=linkField.link.modelId;const foreignModel=kiss.app.models[foreignModelId];const sourceField=foreignModel.getField(field.lookup.fieldId);shape=sourceField.shape;iconColorOn=sourceField.iconColorOn;iconColorOff=sourceField.iconColorOff}}catch(err){log("kiss.fields - Couldn't generate renderer for field "+model.name+"/"+field.label);return function({value:value}){return value}}const iconClasses=kiss.ui.Rating.prototype.getIconClasses();const icon=iconClasses[shape];const max=field.max||5;return function({value:value}){let html="";for(let i=0;i<max;i++){const color=i<value?iconColorOn:iconColorOff;html+=`<span class="rating ${icon}" style="color: ${color}" index=${i}></span>`}return html}},_setRendererForColor(){return function({value:value}){if(!value)return"";return`<span class="data-type-color" style="background: ${value}"></span>`}},_setRendererForIcon(){return function({value:value}){if(!value)return"";return`<span class="data-type-icon ${value}"/>`}},_setRendererForSelectViewColumn(){return function({value:value}){return[].concat(value).map((val=>{if(!val)return"";return`<span class="field-select-value">${val}</span>`})).join("")}},_setRendererForAttachments(){return function({value:value,config:config={}}){try{if(!value||value==" "||!Array.isArray(value))return"";let attachmentItems=value.map(((file,i)=>{if(!file.path)return"";let preview;let filePath=kiss.tools.createFileURL(file,config.thumbSize||"s");const fileExtension=file.path.split(".").pop().toLowerCase();if(["jpg","jpeg","png","gif","webp"].indexOf(fileExtension)!=-1){preview=`<img id="${file.id}" fieldId="${this.id}" class="data-type-attachment-image data-thumbnail" src="${filePath}" loading="lazy"></img>`}else{const{icon:icon,color:color}=kiss.tools.fileToIcon(fileExtension);preview=`<span id="${file.id}" fieldId="${this.id}" style="color: ${color}" class="fas ${icon} data-type-attachment-icon data-thumbnail"></span>`}return preview})).join("");return attachmentItems}catch(err){log.err("kiss.fields - Error rendering attachment field");return""}}},_setRendererForPassword(){return function(){return"***"}},_setRendererForLink(field){if(!field||!field.link)return()=>"";const linkModelId=field.link.modelId;if(!linkModelId)return()=>"";const linkModel=kiss.app.models[linkModelId];if(!linkModel)return()=>"";return function(){try{return`<span class="field-link-value-cell" modelId="${linkModelId}">\n                            ${field.multiple?linkModel.namePlural+"&nbsp; <span class='fas fa-sitemap'></span>":linkModel.name+"&nbsp; <span class='fas fa-link'></span>"}\n                        </span>`.removeExtraSpaces()}catch(err){log.err("kiss.fields - Error rendering link field");return""}}}};kiss.language={current:"en",currentDynamic:"en",texts:{},missingTexts:[],available:[{code:"en",name:"English"},{code:"fr",name:"Français"},{code:"es",name:"Español"}],setAvailable(languages){kiss.language.available=languages;return this},async init(loadAllLanguages=false){if(kiss.language.isInitialized)return;const urlLanguage=kiss.router.getRoute().language;if(urlLanguage){if(!kiss.language.available.find((lang=>lang.code==urlLanguage)))urlLanguage="en";kiss.language.current=urlLanguage}else{const navigatorLanguage=(navigator.languages?navigator.languages[0]:navigator.language).substring(0,2);const storedLanguage=localStorage.getItem("config-language");kiss.language.current=storedLanguage||navigatorLanguage||"en";if(!kiss.language.available.find((lang=>lang.code==kiss.language.current)))kiss.language.current="en"}const storedDynamicLanguage=localStorage.getItem("config-language-dynamic");if(storedDynamicLanguage){kiss.language.currentDynamic=storedDynamicLanguage}else{kiss.language.currentDynamic=kiss.language.current}if(!kiss.language.texts._){await kiss.language.loadLibraryTexts(loadAllLanguages)}kiss.language.isInitialized=true},async loadLibraryTexts(loadAllLanguages=false){const libraryPath=kiss.loader.getLibraryPath();if(loadAllLanguages){await kiss.loader.loadScript(libraryPath+"/texts/all")}else{await kiss.loader.loadScript(libraryPath+"/texts/"+kiss.language.current)}},get(){return{static:kiss.language.current,dynamic:kiss.language.currentDynamic}},translate(key,customSourceTexts,merge){let translationKey=customSourceTexts?customSourceTexts[key]:kiss.language.texts[key];let translation=translationKey?translationKey[kiss.language.current]:null;let isMissing=false;if(!translation){translation=key;isMissing=true}if(merge){Object.keys(merge).forEach((key=>{let tag=new RegExp("%"+key,"g");translation=translation.replace(tag,merge[key])}))}if(isMissing&&kiss.language.missingTexts.indexOf(key)==-1){kiss.language.missingTexts.push(key);log(`kiss.language - Missing [${kiss.language.current}] translation for [${key}]`,4)}return translation},translateProperty(obj,key){let value=obj[key];if(obj[key+"Translations"]){value=obj[key+"Translations"][kiss.language.currentDynamic]||obj[key]}return value},set(newLanguage){kiss.language.current=newLanguage;localStorage.setItem("config-language",newLanguage);document.location.reload()},setDynamic(newLanguage){kiss.language.currentDynamic=newLanguage;localStorage.setItem("config-language-dynamic",newLanguage);document.location.reload()},showMissingTexts(){let i=0;kiss.language.missingTexts.forEach((text=>{console.log(text);i++}));console.log(`kiss.language - Result: ${i} missing texts for language ${kiss.language.current}`)},showTranslationWindow(){const containerId=kiss.tools.uid();const items=kiss.language.missingTexts.map((text=>({type:"text",label:text,labelPosition:"top",width:"100%",events:{onchange:()=>$(containerId).update()}})));createPanel({title:"Quick translation for "+kiss.language.current.toUpperCase(),width:()=>kiss.screen.current.width-100,height:()=>kiss.screen.current.height-100,align:"center",verticalAlign:"center",modal:true,draggable:true,closable:true,layout:"horizontal",overflowY:"auto",defaultConfig:{margin:10,borderRadius:10,boxShadow:"var(--shadow-4)"},items:[{id:containerId,layout:"vertical",flex:1,overflowY:"auto",padding:10,items:items,methods:{update:function(){const translationFields=$(containerId).items;const translations={};translationFields.forEach((field=>{const translation=field.getValue();if(translation){const translationKey=field.getLabel();translations[translationKey]={[kiss.language.current]:translation}}}));$("export").setValue(JSON.stringify(translations,null,4))}}},{id:"export",type:"textarea",label:"Export",labelPosition:"top",flex:1,fieldHeight:"100%"}]}).render()},select(config={}){if($("language-window"))return;const isMobile=kiss.screen.isMobile;if(isMobile){responsiveOptions={top:()=>0,left:()=>0,width:"100%",height:"100%",borderRadius:"0 0 0 0",draggable:false}}else{responsiveOptions={verticalAlign:"center",draggable:true}}const titleStyle={color:"var(--blue)",fontSize:"1.8rem",fontWeight:"bold",flex:1,width:"100%",margin:"3rem 0 1.5rem 0",boxShadow:"none",textAlign:isMobile?"center":"left"};const defaultConfig={type:"button",flex:1,height:"5rem",minWidth:isMobile?"100%":"",margin:isMobile?"0 0 1rem 0":"0 1rem 0 0",iconColor:"var(--blue)",fontSize:"1.6rem",textAlign:"left",boxShadow:"var(--shadow-1)",boxShadowHover:"var(--shadow-4)"};const languageButtons=kiss.language.available.map((language=>({text:language.name,icon:"fas fa-flag",action:()=>kiss.language.set(language.code)})));return createPanel({id:"language-window",icon:"fas fa-globe",title:txtTitleCase("#switch language"),modal:true,backdropFilter:true,closable:true,display:"block",position:"absolute",align:"center",overflowY:"auto",padding:"0 2rem 2rem 2rem",...responsiveOptions,items:[{hidden:config.static==false,type:"html",...titleStyle,html:txtTitleCase("interface language")},{hidden:config.static==false,defaultConfig:defaultConfig,display:"flex",flexWrap:"wrap",items:languageButtons},{hidden:config.dynamic!=true,type:"html",...titleStyle,html:txtTitleCase("prefered language for content")},{hidden:config.dynamic!=true,type:"html",html:txtTitleCase("#content language help")},{hidden:config.dynamic!=true,defaultConfig:defaultConfig,items:[{type:"select",label:txtTitleCase("pick a language"),labelPosition:"top",flex:1,height:"7rem",margin:"2rem 0",maxHeight:isMobile?"":"20rem",options:kiss.language.codes.map((code=>({label:code.name,value:code.code}))),value:kiss.language.currentDynamic,events:{change:function(){const selectedContentLanguage=this.getValue();if(selectedContentLanguage){kiss.language.setDynamic(selectedContentLanguage)}}}}]}]}).render()},getLanguageName(code){const language=kiss.language.codes.find((lang=>lang.code==code));if(language){return language.name}else{return code}},codes:[{name:"Afaan Oromoo",code:"om"},{name:"Afaraf",code:"aa"},{name:"Afrikaans",code:"af"},{name:"Akan",code:"ak"},{name:"Aragonés",code:"an"},{name:"Asụsụ Igbo",code:"ig"},{name:"Avañe'ẽ",code:"gn"},{name:"Aymar aru",code:"ay"},{name:"Azərbaycanca",code:"az"},{name:"Bahasa Indonesia",code:"id"},{name:"Bahasa Melayu",code:"ms"},{name:"Bamanakan",code:"bm"},{name:"Basa Sunda",code:"su"},{name:"Bislama",code:"bi"},{name:"Brezhoneg",code:"br"},{name:"Bosanski",code:"bs"},{name:"Català",code:"ca"},{name:"Chamoru",code:"ch"},{name:"Corsu",code:"co"},{name:"Cymraeg",code:"cy"},{name:"Čeština",code:"cs"},{name:"Diné bizaad",code:"nv"},{name:"Deutsch",code:"de"},{name:"Eesti",code:"et"},{name:"Eʋegbe",code:"ee"},{name:"English",code:"en"},{name:"Español",code:"es"},{name:"Esperanto",code:"eo"},{name:"Euskara",code:"eu"},{name:"Faka‑Tonga",code:"to"},{name:"Føroyskt",code:"fo"},{name:"Français",code:"fr"},{name:"Frysk",code:"fy"},{name:"Fulfulde",code:"ff"},{name:"Gaelg",code:"gv"},{name:"Gaeilge",code:"ga"},{name:"Gàidhlig",code:"gd"},{name:"Galego",code:"gl"},{name:"Gĩkũyũ",code:"ki"},{name:"Hausa",code:"ha"},{name:"Hiri Motu",code:"ho"},{name:"Hrvatski",code:"hr"},{name:"IsiNdebele",code:"nd"},{name:"IsiXhosa",code:"xh"},{name:"IsiZulu",code:"zu"},{name:"Italiano",code:"it"},{name:"Íslenska",code:"is"},{name:"Kajin M̧ajeļ",code:"mh"},{name:"Kanuri",code:"kr"},{name:"Kashmiri",code:"ks"},{name:"Kernewek",code:"kw"},{name:"Kikongo",code:"kg"},{name:"Kirundi",code:"rn"},{name:"Kiswahili",code:"sw"},{name:"Kinyarwanda",code:"rw"},{name:"Kurdî",code:"ku"},{name:"Lao",code:"lo"},{name:"Latine",code:"la"},{name:"Latviešu",code:"lv"},{name:"Lëtzebuergesch",code:"lb"},{name:"Lietuvių",code:"lt"},{name:"Lingála",code:"ln"},{name:"Luganda",code:"lg"},{name:"Magyar",code:"hu"},{name:"Malagasy",code:"mg"},{name:"Malti",code:"mt"},{name:"Māori",code:"mi"},{name:"Melayu",code:"ms"},{name:"Nederlands",code:"nl"},{name:"Norsk",code:"no"},{name:"Norsk bokmål",code:"nb"},{name:"Norsk nynorsk",code:"nn"},{name:"Occitan",code:"oc"},{name:"Odia",code:"or"},{name:"Oshikwanyama",code:"kj"},{name:"Pāli",code:"pi"},{name:"Polski",code:"pl"},{name:"Português",code:"pt"},{name:"Reo Tahiti",code:"ty"},{name:"Română",code:"ro"},{name:"Rumantsch",code:"rm"},{name:"Русский",code:"ru"},{name:"Sängö",code:"sg"},{name:"Sesotho",code:"st"},{name:"Setswana",code:"tn"},{name:"Shqip",code:"sq"},{name:"Slovenčina",code:"sk"},{name:"Slovenščina",code:"sl"},{name:"Soomaali",code:"so"},{name:"Suomi",code:"fi"},{name:"Svenska",code:"sv"},{name:"Tiếng Việt",code:"vi"},{name:"Türkçe",code:"tr"},{name:"Yкраїнська",code:"uk"},{name:"اردو",code:"ur"},{name:"العربية",code:"ar"},{name:"فارسی",code:"fa"},{name:"עברית",code:"he"},{name:"हिन्दी",code:"hi"},{name:"বাংলা",code:"bn"},{name:"தமிழ்",code:"ta"},{name:"తెలుగు",code:"te"},{name:"ไทย",code:"th"},{name:"ᐃᓄᒃᑎᑐᑦ",code:"iu"},{name:"日本語",code:"ja"},{name:"中文",code:"zh"},{name:"한국어",code:"ko"},{name:"ꆇꉙ",code:"ii"},{name:"བོད་སྐད་",code:"bo"},{name:"རྫོང་ཁ",code:"dz"},{name:"မြန်မာဘာသာ",code:"my"},{name:"ქართული",code:"ka"},{name:"ትግርኛ",code:"ti"},{name:"አማርኛ",code:"am"},{name:"ᐊᓂᔑᓈᐯᒧᐎᓐ",code:"oj"},{name:"Ṣọ̀rọ̀ Yorùbá",code:"yo"},{name:"Wolof",code:"wo"},{name:"IsiSwati",code:"ss"},{name:"Volapük",code:"vo"},{name:"Tshivenḓa",code:"ve"},{name:"Xitsonga",code:"ts"}]};const txt=kiss.language.translate;const txtUpperCase=(key,customSourceTexts,merge)=>txt(key,customSourceTexts,merge).toUpperCase();const txtLowerCase=(key,customSourceTexts,merge)=>txt(key,customSourceTexts,merge).toLowerCase();const txtTitleCase=(key,customSourceTexts,merge)=>txt(key,customSourceTexts,merge).toTitleCase();kiss.loadingSpinner={components:[],_isLoading(){return this.components.length!=0},_init(){this.loadingLayer=document.createElement("div");this.loadingLayer.setAttribute("id","loading-layer");this.loadingLayer.style.display="fixed";this.loadingLayer.style.width="100%";this.loadingLayer.style.height="100%";document.body.append(this.loadingLayer)},show(){if(!this.loadingLayer)this._init();this.loadingId=kiss.tools.shortUid();this.components.push(this.loadingId);this.loadingLayer.showLoading({fullscreen:true,spinnerSize:"12.8rem",mask:false});return this.loadingId},hide(loadingId){this.components=this.components.filter((componentId=>componentId!=loadingId));if(this.components.length==0&&this.loadingLayer)this.loadingLayer.hideLoading()}};kiss.logger={history:[],maxLength:200,types:["*"],categories:["none"],data:true,init(config){kiss.logger.maxLength=config.maxLength||200;kiss.logger.types=config.types||[];kiss.logger.categories=config.categories||[];if(config.data===false)kiss.logger.data=false},log(msg,type=0,data){if(typeof msg!="string")return console.log(msg);const msgCategory=msg.split(" ")[0];if(!kiss.logger.categories.includes(msgCategory)&&!kiss.logger.categories.includes("*"))return;if(!kiss.logger.types.includes(type)&&!kiss.logger.types.includes("*"))return;let style;switch(type){case 0:style="color: black";break;case 1:style="color: blue";break;case 2:style="color: green";break;case 3:style="color: orange";break;case 4:style="color: red";break}console.log("%c%s",style,msg);if(data&&kiss.logger.data)console.log(data);kiss.logger.history.push({msg:msg,type:type});if(kiss.logger.history.length>kiss.logger.maxLength)kiss.logger.history.splice(0,1)},show(){console.log(kiss.logger.history)},replay(count=0){if(!count){kiss.logger.history.forEach((event=>log(event.msg,event.type)))}else{kiss.logger.history.slice(-count).forEach((event=>log(event.msg,event.type)))}}};const log=kiss.logger.log;log.info=(msg,data)=>log(msg,1,data);log.ack=(msg,data)=>log(msg,2,data);log.warn=(msg,data)=>log(msg,3,data);log.err=(msg,data)=>log(msg,4,data);kiss.plugins={plugins:[],add(plugin){try{log("kiss.plugins - Adding plugin <"+plugin.name+">",1,plugin);kiss.plugins.plugins.push(plugin)}catch(err){log("kiss.plugins - The plugin "+plugin.id+" is not well formatted",4,plugin)}},get(pluginId){if(!pluginId)return kiss.plugins.plugins.sortBy("order");return kiss.plugins.plugins.find((plugin=>plugin.id==pluginId))},getTexts(pluginId){const plugin=kiss.plugins.get(pluginId);return plugin.texts},initTexts(){this.plugins.forEach((plugin=>{plugin.name=txtTitleCase("name",plugin.texts);plugin.description=txtTitleCase("description",plugin.texts);plugin.instructions=txtTitleCase("instructions",plugin.texts)}))},async init(){for(let plugin of kiss.plugins.plugins){if(plugin.init)await plugin.init();if(plugin.methods)Object.keys(plugin.methods).forEach((method=>plugin[method]=plugin.methods[method]))}}};kiss.pubsub={subscriptions:{},channelsNotLogged:["EVT_ROUTE_UPDATED","EVT_CONTAINERS_RESIZED"],publish(channel,messageData){let targetChannel=kiss.pubsub.subscriptions[channel];if(!targetChannel){kiss.pubsub.publishOnGlobalChannel(messageData);return}if(!kiss.pubsub.channelsNotLogged.includes(channel.toUpperCase())){log.info("kiss.pubsub - publish on channel: "+channel,messageData)}Object.keys(targetChannel).forEach((subscriptionId=>{let fn=targetChannel[subscriptionId];try{fn(messageData)}catch(err){log.err("kiss.pubsub - publish - Error with subscription id: "+subscriptionId,err)}}));kiss.pubsub.publishOnGlobalChannel(messageData)},publishOnGlobalChannel(messageData){if(kiss.pubsub.subscriptions["*"]){let globalChannel=kiss.pubsub.subscriptions["*"];Object.keys(globalChannel).forEach((subscriptionId=>{let fn=globalChannel[subscriptionId];try{fn(messageData)}catch(err){log.err("kiss.pubsub - publish - Error with subscription id: "+subscriptionId,err)}}))}},subscribe(channel,fn,description){let subscriptionId=kiss.tools.shortUid();if(!kiss.pubsub.subscriptions[channel])kiss.pubsub.subscriptions[channel]={};kiss.pubsub.subscriptions[channel][subscriptionId]=fn;kiss.pubsub.subscriptions[channel][subscriptionId].description=description;return subscriptionId},subscribeOnce(channel,fn,description){let subscriptionId=kiss.pubsub.subscribe(channel,fn,description);let originalFn=kiss.pubsub.subscriptions[channel][subscriptionId];kiss.pubsub.subscriptions[channel][subscriptionId]=function(messageData){originalFn(messageData);kiss.pubsub.unsubscribe(subscriptionId)};return subscriptionId},unsubscribe(subscriptionId){Object.keys(kiss.pubsub.subscriptions).forEach((channel=>{let channelSubscriptions=kiss.pubsub.subscriptions[channel];Object.keys(channelSubscriptions).forEach((channelSubscriptionId=>{if(channelSubscriptionId==subscriptionId){delete kiss.pubsub.subscriptions[channel][subscriptionId];return}}))}))},getCount(){let count=0;Object.keys(kiss.pubsub.subscriptions).forEach((channel=>{let channelSubscriptions=kiss.pubsub.subscriptions[channel];Object.keys(channelSubscriptions).forEach((()=>count++))}));return count},get(subscriptionId){let subscription;Object.keys(kiss.pubsub.subscriptions).forEach((channel=>{let channelSubscriptions=kiss.pubsub.subscriptions[channel];Object.keys(channelSubscriptions).forEach((channelSubscriptionId=>{if(channelSubscriptionId==subscriptionId){subscription=kiss.pubsub.subscriptions[channel][subscriptionId]}}))}));return subscription},list(showFunction){let counter=0;Object.keys(kiss.pubsub.subscriptions).forEach((channel=>{let channelSubscriptions=kiss.pubsub.subscriptions[channel];Object.keys(channelSubscriptions).forEach((channelSubscriptionId=>{let subscription=kiss.pubsub.subscriptions[channel][channelSubscriptionId];let description=kiss.pubsub.subscriptions[channel][channelSubscriptionId].description;log("-----------------------------------------------------------------");log.info("Subscription "+counter.pad(5)+" - subscription id: "+channelSubscriptionId);if(description)log.ack("Description: ",description);if(showFunction)log.ack("Function: ",subscription);counter++}))}));log("Total number of subscriptions: "+counter)}};const publish=kiss.pubsub.publish;const subscribe=kiss.pubsub.subscribe;const unsubscribe=kiss.pubsub.unsubscribe;kiss.router={publicRoutes:["authentication-login","authentication-register","authentication-reset-password","authentication-error"],init(config={}){if(config.publicRoutes&&Array.isArray(config.publicRoutes)){kiss.router.publicRoutes=config.publicRoutes}window.onhashchange=async function(){const newRoute=kiss.router.getRoute();const doRoute=await kiss.router._beforeRouting(newRoute);if(!doRoute)return;kiss.context.update(newRoute);await kiss.router._afterRouting()}},setPublicRoutes(publicRoutes){kiss.router.publicRoutes=publicRoutes},addPublicRoutes(publicRoutes){kiss.router.publicRoutes=kiss.router.publicRoutes.concat(publicRoutes).unique()},addRoutingGuards(guards){if(guards&&Array.isArray(guards)){kiss.router.beforeRoutingGuards=kiss.router.beforeRoutingGuards.concat(guards)}},addRoutingActions(actions){if(actions&&Array.isArray(actions)){kiss.router.afterRoutingActions=kiss.router.afterRoutingActions.concat(actions)}},isPublicRoute(){const currentRoute=kiss.router.getRoute().ui;if(!currentRoute)return false;return kiss.router.publicRoutes.includes(currentRoute)},async navigateTo(newRoute,reset){if(typeof newRoute==="string")newRoute={ui:newRoute};kiss.router.updateUrlHash(newRoute,reset);window.dispatchEvent(new HashChangeEvent("hashchange"))},getRoute(){return kiss.router._toRoute(window.location.hash.slice(1))},updateUrlHash(newRoute,reset){const currentRoute=kiss.router.getRoute();const toRoute=reset?newRoute:Object.assign(currentRoute,newRoute);const newHash="#"+kiss.router._toHash(toRoute);window.history.pushState(toRoute,toRoute.ui,newHash)},_toRoute(hash){const route={};hash.split("&").forEach((param=>{const paramName=param.split("=")[0];if(paramName)route[paramName]=param.split("=")[1]}));return route},_toHash(newRoute){const hash=[];Object.keys(newRoute).forEach((key=>newRoute[key]?hash.push(key+"="+newRoute[key]):""));return hash.join("&")},async _beforeRouting(newRoute){if(kiss.router._isLoginPage(newRoute))return true;if(kiss.router._isPublicRoute(newRoute))return true;const appLoaded=await kiss.router._isAppLoaded();if(!appLoaded)return false;for(let guardFunction of kiss.router.beforeRoutingGuards){const guardResult=await guardFunction(newRoute);if(!guardResult)return false}return true},async _afterRouting(){for(let actionFunction of kiss.router.afterRoutingActions){await actionFunction()}},_isLoginPage(newRoute){if(newRoute.ui==kiss.session.defaultViews.login)return true;return false},_isPublicRoute(newRoute){if(kiss.router.publicRoutes.indexOf(newRoute.ui)!=-1)return true;return false},async _isAppLoaded(){if(!kiss.app.isLoaded){let success=await kiss.app.load();if(!success)return false;if(kiss.app.loader&&typeof kiss.app.loader==="function"){success=await kiss.app.loader();if(!success)return false}kiss.app.isLoaded=true}return true},beforeRoutingGuards:[],afterRoutingActions:[async function(){const newRoute=kiss.router.getRoute();if(newRoute.ui)await kiss.views.show(newRoute.ui,null,true);for(let route of Object.keys(newRoute)){if(route.startsWith("ui")&&route!="ui")await kiss.views.show(newRoute[route])}kiss.pubsub.publish("EVT_ROUTE_UPDATED",newRoute)}]};kiss.screen={isMobile:false,isHorizontal:()=>kiss.screen.current.width>kiss.screen.current.height,isVertical:()=>kiss.screen.current.width<kiss.screen.current.height,isTouch:()=>"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,lastClick:{x:0,y:0},previous:{width:window.innerWidth,height:window.innerHeight,ratio:window.innerWidth/window.innerHeight},current:{width:window.innerWidth,height:window.innerHeight,ratio:window.innerWidth/window.innerHeight},init(){if(kiss.tools.isMobile())kiss.screen.isMobile=true;kiss.screen.observe()},_update(){kiss.screen.previous=kiss.screen.current;kiss.screen.current={width:window.innerWidth,height:window.innerHeight,ratio:window.innerWidth/window.innerHeight}},_delta(){let deltaWidth=kiss.screen.current.width-kiss.screen.previous.width;let deltaHeight=kiss.screen.current.height-kiss.screen.previous.height;let delta={width:deltaWidth,height:deltaHeight};return delta},getHeightMinus(...something){let delta=0;something.forEach((function(item){if(typeof item=="number"){delta+=item}else{if(item.indexOf("px")!=-1){delta+=Number(item.substring(0,item.indexOf("px")))}else{let node=$(item);if(node){if(!node.offsetHeight)node=node.firstElementChild;delta+=node.offsetHeight}}}}));return window.innerHeight-delta},getWidthMinus(...something){let delta=0;something.forEach((function(item){if(typeof item=="number"){delta+=item}else{if(item.indexOf("px")!=-1){delta+=Number(item.substring(0,item.indexOf("px")))}else{let node=$(item);if(node){if(!node.offsetWidth)node=node.firstElementChild;delta+=node.offsetWidth}}}}));return window.innerWidth-delta},getOrientation(){return kiss.screen.current.height>kiss.screen.current.width?"vertical":"horizontal"},_debounce(interval,fn){let timer;return function(event){if(timer)clearTimeout(timer);timer=setTimeout(fn,interval,event)}},observe(){window.addEventListener("resize",kiss.screen._debounce(100,(function(){kiss.screen._update();kiss.pubsub.publish("EVT_WINDOW_RESIZED",{previous:kiss.screen.previous,current:kiss.screen.current,delta:kiss.screen._delta()})})));window.addEventListener("mousemove",(evt=>{kiss.screen.mousePosition={x:evt.clientX,y:evt.clientY}}))},getResizeObserver(){if(kiss.screen.resize)return kiss.screen.resize;kiss.screen.resize=new ResizeObserver(kiss.screen._debounce(100,(function(entries){let elements=Array.from(entries).filter((entry=>entry.borderBoxSize[0].blockSize!=0)).map((entry=>entry.target.id));if(elements.length>0)kiss.pubsub.publish("EVT_CONTAINERS_RESIZED",elements)})));return kiss.screen.resize}};kiss.selection={insertOne(viewId,recordId){let selection=localStorage.getItem("config-selection-"+viewId);if(!selection){localStorage.setItem("config-selection-"+viewId,recordId);return}let records=selection.split(",");if(records.indexOf(recordId)!=-1)return;localStorage.setItem("config-selection-"+viewId,selection+","+recordId)},insertMany(viewId,recordIds){let selection=localStorage.getItem("config-selection-"+viewId);if(!selection){localStorage.setItem("config-selection-"+viewId,recordIds.join(","));return}let ids=selection.split(",");ids=ids.concat(recordIds).unique();localStorage.setItem("config-selection-"+viewId,ids.join(","))},delete(viewId,recordId){let selection=localStorage.getItem("config-selection-"+viewId);if(!selection)return;let records=selection.split(",").remove(recordId);records=records.filter((recordId=>recordId!=""));localStorage.setItem("config-selection-"+viewId,records.join(","))},reset(viewId){let selection=localStorage.getItem("config-selection-"+viewId);if(!selection)return;localStorage.removeItem("config-selection-"+viewId)},get(viewId){let selection=localStorage.getItem("config-selection-"+viewId);if(!selection)return[];return selection.split(",")},getFromActiveView(){const viewId=kiss.context.viewId;if(!viewId)return[];let selection=localStorage.getItem("config-selection-"+viewId);if(!selection)return[];return selection.split(",")},async getRecords(viewId){const recordIds=kiss.selection.get(viewId);const viewCollection=$(viewId).collection;return await viewCollection.findById(recordIds)},async getRecordsFromActiveView(){const viewId=kiss.context.viewId;return await kiss.selection.getRecords(viewId)},updateSelectedRecords(){const ids=kiss.selection.getFromActiveView();if(ids.length==0)return createNotification(txtTitleCase("#no selection"));const model=kiss.app.models[kiss.context.modelId];if(!model)return;const fields=model.getUpdatableFields();createPanel({id:"selection-batch-update",title:txtTitleCase("update selected documents"),modal:true,backdropFilter:true,closable:true,draggable:true,icon:"fas fa-bolt",align:"center",verticalAlign:"center",layout:"vertical",width:400,items:[{id:"batch-field",type:"select",label:txtTitleCase("field to update"),labelPosition:"top",width:"100%",options:fields.map((field=>({value:field.id,label:field.label}))),events:{change:function(){const fieldId=this.getValue();$("selection-batch-update").updateInput(fieldId)}}},{id:"batch-value-container"},{hidden:true,id:"batch-update-button",type:"button",text:txtTitleCase("update"),icon:"fas fa-bolt",iconColor:"var(--yellow)",margin:"5px 5px 0 5px",action:()=>$("selection-batch-update").updateRecords(ids)}],methods:{updateRecords(ids){createDialog({title:txtTitleCase("update selected documents"),type:"danger",buttonOKPosition:"left",message:txtTitleCase("#warning update docs",null,{n:ids.length}),action:async()=>{const fieldId=$("batch-field").getValue();const value=$("batch-value").getValue();if(value==""){createDialog({title:txtTitleCase("empty value"),type:"danger",buttonOKPosition:"left",message:txtTitleCase("#warning empty value"),action:async()=>{await kiss.selection._updateRecords(fieldId,value);$("selection-batch-update").close();const viewId=kiss.context.viewId;$(viewId).deselectAll()}})}else{kiss.selection._updateRecords(fieldId,value);$("selection-batch-update").close();const viewId=kiss.context.viewId;$(viewId).deselectAll()}}})},updateInput(fieldId){let currentField=$("batch-value");if(currentField)currentField.deepDelete();const fieldConfig=this.buildInput(fieldId);let input=fieldConfig.renderer(fieldConfig);input.render();$("batch-update-button").show()},buildInput(fieldId){const fieldConfig=fields.find((field=>field.id==fieldId));let fieldType=fieldConfig.type;let fieldBuilderFunction=createField;let allowValuesNotInList=true;let iconColorOn;let checked=false;let options=[];let optionsFilter;let shape="";let roles=[];let multiple;let unit;let min;let max;let rows;switch(fieldType){case"textarea":case"aiTextarea":fieldType="textarea";rows=5;break;case"select":options=fieldConfig.options;optionsFilter=fieldConfig.optionsFilter;multiple=fieldConfig.multiple;allowValuesNotInList=fieldConfig.allowValuesNotInList;fieldBuilderFunction=createSelect;break;case"checkbox":shape=fieldConfig.shape;iconColorOn=fieldConfig.iconColorOn;fieldBuilderFunction=createCheckbox;break;case"slider":min=fieldConfig.min||0;max=fieldConfig.max||100;fieldBuilderFunction=createSlider;break;case"rating":shape=fieldConfig.shape||"star";min=fieldConfig.min||0;max=fieldConfig.max||10;iconColorOn=fieldConfig.iconColorOn;fieldBuilderFunction=createRating;break;case"color":fieldBuilderFunction=createColorField;break;case"icon":fieldBuilderFunction=createIconField;break;case"directory":roles=["userId"];multiple=fieldConfig.multiple;allowValuesNotInList=false;fieldBuilderFunction=createDirectory;break}return{id:"batch-value",target:"batch-value-container",type:fieldType,label:txtTitleCase("new field value"),labelPosition:"top",width:"100%",rows:rows,min:min,max:max,unit:unit,checked:checked,multiple:multiple,allowValuesNotInList:allowValuesNotInList,renderer:fieldBuilderFunction,options:options,optionsFilter:optionsFilter,optionsColor:model.color,roles:roles,shape:shape,iconColorOn:iconColorOn,iconSize:"20px"}}}}).render()},async _updateRecords(fieldLabel,value){const model=kiss.app.models[kiss.context.modelId];if(!model)return;const field=model.getFieldByLabel(fieldLabel);if(!field)return;const viewId=kiss.context.viewId;if(!$(viewId))return;const recordIds=kiss.selection.get(viewId);const viewCollection=$(viewId).collection;const selectedRecords=await viewCollection.findById(recordIds);kiss.global.preventViewRefresh=true;const loadingId=kiss.loadingSpinner.show();let counter=0;for(let record of selectedRecords){record.update({[field.id]:value});await kiss.tools.wait(100);counter++;createNotification(counter+" / "+selectedRecords.length);if(counter==selectedRecords.length-1){kiss.global.preventViewRefresh=false}}kiss.loadingSpinner.hide(loadingId)},deleteSelectedRecords(){const model=kiss.app.models[kiss.context.modelId];if(!model)return;const ids=this.getFromActiveView();if(ids.length==0)return createNotification(txtTitleCase("#no selection"));createDialog({title:txtTitleCase("delete selected documents"),type:"danger",buttonOKPosition:"left",message:txtTitleCase("#warning delete docs",null,{n:ids.length}),action:async()=>{await kiss.db.deleteMany(model.id,{_id:{$in:ids}},true);const viewId=kiss.context.viewId;$(viewId).deselectAll()}})}};kiss.session={resourcesObserver:null,maxIdleTime:4*60,userId:"anonymous",isOwner:false,invitedBy:[],isCollaboratorOf:[],defaultViews:{login:"authentication-login",home:"home-start",application:"application-start"},loginMethods:["internal","google","microsoftAD"],host:"",httpPort:80,httpsPort:443,wsPort:80,wssPort:443,setHost(config){config.host=config.host||"";config.httpPort=config.httpPort||80;config.httpsPort=config.httpsPort||443;config.wsPort=config.wsPort||80;config.wssPort=config.wssPort||443;Object.assign(kiss.session,config)},secure:true,setSecure(secure=true){kiss.session.secure=secure},getHttpHost(){const host=!this.host?window.location.host:this.host;const url=this.secure?"https://"+host:"http://"+host;return this.secure?url+":"+this.httpsPort:url+":"+this.httpPort},getWebsocketHost(){const host=!this.host?window.location.host:this.host;const url=this.secure?"wss://"+host:"ws://"+host;return this.secure?url+":"+this.wssPort:url+":"+this.wsPort},setDefaultViews(views){Object.assign(this.defaultViews,views)},setWebSocketMessageView(viewId){this.webSocketMessageView=viewId},getLoginMethodTypes:()=>[{type:"internal",alias:"i"},{type:"google",alias:"g",text:"Google",icon:"fab fa-google",callback:"/auth/google"},{type:"microsoftAD",alias:"a",text:"Microsoft",icon:"fab fa-microsoft",callback:"/auth/azureAd"},{type:"microsoft365",alias:"m",text:"Microsoft 365",icon:"fab fa-microsoft",callback:"/auth/microsoft"},{type:"linkedin",alias:"l",text:"LinkedIn",icon:"fab fa-linkedin",callback:"/auth/linkedin"},{type:"facebook",alias:"f",text:"Facebook",icon:"fab fa-facebook",callback:"/auth/facebook"},{type:"instagram",alias:"s",text:"Instagram",icon:"fab fa-instragram",callback:"/auth/instagram"},{type:"twitter",alias:"t",text:" Twitter",icon:"fab fa-twitter",callback:"/auth/twitter"}],setLoginMethods(methods){kiss.session.loginMethods=methods},getLoginMethods(){if(!kiss.session.loginMethods){return kiss.session.getLoginMethodTypes().map((method=>method.alias)).join("")}else{return kiss.session.loginMethods.map((loginMethodType=>kiss.session.getLoginMethodTypes().find((loginMethod=>loginMethod.type==loginMethodType)))).filter((loginMethod=>loginMethod!==undefined)).map((loginMethod=>loginMethod.alias)).join("")}},isOffline:()=>["memory","offline"].includes(kiss.db.mode),isOnline:()=>!kiss.session.isOffline(),setMaxIdleTime(newIdleTime){this.maxIdleTime=newIdleTime;localStorage.setItem("session-max-idle-time",this.maxIdleTime)},getMaxIdleTime(){return localStorage.getItem("session-max-idle-time")||kiss.session.maxIdleTime},selectMaxIdleTime(){const currentMaxIdleTime=kiss.session.getMaxIdleTime()/60;createPanel({id:"idle-time",title:txtTitleCase("#auto logout"),icon:"fas fa-clock",modal:true,backdropFilter:true,draggable:true,closable:true,align:"center",verticalAlign:"center",padding:50,items:[{id:"maxIdleTime",type:"slider",value:currentMaxIdleTime,label:txtTitleCase("#auto logout help"),labelPosition:"top",min:.5,max:8,step:.5,width:500,events:{change:function(){const newMaxIdleTime=this.getValue()*60;kiss.session.setMaxIdleTime(newMaxIdleTime);createNotification(txtTitleCase("#update done"))}}}]}).render()},getServerEnvironment:async()=>{const response=await kiss.ajax.request({url:"/getEnvironment"});return response.environment||"unknown"},getToken:()=>localStorage.getItem("session-token"),getRefreshToken:()=>localStorage.getItem("session-refresh-token"),getExpiration:()=>localStorage.getItem("session-expiration"),getWebsocketPort:()=>localStorage.getItem("session-ws.port"),getWebsocketSSLPort:()=>localStorage.getItem("session-ws.sslPort"),getLastActivity:()=>{const lastActivity=localStorage.getItem("session-lastActivity");if(lastActivity)return new Date(lastActivity);else return new Date},getUserId:()=>kiss.session.isOffline()?"anonymous":localStorage.getItem("session-userId")||"anonymous",isAuthenticated:()=>kiss.session.isOffline()?true:kiss.session.getUserId()!="anonymous",getFirstName:()=>kiss.session.isOffline()?"anonymous":localStorage.getItem("session-firstName"),getLastName:()=>kiss.session.isOffline()?"anonymous":localStorage.getItem("session-lastName"),getUserName:()=>kiss.session.isOffline()?"anonymous":kiss.session.getFirstName()+" "+kiss.session.getLastName(),getAccountId:()=>kiss.session.isOffline()?"anonymous":localStorage.getItem("session-accountId"),getCurrentAccountId:()=>kiss.session.isOffline()?"anonymous":localStorage.getItem("session-currentAccountId"),getCollaborators:()=>{if(!kiss.session.isOffline()){try{return JSON.parse(localStorage.getItem("session-isCollaboratorOf"))}catch(err){}}return[]},getInvitations:()=>{if(!kiss.session.isOffline()){try{return JSON.parse(localStorage.getItem("session-invitedBy"))}catch(err){}}return[]},isAccountOwner:()=>{if(kiss.session.isOffline())return true;return localStorage.getItem("session-accountId")==localStorage.getItem("session-currentAccountId")},isAccountManager(){if(kiss.session.isOffline())return true;if(!kiss.session.account)return false;return(kiss.session.account.managers||[]).includes(this.getUserId())},async initAccount(){if(kiss.session.isOnline()){kiss.session.account=await kiss.app.collections.account.findOne(kiss.session.getCurrentAccountId());kiss.pubsub.subscribe("EVT_DB_UPDATE:ACCOUNT",(async()=>kiss.session.account=await kiss.app.collections.account.findOne(kiss.session.getCurrentAccountId())))}else{kiss.session.account=kiss.app.models.account.create({accountId:"anonymous",status:"active"})}},initAccountOwner(){if(kiss.db.mode=="memory"||kiss.db.mode=="offline"){kiss.session.isOwner=true}else{kiss.session.isOwner=this.isAccountOwner()}},initAccountManagers(){if(kiss.db.mode=="memory"||kiss.db.mode=="offline"){kiss.session.isManager=true}else{kiss.session.isManager=this.isAccountManager()}},hooks:{beforeInit:[],beforeRestore:[],afterInit:[async()=>await kiss.session.initAccount()],afterRestore:[async()=>await kiss.session.initAccount()]},addHook(event,callback){if(["beforeInit","afterInit","beforeRestore","afterRestore"].includes(event))this.hooks[event].push(callback);return this},_processHook(event,sessionData){if(this.hooks[event].length!=0){this.hooks[event].forEach((hook=>{hook(sessionData)}))}},async switchAccount(accountId){if(kiss.context.ui==this.defaultViews.application){kiss.router.navigateTo({ui:this.defaultViews.home})}const data=await kiss.ajax.request({url:"/switchAccount",method:"post",showLoading:true,body:JSON.stringify({accountId:accountId})});if(!data)return;if(data.error)return data;if(typeof data==="object"){this._updateCurrentAccount(Object.assign(data,{accountId:accountId}))}window.location.reload()},async acceptInvitationOf(accountId){const response=await kiss.ajax.request({url:"/acceptInvitationOf",method:"post",showLoading:true,body:JSON.stringify({accountId:accountId})});if(response.error)return response;kiss.session.invitedBy.splice(kiss.session.invitedBy.indexOf(accountId),1);kiss.session.isCollaboratorOf.push(accountId);localStorage.setItem("session-invitedBy",JSON.stringify(kiss.session.invitedBy));localStorage.setItem("session-isCollaboratorOf",JSON.stringify(kiss.session.isCollaboratorOf));createNotification({message:txtTitleCase("invitation accepted")});return response},async rejectInvitationOf(accountId){const response=await kiss.ajax.request({url:"/rejectInvitationOf",method:"post",showLoading:true,body:JSON.stringify({accountId:accountId})});if(response&&response.error)return response;kiss.session.invitedBy.splice(kiss.session.invitedBy.indexOf(kiss.session.accountId),1);localStorage.setItem("session-invitedBy",JSON.stringify(kiss.session.invitedBy));return response},async quitAccount(accountId){const response=await kiss.ajax.request({url:"/quitAccount",method:"post",showLoading:true,body:JSON.stringify({accountId:accountId})});if(response.error)return response;const{currentAccountChanged:currentAccountChanged,currentAccountId:currentAccountId,token:token,refreshToken:refreshToken,expiresIn:expiresIn}=response;if(!currentAccountChanged)return response;this.isCollaboratorOf.splice(kiss.session.isCollaboratorOf.indexOf(accountId),1);localStorage.setItem("session.isCollaboratorOf",JSON.stringify(this.isCollaboratorOf));this._updateCurrentAccount({accountId:currentAccountId,refreshToken:refreshToken,token:token,expiresIn:expiresIn});kiss.router.navigateTo({ui:this.defaultViews.home})},_updateCurrentAccount({accountId:accountId,refreshToken:refreshToken,token:token,expiresIn:expiresIn}){const expirationDate=new Date;expirationDate.setSeconds(expirationDate.getSeconds()+expiresIn);localStorage.setItem("session-refresh-token",refreshToken);localStorage.setItem("session-token",token);localStorage.setItem("session-expiration",expirationDate);localStorage.setItem("session-currentAccountId",accountId)},setupDownloadLink(...links){links.filter((link=>!!link)).forEach((link=>{if(link.getAttribute("public"))return;link.addEventListener("click",(async e=>{const currentTarget=e.currentTarget;e.stopImmediatePropagation();if(e.isTrusted){e.preventDefault();const response=await fetch(currentTarget.href,{method:"head"});if(response.status===498){if(!await kiss.session.getNewToken()){log("kiss.session - setupDownloadLink - Unable to get a new token",1);return}}else if(response.status===401){log("kiss.session - setupDownloadLink - Unauthorized",1);return}link.dispatchEvent(new MouseEvent("click"))}}))}))},setupImg(...imgs){imgs.filter((img=>!!img)).forEach((img=>{if(img.getAttribute("public"))return;img.addEventListener("error",(async e=>{const currentTarget=e.currentTarget;let src=currentTarget.src;const response=await fetch(src,{method:"head"});if(response.status===401){kiss.session.showLogin();return}if(response.status!==498)return;if(await kiss.session.checkTokenValidity(true)){currentTarget.src="";currentTarget.src=src}else{kiss.session.showLogin()}}))}))},async init(sessionData){this.observeResources();if(!sessionData.token)return;await this._processHook("beforeInit",sessionData);sessionData.expirationDate=new Date;sessionData.expirationDate.setSeconds(sessionData.expirationDate.getSeconds()+sessionData.expiresIn);Object.assign(this,sessionData);localStorage.setItem("session-token",sessionData.token);localStorage.setItem("session-refresh-token",sessionData.refreshToken);localStorage.setItem("session-expiration",sessionData.expirationDate);localStorage.setItem("session-userId",sessionData.userId);localStorage.setItem("session-firstName",sessionData.firstName);localStorage.setItem("session-lastName",sessionData.lastName);localStorage.setItem("session-accountId",sessionData.accountId);localStorage.setItem("session-currentAccountId",sessionData.currentAccountId);localStorage.setItem("session-isCollaboratorOf",JSON.stringify(sessionData.isCollaboratorOf));localStorage.setItem("session-invitedBy",JSON.stringify(sessionData.invitedBy));localStorage.setItem("session-isOwner",this.isAccountOwner());localStorage.setItem("session-ws.port",sessionData.ws.port);localStorage.setItem("session-ws.sslPort",sessionData.ws.sslPort);this.initAccountOwner();this.initAccountManagers();await kiss.websocket.init({port:this.getWebsocketPort(),sslPort:this.getWebsocketSSLPort()}).then((()=>{log("kiss.session - restore - Websocket connected")})).catch((err=>{log("kiss.session - restore - Websocket error: ",4,err)}));this.observeWebsocket();this.observeCollaborations();this.initIdleTracker();await this._processHook("afterInit",sessionData)},async restore(){if(kiss.session.isOffline()){this.initAccountOwner();await this._processHook("afterRestore");return true}this.token=this.getToken();if(!this.token)return;await this._processHook("beforeRestore");this.refreshToken=this.getRefreshToken();this.expirationDate=this.getExpiration();this.userId=this.getUserId();this.firstName=this.getFirstName();this.lastName=this.getLastName();this.accountId=this.getAccountId();this.currentAccountId=this.getCurrentAccountId();this.isCollaboratorOf=this.getCollaborators();this.invitedBy=this.getInvitations();this.isOwner=this.isAccountOwner();this.ws={port:this.getWebsocketPort(),sslPort:this.getWebsocketSSLPort()};this.initAccountOwner();this.initAccountManagers();await kiss.websocket.init({port:this.ws.port,sslPort:this.ws.sslPort}).then((()=>{log("kiss.session - restore - Websocket connected")})).catch((err=>{log("kiss.session - restore - Websocket error:",4,err)}));this.lastActivity=this.getLastActivity();kiss.session.initIdleTracker();await this._processHook("afterRestore")},reset(){const propertiesToReset=["token","refreshToken","accountId","currentAccountId","userId","isOwner","firstName","lastName","lastActivity","expirationDate"];propertiesToReset.forEach((prop=>delete this[prop]));localStorage.removeItem("session-token");localStorage.removeItem("session-refresh-token");localStorage.removeItem("session-expiration");localStorage.removeItem("session-userId");localStorage.removeItem("session-firstName");localStorage.removeItem("session-lastName");localStorage.removeItem("session-lastActivity");localStorage.removeItem("session-accountId");localStorage.removeItem("session-currentAccountId");localStorage.removeItem("session-isCollaboratorOf");localStorage.removeItem("session-invitedBy");localStorage.removeItem("session-isOwner");localStorage.removeItem("session-ws.port");localStorage.removeItem("session-ws.sslPort");if(kiss.websocket.connection.readyState!==WebSocket.CLOSED){kiss.websocket.close()}},initIdleTracker(){this.setMaxIdleTime(this.getMaxIdleTime());const reportActivity=()=>{this.lastActivity=new Date;localStorage.setItem("session-lastActivity",new Date)};if(!this.idleObserver){this.idleObserver=document.body.addEventListener("mousemove",kiss.tools.throttle(10*1e3,reportActivity))}setInterval((()=>{if(kiss.session.isIddle()){log("kiss.session - activity tracker - You were logged out because considered iddled",1);kiss.session.logout()}}),1e3*60)},isIddle(){if(new Date-this.getLastActivity()>this.maxIdleTime*1e3*60)return true;return false},getACL(){return kiss.directory.getUserACL(this.userId)},showLogin(redirectTo){if(redirectTo){kiss.context.redirectTo=redirectTo}else{kiss.context.redirectTo={ui:this.defaultViews.home}}kiss.router.navigateTo({ui:this.defaultViews.login})},async login(login){let data;if(!login.token){data=await kiss.ajax.request({url:"/login",method:"post",showLoading:true,body:JSON.stringify({username:login.username,password:login.password})})}else{data=await kiss.ajax.request({url:"/verifyToken",method:"post",body:JSON.stringify({token:login.token})})}if(!data||!data.token)return false;await kiss.session.init(data);const currentRoute=kiss.router.getRoute();if(kiss.context.acceptInvitationOf){await kiss.session.acceptInvitationOf(kiss.context.acceptInvitationOf)}if(currentRoute&&currentRoute.ui!=this.defaultViews.login){location.reload()}else{return true}},async checkTokenValidity(autoRenew=true){try{const resp=await fetch(kiss.session.host+"/checkTokenValidity",{headers:{authorization:"Bearer "+this.getToken()}});if(autoRenew&&resp.status===498)return await this.getNewToken();return resp.status===200}catch(err){log(err);return false}},async logout(){await kiss.ajax.request({url:kiss.session.host+"/logout",method:"get"});if(kiss.websocket.connection.readyState!==WebSocket.CLOSED){kiss.websocket.close()}kiss.session.reset();document.location.reload()},async getNewToken(){const newToken=await kiss.ajax.request({url:"/refreshToken",method:"post",body:JSON.stringify({refreshToken:kiss.session.getRefreshToken()})});if(newToken){await kiss.session.init(newToken);return newToken}else{kiss.websocket.close();kiss.tools.closeAllWindows(["login"]);return false}},observeResources(){if(this.resourcesObserver)return;this.resourcesObserver=new MutationObserver((mutations=>{for(let mutation of mutations){for(let addedNode of mutation.addedNodes){if(addedNode.tagName==="IMG"){kiss.session.setupImg(addedNode)}else if(addedNode.tagName==="A"&&addedNode.hasAttribute("download")){kiss.session.setupDownloadLink(addedNode)}else if(addedNode.querySelectorAll){kiss.session.setupImg(...addedNode.querySelectorAll("img"));kiss.session.setupDownloadLink(...addedNode.querySelectorAll("a[download]"))}}}}));this.resourcesObserver.observe(document.body,{childList:true,subtree:true})},observeWebsocket(){if(this.websocketObserver)return;kiss.pubsub.subscribe("EVT_DISCONNECTED",(()=>this.showWebsocketMessage("#websocket disconnected")));kiss.pubsub.subscribe("EVT_RECONNECTED",(()=>{log("kiss.session - observeWebsocket - Socket reconnected");this.hideWebsocketMessage()}));kiss.pubsub.subscribe("EVT_CONNECTION_LOST",(()=>this.showWebsocketMessage("#websocket connection lost")));kiss.pubsub.subscribe("EVT_UNUSABLE_TOKEN",(()=>{kiss.session.reset();window.location.reload()}));this.websocketObserver=true},observeCollaborations(){if(this.collaborationObserver)return;kiss.pubsub.subscribe("EVT_COLLABORATION:RECEIVED",(data=>{this.invitedBy.push(data.accountId);window.localStorage.setItem("session-invitedBy",JSON.stringify(this.invitedBy))}));kiss.pubsub.subscribe("EVT_COLLABORATION:DELETED",(data=>{this._updateCurrentAccount({accountId:this.getAccountId(),token:data.token,refreshToken:data.refreshToken,expiresIn:data.expiresIn});kiss.router.navigateTo({ui:this.defaultViews.home})}));this.collaborationObserver=true},showWebsocketMessage(message){if($("websocket-message"))$("websocket-message").remove();createBlock({id:"websocket-message",fullscreen:true,background:"transparent",items:[{type:"panel",maxWidth:()=>Math.min(kiss.screen.current.width/2,1e3),header:false,layout:"vertical",align:"center",verticalAlign:"center",alignItems:"center",justifyContent:"center",items:[{type:"html",padding:32,html:`<div style="font-size: 18px; text-align: center;">${txtTitleCase(message)}</div>`}]}]}).render()},hideWebsocketMessage(){if($("websocket-message"))$("websocket-message").remove()}};kiss.theme={currentColor:"",currentGeometry:"",init(){const localStorageTheme=kiss.theme.get();kiss.context.themeColor=kiss.theme.currentColor=kiss.router.getRoute().themeColor||localStorageTheme.color;kiss.context.themeGeometry=kiss.theme.currentGeometry=kiss.router.getRoute().themeGeometry||localStorageTheme.geometry;kiss.theme._load({color:kiss.context.themeColor,geometry:kiss.context.themeGeometry});kiss.theme._observe()},set({color:color,geometry:geometry}){color=color||kiss.theme.currentColor;geometry=geometry||kiss.theme.currentGeometry;localStorage.setItem("config-themeColor",color);localStorage.setItem("config-themeGeometry",geometry);kiss.theme._load({color:color,geometry:geometry});kiss.router.updateUrlHash({themeColor:color,themeGeometry:geometry})},resetSize(){document.documentElement.style.fontSize="62.5%";localStorage.setItem("config-themeSize",62.5)},updateSize(newSize){document.documentElement.style.fontSize=newSize+"%";localStorage.setItem("config-themeSize",newSize);if($("custom-size"))$("custom-size").setValue(newSize+37.5,true)},get(){kiss.theme.currentColor=localStorage.getItem("config-themeColor");if(!kiss.theme.currentColor)kiss.theme.currentColor="light";kiss.theme.currentGeometry=localStorage.getItem("config-themeGeometry");if(!kiss.theme.currentGeometry)kiss.theme.currentGeometry="default";return{color:kiss.theme.currentColor,geometry:kiss.theme.currentGeometry}},_load({color:color,geometry:geometry,size:size}){if(color){let colorHrefLink;if(kiss.global.absolutePath){colorHrefLink=kiss.global.absolutePath+"/kissjs/client/ui/styles/colors/"+color+".css"}else{if(kiss.app.name=="pickaform"){colorHrefLink="../../kissjs/client/ui/styles/colors/"+color+".css"}else{colorHrefLink="https://kissjs.net/resources/lib/kissjs/styles/colors/"+color+".css"}}if(color!="custom"){let colorThemeFound=false;document.documentElement.removeAttribute("style");document.querySelectorAll("link").forEach((link=>{if(link.href.indexOf("styles/colors")!=-1){colorThemeFound=true;link.href=colorHrefLink}}));if(!colorThemeFound){const newLink=document.createElement("link");newLink.rel="stylesheet";newLink.href=colorHrefLink;document.head.appendChild(newLink)}}else{let theme=localStorage.getItem("config-theme");if(!theme)return;theme=JSON.parse(theme);Object.keys(theme).forEach((variable=>{const color=theme[variable];document.documentElement.style.setProperty(variable,color)}))}}if(geometry){let geometryHrefLink;if(kiss.global.absolutePath){geometryHrefLink=kiss.global.absolutePath+"/kissjs/client/ui/styles/geometry/"+geometry+".css"}else{if(kiss.app.name=="pickaform"){geometryHrefLink="../../kissjs/client/ui/styles/geometry/"+geometry+".css"}else{geometryHrefLink="https://kissjs.net/resources/lib/kissjs/styles/geometry/"+geometry+".css"}}let geometryThemeFound=false;document.querySelectorAll("link").forEach((link=>{if(link.href.indexOf("styles/geometry")!=-1){geometryThemeFound=true;link.href=geometryHrefLink}}));if(!geometryThemeFound){const newLink=document.createElement("link");newLink.rel="stylesheet";newLink.href=geometryHrefLink;document.head.appendChild(newLink)}}if(size){if(size<50)size=50;document.documentElement.style.fontSize=size+"%";localStorage.setItem("config-themeSize",size)}else{const size=localStorage.getItem("config-themeSize");if(size){document.documentElement.style.fontSize=size+"%"}else{document.documentElement.style.fontSize="62.5%"}}kiss.theme.currentColor=color||"light";kiss.theme.currentGeometry=geometry||"default";kiss.theme.currentSize=size||62.5},_observe(){subscribe("EVT_ROUTE_UPDATED",(msgData=>{if(msgData.themeColor!=kiss.theme.currentColor||msgData.themeGeometry!=kiss.theme.currentGeometry){kiss.theme._load({color:msgData.themeColor,geometry:msgData.themeGeometry})}}))},select(){if($("theme-window"))return;const isMobile=kiss.screen.isMobile;let responsiveOptions;if(isMobile){responsiveOptions={top:()=>0,left:()=>0,width:"100%",height:"100%",borderRadius:"0 0 0 0",align:"center",draggable:false}}else{responsiveOptions={verticalAlign:"center",draggable:true,animation:{name:"slideInRight",speed:"faster"}}}const titleStyle={fontSize:"2rem",fontWeight:"bold",textAlign:"center",margin:"4rem 0 1.5rem 0"};const blockStyle={boxShadow:"var(--shadow-2)",margin:"1rem 0",borderRadius:"var(--panel-border-radius)"};const defaultConfig={type:"button",icon:"fas fa-palette",flex:1,height:"5rem",width:"calc(100% - 2rem)",margin:"1rem",iconSize:"2.4rem",fontSize:"1.6rem",textAlign:"left",boxShadow:"var(--shadow-1)",boxShadowHover:"var(--shadow-4)"};return createPanel({id:"theme-window",title:txtTitleCase("theme"),icon:"fas fa-sliders-h",draggable:true,closable:true,width:"30rem",left:()=>"calc(100% - 31rem)",maxHeight:()=>"calc(100% - 2rem)",padding:"1rem",overflowY:"auto",zIndex:1e3,...responsiveOptions,items:[{type:"html",...titleStyle,html:txtTitleCase("color")},{defaultConfig:defaultConfig,...blockStyle,items:[{text:txtTitleCase("light"),color:"#232730",iconColor:"#232730",backgroundColor:"#eeeeee",action:()=>kiss.theme.set({color:"light"})},{text:txtTitleCase("dark"),color:"#ffffff",iconColor:"#ffffff",backgroundColor:"#373a40",action:()=>kiss.theme.set({color:"dark"})},{text:txtTitleCase("pink"),color:"#ffffff",iconColor:"#ffffff",background:kiss.tools.CSSGradient("#ffa3a3",90,-.05),action:()=>kiss.theme.set({color:"pink"})},{text:txtTitleCase("purple"),color:"#ffffff",iconColor:"#ffffff",background:kiss.tools.CSSGradient("#aeabe8",90,-.05),action:()=>kiss.theme.set({color:"purple"})},{text:txtTitleCase("blue"),color:"#232730",iconColor:"#ffffff",background:kiss.tools.CSSGradient("#c7efff",90,-.05),action:()=>kiss.theme.set({color:"blue"})},{text:txtTitleCase("green"),color:"#232730",iconColor:"#ffffff",background:kiss.tools.CSSGradient("#b4e9b4",90,-.05),action:()=>kiss.theme.set({color:"green"})},{text:txtTitleCase("orange"),color:"#ffffff",iconColor:"#ffffff",background:kiss.tools.CSSGradient("#ffbe61",90,-.05),action:()=>kiss.theme.set({color:"orange"})},{text:txtTitleCase("minimal"),color:"#456789",iconColor:"#456789",background:kiss.tools.CSSGradient("#fafafa",90,-.05),action:()=>kiss.theme.set({color:"clean"})},{hidden:isMobile,text:txtTitleCase("custom"),color:"var(--body)",icon:"fas fa-user-cog",iconColor:"var(--body)",backgroundColor:"transparent",action:function(){kiss.theme.set({color:"custom"});$("theme-window").close();kiss.theme.createThemeBuilderWindow()}}]},{type:"html",...titleStyle,html:txtTitleCase("geometry")},{defaultConfig:defaultConfig,...blockStyle,items:[{text:txtTitleCase("default"),icon:"far fa-square",action:()=>kiss.theme.set({geometry:"default"})},{text:txtTitleCase("sharp"),icon:"far fa-gem",action:()=>kiss.theme.set({geometry:"sharp"})},{text:txtTitleCase("round"),icon:"far fa-circle",action:()=>kiss.theme.set({geometry:"round"})}]},{type:"html",...titleStyle,html:txtTitleCase("interface size")},{defaultConfig:defaultConfig,...blockStyle,textAlign:"center",items:[{text:txtTitleCase("compact"),icon:"fas fa-circle",iconSize:"1rem",action:()=>kiss.theme.updateSize(50)},{text:txtTitleCase("normal"),icon:"fas fa-circle",iconSize:"1.4rem",action:()=>kiss.theme.updateSize(62.5)},{text:txtTitleCase("tall"),icon:"fas fa-circle",iconSize:"1.8rem",action:()=>kiss.theme.updateSize(75)},{text:txtTitleCase("very tall"),icon:"fas fa-circle",iconSize:"2.2rem",action:()=>kiss.theme.updateSize(87.5)},{id:"custom-size",type:"slider",label:txtTitleCase("custom"),labelPosition:"top",min:75,max:150,step:.5,width:"95%",unit:"%",events:{change:function(){const newSize=this.getValue();kiss.theme.updateSize(newSize-37.5)}},methods:{load(){let size=localStorage.getItem("config-themeSize");if(size)size=parseFloat(size);if(size){this.setValue(size+37.5,true)}else{this.setValue(100,true)}}}}]}]}).render()},createThemeBuilderWindow(){const cssVariables=[txtTitleCase("body"),"--body","--body-alt","--body-background","--body-background-alt","--link",txtTitleCase("panels"),"--panel-background","--panel-header","--panel-border","--panel-box-shadow",txtTitleCase("fields"),"--field","--field-label","--field-background","--field-background-hover","--field-background-focus","--field-border","--field-border-hover",txtTitleCase("select fields"),"--select-option","--select-option-background","--select-option-background-selected","--select-option-highlight","--select-option-background-highlight","--select-option-box-shadow","--select-value-shadow",txtTitleCase("menus"),"--menu-background","--menu-item-background-hover","--menu-item-background-selected","--menu-item","--menu-item-hover","--menu-item-selected","--menu-border","--menu-separator","--menu-box-shadow",txtTitleCase("buttons"),"--button-background","--button-background-hover","--button-border","--button-border-hover","--button-text","--button-text-hover","--button-icon","--button-shadow","--button-shadow-hover",txtTitleCase("data components"),"--datacomponent-toolbar-background","--datacomponent-header-background","--datacomponent-body-background","--datacomponent-cell-background","--datacomponent-cell-border","--datacomponent-1st-column-background","--datacomponent-group-background","--datacomponent-alternate-border","--datacomponent-row-hover","--datacomponent-row-selected","--datacomponent-header","--datacomponent-1st-column","--datacomponent-cell","--datacomponent-group-text","--datacomponent-input-background","--datacomponent-interaction-hover","--datacomponent-header-background-hover",txtTitleCase("shadows"),"--shadow-1","--shadow-2","--shadow-3","--shadow-4"];const items=cssVariables.map((variable=>{if(variable.startsWith("--")){let variableValue=getComputedStyle(document.documentElement).getPropertyValue(variable);variableValue=variableValue.trim();const isColor=variableValue.startsWith("#")||variableValue.indexOf("linear-gradient")!=-1||variableValue=="inherit"||variableValue=="";return{id:variable,type:isColor?"color":"text",palette:"default",label:variable,labelPosition:"top",width:"100%",value:variableValue,events:{change:function(){const newColor=this.getValue();document.documentElement.style.setProperty(variable,newColor);$("theme-builder").save()}}}}else{return{type:"html",class:"theme-window-title",html:variable,margin:"2rem 0 1rem 0"}}}));const buttonsBlock={layout:"horizontal",backgroundColor:"var(--body-background-alt)",minHeight:"4rem",padding:"0.5rem",items:[{type:"button",tip:txtTitleCase("#download theme"),icon:"fas fa-download",width:"3.2rem",margin:"0 0.5rem 0 0",action:()=>{let theme=$("theme-builder").getData();theme=JSON.stringify(theme,null,4);theme=theme.replace("{",":root {");theme=theme.replaceAll('"',"");theme=theme.replaceAll(",\n",";\n");theme=theme.replace("\n}",";\n}");createDialog({type:"input",title:txtTitleCase("#theme name"),message:txtTitleCase("#theme name help"),autoClose:false,action:value=>{if(!value)return false;theme=`/* ${value.toUpperCase()} THEME PARAMETERS */\n`+theme+`\n/* /${value.toUpperCase()} THEME PARAMETERS */\n`;kiss.tools.downloadFile({title:txtTitleCase("CSS theme"),content:theme,filename:value+".css"});return true}})}},{type:"html",tip:txtTitleCase("#load theme"),class:"a-button",display:"flex",justifyContent:"center",width:"3.2rem",html:`\n                        <label for="themeFileInput"><i class="fas fa-file button-icon" style="cursor: pointer"></i></label>\n                        <input type="file" id="themeFileInput" accept=".css" style="display: none"/>\n                    `,methods:{load(){document.getElementById("themeFileInput").addEventListener("change",(function(event){const file=event.target.files[0];if(file){const reader=new FileReader;reader.onload=function(e){const content=e.target.result;let theme=content.split("{")[1].split("}")[0];theme=theme.replaceAll(";","");const themeObj={};theme.split("\n").forEach(((line,index)=>{if(line&&line.length>1){const[variable,value]=line.split(":");themeObj[variable.trim()]=value.trim()}}));Object.keys(themeObj).forEach((variable=>{const color=themeObj[variable];document.documentElement.style.setProperty(variable,color);const setupField=$(variable);if(setupField)setupField.setValue(color)}));$("theme-builder").save()};reader.readAsText(file)}}))}}}]};return createPanel({id:"theme-builder",title:txtTitleCase("#theme builder"),icon:"fas fa-sliders-h",draggable:true,closable:true,width:"30rem",left:()=>"calc(100% - 31rem)",maxHeight:()=>"calc(100% - 2rem)",align:"center",verticalAlign:"center",layout:"vertical",padding:0,zIndex:1e4,animation:{name:"slideInRight",speed:"faster"},items:[buttonsBlock,{layout:"vertical",overflowY:"auto",padding:"1rem",items:items}],methods:{save(){const theme=this.getData();localStorage.setItem("config-theme",JSON.stringify(theme))}}}).render()}};kiss.tools={$(id,parentNode){if(parentNode){return parentNode.querySelector("#"+id)}else{return document.getElementById(id)}},uid(){const UUID_UNIX_TS_MS_BITS=48;const UUID_VAR=2;const UUID_VAR_BITS=2;const UUID_RAND_B_BITS=62;if(!kiss.tools.prevTimestamp)kiss.tools.prevTimestamp=-1;const timestamp=Math.max(Date.now(),kiss.tools.prevTimestamp);const randA=crypto.getRandomValues(new Uint8Array(2));randA[0]=randA[0]&15|112;const randB=crypto.getRandomValues(new Uint32Array(2));randB[0]=UUID_VAR<<32-UUID_VAR_BITS|randB[0]>>>UUID_VAR_BITS;const rawV7=timestamp.toString(16).padStart(UUID_UNIX_TS_MS_BITS/4,"0")+randA[0].toString(16)+randA[1].toString(16).padStart(2,"0")+randB[0].toString(16).padStart((UUID_VAR_BITS+UUID_RAND_B_BITS)/8,"0")+randB[1].toString(16).padStart((UUID_VAR_BITS+UUID_RAND_B_BITS)/8,"0");return rawV7.slice(0,8)+"-"+rawV7.slice(8,12)+"-"+rawV7.slice(12,16)+"-"+rawV7.slice(16,20)+"-"+rawV7.slice(20)},getUrlParameter(name,url=window.location.href){name=name.replace(/[\[\]]/g,"\\$&");const regex=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)");const results=regex.exec(url);if(!results)return null;if(!results[2])return"";return decodeURIComponent(results[2].replace(/\+/g," "))},async copyTextToClipboard(text){await navigator.clipboard.writeText(text)},getThumbnail(file,thumbCode=null){if(thumbCode&&file.thumbnails&&thumbCode in file.thumbnails){return file.thumbnails[thumbCode]}return file},createFileURL(file,thumb=null){let{path:path,size:size}=thumb?kiss.tools.getThumbnail(file,thumb):file;path=path.replaceAll("\\","/");path=path.replace("eu-west-3.amazonaws.com","fr-par.scw.cloud");if(Array.isArray(file.accessReaders)&&file.accessReaders.includes("$authenticated")&&!file.accessReaders.includes("*")){return`/file?path=${encodeURIComponent(path)}&mimeType=${encodeURIComponent(file.mimeType)}&size=${size}`}else{return path.match(/^uploads\//)||path.match(/^file\//)?`/${path}`:path}},downloadFile(config){const blob=new Blob([config.content],{type:config.mimeType||"application/json"});const url=URL.createObjectURL(blob);const message=`<center>\n                        ${txtTitleCase("#click to download")}\n                        <a href="${url}" download="${config.filename||"file.json"}">\n                            ${txtTitleCase("download file")}\n                        </a>\n                    </center>`;createDialog({type:"message",title:config.title||"Download file",message:message,buttonOKText:txtTitleCase("validate"),noOK:true})},async waitForElement(selector){function rafAsync(){return new Promise((resolve=>{requestAnimationFrame(resolve)}))}let retry=0;while(document.querySelector(selector)===null&&retry<20){await rafAsync();retry++}return document.body.querySelector(selector)},waitUntil(conditionFn,checkInterval=50,timeout=5e3){return new Promise(((resolve,reject)=>{const start=new Date;(function check(){if(conditionFn())return resolve();if(new Date-start>=timeout)return reject(new Error("Timeout"));setTimeout(check,checkInterval)})()}))},isEventInElement(event,element,delta=0){const rect=element.getBoundingClientRect();const x=event.clientX;if(x<rect.left-delta||x>=rect.right+delta)return false;const y=event.clientY;if(y<rect.top-delta||y>=rect.bottom+delta)return false;return true},moveToViewport(element){const horizontalDiff=kiss.screen.current.width-(element.offsetLeft+element.clientWidth);const verticalDiff=kiss.screen.current.height-(element.offsetTop+element.clientHeight);if(horizontalDiff<0)element.style.left=Math.max(10,element.offsetLeft+horizontalDiff-10)+"px";if(verticalDiff<0)element.style.top=Math.max(10,element.offsetTop+verticalDiff-10)+"px";return element},mergeTags(text,context){const record=context.record;if(!text)return text;if(!record)return text;const tags=kiss.tools.findTags(text);tags.forEach((tag=>{Object.keys(context).forEach((key=>{if(tag==key){const contextValue=context[key];if(typeof contextValue=="string")text=text.replaceAll(`{{${tag}}}`,contextValue)}}));const value=record.get(tag)||"";text=text.replaceAll(`{{${tag}}}`,value)}));return text},closeAllWindows(exceptions=[]){Array.from(document.querySelectorAll(".a-panel")).filter((panel=>!exceptions.includes(panel.id))).forEach((panel=>panel.close(true)));document.querySelectorAll(".a-menu").forEach((panel=>panel.close(true)))},benchmark(numberOfFields,fieldType,targetDomElementId){kiss.tools.timer.start();const setConfig=function(i){return{id:"cmp-"+i,type:fieldType||"text",target:targetDomElementId||null,display:"inline-block",placeholder:"Enter a value... ("+i.toString()+")",label:"Label nr "+i.toString()+" : ",labelPosition:"top",height:"3.2rem",width:"20rem",margin:"1rem",labelWidth:"20rem",events:{onchange:function(event){publish("EVT_BENCH_UPDATE_FIELD",{fieldId:this.id,value:event.target.value})}},subscriptions:{EVT_BENCH_UPDATE_FIELD:function(msgData){if(msgData.fieldId!="cmp-"+i)$("cmp-"+i).setValue(msgData.value)}}}};for(let i=0;i<numberOfFields;i++){createField(setConfig(i)).render()}kiss.tools.timer.show("Components built!")},treeify(list,idAttr="id",parentAttr="parent",childrenAttr="children"){let treeList=[];let lookup={};list.forEach((function(obj){lookup[obj[idAttr]]=obj;obj[childrenAttr]=[]}));list.forEach((function(obj){if(obj[parentAttr]!=null&&obj[parentAttr]!=""){lookup[obj[parentAttr]][childrenAttr].push(obj)}else{treeList.push(obj)}}));return treeList},adjustColor(hex,lum){hex=String(hex).replace(/[^0-9a-f]/gi,"");if(hex.length<6){hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]}lum=lum||0;let rgb="#",c,i;for(let i=0;i<3;i++){c=parseInt(hex.substring(i*2,i*2+2),16);c=Math.round(Math.min(Math.max(0,c+c*lum),255)).toString(16);rgb+=("00"+c).substring(c.length)}return rgb},CSSGradient(hexColor,angle=90,lum=-.2){const secondaryColor=kiss.tools.adjustColor(hexColor,lum);return`linear-gradient(${angle}deg, ${hexColor} 0%, ${secondaryColor}  100%)`},getRandomColor(fromColorIndex=0,toColorIndex){const randomIndex=fromColorIndex+Math.round(Math.random()*(toColorIndex-fromColorIndex||kiss.global.palette.length));return"#"+kiss.global.palette[randomIndex]},getIconByType(type){let item=kiss.global.fieldTypes.find((item=>item.value===type));if(!item)item=kiss.global.elementTypes.find((item=>item.value===type));if(item)return item.icon||"";return""},fileToIcon(fileType){const associations=[{extensions:["jpg","jpeg","jfif","png","gif","webp","psd"],icon:"fas fa-file",color:"#000000"},{extensions:["doc","docx","odt"],icon:"fas fa-file-word",color:"#00aaee"},{extensions:["csv","xls","xlsx","ods"],icon:"fas fa-file-excel",color:"#09c60B"},{extensions:["ppt","pptx","odp"],icon:"fas fa-file-powerpoint",color:"#ba6044"},{extensions:["pdf"],icon:"fas fa-file-pdf",color:"#dd0000"},{extensions:["html","css","js","jsx"],icon:"fas fa-file-code",color:"#5fabbb"}];for(let association of associations){if(association.extensions.indexOf(fileType)!=-1)return{icon:association.icon,color:association.color}}return{icon:"fas fa-file-alt",color:"#556677"}},snapshot(object){let snapshot={};Object.keys(object).forEach((key=>{const type=typeof object[key];const safeKey=key.startsWith("$")?key.substring(1):key;if(type=="string"||type=="number"||type=="boolean"||Array.isArray(object[key]))snapshot[safeKey]=object[key]}));return snapshot},timer:{time:new Date,current:0,start(msg){kiss.tools.timer.time=performance.now();if(msg)console.log(msg)},show(msg){setTimeout((function(){kiss.tools.timer.current=performance.now()-kiss.tools.timer.time;console.log(`${msg||""} - ${kiss.tools.timer.current+" ms"}`)}),0)}},async getGeolocationFromIP(){const response=await fetch("https://ipapi.co/json/");if(!response.ok){throw new Error("Impossible to get the geolocation from the IP address")}const data=await response.json();return{latitude:data.latitude,longitude:data.longitude}},async getGeolocationFromAddress(address){const url=`https://nominatim.openstreetmap.org/search?q=${address}&format=json`;const response=await fetch(url);const data=await response.json();return data[0]?{latitude:data[0].lat,longitude:data[0].lon}:false},async getGeolocation(){return new Promise((async(resolve,reject)=>{if(navigator.geolocation){navigator.geolocation.getCurrentPosition((position=>{const latitude=position.coords.latitude;const longitude=position.coords.longitude;resolve({latitude:latitude,longitude:longitude})}),(error=>{kiss.tools.getGeolocationFromIP().then((geolocation=>{resolve(geolocation)})).catch((error=>{reject(error)}))}))}else{kiss.tools.getGeolocationFromIP().then((geolocation=>{resolve(geolocation)})).catch((error=>{reject(error)}))}}))},isGeolocation(input){input=input.trim();const parts=input.split(",");if(parts.length!==2){return false}const latitude=parseFloat(parts[0]);const longitude=parseFloat(parts[1]);if(isNaN(latitude)||isNaN(longitude)){return false}if(latitude<-90||latitude>90){return false}if(longitude<-180||longitude>180){return false}return{latitude:latitude,longitude:longitude}},isMobile(){const agent=navigator.userAgent;const mobiles=["Android","iPhone","Windows Phone","iPod"];for(let mobile of mobiles){if(agent.indexOf(mobile)!==-1){return true}}return false},remToPx(number){const oneRemInPixels=parseFloat(getComputedStyle(document.documentElement).fontSize);return number*oneRemInPixels},pxToRem(number){const oneRemInPixels=parseFloat(getComputedStyle(document.documentElement).fontSize);return number/oneRemInPixels},debugDOM(state){[].forEach.call($$("*"),(function(a){a.style.outline=`${state?"1":"0"}px solid #`+(~~(Math.random()*(1<<24))).toString(16)}))},highlight({element:element,text:text,position:position}){const elementRect=element.getBoundingClientRect();const overlay=document.createElement("div");overlay.style.position="fixed";overlay.style.top=0;overlay.style.left=0;overlay.style.width="100vw";overlay.style.height="100vh";overlay.style.zIndex=9999;const rects=[{top:0,left:0,width:"100vw",height:elementRect.top+"px"},{top:elementRect.top+"px",left:0,width:elementRect.left+"px",height:elementRect.height+"px"},{top:elementRect.top+"px",left:elementRect.right+"px",width:"calc(100vw - "+elementRect.right+"px)",height:elementRect.height+"px"},{top:elementRect.bottom+"px",left:0,width:"100vw",height:"calc(100vh - "+elementRect.bottom+"px)"}];position=position||"bottom";rects.forEach(((rect,index)=>{const div=document.createElement("div");div.style.top=rect.top;div.style.left=rect.left;div.style.width=rect.width;div.style.height=rect.height;div.classList.add("highlight-overlay");if(index===3){const arrow=document.createElement("div");const label=document.createElement("div");arrow.classList.add("highlight-arrow");label.classList.add("highlight-label");switch(position){case"top":arrow.style.top=elementRect.top-kiss.tools.remToPx(3.5)+"px";arrow.style.left=elementRect.left+elementRect.width/2-15+"px";arrow.style.animation="highlight-arrow-vertical 0.3s ease-in-out infinite alternate";arrow.style.borderLeft="1.5rem solid transparent";arrow.style.borderRight="1.5rem solid transparent";arrow.style.borderTop="1.5rem solid #ffffff";div.appendChild(arrow);label.style.left=elementRect.left+elementRect.width/2-kiss.tools.remToPx(15)+"px";label.innerHTML=text;div.appendChild(label);setTimeout((()=>{label.style.top=elementRect.top-kiss.tools.remToPx(5)-label.getBoundingClientRect().height+"px"}),0);break;case"bottom":arrow.style.top=elementRect.top+elementRect.height+kiss.tools.remToPx(2)+"px";arrow.style.left=elementRect.left+elementRect.width/2-15+"px";arrow.style.animation="highlight-arrow-vertical 0.3s ease-in-out infinite alternate";arrow.style.borderLeft="1.5rem solid transparent";arrow.style.borderRight="1.5rem solid transparent";arrow.style.borderBottom="1.5rem solid #ffffff";div.appendChild(arrow);label.style.top=elementRect.top+elementRect.height+kiss.tools.remToPx(5)+"px";label.style.left=elementRect.left+elementRect.width/2-kiss.tools.remToPx(15)+"px";label.innerHTML=text;div.appendChild(label);break;case"left":arrow.style.top=elementRect.top+"px";arrow.style.left=elementRect.left-kiss.tools.remToPx(3)+"px";arrow.style.animation=`highlight-arrow-horizontal 0.3s ease-in-out infinite alternate`;arrow.style.borderTop="1.5rem solid transparent";arrow.style.borderBottom="1.5rem solid transparent";arrow.style.borderLeft="1.5rem solid #ffffff";div.appendChild(arrow);label.style.top=elementRect.top+"px";label.innerHTML=text;div.appendChild(label);setTimeout((()=>{label.style.left=elementRect.left-kiss.tools.remToPx(5)-label.getBoundingClientRect().width+"px"}),0);break;case"right":arrow.style.top=elementRect.top+"px";arrow.style.left=elementRect.left+elementRect.width+kiss.tools.remToPx(1.5)+"px";arrow.style.animation=`highlight-arrow-horizontal 0.3s ease-in-out infinite alternate`;arrow.style.borderTop="1.5rem solid transparent";arrow.style.borderBottom="1.5rem solid transparent";arrow.style.borderRight="1.5rem solid #ffffff";div.appendChild(arrow);label.style.top=elementRect.top+"px";label.innerHTML=text;div.appendChild(label);setTimeout((()=>{label.style.left=elementRect.left+elementRect.width+kiss.tools.remToPx(5)+"px"}),0);break}}overlay.appendChild(div)}));document.body.appendChild(overlay);const subscriptionId=kiss.pubsub.subscribe("EVT_CONTAINERS_RESIZED",(()=>{overlay.remove();kiss.pubsub.unsubscribe(subscriptionId)}));overlay.onclick=()=>{overlay.remove();kiss.pubsub.unsubscribe(subscriptionId);kiss.pubsub.publish("EVT_NEXT_TIP")}},highlightElements(elements,callback){const tip=elements.shift();kiss.tools.highlight({element:tip.element,text:tip.text.replaceAll("\n","<br>"),position:tip.position});const subscriptionId=kiss.pubsub.subscribe("EVT_NEXT_TIP",(()=>{if(elements.length==0){kiss.pubsub.unsubscribe(subscriptionId);if(callback)callback()}else{const tip=elements.shift();kiss.tools.highlight({element:tip.element,text:tip.text,position:tip.position})}}))},animateElement(id,animation,delay){return setInterval((()=>{const element=$(id);if(!element)return;element.setAnimation(animation)}),delay)},featureNotAvailable(title,message){if(!title)title=kiss.global.mode=="demo"?"demo":"offline";if(!message)message=kiss.global.mode=="demo"?"#not available in demo":"#not available offline";createDialog({title:txtTitleCase(title),message:txtTitleCase(message),icon:"fas fa-exclamation-triangle",noCancel:true})},showFormulae(){const formulae=Object.keys(kiss.formula).filter((formula=>formula.includes("HELP"))).map((key=>kiss.formula[key])).join("\n\n");createPanel({modal:true,closable:true,width:()=>kiss.screen.current.width-20,height:()=>kiss.screen.current.height-20,align:"center",verticalAlign:"center",layout:"vertical",items:[{id:"formulae",type:"textarea",width:"100%",fieldWidth:"100%",height:"100%",value:formulae},{type:"button",text:"Copy to clipboard",action:()=>{kiss.tools.copyTextToClipboard($("formulae").getValue());createNotification("Copied to clipboard")}}]}).render()},printDiv(id){const content=$(id);const printWindow=window.open("","_blank","width=800,height=600");printWindow.document.open();printWindow.document.write(`\n          <!DOCTYPE html>\n          <html>\n          <head>\n            <title>Print Dashboard</title>\n            <style>\n              @media print {\n                body {\n                  margin: 0;\n                  padding: 0;\n                }\n                canvas {\n                  max-width: 100%;\n                  height: auto;\n                }\n              }\n            </style>\n          </head>\n          <body>\n            ${content.outerHTML}\n          </body>\n          </html>\n        `);printWindow.document.close();printWindow.onload=()=>{printWindow.print();printWindow.close()}},startSpeechRecognition(targetFieldId){if(!$(targetFieldId)){log.err("The target field is not available");return}const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SpeechRecognition){return createNotification(txtTitleCase("#recognition not available"))}const recognition=new SpeechRecognition;recognition.lang=kiss.language.current;recognition.interimResults=false;recognition.maxAlternatives=1;recognition.start();if($("recording-indicator")){$("recording-indicator").show()}else{createPanel({id:"recording-indicator",position:"absolute",layout:"vertical",alignItems:"center",justifyContent:"center",align:"center",verticalAlign:"center",width:"20rem",height:"20rem",borderRadius:"100%",header:false,background:"var(--body)",animation:{name:"pulse",speed:"fast",repeat:"infinite"},items:[{type:"html",color:"var(--body-background)",fontSize:"1.5rem",fontWeight:"bold",html:txtTitleCase("#recognition speak")}]}).render()}recognition.onresult=event=>{const transcript=event.results[0][0].transcript;const targetField=$(targetFieldId);const currentValue=targetField.getValue();const newValue=currentValue?`${currentValue}\n${transcript}`:transcript;targetField.setValue(newValue)};recognition.onerror=event=>{createNotification(txtTitleCase("#recognition error"));log.err(event.error)};recognition.onend=()=>{$("recording-indicator").hide()}}};const{$:$,uid:uid}=kiss.tools;kiss.undoRedo={log:{undo:[],redo:[]},init(config={}){if(config.undo)kiss.undoRedo.undo=config.undo;if(config.redo)kiss.undoRedo.redo=config.redo;const currentOperations=kiss.undoRedo.getOperations();if(currentOperations.length>0){kiss.undoRedo.log.undo=currentOperations}document.addEventListener("keydown",(async function(e){e.preventDefault;if(e.keyCode===89&&e.ctrlKey){if(!kiss.undoRedo.log.redo.length>0){createNotification(txtTitleCase("nothing to redo"));return}if(!kiss.undoRedo.redo)return;await kiss.undoRedo.redo()}else if(e.keyCode===90&&e.ctrlKey){if(!kiss.undoRedo.log.undo.length>0){createNotification(txtTitleCase("nothing to undo"));return}if(!kiss.undoRedo.undo)return;await kiss.undoRedo.undo()}}))},addOperation(operation){kiss.undoRedo.log.undo.push(operation);try{localStorage.setItem("session-undoRedo",JSON.stringify(kiss.undoRedo.log.undo))}catch(err){kiss.undoRedo.log.undo=kiss.undoRedo.log.undo.slice(0,-10);localStorage.setItem("session-undoRedo",JSON.stringify(kiss.undoRedo.log.undo))}},getOperations(order="asc"){const operationsAsString=localStorage.getItem("session-undoRedo");if(!operationsAsString)return[];const operations=JSON.parse(operationsAsString);if(order==="asc")return operations;return operations.reverse()},undoOperation(operation){const index=kiss.undoRedo.log.undo.findIndex((update=>update.id===operation.id));if(index!==-1){kiss.undoRedo.log.undo.splice(index,1);kiss.undoRedo.log.redo.push(operation);try{localStorage.setItem("session-undoRedo",JSON.stringify(kiss.undoRedo.log.undo))}catch(err){}}},redoOperation(operation){const index=kiss.undoRedo.log.redo.findIndex((update=>update.id===operation.id));if(index!==-1){kiss.undoRedo.log.redo.splice(index,1);kiss.undoRedo.log.undo.push(operation);try{localStorage.setItem("session-undoRedo",JSON.stringify(kiss.undoRedo.log.undo))}catch(err){}}},reset(){kiss.undoRedo.log.undo=[];kiss.undoRedo.log.redo=[];localStorage.removeItem("session-undoRedo")}};kiss.views={views:{},viewRenderers:{},viewControllers:{},viewMetas:{},cachedNodes:{},addView({id:id,renderer:renderer,meta:meta}){if(!id||!renderer){log(`kiss.views - You're trying to define the view <${id}>, but it's not properly setup: a view needs an id and a renderer.`,3);return}this.viewRenderers[id]=renderer;if(meta)this.viewMetas[id]=meta},addViewController(id,controller){this.viewControllers[id]=controller},buildView(id,target){if(kiss.screen.isMobile&&this.viewRenderers["mobile-"+id]){id="mobile-"+id}if(!this.views[id]){try{log(`kiss.views - buildView - Building view ${id}`);const viewRenderer=this.viewRenderers[id];if(!viewRenderer){log(`kiss.views - You're trying to build the view <${id}>, but it hasn't been defined.`,3);return null}const view=this.views[id]=viewRenderer(id,target);view.isView=true;if(!view.isComponent){const viewControllers=kiss.views.viewControllers[id];if(viewControllers)for(let method in viewControllers)view[method]=viewControllers[method]}if(this.viewMetas[id])this._insertMeta(id)}catch(err){log(`kiss.views - buildView - The view ${id} couldn't be built`,4,err)}}if(target)this.views[id].target=target;return this.views[id]},get(id){return this.views[id]},remove(id){if(this.views[id])delete this.views[id];let node=$(id);if(node)node.deepDelete()},reset(viewId,target,exclusive){const view=kiss.views.get(viewId);kiss.views.remove(viewId);kiss.views.show(viewId,view.target,view.exclusive)},show(id,target,exclusive){const view=this.buildView(id);if(view&&(!view.isConnected||view.hidden)){view.render(target);if(exclusive){Object.keys(this.views).forEach((function(viewId){if(viewId==view.id)return;const otherView=kiss.views.views[viewId];if(otherView.parentNode==view.parentNode&&viewId!="topbar")kiss.views.removeAndCacheNode(viewId)}))}if(target!=undefined)view.target=target;view.exclusive=!!exclusive}if(view&&view.hidden)view.show();if(this.viewMetas[id])this._insertMeta(id);return view},_insertMeta(id){const meta=this.viewMetas[id];Object.keys(meta).forEach((name=>{switch(name){case"title":document.title=this._getMetaData(meta,"title");this._injectMetaTag("name","twitter:title",meta,name);this._injectMetaTag("property","og:title",meta,name);break;case"description":this._injectMetaTag("name","description",meta,name);this._injectMetaTag("name","twitter:description",meta,name);this._injectMetaTag("property","og:description",meta,name);break;case"author":this._injectMetaTag("name","author",meta,name);this._injectMetaTag("name","twitter:creator",meta,name);this._injectMetaTag("property","og:article:author",meta,name);break;case"type":this._injectMetaTag("property","og:type",meta,name);break;case"site_name":this._injectMetaTag("property","og:site_name",meta,name);break;case"image":this._injectMetaTag("name","twitter:image",meta,name);this._injectMetaTag("property","og:image",meta,name);break;case"audio":this._injectMetaTag("property","og:audio",meta,name);break;case"video":this._injectMetaTag("property","og:video",meta,name);break;case"url":this._injectMetaTag("name","twitter:url",meta,name);this._injectMetaTag("property","og:url",meta,name);this._injectLanguageLinks(meta);break;case"locale":this._injectMetaTag("property","og:locale",meta,name);break;default:this._injectMetaTag("name",name,meta,name)}}))},_injectLanguageLinks(meta){const url=meta.url;if(typeof url=="string"){let language=kiss.language.current||"en";this._injectLinkRel("canonical",language,url)}else{Object.keys(url).forEach(((language,index)=>{if(index==0){this._injectLinkRel("canonical",language,url[language])}else{this._injectLinkRel("alternate",language,url[language])}}))}},_injectLinkRel(type,language,url){let linkTag;if(type=="canonical"){linkTag=document.querySelector('link[rel="canonical"]')}else if(type=="alternate"){linkTag=document.querySelector('link[rel="alternate"][hreflang="'+language+'"')}if(linkTag){linkTag.setAttribute("href",url)}else{linkTag=document.createElement("link");linkTag.setAttribute("rel",type);if(type=="alternate")linkTag.setAttribute("hreflang",language);linkTag.setAttribute("href",url);document.head.appendChild(linkTag)}},_injectMetaTag(propertyType,propertyName,meta,name){let metaTag=document.querySelector("meta["+propertyType+'="'+propertyName+'"]');let value=this._getMetaData(meta,name);if(metaTag){metaTag.setAttribute("content",value)}else{metaTag=document.createElement("meta");metaTag.setAttribute(propertyType,propertyName);metaTag.setAttribute("content",value);document.head.appendChild(metaTag)}},_getMetaData(meta,name){if(typeof meta[name]=="string"){return meta[name]}else{return meta[name][kiss.language.current]}},replaceBy(id,target){return this.show(id,target,true)},removeAndCacheNode(id){log("kiss.views - Pushed node into cache: "+id);let node=$(id);this.cachedNodes[id]={parentId:node.parentNode.id,index:Array.from(node.parentNode.children).indexOf(node),node:node.parentElement.removeChild(node)};return node},restoreCachedNode(id){log("kiss.views - Restored node from cache: "+id);let cachedNode=this.cachedNodes[id];let parentNode=cachedNode.parentId?$(cachedNode.parentId):document.body;parentNode.insertBefore(cachedNode.node,parentNode.children[cachedNode.index]);return cachedNode.node},getCachedNode(id){let cachedNode=this.cachedNodes[id];if(cachedNode){return cachedNode.node}else{return null}},deleteCachedNode(id){log("kiss.views - Deleted node from cache: "+id);delete this.cachedNodes[id]}};kiss.webfonts={check:icon=>kiss.webfonts.all.includes(icon),get(icon){if(!kiss.webfonts.check(icon)){return"fas fa-th"}return icon},all:["fab fa-buromobelexperte","fas fa-burn","fas fa-bullseye","fas fa-bullhorn","fas fa-building","far fa-building","fas fa-bug","fab fa-btc","fas fa-briefcase-medical","fas fa-briefcase","fas fa-braille","fas fa-boxes","fas fa-box-open","fas fa-box","fas fa-bowling-ball","fas fa-bookmark","far fa-bookmark","fas fa-book","fas fa-bomb","fas fa-bolt","fas fa-bold","fab fa-bluetooth-b","fab fa-bluetooth","fab fa-blogger-b","fab fa-blogger","fas fa-blind","fab fa-blackberry","fab fa-black-tie","fab fa-bity","fab fa-bitcoin","fab fa-bitbucket","fas fa-birthday-cake","fas fa-binoculars","fab fa-bimobject","fas fa-bicycle","fas fa-bell-slash","far fa-bell-slash","fas fa-bell","far fa-bell","fab fa-behance-square","fab fa-behance","fas fa-beer","fas fa-bed","fas fa-battery-three-quarters","fas fa-battery-quarter","fas fa-battery-half","fas fa-battery-full","fas fa-battery-empty","fas fa-bath","fas fa-basketball-ball","fas fa-baseball-ball","fas fa-bars","fas fa-barcode","fab fa-bandcamp","fas fa-band-aid","fas fa-ban","fas fa-balance-scale","fas fa-backward","fab fa-aws","fab fa-aviato","fab fa-avianex","fab fa-autoprefixer","fas fa-audio-description","fab fa-audible","fas fa-at","fab fa-asymmetrik","fas fa-asterisk","fas fa-assistive-listening-systems","fas fa-arrows-alt-v","fas fa-arrows-alt-h","fas fa-arrows-alt","fas fa-arrow-up","fas fa-arrow-right","fas fa-arrow-left","fas fa-arrow-down","fas fa-arrow-circle-up","fas fa-arrow-circle-right","fas fa-arrow-circle-left","fas fa-arrow-circle-down","fas fa-arrow-alt-circle-up","far fa-arrow-alt-circle-up","fas fa-arrow-alt-circle-right","far fa-arrow-alt-circle-right","fas fa-arrow-alt-circle-left","far fa-arrow-alt-circle-left","fas fa-arrow-alt-circle-down","far fa-arrow-alt-circle-down","fas fa-archive","fab fa-apple-pay","fab fa-apple","fab fa-apper","fab fa-app-store-ios","fab fa-app-store","fab fa-angular","fab fa-angrycreative","fas fa-angle-up","fas fa-angle-right","fas fa-angle-left","fas fa-angle-down","fas fa-angle-double-up","fas fa-angle-double-right","fas fa-angle-double-left","fas fa-angle-double-down","fab fa-angellist","fab fa-android","fas fa-anchor","fab fa-amilia","fas fa-american-sign-language-interpreting","fas fa-ambulance","fab fa-amazon-pay","fab fa-amazon","fas fa-allergies","fas fa-align-right","fas fa-align-left","fas fa-align-justify","fas fa-align-center","fab fa-algolia","fab fa-affiliatetheme","fab fa-adversal","fab fa-adn","fas fa-adjust","fas fa-address-card","far fa-address-card","fas fa-address-book","far fa-address-book","fab fa-accusoft","fab fa-accessible-icon","fab fa-500px","fab fa-youtube-square","fab fa-youtube","fab fa-yoast","fas fa-yen-sign","fab fa-yelp","fab fa-yandex-international","fab fa-yandex","fab fa-yahoo","fab fa-y-combinator","fab fa-xing-square","fab fa-xing","fab fa-xbox","fas fa-x-ray","fas fa-wrench","fab fa-wpforms","fab fa-wpexplorer","fab fa-wpbeginner","fab fa-wordpress-simple","fab fa-wordpress","fas fa-won-sign","fab fa-wolf-pack-battalion","fas fa-wine-glass","fab fa-windows","fas fa-window-restore","far fa-window-restore","fas fa-window-minimize","far fa-window-minimize","fas fa-window-maximize","far fa-window-maximize","fas fa-window-close","far fa-window-close","fab fa-wikipedia-w","fas fa-wifi","fab fa-whmcs","fas fa-wheelchair","fab fa-whatsapp-square","fab fa-whatsapp","fab fa-weixin","fas fa-weight","fab fa-weibo","fas fa-warehouse","fab fa-vuejs","fas fa-volume-up","fas fa-volume-off","fas fa-volume-down","fas fa-volleyball-ball","fab fa-vnv","fab fa-vk","fab fa-vine","fab fa-vimeo-v","fab fa-vimeo-square","fab fa-vimeo","fas fa-video-slash","fas fa-video","fab fa-viber","fas fa-vials","fas fa-vial","fab fa-viadeo-square","fab fa-viadeo","fab fa-viacoin","fas fa-venus-mars","fas fa-venus-double","fas fa-venus","fab fa-vaadin","fas fa-utensils","fas fa-utensil-spoon","fab fa-ussunnah","fas fa-users-cog","fas fa-users","fas fa-user-times","fas fa-user-tie","fas fa-user-tag","fas fa-user-slash","fas fa-user-shield","fas fa-user-secret","fas fa-user-plus","fas fa-user-ninja","fas fa-user-minus","fas fa-user-md","fas fa-user-lock","fas fa-user-graduate","fas fa-user-friends","fas fa-user-edit","fas fa-user-cog","fas fa-user-clock","fas fa-user-circle","far fa-user-circle","fas fa-user-check","fas fa-user-astronaut","fas fa-user-alt-slash","fas fa-user-alt","fas fa-user","far fa-user","fab fa-usb","fas fa-upload","fab fa-untappd","fas fa-unlock-alt","fas fa-unlock","fas fa-unlink","fas fa-university","fas fa-universal-access","fab fa-uniregistry","fas fa-undo-alt","fas fa-undo","fas fa-underline","fas fa-umbrella","fab fa-uikit","fab fa-uber","fab fa-typo3","fab fa-twitter-square","fab fa-twitter","fab fa-twitch","fas fa-tv","fab fa-tumblr-square","fab fa-tumblr","fas fa-tty","fas fa-truck-moving","fas fa-truck-loading","fas fa-truck","fas fa-trophy","fab fa-tripadvisor","fab fa-trello","fas fa-tree","fas fa-trash-alt","far fa-trash-alt","fas fa-trash","fas fa-transgender-alt","fas fa-transgender","fas fa-train","fas fa-trademark","fab fa-trade-federation","fas fa-toggle-on","fas fa-toggle-off","fas fa-tint","fas fa-times-circle","far fa-times-circle","fas fa-times","fas fa-ticket-alt","fas fa-thumbtack","fas fa-thumbs-up","far fa-thumbs-up","fas fa-thumbs-down","far fa-thumbs-down","fas fa-thermometer-three-quarters","fas fa-thermometer-quarter","fas fa-thermometer-half","fas fa-thermometer-full","fas fa-thermometer-empty","fas fa-thermometer","fab fa-themeisle","fas fa-th-list","fas fa-th-large","fas fa-th","fas fa-text-width","fas fa-text-height","fas fa-terminal","fab fa-tencent-weibo","fab fa-telegram-plane","fab fa-telegram","fab fa-teamspeak","fas fa-taxi","fas fa-tasks","fas fa-tape","fas fa-tags","fas fa-tag","fas fa-tachometer-alt","fas fa-tablets","fas fa-tablet-alt","fas fa-tablet","fas fa-table-tennis","fas fa-table","fas fa-syringe","fas fa-sync-alt","fas fa-sync","fab fa-supple","fas fa-superscript","fab fa-superpowers","fas fa-sun","far fa-sun","fas fa-suitcase","fas fa-subway","fas fa-subscript","fab fa-stumbleupon-circle","fab fa-stumbleupon","fab fa-studiovinari","fab fa-stripe-s","fab fa-stripe","fas fa-strikethrough","fas fa-street-view","fab fa-strava","fas fa-stopwatch","fas fa-stop-circle","far fa-stop-circle","fas fa-stop","fas fa-sticky-note","far fa-sticky-note","fab fa-sticker-mule","fas fa-stethoscope","fas fa-step-forward","fas fa-step-backward","fab fa-steam-symbol","fab fa-steam-square","fab fa-steam","fab fa-staylinked","fas fa-star-half","far fa-star-half","fas fa-star","far fa-star","fab fa-stack-overflow","fab fa-stack-exchange","fas fa-square-full","fas fa-square","far fa-square","fab fa-spotify","fas fa-spinner","fab fa-speakap","fas fa-space-shuttle","fab fa-soundcloud","fas fa-sort-up","fas fa-sort-numeric-up","fas fa-sort-numeric-down","fas fa-sort-down","fas fa-sort-amount-up","fas fa-sort-amount-down","fas fa-sort-alpha-up","fas fa-sort-alpha-down","fas fa-sort","fas fa-snowflake","far fa-snowflake","fab fa-snapchat-square","fab fa-snapchat-ghost","fab fa-snapchat","fas fa-smoking","fas fa-smile","far fa-smile","fab fa-slideshare","fas fa-sliders-h","fab fa-slack-hash","fab fa-slack","fab fa-skype","fab fa-skyatlas","fab fa-sith","fas fa-sitemap","fab fa-sistrix","fab fa-simplybuilt","fas fa-signal","fas fa-sign-out-alt","fas fa-sign-language","fas fa-sign-in-alt","fas fa-sign","fas fa-shower","fas fa-shopping-cart","fas fa-shopping-basket","fas fa-shopping-bag","fab fa-shirtsinbulk","fas fa-shipping-fast","fas fa-ship","fas fa-shield-alt","fas fa-shekel-sign","fas fa-share-square","far fa-share-square","fas fa-share-alt-square","fas fa-share-alt","fas fa-share","fab fa-servicestack","fas fa-server","fab fa-sellsy","fab fa-sellcast","fas fa-seedling","fab fa-searchengin","fas fa-search-plus","fas fa-search-minus","fas fa-search","fab fa-scribd","fab fa-schlix","fas fa-save","far fa-save","fab fa-sass","fab fa-safari","fas fa-rupee-sign","fas fa-ruble-sign","fas fa-rss-square","fas fa-rss","fab fa-rockrms","fab fa-rocketchat","fas fa-rocket","fas fa-road","fas fa-ribbon","fas fa-retweet","fab fa-resolving","fab fa-researchgate","fab fa-replyd","fas fa-reply-all","fas fa-reply","fab fa-renren","fab fa-rendact","fas fa-registered","far fa-registered","fas fa-redo-alt","fas fa-redo","fab fa-reddit-square","fab fa-reddit-alien","fab fa-reddit","fab fa-red-river","fas fa-recycle","fab fa-rebel","fab fa-readme","fab fa-react","fab fa-ravelry","fas fa-random","fab fa-r-project","fas fa-quote-right","fas fa-quote-left","fab fa-quora","fab fa-quinscape","fas fa-quidditch","fas fa-question-circle","far fa-question-circle","fas fa-question","fas fa-qrcode","fab fa-qq","fab fa-python","fas fa-puzzle-piece","fab fa-pushed","fab fa-product-hunt","fas fa-procedures","fas fa-print","fas fa-prescription-bottle-alt","fas fa-prescription-bottle","fas fa-power-off","fas fa-pound-sign","fas fa-portrait","fas fa-poo","fas fa-podcast","fas fa-plus-square","far fa-plus-square","fas fa-plus-circle","fas fa-plus","fas fa-plug","fab fa-playstation","fas fa-play-circle","far fa-play-circle","fas fa-play","fas fa-plane","fab fa-pinterest-square","fab fa-pinterest-p","fab fa-pinterest","fas fa-pills","fas fa-piggy-bank","fab fa-pied-piper-pp","fab fa-pied-piper-hat","fab fa-pied-piper-alt","fab fa-pied-piper","fab fa-php","fas fa-phone-volume","fas fa-phone-square","fas fa-phone-slash","fas fa-phone","fab fa-phoenix-squadron","fab fa-phoenix-framework","fab fa-phabricator","fab fa-periscope","fas fa-percent","fas fa-people-carry","fas fa-pencil-alt","fas fa-pen-square","fab fa-paypal","fas fa-paw","fas fa-pause-circle","far fa-pause-circle","fas fa-pause","fab fa-patreon","fas fa-paste","fas fa-paragraph","fas fa-parachute-box","fas fa-paperclip","fas fa-paper-plane","far fa-paper-plane","fas fa-palette","fas fa-pallet","fab fa-palfed","fas fa-paint-brush","fab fa-pagelines","fab fa-page4","fas fa-outdent","fab fa-osi","fab fa-optin-monster","fab fa-opera","fab fa-openid","fab fa-opencart","fab fa-old-republic","fab fa-odnoklassniki-square","fab fa-odnoklassniki","fas fa-object-ungroup","far fa-object-ungroup","fas fa-object-group","far fa-object-group","fab fa-nutritionix","fab fa-ns8","fab fa-npm","fas fa-notes-medical","fab fa-node-js","fab fa-node","fab fa-nintendo-switch","fas fa-newspaper","far fa-newspaper","fas fa-neuter","fab fa-napster","fas fa-music","fas fa-mouse-pointer","fas fa-motorcycle","fas fa-moon","far fa-moon","fas fa-money-bill-alt","far fa-money-bill-alt","fab fa-monero","fab fa-modx","fas fa-mobile-alt","fas fa-mobile","fab fa-mizuni","fab fa-mixcloud","fab fa-mix","fas fa-minus-square","far fa-minus-square","fas fa-minus-circle","fas fa-minus","fab fa-microsoft","fas fa-microphone-slash","fas fa-microphone","fas fa-microchip","fas fa-mercury","fas fa-meh","far fa-meh","fab fa-meetup","fab fa-medrt","fas fa-medkit","fab fa-medium-m","fab fa-medium","fab fa-medapps","fab fa-maxcdn","fab fa-mastodon","fas fa-mars-stroke-v","fas fa-mars-stroke-h","fas fa-mars-stroke","fas fa-mars-double","fas fa-mars","fas fa-map-signs","fas fa-map-pin","fas fa-map-marker-alt","fas fa-map-marker","fas fa-map","far fa-map","fab fa-mandalorian","fas fa-male","fas fa-magnet","fas fa-magic","fab fa-magento","fab fa-lyft","fas fa-low-vision","fas fa-long-arrow-alt-up","fas fa-long-arrow-alt-right","fas fa-long-arrow-alt-left","fas fa-long-arrow-alt-down","fas fa-lock-open","fas fa-lock","fas fa-location-arrow","fas fa-list-ul","fas fa-list-ol","fas fa-list-alt","far fa-list-alt","fas fa-list","fas fa-lira-sign","fab fa-linux","fab fa-linode","fab fa-linkedin-in","fab fa-linkedin","fas fa-link","fab fa-line","fas fa-lightbulb","far fa-lightbulb","fas fa-life-ring","far fa-life-ring","fas fa-level-up-alt","fas fa-level-down-alt","fab fa-less","fas fa-lemon","far fa-lemon","fab fa-leanpub","fas fa-leaf","fab fa-lastfm-square","fab fa-lastfm","fab fa-laravel","fas fa-laptop","fas fa-language","fab fa-korvue","fab fa-kickstarter-k","fab fa-kickstarter","fab fa-keycdn","fas fa-keyboard","far fa-keyboard","fab fa-keybase","fas fa-key","fab fa-jsfiddle","fab fa-js-square","fab fa-js","fab fa-joomla","fab fa-joget","fab fa-jenkins","fab fa-jedi-order","fab fa-java","fab fa-itunes-note","fab fa-itunes","fas fa-italic","fab fa-ioxhost","fab fa-internet-explorer","fab fa-instagram","fas fa-info-circle","fas fa-info","fas fa-industry","fas fa-indent","fas fa-inbox","fab fa-imdb","fas fa-images","far fa-images","fas fa-image","far fa-image","fas fa-id-card-alt","fas fa-id-card","far fa-id-card","fas fa-id-badge","far fa-id-badge","fas fa-i-cursor","fab fa-hubspot","fab fa-html5","fab fa-houzz","fas fa-hourglass-start","fas fa-hourglass-half","fas fa-hourglass-end","fas fa-hourglass","far fa-hourglass","fab fa-hotjar","fas fa-hospital-symbol","fas fa-hospital-alt","fas fa-hospital","far fa-hospital","fab fa-hooli","fas fa-home","fas fa-hockey-puck","fas fa-history","fab fa-hire-a-helper","fab fa-hips","fas fa-heartbeat","fas fa-heart","far fa-heart","fas fa-headphones","fas fa-heading","fas fa-hdd","far fa-hdd","fas fa-hashtag","fas fa-handshake","far fa-handshake","fas fa-hands-helping","fas fa-hands","fas fa-hand-spock","far fa-hand-spock","fas fa-hand-scissors","far fa-hand-scissors","fas fa-hand-rock","far fa-hand-rock","fas fa-hand-pointer","far fa-hand-pointer","fas fa-hand-point-up","far fa-hand-point-up","fas fa-hand-point-right","far fa-hand-point-right","fas fa-hand-point-left","far fa-hand-point-left","fas fa-hand-point-down","far fa-hand-point-down","fas fa-hand-peace","far fa-hand-peace","fas fa-hand-paper","far fa-hand-paper","fas fa-hand-lizard","far fa-hand-lizard","fas fa-hand-holding-usd","fas fa-hand-holding-heart","fas fa-hand-holding","fab fa-hacker-news-square","fab fa-hacker-news","fas fa-h-square","fab fa-gulp","fab fa-grunt","fab fa-gripfire","fab fa-grav","fab fa-gratipay","fas fa-graduation-cap","fab fa-google-wallet","fab fa-google-plus-square","fab fa-google-plus-g","fab fa-google-plus","fab fa-google-play","fab fa-google-drive","fab fa-google","fab fa-goodreads-g","fab fa-goodreads","fas fa-golf-ball","fab fa-gofore","fas fa-globe","fab fa-glide-g","fab fa-glide","fas fa-glass-martini","fab fa-gitter","fab fa-gitlab","fab fa-gitkraken","fab fa-github-square","fab fa-github-alt","fab fa-github","fab fa-git-square","fab fa-git","fas fa-gift","fab fa-gg-circle","fab fa-gg","fab fa-get-pocket","fas fa-genderless","fas fa-gem","far fa-gem","fas fa-gavel","fas fa-gamepad","fab fa-galactic-senate","fab fa-galactic-republic","fas fa-futbol","far fa-futbol","fab fa-fulcrum","fas fa-frown","far fa-frown","fab fa-freebsd","fab fa-free-code-camp","fab fa-foursquare","fas fa-forward","fab fa-forumbee","fab fa-fort-awesome-alt","fab fa-fort-awesome","fas fa-football-ball","fab fa-fonticons-fi","fab fa-fonticons","fab fa-font-awesome-flag","fab fa-font-awesome-alt","fab fa-font-awesome","fas fa-font","fas fa-folder-open","far fa-folder-open","fas fa-folder","far fa-folder","fab fa-fly","fab fa-flipboard","fab fa-flickr","fas fa-flask","fas fa-flag-checkered","fas fa-flag","far fa-flag","fab fa-firstdraft","fab fa-first-order-alt","fab fa-first-order","fas fa-first-aid","fab fa-firefox","fas fa-fire-extinguisher","fas fa-fire","fas fa-filter","fas fa-film","fas fa-file-word","far fa-file-word","fas fa-file-video","far fa-file-video","fas fa-file-powerpoint","far fa-file-powerpoint","fas fa-file-pdf","far fa-file-pdf","fas fa-file-medical-alt","fas fa-file-medical","fas fa-file-image","far fa-file-image","fas fa-file-excel","far fa-file-excel","fas fa-file-code","far fa-file-code","fas fa-file-audio","far fa-file-audio","fas fa-file-archive","far fa-file-archive","fas fa-file-alt","far fa-file-alt","fas fa-file","far fa-file","fas fa-fighter-jet","fas fa-female","fas fa-fax","fas fa-fast-forward","fas fa-fast-backward","fab fa-facebook-square","fab fa-facebook-messenger","fab fa-facebook-f","fab fa-facebook","fas fa-eye-slash","far fa-eye-slash","fas fa-eye-dropper","fas fa-eye","far fa-eye","fas fa-external-link-square-alt","fas fa-external-link-alt","fab fa-expeditedssl","fas fa-expand-arrows-alt","fas fa-expand","fas fa-exclamation-triangle","fas fa-exclamation-circle","fas fa-exclamation","fas fa-exchange-alt","fas fa-euro-sign","fab fa-etsy","fab fa-ethereum","fab fa-erlang","fas fa-eraser","fab fa-envira","fas fa-envelope-square","fas fa-envelope-open","far fa-envelope-open","fas fa-envelope","far fa-envelope","fab fa-empire","fab fa-ember","fas fa-ellipsis-v","fas fa-ellipsis-h","fab fa-elementor","fas fa-eject","fas fa-edit","far fa-edit","fab fa-edge","fab fa-ebay","fab fa-earlybirds","fab fa-dyalog","fab fa-drupal","fab fa-dropbox","fab fa-dribbble-square","fab fa-dribbble","fab fa-draft2digital","fas fa-download","fas fa-dove","fas fa-dot-circle","far fa-dot-circle","fas fa-donate","fas fa-dolly-flatbed","fas fa-dolly","fas fa-dollar-sign","fab fa-docker","fab fa-dochub","fas fa-dna","fab fa-discourse","fab fa-discord","fab fa-digital-ocean","fab fa-digg","fas fa-diagnoses","fab fa-deviantart","fas fa-desktop","fab fa-deskpro","fab fa-deploydog","fab fa-delicious","fas fa-deaf","fas fa-database","fab fa-dashcube","fab fa-d-and-d","fab fa-cuttlefish","fas fa-cut","fas fa-cubes","fas fa-cube","fab fa-css3-alt","fab fa-css3","fas fa-crosshairs","fas fa-crop","fas fa-credit-card","far fa-credit-card","fab fa-creative-commons-share","fab fa-creative-commons-sampling-plus","fab fa-creative-commons-sampling","fab fa-creative-commons-sa","fab fa-creative-commons-remix","fab fa-creative-commons-pd-alt","fab fa-creative-commons-pd","fab fa-creative-commons-nd","fab fa-creative-commons-nc-jp","fab fa-creative-commons-nc-eu","fab fa-creative-commons-nc","fab fa-creative-commons-by","fab fa-creative-commons","fab fa-cpanel","fas fa-couch","fas fa-copyright","far fa-copyright","fas fa-copy","far fa-copy","fab fa-contao","fab fa-connectdevelop","fas fa-compress","fas fa-compass","far fa-compass","fas fa-comments","far fa-comments","fas fa-comment-slash","fas fa-comment-dots","far fa-comment-dots","fas fa-comment-alt","far fa-comment-alt","fas fa-comment","far fa-comment","fas fa-columns","fas fa-cogs","fas fa-cog","fas fa-coffee","fab fa-codiepie","fab fa-codepen","fas fa-code-branch","fas fa-code","fab fa-cloudversify","fab fa-cloudsmith","fab fa-cloudscale","fas fa-cloud-upload-alt","fas fa-cloud-download-alt","fas fa-cloud","fas fa-closed-captioning","far fa-closed-captioning","fas fa-clone","far fa-clone","fas fa-clock","far fa-clock","fas fa-clipboard-list","fas fa-clipboard-check","fas fa-clipboard","far fa-clipboard","fas fa-circle-notch","fas fa-circle","far fa-circle","fab fa-chrome","fas fa-child","fas fa-chevron-up","fas fa-chevron-right","fas fa-chevron-left","fas fa-chevron-down","fas fa-chevron-circle-up","fas fa-chevron-circle-right","fas fa-chevron-circle-left","fas fa-chevron-circle-down","fas fa-chess-rook","fas fa-chess-queen","fas fa-chess-pawn","fas fa-chess-knight","fas fa-chess-king","fas fa-chess-board","fas fa-chess-bishop","fas fa-chess","fas fa-check-square","far fa-check-square","fas fa-check-circle","far fa-check-circle","fas fa-check","fas fa-chart-pie","fas fa-chart-line","fas fa-chart-bar","far fa-chart-bar","fas fa-chart-area","fas fa-certificate","fab fa-centercode","fab fa-cc-visa","fab fa-cc-stripe","fab fa-cc-paypal","fab fa-cc-mastercard","fab fa-cc-jcb","fab fa-cc-discover","fab fa-cc-diners-club","fab fa-cc-apple-pay","fab fa-cc-amex","fab fa-cc-amazon-pay","fas fa-cart-plus","fas fa-cart-arrow-down","fas fa-caret-up","fas fa-caret-square-up","far fa-caret-square-up","fas fa-caret-square-right","far fa-caret-square-right","fas fa-caret-square-left","far fa-caret-square-left","fas fa-caret-square-down","far fa-caret-square-down","fas fa-caret-right","fas fa-caret-left","fas fa-caret-down","fas fa-car","fas fa-capsules","fas fa-camera-retro","fas fa-camera","fas fa-calendar-times","far fa-calendar-times","fas fa-calendar-plus","far fa-calendar-plus","fas fa-calendar-minus","far fa-calendar-minus","fas fa-calendar-check","far fa-calendar-check","fas fa-calendar-alt","far fa-calendar-alt","fas fa-calendar","far fa-calendar","fas fa-calculator","fab fa-buysellads","fas fa-bus"],workflow:["fas fa-cog","fas fa-check","fas fa-plus","fas fa-times","fas fa-paper-plane","far fa-paper-plane","fas fa-sitemap","fas fa-lightbulb","fas fa-balance-scale","fas fa-thumbs-up","fas fa-thumbs-down","fas fa-handshake","far fa-handshake","fas fa-hand-holding-usd","fas fa-euro-sign","fas fa-dollar-sign","fas fa-trash","fas fa-power-off","fas fa-sync-alt","fas fa-redo-alt","fas fa-undo-alt","fas fa-star","fas fa-key","fas fa-save","fas fa-heart","far fa-heart","fas fa-exclamation-triangle","fas fa-bolt","fas fa-exclamation","fas fa-question","fas fa-hourglass-half","fas fa-clock","far fa-clock","fas fa-history","fas fa-calendar-times","fas fa-calendar-alt","far fa-flag","fas fa-flag-checkered","fas fa-archive","fas fa-edit","far fa-edit","fas fa-print","fas fa-unlock-alt","fas fa-unlock","fas fa-wrench","fas fa-cogs","fas fa-paperclip","fas fa-file-alt","far fa-file-alt","fas fa-file","far fa-file","fas fa-copy","far fa-copy","fas fa-folder-open","far fa-folder-open","fas fa-folder","far fa-folder","fas fa-comments","far fa-comments","fas fa-comment-dots","far fa-comment-dots","fas fa-comment-alt","far fa-comment-alt","fas fa-comment","far fa-comment","fas fa-search","fas fa-binoculars","fas fa-filter","fas fa-lock-open","fas fa-lock","fas fa-clone","far fa-clone","fas fa-paste","fas fa-notes-medical","fas fa-clipboard-list","fas fa-clipboard-check","fas fa-clipboard","far fa-clipboard","fas fa-child","fas fa-smile","far fa-smile","fas fa-meh","far fa-meh","fas fa-frown","far fa-frown","fas fa-user","fas fa-user-friends","fas fa-users","fas fa-user-check","fas fa-user-plus","fas fa-user-minus","fas fa-user-tie","fas fa-user-graduate","fas fa-graduation-cap","fas fa-address-card","fas fa-step-backward","fas fa-fast-backward","fas fa-backward","fas fa-play","fas fa-pause","fas fa-forward","fas fa-fast-forward","fas fa-step-forward","fas fa-reply-all","fas fa-reply","fas fa-play-circle","fas fa-pause-circle","fas fa-stop-circle","fas fa-check-circle","far fa-check-circle","fas fa-arrow-circle-left","fas fa-arrow-circle-right","fas fa-arrow-alt-circle-left","fas fa-arrow-alt-circle-right","fas fa-chevron-circle-left","fas fa-chevron-circle-right","fas fa-user-circle","fas fa-times-circle","fas fa-plus-circle","fas fa-minus-circle","fas fa-exclamation-circle","fas fa-question-circle","fas fa-adjust","fas fa-plus-square","fas fa-minus-square","fas fa-external-link-square-alt","fas fa-check-square","far fa-check-square","fas fa-caret-square-left","fas fa-caret-square-right","far fa-caret-square-left","far fa-caret-square-right","fas fa-arrow-left","fas fa-chevron-left","fas fa-angle-double-left","fas fa-angle-left","fas fa-caret-left","fas fa-exchange-alt","fas fa-caret-right","fas fa-angle-right","fas fa-angle-double-right","fas fa-chevron-right","fas fa-arrow-right","fas fa-phone","fas fa-bullhorn","fas fa-bell","fas fa-envelope-open","far fa-envelope-open","fas fa-envelope","far fa-envelope","fas fa-chart-pie","fas fa-chart-line","fas fa-chart-bar","fas fa-chart-area","fab fa-windows","fab fa-microsoft","fas fa-desktop","fas fa-laptop","fas fa-keyboard","fas fa-database","fas fa-hockey-puck","fas fa-hdd","fas fa-mobile-alt","fas fa-microchip","fas fa-microphone","fas fa-wifi","fas fa-cloud","fas fa-cloud-upload-alt","fas fa-cloud-download-alt","fas fa-road","fas fa-map-signs","fas fa-map-marker","fas fa-map","fas fa-globe","fas fa-magnet","fas fa-location-arrow","fas fa-mouse-pointer","fas fa-moon","fas fa-bicycle","fas fa-motorcycle","fas fa-car","fas fa-bus","fas fa-truck","fas fa-plane","fas fa-fighter-jet","fas fa-dolly-flatbed","fas fa-dolly","fab fa-dropbox","fas fa-box-open","fas fa-shopping-cart","fas fa-cart-plus","fas fa-home","fas fa-building","fas fa-university","fas fa-book","fas fa-code","fas fa-code-branch","fas fa-bookmark","fas fa-bomb","far fa-eye","fas fa-camera","fas fa-images","fas fa-film","fas fa-music","fas fa-paw","fas fa-dove","fas fa-dna","fas fa-gift","fas fa-gem","far fa-gem","fas fa-puzzle-piece","fas fa-plug","fas fa-cut","fas fa-cubes","fas fa-cube","fas fa-bed","fas fa-couch","fas fa-coffee","fas fa-beer","fas fa-wine-glass","fas fa-glass-martini","fas fa-utensils","fas fa-flask","fas fa-capsules"]};(function(){const RECONNECTION_SYMBOL=Symbol("reconnection");let reconnecting=false,closing=false;kiss.websocket={connection:{},async init(config={}){if(this.connection.readyState!==undefined&&this.connection.readyState!==WebSocket.CLOSED||closing||kiss.context.ws==="no"){return}const logPrefix=`kiss.websocket - ${kiss.tools.uid()}`;let socketUrl=config.socketUrl;const{port:port=80,sslPort:sslPort=443,reconnection:{enabled:autoReconnect=true,delay:reconnectionDelay=5e3,delta:reconnectionDelta=2,maxAttempts:maxAttempts=10}={},heartbeat:{enabled:heartbeatEnabled=true,delay:heartbeatDelay=1e4,timeout:heartbeatTimeout=35e3}={}}=config;const ws=window.WebSocket||window.MozWebSocket;if(!socketUrl){socketUrl=kiss.session.getWebsocketHost()+"/?token="}log(`${logPrefix} - Connecting to ${socketUrl}`);const connection=new ws(socketUrl+kiss.session.getToken());const connectionResolver={};connectionResolver.promise=new Promise(((resolve,reject)=>{Object.assign(connectionResolver,{resolve:resolve,reject:reject})})).then((()=>connectionResolver.succeeded=true)).catch((()=>connectionResolver.succeeded=false));let heartbeatHandle,heartbeatResponseHandle;connection.addEventListener("open",(e=>{log(`${logPrefix} - Connected`);connectionResolver.resolve();if(RECONNECTION_SYMBOL in config||reconnecting){if(!(RECONNECTION_SYMBOL in config)){config[RECONNECTION_SYMBOL]={attempt:0}}else{config[RECONNECTION_SYMBOL].attempt=0}kiss.pubsub.publish("EVT_RECONNECTED")}else{kiss.pubsub.publish("EVT_CONNECTED")}if(typeof config.onopen==="function"){try{config.onopen()}catch(err){log(`${logPrefix} - Could not execute 'onopen' hook properly - Error:`,4,err)}}if(!heartbeatEnabled)return;heartbeatHandle=setInterval((()=>{if(!heartbeatResponseHandle){heartbeatResponseHandle=setTimeout((()=>{connection.close(4e3,"SERVER_NOT_RESPONDING")}),heartbeatTimeout)}connection.send("ping")}),heartbeatDelay)}));connection.addEventListener("close",(async e=>{log(`${logPrefix} - Closed ${e.reason} (${e.code})`);closing=true;clearInterval(heartbeatHandle);if(typeof config.onclose==="function"){try{config.onclose()}catch(err){log(`${logPrefix} - Could not execute 'onclose' hook properly - Error:`,4,err)}}if(e.code===4002){log(`${logPrefix} - Connection locked by server (too many sockets have been opened by this user).`);kiss.pubsub.publish("EVT_CONNECTION_LOST");return}else if(e.code===4003){log(`${logPrefix} - Connection definitively closed.`);kiss.pubsub.publish("EVT_CONNECTION_CLOSED");return}else if(!e.reason&&e.code===1006){if(!await kiss.session.checkTokenValidity(true)){log(`${logPrefix} - Can't reconnect. No valid token available, and current token can't be renewed !`);kiss.pubsub.publish("EVT_UNUSABLE_TOKEN");return kiss.session.logout()}}else if(e.code===1001){log(`${logPrefix} - Server gone.`);kiss.pubsub.publish("EVT_SERVER_GONE");return}if(!config[RECONNECTION_SYMBOL]){config[RECONNECTION_SYMBOL]={attempt:1}}else{config[RECONNECTION_SYMBOL].attempt++}if(connectionResolver.succeeded){kiss.pubsub.publish("EVT_DISCONNECTED")}else{connectionResolver.reject()}closing=false;if(!autoReconnect)return;if(config[RECONNECTION_SYMBOL].attempt<=maxAttempts){let delay=reconnectionDelay||5e3;if([1001,1006].includes(e.code)&&reconnectionDelta){delay+=Math.floor(Math.random()*(delay*reconnectionDelta+1))}log(`${logPrefix} - Will try to reconnect to the server in ${delay} ms...`);setTimeout((async()=>{if("readyState"in kiss.websocket.connection&&kiss.websocket.connection.readyState!==WebSocket.CLOSED){log(`${logPrefix} - Reconnection aborted`);return}log(`${logPrefix} - Trying to reconnect (attempt ${config[RECONNECTION_SYMBOL].attempt}/${maxAttempts})`);try{const promise=kiss.websocket.init(config);kiss.pubsub.publish("EVT_RECONNECTING",promise);reconnecting=true}catch(err){reconnecting=false;log(`${logPrefix} - Unable to reconnect: `,4,err)}}),delay)}else{log(`${logPrefix} - Connection lost (max attempts (${maxAttempts}) reached !)`);kiss.pubsub.publish("EVT_CONNECTION_LOST")}}));connection.addEventListener("message",(message=>{if(message.data==="pong"){clearTimeout(heartbeatResponseHandle);heartbeatResponseHandle=null;return}try{log(`${logPrefix} - onmessage - Data:`,1,message.data);let json=JSON.parse(message.data);json.websocket=true;kiss.pubsub.publish(json.channel,json);if(typeof config.onmessage==="function"){try{config.onmessage(message)}catch(err){log(`${logPrefix} - Could not execute 'onmessage' hook properly - Error:`,4,err)}}}catch(err){log(`${logPrefix} - onmessage - Error:`,4,err)}}));kiss.websocket.connection=connection;return connectionResolver.promise},close(){if(typeof this.connection.close==="function"){this.connection.close(4003,"DEFINITIVE_CLOSE")}else throw new Error("No connection to close: kiss.websocket.init has not been called.")},send(jsonData){if(typeof this.connection.send==="function"){const message=JSON.stringify(jsonData);this.connection.send(message)}else throw new Error("No connection to opened: kiss.websocket.init has not been called.")}}})();kiss.ui.Component=class Component extends HTMLElement{constructor(){super()}init(config){if(!config)return null;this.isComponent=true;this.type=config.type||this.constructor.name.toLowerCase();this.id=config.id||"cmp-"+(kiss.global.componentCount++).toString();this.target=config.target||null;this.config=config;this.renderDelay=25;this.classList.add("a-"+this.type.toLowerCase());if(kiss.screen.isMobile)this.classList.add("a-"+this.type.toLowerCase()+"-mobile");if(config.display)this.displayMode=config.display;if(config.hidden==true)this.style.display="none";if(config.tip)this.attachTip(config.tip);if(config.animation)this.setAnimation(config.animation);const methods=config.methods;if(methods){for(let method in methods){this[method]=methods[method]}}let viewControllers=kiss.views.viewControllers[this.id];if(kiss.screen.isMobile){if(!this.id.includes("mobile")){viewControllers=kiss.views.viewControllers["mobile-"+this.id]||kiss.views.viewControllers[this.id]}}if(viewControllers){for(let method in viewControllers){this[method]=viewControllers[method]}}this._bindEvents(this.config.events);this.subscriptions=[];if(this.config.subscriptions){Object.keys(this.config.subscriptions).forEach((pubSubEventName=>{this.subscriptions.push(subscribe(pubSubEventName,this.config.subscriptions[pubSubEventName].bind(this)))}))}if(config.autoSize){this.resizeCount=0;this.subscriptions.push(subscribe("EVT_CONTAINERS_RESIZED",(containerIds=>{if(this.parentNode==document.body||this.parentNode&&this.parentNode.id&&containerIds.indexOf(this.parentNode.id)!=-1){this.updateLayout("EVT_CONTAINERS_RESIZED");this.resizeCount++}})))}if(config.collections&&config.collections.length>0&&config.collections[0]){this.collections=config.collections;if(this.load){const observedEvents=[];this.collections.forEach((collection=>{let model=collection.model;let modelId=model.id;let events=["EVT_DB_INSERT:","EVT_DB_UPDATE:","EVT_DB_DELETE:"];events.forEach((EVT=>{let eventName=EVT+modelId.toUpperCase();observedEvents.push(eventName)}))}));observedEvents.forEach((eventName=>{this.subscriptions.push(subscribe(eventName,(msgData=>{if(this.isConnected){log("kiss.ui - React to "+eventName+" - Component loading "+this.id,2);this.load(msgData)}})))}));const observedModels=this.collections.map((collection=>collection.model.id));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{if(this.isConnected){let shouldLoad=false;const bulkUpdates=msgData.data;bulkUpdates.forEach((update=>{if(observedModels.indexOf(update.modelId)!=-1)shouldLoad=true}));if(shouldLoad){log("EVT_DB_UPDATE_BULK - Component loading "+this.id,2);this.load(msgData)}}})))}}this._translate(config);return this}_translate(config){if(config.label){config.label=kiss.language.translateProperty(config,"label")}else if(config.title){config.title=kiss.language.translateProperty(config,"title")}else if(config.name){config.name=kiss.language.translateProperty(config,"name");if(config.namePlural){config.namePlural=kiss.language.translateProperty(config,"namePlural")}}}connectedCallback(){if(this._afterConnected)this._afterConnected()}disconnectedCallback(){if(this.loadingId)this.hideLoading();if(this._afterDisconnected)this._afterDisconnected()}render(target,load=true){this.style.visibility="hidden";if(!this.isConnected){if(this.config&&this.config.classes)this._dispatchClasses(this.config.classes);if(this.config&&this.config.class)this.classList.add(this.config.class);if(this.config&&this.config.styles)this._dispatchStyles(this.config.styles);if(this.config&&this.config.style)this.style.cssText+=this.config.style;if(this.config&&this.config.hidden)this.style.display="none";this._insertIntoDOM(target,this.config&&this.config.targetIndex)}if(this.items&&this.items.length>0)this.items.forEach((item=>item.render(item.target||target)));if(load&&this.load){if(this.isComponent){this._load()}else{this.load()}}else{if(this.updateLayout)this.updateLayout("Component.render");if(this._afterRender)this._afterRender();setTimeout((()=>this.style.visibility="visible"),this.renderDelay)}return this}update(newConfig){let component;const config=this.config;if(newConfig)Object.assign(config,newConfig);config.target=this.parentNode.id;config.targetIndex=Array.from(this.parentNode.children).indexOf(this);this.deepDelete();if(this.type){if(["text","textarea","number","date","password","lookup","summary"].includes(this.type)){component=document.createElement("a-field").init(config)}else{component=document.createElement("a-"+this.type.toLowerCase()).init(config)}}else{component=document.createElement("a-block").init(config)}return component.render()}hide(){let currentDisplayMode=window.getComputedStyle(this,"")["display"];if(currentDisplayMode!=""&&currentDisplayMode!="none")this.displayMode=currentDisplayMode;this.style.display="none";this.hidden=true;if(this._afterHide)this._afterHide();return this}show(mode){if(this.style.display!="none")return this;this.style.display=mode||this.displayMode||this.config&&this.config.display||"block";this.hidden=false;if(this._afterShow)this._afterShow();return this}showAt(x,y,animationTimeInSeconds){if(animationTimeInSeconds)this.style.transition=animationTimeInSeconds+"s";this.style.left=x+"px";this.style.top=y+"px";this.show().moveToViewport();return this}moveToViewport(){kiss.tools.moveToViewport(this);return this}isLocked(){this.locker=`<span class="field-label-read-only fas fa-lock"></span> `;return this.config&&this.config.label&&this.config.locked===true}isRequired(){this.asterisk=` <span class="field-label-required"><sup>*</sup></span>`;return this.config&&this.config.label&&this.config.required===true&&this.config.readOnly!==true&&this.config.disabled!==true&&!this.isLocked()}isHidden(){return this.style.display=="none"||this.hidden==true}isVisible(){return!this.isHidden()}toggle(){if(this.isHidden()){this.show()}else{this.hide()}return this}showLoading(config={}){if(this.isLoading)return;const box=this.getBoundingClientRect();const mask=document.createElement("div");mask.classList.add("component-loader-mask");mask.id="mask-"+kiss.tools.shortUid();mask.style.top=config.fullscreen==true?0:box.y+"px";mask.style.left=config.fullscreen==true?0:box.x+"px";mask.style.width=config.fullscreen==true?"100vw":box.width+"px";mask.style.height=config.fullscreen==true?"100vh":box.height+"px";if(this.type=="panel")mask.style.borderRadius="var(--panel-border-radius)";if(config.mask!==false)mask.style.background="var(--background-overlay)";const spinner=document.createElement("div");spinner.classList.add("component-loader");spinner.id="spinner-"+this.id;if(config.spinnerSize){if(typeof config.spinnerSize=="number"){spinner.style.width=config.spinnerSize+"px";spinner.style.height=config.spinnerSize+"px"}else{spinner.style.width=config.spinnerSize;spinner.style.height=config.spinnerSize}}else{spinner.style.width="3.2rem";spinner.style.height="3.2rem"}this.loadingId=mask.id;const maskNode=document.body.appendChild(mask);maskNode.appendChild(spinner);this.isLoading=true;return this}hideLoading(){try{$(this.loadingId).remove();delete this.loadingId;this.isLoading=false}catch(err){}return this}attachTip(tipConfig){if(kiss.screen.isMobile)return;if(kiss.screen.isTouch())return;if(this.tip)return;if(typeof tipConfig==="object"){this.tip=createTip({target:this,text:tipConfig.text,textAlign:tipConfig.textAlign,x:tipConfig.x,y:tipConfig.y,deltaX:tipConfig.deltaX,deltaY:tipConfig.deltaY,minWidth:tipConfig.minWidth,maxWidth:tipConfig.maxWidth})}else{this.tip=createTip({target:this,text:tipConfig})}setTimeout((()=>{if(this.config&&!this.isConnected){if(!this.config.events)this.config.events={};this.config.events.onmouseenter=()=>this.tip.render()}else{this.onmouseenter=()=>this.tip.render()}}),0);return this}detachTip(){if(!this.tip)return this;this.tip.detach();delete this.tip;return this}getWidth(){return this.clientWidth}getHeight(){return this.clientHeight}setSize(config){if(config.width){this.config.width=config.width;this._setWidth()}if(config.height){this.config.height=config.height;this._setHeight()}return this}setLeft(newLeft){this.config.left=newLeft;this._setLeft();return this}setTop(newTop){this.config.top=newTop;this._setTop();return this}_insertIntoDOM(target,index){let domTarget=target||this.target;if(domTarget){if(typeof domTarget=="string"){if(index){$(domTarget).insertBefore(this,$(domTarget).children[index])}else{$(domTarget).appendChild(this)}}else{if(index){domTarget.insertBefore(this,domTarget.children[index])}else{domTarget.appendChild(this)}}}else{document.body.appendChild(this)}}async _load(){try{if(this.collections){for(let collection of this.collections){await collection.find()}}if(this.load)await this.load();if(this.updateLayout)this.updateLayout("Component._load");if(this._afterRender)this._afterRender();setTimeout((()=>this.style.visibility="visible"),this.renderDelay)}catch(err){log("kiss.ui - Component - Loading error: "+this.id,4);log(err)}}_bindEvents(events,target){let targetElement=target||this;if(events){for(let event in events){const eventName=event.slice(0,2).toLowerCase()=="on"?event:"on"+event;targetElement[eventName.toLowerCase()]=events[event]}}return this}_setProperties(config,rules){rules.forEach((rule=>{let properties=rule[0];let targets=rule[1];properties.forEach((property=>{let[configProperty,targetProperty]=property.split("=");if(config[configProperty]!=null){let value=config[configProperty];if(["padding","margin","top","right","bottom","left","width","minWidth","maxWidth","height","minHeight","maxHeight","fontSize","iconSize","borderWidth","borderRadius","fieldWidth","fieldHeight","labelWidth","headerHeight","colorWidth","colorHeight"].includes(configProperty)){value=this._computeSize(configProperty)}targets.forEach((target=>{if(target){if(!targetProperty){target[configProperty]=value}else{target[targetProperty]=value}}}))}}))}));return this}_computeSize(type){let newSize=this.config[type];if(typeof newSize=="function"){try{newSize=newSize()}catch(err){newSize=0}}if(typeof newSize=="number")newSize=newSize.toString()+"px";return newSize}_setTop(){setTimeout((()=>this.style.top=this._computeSize("top")),0)}_setLeft(){setTimeout((()=>this.style.left=this._computeSize("left")),0)}_setBottom(){setTimeout((()=>this.style.bottom=this._computeSize("bottom")),0)}_setRight(){setTimeout((()=>this.style.right=this._computeSize("right")),0)}_setWidth(){setTimeout((()=>this.style.width=this._computeSize("width")),0)}_setMinWidth(){setTimeout((()=>this.style.minWidth=this._computeSize("minWidth")),0)}_setMaxWidth(){setTimeout((()=>this.style.maxWidth=this._computeSize("maxWidth")),0)}_setHeight(){setTimeout((()=>this.style.height=this._computeSize("height")),0)}_setMinHeight(){setTimeout((()=>this.style.minHeight=this._computeSize("minHeight")),0)}_setMaxHeight(){setTimeout((()=>this.style.maxHeight=this._computeSize("maxHeight")),0)}_dispatchClasses(cssClasses){Object.keys(cssClasses).forEach((cssClass=>{let arrayOfClasses=cssClasses[cssClass].split(/\s+/);try{if(cssClass=="this"){this.classList.add(...arrayOfClasses)}else{let targetElement=this.querySelector("."+cssClass);targetElement.classList.add(...arrayOfClasses)}}catch(err){log(`Component._dispatchClasses: the class selector <${cssClass}> is not valid for the component <${this.id}>`,2)}}));return this}_dispatchStyles(styles){if(styles){Object.keys(styles).forEach((cssClass=>{try{if(cssClass=="this"){let currentStyles=this.style.cssText;this.style=currentStyles+";"+styles[cssClass]}else{let currentStyles=this.querySelector("."+cssClass).style.cssText;this.querySelector("."+cssClass).style=currentStyles+";"+styles[cssClass]}}catch(err){log(`Component._dispatchStyles: the class selector <${cssClass}> is not valid for the component <${this.id}>`,2)}}))}return this}_toggleClass(cssClasses){if(cssClasses)cssClasses.split(/\s+/).forEach((cssClass=>this.classList.toggle(cssClass)));return this}setAnimation(config){if(config===false){Array.from(this.classList).forEach((className=>{if(className.startsWith("animate__"))this.classList.remove(className)}));return this}let animationName,animationSpeed,animationRepeat;if(typeof config==="string"){animationName="animate__"+config;animationSpeed="animate__fast";animationRepeat="animate__repeat-1"}else{animationName=config.name?"animate__"+config.name:"animate__fadeIn";animationSpeed=config.speed?"animate__"+config.speed:"animate__fast";animationRepeat=config.repeat?"animate__"+config.repeat:"animate__repeat-1";this.animationCallback=config.callback}setTimeout((()=>this.classList.add("animate__animated",animationName,animationSpeed,animationRepeat)),10);this.handleAnimationEnd=function(event){event.stopPropagation();this.classList.remove("animate__animated",animationName,animationSpeed,animationRepeat);this.removeEventListener("animationend",this.handleAnimationEnd);if(typeof this.animationCallback==="function")this.animationCallback()};this.addEventListener("animationend",this.handleAnimationEnd,{once:true});return this}};HTMLElement.prototype.getComponent=function(){function getParent(node){let parent=node.parentNode;if(!parent)return null;if(!parent.classList)return null;if(parent.constructor.name=="HTMLDocument")return null;return parent}let parentNode=this.parentNode;while(getParent(parentNode)){if(parentNode.classList.value!=""){if(parentNode.classList[0].slice(0,2)=="a-")return parentNode}parentNode=parentNode.parentNode}return null};HTMLElement.prototype.render=kiss.ui.Component.prototype.render;HTMLElement.prototype._insertIntoDOM=kiss.ui.Component.prototype._insertIntoDOM;HTMLElement.prototype.show=kiss.ui.Component.prototype.show;HTMLElement.prototype.hide=kiss.ui.Component.prototype.hide;HTMLElement.prototype.showLoading=kiss.ui.Component.prototype.showLoading;HTMLElement.prototype.hideLoading=kiss.ui.Component.prototype.hideLoading;HTMLElement.prototype.attachTip=kiss.ui.Component.prototype.attachTip;HTMLElement.prototype.detachTip=kiss.ui.Component.prototype.detachTip;HTMLElement.prototype.setAnimation=kiss.ui.Component.prototype.setAnimation;kiss.ui.Container=class Container extends kiss.ui.Component{constructor(){super()}init(config){if(config.layout){config.display="flex";if(config.layout=="vertical"){config.flexFlow="column"}else if(config.layout=="horizontal"){config.flexFlow="row"}}super.init(config);if(this.type=="block")this.containerId=this.id;else this.containerId="panel-body-"+this.id;if(config.record)this._bindRecord(config.items,config.record);this.items=[];this.config.items=this.config.items||[];this._insertItems(this.config.items);this.subscriptions=this.subscriptions||[];let _this=this;if(this.config.align=="center"&&!this.config.left)this.config.left=()=>(kiss.screen.current.width-$(_this.id).clientWidth)/2;if(this.config.verticalAlign=="center"&&!this.config.top)this.config.top=()=>(kiss.screen.current.height-$(_this.id).clientHeight)/2;this.isContainer=true;kiss.screen.getResizeObserver().observe(this);return this}setDisplayMode(mode="flex"){this.config.display=this.container.style.display=mode}setItems(newItems){const containerElement=this.getContainer();containerElement.deepDelete(false);this.items=[];this.config.items=[];this._insertItems(newItems);this.render(this.target,false);return this}addItem(item){let insertedItem=this._insertOrAddItem(item,null,true);insertedItem.render();return this}insertItem(item,position){let insertedItem=this._insertOrAddItem(item,position);insertedItem.render();return this}deleteItem(itemId){this.config.items=this.config.items.filter((item=>item.id!=itemId));this.items=this.items.filter((item=>item.id!=itemId));$(itemId).deepDelete();return this}expandAll(){this.items.forEach((function(item){if(item.items){if(item.type=="panel")item.expand();item.expandAll()}}));return this}collapseAll(){this.items.forEach((function(item){if(item.items){if(item.type=="panel")item.collapse();item.collapseAll()}}));return this}getContainer(){return $(this.containerId)}getComponentIds(){let ids=[];ids.push(this.id);this.items.forEach((function(item){if(item.items)ids.push(item.getComponentIds());else if(item.id)ids.push(item.id)}));return ids.flat()}getElements(){let values=[];Array.from(this.getContainer().children).forEach((function(item){if(item.items){values.push(item.getElements())}else{if(kiss.global.elementTypes.map((type=>type.value)).indexOf(item.type)!=-1){values.push(item)}}}));return values.flat()}getFields(){let values=[];Array.from(this.getContainer().children).forEach((function(item){if(item.items){values.push(item.getFields())}else{if(kiss.global.fieldTypes.map((type=>type.value)).indexOf(item.type)!=-1){values.push(item)}}}));return values.flat()}resetFields(){const fields=this.getFields();fields.forEach((field=>field.clearValue()))}validate(){let isValid=true;const fields=this.getFields();fields.forEach((field=>{let fieldElement=this.querySelector("#"+field.id.replaceAll(":","\\:"));isValid=isValid&&fieldElement.validate()}));if(!isValid)createNotification(txtTitleCase("#fields incorrect value"));return isValid}getData(config){let record={};this.getFields().forEach((function(field){if(config&&config.useLabels){let label=field.getLabel();if(!label)label=field.id;label=label.replaceAll(" *","");record[label]=field.getValue()}else{record[field.id]=field.getValue()}}));return record}setData(data,rawUpdate){this.getFields().forEach((function(field){if(data[field.id]!=undefined)field.setValue(data[field.id],rawUpdate)}));return this}setWidth(width){this.config.width=width;this.updateLayout();return this}setHeight(height){this.config.height=height;this.updateLayout();return this}updateLayout(){if(this.isConnected){this._setWidth();this._setMinWidth();this._setMaxWidth();this._setHeight();this._setMinHeight();this._setMaxHeight();this._setTop();this._setLeft()}return this}setLabelPosition(position="left"){const fields=this.getFields();if(position=="top"||position=="bottom"){fields.forEach((item=>{if(item.field)item.field.style.transition="all 0.1s";if(item.setFieldWidth)item.setFieldWidth("100%");if(item.label){item.label.style.transition="all 0.1s";if(item.setLabelPosition){item.setLabelPosition(position)}if(item.setLabelWidth){item.setLabelWidth("100.00%")}}}))}else if(position=="left"||position=="right"){fields.forEach((item=>{if(item.field)item.field.style.transition="all 0.1s";if(item.setFieldWidth)item.setFieldWidth("50%");if(item.label){item.label.style.transition="all 0.1s";if(item.setLabelPosition){item.setLabelPosition(position)}if(item.setLabelWidth){item.setLabelWidth("50.00%")}}}))}return this}setLabelSize(size="1/3"){const fields=this.getFields();let labelSize;let fieldSize;switch(size){case"1/6":labelSize="16.66%";fieldSize="83.33%";break;case"1/4":labelSize="25.00%";fieldSize="75.00%";break;case"1/3":labelSize="33.33%";fieldSize="66.66%";break;case"1/2":labelSize="50.00%";fieldSize="50.00%";break;case"2/3":labelSize="66.66%";fieldSize="33.33%";break;case"3/4":labelSize="75.00%";fieldSize="25.00%";break}fields.forEach((item=>{if(item.style.flexFlow=="column")return;if(item.field)item.field.style.transition="all 0.1s";if(item.setFieldWidth)item.setFieldWidth(fieldSize);if(item.label){item.label.style.transition="all 0.1s";if(item.setLabelWidth)item.setLabelWidth(labelSize)}}));return this}setLabelAlign(position="left"){const fields=this.getFields();fields.forEach((item=>{if(item.label){item.label.style.transition="all 1s";item.config.labelAlign=item.label.style.textAlign=position}}));return this}setColumns(numberOfColumns=1,margin=0){const fields=this.getFields();const elements=this.getElements();const items=fields.concat(elements);const percent=(100/numberOfColumns).toFixed(2)+"%";if(numberOfColumns>1)this.setDisplayMode("block");else this.setDisplayMode("flex");items.forEach((item=>{const displayType=item.type=="html"?"block":"flex";if(!item.config.deleted)item.style.display=item.config.display="inline-"+displayType;if(item.field)item.field.style.transition="all 1s";if(item.setWidth)item.setWidth(percent,margin)}));return this}showItem(itemIndex,animation){if(itemIndex>this.items.length)return;if(this.activeItemIndex==itemIndex)return;this.activeItemIndex=itemIndex;for(let i=0;i<this.items.length;i++)this.items[i].hide();this.items[itemIndex].show();if(animation)this.items[itemIndex].setAnimation(animation);return this}showItemById(itemId,animation){let itemIndex=this.items.findIndex((item=>item.id==itemId));if(itemIndex!=-1)this.showItem(itemIndex,animation);return this}showItemByClass(className,animation){let itemIndex=this.items.findIndex((item=>Array.from(item.classList).includes(className)));if(itemIndex!=-1)this.showItem(itemIndex,animation);return this}bindRecord(record){this.items.forEach((item=>{if(item.items){item.bindRecord(record)}else if(kiss.global.fieldTypes.map((type=>type.value)).includes(item.type)&&item.config.bindRecord!==false){item._bindRecord(record)}else if(item.config.bindRecord==true){item._bindRecord(record)}}));return this}_bindRecord(items,record){items.forEach((item=>{if(item.items){item.record=record;this._bindRecord(item.items,record)}else if(kiss.global.fieldTypes.map((type=>type.value)).includes(item.type)){if(item.bindRecord!==false)item.record=record}}));return this}_insertItems(newItems){if(this.config.multiview){this.activeItemIndex=0;newItems.forEach(((item,index)=>{if(index==0){this._insertOrAddItem(item);return}if(item.tagName){item.hide()}else{item.hidden=true}this._insertOrAddItem(item)}))}else{newItems.forEach((item=>this._insertOrAddItem(item)))}}_insertOrAddItem(item,position,isNewItem){if(!item)return;item.target=this.containerId;const containerDefaults=this.config.defaultConfig;if(containerDefaults){for(let defaultProperty in containerDefaults){if(!item[defaultProperty])item[defaultProperty]=containerDefaults[defaultProperty]}}let newItem=this._createNewItem(item);if(position!=null){this.config.items.splice(position,0,item);const targetNode=this.items[position];this.items.splice(position,0,newItem);this.insertBefore(newItem,targetNode)}else{if(isNewItem)this.config.items.push(item);this.items.push(newItem)}return newItem}_createNewItem(item){if(!item.render){const type=item.type;if(type){if(["text","textarea","number","date","password","lookup","summary"].includes(type)){return document.createElement("a-field").init(item)}else if(type=="view"){return kiss.views.buildView(item.id,this.containerId)}else{return document.createElement("a-"+type.toLowerCase()).init(item)}}else{return document.createElement("a-block").init(item)}}else{return item}}};kiss.ui.DataComponent=class DataComponent extends kiss.ui.Component{constructor(){super()}init(config={}){super.init(config);if(config.collection){this.collection=config.collection;this.model=config.model||this.collection.model;this.modelId=this.model.id}else if(config.model){this.model=config.model;this.modelId=this.model.id;this.collection=new kiss.data.Collection({model:this.model,sort:[{[this.model.getPrimaryKeyField().id]:"asc"}]})}else if(config.collectionId){this.collection=kiss.app.collections[config.collectionId];this.model=this.collection.model;this.modelId=this.model.id}else if(config.modelId){this.model=kiss.app.models[config.modelId];this.modelId=this.model.id;this.collection=new kiss.data.Collection({model:this.model,sort:[{[this.model.getPrimaryKeyField().id]:"asc"}]})}this._initParameters();return this}_initParameters(){if(this.config.record){this.record=this.config.record;this.id=this.record.id;this.name=this.record.name;this.filter=this.record.filter||{};this.filterSyntax=this.record.filterSyntax||this.collection.filterSyntax||"normalized";this.sort=this.record.sort||this.collection.sort||[];this.sortSyntax=this.record.sortyntax||this.collection.sortyntax||"normalized";this.group=this.record.group||this.collection.group||[];this.projection=this.record.projection||this.collection.projection||{};this.groupUnwind=this.record.groupUnwind||this.collection.groupUnwind||false;this.canCreateRecord=this.record.canCreateRecord!==false}else{this.id=this.config.id||kiss.tools.shortUid();this.name=this.config.name;this.filter=this.config.filter||this.collection.filter||{};this.filterSyntax=this.config.filterSyntax||this.collection.filterSyntax||"normalized";this.sort=this.config.sort||this.collection.sort||[];this.sortSyntax=this.config.sortyntax||this.collection.sortyntax||"normalized";this.group=this.config.group||this.collection.group||[];this.projection=this.config.projection||this.collection.projection||{};this.groupUnwind=this.config.groupUnwind||this.collection.groupUnwind||false;this.canCreateRecord=this.config.canCreateRecord!==false}this.collection.init({filter:this.filter,filterSyntax:this.filterSyntax,sort:this.sort,sortSyntax:this.sortSyntax,group:this.group,projection:this.projection,groupUnwind:this.groupUnwind});this.localConfig=this.getLocalConfig();if(this.localConfig){if(this.localConfig.filter)this.filter=this.localConfig.filter;if(this.localConfig.sort)this.sort=this.localConfig.sort;if(this.localConfig.group)this.group=this.localConfig.group}return this}_afterConnected(){if(this.currentSearchTerm){this.showSearchBar()}else{this.resetSearchBar()}}_afterDisconnected(){if(this.currentSearchTerm)this.hideSearchBar()}_initSubscriptions(){this.subscriptions=[subscribe("EVT_VIEW_SORTING:"+this.id,(msgData=>this._dataSort(msgData))),subscribe("EVT_VIEW_FILTERING:"+this.id,(msgData=>this._dataFilterBy(msgData))),subscribe("EVT_VIEW_GROUPING:"+this.id,(msgData=>this._dataGroupBy(msgData))),subscribe("EVT_VIEW_FIELD_TOGGLED_ONE:"+this.id,(fieldId=>this._columnsToggleOne(fieldId))),subscribe("EVT_VIEW_FIELD_TOGGLED_ALL:"+this.id,(newState=>this._columnsToggleAll(newState))),subscribe("EVT_VIEW_FIELD_MOVING:"+this.id,(msgData=>this._columnsMove(msgData.sourceFieldId,msgData.targetFieldId,msgData.position))),subscribe("EVT_DB_UPDATE:VIEW",(msgData=>{if(msgData.id!=this.id)return;if(msgData.data.filter)this.filter=msgData.data.filter;if(msgData.data.sort)this.sort=msgData.data.sort;if(msgData.data.group)this.group=msgData.data.group;if(msgData.data.projection)this.projection=msgData.data.projection;if(msgData.data.hasOwnProperty("canCreateRecord")){this.canCreateRecord=!!msgData.data.canCreateRecord;this._updateToolbar()}this.collection.hasChanged=true;if(msgData.data.config&&msgData.data.config.columns){if(this.record){this.record.config.columns=msgData.data.config.columns}else{this.config.columns=msgData.data.config.columns}this._initColumns();this.collection.hasChanged=false}this._reloadWhenNeeded(msgData,0)})),subscribe("EVT_DB_UPDATE:MODEL",(msgData=>{if(msgData.id==this.model.id){this.reload()}})),subscribe("EVT_DB_DELETE:"+this.model.id.toUpperCase(),(msgData=>{kiss.selection.delete(this.id,msgData.id)})),subscribe("EVT_DB_DELETE_MANY:"+this.model.id.toUpperCase(),(msgData=>{const filter=msgData.data;if(filter&&filter._id&&filter._id.$in){const ids=filter._id.$in;ids.forEach((id=>kiss.selection.delete(this.id,id)))}}))]}async _reloadWhenNeeded(msgData,delay){if(!this.isConnected){this.hasChanged=true;return}if(kiss.global.preventViewRefresh){return}if(kiss.session.getUserId()==msgData.userId){if(delay)await kiss.tools.wait(delay);await this.reload()}}async sortBy(sortFields){this.sort=sortFields;await this._dataSortUpdate()}async sortByField(fieldId,direction){const currentSortFields=this.sort;let isSortUpdated=false;currentSortFields.forEach((sortField=>{if(Object.keys(sortField)[0]==fieldId){sortField[fieldId]=direction;isSortUpdated=true}}));if(!isSortUpdated){currentSortFields.push({[fieldId]:direction})}await this.sortBy(currentSortFields)}async _dataSort(msgData){if(msgData.sortAction=="remove"){await this._dataSortRemove(msgData.sortIndex)}else{await this._dataSortBy(msgData.sortFieldName,msgData.sortDirection,msgData.sortIndex)}}async _dataSortBy(fieldId,sortOrder,sortIndex){let newSortOption={};newSortOption[fieldId]=sortOrder;if(this.sort.length==0){this.sort.push(newSortOption)}else{this.sort[sortIndex]=newSortOption}await this._dataSortUpdate()}async _dataSortRemove(sortIndex){this.sort.splice(sortIndex,1);await this._dataSortUpdate()}async _dataSortUpdate(){await this.collection.sortBy(this.sort);this._render();await this.updateConfig({sort:this.sort});kiss.pubsub.publish("EVT_VIEW_SORTED:"+this.id);if(this.dashboard)kiss.pubsub.publish("EVT_DASHBOARD_SETUP",this.id)}groupBy(groupFieldIds){$("grouping-field:"+this.id).setValue(groupFieldIds)}async _dataGroupBy(groupFields){this.skip=0;await this.collection.groupBy(groupFields);this._render();if(groupFields.length===0){this.buttonExpand.hide();this.buttonCollapse.hide()}else{this.buttonExpand.show();this.buttonCollapse.show()}this.group=groupFields;await this.updateConfig({group:this.group})}_groupToggle(groupId,groupLevel,rowIndex){if(this.collection.collapsedGroups.includes(groupId)){this._groupExpand(groupId,rowIndex)}else{this._groupCollapse(groupId)}}_groupExpand(groupId,rowIndex){this.collection.groupExpand(groupId,rowIndex);this._render();this._renderScroller()}_groupCollapse(groupId){this.collection.groupCollapse(groupId);this._render()}expandAll(){this.collection.groupExpandAll();this._render()}collapseAll(){this.skip=0;this.collection.groupCollapseAll();this._render()}_groupUpdateGroupingFields(){if(!this.isConnected)return;const groupingField=$("grouping-field:"+this.id);const modelFields=this._groupGetModelFields();groupingField.value=this.group;groupingField.updateOptions(modelFields)}_groupGetModelFields(config={}){const isDynamicModel=kiss.tools.isUid(this.model.id);const excludedFields=["password","link","attachment","aiImage","textarea","aiTextarea","richTextField","codeEditor","mapField"];let modelFields=this.model.fields.filter((field=>!excludedFields.includes(field.type)&&field.label&&field.deleted!=true));if(config.excludeSystemFields)modelFields=modelFields.filter((field=>!field.isSystem));if(config.excludePluginFields)modelFields=modelFields.filter((field=>!field.isFromPlugin));return modelFields.map((field=>({value:field.id,label:isDynamicModel&&!field.isSystem?field.label.toTitleCase():txtTitleCase(field.label)})))}async _dataFilterBy(filterConfig){this.resetSearchBar();this.filter=filterConfig;await this.updateConfig({filter:this.filter});this.skip=0;await this.collection.filterBy(filterConfig);this._render();if(this.dashboard)kiss.pubsub.publish("EVT_DASHBOARD_SETUP",this.id)}async updateConfig(update,needsDataReload=true){try{if(needsDataReload===false){this.collection.hasChanged=false}if(!this.record){this.updateLocalConfig(update);this.reload();return}const canUpdate=await kiss.acl.check({action:"update",record:this.record});if(!canUpdate){this.updateLocalConfig(update);this.reload();return}const newConfig=this._buildConfig(this.record,update);await this.record.update(newConfig)}catch(err){log("kiss.ui - dataComponent - Didn't save new view config",4,err)}}async reload(){if(!this.isConnected)return;if(this.columns)this._initColumns();await this.load();this._render()}updateLocalConfig(update){let currentConfig=this.getLocalConfig()||{};let newConfig=this._buildConfig(currentConfig,update);Object.assign(currentConfig,newConfig);const storageId="config-view-"+this.id;localStorage.setItem(storageId,JSON.stringify(currentConfig))}_buildConfig(record,update){let config={};if(update.hasOwnProperty("name"))config.name=update.name;if(update.hasOwnProperty("sort"))config.sort=update.sort;if(update.hasOwnProperty("filter"))config.filter=update.filter;if(update.hasOwnProperty("group"))config.group=update.group;if(update.hasOwnProperty("config")){let currentConfig=record.config||{};Object.assign(currentConfig,update.config);config.config=currentConfig}return config}getLocalConfig(){const storageId="config-view-"+this.id;const localConfig=localStorage.getItem(storageId);if(!localConfig)return false;let setup=JSON.parse(localConfig);if(setup.config&&setup.config.columns&&Array.isArray(setup.config.columns)){this.model.getFields().forEach((field=>{let column=setup.config.columns.get(field.id);if(column){column.type=this.model.getFieldType(field);column.title=field.label;if(column.title.startsWith("#"))column.title=txtTitleCase(column.title);column.title=column.title.toTitleCase();column.deleted=!!field.deleted}else{if(field.label&&field.type&&!field.deleted){setup.config.columns.push({id:field.id,type:this.model.getFieldType(field),title:field.label.toTitleCase(),hidden:field.type=="link"?true:false})}}}))}if(setup.sort){const sortableFields=this.model.getSortableFields().map((field=>field.id));setup.sort=setup.sort.filter((sort=>sortableFields.includes(Object.keys(sort)[0])))}if(setup.group){const groupableFields=this.model.getGroupableFields().map((field=>field.id));setup.group=setup.group.filter((fieldId=>groupableFields.includes(fieldId)))}return setup}async resetLocalViewParameters(){const storageId="config-view-"+this.id;localStorage.removeItem(storageId);if(this.record)await this.record.read();if(this.columns)this.resetColumnsWidth();this._initParameters();this.collection.hasChanged=true;await this.reload();return this}async _updateToolbar(){const createButton=this.querySelector("."+this.type+"-create-record");if(!createButton)return;if(this.canCreateRecord===false){createButton.hide()}else{createButton.show()}}_initColumns(columns){if(columns){this.columns=columns}else{this.columns=this.record?this.record.config.columns:this.config.columns;const localConfig=this.getLocalConfig();if(localConfig&&localConfig.config&&localConfig.config.columns)this.columns=localConfig.config.columns}if(this.columns){this.columns=this.columns.filter((column=>{if(column.type=="button")return true;const field=this.model.getField(column.id);if(field){return true}return false}));this._appendMissingColumns()}else{this.columns=this.model.getFieldsAsColumns()}this.columns=this.columns.filter((column=>{if(column.type=="button")return true;if(column.type=="link"&&this.config.showLinks===false)return false;const field=this.model.getField(column.id);if(field&&field.acl&&field.acl.read===false){return false}return true}));this.columns.forEach((column=>{if(!column.id)return;const field=this.model.getField(column.id);if(!field)return;column.title=this.model.getFieldLabel(field);if(field&&field.valueRenderer){column.renderer=field.valueRenderer}if(column.widthUnit!="rem"){column.widthUnit="rem";column.width=kiss.tools.pxToRem(column.width)}}));return this}_appendMissingColumns(){const fieldIds=this.model.fields.filter((field=>!field.deleted)).map((field=>field.id));const columnIds=this.columns.filter((column=>!column.deleted)).map((column=>column.id));const missingIds=fieldIds.filter((item=>!columnIds.includes(item)));if(missingIds.length>0){missingIds.forEach((fieldId=>{const field=this.model.getField(fieldId);if(!field.label)return;let columnConfig={id:field.id,type:this.model.getFieldType(field),title:field.label};if(field.isFromPlugin){columnConfig.isFromPlugin=true;columnConfig.pluginId=field.pluginId;columnConfig.title=txtTitleCase(field.label);columnConfig.hidden=true}if(field.isSystem){columnConfig.isSystem=true;columnConfig.title=txtTitleCase(field.label);columnConfig.hidden=field.hidden===true}this.columns.push(columnConfig)}))}}getColumns(){return this.columns}getFields(){return this.columns}_columnsToggleOne(columnId){this._columnsToggle(columnId);this._render();this.updateConfig({config:{columns:this.columns}})}_columnsToggleAll(newState){let hidden=newState=="hide";this.columns.forEach((column=>this._columnsToggle(column.id,hidden)));this._render();this.updateConfig({config:{columns:this.columns}})}_columnsToggle(columnId,hidden=null){let columnIndex=this.columns.findIndex((column=>column.id==columnId));let newState=hidden!=null?hidden:!this.columns[columnIndex].hidden;this.columns[columnIndex].hidden=newState;return this}_columnsHasHiddenColumns(){let hasHiddenColumns=false;this.columns.forEach((column=>{if(column.hidden==true)hasHiddenColumns=true}));return hasHiddenColumns}async _columnsMove(sourceColumnId,targetColumnId,position){let currentColumn=this.getColumn(sourceColumnId);let currentColumnIndex=this.columns.findIndex((column=>column.id==sourceColumnId));let newColumns=this.columns.filter((column=>column.id!=currentColumn.id));let targetColumnIndex=newColumns.findIndex((column=>column.id==targetColumnId));let adjustPositionIndex=position=="before"?0:1;if(targetColumnIndex==-1||currentColumnIndex==targetColumnIndex+adjustPositionIndex)return;newColumns.splice(targetColumnIndex+adjustPositionIndex,0,currentColumn);this.columns=newColumns;this._render();await this.updateConfig({config:{columns:this.columns}});kiss.pubsub.publish("EVT_VIEW_FIELD_MOVED:"+this.id)}getColumn(fieldId){return this.columns.find((column=>column.id==fieldId))}showFieldsWindow(x,y,color="#00aaee"){const selectionWindow=createDataFieldsWindow(this.id,color);this.selectFieldWindowId=selectionWindow.id;if(!y||!x){selectionWindow.top=()=>kiss.screen.current.height/3-selectionWindow.offsetHeight/2;selectionWindow.left=()=>kiss.screen.current.width/2-selectionWindow.offsetWidth/2;selectionWindow.render()}else{selectionWindow.showAt(x,y).render()}}showSortWindow(x,y,color="#00aaee"){const sortWindow=createDataSortWindow(this.id,color);this.sortWindowId=sortWindow.id;if(!y||!x){sortWindow.top=()=>kiss.screen.current.height/3-sortWindow.offsetHeight/2;sortWindow.left=()=>kiss.screen.current.width/2-sortWindow.offsetWidth/2;sortWindow.render()}else{sortWindow.render().showAt(x,y)}}showFilterWindow(x,y,color="#00aaee"){const filterWindow=createDataFilterWindow(this.id,color);this.filterWindowId=filterWindow.id;if(!y||!x){filterWindow.top=()=>kiss.screen.current.height/3-filterWindow.offsetHeight/2;filterWindow.left=()=>kiss.screen.current.width/2-filterWindow.offsetWidth/2;filterWindow.render()}else{filterWindow.render().showAt(x,y)}}showSearchBar(){if(kiss.screen.isMobile){return this.showMobileSearchBar()}if($("search-bar-"+this.id))return;const id=this.id;const searchButton=$("search:"+id);const searchButtonTop=searchButton.getBoundingClientRect().top;this.searchBar=createPanel({id:"search-bar-"+id,title:txtTitleCase("#ftsearch title"),icon:"fas fa-search",headerBackgroundColor:this.color||"var(--background-blue)",draggable:true,closable:false,autoSize:true,opacity:.8,top:()=>{if(!searchButton)return 0;return searchButtonTop+40},left:"calc(100vw - 30rem)",position:"absolute",width:"28rem",height:"10rem",layout:"horizontal",alignItems:"center",animation:{name:"zoomIn",speed:"faster"},items:[{id:"search-term-"+id,type:"text",fieldWidth:"22rem",borderColor:"var(--body-1)",autocomplete:"off",events:{keydown:function(event){let view=$(id);if(!view)return;if(this.getValue()==view.currentSearchTerm)return;if(event.key=="Enter"){view.currentSearchTerm=this.getValue();view.ftsearch(view.currentSearchTerm)}}}},{type:"button",icon:"fas fa-times",width:"3rem",height:"3rem",action:async()=>this.closeSearchBar()}],methods:{_afterRender(){setTimeout((()=>{if($("search-term-"+id))$("search-term-"+id).focus();this.restoreSearchTerm()}),100)},restoreSearchTerm:()=>{if($("search-term-"+id))$("search-term-"+id).setValue(this.currentSearchTerm||"")}}}).render()}showMobileSearchBar(){if($("search-term-"+this.id))return;this.switchToSearchMode();const id=this.id;this.searchBar=createBlock({target:"search-field:"+id,layout:"horizontal",alignItems:"center",animation:{name:"slideInLeft",speed:"faster"},items:[{type:"button",icon:"fas fa-times",width:"3rem",height:"3rem",action:async()=>this.closeSearchBar()},{id:"search-term-"+id,type:"text",placeholder:txtTitleCase("search"),borderColor:"var(--body-1)",autocomplete:"off",flex:1,fieldWidth:"100%",events:{keydown:function(event){let view=$(id);if(!view)return;if(this.getValue()==view.currentSearchTerm)return;if(event.key=="Enter"){view.currentSearchTerm=this.getValue();view.ftsearch(view.currentSearchTerm)}}},methods:{_afterRender(){setTimeout((()=>{if($("search-term-"+id))$("search-term-"+id).focus();this.restoreSearchTerm()}),100)},restoreSearchTerm:()=>{if($("search-term-"+id))$("search-term-"+id).setValue(this.currentSearchTerm||"")}}}]}).render()}hideSearchBar(){if(this.searchBar){if(kiss.screen.isMobile)this.searchBar.remove();else this.searchBar.close()}}async closeSearchBar(){if(this.currentSearchTerm!==undefined&&this.currentSearchTerm!==""){this.skip=0;await this.collection.find({filterSyntax:this.filterSyntax,filter:this.filter,sortSyntax:this.sortSyntax,sort:this.sort,group:this.group,projection:this.projection,groupUnwind:this.groupUnwind},true);this._render()}this.resetSearchBar()}resetSearchBar(){this.currentSearchTerm="";this.hideSearchBar();if(this.resetSearchMode)this.resetSearchMode()}async ftsearch(value){const searchFilter=this.createSearchFilter(value);this.skip=0;await this.collection.find({filterSyntax:this.filterSyntax,filter:searchFilter,sortSyntax:this.sortSyntax,sort:this.sort,group:this.group,projection:this.projection,groupUnwind:this.groupUnwind},true);this._render()}createSearchFilter(value){const model=this.model||this.collection.model;const textFields=model.getFieldsByType(["text","textarea","aiTextarea","richTextField","select","selectViewColumn","selectViewColumns","date","lookup","directory","map"]);const textFilters=textFields.map((field=>({type:"filter",fieldId:field.id,fieldLabel:field.label,operator:"contains",value:value})));return{type:"group",operator:"and",filters:[{type:"group",operator:"or",filters:textFilters},this.filter]}}async selectRecordById(recordId){let record=await this.collection.findOne(recordId);await this.selectRecord(record)}async selectRecord(record){createForm(record)}async createRecord(model){const newRecord=model.create();await newRecord.save();createForm(newRecord)}getSelection(){this.selectedRecords=kiss.selection.get(this.id);return this.selectedRecords}getSelectedRecords(){let records=[];for(let id of this.getSelection())records.push(this.collection.getRecord(id));return records}toggleSelection(){if(this._pageHasUnselectedRows()){const ids=this._getVisibleIds();kiss.selection.insertMany(this.id,ids)}else{kiss.selection.reset(this.id)}this._renderSelectionRestore()}deselectAll(){kiss.selection.reset(this.id);this._renderSelectionRestore()}selectRange(rangeStart,rangeEnd){const loadingId=kiss.loadingSpinner.show();setTimeout((()=>{let selectedIds=[];this.collection.records.forEach(((record,index)=>{if(record.$type=="group")return;if(index>=rangeStart&&index<=rangeEnd)selectedIds.push(record.id)}));kiss.selection.insertMany(this.id,selectedIds);this._renderSelectionRestore();kiss.loadingSpinner.hide(loadingId)}),0)}async export(){const exportSelection={datatable:true,calendar:false,kanban:false,timeline:true,gallery:true};const canExportSelection=exportSelection[this.type];createPanel({id:"export-setup",title:txtTitleCase("#export view"),icon:"fas fa-cloud-download-alt",modal:true,backdropFilter:true,closable:true,draggable:true,align:"center",verticalAlign:"center",width:"40rem",layout:"vertical",items:[{id:"export-type",label:txtTitleCase("format"),labelPosition:"top",type:"select",value:"xls",options:[{label:"EXCEL",color:"var(--green)",value:"xls"},{label:"CSV",color:"var(--blue)",value:"csv"},{label:"JSON",color:"var(--orange)",value:"json"}]},{hidden:!canExportSelection,id:"export-set",label:txtTitleCase("#export target"),labelPosition:"top",type:"select",value:"selection",options:[{label:txtTitleCase("#all view records"),value:"all"},{label:txtTitleCase("#selected documents"),value:"selection"}]},{type:"button",text:txtTitleCase("export"),icon:"fas fa-bolt",height:"4rem",margin:"2rem 0 0 0",action:async()=>{const exportType=$("export-type").getValue();const exportSet=canExportSelection?$("export-set").getValue():"all";let exportString;let records;let mimeType;let extension;if(exportSet=="selection"){records=this.getSelectedRecords();if(records.length==0)return createNotification(txtTitleCase("#no selection"))}else{records=await this.collection.find({});records=records.filter((record=>record.$type!="group"))}if(exportType=="xls"){mimeType="application/application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";extension="xls";const columns=this.columns.filter((column=>!column.hidden&&column.type!="link"));exportString="<table border=1 borderColor=#cccccc><tr>";exportString+=columns.map((column=>`<th style="background-color: #00aaee; color: #ffffff; font-size: 1.6rem;">${column.title}</th>`)).join("");exportString+="<tr>";for(let record of records){const data=await record.getData({convertNames:true,includeLinks:false});exportString+="<tr>";exportString+=columns.map((column=>`<td>${data[column.id]}</td>`)).join("");exportString+="</tr>"}exportString+="</table>"}else if(exportType=="json"){mimeType="application/json";extension="json";let exportRecords=[];for(let record of records)exportRecords.push(await record.getData({useLabels:true,convertNames:true,includeLinks:false}));exportString=JSON.stringify(exportRecords)}else{mimeType="text/csv";extension="csv";const columns=this.columns.filter((column=>!column.hidden&&column.type!="link"));exportString=columns.map((column=>column.title)).join(",");exportString+="\n";for(let record of records){const data=await record.getData({convertNames:true,includeLinks:false});exportString+=columns.map((column=>data[column.id])).join(",");exportString+="\n"}}const encodedData=encodeURIComponent("\ufeff"+exportString);const dataURI=`data:${mimeType};charset=utf-8,${encodedData}`;const sourceUrl=`<br><br><center><a href="${dataURI}" download="export.${extension}">${txtTitleCase("download file")}</a></center>`;createDialog({type:"message",title:txtTitleCase("#export view"),message:txtTitleCase("#click to download")+sourceUrl,noOK:true});$("export-setup").close()}}]}).render()}async copySelectionToClipboard(){const ids=kiss.selection.get(this.id);if(ids.length==0)return createNotification(txtTitleCase("#no selection"));const records=this.collection.records.filter((record=>ids.includes(record.id)));let clipboardData="";for(const record of records){const recordData=await record.getData({convertNames:true});this.columns.forEach((column=>{if(column.hidden)return;let value=recordData[column.id];value=this.formatValueForClipboard(column,value);clipboardData+=value+"\t"}));clipboardData+="\n"}kiss.tools.copyTextToClipboard(clipboardData);createNotification(txtTitleCase("copied to clipboard"))}formatValueForClipboard(column,value){if(value==undefined)return"";if(column.type=="link"||column.type=="password"){value=""}else if(typeof value=="string"&&(value.includes("\n")||value.includes('"'))){value=`"${value.replace(/"/g,'""')}"`}else if(Array.isArray(value)){if(column.type=="attachment"||column.type=="aiImage"){value=value.map((attachment=>attachment.filename)).join(", ")}else{value=value.join(", ")}}else if(value===true){value="☑"}else if(value===false){value="☐"}return value}_pageHasUnselectedRows(){let hasUnselectedRows=false;const rows=this.querySelectorAll("."+this.type+"-row");Array.from(rows).every((row=>{if(row.classList.contains(this.type+"-row-selected")){return true}else{hasUnselectedRows=true;return false}}));return hasUnselectedRows}_getVisibleIds(){const rows=this.querySelectorAll("."+this.type+"-row");return Array.from(rows).map((row=>row.getAttribute("recordid")))}async _buildActionMenu(){let actions=[];let buttonLeftPosition=$("actions:"+this.id).offsetLeft;let buttonTopPosition=$("actions:"+this.id).offsetTop;if(this.actions.length){actions=actions.concat(this.actions)}if(actions.length==0){return}if(kiss.app.customActions&&kiss.app.customActions.length>0){const userACL=kiss.session.getACL();let customActions=kiss.app.customActions.filter((action=>{const isTargetView=action.type&&action.type.includes("view")&&action.viewIds&&(action.viewIds.includes(this.id)||action.viewIds.includes("*"));const isTargetUser=kiss.tools.intersects(userACL,action.accessRead);return isTargetView&&isTargetUser}));actions.push("-");customActions.forEach((action=>{const menuAction={id:action.id,text:action.name,icon:action.icon,iconColor:action.color,action:()=>{kiss.context.view=this;eval(action.code)}};actions.push(menuAction)}))}createMenu({top:buttonTopPosition,left:buttonLeftPosition,items:actions}).render()}};kiss.ui.Block=class Block extends kiss.ui.Container{constructor(){super()}init(config){super.init(config);if(config.fullscreen){this.style.display="block";this.style.position="fixed";this.style.top="0px";this.style.left="0px";this.style.width="100%";this.style.height="100%"}this.container=this;this._setProperties(config,[[["draggable"],[this]],[["display","padding","margin","position","top","left","right","overflow","overflowX","overflowY","flex","flexFlow","flexWrap","flexGrow","flexShrink","alignItems","alignContent","justifyContent","width","height","minWidth","minHeight","maxWidth","maxHeight","background","backgroundColor","backgroundImage","backgroundSize","border","borderStyle","borderWidth","borderColor","borderRadius","boxShadow","zIndex","transform"],[this.style]]]);return this}setInnerHtml(html){this.innerHTML=html;return this}getInnerHtml(){return this.innerHTML}};customElements.define("a-block",kiss.ui.Block);const createBlock=config=>document.createElement("a-block").init(config);kiss.ui.Panel=class Panel extends kiss.ui.Container{constructor(){super()}init(config){super.init(config);const id=this.id;this.innerHTML=`${config.collapsible==true&&config.draggable!=true?`<div id="panel-header-${id}" class="panel-header panel-header-collapsible">`:`<div id="panel-header-${id}" class="panel-header ${config.draggable==true?"panel-header-draggable":""}">`}\n                <span id="panel-icon-${id}" class="panel-icon ${config.icon?config.icon:""}"></span>\n                <span id="panel-title-${id}" class="panel-title">${config.title||""}</span>\n                <span style="flex:1"></span>\n                <span class="panel-custom-buttons"></span>\n                <span class="panel-custom-icons"></span>\n\n                ${config.collapsible?`<span id="panel-button-expand-collapse-${id}" class="fas fa-chevron-down panel-buttons panel-button-expand-collapse"></span>`:""}\n                ${config.expandable?`<span id="panel-button-maximize-${id}" class="fas fa-expand panel-buttons panel-button-expand"></span>`:""}\n                ${config.closable?`<span id="panel-button-close-${id}" class="fas fa-times panel-buttons panel-button-close"></span>`:""}\n            </div>\n            \n            <div tabindex=1 id="panel-body-${id}" class="panel-body ${config.header==false?"panel-body-no-header":""}">\n            </div>`.removeExtraSpaces();if(config.modal==true){this.mask=document.createElement("div");this.mask.setAttribute("id","panel-mask-"+id);this.mask.classList.add("panel-mask");this.mask.onmousedown=()=>{if(config.closable!==false)$(id).close()};if(config.zIndex)this.mask.style=`z-index: ${config.zIndex}`;if(config.backdropFilter){if(config.backdropFilter===true){this.mask.style.backdropFilter="var(--backdrop-filter)"}else{this.mask.style.backdropFilter=config.backdropFilter}}document.body.appendChild(this.mask)}this.panelHeader=this.querySelector(".panel-header");this.panelTitle=this.querySelector(".panel-title");this.panelIcon=this.querySelector(".panel-icon");this.panelButtonExpandCollapse=this.querySelector(".panel-button-expand-collapse");this.panelButtons=this.querySelectorAll(".panel-buttons");this.panelCustomButtons=this.querySelector(".panel-custom-buttons");this.panelCustomIcons=this.querySelector(".panel-custom-icons");this.panelBody=this.container=this.querySelector(".panel-body");config.position=config.draggable?"fixed":config.modal?"absolute":config.position||"relative";if(config.borderRadius&&typeof config.borderRadius=="number"){let r=config.borderRadius;config.borderRadius=`${r}px ${r}px ${r}px ${r}px`}if(config.header!==false&&config.borderRadius&&config.borderRadius.split(" ").length==4){const borderRadiusConfig=config.borderRadius.split(" ");const topLeftBorderRadius=borderRadiusConfig[0];const topRightBorderRadius=borderRadiusConfig[1];const bottomRightBorderRadius=borderRadiusConfig[2];const bottomLeftBorderRadius=borderRadiusConfig[3];config.headerBorderRadius=topLeftBorderRadius+" "+topRightBorderRadius+" 0 0";config.bodyBorderRadius="0 0 "+bottomRightBorderRadius+" "+bottomLeftBorderRadius}if(config.headerBackgroundColor&&config.headerBackgroundColor2){let gradientDirection=config.headerGradientDirection||"to right";config.headerBackgroundColor=`linear-gradient(${gradientDirection}, ${config.headerBackgroundColor}, ${config.headerBackgroundColor2})`}this._setProperties(config,[[["position","top","bottom","left","right","flex","margin","border","borderColor","borderRadius","boxShadow","transform","zIndex","opacity"],[this.style]],[["headerHeight=height","headerBackgroundColor=background","headerBorderColor=borderColor","headerBorderRadius=borderRadius"],[this.panelHeader.style]],[["headerColor=color"],[this.panelTitle.style]],[["headerColor=color","iconColor=color","iconSize=fontSize"],[this.panelIcon.style]],[["headerColor=color"],Array.from(this.panelButtons).map((panelButton=>panelButton.style))],[["display","flexFlow","flexWrap","alignItems","alignContent","justifyContent","padding","overflow","overflowX","overflowY","background","backgroundColor","backgroundImage","backgroundSize","borderRadius","bodyBorderRadius=borderRadius"],[this.panelBody.style]],[["maskBackgroundColor=backgroundColor"],[this.mask?.style]]]);if(config.header==false)this.panelHeader.style.display="none";if(config.closable)this.isClosable=true;this.closeMethod=config.closeMethod||"remove";if(config.draggable==true){this.isDraggable=true;this._enableDrag()}if(config.draggable||config.align=="center"||config.verticalAlign=="center"){this.subscriptions.push(subscribe("EVT_WINDOW_RESIZED",(()=>this.updateLayout())))}if(config.autoSize===true){kiss.screen.getResizeObserver().observe(this.panelBody)}if(config.expandable)this.isExpandable=true;this.expanded=true;if(config.collapsible)this.isCollapsible=true;if(config.collapsed){setTimeout((()=>this.collapse()),0)}if(config.headerButtons){config.headerButtons.forEach((button=>this.addHeaderButton(button)))}if(config.headerIcons){config.headerIcons.filter((icon=>icon.hidden!==true)).forEach((icon=>this.addHeaderIcon(icon)))}this._initHeaderClickEvent();return this}_initHeaderClickEvent(){this.panelHeader.onclick=function(event){const element=event.target;let panel=element.closest("a-panel");if(element.classList.contains("panel-button-close")){panel.close()}else if(element.classList.contains("panel-button-expand")){panel.maximize(20)}else if(element.classList.contains("panel-button-expand-collapse")||element.classList.contains("panel-header-collapsible")){panel.expandCollapse()}else if((element.classList.contains("panel-title")||element.classList.contains("panel-icon"))&&panel.config.collapsible===true&&panel.config.draggable!==true){panel.expandCollapse()}}}setIcon(iconClass){this.config.icon=iconClass;this.panelIcon.className="panel-icon "+iconClass;return this}setHeaderColor(color){this.config.headerColor=color;this.panelIcon.style.color=color;this.panelTitle.style.color=color;Array.from(this.panelButtons).forEach((panelButton=>panelButton.style.color=color));return this}setHeaderBackgroundColor(color,color2,direction){this.config.headerBackgroundColor=color;if(color2)this.config.headerBackgroundColor2=color2;let bgColor=color;if(color2){let bgDirection="to right";if(direction){this.config.headerGradientDirection=bgDirection=direction}bgColor=`linear-gradient(${bgDirection}, ${color}, ${color2})`}this.panelHeader.style.backgroundColor=bgColor;return this}addHeaderButton(config){const button=createButton(config);button.classList.add("panel-button");this.panelCustomButtons.appendChild(button);return this}addHeaderIcon(config){if(!config.icon)return;const icon=document.createElement("span");icon.setAttribute("id",kiss.tools.shortUid());icon.classList.add("panel-buttons",...config.icon.split(" "));if(config.action)icon.onclick=config.action;if(config.tip)icon.attachTip(config.tip);if(config.margin)icon.style.margin=config.margin;this.panelCustomIcons.appendChild(icon);return this}setTitle(newTitle){this.panelTitle.innerHTML=newTitle;return this}setInnerHtml(html){this.panelBody.innerHTML=html;return this}getInnerHtml(){return this.panelBody.innerHTML}close(closeMethod,forceClose=false){const closeEvent=this.config?.events?.onclose||this.config?.events?.onClose||this.config?.events?.close;if(closeEvent){const doClose=closeEvent(forceClose);if(doClose===false)return false}let method=closeMethod||this.closeMethod;if(method=="hide"){this.hide();if(this.mask)this.mask.hide()}else{kiss.views.remove(this.id);if(this.mask)kiss.views.remove("panel-mask-"+this.id)}return true}collapse(){if(this.config.header===false)return;if(this.expanded){let panelBorderWidth=Number(getComputedStyle(this,"")["border-width"].replace("px",""));this.style.height=(this.panelHeader.offsetHeight+2*panelBorderWidth).toString()+"px";this.panelBody.style.height="0px";this.panelBody.style.padding="0px";this.panelButtonExpandCollapse.classList.remove("fa-chevron-down");this.panelButtonExpandCollapse.classList.add("fa-chevron-right");this.expanded=false;const collapseEvent=this.config?.events?.oncollapse||this.config?.events?.onCollapse||this.config?.events?.collapse;if(collapseEvent){collapseEvent()}}return this}expand(){if(this.config.header===false)return;if(!this.expanded){if(this.config.height){this._setHeight()}else{this.style.height="";this.panelBody.style.height="";this.panelBody.style.padding=""}this.panelButtonExpandCollapse.classList.remove("fa-chevron-right");this.panelButtonExpandCollapse.classList.add("fa-chevron-down");this.expanded=true;const expandEvent=this.config?.events?.onexpand||this.config?.events?.onExpand||this.config?.events?.expand;if(expandEvent){expandEvent()}}return this}expandCollapse(){if(!this.isCollapsible)return;if(this.expanded){this.collapse()}else{this.expand()}return this}setCollapsible(status){this.isCollapsible=status;return this}maximize(delta=0,state){if(this.isFullscreen&&state==true)return;if(!this.isFullscreen&&state===false)return;if(this.isFullscreen!=true||state==true){this.isFullscreen=true;this.fullscreenDelta=delta;this.currentWidth=this.config.width||this.clientWidth;this.currentHeight=this.config.height||this.clientHeight;this.currentTop=this.config.top;this.currentLeft=this.config.left;this.config.width=()=>kiss.screen.current.width-delta;this.config.height=()=>kiss.screen.current.height-delta;this.config.top=delta/2;this.config.left=delta/2}else if(this.isFullscreen==true||state===false){this.isFullscreen=false;this.config.width=this.currentWidth;this.config.height=this.currentHeight;this.config.top=this.currentTop;this.config.left=this.currentLeft}this.updateLayout();return this}minimize(){this.maximize(this.fullscreenDelta,false);return this}showHeader(){this.panelHeader.show();return this}hideHeader(){this.panelHeader.hide();return this}showMask(){this.mask.show();return this}hideMask(){this.mask.hide();return this}_enableDrag(){let _this=this;let deltaX=0;let deltaY=0;let posX=0;let posY=0;let header=_this.querySelector(".panel-header");if(header.style.display!="none"){header.onmousedown=dragStart}else{_this.onmousedown=dragStart}function dragStart(e){e=e||window.event;e.stop();posX=e.clientX;posY=e.clientY;document.onmouseup=dragStop;document.onmousemove=dragMove}function dragMove(e){e=e||window.event;if(e.target.nodeName=="INPUT"){dragStop(e);return e}e.stop();deltaX=posX-e.clientX;deltaY=posY-e.clientY;posX=e.clientX;posY=e.clientY;_this.style.opacity="0.8";_this.style.top=_this.offsetTop-deltaY+"px";_this.style.left=_this.offsetLeft-deltaX+"px"}function dragStop(e){e=e||window.event;e.stop();_this.style.opacity="1";document.onmouseup=null;document.onmousemove=null}}};customElements.define("a-panel",kiss.ui.Panel);const createPanel=config=>document.createElement("a-panel").init(config);kiss.ui.Calendar=class Calendar extends kiss.ui.DataComponent{constructor(){super()}init(config){config.autoSize=true;super.init(config);this.showToolbar=config.showToolbar!==false;this.showActions=config.showActions!==false;this.showSetup=config.showSetup!==false;this.canSearch=config.canSearch!==false;this.canFilter=config.canFilter!==false;this.canSelectFields=config.canSelectFields!==false;this.canChangePeriod=config.canChangePeriod!==false;this.color=config.color||"#00aaee";this.actions=config.actions||[];let id=this.id;this.innerHTML=`<div id="calendar-toolbar:${id}" class="calendar-toolbar">\n                <div id="create:${id}"></div>\n                <div id="actions:${id}"></div>\n                <div id="setup:${id}"></div>\n                <div id="select:${id}"></div>\n                <div id="filter:${id}"></div>\n                <div id="refresh:${id}"></div>\n                <div class="spacer"></div>\n                <div id="title:${id}" class="calendar-title"></div>\n                <div class="spacer"></div>\n                <div id="pager-index:${id}" class="calendar-toolbar-pager-index"></div>\n                <div id="pager-mode:${id}"></div>\n                <div id="pager-previous:${id}"></div>\n                <div id="pager-next:${id}"></div>\n                <div id="pager-today:${id}"></div>\n                <div id="layout:${id}"></div>\n            </div>\n            <div id="calendar-body:${id}" class="calendar-body">`.removeExtraSpaces();this.calendar=this.querySelector(".calendar");this.calendarToolbar=this.querySelector(".calendar-toolbar");this.calendarBody=this.querySelector(".calendar-body");this._initColumns(config.columns)._initCalendarParams(config)._initTexts()._initElementsVisibility()._initEvents()._initSubscriptions();return this}async load(){try{log(`kiss.ui - Calendar ${this.id} - Loading collection <${this.collection.id} (changed: ${this.collection.hasChanged})>`);await this.collection.find({filterSyntax:this.filterSyntax,filter:this.filter});this._renderToolbar();this.showCalendar(this.date)}catch(err){log(err);log(`kiss.ui - Calendar ${this.id} - Couldn't load data properly`)}}async reload(){await this.load();this._initColumns();this._render()}updateLayout(){if(this.isConnected){this._render()}}async setColor(newColor){this.color=newColor;Array.from(this.calendarToolbar.children).forEach((item=>{if(item&&item.firstChild&&item.firstChild.type=="button")item.firstChild.setIconColor(newColor)}));this._render()}showCalendar(date){if(typeof date=="string"&&kiss.tools.isISODate(date,true))date=new Date(date);const animation=date.toISO()==this.date.toISO()?"fadeIn":date.toISO()<this.date.toISO()?"slideInLeft":"slideInRight";this.date=date;this._render();this.calendarBody.setAnimation({name:animation,speed:"light"});return this}showSetupWindow(){let dateFields=this.model.getFieldsByType("date").filter((field=>!field.deleted)).map((field=>({value:field.id,label:field.label.toTitleCase()})));let timeFields=this.model.getFieldsByType("select").filter((field=>!field.deleted&&field.template=="time")).map((field=>({value:field.id,label:field.label.toTitleCase()})));createPanel({icon:"fas fa-calendar",title:txtTitleCase("setup the calendar"),headerBackgroundColor:this.color,modal:true,backdropFilter:true,draggable:true,closable:true,align:"center",verticalAlign:"center",width:"40rem",defaultConfig:{labelPosition:"top",optionsColor:this.color},items:[{type:"select",id:"calendar-datefield:"+this.id,label:txtTitleCase("date field used"),options:dateFields,maxHeight:()=>kiss.screen.current.height-200,value:this.dateField,events:{change:async function(){let dateField=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{dateField:dateField})}}},{type:"select",id:"calendar-timefield:"+this.id,label:txtTitleCase("time field used"),options:timeFields,maxHeight:()=>kiss.screen.current.height-200,value:this.timeField,events:{change:async function(){let timeField=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{timeField:timeField})}}},{type:"select",id:"calendar-period:"+this.id,label:txtTitleCase("default period"),options:[{label:txtTitleCase("month"),value:"month"},{label:"3 "+txtTitleCase("weeks"),value:"3 weeks"},{label:"2 "+txtTitleCase("weeks"),value:"2 weeks"},{label:"1 "+txtTitleCase("week"),value:"1 week"},{label:"1 "+txtTitleCase("week")+" + "+txtTitleCase("details"),value:"1 week + details"}],value:this.period||"month",events:{change:async function(){let period=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{period:period})}}},{type:"checkbox",id:"calendar-showWeekend:"+this.id,label:txtTitleCase("show week-ends"),labelPosition:"right",shape:"switch",iconColorOn:this.color,value:this.showWeekend,events:{change:async function(){let showWeekend=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{showWeekend:showWeekend});if(showWeekend==true){$("calendar-startOnMonday:"+viewId).show()}else{$("calendar-startOnMonday:"+viewId).hide()}}}},{hidden:!this.showWeekend,type:"checkbox",id:"calendar-startOnMonday:"+this.id,label:txtTitleCase("weeks start on monday"),labelPosition:"right",shape:"switch",iconColorOn:this.color,value:this.startOnMonday,events:{change:async function(){let startOnMonday=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{startOnMonday:startOnMonday})}}}]}).render()}showFieldsWindow(){let selectionButton=$("select:"+this.id);const box=selectionButton.getBoundingClientRect();super.showFieldsWindow(box.left,box.top+40,this.color)}showFilterWindow(){super.showFilterWindow(null,null,this.color)}_initCalendarParams(config){this.date=this.config.date||new Date;if(this.record){this.dateField=config.dateField||this.record.config.dateField;this.timeField=config.timeField||this.record.config.timeField;this.period=config.period||this.record.config.period||"month";this.startOnMonday=config.hasOwnProperty("startOnMonday")?!!config.startOnMonday:this.record.config.startOnMonday!==false;this.showWeekend=config.hasOwnProperty("showWeekend")?!!config.showWeekend:this.record.config.showWeekend!==false}else{this.dateField=config.dateField||this.config.dateField;this.timeField=config.timeField||this.config.timeField;this.period=config.period||this.config.period||"month";this.startOnMonday=config.hasOwnProperty("startOnMonday")?!!config.startOnMonday:this.config.startOnMonday!==false;this.showWeekend=config.hasOwnProperty("showWeekend")?!!config.showWeekend:this.config.showWeekend!==false}if(!this.dateField){let modelDateFields=this.model.getFieldsByType(["date"]);if(modelDateFields.length!=0){this.dateField=modelDateFields[0].id}else{this.dateField="createdAt"}}if(!this.timeField&&this.timeField!==""){let modelTimeFields=this.model.getFieldsByType(["select"]);modelTimeFields=modelTimeFields.filter((field=>field.template=="time"));if(modelTimeFields.length!=0){this.timeField=modelTimeFields[0].id}}return this}_initElementsVisibility(){if(this.showToolbar==false)this.calendarToolbar.style.display="none";return this}_initSubscriptions(){super._initSubscriptions();const viewModelId=this.modelId.toUpperCase();this.subscriptions=this.subscriptions.concat([subscribe("EVT_VIEW_SETUP:"+this.id,(msgData=>this._updateConfig(msgData))),subscribe("EVT_DB_INSERT:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_UPDATE:"+viewModelId,(msgData=>this._updateOneAndReload(msgData))),subscribe("EVT_DB_DELETE:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_INSERT_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_DELETE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_BULK",(msgData=>this._reloadWhenNeeded(msgData,2e3)))]);return this}_initEvents(){this.onclick=async event=>{const clickedElement=event.target;const recordElement=clickedElement.closest(".calendar-record");if(!recordElement)return;if(recordElement.classList.contains("calendar-record")){const recordId=recordElement.getAttribute("recordid");const record=await this.collection.getRecord(recordId);await this.selectRecord(record);return event}};return this}_render(){switch(this.period){case"month":return this._renderAsWeeks(6);case"3 weeks":return this._renderAsWeeks(3);case"2 weeks":return this._renderAsWeeks(2);case"1 week":return this._renderAsWeeks(1);case"1 week + details":return this._renderAsWeeks(1,true);default:return this._renderAsWeeks(6)}}_renderAsWeeks(numberOfWeeks,expanded){let date=this.date;let currentMonth=date.getMonth();let currentDate=this.startOnMonday?this._getPreviousMonday(date):this._getPreviousSunday(date);this.startDate=currentDate;switch(this.period){case"month":this.date.setDate(1);break;default:this.date=this._getPreviousMonday(this.date)}let calendarHTML=`\n            <div class="calendar-header">\n                ${this.weekDays.map((day=>`<div class="calendar-header-title">${day}</div>`)).join("")}\n            </div>`;for(let weekIndex=1;weekIndex<=numberOfWeeks;weekIndex++){calendarHTML+=`<div class="calendar-week">`;for(let dayIndex=1;dayIndex<=7;dayIndex++){let day=currentDate.getDate();let month=currentDate.getMonth();let year=currentDate.getFullYear();let dayId=this._getDayId(day,month+1,year);let dayClass="";if(currentDate.getDay()==0||currentDate.getDay()==6){dayClass=this.showWeekend?"calendar-weekend":"calendar-no-weekend"}if(month!=currentMonth)day=`<span class="calendar-otherMonth">${day}</span>`;calendarHTML+=`<div class="calendar-day ${dayClass}"><div>${day}</div><div class="day-items" id="${dayId}"></div></div>`;currentDate=new Date(kiss.formula.ADJUST_DATE(currentDate,0,0,1,0,0,0))}calendarHTML+=`</div>`}this.endDate=currentDate;this._renderToolbarTitle();this.calendarBody.innerHTML=calendarHTML;this._renderRecords(expanded);this._renderToday();return this}_renderRecords(expanded){const startDateISO=this.startDate.toISO();const endDateISO=this.endDate.toISO();let records=this.collection.records.filter((record=>{const date=record[this.dateField];if(date instanceof Date)return date>=this.startDate&&date<=this.endDate;return date>=startDateISO&&date<=endDateISO}));if(this.timeField)records=records.sortBy(this.timeField);records.forEach((record=>{const date=new Date(record[this.dateField]).toISO();const calendarCell=$(date);if(!calendarCell)return;const recordHtml=document.createElement("div");recordHtml.innerHTML=!expanded?this._renderRecord(record):this._renderRecordAsCard(record);recordHtml.classList.add("calendar-record");recordHtml.style.borderColor=this.model.color;recordHtml.setAttribute("recordid",record.id);calendarCell.appendChild(recordHtml)}))}_renderRecord(record){let recordHtml=(this.timeField?record[this.timeField]:"")||"";if(recordHtml)recordHtml=`<span style="color: ${this.model.color}">${recordHtml}</span>`;this.columns.filter((column=>column.hidden!==true)).forEach((column=>{let field=this.model.getField(column.id);if(!field)return;let value=record[column.id];if(!value&&value!==false&&value!==0)return;recordHtml+=" · "+this._renderSingleValue(field,value,record)}));return recordHtml}_renderToday(){let today=(new Date).toISO();let todayCell=$(today);if(!todayCell)return;let day=todayCell.parentNode.children[0];day.classList.add("calendar-today");day.style.color="#ffffff";day.style.backgroundColor=this.color}_renderRecordAsCard(record){let recordHtml=(this.timeField?record[this.timeField]:"")||"";if(recordHtml)recordHtml=`<span style="color: ${this.model.color}">${recordHtml}</span>`;this.columns.filter((column=>column.hidden!==true)).forEach((column=>{let field=this.model.getField(column.id);if(!field)return;if(["attachment","password","link"].includes(field.type))return;let value=record[column.id];if(!value&&value!==false&&value!==0)return;let valueHtml=this._renderSingleValue(field,value,record);recordHtml+=`\n                    <div class="calendar-record-field">\n                        <div class="calendar-record-label">${field.label} ${field.unit?`(${field.unit})`:""}</div>\n                        <div class="calendar-record-value">${valueHtml}</div>\n                    </div>\n                `.removeExtraSpaces()}));return recordHtml}_renderSingleValue(field,value,record){const renderer=kiss.fields.renderers[this.model.id][field.id];const type=kiss.fields.getFieldType(field);switch(type){case"date":case"textarea":case"aiTextarea":case"select":case"directory":case"checkbox":case"rating":case"color":case"icon":case"selectViewColumn":return renderer({value:value,record:record});case"number":case"slider":return renderer({value:value,record:record,config:{unit:false}});default:return value}}async _updateOneAndReload(msgData){const filterFields=kiss.db.mongo.getFilterFields(this.filter);let dateHasChanged=false;let timeHasChanged=false;let filterHasChanged=false;let updates=msgData.data;for(let fieldId of Object.keys(updates)){if(this.dateField==fieldId)dateHasChanged=true;if(this.timeField==fieldId)timeHasChanged=true;if(filterFields.indexOf(fieldId)!=-1)filterHasChanged=true}if(dateHasChanged||timeHasChanged||filterHasChanged){this._reloadWhenNeeded(msgData,2e3)}else{this._updateRecord(msgData.id)}}_updateRecord(recordId){const record=this.collection.getRecord(recordId);const recordNode=document.querySelector(`.calendar-record[recordid="${recordId}"]`);if(recordNode){const replacementNode=document.createElement("div");replacementNode.classList.add("calendar-record");replacementNode.style.borderColor=this.model.color;replacementNode.innerHTML=this.period.includes("details")?this._renderRecordAsCard(record):this._renderRecord(record);recordNode.parentNode.replaceChild(replacementNode,recordNode);replacementNode.setAttribute("recordid",recordId)}}async _updateConfig(newConfig){if(newConfig.hasOwnProperty("dateField"))this.dateField=newConfig.dateField;if(newConfig.hasOwnProperty("timeField"))this.timeField=newConfig.timeField;if(newConfig.hasOwnProperty("period"))this.period=newConfig.period;if(newConfig.hasOwnProperty("startOnMonday"))this.startOnMonday=newConfig.startOnMonday;if(newConfig.hasOwnProperty("showWeekend"))this.showWeekend=newConfig.showWeekend;this._initTexts();this._render();let currentConfig;if(this.record){currentConfig=this.record.config}else{currentConfig={dateField:this.dateField,timeField:this.timeField,period:this.period,startOnMonday:this.startOnMonday,showWeekend:this.showWeekend,columns:this.columns}}let config=Object.assign(currentConfig,newConfig);await this.updateConfig({config:config})}_renderToolbar(){if(this.isToolbarRendered)return;this.isToolbarRendered=true;createButton({hidden:!this.canCreateRecord,class:"calendar-create-record",target:"create:"+this.id,text:this.config.createRecordText||this.model.name.toTitleCase(),icon:"fas fa-plus",iconColor:this.color,borderWidth:"0.3rem",borderRadius:"3.2rem",maxWidth:kiss.screen.isMobile&&kiss.screen.isVertical()?"16rem":null,action:async()=>this.createRecord(this.model)}).render();createButton({hidden:!this.showSetup,target:"setup:"+this.id,tip:txtTitleCase("setup the calendar"),icon:"fas fa-cog",iconColor:this.color,width:"3.2rem",action:()=>this.showSetupWindow()}).render();createButton({hidden:!this.canSelectFields,target:"select:"+this.id,tip:txtTitleCase("#display fields"),icon:"fas fa-bars fa-rotate-90",iconColor:this.color,width:"3.2rem",action:()=>this.showFieldsWindow()}).render();createButton({hidden:!this.canFilter,target:"filter:"+this.id,tip:txtTitleCase("to filter"),icon:"fas fa-filter",iconColor:this.color,width:"3.2rem",action:()=>this.showFilterWindow()}).render();if(this.canChangePeriod){let _this=this;createSelect({target:"pager-mode:"+this.id,id:"pager-mode:"+this.id,options:[{label:txtTitleCase("month"),value:"month"},{label:"3 "+txtTitleCase("weeks"),value:"3 weeks"},{label:"2 "+txtTitleCase("weeks"),value:"2 weeks"},{label:"1 "+txtTitleCase("week"),value:"1 week"},{label:"1 "+txtTitleCase("week")+" + "+txtTitleCase("details"),value:"1 week + details"}],optionsColor:this.color,value:this.period||"month",fieldWidth:"15rem",styles:{this:"align-items: center;","field-label":"white-space: nowrap;","field-select":"white-space: nowrap;"},events:{change:async function(){_this.period=this.getValue();_this._render()}}}).render()}createButton({target:"pager-previous:"+this.id,icon:"fas fa-chevron-left",iconColor:this.color,width:"3.2rem",events:{click:()=>{let previousDate;switch(this.period){case"month":previousDate=kiss.formula.ADJUST_DATE(this.date,0,-1,0,0,0,0);break;case"3 weeks":previousDate=kiss.formula.ADJUST_DATE(this.startDate,0,0,-21,0,0,0);break;case"2 weeks":previousDate=kiss.formula.ADJUST_DATE(this.startDate,0,0,-14,0,0,0);break;case"1 week":case"1 week + details":previousDate=kiss.formula.ADJUST_DATE(this.startDate,0,0,-7,0,0,0);break;default:}this.showCalendar(previousDate)}}}).render();createButton({target:"pager-next:"+this.id,icon:"fas fa-chevron-right",iconColor:this.color,width:"3.2rem",events:{click:()=>{let nextDate;switch(this.period){case"month":nextDate=kiss.formula.ADJUST_DATE(this.date,0,1,0,0,0,0);break;default:nextDate=kiss.formula.ADJUST_DATE(this.endDate,0,0,1,0,0,0)}this.showCalendar(nextDate)}}}).render();const todayButton={target:"pager-today:"+this.id,icon:"fas fa-stop",iconColor:this.color,events:{click:()=>{let currentDate=new Date;let startDate=currentDate;switch(this.period){case"month":startDate.setDate(1);break;default:startDate=this._getPreviousMonday(currentDate)}this.showCalendar(startDate)}}};if(!kiss.screen.isMobile)todayButton.text=txtTitleCase("today");createButton(todayButton).render();if(!kiss.screen.isMobile){createButton({target:"refresh:"+this.id,tip:txtTitleCase("refresh"),icon:"fas fa-undo-alt",iconColor:this.color,width:"3.2rem",events:{click:()=>this.reload()}}).render()}}_renderToolbarTitle(){let title;this.startDay=this.startDate.getDate();this.startMonth=this.startDate.getMonth();this.startYear=this.startDate.getFullYear();this.endDay=new Date(kiss.formula.ADJUST_DATE(this.endDate,0,0,-1,0,0,0));this.endMonth=this.endDay.getMonth();this.endYear=this.endDay.getFullYear();this.endDay=this.endDay.getDate();switch(this.period){case"month":title=this.months[this.date.getMonth()].toUpperCase()+" "+this.date.getFullYear();break;default:title=String(this.startDay).padStart(2,"0")+" "+this.months[this.startMonth]+" - "+String(this.endDay).padStart(2,"0")+" "+this.months[this.endMonth]+" "+((new Date).getFullYear()!=this.endYear?this.endYear:"")}this.calendarTitle=title;$("title:"+this.id).innerHTML=this.calendarTitle}_getPreviousMonday(date){let newDate=new Date(date);let dayOfWeek=date.getDay();if(dayOfWeek!==1)newDate.setDate(date.getDate()-(dayOfWeek===0?6:dayOfWeek-1));return newDate}_getPreviousSunday(date){let newDate=new Date(date);let dayOfWeek=date.getDay();if(dayOfWeek!==0)newDate.setDate(date.getDate()-dayOfWeek);return newDate}_initTexts(){this.months=[txtTitleCase("january"),txtTitleCase("february"),txtTitleCase("march"),txtTitleCase("april"),txtTitleCase("may"),txtTitleCase("june"),txtTitleCase("july"),txtTitleCase("august"),txtTitleCase("september"),txtTitleCase("october"),txtTitleCase("november"),txtTitleCase("december")];this.weekDays=[txtTitleCase("sunday"),txtTitleCase("monday"),txtTitleCase("tuesday"),txtTitleCase("wednesday"),txtTitleCase("thursday"),txtTitleCase("friday"),txtTitleCase("saturday")];if(this.showWeekend===false){this.weekDays.shift();this.weekDays.pop()}if(this.showWeekend&&this.startOnMonday){let lastElement=this.weekDays.shift();this.weekDays.push(lastElement)}if(kiss.screen.isMobile&&kiss.screen.isVertical()){this.months=this.months.map((month=>month.substring(0,4)+"."))}return this}_getDayId(day,month,year){return year+"-"+(month+"").padStart(2,"0")+"-"+(day+"").padStart(2,"0")}};customElements.define("a-calendar",kiss.ui.Calendar);const createCalendar=config=>document.createElement("a-calendar").init(config);kiss.ui.ChartView=class ChartView extends kiss.ui.DataComponent{constructor(){super()}init(config){config.autoSize=true;super.init(config);this.dashboard=config.dashboard===true;this.showToolbar=config.showToolbar!==false;this.showActions=config.showActions!==false;this.showSetup=config.showSetup!==false;this.canSort=config.canSort!==false;this.canFilter=config.canFilter!==false;this.canGroup=config.canGroup!==false;this.actions=config.actions||[];this.color=config.color||"#00aaee";this.useCDN=config.useCDN===false?false:true;let id=this.id;this.innerHTML=`<div class="chartview-container">\n                <div class="chartview-header">\n                    <div class="chartview-title">\n                        ${this.name||""}\n                    </div>\n                    <div style="flex: 1"></div>\n                    <div id="chartview-toolbar:${id}" class="chartview-toolbar">\n                        <div id="actions:${id}"></div>\n                    </div>\n                </div>\n                <div class="chartview-chart"></div>\n            </div>`.removeExtraSpaces();this.header=this.querySelector(".chartview-header");this.headerTitle=this.querySelector(".chartview-title");this.toolbar=this.querySelector(".chartview-toolbar");this.chartContainer=this.querySelector(".chartview-chart");this._initChartParams(config)._initSubscriptions()._initClickEvents();return this}async load(){try{log(`kiss.ui - Chart ${this.id} - Loading collection <${this.collection.id} (changed: ${this.collection.hasChanged})>`);await this.collection.find({filterSyntax:this.filterSyntax,filter:this.filter,sortSyntax:this.sortSyntax,sort:this.sort,group:this.group,projection:this.projection,groupUnwind:this.groupUnwind});this._renderToolbar()}catch(err){log(err);log(`kiss.ui - Chart ${this.id} - Couldn't load data properly`)}}setTitle(newTitle){this.headerTitle.innerHTML=newTitle}setColor(newColor){this.color=newColor;Array.from(this.toolbar.children).forEach((item=>{if(item&&item.firstChild&&item.firstChild.type=="button")item.firstChild.setIconColor(newColor)}))}updateLayout(msg){if(this.isConnected){this._render()}}updateSize(){if(!this.chart)return this;this._initChartSize();this.chart.resize(this.chartWidth,this.chartHeight);return this}showSetupWindow(){let _this=this;let chartType;let color=this.color;const sectionForChartType={id:"chart-setup-type",class:"chartview-wizard-section",layout:"horizontal",defaultConfig:{type:"button",margin:"0 0.5rem 0 0",flex:1,justifyContent:"center",height:"6.4rem",iconSize:"4rem",iconColor:this.color,action:function(){chartType=this.config.chartType;$("chart-setup-type").highlightButton(chartType);$("chartType").setValue(chartType);let data=$("chart-setup").getData();publish("EVT_CHART_SETUP_CHANGED",data)}},items:[{tip:txtTitleCase("#bar chart"),icon:kiss.global.getChartIcon("bar"),chartType:"bar"},{tip:txtTitleCase("#line chart"),icon:kiss.global.getChartIcon("line"),chartType:"line"},{tip:txtTitleCase("#pie chart"),icon:kiss.global.getChartIcon("pie"),chartType:"pie"},{tip:txtTitleCase("#pie chart"),icon:kiss.global.getChartIcon("doughnut"),chartType:"doughnut"},{tip:txtTitleCase("#number chart"),icon:kiss.global.getChartIcon("number"),chartType:"number"},{id:"chartType",type:"text",value:this.chartType,hidden:true}],methods:{load:()=>{chartType=this.chartType;$("chart-setup-type").highlightButton(this.chartType)},highlightButton(chartType){const allButtons=this.querySelectorAll("a-button");allButtons.forEach((button=>{if(button.config.chartType!=chartType){button.setColor(color);button.setIconColor(color);button.setBackgroundColor("var(--button-background)")}else{button.setColor("#ffffff");button.setIconColor("#ffffff");button.setBackgroundColor(color)}}))}}};const categoryFields=this.model.getFieldsAsOptions(["text","select","selectViewColumn","selectViewColumns","checkbox","directory","rating","icon","color"]).filter((field=>!field.isFromPlugin));const sectionForChartData={class:"chartview-wizard-section",type:"panel",title:txtTitleCase("data"),headerColor:"var(--body)",headerBackgroundColor:"var(--body-background-alt)",border:"none",defaultConfig:{width:"100%",labelWidth:"50%",fieldWidth:"50%",labelPosition:"left"},items:[{type:"text",id:"name",label:txtTitleCase("title"),value:this.name||""},{type:"checkbox",id:"isTimeSeries",label:txtTitleCase("#time series"),value:this.isTimeSeries,shape:"switch",width:"100%",subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.chartType=="pie"||data.chartType=="doughnut"||data.chartType=="number")return this.hide();this.show()}},events:{change:()=>publish("EVT_CHART_SETUP_CHANGED",$("chart-setup").getData())}},{type:"select",id:"categoryField",label:txtTitleCase("#category field"),multiple:false,options:categoryFields,value:this.categoryField,maxHeight:()=>kiss.screen.current.height-200,optionsColor:this.color,subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.isTimeSeries&&data.chartType!="pie"&&data.chartType!="doughnut")return this.hide();if(data.chartType=="number")return this.hide();this.show()}}},{type:"select",id:"timeField",label:txtTitleCase("time axis"),multiple:false,options:this.model.getFieldsAsOptions("date"),value:this.timeField,autocomplete:"off",maxHeight:()=>kiss.screen.current.height-200,optionsColor:this.color,subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.isTimeSeries&&data.chartType!="pie"&&data.chartType!="doughnut"&&data.chartType!="number")return this.show();this.hide()}}},{type:"select",id:"timePeriod",label:txtTitleCase("group by"),multiple:false,options:[{value:"week",label:txtTitleCase("week")},{value:"month",label:txtTitleCase("month")},{value:"quarter",label:txtTitleCase("quarter")},{value:"year",label:txtTitleCase("year")}],value:this.timePeriod||"month",maxHeight:()=>kiss.screen.current.height-200,optionsColor:this.color,autocomplete:"off",subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.isTimeSeries&&data.chartType!="pie"&&data.chartType!="doughnut"&&data.chartType!="number")return this.show();this.hide()}}},{type:"select",id:"operationType",label:txtTitleCase("chart values"),multiple:false,autocomplete:"off",options:[{label:txtTitleCase("#count data"),value:"count"},{label:txtTitleCase("#summarize data"),value:"summary"}],value:this.operationType||"count",width:"100%",maxHeight:()=>kiss.screen.current.height-200,optionsColor:this.color,events:{change:()=>publish("EVT_CHART_SETUP_CHANGED",$("chart-setup").getData())}},{type:"select",id:"summaryOperation",label:txtTitleCase("summary operation"),multiple:false,options:[{label:txtTitleCase("sum"),value:"sum"},{label:txtTitleCase("average"),value:"average"}],value:this.summaryOperation||"sum",width:"100%",maxHeight:()=>kiss.screen.current.height-200,optionsColor:this.color,autocomplete:"off",subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.operationType!="summary")return this.hide();this.show()}}},{type:"select",id:"valueField",label:txtTitleCase("#summary field"),multiple:false,options:this.model.getFieldsAsOptions(["number","slider"]),value:this.valueField,autocomplete:"off",width:"100%",maxHeight:()=>kiss.screen.current.height-200,optionsColor:this.color,subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.operationType!="summary")return this.hide();this.show()}}},{layout:"horizontal",margin:"2rem 0 0 0",defaultConfig:{type:"button",width:"100%",labelWidth:"50%",fieldWidth:"50%",labelPosition:"left",iconColor:this.color,height:"4rem"},items:[{type:"button",text:txtTitleCase("to sort"),icon:"fas fa-sort",action:()=>this.showSortWindow(),margin:"0 0.5rem 0 0"},{type:"button",text:txtTitleCase("to filter"),icon:"fas fa-filter",action:()=>this.showFilterWindow()}]}]};const sectionForChartLayout={class:"chartview-wizard-section",type:"panel",title:txtTitleCase("layout"),headerColor:"var(--body)",headerBackgroundColor:"var(--body-background-alt)",border:"none",defaultConfig:{width:"100%",labelWidth:"50%",fieldWidth:"50%",labelPosition:"left"},items:[{type:"checkbox",id:"showLegend",label:txtTitleCase("show legend"),shape:"switch",value:this.showLegend===false?false:true,subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.chartType!="number")return this.show();this.hide()}},events:{change:()=>publish("EVT_CHART_SETUP_CHANGED",$("chart-setup").getData())}},{type:"select",id:"legendPosition",label:txtTitleCase("legend position"),autocomplete:"off",options:[{value:"top",label:txtTitleCase("top")},{value:"bottom",label:txtTitleCase("bottom")},{value:"left",label:txtTitleCase("left")},{value:"right",label:txtTitleCase("right")}],value:this.legendPosition||"top",subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.showLegend===false||data.chartType=="number")return this.hide();this.show()}}},{type:"checkbox",id:"showValues",label:txtTitleCase("show values on chart"),shape:"switch",value:this.showValues===false?false:true,subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.chartType=="line"||data.chartType=="number")return this.hide();this.show()}},events:{change:()=>publish("EVT_CHART_SETUP_CHANGED",$("chart-setup").getData())}},{type:"checkbox",id:"showLabels",label:txtTitleCase("show labels on chart"),shape:"switch",value:!!this.showLabels,subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.chartType=="pie"||data.chartType=="doughnut")return this.show();this.hide()}},events:{change:()=>publish("EVT_CHART_SETUP_CHANGED",$("chart-setup").getData())}},{type:"checkbox",id:"centerLabels",label:txtTitleCase("#center labels"),shape:"switch",value:this.centerLabels===false?false:true,subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.chartType=="number")return this.hide();else if(data.showValues&&data.chartType!="line"||data.showLabels&&(data.chartType=="pie"||data.chartType=="doughnut"))return this.show();this.hide()}}},{type:"color",id:"labelColor",label:txtTitleCase("color"),value:this.labelColor||"#000000",subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.showValues&&data.chartType!="line"||data.showLabels&&(data.chartType=="pie"||data.chartType=="doughnut")||data.chartType=="number")return this.show();this.hide()}}},{type:"checkbox",id:"startAtZero",label:txtTitleCase("start at zero"),value:this.startAtZero===false?false:true,shape:"switch",width:"100%",subscriptions:{EVT_CHART_SETUP_CHANGED:function(data){if(data.chartType=="pie"||data.chartType=="doughnut"||data.chartType=="number")return this.hide();this.show()}}},{hidden:true,type:"select",id:"precision",label:txtTitleCase("number style"),autocomplete:"off",value:this.precision||0,options:[{label:"1",value:0},{label:"1.0",value:1},{label:"1.00",value:2},{label:"1.000",value:3},{label:"1.0000",value:4},{label:"1.00000",value:5},{label:"1.000000",value:6},{label:"1.0000000",value:7},{label:"1.00000000",value:8}],optionsColor:this.color},{hidden:true,type:"text",id:"unit",label:txtTitleCase("unit"),value:this.unit}]};const viewId=this.id;createPanel({id:"chart-setup",title:txtTitleCase("setup the chart"),icon:"fas fa-cog",draggable:true,closable:true,modal:true,backdropFilter:true,top:0,left:"calc(100vw - 50rem)",width:"50rem",height:()=>kiss.screen.current.height,headerHeight:"4.9rem",headerBackgroundColor:this.color,overflowY:"auto",animation:{name:"fadeIn",speed:"faster"},items:[sectionForChartType,sectionForChartData,sectionForChartLayout,{layout:"horizontal",overflow:"unset",defaultConfig:{type:"button",flex:1,height:"4rem",margin:"0.5rem 1rem"},items:[{type:"button",icon:"fas fa-check",iconColor:"var(--green)",text:txtTitleCase("save"),action:()=>$("chart-setup").save()}]}],methods:{load(){publish("EVT_CHART_SETUP_CHANGED",this.getData());setTimeout((()=>$("name").focus()),100)},async save(){const{name:name,chartType:chartType,isTimeSeries:isTimeSeries,categoryField:categoryField,timeField:timeField,timePeriod:timePeriod,operationType:operationType,summaryOperation:summaryOperation,valueField:valueField,startAtZero:startAtZero,showLegend:showLegend,legendPosition:legendPosition,showValues:showValues,showLabels:showLabels,centerLabels:centerLabels,labelColor:labelColor,precision:precision,unit:unit}=$("chart-setup").getData();if(!chartType||!isTimeSeries&&!categoryField&&chartType!="number"||chartType=="pie"&&!categoryField||chartType=="doughnut"&&!categoryField||isTimeSeries&&!timeField||operationType=="summary"&&!summaryOperation||operationType=="summary"&&!valueField){return createNotification(txtTitleCase("#chart wrong params"))}publish("EVT_VIEW_SETUP:"+viewId,{name:name,chartType:chartType,isTimeSeries:isTimeSeries,categoryField:categoryField,timeField:timeField,timePeriod:timePeriod,operationType:operationType,summaryOperation:summaryOperation,valueField:valueField,startAtZero:startAtZero,showLegend:showLegend,legendPosition:legendPosition,showValues:showValues,showLabels:showLabels,centerLabels:centerLabels,labelColor:labelColor,precision:precision,unit:unit});if(_this.dashboard)publish("EVT_DASHBOARD_SETUP",viewId)}}}).render()}async showRecords(category){const model=this.model;const tempDatatableId="chart-data-"+this.id;const tempCollection=this.collection.clone();let newFilter;if(category){if(!this.isTimeSeries){const categoryField=this.model.getField(this.categoryField);newFilter={type:"group",operator:"and",filters:[this.collection.filter,{type:"filter",fieldId:categoryField.id,fieldType:categoryField.type,operator:"=",value:category}]}}tempCollection.filter=newFilter;tempCollection.group=[]}await tempCollection.find();const datatable=createDatatable({id:"datatable-"+tempDatatableId,type:"datatable",collection:tempCollection,color:this.color,showActions:false,showLinks:false,canEdit:false,canAddField:false,canEditField:false,canCreateRecord:false,canSelect:false,autoSize:true});createPanel({modal:true,closable:true,title:"<b>"+model.namePlural+"</b>",icon:model.icon,headerBackgroundColor:model.color,display:"flex",layout:"vertical",align:"center",verticalAlign:"center",background:"var(--body-background)",padding:0,width:()=>"calc(100vw - 2rem)",height:()=>"calc(100vh - 2rem)",autoSize:true,methods:{load(){setTimeout((()=>this.setItems([datatable])),50)}}}).render()}_initChartParams(config){if(this.record){this.chartType=config.chartType||this.record.config.chartType;this.isTimeSeries=config.isTimeSeries||this.record.config.isTimeSeries;this.categoryField=config.categoryField||this.record.config.categoryField;this.timeField=config.timeField||this.record.config.timeField;this.timePeriod=config.timePeriod||this.record.config.timePeriod;this.operationType=config.operationType||this.record.config.operationType;this.summaryOperation=config.summaryOperation||this.record.config.summaryOperation;this.valueField=config.valueField||this.record.config.valueField;this.startAtZero=config.startAtZero||this.record.config.startAtZero;this.showLegend=config.showLegend||this.record.config.showLegend;this.legendPosition=config.legendPosition||this.record.config.legendPosition;this.showValues=config.showValues||this.record.config.showValues;this.showLabels=config.showLabels||this.record.config.showLabels;this.centerLabels=config.centerLabels||this.record.config.centerLabels;this.labelColor=config.labelColor||this.record.config.labelColor;this.precision=config.precision||this.record.config.precision||0;this.unit=config.unit||this.record.config.unit||""}else{this.chartType=config.chartType||this.config.chartType;this.isTimeSeries=config.isTimeSeries||false;this.categoryField=config.categoryField||this.config.categoryField;this.timeField=config.timeField||this.config.timeField;this.timePeriod=config.timePeriod||"month";this.operationType=config.operationType||"count";this.summaryOperation=config.summaryOperation||"sum";this.valueField=config.valueField||this.config.valueField;this.startAtZero=config.startAtZero===false?false:true;this.showLegend=config.showLegend===false?false:true;this.legendPosition=config.legendPosition||"top";this.showValues=config.showValues===false?false:true;this.showLabels=config.showLabels||false;this.centerLabels=config.centerLabels===false?false:true;this.labelColor=config.labelColor||"#000000";this.precision=config.precision||0;this.unit=config.unit||""}this.isTimeSeries=this.isTimeSeries&&(this.chartType=="line"||this.chartType=="bar");if(this.isTimeSeries){this.sort=[{[this.timeField]:"asc"}];this.group=[this.timeField]}else{if(this.chartType!="number"){this.group=[this.categoryField]}else{this.group=[]}}if(!this.valueField){let modelNumberFields=this.model.getFieldsByType(["number"]);if(modelNumberFields.length!=0){this.valueField=modelNumberFields[0].id}else{this.valueField=null}}return this}_initSubscriptions(){super._initSubscriptions();const viewModelId=this.modelId.toUpperCase();this.subscriptions=this.subscriptions.concat([subscribe("EVT_VIEW_SETUP:"+this.id,(msgData=>this._updateConfig(msgData))),subscribe("EVT_DB_INSERT:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_UPDATE:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_DELETE:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_INSERT_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_DELETE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_BULK",(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE:VIEW",(msgData=>this._updateTitle(msgData)))]);return this}_initClickEvents(){this.onclick=e=>{const target=e.target;if(!target.closest(".a-button")&&!target.closest(".chartview-number")&&target.tagName!="CANVAS"){publish("EVT_CHART_CLICKED",{chartId:this.id,event:e})}};return this}_initChartSize(){const VERTICAL_SPACE=80;const HORIZONTAL_SPACE=40;let width=this.clientWidth-HORIZONTAL_SPACE;let height=this.clientHeight-VERTICAL_SPACE;this.chartWidth=width;this.chartHeight=height;return this}_updateTitle(msgData){if(!this.record)return;if(msgData.id==this.record.id&&msgData.data.name){this.setTitle(msgData.data.name)}}async _updateConfig(newConfig){let currentConfig;let finalConfig;let needsDataReload=false;if(this.chartType!=newConfig.chartType)needsDataReload=true;if(this.isTimeSeries!=newConfig.isTimeSeries)needsDataReload=true;if(this.isTimeSeries&&this.timeField!=newConfig.timeField)needsDataReload=true;if(this.isTimeSeries&&this.timePeriod!=newConfig.timePeriod)needsDataReload=true;if(this.categoryField!=newConfig.categoryField)needsDataReload=true;if(this.operationType!=newConfig.operationType)needsDataReload=true;if(this.operationType=="summary"&&this.summaryOperation!=newConfig.summaryOperation)needsDataReload=true;if(this.valueField!=newConfig.valueField)needsDataReload=true;if(needsDataReload)this.collection.hasChanged=true;if(this.record){currentConfig=this.record.config}else{currentConfig={chartType:this.chartType,isTimeSeries:this.isTimeSeries,categoryField:this.categoryField,timeField:this.timeField,timePeriod:this.timePeriod,operationType:this.operationType,summaryOperation:this.summaryOperation,valueField:this.valueField,startAtZero:this.startAtZero,showLegend:this.showLegend,legendPosition:this.legendPosition,showValues:this.showValues,showLabels:this.showLabels,centerLabels:this.centerLabels,labelColor:this.labelColor,precision:this.precision,unit:this.unit}}if(newConfig.hasOwnProperty("name"))this.name=newConfig.name;if(newConfig.hasOwnProperty("chartType"))this.chartType=newConfig.chartType;if(newConfig.hasOwnProperty("isTimeSeries"))this.isTimeSeries=newConfig.isTimeSeries;if(newConfig.hasOwnProperty("categoryField"))this.categoryField=newConfig.categoryField;if(newConfig.hasOwnProperty("timeField"))this.timeField=newConfig.timeField;if(newConfig.hasOwnProperty("timePeriod"))this.timePeriod=newConfig.timePeriod;if(newConfig.hasOwnProperty("operationType"))this.operationType=newConfig.operationType;if(newConfig.hasOwnProperty("summaryOperation"))this.summaryOperation=newConfig.summaryOperation;if(newConfig.hasOwnProperty("valueField"))this.valueField=newConfig.valueField;if(newConfig.hasOwnProperty("startAtZero"))this.startAtZero=newConfig.startAtZero;if(newConfig.hasOwnProperty("showLegend"))this.showLegend=newConfig.showLegend;if(newConfig.hasOwnProperty("legendPosition"))this.legendPosition=newConfig.legendPosition;if(newConfig.hasOwnProperty("showValues"))this.showValues=newConfig.showValues;if(newConfig.hasOwnProperty("showLabels"))this.showLabels=newConfig.showLabels;if(newConfig.hasOwnProperty("centerLabels"))this.centerLabels=newConfig.centerLabels;if(newConfig.hasOwnProperty("labelColor"))this.labelColor=newConfig.labelColor;if(newConfig.hasOwnProperty("precision"))this.precision=newConfig.precision;if(newConfig.hasOwnProperty("unit"))this.unit=newConfig.unit;let config=Object.assign(currentConfig,newConfig);this.setTitle(this.name);this.isTimeSeries=newConfig.isTimeSeries&&(newConfig.chartType=="line"||newConfig.chartType=="bar");if(this.isTimeSeries){finalConfig={name:this.name,sort:[{[config.timeField]:"asc"}],group:[config.timeField],config:config}}else{if(config.chartType!="number"){finalConfig={name:this.name,group:[config.categoryField],config:config}}else{finalConfig={name:this.name,group:[],config:config}}}if(!this.record){Object.assign(this,finalConfig)}await this.updateConfig(finalConfig,needsDataReload)}_consolidateData(rawData,interval,operation){const parseDate=date=>{if(typeof date==="string"){return new Date(date)}if(date instanceof Date){return date}throw new Error("Invalid date format")};const formatKey=(date,interval)=>{const parsedDate=parseDate(date);const year=parsedDate.getFullYear();const month=(parsedDate.getMonth()+1).toString().padStart(2,"0");const day=parsedDate.getDate().toString().padStart(2,"0");switch(interval){case"day":return`${year}-${month}-${day}`;case"week":{const firstDayOfYear=new Date(year,0,1);const weekNumber=Math.ceil(((parsedDate-firstDayOfYear)/864e5+firstDayOfYear.getDay()+1)/7);return`${year}-W${weekNumber}`}case"month":return`${year}-${month}`;case"quarter":const qMonth=Math.ceil((parsedDate.getMonth()+1)/3);return`${year}-Q${qMonth}`;case"year":return`${year}`;default:throw new Error("Unsupported interval")}};const groupedData=rawData.reduce(((acc,{x:x,y:y})=>{const key=formatKey(x,interval);if(!acc[key]){acc[key]={total:0,count:0}}acc[key].total+=y;acc[key].count+=1;return acc}),{});return Object.entries(groupedData).map((([key,{total:total,count:count}])=>{const value=operation==="average"?total/count:total;return{x:key,y:value}}))}_render(){if(this.chartType=="number")return this._renderNumber();return this._renderChart()}_renderNumber(){if(this.chart){this.chart.destroy();this.chart=null}this.chartContainer.innerHTML="";this.chartContainer.classList.remove("chartview-container-empty");let operation=this.operationType=="count"?"count":this.summaryOperation;const valueField=this.valueField;let total=0;let unit;let precision;if(operation!="count"){const field=this.model.getField(this.valueField);unit=field.unit||"";precision=field.precision||0}switch(operation){case"count":total=this.collection.records.length;break;case"sum":total=this.collection.records.reduce(((acc,record)=>acc+record[valueField]||0),0);break;case"average":total=this.collection.records.reduce(((acc,record)=>acc+record[valueField]||0),0)/this.collection.records.length;break;default:}this.number=createBlock({target:this.chartContainer,class:"chartview-number",backgroundColor:this.labelColor+"20",items:[{type:"html",color:this.labelColor,html:total.format(precision)+(unit?` <span class="chartview-unit">${unit}</span>`:"")}],events:{click:()=>this.showRecords()}}).render();return this}_renderChart(){if(this.collection.group.length===0){this.chartContainer.classList.remove("chartview-chart-empty");this.chartContainer.innerHTML=`<div class="chartview-help">${txtTitleCase("#chart help")}</div>`;if(this.chart){this.chart.destroy();this.chart=null}else if(this.number){this.number.deepDelete();this.number=null}return this}else{if(this.collection.records.length=="0"){this.chartContainer.classList.add("chartview-container-empty");return this}this.chartContainer.classList.remove("chartview-container-empty");let sourceData=this.collection.records.filter((record=>record.$type=="group"));let xyData;let operation=this.operationType=="count"?"count":this.summaryOperation;const valueField=this.valueField;const renderer=false;switch(operation){case"count":if(!renderer){xyData=sourceData.map((rec=>({x:""+rec.$name,y:rec.$size})))}else{xyData=sourceData.map((rec=>({x:renderer({value:rec.$name,record:rec}),y:rec.$size})))}break;case"sum":if(!renderer){xyData=sourceData.map((rec=>({x:""+rec.$name,y:rec[valueField]?.sum||0})))}else{xyData=sourceData.map((rec=>({x:renderer(rec.$name),y:rec[valueField]?.sum||0})))}break;case"average":if(!renderer){xyData=sourceData.map((rec=>({x:""+rec.$name,y:rec[valueField]?.avg||0})))}else{xyData=sourceData.map((rec=>({x:renderer(rec.$name),y:rec[valueField]?.avg||0})))}break;default:}let normalizedData=xyData;if(this.isTimeSeries)normalizedData=this._consolidateData(xyData,this.timePeriod,operation);normalizedData=normalizedData.filter((record=>record.x!==""&&record.x!=="undefined"));let groupFieldId=this.collection.group[0];const startIndex=0;let colors=normalizedData.map(((record,index)=>this._getCategoryColor(groupFieldId,record.x,startIndex+index)));const data={datasets:[{data:normalizedData,borderWidth:1,borderRadius:5,backgroundColor:colors}]};const currentChartType=this.chartType;const showLabels=this.showLabels;const showValues=this.showValues;const displayLabels=this.showValues&&this.chartType!="line"||this.showLabels&&(this.chartType=="pie"||this.chartType=="doughnut");const legendTitleFieldId=this.isTimeSeries?this.timeField:this.categoryField;const legendTitleField=legendTitleFieldId?this.model.getField(legendTitleFieldId):"";const legendText=legendTitleField?legendTitleField.label:txtTitleCase("legend");let plugins={tooltip:{callbacks:{label:function(tooltipItem){const label=tooltipItem.raw.x||"";const value=tooltipItem.raw.y||0;if(currentChartType=="line"||currentChartType=="bar")return value;return`${label}: ${value}`}}},legend:{display:this.showLegend,position:this.legendPosition,title:{display:true,text:legendText,font:{weight:"bold",size:14}},labels:{boxWidth:10,boxHeight:10,generateLabels:function(chart){const dataset=chart.data.datasets[0];return dataset.data.map(((record,index)=>({datasetIndex:0,text:record.x,fillStyle:colors[index],textAlign:"left",borderRadius:{topLeft:3,topRight:3,bottomLeft:3,bottomRight:3}})))}},onClick:(event,legendItem,legend)=>{kiss.context.chartLegendClicked=true;const category=legendItem.text;if(this.isTimeSeries)return;this.showRecords(category)}},datalabels:{display:displayLabels,align:"center",anchor:this.centerLabels?"center":"end",color:this.labelColor,font:{weight:"normal"},formatter:value=>{if(currentChartType=="pie"||currentChartType=="doughnut"){if(showLabels&&showValues)return value.x+": "+Math.round(value.y||0);if(showLabels)return value.x;if(showValues)return Math.round(value.y||0)}return Math.round(value.y||0)}}};let options={scales:{y:{display:currentChartType=="pie"||currentChartType=="doughnut"?false:true,beginAtZero:this.startAtZero}},responsive:true,maintainAspectRatio:false,normalized:true,animation:false,plugins:plugins};if(this.chartType=="pie"||this.chartType=="doughnut"){options.parsing={key:"y"}}else if(this.isTimeSeries){options.scales.x={type:"time",time:{unit:this.timePeriod,displayFormats:{day:"DD/MM/YYYY",week:"YYYY [W]WW",year:"YYYY",quarter:"[Q]Q-YYYY"}}};if(this.timePeriod=="week"){}else if(this.timePeriod=="quarter"){options.scales.x.time.parser="YYYY-[Q]Q"}}this._initChartSize();options.onClick=(event,elements)=>{if(elements.length>0){const element=elements[0].element;const context=element.$context;const category=context.raw.x;if(this.isTimeSeries)return;this.showRecords(category)}};if(this.chart){this.chart.refresh({chartType:this.chartType,width:this.chartWidth,height:this.chartHeight,useDataLabels:displayLabels,useMoment:true,data:data,options:options,useCDN:this.useCDN})}else{this.chartContainer.innerHTML="";this.chart=createChart({target:this.chartContainer,chartType:this.chartType,width:this.chartWidth,height:this.chartHeight,useDataLabels:displayLabels,useMoment:true,data:data,options:options,useCDN:this.useCDN});this.chart.render()}this.chart.onclick=event=>{setTimeout((()=>{if(kiss.context.chartLegendClicked==true){kiss.context.chartLegendClicked=false;return}const elements=this.chart.chart.getElementsAtEventForMode(event,"nearest",{intersect:true},false);if(elements.length===0){publish("EVT_CHART_CLICKED",{chartId:this.id,event:event})}}),50)}}return this}_getCategoryColor(groupFieldId,columnValue,index){const field=this.model.getField(groupFieldId);const options=field.options||[];const randomColor="#"+kiss.global.palette[index*2%40];if(Array.isArray(options)){const option=options.find((option=>option.value==columnValue));return option?option.color||randomColor:randomColor}return randomColor}_renderToolbar(){if(this.isToolbarRendered)return;createButton({hidden:this.showActions===false,target:"actions:"+this.id,icon:"fas fa-chevron-down",iconColor:this.color,width:"3.2rem",border:"none",boxShadow:"none",action:event=>{createMenu({left:event.x-10,top:event.y-10,items:[{text:txtTitleCase("setup the chart"),icon:"fas fa-cog",iconColor:this.color,action:()=>this.showSetupWindow()},{text:txtTitleCase("refresh"),icon:"fas fa-undo-alt",iconColor:this.color,action:()=>this.reload()},{hidden:this.chartType=="number",text:txtTitleCase("download image"),icon:"fas fa-image",iconColor:this.color,action:()=>{if(!this.chart)return;this.chart.downloadBase64Image("image/png",1)}},this.dashboard?"-":"",this.dashboard?{text:txtTitleCase("delete"),icon:"fas fa-trash",iconColor:"var(--red)",action:()=>publish("EVT_DASHBOARD_CHART_DELETED",this.id)}:""]}).render()}}).render();this.isToolbarRendered=true}};customElements.define("a-chartview",kiss.ui.ChartView);const createChartView=config=>document.createElement("a-chartview").init(config);kiss.ui.Dashboard=class Dashboard extends kiss.ui.DataComponent{constructor(){super()}init(config){config.autoSize=true;super.init(config);this.color=config.color||"#00aaee";this.canEditView=config.canEditView===false?false:true;this.useCDN=config.useCDN===false?false:true;this.CHART_TOP_SPACE=13;let id=this.id;this.innerHTML=`<div class="dashboard-container">\n                <div class="dashboard-header">\n                    <div class="dashboard-title">\n                        ${this.name||""}\n                    </div>\n                    <div style="flex: 1"></div>\n                    <div id="dashboard-toolbar:${id}" class="dashboard-toolbar">\n                        <div id="setup:${id}"></div>\n                    </div>\n                </div>\n                <div id="dashboard-groups:${id}" class="dashboard-groups"></div>\n            </div>`.removeExtraSpaces();this.header=this.querySelector(".dashboard-header");this.headerTitle=this.querySelector(".dashboard-title");this.toolbar=this.querySelector(".dashboard-toolbar");this.dashboardGroups=this.querySelector(".dashboard-groups");this._initClickEvents();this._initSubscriptions();return this}async load(){await this.collection.find();this._render()}_render(){let isFirstGroup=false;this.dashboardGroups.innerHTML="";let items=this.record.config||[];if(items.length==0){isFirstGroup=true;const groupId="dashboard-group:"+uid();const viewId=uid();items.push({id:groupId,class:"dashboard-group",height:`calc(calc(calc(100vh - ${this.CHART_TOP_SPACE}rem) * 0.5) - 1px)`,items:[{id:viewId,type:"chartview",chartType:"bar",dashboard:true,name:txtTitleCase("untitled"),color:this.color,collection:this.collection.clone("memory"),useCDN:this.useCDN}]})}if(!this.canEditView){items.forEach((group=>{group.items.forEach((item=>{if(item.type=="chartview"){item.showActions=false}}))}))}items.forEach((group=>{group.items.forEach((item=>{if(item.type=="chartview"){item.useCDN=this.useCDN}}))}));this.dashboardGroups.appendChild(createBlock({id:"dashboard-groups-container:"+this.id,width:"100%",flex:1,overflow:"auto",items:items}).render());this._manageDashboardButtons();this._enableDragAndDrop();this.setColor(this.color);if(isFirstGroup)this._showQuickTips();return this}setTitle(newTitle){this.headerTitle.innerHTML=newTitle}setColor(color){const charts=this._getCharts();for(const chart of charts){chart.setColor(color)}return this}async addGroup(){const newGroupId=uid();const newGroup=createBlock({id:"dashboard-group:"+newGroupId,class:"dashboard-group",items:[]}).render();const groupsContainer=this._getGroupsContainer();groupsContainer.appendChild(newGroup);await this.saveConfig();const escapedId=CSS.escape("dashboard-group:"+newGroupId);kiss.tools.waitForElement("#"+escapedId).then((()=>{$("dashboard-group:"+newGroupId).scrollIntoView({behavior:"smooth"})}));this.addChart("dashboard-group:"+newGroupId);this._manageDashboardButtons();this._enableDragAndDrop();return this}async deleteGroup(groupId){createDialog({title:txtTitleCase("delete this row"),icon:"fas fa-trash",headerBackgroundColor:"var(--red)",message:txtTitleCase("#delete row"),action:async()=>{const groupsContainer=this._getGroupsContainer();groupsContainer.deleteItem(groupId);await this.saveConfig();this._render()}})}moveGroupUp(groupId){const group=$(groupId);if(!group)return;const previousGroup=group.previousElementSibling;if(!previousGroup||!previousGroup.classList.contains("dashboard-group"))return;previousGroup.before(group);this.saveConfig();return this}moveGroupDown(groupId){const group=$(groupId);if(!group)return;const nextGroup=group.nextElementSibling;if(!nextGroup||!nextGroup.classList.contains("dashboard-group"))return;nextGroup.after(group);this.saveConfig();return this}checkGroupMove(groupId){const group=$(groupId);if(!group)return false;const previousGroup=group.previousElementSibling;const nextGroup=group.nextElementSibling;return{up:!!(previousGroup&&previousGroup.classList.contains("dashboard-group")),down:!!(nextGroup&&nextGroup.classList.contains("dashboard-group"))}}getGroups(){return Array.from(this.querySelectorAll(".dashboard-group"))}getGroupCount(){return this.getGroups().length}getGroupCharts(groupId){return Array.from($(groupId).querySelectorAll(".a-chartview"))}getChart(chartId){const dashboardGroups=$("dashboard-groups:"+this.id);let chart=null;for(const dashboardGroup of dashboardGroups.firstChild.items){chart=dashboardGroup.items.find((item=>item.id==chartId));if(chart)break}return chart}async addChart(groupId){const viewId=uid();const dashboardGroup=$(groupId);dashboardGroup.insertItem({id:viewId,type:"chartview",chartType:"bar",dashboard:true,name:txtTitleCase("untitled"),color:this.color,collection:this.collection.clone("memory"),useCDN:this.useCDN},dashboardGroup.items.length-1);this._manageDashboardButtons();this._enableDragAndDrop();await this.saveConfig();return this}moveChart(chartId,targetChartId){const sourceChart=$(chartId);const targetChart=$(targetChartId);const sourceGroup=$(chartId).closest(".dashboard-group");const targetGroup=$(targetChartId).closest(".dashboard-group");if(sourceGroup.id==targetGroup.id){const sourceIndex=this.getChartIndexInGroup(chartId);const targetIndex=this.getChartIndexInGroup(targetChartId);if(sourceIndex<targetIndex){targetChart.after(sourceChart)}else{targetChart.before(sourceChart)}this.saveConfig();return this}const chartsInTargetGroup=targetGroup.querySelectorAll(".a-chartview").length;if(chartsInTargetGroup>=4){return createNotification(txtTitleCase("this row is full"))}const targetIndex=[...targetGroup.children].indexOf(targetChart);if(targetIndex!==-1){targetChart.before(sourceChart)}else{targetGroup.appendChild(sourceChart)}sourceChart.updateSize();this._updateGroupLayout(sourceGroup);if(sourceGroup.children.length==1){sourceGroup.deepDelete()}this.saveConfig();return this}async deleteChart(chartId){const dashboardGroup=$(chartId).closest(".dashboard-group");dashboardGroup.deleteItem(chartId);this._manageDashboardButtons();await this.saveConfig();return this}getChartIndexInGroup(chartId){const sourceChart=$(chartId);const sourceGroup=$(chartId).closest(".dashboard-group");return[...sourceGroup.children].indexOf(sourceChart)}getConfig(){const dashboardGroupsContainer=$("dashboard-groups:"+this.id);let dashboardGroups=[];const dashboardGroupElements=Array.from(dashboardGroupsContainer.firstChild.children);dashboardGroupElements.forEach((dashboardGroup=>{let group={id:dashboardGroup.id,height:dashboardGroup.config.height,class:"dashboard-group"};let items=[];const groupItems=[...dashboardGroup.children];groupItems.forEach((item=>{if(item.type=="chartview"){let newItem={type:"chartview",dashboard:true,id:item.id,name:item.name,modelId:item.model.id,chartType:item.chartType,sort:item.sort,filter:item.filter,isTimeSeries:item.isTimeSeries,categoryField:item.categoryField,timeField:item.timeField,timePeriod:item.timePeriod,operationType:item.operationType,summaryOperation:item.summaryOperation,valueField:item.valueField,startAtZero:item.startAtZero,showLegend:item.showLegend,legendPosition:item.legendPosition,showValues:item.showValues,showLabels:item.showLabels,centerLabels:item.centerLabels,labelColor:item.labelColor,precision:item.precision,unit:item.unit,useCDN:this.useCDN};items.push(newItem)}}));group.items=items;dashboardGroups.push(group)}));return dashboardGroups}async saveConfig(){const config=this.getConfig();await this.record.update({config:config});return this}updateLayout(){return this}async print(){}_initClickEvents(){if(!this.canEditView)return}_initSubscriptions(){this.subscriptions=this.subscriptions.concat([subscribe("EVT_DB_UPDATE:VIEW",(msgData=>this._updateTitle(msgData))),subscribe("EVT_DASHBOARD_SETUP",(chartId=>{if(!this.isConnected)return;const chartIds=this._getChartIds();if(chartIds.length==0)return;if(chartIds.includes(chartId)){this.saveConfig()}})),subscribe("EVT_DASHBOARD_CHART_DELETED",(chartId=>{if(!this.isConnected)return;const chartIds=this._getChartIds();if(chartIds.length==0)return;if(chartIds.includes(chartId)){this.deleteChart(chartId)}})),subscribe("EVT_CHART_CLICKED",(msg=>{if(!this.isConnected)return;const chartIds=this._getChartIds();if(chartIds.length==0)return;if(chartIds.includes(msg.chartId)){const group=this._getChartGroup(msg.chartId);this._showGroupSetup(group.id,msg.event)}}))]);return this}_enableDragAndDrop(){if(!this.canEditView)return;const getCharts=()=>this.querySelectorAll(".a-chartview");const resetCharts=()=>getCharts().forEach((chart=>chart.classList.remove("chartview-highlight")));const resetChart=chart=>chart.classList.remove("chartview-highlight");const highlightChart=chart=>chart.classList.add("chartview-highlight");const dndEvents={ondragstart:event=>{const chart=event.target.closest(".a-chartview");kiss.context.chartId=chart.id},ondragover:event=>{event.preventDefault();resetCharts();const chart=event.target.closest(".a-chartview");if(!chart)return;highlightChart(chart)},ondrop:event=>{event.preventDefault();resetCharts();const chart=event.target.closest(".a-chartview");if(!chart)return;const chartId=kiss.context.chartId;this.moveChart(chartId,chart.id)},ondragleave:event=>{const chart=event.target.closest(".a-chartview");if(!chart)return;resetChart(chart)}};this.querySelectorAll(".a-chartview").forEach((chart=>{chart.draggable=true;chart.ondragstart=dndEvents.ondragstart;Object.assign(chart,dndEvents)}))}_showGroupSetup(groupId,event){const _this=this;const group=$(groupId);const groupMoves=this.checkGroupMove(groupId);createMenu({items:[`<h3>${txtTitleCase("row height")}</h3>`,"-",{text:"20%",icon:"fas fa-circle",iconSize:"0.2rem",action:async function(){group.config.height=group.style.height=`calc(calc(calc(100vh - ${_this.CHART_TOP_SPACE}rem) * 0.2) - 1px)`;await _this.saveConfig()}},{text:"25%",icon:"fas fa-circle",iconSize:"0.5rem",action:async function(){group.config.height=group.style.height=`calc(calc(calc(100vh - ${_this.CHART_TOP_SPACE}rem) * 0.25) - 1px)`;await _this.saveConfig()}},{text:"33%",icon:"fas fa-circle",iconSize:"0.66rem",action:async function(){group.config.height=group.style.height=`calc(calc(calc(100vh - ${_this.CHART_TOP_SPACE}rem) * 0.33) - 1px)`;await _this.saveConfig()}},{text:"40%",icon:"fas fa-circle",iconSize:"0.8rem",action:async function(){group.config.height=group.style.height=`calc(calc(calc(100vh - ${_this.CHART_TOP_SPACE}rem) * 0.40) - 1px)`;await _this.saveConfig()}},{text:"50%",icon:"fas fa-circle",iconSize:"1rem",action:async function(){group.config.height=group.style.height=`calc(calc(calc(100vh - ${_this.CHART_TOP_SPACE}rem) * 0.5) - 1px)`;await _this.saveConfig()}},{text:"66%",icon:"fas fa-circle",iconSize:"1.3rem",action:async function(){group.config.height=group.style.height=`calc(calc(calc(100vh - ${_this.CHART_TOP_SPACE}rem) * 0.66) - 1px)`;await _this.saveConfig()}},{text:"75%",icon:"fas fa-circle",iconSize:"1.5rem",action:async function(){group.config.height=group.style.height=`calc(calc(calc(100vh - ${_this.CHART_TOP_SPACE}rem) * 0.75) - 1px)`;await _this.saveConfig()}},{text:"100%",icon:"fas fa-circle",iconSize:"2rem",action:async function(){group.config.height=group.style.height=`calc(100vh - ${_this.CHART_TOP_SPACE}rem)`;await _this.saveConfig()}},"-",{hidden:groupMoves.up?false:true,text:txtTitleCase("move up"),icon:"fas fa-arrow-up",action:async()=>this.moveGroupUp(groupId)},{hidden:groupMoves.down?false:true,text:txtTitleCase("move down"),icon:"fas fa-arrow-down",action:async()=>this.moveGroupDown(groupId)},{text:txtTitleCase("add row"),icon:"fas fa-plus",action:async()=>this.addGroup()},"-",{text:txtTitleCase("delete this row"),icon:"fas fa-trash",iconColor:"var(--red)",action:async()=>this.deleteGroup(groupId)}]}).render().showAt(event.clientX-20,event.clientY-20)}_showQuickTips(){const dashboardGroup=this.getGroups()[0];setTimeout((()=>{const buttonSetup=$("actions:"+dashboardGroup.items[0].id);const buttonAdd=dashboardGroup.items[dashboardGroup.items.length-1];kiss.tools.highlightElements([{element:buttonSetup,text:txtTitleCase("#help setup chart"),position:"left"},{element:buttonAdd,text:txtTitleCase("#help add chart"),position:"left"}])}),1e3)}_manageDashboardButtons(){if(!this.canEditView)return;setTimeout((()=>{const dashboardGroupsContainer=$("dashboard-groups:"+this.id);const dashboardGroupElements=Array.from(dashboardGroupsContainer.firstChild.children);dashboardGroupElements.forEach((dashboardGroup=>{dashboardGroup.items.forEach(((item,index)=>{if(item.type=="button"){dashboardGroup.deleteItem(item.id)}}))}));dashboardGroupElements.forEach((dashboardGroup=>{if(dashboardGroup.items.length>3)return;let buttonConfig={type:"button",icon:"fas fa-plus",width:"3.2rem",height:"3.2rem",margin:"0 0 0 -2.5rem",tip:txtTitleCase("add chart"),action:()=>this.addChart(dashboardGroup.id)};dashboardGroup.addItem(buttonConfig)}))}),0)}_updateTitle(msgData){if(!this.record)return;if(msgData.id==this.record.id&&msgData.data.name){this.setTitle(msgData.data.name)}}_getCharts(){return Array.from(this.querySelectorAll(".a-chartview"))}_getChartIds(){return this._getCharts().map((chart=>chart.id))}_getChartGroup(chartId){return $(chartId).closest(".dashboard-group")}_getGroupIndex(groupId){const dashboardGroups=$("dashboard-groups:"+this.id);return dashboardGroups.firstChild.items.findIndex((group=>group.id==groupId))}_getGroupsContainer(){return $("dashboard-groups-container:"+this.id)}_updateGroupLayout(group){group.querySelectorAll(".a-chartview").forEach((chart=>chart.updateSize()))}};customElements.define("a-dashboard",kiss.ui.Dashboard);const createDashboard=config=>document.createElement("a-dashboard").init(config);kiss.ui.Datatable=class Datatable extends kiss.ui.DataComponent{constructor(){super()}init(config){config.autoSize=true;super.init(config);this.showHeader=config.showHeader!==false;this.showColumnType=!!config.showColumnType;this.showToolbar=config.showToolbar!==false;this.showPagerIndex=config.showPagerIndex!==false;this.showScroller=config.showScroller!==false;this.showActions=config.showActions!==false;this.showLayoutButton=config.showLayoutButton!==false;this.showGroupButtons=config.showGroupButtons!==false;this.showGroupHierarchy=!!config.showGroupHierarchy;this.showGroupHierarchyButton=config.showGroupHierarchyButton!==false;this.canSearch=config.canSearch!==false;this.canSort=config.canSort!==false;this.canFilter=config.canFilter!==false;this.canGroup=config.canGroup!==false;this.color=config.color||"#00aaee";this.iconAction=config.iconAction||"far fa-file-alt";this.defaultRowHeight=4;this.resizerWidth=1.5;this.canSelect=config.canSelect!==false;this.canSelectCells=config.canSelectCells!==false;this.canEdit=!!config.canEdit;this.canAddField=!!config.canAddField;this.canEditField=!!config.canEditField;this.canSelectFields=config.canSelectFields!==false;this.actions=config.actions||[];this.buttons=config.buttons||[];let id=this.id;this.innerHTML=`<div class="datatable">\n                <div id="datatable-toolbar:${id}" class="datatable-toolbar">\n                    <div id="search-field:${id}"></div>\n                    <div id="create:${id}"></div>\n                    <div id="actions:${id}"></div>\n                    <div id="select:${id}"></div>\n                    <div id="sort:${id}"></div>\n                    <div id="filter:${id}"></div>\n                    <div id="group:${id}"></div>\n                    <div id="collapse:${id}"></div>\n                    <div id="expand:${id}"></div>\n                    <div id="refresh:${id}"></div>\n                    <div id="search:${id}"></div>\n                    <div id="hierarchy:${id}"></div>\n                    <div id="add:${id}"></div>\n                    <div id="explode:${id}"></div>\n                    <div class="spacer"></div>\n                    <div id="pager-index:${id}" class="datatable-toolbar-pager-index"></div>\n                    <div id="pager-first:${id}"></div>\n                    <div id="pager-previous:${id}"></div>\n                    <div id="pager-next:${id}"></div>\n                    <div id="pager-last:${id}"></div>\n                    <div id="layout:${id}"></div>\n                </div>\n\n                <div class="datatable-header-container">\n                    <div class="datatable-header-1st-column"></div>\n                    <div id="datatable-header:${id}" class="datatable-header"></div>\n                </div>\n\n                <div class="datatable-body-container">\n                    <div class="datatable-body-1st-column"></div>\n                    <div id="datatable-body:${id}" class="datatable-body"></div>\n                </div>\n\n                <div class="datatable-virtual-scroller-container">\n                    <div class="datatable-virtual-scroller"></div>\n                </div>\n            </div>`.removeExtraSpaces();this.datatable=this.querySelector(".datatable");this.datatableToolbar=this.querySelector(".datatable-toolbar");this.datatableHeader=this.querySelector(".datatable-header");this.datatableBody=this.querySelector(".datatable-body");this.datatableBodyContainer=this.querySelector(".datatable-body-container");this.datatableHeader1stColumn=this.querySelector(".datatable-header-1st-column");this.datatableBody1stColumn=this.querySelector(".datatable-body-1st-column");this.datatableScrollerContainer=this.querySelector(".datatable-virtual-scroller-container");this.datatableScroller=this.querySelector(".datatable-virtual-scroller");this.datatablePagerIndex=this.querySelector(".datatable-toolbar-pager-index");if(this.showHeader===false)this.datatableHeader.style.display="none";if(this.showToolbar===false)this.datatableToolbar.style.display="none";if(this.showScroller===false)this.datatableScrollerContainer.style.display="none";if(this.showPagerIndex===false)this.datatablePagerIndex.style.display="none";this._initColumnsDefaultWidth()._initColumns()._initSize(config)._initEvents()._initSubscriptions();return this}async load(){try{log(`kiss.ui - Datatable ${this.id} - Loading collection <${this.collection.id} (changed: ${this.collection.hasChanged})>`);let currentFilter=this.filter;if(this.currentSearchTerm){currentFilter=this.createSearchFilter(this.currentSearchTerm)}await this.collection.find({filterSyntax:this.filterSyntax,filter:currentFilter,sortSyntax:this.sortSyntax,sort:this.sort,group:this.group,projection:this.projection,groupUnwind:this.groupUnwind});this._hideScroller();this._columnsAdjustWidthFromLocalStorage();this.getSelection();this._renderToolbar();this.skip=0;this._setLimit();if(kiss.context.onboard==true){this.showTutorial()}}catch(err){log(`kiss.ui - Datatable ${this.id} - Couldn't load data properly`)}}switchToSearchMode(){if(kiss.screen.isMobile){$("create:"+this.id).hide();$("search:"+this.id).hide();$("expand:"+this.id).hide();$("collapse:"+this.id).hide()}}resetSearchMode(){if(kiss.screen.isMobile){$("create:"+this.id).show();$("search:"+this.id).show();$("expand:"+this.id).show();$("collapse:"+this.id).show()}}async setColor(newColor){this.color=newColor;Array.from(this.datatableToolbar.children).forEach((item=>{if(item&&item.firstChild&&item.firstChild.type=="button")item.firstChild.setIconColor(newColor)}))}setRowHeight(height){this.rowHeight=height;document.documentElement.style.setProperty("--datacomponent-cell-height",this.rowHeight+"rem");document.documentElement.style.setProperty("--datacomponent-group-cell-height",this.rowHeight+"rem");this._setThumbSize();const localStorageId="config-view-datatable-"+this.id+"-row-height";localStorage.setItem(localStorageId,this.rowHeight);this.reload()}async resetColumnsWidth(){this.columns.forEach((column=>{let width=this.defaultColumnWidth[column.type];if(!width)width=this.defaultColumnWidth.default;this._columnsSetWidth(column.id,width)}))}updateLayout(){if(this.isConnected){this._setWidth();this._setHeight();this._setLimit();this._renderPagerIndex();this._render();this._renderSelectionRestore()}}highlightRecord(recordId){let index=this.goToRecord(recordId);if(index!=-1)this._rowHighlight(index)}goToRecord(recordId){let index=this._rowFindIndex(recordId);if(index!=-1)this.goToIndex(index);return index}goToIndex(index){this.skip=index;this._render()}showFirstPage(){this.skip=0;this._renderPage(0)}showPreviousPage(){this._renderPage(-this.limit)}showNextPage(){this._renderPage(this.limit)}showLastPage(){this.skip=this.collection.count-this.limit-1;this._renderPage(this.limit)}showSortWindow(){let sortButton=$("sort:"+this.id);const box=sortButton.getBoundingClientRect();super.showSortWindow(box.left,box.top+40,this.color)}showFieldsWindow(){let selectionButton=$("select:"+this.id);const box=selectionButton.getBoundingClientRect();super.showFieldsWindow(box.left,box.top+40,this.color)}showFilterWindow(){super.showFilterWindow(null,null,this.color)}showColorWindow(column){const picker=createPanel({modal:true,header:false,align:"center",verticalAlign:"center",items:[{id:"column-color",type:"colorPicker",value:column.color,palette:kiss.global.palette.slice(0,20),selectorBorderRadius:"3.2rem",height:"10rem",events:{change:()=>{let color=$("column-color").getValue();column.color=color;this._render();this.updateConfig({config:{columns:this.columns}});picker.close()}}}]}).render()}_initSize(config){this._initRowHeight(config);if(config.width){this._setWidth()}else{this.style.width=this.config.width=`calc(100%)`}if(config.height){this._setHeight()}else{this.style.height=this.config.height=`calc(100% - 1rem)`}return this}_initRowHeight(config={}){this.rowHeight=config.rowHeight||this._getRowHeightFromLocalStorage();document.documentElement.style.setProperty("--datacomponent-cell-height",this.rowHeight+"rem");document.documentElement.style.setProperty("--datacomponent-group-cell-height",this.rowHeight+"rem");this._setThumbSize()}_initEvents(){const nonSelectableCells=["datatable-type-attachment","datatable-type-link","datatable-type-aiImage"];if(this.canSelectCells)this._initCellsCopyToClipboard();this.datatableHeader1stColumn.onclick=event=>{if(event.target.classList.contains("datatable-header-checkbox")){this.toggleSelection()}};this.datatableHeader.onclick=event=>{const clickedElement=event.target;if(clickedElement.classList.contains("datatable-column-header-properties")){const columnId=clickedElement.id.split(":")[1];this._showColumnMenu(columnId,clickedElement,event)}if(clickedElement.classList.contains("datatable-header-last-column")||clickedElement.parentNode.classList.contains("datatable-header-last-column")){if(this.canAddField){this._showColumnSetup();return event}}};this.datatableHeader1stColumn.onmousedown=event=>{const clickedElement=event.target;if(clickedElement.classList.contains("datatable-column-header-resizer")){this._columnsResizeWithDragAndDrop(event,clickedElement)}};this.datatableHeader.onmousedown=event=>{const clickedElement=event.target;if(clickedElement.classList.contains("datatable-column-header-resizer")){this._columnsResizeWithDragAndDrop(event,clickedElement)}};this.onclick=async event=>{const clickedElement=event.target;const clickedParent=clickedElement.parentNode;if(clickedElement.classList.contains("data-thumbnail")){const fieldId=event.target.getAttribute("fieldId");const attachmentId=event.target.getAttribute("id");const cell=event.target.closest(".datatable-cell");const record=this._cellGetRecord(cell);const cellAttachments=record[fieldId];createPreviewWindow(cellAttachments,attachmentId)}if(clickedElement.classList.contains("datatable-cell-blank")){return event}if(clickedElement.tagName.toLowerCase()=="input"){return event}if(clickedElement.classList.contains("datatable-cell-selected-locked")){const cellValue=clickedElement.innerText;if(cellValue&&cellValue.match(kiss.tools.regex.url)){window.open(cellValue);return}}if(clickedElement.classList.contains("field-link-value-cell")||clickedParent.classList.contains("field-link-value-cell")){const cell=clickedElement.closest("div");const fieldId=this._cellGetFieldId(cell);const recordId=clickedElement.closest(".datatable-row").getAttribute("recordId");this._cellOpenLinkedRecord(fieldId,recordId);return event}if(clickedElement.classList.contains("form-feature-workflow-history-button")||clickedParent.classList.contains("form-feature-workflow-history-button")){const recordId=clickedElement.closest(".datatable-row").getAttribute("recordId");kiss.templates.workflowHistoryFromView(this.id,recordId);return event}if(clickedElement.classList.contains("datatable-row-checkbox")){const rowIndex=clickedParent.getAttribute("row");this._rowToggleSelect(rowIndex);if(event.shiftKey&&this.lastSelectedRowIndex!=null){const rangeStart=Math.min(this.lastSelectedRowIndex,rowIndex);const rangeEnd=Math.max(this.lastSelectedRowIndex,rowIndex);this.selectRange(rangeStart,rangeEnd);delete this.lastSelectedRowIndex;return event}this.lastSelectedRowIndex=rowIndex;return event}if(Array.from(clickedParent.classList).concat(Array.from(clickedElement.classList)).indexOf("datatable-cell-1st")!=-1){const cell=clickedElement.closest("div");const recordId=cell.getAttribute("recordid");const record=await this.collection.getRecord(recordId);await this.selectRecord(record);return event}if(clickedElement.classList.contains("datatable-group-summary")||clickedParent.classList.contains("datatable-group-summary")){const colIndex=clickedElement.closest("div").getAttribute("col");const visibleColumn=this.visibleColumns[colIndex];const columnId=visibleColumn.id;const column=this.columns.get(columnId);await this._columnsSetAggregationType(column,event.pageX-32,event.pageY-32);return event}if(clickedParent.classList[0]&&clickedParent.classList[0].indexOf("datatable-group")!=-1){const rowIndex=this._cellGetRowIndex(clickedElement);const record=this.collection.records[Number(rowIndex)];const groupId=record.$groupId;const groupLevel=record.$groupLevel;this._groupToggle(groupId,groupLevel,rowIndex);return event}if(clickedElement.classList.contains("datatable-group")){const rowIndex=clickedElement.getAttribute("row");const record=this.collection.records[Number(rowIndex)];const groupId=record.$groupId;const groupLevel=record.$groupLevel;this._groupToggle(groupId,groupLevel,rowIndex);return event}if(!this.canEdit){if(clickedElement.classList.contains("datatable-cell")||clickedParent.classList.contains("datatable-cell")){const row=clickedElement.closest(".datatable-row");const recordId=row.getAttribute("recordid");const record=await this.collection.getRecord(recordId);await this.selectRecord(record)}return event}if(clickedParent.classList.contains("datatable-cell-selected")&&!clickedParent.classList.contains("datatable-cell-selected-locked")){this._cellSwitchToEditMode(clickedParent,event);return event}if(clickedElement.classList.contains("datatable-cell-selected")&&!clickedElement.classList.contains("datatable-cell-selected-locked")){this._cellSwitchToEditMode(clickedElement,event);return event}let selectedCell;if(clickedParent.classList.contains("datatable-cell")){selectedCell=clickedParent}else if(clickedElement.classList.contains("datatable-cell")){selectedCell=clickedElement}if(selectedCell){const cellValue=selectedCell.innerText;if(cellValue&&cellValue.match(kiss.tools.regex.url)){createMenu({items:[{text:txtTitleCase("#open link"),icon:"fas fa-external-link-alt",action:()=>window.open(cellValue)}]}).render().showAt(event.pageX+10,event.pageY+10)}const classes=selectedCell.classList;if(nonSelectableCells.some((cell=>classes.contains(cell)))){return event}selectedCell.setAttribute("tabindex","0");selectedCell.focus();selectedCell.classList.add("datatable-cell-selected");const recordId=clickedElement.closest(".datatable-row").getAttribute("recordId");const record=await this.collection.getRecord(recordId);const isEditable=record.isLocked?false:this._cellIsEditable(selectedCell);if(!isEditable){selectedCell.classList.add("datatable-cell-selected-locked")}else{selectedCell.onkeydown=event=>{if(!["Escape"].includes(event.key))this._cellSwitchToEditMode(selectedCell);selectedCell.classList.remove("datatable-cell-selected");selectedCell.classList.remove("datatable-cell-selected-locked");selectedCell.blur();selectedCell.removeAttribute("tabindex");selectedCell.onkeydown=null}}selectedCell.onmouseleave=()=>{selectedCell.classList.remove("datatable-cell-selected");selectedCell.classList.remove("datatable-cell-selected-locked");selectedCell.blur();selectedCell.removeAttribute("tabindex");selectedCell.onmouseleave=null}}};this.datatableBody.onscroll=()=>{this.datatableHeader.scrollLeft=this.datatableBody.scrollLeft};this.onmousewheel=this.onwheel=event=>{if(!event.target.closest(".datatable-body-container"))return;if(event.wheelDelta>0){this._virtualScrollUp()}else{this._virtualScrollDown()}this._renderPagerIndex()};this.datatableScrollerContainer.onmousedown=event=>{this.preventScroll=false};this.datatableScrollerContainer.onscroll=event=>{if(this.preventScroll==true)return false;window.clearTimeout(this.isScrolling);this.isScrolling=null;this.isScrolling=setTimeout((()=>{let percent=event.target.scrollTop/(this.datatableScroller.offsetHeight-this.datatableBody.offsetHeight);let recordIndex=Math.round((this.collection.count-this.limit)*percent);let newSkip=Math.min(recordIndex,this.collection.records.length-this.limit);if(newSkip!=this.skip){this.skip=Math.max(newSkip,0);this._render()}}),10)};return this}_initCellsCopyToClipboard(){if(!this.canSelect)return;const _this=this;this.isSelecting=false;this.isDrag=false;this.startCell=null;this.endCell=null;this.selectedCells=[];this.isScrolling=false;this.scrollInterval=null;this.datatableBody.onmousedown=event=>{const clickedElement=event.target;const clickedCell=clickedElement.closest(".datatable-cell");this.startCell=clickedCell;if(clickedCell){this.isSelecting=true;this.isDrag=false;this.selectedCells=[clickedCell];this.startCellData={rowIndex:this._cellGetRowIndex(clickedCell),colIndex:this._cellGetColIndex(clickedCell)}}};this.datatableBody.onmouseover=event=>{const HORIZONTAL_SCROLLZONE=200;const TOP_SCROLLZONE=40;const BOTTOM_SCROLLZONE=80;if(this.isSelecting){this.isDrag=true;const hoveredCell=event.target.closest(".datatable-cell");if(hoveredCell){this.endCell=hoveredCell;this.endCellData={rowIndex:this._cellGetRowIndex(hoveredCell),colIndex:this._cellGetColIndex(hoveredCell)};this.selectedCells.forEach((cell=>cell.classList.remove("datatable-cell-copied")));this.selectedCells=_this._getCellsInRange(this.startCell,this.endCell);this.selectedCells.forEach((cell=>cell.classList.add("datatable-cell-copied")))}const datatableBounds=this.datatableBody.getBoundingClientRect();const mouseX=event.clientX;const mouseY=event.clientY;if(mouseX>datatableBounds.right-HORIZONTAL_SCROLLZONE&&mouseX<datatableBounds.right){this._startHorizontalScrolling("right")}else if(mouseX<datatableBounds.left+HORIZONTAL_SCROLLZONE&&mouseX>datatableBounds.left){this._startHorizontalScrolling("left")}else if(mouseY<datatableBounds.top+TOP_SCROLLZONE&&mouseY>datatableBounds.top){this._startVerticalScrolling("up")}else if(mouseY>datatableBounds.bottom-BOTTOM_SCROLLZONE&&mouseY<datatableBounds.bottom){this._startVerticalScrolling("down")}else{this._stopHorizontalScrolling()}}};this.datatableBody.onmouseup=()=>{this._stopHorizontalScrolling();if(this.isSelecting){this.isSelecting=false;if(this.isDrag){this._copySelectedCellsDataToClipboard();this.selectedCells.forEach((cell=>cell.classList.remove("datatable-cell-copied")))}}};this.datatableBody.onmouseleave=()=>{this._stopHorizontalScrolling();if(this.isSelecting){this.isSelecting=false;if(this.isDrag){this._copySelectedCellsDataToClipboard();this.selectedCells.forEach((cell=>cell.classList.remove("datatable-cell-copied")))}}}}_startHorizontalScrolling(direction){if(this.isScrolling)return;this.isScrolling=true;this.scrollInterval=setInterval((()=>{if(direction==="right"){this.datatableBody.scrollLeft+=10}else if(direction==="left"){this.datatableBody.scrollLeft-=10}}),10)}_stopHorizontalScrolling(){this.isScrolling=false;clearInterval(this.scrollInterval)}_startVerticalScrolling(direction){if(this.isScrolling)return;this.isScrolling=true;this.scrollInterval=setInterval((()=>{if(direction==="up"){this._virtualScrollUp()}else if(direction==="down"){this._virtualScrollDown()}}),30)}_initSubscriptions(){super._initSubscriptions();const viewModelId=this.modelId.toUpperCase();this.subscriptions=this.subscriptions.concat([subscribe("EVT_DB_INSERT:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_UPDATE:"+viewModelId,(msgData=>this._updateOneAndReload(msgData))),subscribe("EVT_DB_DELETE:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_INSERT_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_DELETE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_BULK",(msgData=>this._updateManyAndReload(msgData)))]);return this}async _updateOneAndReload(msgData){const sortFields=this.sort.map((sort=>Object.keys(sort)[0]));const filterFields=kiss.db.mongo.getFilterFields(this.filter);let groupHasChanged=false;let sortHasChanged=false;let filterHasChanged=false;let updates=msgData.data;for(let fieldId of Object.keys(updates)){if(this.group.indexOf(fieldId)!=-1)groupHasChanged=true;if(sortFields.indexOf(fieldId)!=-1)sortHasChanged=true;if(filterFields.indexOf(fieldId)!=-1)filterHasChanged=true;let newValue=updates[fieldId];this._cellSetValue(msgData.id,fieldId,newValue)}if(sortHasChanged||filterHasChanged||groupHasChanged){this._reloadWhenNeeded(msgData)}}async _updateManyAndReload(msgData){const sortFields=this.sort.map((sort=>Object.keys(sort)[0]));const filterFields=kiss.db.mongo.getFilterFields(this.filter);let groupHasChanged=false;let sortHasChanged=false;let filterHasChanged=false;let operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId){for(let fieldId of Object.keys(operation.updates)){if(this.group.indexOf(fieldId)!=-1)groupHasChanged=true;if(sortFields.indexOf(fieldId)!=-1)sortHasChanged=true;if(filterFields.indexOf(fieldId)!=-1)filterHasChanged=true;let newValue=operation.updates[fieldId];this._cellSetValue(operation.recordId,fieldId,newValue)}}}));if(sortHasChanged||filterHasChanged||groupHasChanged){this._reloadWhenNeeded(msgData)}}_afterConnected(){super._afterConnected();this._hideScroller();this._renderScroller()}_initColumnsDefaultWidth(){this.defaultColumnWidth={text:18,number:18,date:18,select:18,textarea:35,checkbox:10,color:10,icon:10,attachment:15,directory:20,firstColumn:kiss.screen.isMobile?5:9,default:18};return this}_virtualScrollUp(){if(this.skip-1<0)return;this.skip-=1;this.lastIndex=Math.min(this.skip+this.limit-1,this.collection.records.length);this.datatableBody.lastChild.remove();this.datatableBody.insertBefore(this._renderRowDiv(this.skip),this.datatableBody.children[0]);this.datatableBody1stColumn.lastChild.remove();this.datatableBody1stColumn.insertBefore(this._renderRowDiv1stColumn(this.skip),this.datatableBody1stColumn.children[0]);this._renderScrollerPosition()}_virtualScrollDown(){if(this.lastIndex+1>=this.collection.records.length)return;this.skip+=1;this.lastIndex=Math.min(this.skip+this.limit-1,this.collection.records.length);this.datatableBody.children[0].remove();this.datatableBody.appendChild(this._renderRowDiv(this.lastIndex));this.datatableBody1stColumn.children[0].remove();this.datatableBody1stColumn.appendChild(this._renderRowDiv1stColumn(this.lastIndex));this._renderScrollerPosition()}_showColumnMenu(fieldId,columnMenu,event){const field=this.model.getField(fieldId);const column=this.columns.find((column=>column.id==fieldId));const isGrouped=this.group.length>0;const colorableFields=["text","textarea","number","date"];const isColorable=colorableFields.includes(field.type)||field.type=="lookup"&&colorableFields.includes(field.lookup.type)||field.type=="summary"&&colorableFields.includes(field.summary.type);const isNumeric=kiss.tools.isNumericField(field);const canBeAggregated=isNumeric&&isGrouped;let columnActions=[{icon:"fas fa-arrow-up",text:txtTitleCase("sort ascending"),action:async()=>{await this.sortByField(fieldId,"asc");this.showSortWindow()}},{icon:"fas fa-arrow-down",text:txtTitleCase("sort descending"),action:async()=>{await this.sortByField(fieldId,"desc");this.showSortWindow()}},this.canEditField&&isColorable?"-":"",{hidden:!isColorable,icon:"fas fa-palette",text:txtTitleCase("column color"),action:async()=>{this.showColorWindow(column)}},{hidden:!this.canEditField||!isColorable,icon:"fas fa-times",text:txtTitleCase("remove color"),action:async()=>{if(!column.color)return;delete column.color;this._render();this.updateConfig({config:{columns:this.columns}})}}];if(this.canEditField&&!field.isFromPlugin&&!field.isSystem){columnActions.splice(0,0,"-");if(!field.primary){columnActions.splice(0,0,{icon:"fas fa-trash",iconColor:"var(--red)",text:txtTitleCase("delete this item"),action:()=>{const deleteDialog=createDialog({type:"danger",title:txtTitleCase("delete an item"),message:txtTitleCase("#delete item warning"),buttonOKPosition:"left",action:async()=>{this.model.deleteField(fieldId);deleteDialog.close();this.reload()}})}})}columnActions.splice(0,0,{icon:"fas fa-edit",text:txtTitleCase("edit this field"),action:async()=>this._showColumnSetup(fieldId)})}if(canBeAggregated){columnActions.push("-");columnActions.push({text:txtTitleCase("#summary sum"),icon:"fas fa-chart-bar",action:async()=>{column.summary="sum";this._render();this.updateConfig({config:{columns:this.columns}})}});columnActions.push({text:txtTitleCase("#summary avg"),icon:"fas fa-tachometer-alt",action:async()=>{column.summary="avg";this._render();this.updateConfig({config:{columns:this.columns}})}});columnActions.push({text:txtTitleCase("#no summary"),icon:"fas fa-ban",action:async()=>{delete column.summary;this._render();this.updateConfig({config:{columns:this.columns}})}})}createMenu({top:columnMenu.getBoundingClientRect().y-10,left:columnMenu.getBoundingClientRect().x-10,items:columnActions}).render()}_showColumnSetup(fieldId){kiss.context.dockFieldProperties=false;kiss.router.updateUrlHash({fieldId:fieldId?fieldId:""});kiss.views.show("model-field")}_setThumbSize(){if(this.rowHeight<=this.defaultRowHeight){this.thumbSize="s"}else{this.thumbSize="m"}}_setWidth(){let newWidth=this._computeSize("width");setTimeout((()=>{this.style.width=newWidth;this.datatable.style.width=this.clientWidth.toString()+"px"}),50)}_setHeight(){let newHeight=this._computeSize("height");this.style.height=this.datatable.style.height=newHeight}_setLimit(){if(!this.isConnected)return;let tableHeight=this.offsetHeight;let headerHeight=$("datatable-header:"+this.id).offsetHeight;let toolbarHeight=$("datatable-toolbar:"+this.id).offsetHeight;let bodyHeight=tableHeight-toolbarHeight-headerHeight;this.limit=Math.floor(bodyHeight/(kiss.tools.remToPx(this.rowHeight)+1));if(kiss.screen.isMobile)this.limit=this.limit-1}_renderPage(size){if(size<0&&this.skip==0||size>0&&this.skip+size>=this.collection.count)return;this.skip=this.skip+2*size>=this.collection.count?this.skip=this.collection.count-size:this.skip+size;this.skip=Math.max(this.skip,0);this._render();this._renderScrollerPosition()}_renderPagerIndex(){if(!this.isConnected)return;if(kiss.screen.isMobile&&kiss.screen.isVertical()){$("pager-index:"+this.id).innerHTML=Math.min(this.collection.count,this.skip+this.limit)+" / "+this.collection.count}else{$("pager-index:"+this.id).innerHTML=this.skip+1+" - "+Math.min(this.collection.count,this.skip+this.limit)+" / "+this.collection.count}}_render(){this.datatableHeader1stColumn.innerHTML="";this.datatableBody1stColumn.innerHTML="";this.visibleColumns=this.columns.filter((column=>column.hidden!=true&&column.deleted!=true));this._prepareCellRenderers()._renderHeader()._renderBody();return this}_renderHeader(){let firstCell=document.createElement("div");firstCell.setAttribute("id","header-1stColumn");firstCell.setAttribute("col","-1");firstCell.classList.add("datatable-column-header","datatable-column-header-1st");firstCell.style.width=firstCell.style.minWidth=this.defaultColumnWidth.firstColumn+"rem";firstCell.innerHTML=`<span id='toggle-selection' class='datatable-header-checkbox ${this.canSelect?"datatable-header-checkbox-off":""}'></span>`+"<span id='header-resizer-1st-column' class='datatable-column-header-resizer'>&nbsp</span>";this.datatableHeader1stColumn.appendChild(firstCell);this._columnsAdjustWidthFromLocalStorage();this.datatableHeader.innerHTML=this.visibleColumns.map(this._renderColumnHeader.bind(this)).join("")+`<span class="datatable-column-header datatable-header-last-column">${this.canAddField?`<span class="fas fa-plus"></span>`:""}</span>`;return this}_renderBody(){this._initRowHeight();this._columnsSetFirstColumnWidth(this.defaultColumnWidth.firstColumn);let table="";let firstColumn="";this.startIndex=Math.max(0,this.skip);this.lastIndex=Math.min(this.skip+this.limit,this.collection.records.length);if(this.collection.group.length===0){for(let rowIndex=this.startIndex;rowIndex<this.lastIndex;rowIndex++){let record=this.collection.records[rowIndex];firstColumn+='<div col="-1" row="'+rowIndex+'" recordId="'+record.id+'" class="datatable-cell-1st" style="width: '+this.defaultColumnWidth.firstColumn+"rem; min-width: "+this.defaultColumnWidth.firstColumn+'rem">';firstColumn+=this._renderRowContent1stColumn(record,rowIndex);firstColumn+="</div>";table+='<div row="'+rowIndex+'" recordId="'+record.id+'" class="datatable-row">';table+=this._renderRowContent(record,rowIndex);table+="</div>"}}else{let nbOfRows=0;for(let rowIndex=this.skip;nbOfRows<this.limit&&rowIndex<this.collection.records.length;rowIndex++){let record=this.collection.records[rowIndex];if(record.$type=="group"){firstColumn+='<div col="-1" row="'+rowIndex+'" class="datatable-group datatable-group-level-'+record.$groupLevel+'" style="width: '+this.defaultColumnWidth.firstColumn+"rem; min-width: "+this.defaultColumnWidth.firstColumn+'rem">';firstColumn+=this._renderRowGroupContent1stColumn(record);firstColumn+="</div>";table+='<div row="'+rowIndex+'" groupLevel="'+record.$groupLevel+'" class="datatable-group-row">';table+=this._renderRowGroupContent(record);table+="</div>"}else{firstColumn+='<div col="-1" row="'+rowIndex+'" recordId="'+record.id+'" class="datatable-cell-1st" style="width: '+this.defaultColumnWidth.firstColumn+"rem; min-width: "+this.defaultColumnWidth.firstColumn+'rem">';firstColumn+=this._renderRowContent1stColumn(record,rowIndex);firstColumn+="</div>";table+='<div row="'+rowIndex+'" recordId="'+record.id+'" class="datatable-row">';table+=this._renderRowContent(record,rowIndex);table+="</div>"}nbOfRows++}}this.datatableBody.innerHTML=table;this.datatableBody1stColumn.innerHTML=firstColumn;this._renderPagerIndex();this._renderSelection();this._renderScroller();this._renderEmptyIcon();return this}_renderEmptyIcon(){if(this.collection.records.length=="0"){this.datatableBodyContainer.classList.add("datatable-body-container-empty")}else{this.datatableBodyContainer.classList.remove("datatable-body-container-empty")}}_renderRowDiv(rowIndex){let record=this.collection.records[rowIndex];if(record.$type=="group")return this._renderRowGroupDiv(record,rowIndex);let newRow=document.createElement("div");newRow.setAttribute("row",rowIndex);newRow.setAttribute("recordid",record.id);newRow.classList.add("datatable-row");let isSelected=!(this.selectedRecords.indexOf(record.id)==-1);if(isSelected)newRow.classList.add("datatable-row-selected");newRow.innerHTML=this._renderRowContent(record,rowIndex);return newRow}_renderRowDiv1stColumn(rowIndex){let record=this.collection.records[rowIndex];if(record.$type=="group")return this._renderRowGroupDiv1stColumn(record,rowIndex);let firstCell=document.createElement("div");firstCell.setAttribute("col","-1");firstCell.setAttribute("row",rowIndex);firstCell.setAttribute("recordid",record.id);firstCell.classList.add("datatable-cell-1st");firstCell.style.width=firstCell.style.minWidth=this.defaultColumnWidth.firstColumn+"rem";let isSelected=!(this.selectedRecords.indexOf(record.id)==-1);firstCell.innerHTML=this._renderRowContent1stColumn(record,rowIndex,isSelected);return firstCell}_renderRowContent(record,rowIndex){let row="";for(let colIndex=0,length=this.visibleColumns.length;colIndex<length;colIndex++){let column=this.visibleColumns[colIndex];let value=column.renderer({value:record[column.id],record:record,config:{rowIndex:rowIndex,colIndex:colIndex,thumbSize:this.thumbSize}});row+=`<div col=${colIndex} class="datatable-cell datatable-type-${column.type}" style="${this._columnsConvertWidthToStyle(column.width)}; ${column.color?`color: ${column.color}`:""}">`+value+"</div>"}row+="<div class='datatable-cell datatable-cell-blank'></div>";return row}_renderRowContent1stColumn(record,rowIndex,isSelected){return(this.canSelect?'<span class="datatable-row-checkbox datatable-row-checkbox-'+(isSelected?"on":"off")+'"></span>':"")+'<span class="datatable-row-number">'+(record.$index+1||Number(rowIndex+1))+"</span>"+'<span class="datatable-row-action '+this.iconAction+'"></span>'}_renderRowGroupDiv(record,rowIndex){let newRow=document.createElement("div");newRow.setAttribute("row",rowIndex);newRow.classList.add("datatable-group-row");newRow.innerHTML=this._renderRowGroupContent(record);return newRow}_renderRowGroupDiv1stColumn(record,rowIndex){let firstCell=document.createElement("div");firstCell.setAttribute("col","-1");firstCell.setAttribute("row",rowIndex);firstCell.classList.add("datatable-group","datatable-group-level-"+record.$groupLevel);firstCell.style.width=firstCell.style.minWidth=this.defaultColumnWidth.firstColumn+"rem";firstCell.innerHTML=this._renderRowGroupContent1stColumn(record);return firstCell}_renderRowGroupContent(record){let row="";for(let colIndex=0,length=this.visibleColumns.length;colIndex<length;colIndex++){const column=this.visibleColumns[colIndex];const field=this.model.getField(column.id);const precision=field&&field.precision||0;const unit=field&&field.unit||"";let cellRawValue=record[column.id];if(cellRawValue!==undefined){const aggregationType=column.summary||"summary";const aggregationSettings=`<span class='fas fa-caret-down datatable-group-summary'><span>${txtTitleCase("#"+aggregationType)}</span></span>`;cellRawValue=aggregationType!="summary"?cellRawValue[aggregationType].format(precision)+" "+unit:" ";row+='<div col="'+colIndex+'" class="datatable-group-cell" style="'+this._columnsConvertWidthToStyle(column.width)+'">'+aggregationSettings+cellRawValue+"</div>"}else{row+='<div col="'+colIndex+'" class="datatable-group-cell" style="'+this._columnsConvertWidthToStyle(column.width)+'"></div>'}}row+="<div class='datatable-cell datatable-cell-blank'></div>";return row}_renderRowGroupContent1stColumn(record){let groupFieldId=this.collection.group[record.$groupLevel];let groupColumn=this.getColumn(groupFieldId);let groupClass=this.collection.collapsedGroups.includes(record.$groupId)?"datatable-group-collapsed":"datatable-group-expanded";let groupRawValue=record.$name;let groupCellValue=groupColumn?groupColumn.renderer({value:groupRawValue,record:record,config:{thumbSize:this.thumbSize}}):"...";return"<span class='"+groupClass+"'></span>"+(this.showGroupHierarchy?"<span class='datatable-group-hierarchy'>"+record.$groupId+"</span>":"")+groupCellValue+"&nbsp;&nbsp;("+record.$size+")"}_renderColumnHeader(column,index){let localColumnWidthStyle=this._columnsConvertWidthToStyle(column.width);let localColumnTitleWidthStyle=this._columnsConvertWidthToStyle(column.width-this.resizerWidth);let columnTitle=column.title;if(this.showColumnType){const fieldType=kiss.global.fieldTypes.find((fieldType=>fieldType.value==column.type));const icon=fieldType?fieldType.icon:"";if(icon)columnTitle=`<i class="${icon} datatable-column-header-icon"></i>${column.title}`}return`<div id="header-${column.id}" col="${index}" class="datatable-column-header" style="${localColumnWidthStyle}">\n                    <span\n                        id="header-title-${column.id}"\n                        class="datatable-column-header-title"\n                        draggable="true"\n                        ondragstart="this.closest('a-datatable')._columnsMoveWithdragAndDrop('dragstart', event, this)"\n                        ondragover="this.closest('a-datatable')._columnsMoveWithdragAndDrop('dragover', event, this)"\n                        ondragleave="this.closest('a-datatable')._columnsMoveWithdragAndDrop('dragleave', event, this)"\n                        ondrop="this.closest('a-datatable')._columnsMoveWithdragAndDrop('drop', event, this)"\n                        style="${localColumnTitleWidthStyle}"\n                    >\n                    ${columnTitle}\n                    </span>\n                    <span id="header-properties-for:${column.id}" class="datatable-column-header-properties fas fa-chevron-down">&nbsp</span>\n                    <span id="header-resizer-for:${column.id}" class="datatable-column-header-resizer">&nbsp</span>\n                </div>`.removeExtraSpaces()}_prepareCellRenderers(){this.columns.forEach((column=>{if(column.renderer)return;switch(column.type){case"number":case"date":case"textarea":case"aiTextarea":case"richTextField":case"select":case"directory":case"checkbox":case"slider":case"rating":case"color":case"icon":case"attachment":case"aiImage":case"selectViewColumn":case"password":case"link":column.renderer=kiss.fields.renderers[this.model.id][column.id];break;case"button":column.renderer=this._prepareCellRendererForButtons(column);break;default:column.renderer=kiss.fields.defaultRenderer}}));return this}_prepareCellRendererForButtons(column){let colIndex="column_"+kiss.tools.shortUid();if(!column.id)column.id=colIndex;column.title=column.text||txtTitleCase("action");return function({record:record,config:config}){return`\n                <center>\n                    <span id="column-button-${config.rowIndex}-${config.colIndex}" class="a-button datatable-cell-button" ${column.button.tip?`onmouseover="this.attachTip('${column.button.tip}')"`:""} onclick="this.getComponent()._rowTriggerButtonAction('${config.rowIndex}', '${column.id}', '${record.id}')">\n                        ${column.button.icon?`<span class="button-icon ${column.button.icon}"></span>`:""}\n                        ${column.button.text?`<span class="button-text">${column.button.text}</span>`:""}\n                    </span>\n                </center>`.removeExtraSpaces()}}_cellPreviewAttachment(event,fieldId){const attachmentId=event.target.id;const cell=event.target.closest(".datatable-cell");const record=this._cellGetRecord(cell);const cellAttachments=record[fieldId];createPreviewWindow(cellAttachments,attachmentId)}_renderScroller(){setTimeout((()=>{this.datatableScrollerContainer.style.top=kiss.tools.pxToRem(this.datatableBody.getBoundingClientRect().top)+"rem";this.datatableScrollerContainer.style.left=kiss.tools.pxToRem(this.getBoundingClientRect().right-this.datatableScrollerContainer.offsetWidth)+"rem";this._showScroller()}),50);this.datatableScrollerContainer.style.height=kiss.tools.pxToRem(this.datatableBody.offsetHeight-10)+"rem";this.datatableScroller.style.height=Math.min(this.collection.count*this.rowHeight,1e4)+"rem"}_showScroller(){if(this.showScroller!==false){setTimeout((()=>{this.datatableScrollerContainer.style.visibility="visible"}),0)}}_hideScroller(){this.datatableScrollerContainer.style.visibility="hidden"}_renderScrollerPosition(){let percent=this.skip/(this.collection.records.length-this.limit);let topPosition=Math.round((this.datatableScroller.offsetHeight-this.datatableBody.offsetHeight)*percent);this.preventScroll=true;this.datatableScrollerContainer.scrollTop=topPosition}_renderSelection(){if(!this.selectedRecords)return;this.selectedRecords.forEach((recordId=>{let rowIndexes=this._rowGetAllIndexes(recordId);rowIndexes.forEach((rowIndex=>this._rowSelect(rowIndex)))}))}_renderSelectionRestore(){this.getSelection();this._renderBody()}_renderToolbar(){if(this.isToolbarRendered){this._groupUpdateGroupingFields();return}createButton({hidden:!this.canCreateRecord,class:"datatable-create-record",target:"create:"+this.id,text:this.config.createRecordText||this.model.name.toTitleCase(),icon:"fas fa-plus",iconColor:this.color,borderWidth:"0.3rem",borderRadius:"3.2rem",maxWidth:kiss.screen.isMobile&&kiss.screen.isVertical()?"16rem":null,action:async()=>this.createRecord(this.model)}).render();createButton({hidden:this.showActions===false,target:"actions:"+this.id,tip:txtTitleCase("actions"),icon:"fas fa-bolt",iconColor:this.color,width:"3.2rem",action:()=>this._buildActionMenu()}).render();createButton({hidden:!this.canSelectFields,target:"select:"+this.id,tip:txtTitleCase("#display fields"),icon:"fas fa-bars fa-rotate-90",iconColor:this.color,width:"3.2rem",action:()=>this.showFieldsWindow()}).render();createButton({hidden:!this.canSort,target:"sort:"+this.id,tip:txtTitleCase("to sort"),icon:"fas fa-sort",iconColor:this.color,width:"3.2rem",action:()=>this.showSortWindow()}).render();createButton({hidden:!this.canFilter,target:"filter:"+this.id,tip:txtTitleCase("to filter"),icon:"fas fa-filter",iconColor:this.color,width:"3.2rem",action:()=>this.showFilterWindow()}).render();createButton({hidden:!this.showLayoutButton,target:"layout:"+this.id,tip:{text:txtTitleCase("layout"),minWidth:"10rem"},icon:"fas fa-ellipsis-v",iconColor:this.color,width:"3.2rem",action:()=>this._buildLayoutMenu()}).render();createButton({hidden:!this.canAddField,target:"add:"+this.id,tip:txtTitleCase("add a column"),icon:"fas fa-plus",iconColor:this.color,width:"3.2rem",action:()=>this._showColumnSetup()}).render();let groupingFields=this._groupGetModelFields();let groupingFieldValues=[];this.collection.group.forEach((fieldId=>{let groupingField=groupingFields.find((field=>field.value==fieldId));if(groupingField)groupingFieldValues.push(groupingField.value)}));createSelect({hidden:!this.canGroup,target:"group:"+this.id,id:"grouping-field:"+this.id,label:txtTitleCase("group by"),multiple:true,allowClickToDelete:true,options:groupingFields,minWidth:"20rem",maxHeight:()=>kiss.screen.current.height-200,optionsColor:this.color,value:groupingFieldValues,styles:{this:"align-items: center;","field-label":"white-space: nowrap;","field-select":"white-space: nowrap;"},events:{change:async function(event){let groupFields=this.getValue();if(groupFields.length>6){let fieldGroupSelect=$(this.id);fieldGroupSelect.value=fieldGroupSelect.getValue().slice(0,6);fieldGroupSelect._renderValues();createDialog({type:"message",title:txtTitleCase("seriously"),icon:"fas fa-exclamation-triangle",message:txtTitleCase("#too many groups"),buttonOKText:txtTitleCase("#understood")});return}let viewId=this.id.split(":")[1];publish("EVT_VIEW_GROUPING:"+viewId,groupFields)}}}).render();this.buttonExpand=createButton({hidden:!this.showGroupButtons||this.collection.group.length===0,target:"expand:"+this.id,tip:txtTitleCase("expand all"),icon:"far fa-plus-square",iconColor:this.color,width:"3.2rem",action:()=>this.expandAll()}).render();this.buttonCollapse=createButton({hidden:!this.showGroupButtons||this.collection.group.length===0,target:"collapse:"+this.id,tip:txtTitleCase("collapse all"),icon:"far fa-minus-square",iconColor:this.color,width:"3.2rem",action:()=>this.collapseAll()}).render();if(!kiss.screen.isMobile){createButton({target:"refresh:"+this.id,tip:txtTitleCase("refresh"),icon:"fas fa-undo-alt",iconColor:this.color,width:"3.2rem",events:{click:()=>this.reload()}}).render()}this.buttonShowHierarchy=createCheckbox({hidden:true,target:"hierarchy:"+this.id,tip:txtTitleCase("show group hierarchy"),iconOff:"fas fa-list-ol",iconOn:"fas fa-list-ol",iconColorOn:this.color,checked:this.showGroupHierarchy,events:{change:event=>{this.showGroupHierarchy=event.target.getValue();this._render()}}}).render();createButton({hidden:!this.canSearch,target:"search:"+this.id,icon:"fas fa-search",iconColor:this.color,width:"3.2rem",events:{click:()=>this.showSearchBar()}}).render();createButton({hidden:kiss.screen.isMobile&&kiss.screen.isVertical(),target:"pager-first:"+this.id,icon:"fas fa-step-backward",iconColor:this.color,width:"3.2rem",events:{click:()=>this.showFirstPage()}}).render();createButton({target:"pager-previous:"+this.id,icon:"fas fa-chevron-left",iconColor:this.color,width:"3.2rem",events:{click:()=>this.showPreviousPage()}}).render();createButton({target:"pager-next:"+this.id,icon:"fas fa-chevron-right",iconColor:this.color,width:"3.2rem",events:{click:()=>this.showNextPage()}}).render();createButton({hidden:kiss.screen.isMobile&&kiss.screen.isVertical(),target:"pager-last:"+this.id,icon:"fas fa-step-forward",iconColor:this.color,width:"3.2rem",events:{click:()=>this.showLastPage()}}).render();this._buildCustomButtons();this.isToolbarRendered=true}_rowToggleSelect(rowIndex){let checkbox=this._rowGetCheckbox(rowIndex);let recordId=checkbox.parentNode.getAttribute("recordId");let rowIndexes=this._rowGetAllIndexes(recordId);let isSelected=this.selectedRecords.indexOf(recordId)!=-1;if(isSelected){rowIndexes.forEach((rowIndex=>this._rowDeselect(rowIndex)));kiss.selection.delete(this.id,recordId)}else{rowIndexes.forEach((rowIndex=>this._rowSelect(rowIndex)));kiss.selection.insertOne(this.id,recordId)}this.selectedRecords=kiss.selection.get(this.id);return recordId}_rowSelect(rowIndex){let checkbox=this._rowGetCheckbox(rowIndex);if(!checkbox)return;checkbox.classList.add("datatable-row-checkbox-on");checkbox.classList.remove("datatable-row-checkbox-off");let row=this.datatableBody.querySelector('[row="'+rowIndex+'"]');row.classList.add("datatable-row-selected")}_rowDeselect(rowIndex){let checkbox=this._rowGetCheckbox(rowIndex);if(!checkbox)return;checkbox.classList.add("datatable-row-checkbox-off");checkbox.classList.remove("datatable-row-checkbox-on");let row=this.datatableBody.querySelector('[row="'+rowIndex+'"]');row.classList.remove("datatable-row-selected")}_rowHighlight(rowIndex){let row=this.querySelector('[row="'+rowIndex+'"]');if(!row)return;row.classList.add("datatable-row-selected")}async _rowTriggerButtonAction(rowIndex,colId,recordId){const column=this.columns.get(colId);let record=this.collection.records[rowIndex];if(column.button.action)await column.button.action(rowIndex,colId,recordId,record)}_rowGetCheckbox(rowIndex){return this.datatableBody1stColumn.querySelector('[row="'+rowIndex+'"]').querySelector(".datatable-row-checkbox")}_rowGetIndex(recordId){let row=this.datatableBody.querySelector("div[recordId='"+recordId+"']");if(row)return row.getAttribute("row");else return null}_rowFindIndex(recordId){return this.collection.records.findIndex((record=>record.id==recordId))}_rowGetAllIndexes(recordId){let rows=this.datatableBody.querySelectorAll("div[recordId='"+recordId+"']");if(rows)return Array.from(rows).map((row=>row.getAttribute("row")));else return null}_getRowHeightFromLocalStorage(){const localStorageId="config-view-datatable-"+this.id+"-row-height";const rowHeight=localStorage.getItem(localStorageId);if(!rowHeight)return this.defaultRowHeight;return Number(rowHeight)}_columnsSetWidth(columnId,newWidth){let localStorageId;if(columnId=="1stColumn"){localStorage.setItem("config-view-datatable-"+this.id+"-1st-column",newWidth);return}let columnIndex=this.columns.findIndex((column=>column.id==columnId));if(newWidth<=1)newWidth=1;this.columns[columnIndex].width=newWidth;localStorageId="config-view-datatable-"+this.id+"-columns";localStorage.setItem(localStorageId,JSON.stringify(this.columns))}_columnsMoveWithdragAndDrop(phase,event,element){let target=event.target;let targetCenterX=null;let colIndex=target.closest("div").getAttribute("col");let columnCells=Array.from(this.querySelectorAll("div[col='"+colIndex+"']"));switch(phase){case"dragstart":this.sourceColumnId=target.id.split("title-")[1];break;case"dragover":targetCenterX=target.offsetLeft+target.clientWidth/2;if(event.x<targetCenterX){columnCells.forEach((cell=>{cell.classList.remove("datatable-column-dragover-right");cell.classList.add("datatable-column-dragover-left")}))}else{columnCells.forEach((cell=>{cell.classList.remove("datatable-column-dragover-left");cell.classList.add("datatable-column-dragover-right")}))}event.preventDefault();return false;case"dragleave":columnCells.forEach((cell=>{cell.classList.remove("datatable-column-dragover-left");cell.classList.remove("datatable-column-dragover-right")}));break;case"drop":event.stopPropagation();columnCells.forEach((cell=>{cell.classList.remove("datatable-column-dragover-left");cell.classList.remove("datatable-column-dragover-right")}));targetCenterX=target.offsetLeft+target.clientWidth/2;let position=event.x<targetCenterX?"before":"after";this._columnsMove(this.sourceColumnId,target.id.split("title-")[1],position);break}}_columnsResizeWithDragAndDrop(event,element){let columnId=element.parentNode.id.split("header-")[1];let colIndex=element.parentNode.getAttribute("col");let columnCells=Array.from(this.querySelectorAll("div[col='"+colIndex+"']"));let columnHeader=element.parentNode;let columnHeaderTitle=columnHeader.children[0];columnHeader.mouseStartX=event.x;let currentWidth=columnHeader.clientWidth;let newWidth;let columnMinSize=columnId=="1stColumn"?9:5;document.onmousemove=event=>{let _event=event;setTimeout((()=>{newWidth=kiss.tools.pxToRem(currentWidth+_event.x-columnHeader.mouseStartX);if(newWidth>columnMinSize){columnHeader.style.minWidth=columnHeader.style.width=newWidth+"rem";columnHeaderTitle.style.minWidth=columnHeaderTitle.style.width=newWidth-this.resizerWidth+"rem";columnCells.forEach((cell=>cell.style.width=cell.style.minWidth=newWidth+"rem"));if(columnId=="1stColumn")this._columnsSetFirstColumnWidth(newWidth)}}),1)};document.onmouseup=()=>{this._columnsSetWidth(columnId,Math.max(columnMinSize,newWidth));document.onmousemove=null;document.onmouseup=null}}_columnsConvertWidthToStyle(width){return"width: "+width+"rem; min-width: "+width+"rem;"}_columnsSetFirstColumnWidth(newWidth){this.defaultColumnWidth.firstColumn=newWidth;this.datatableHeader1stColumn.style.minWidth=newWidth+"rem";this.datatableBody1stColumn.style.minWidth=newWidth+"rem"}_columnsAdjustWidthFromLocalStorage(){let localStorageId="config-view-datatable-"+this.id+"-1st-column";let firstColumnWidth=localStorage.getItem(localStorageId);this.defaultColumnWidth.firstColumn=firstColumnWidth||this.defaultColumnWidth.firstColumn;localStorageId="config-view-datatable-"+this.id+"-columns";let localColumns=JSON.parse(localStorage.getItem(localStorageId));this.columns=this.columns.map((column=>{const defaultColumnWidth=this.defaultColumnWidth[column.type]||this.defaultColumnWidth.default;column.width=column.width||defaultColumnWidth;if(localColumns){let localColumn=localColumns.find((localColumn=>localColumn.id==column.id));if(localColumn&&localColumn.width)column.width=localColumn.width}return column}))}_columnsSetAggregationType(column,x,y){createMenu({items:[{text:txtTitleCase("sum"),icon:"fas fa-chart-bar",action:async()=>{column.summary="sum";this._render();this.updateConfig({config:{columns:this.columns}})}},{text:txtTitleCase("average"),icon:"fas fa-tachometer-alt",action:async()=>{column.summary="avg";this._render();this.updateConfig({config:{columns:this.columns}})}},{text:txtTitleCase("#no summary"),icon:"fas fa-ban",action:async()=>{delete column.summary;this._render();this.updateConfig({config:{columns:this.columns}})}}]}).render().showAt(x,y)}_cellSetValue(recordId,fieldId,value){try{const colIndex=this.visibleColumns.findIndex((column=>column.id==fieldId));if(colIndex==-1)return;const column=this.visibleColumns[colIndex];const record=this.collection.getRecord(recordId);const rowIndexes=this._rowGetAllIndexes(recordId);rowIndexes.forEach((rowIndex=>{const row=this.datatableBody.querySelector("div[row='"+rowIndex+"']");const cell=row.querySelector("div[col='"+colIndex+"']");cell.innerHTML=column.renderer({value:value,record:record,config:{rowIndex:rowIndex,colIndex:colIndex,thumbSize:this.thumbSize}})}))}catch(err){log("kiss.ui - datatable - Couldn't set the cell value",4,err)}}async _cellSetCheckboxValue(recordId,fieldId){let record=this.collection.getRecord(recordId);let currentCellValue=record[fieldId]||false;await record.updateFieldDeep(fieldId,!currentCellValue)}async _cellSetRatingValue(recordId,fieldId,event){if(!event.target.classList.contains("rating"))return;let record=this.collection.getRecord(recordId);let currentCellValue=record[fieldId];const index=event.target.getAttribute("index");const newValue=Number(index)+1;if(newValue!=currentCellValue)await record.updateFieldDeep(fieldId,newValue)}_cellGetNext(cell,direction){let shift={up:{x:0,y:-1},down:{x:0,y:1},left:{x:-1,y:0},right:{x:1,y:0}};let rowIndex=this._cellGetRowIndex(cell)+shift[direction].y;let colIndex=this._cellGetColIndex(cell)+shift[direction].x;let row=this.datatableBody.querySelector("div[row='"+rowIndex+"']");if(!row)return null;if(row.className=="datatable-group-row")return null;let nextCell=row.querySelector("div[col='"+colIndex+"']");if(!nextCell)return null;if(this._cellIsEditable(nextCell)){return null}else{return nextCell}}_cellGetRowIndex(cell){return Number(cell.parentNode.getAttribute("row"))}_cellGetColIndex(cell){return Number(cell.getAttribute("col"))}_cellGetRecordId(cell){let rowIndex=this._cellGetRowIndex(cell);return this.collection.records[rowIndex].id}_cellGetRecordData(cell){let rowIndex=this._cellGetRowIndex(cell);return this.collection.records[rowIndex]}_cellGetRecord(cell){let recordId=this._cellGetRecordId(cell);return this.collection.getRecord(recordId)}_cellGetFieldId(cell){let col=cell.getAttribute("col");let colHeader=this.datatableHeader.querySelector("div[col='"+col+"']");return colHeader.id.split("header-")[1]}_cellGetColumn(cell){let colId=this._cellGetFieldId(cell);return this.columns.get(colId)}_cellIsEditable(cell){const fieldId=this._cellGetFieldId(cell);const field=this.model.getField(fieldId);if(field.computed)return false;if(field.readOnly)return false;if(field.type=="lookup"||field.type=="summary")return false;if(field.acl){const acl=field.acl.update;return acl!==false}return true}_cellGetText(cell){let textContent="";function extractText(node){if(node.nodeType===Node.TEXT_NODE){textContent+=node.textContent.trim()}else if(node.nodeType===Node.ELEMENT_NODE){if(node.tagName==="BR"){textContent+="\n"}else{node.childNodes.forEach((child=>extractText(child)))}}}extractText(cell);if(textContent.includes("\n")||textContent.includes('"')){textContent=`"${textContent.replace(/"/g,'""')}"`}return textContent}_getCellsInRange(startCell,endCell){const startRowIndex=parseInt(startCell.closest(".datatable-row").getAttribute("row"),10);const endRowIndex=parseInt(endCell.closest(".datatable-row").getAttribute("row"),10);const startColIndex=parseInt(startCell.getAttribute("col"),10);const endColIndex=parseInt(endCell.getAttribute("col"),10);const rangeStartRow=Math.min(startRowIndex,endRowIndex);const rangeEndRow=Math.max(startRowIndex,endRowIndex);const rangeStartCol=Math.min(startColIndex,endColIndex);const rangeEndCol=Math.max(startColIndex,endColIndex);const cells=[];for(let rowIndex=rangeStartRow;rowIndex<=rangeEndRow;rowIndex++){const row=this.querySelector(`.datatable-row[row="${rowIndex}"]`);if(row&&!row.classList.contains("datatable-group-row")){for(let colIndex=rangeStartCol;colIndex<=rangeEndCol;colIndex++){const cell=row.querySelector(`.datatable-cell[col="${colIndex}"]`);if(cell)cells.push(cell)}}}return cells}async _copySelectedCellsDataToClipboard(){let clipboardData="";let records=[];const startIndex=Math.min(this.startCellData.rowIndex,this.endCellData.rowIndex);const endIndex=Math.max(this.startCellData.rowIndex,this.endCellData.rowIndex);const startColIndex=Math.min(this.startCellData.colIndex,this.endCellData.colIndex);const endColIndex=Math.max(this.startCellData.colIndex,this.endCellData.colIndex);for(let rowIndex=startIndex;rowIndex<=endIndex;rowIndex++){records.push(this.collection.records[rowIndex])}records=records.filter((record=>record.$type!="group"));for(const record of records){const recordData=await record.getData({convertNames:true});for(let colIndex=startColIndex;colIndex<=endColIndex;colIndex++){const column=this.visibleColumns[colIndex];let value=recordData[column.id];value=this.formatValueForClipboard(column,value);clipboardData+=value+"\t"}clipboardData+="\n"}kiss.tools.copyTextToClipboard(clipboardData);createNotification(txtTitleCase("copied to clipboard"))}async _copySelectedRowsDataToClipboard(){let clipboardData="";const records=this.getSelectedRecords();for(const record of records){const recordData=await record.getData({convertNames:true});for(const column of this.visibleColumns){let value=recordData[column.id];value=this.formatValueForClipboard(column,value);clipboardData+=value+"\t"}clipboardData+="\n"}kiss.tools.copyTextToClipboard(clipboardData);createNotification(txtTitleCase("copied to clipboard"))}async _cellOpenLinkedRecord(fieldId,recordId){const record=this.collection.getRecord(recordId);if(!record)return;const links=await kiss.data.relations.getLinksAndRecords(record.model.id,record.id,fieldId);const foreignRecords=links.map((link=>link.record));if(links.length==0){const field=record.model.getField(fieldId);const foreignModelId=field.link.modelId;const foreignModel=kiss.app.models[foreignModelId];const foreignModelName=foreignModel.namePlural;return createNotification(txtTitleCase("#no links",null,{table:foreignModelName}))}const field=this.model.getField(fieldId);const foreignModel=kiss.app.models[field.link.modelId];if(links.length==1){const foreignRecord=foreignModel.create(foreignRecords[0]);this.selectRecord(foreignRecord)}else{kiss.context.records=foreignRecords;createRecordSelectionWindow(foreignModel,fieldId,foreignRecords,null,{canSelect:false})}}async _cellSwitchToEditMode(cell,event){const _this=this;let updateOnBlur=true;cell.onkeydown=null;const record=this._cellGetRecord(cell);const recordId=record.id;const fieldId=this._cellGetFieldId(cell);const field=this.model.getField(fieldId);const fieldType=field.type;const column=this.getColumn(fieldId);const cellType=column.type;if(["attachment","aiImage","button","custom"].indexOf(cellType)!=-1)return;if(column.isFromPlugin)return;const fieldInitialValue=record[fieldId]||"";const cellInitialStyle=cell.getAttribute("style");if(field.computed||field.readOnly)return;if(fieldType=="link")return await this.selectRecordById(recordId);if(fieldType=="checkbox")return this._cellSetCheckboxValue(recordId,fieldId);if(fieldType=="rating")return this._cellSetRatingValue(recordId,fieldId,event);if(fieldType=="textarea"||fieldType=="aiTextarea")return this._cellEditTextarea(cell,field,fieldInitialValue);if(fieldType=="textarea"||fieldType=="richTextField")return this._cellEditRichText(cell,field,fieldInitialValue);if(fieldType=="select"||fieldType=="selectViewColumn")return this._cellEditSelect(cell,field);if(fieldType=="selectViewColumns")return this._cellEditSelectViewColumns(cell,field);if(fieldType=="directory")return this._cellEditSelect(cell,field);if(fieldType=="color")return this._cellEditColor(cell,field);if(fieldType=="icon")return this._cellEditIcon(cell,field);let cellWidth=kiss.tools.pxToRem(cell.clientWidth)+"rem";let cellHeight=kiss.tools.pxToRem(cell.clientHeight)+"rem";let inputId="input-"+recordId+"-"+fieldId;const dataType=["number","rating","slider"].includes(field.type)?"number":field.type;const cellValue=typeof fieldInitialValue=="string"?fieldInitialValue.escapeHtml():fieldInitialValue;cell.innerHTML=`<input class="datatable-cell-edited" id="${inputId}" type="${dataType}" value="${cellValue}">`;let fieldInput=$(inputId);cell.style.width=fieldInput.style.width=cellWidth;cell.style.height=fieldInput.style.height=cellHeight;fieldInput.style.border="none";fieldInput.style.padding="var(--datacomponent-cell-padding)";fieldInput.style.color="var(--datacomponent-cell)";fieldInput.style.background="var(--datacomponent-input-background)";fieldInput.focus();fieldInput.select();fieldInput.onkeydown=await(async function(event){updateOnBlur=true;let editNextCell=false;if(event.shiftKey&&event.key=="Tab"){editNextCell="left"}else if(event.key=="Tab"){editNextCell="right"}else if(event.key=="Enter"){editNextCell="down"}else if(event.key=="Escape"){updateOnBlur=false;this.reset()}if(editNextCell){updateOnBlur=false;event.stop();const result=this.updateCell();if(!result)return false;const nextCell=_this._cellGetNext(cell,editNextCell);if(nextCell)_this._cellSwitchToEditMode(nextCell)}});fieldInput.updateCell=async function(){let success=kiss.tools.validateValue(fieldType,field,this.value);if(!success){createNotification(txtTitleCase("#fields incorrect value"));this.reset();return false}const newValue=fieldType=="number"?Number(this.value):this.value;if(newValue!=fieldInitialValue){success=await record.updateFieldDeep(fieldId,newValue);if(!success){this.value=fieldInitialValue;this.reset()}}else{this.reset()}};fieldInput.reset=function(){try{cell.removeAttribute("style");cell.setAttribute("style",cellInitialStyle);cell.innerHTML=column.renderer({value:fieldInitialValue})}catch(err){log("kiss.ui - datatable - Couldn't restore the cell value",4,err)}};fieldInput.onblur=async function(){if(updateOnBlur)this.updateCell()}}_cellEditTextarea(cell,field,initialValue){const column=this._cellGetColumn(cell);createPanel({id:"panel-edit-textarea",title:txtTitleCase("edit field"),icon:"fas fa-edit",headerBackgroundColor:this.color,closable:true,modal:true,draggable:true,width:"66rem",height:"66rem",align:"center",verticalAlign:"center",layout:"vertical",items:[{id:"datatable-edit-textarea",type:"textarea",label:column.title,labelPosition:"top",value:initialValue,required:field.required,minLength:field.minLength,maxLength:field.maxLength,fieldWidth:"100%",fieldHeight:"100%",flex:1},{layout:"horizontal",defaultConfig:{type:"button",flex:1,margin:"0 0.5rem"},items:[{text:txtUpperCase("cancel"),icon:"fas fa-times",action:()=>{$("panel-edit-textarea").doNotModifyValue=true;$("panel-edit-textarea").close()}},{text:txtUpperCase("ok"),icon:"fas fa-check",color:"var(--green)",iconColor:"var(--green)",action:()=>$("panel-edit-textarea").close()}]}],events:{onclose:()=>{if($("panel-edit-textarea").doNotModifyValue)return;const textarea=$("datatable-edit-textarea");let newTextareaValue=textarea.getValue();if(newTextareaValue==initialValue)return;const success=textarea.validate();if(!success){createNotification(txtTitleCase("#fields incorrect value"));return}let record=this._cellGetRecord(cell);record.updateFieldDeep(field.id,newTextareaValue)},onkeydown:function(event){if(event.key!="Escape")return;$("datatable-edit-textarea").setValue(initialValue);$("panel-edit-textarea").doNotModifyValue=true;this.close()}},methods:{load:()=>setTimeout((()=>$("datatable-edit-textarea").focus()),100)}}).render()}_cellEditRichText(cell,field,initialValue){const column=this._cellGetColumn(cell);createPanel({id:"panel-edit-richtext",title:txtTitleCase("edit field"),icon:"fas fa-edit",headerBackgroundColor:this.color,closable:true,modal:true,draggable:true,width:"66rem",height:"66rem",align:"center",verticalAlign:"center",layout:"vertical",items:[{layout:"vertical",overflowY:"auto",flex:1,items:[{id:"datatable-edit-richtext",type:"richTextField",label:column.title,labelPosition:"top",value:initialValue,required:field.required,fieldWidth:"100%",flex:1}]},{layout:"horizontal",margin:"1rem 0 0 0",defaultConfig:{type:"button",flex:1,margin:"0 0.5rem"},items:[{text:txtUpperCase("cancel"),icon:"fas fa-times",action:()=>{$("panel-edit-richtext").doNotModifyValue=true;$("panel-edit-richtext").close()}},{text:txtUpperCase("ok"),icon:"fas fa-check",color:"var(--green)",iconColor:"var(--green)",action:()=>$("panel-edit-richtext").close()}]}],events:{onclose:()=>{if($("panel-edit-richtext").doNotModifyValue)return;const textarea=$("datatable-edit-richtext");let newTextareaValue=textarea.getValue();if(newTextareaValue==initialValue)return;const success=textarea.validate();if(!success){createNotification(txtTitleCase("#fields incorrect value"));return}let record=this._cellGetRecord(cell);record.updateFieldDeep(field.id,newTextareaValue)},onkeydown:function(event){if(event.key!="Escape")return;$("datatable-edit-richtext").setValue(initialValue);$("panel-edit-richtext").doNotModifyValue=true;this.close()}},methods:{load:()=>setTimeout((()=>$("datatable-edit-richtext").focus()),100)}}).render()}_cellEditColor(cell,field){let record=this._cellGetRecord(cell);let initialValue=record[field.id];const picker=createPanel({modal:true,header:false,width:"70.5rem",align:"center",verticalAlign:"center",items:[{type:"colorPicker",value:initialValue,selectorBorderRadius:"3.2rem",events:{change:function(){let color=this.getValue();record.updateFieldDeep(field.id,color);picker.close()}}}]}).render()}_cellEditIcon(cell,field){let record=this._cellGetRecord(cell);let initialValue=record[field.id];const picker=createPanel({modal:true,header:false,width:"67.5rem",align:"center",verticalAlign:"center",items:[{type:"iconPicker",value:initialValue,autoFocus:true,icons:kiss.webfonts.all,selectorBorderRadius:"3.2rem",height:"66rem",events:{change:function(){let icon=this.getValue();record.updateFieldDeep(field.id,icon);picker.close()}}}]}).render()}_cellEditSelect(cell,field){const record=this._cellGetRecord(cell);const column=this._cellGetColumn(cell);let initialValue=record[field.id];createPanel({id:"panel-edit-select",title:column.title,headerBackgroundColor:this.color,modal:true,draggable:true,width:"66rem",align:"center",verticalAlign:"center",layout:"vertical",items:[{id:field.id,type:field.type,value:initialValue,required:field.required,fieldWidth:"100%",maxHeight:"40rem",flex:1,options:field.options,users:field.users===false?false:true,groups:field.groups===false?false:true,roles:field.roles,multiple:field.multiple,template:field.template,min:field.min,max:field.max,interval:field.interval,allowClickToDelete:field.multiple,allowSwitchOnOff:field.multiple,allowValuesNotInList:field.allowValuesNotInList,viewId:field.viewId,fieldId:field.fieldId},{layout:"horizontal",defaultConfig:{type:"button",flex:1,margin:"0 0.5rem"},items:[{text:txtUpperCase("cancel"),icon:"fas fa-times",action:()=>{$("panel-edit-select").doNotModifyValue=true;$("panel-edit-select").close()}},{text:txtUpperCase("ok"),icon:"fas fa-check",color:"var(--green)",iconColor:"var(--green)",action:()=>$("panel-edit-select").close()}]}],events:{onclose:()=>{if($("panel-edit-select").doNotModifyValue)return;const selectField=$(field.id);let newValue=selectField.getValue();if(newValue==initialValue)return;const success=selectField.validate();if(!success){createNotification(txtTitleCase("this field is required"));return}record.updateFieldDeep(field.id,newValue)},onkeydown:function(event){if(event.key!="Escape")return;$(field.id).setValue(initialValue);$("panel-edit-select").doNotModifyValue=true;this.close()}}}).render()}async _cellEditSelectViewColumns(cell,field){const selectedRecord=this._cellGetRecord(cell);const viewRecord=await kiss.app.collections.view.findOne(field.viewId);const viewModel=kiss.app.models[viewRecord.modelId];const datatable=createDatatable({collection:viewModel.collection,sort:viewRecord.sort,filter:viewRecord.filter,group:viewRecord.group,canEdit:false,canAddField:false,canEditField:false,canCreateRecord:false,showActions:false,columns:viewRecord.config.columns,color:viewModel.color,height:()=>"calc(100vh - 20rem)",methods:{selectRecord:async function(record){const fieldId=field.fieldId[0];const otherFieldIds=field.fieldId.slice(1);let mapping=otherFieldIds.map((viewFieldId=>{let label=viewModel.getField(viewFieldId).label;let localField=selectedRecord.model.getFieldByLabel(label)||{};return{label:label,id:localField.id,viewFieldId:viewFieldId}})).filter((map=>map.id));let update={};update[field.id]=record[fieldId];mapping.forEach((map=>update[map.id]=record[map.viewFieldId]));await selectedRecord.updateDeep(update);this.closest("a-panel").close()}}});createPanel({modal:true,closable:true,title:"<b>"+viewModel.namePlural+"</b>",icon:viewModel.icon,headerBackgroundColor:viewModel.color,display:"flex",layout:"vertical",width:()=>"calc(100vw - 20rem)",height:()=>"calc(100vh - 20rem)",align:"center",verticalAlign:"center",autoSize:true,items:[datatable]}).render()}async _buildLayoutMenu(){let buttonLeftPosition=$("layout:"+this.id).offsetLeft;let buttonTopPosition=$("layout:"+this.id).offsetTop;createMenu({top:buttonTopPosition,left:buttonLeftPosition,items:[txtTitleCase("cell size"),"-",{icon:"fas fa-circle",iconSize:"0.2rem",text:txtTitleCase("compact"),action:()=>{this.rowHeight=3;this.setRowHeight(this.rowHeight)}},{icon:"fas fa-circle",iconSize:"0.6rem",text:txtTitleCase("normal"),action:()=>{this.rowHeight=this.defaultRowHeight;this.setRowHeight(this.rowHeight)}},{icon:"fas fa-circle",iconSize:"1rem",text:txtTitleCase("medium"),action:()=>{this.rowHeight=8;this.setRowHeight(this.rowHeight)}},{icon:"fas fa-circle",iconSize:"1.4rem",text:txtTitleCase("tall"),action:()=>{this.rowHeight=12;this.setRowHeight(this.rowHeight)}},{icon:"fas fa-circle",iconSize:"1.8rem",text:txtTitleCase("very tall"),action:()=>{this.rowHeight=16;this.setRowHeight(this.rowHeight)}},"-",{icon:"fas fa-undo-alt",text:txtTitleCase("#reset view params"),action:()=>this.resetLocalViewParameters()}]}).render()}async _buildCustomButtons(){if(!this.buttons)return;this.buttons.forEach((button=>{const newButton=createButton(button);const position=button.position||1;const target=this.datatableToolbar.children[position];this.datatableToolbar.insertBefore(newButton,target)}))}showTutorial(){setTimeout((()=>{kiss.tools.highlightElements([{element:document.body.querySelector(".datatable-header-last-column"),text:txtTitleCase("#add field help")},{element:document.body.querySelector(".datatable-create-record"),text:txtTitleCase("#create record help")},{element:document.body.querySelector(".datatable-row-action"),text:txtTitleCase("#open form help")}],(()=>{createDialog({title:txtTitleCase("#quick tips"),message:txtTitleCase("#replay tips"),buttonOKText:txtTitleCase("yes"),buttonCancelText:txtTitleCase("no"),action:()=>this.showTutorial()})}))}),200);delete kiss.context.onboard}};customElements.define("a-datatable",kiss.ui.Datatable);const createDatatable=config=>document.createElement("a-datatable").init(config);kiss.ui.Gallery=class Gallery extends kiss.ui.DataComponent{constructor(){super()}init(config){config.autoSize=true;super.init(config);this.showToolbar=config.showToolbar!==false;this.showActions=config.showActions!==false;this.showSetup=config.showSetup!==false;this.showLayoutButton=config.showLayoutButton!==false;this.showGroupButtons=config.showGroupButtons!==false;this.canSearch=config.canSearch!==false;this.canSort=config.canSort!==false;this.canFilter=config.canFilter!==false;this.canGroup=config.canGroup!==false;this.canSelect=config.canSelect!==false;this.canSelectFields=config.canSelectFields!==false;this.actions=config.actions||[];this.buttons=config.buttons||[];this.color=config.color||"#00aaee";this.defaultColumnWidth=20;this.collapsedGroups=new Set;let id=this.id;this.innerHTML=`<div class="gallery">\n                <div id="gallery-toolbar:${id}" class="gallery-toolbar">\n                    <div id="create:${id}"></div>\n                    <div id="actions:${id}"></div>\n                    <div id="setup:${id}"></div>\n                    <div id="select:${id}"></div>\n                    <div id="sort:${id}"></div>\n                    <div id="filter:${id}"></div>\n                    <div id="group:${id}"></div>\n                    <div id="collapse:${id}"></div>\n                    <div id="expand:${id}"></div>\n                    <div id="refresh:${id}"></div>\n                    <div id="search-field:${id}"></div>\n                    <div id="search:${id}"></div>\n                    <div class="spacer"></div>\n                    <div id="layout:${id}"></div>\n                </div>\n\n                <div class="gallery-body-container">\n                    <div id="gallery-body:${id}" class="gallery-body"></div>\n                </div>\n            </div>`.removeExtraSpaces();this.gallery=this.querySelector(".gallery");this.galleryToolbar=this.querySelector(".gallery-toolbar");this.galleryBodyContainer=this.querySelector(".gallery-body-container");this.galleryBody=this.querySelector(".gallery-body");this._initColumns(config.columns)._initGalleryParams(config)._initSize(config)._initElementsVisibility()._initEvents()._initSubscriptions();return this}async load(){try{log(`kiss.ui - Gallery ${this.id} - Loading collection <${this.collection.id} (changed: ${this.collection.hasChanged})>`);let currentFilter=this.filter;if(this.currentSearchTerm){currentFilter=this.createSearchFilter(this.currentSearchTerm)}await this.collection.find({filterSyntax:this.filterSyntax,filter:currentFilter,sortSyntax:this.sortSyntax,sort:this.sort,group:this.group,projection:this.projection,groupUnwind:this.groupUnwind});this.getSelection();this._renderToolbar()}catch(err){log(err);log(`kiss.ui - Gallery ${this.id} - Couldn't load data properly`)}}switchToSearchMode(){if(kiss.screen.isMobile){$("create:"+this.id).hide();$("search:"+this.id).hide();$("expand:"+this.id).hide();$("collapse:"+this.id).hide()}}resetSearchMode(){if(kiss.screen.isMobile){$("create:"+this.id).show();$("search:"+this.id).show();$("expand:"+this.id).show();$("collapse:"+this.id).show()}}async setColor(newColor){this.color=newColor;Array.from(this.galleryToolbar.children).forEach((item=>{if(item&&item.firstChild&&item.firstChild.type=="button")item.firstChild.setIconColor(newColor)}))}showSetupWindow(){let attachmentFields=this.model.getFieldsByType(["attachment","aiImage"]).filter((field=>!field.deleted)).map((field=>({value:field.id,label:field.label.toTitleCase()})));createPanel({icon:"fas fa-image",title:txtTitleCase("setup the gallery"),headerBackgroundColor:this.color,modal:true,backdropFilter:true,draggable:true,closable:true,align:"center",verticalAlign:"center",width:"40rem",defaultConfig:{labelPosition:"top",optionsColor:this.color},items:[{type:"checkbox",id:"gallery-showimage:"+this.id,label:txtTitleCase("#gallery show image"),labelPosition:"right",shape:"switch",iconColorOn:this.color,value:this.showImage,events:{change:async function(){let showImage=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{showImage:showImage});if(showImage==true){$("gallery-imagefield:"+viewId).show()}else{$("gallery-imagefield:"+viewId).hide()}}}},{hidden:!this.showImage,type:"select",id:"gallery-imagefield:"+this.id,label:txtTitleCase("#gallery image field"),options:attachmentFields,maxHeight:()=>kiss.screen.current.height-200,value:this.imageFieldId,events:{change:async function(){let imageFieldId=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{imageFieldId:imageFieldId})}}}]}).render()}showSortWindow(){let sortButton=$("sort:"+this.id);const box=sortButton.getBoundingClientRect();super.showSortWindow(box.left,box.top+40,this.color)}showFieldsWindow(){let selectionButton=$("select:"+this.id);const box=selectionButton.getBoundingClientRect();super.showFieldsWindow(box.left,box.top+40,this.color)}showFilterWindow(){super.showFilterWindow(null,null,this.color)}updateLayout(){if(this.isConnected){this._setWidth();this._setHeight();this._render()}}setColumnWidth(width){this.columnWidth=width;document.documentElement.style.setProperty("--gallery-column-width",this.columnWidth+"rem");const localStorageId="config-view-gallery-"+this.id+"-column-width";localStorage.setItem(localStorageId,this.columnWidth);this.reload()}async resetColumnsWidth(){this.columnWidth=this.defaultColumnWidth;document.documentElement.style.setProperty("--gallery-column-width",this.columnWidth+"rem");const localStorageId="config-view-gallery-"+this.id+"-column-width";localStorage.removeItem(localStorageId)}collapseGroup(groupId,group){group.classList.add("gallery-group-collapsed");group.classList.remove("gallery-group-expanded");this.collapsedGroups.add(groupId);this.galleryBody.querySelectorAll("[groupid]").forEach((el=>{const gid=el.getAttribute("groupid");if(gid!==groupId&&gid.startsWith(groupId+".")){el.style.display="none"}else if(gid===groupId&&!el.classList.contains("gallery-group")){el.style.display="none"}}));this._renderDetailsOfVisibleCards();return this}expandGroup(groupId,group){group.classList.add("gallery-group-expanded");group.classList.remove("gallery-group-collapsed");this.collapsedGroups.delete(groupId);this.galleryBody.querySelectorAll("[groupid]").forEach((el=>{const gid=el.getAttribute("groupid");if(!(gid===groupId||gid.startsWith(groupId+".")))return;const isGroup=el.classList.contains("gallery-group");const isRecord=el.classList.contains("gallery-record");if(this._isHiddenByCollapsedParent(gid,true))return;if(this.collapsedGroups.has(gid)){if(isGroup){el.style.display=""}else if(isRecord){el.style.display="none"}return}el.style.display=""}));this._renderDetailsOfVisibleCards();return this}collapseAll(){this.galleryBody.querySelectorAll(".gallery-group").forEach((el=>{let groupId=el.getAttribute("groupid");this.collapseGroup(groupId,el)}));return this}expandAll(){this.collapsedGroups.clear();this.galleryBody.querySelectorAll("[groupid]").forEach((el=>{el.classList.add("gallery-group-expanded");el.classList.remove("gallery-group-collapsed");el.style.display=""}));this._renderDetailsOfVisibleCards();return this}_initGalleryParams(config){if(this.record){this.imageFieldId=config.imageFieldId||this.record.config.imageFieldId;this.showImage=config.hasOwnProperty("showImage")?!!config.showImage:this.record.config.showImage!==false}else{this.imageFieldId=config.imageFieldId||this.config.imageFieldId;this.showImage=config.hasOwnProperty("showImage")?!!config.showImage:this.config.showImage!==false}if(!this.imageFieldId){let modelAttachmentFields=this.model.getFieldsByType(["attachment"]);if(modelAttachmentFields.length!=0){this.imageFieldId=modelAttachmentFields[0].id}}return this}_initElementsVisibility(){if(this.showToolbar===false)this.galleryToolbar.style.display="none";return this}_initSize(config){if(config.width){this._setWidth()}else{this.style.width=this.config.width="100%"}if(config.height){this._setHeight()}else{this.style.height=this.config.height="100%"}return this}_initColumnWidth(config={}){const isMobile=kiss.screen.isMobile;const isPortrait=kiss.screen.isVertical();if(isMobile&&isPortrait){this.columnWidth=kiss.screen.current.width-20;this.columnWidth=kiss.tools.pxToRem(this.columnWidth);document.documentElement.style.setProperty("--gallery-column-width",this.columnWidth+"rem")}else{this.columnWidth=this.columnWidth||config.columnWidth||this._getColumnsWidthFromLocalStorage();document.documentElement.style.setProperty("--gallery-column-width",this.columnWidth+"rem")}}_initEvents(){this.onclick=async event=>{const clickedElement=event.target;const card=clickedElement.closest(".gallery-record");const group=clickedElement.closest(".gallery-group");const checkbox=clickedElement.closest(".gallery-checkbox");if(checkbox){const recordId=card.getAttribute("recordid");this._toggleSelect(recordId)}else if(card){const recordId=card.getAttribute("recordid");const record=await this.collection.getRecord(recordId);await this.selectRecord(record)}else if(group){const groupId=group.getAttribute("groupId");const groupState=this._getGroupState(groupId);if(groupState=="expanded"){this.collapseGroup(groupId,group)}else{this.expandGroup(groupId,group)}}};return this}_renderSelection(){if(!this.selectedRecords)return;this.selectedRecords.forEach((recordId=>{this._select(recordId)}))}_renderSelectionRestore(){this.getSelection();this._renderGalleryBody();this._renderDetailsOfVisibleCards()}_toggleSelect(recordId){let isSelected=this.selectedRecords.indexOf(recordId)!=-1;if(isSelected){this._deselect(recordId);kiss.selection.delete(this.id,recordId)}else{this._select(recordId);kiss.selection.insertOne(this.id,recordId)}this.selectedRecords=kiss.selection.get(this.id);return recordId}_select(recordId){const card=this.querySelector('.gallery-record[recordid="'+recordId+'"]');const checkbox=card.querySelector(".gallery-checkbox");if(checkbox){checkbox.classList.remove("fa-square");checkbox.classList.add("fa-check-square");checkbox.setAttribute("selected","true");card.classList.add("gallery-record-selected")}}_deselect(recordId){const card=this.querySelector('.gallery-record[recordid="'+recordId+'"]');const checkbox=card.querySelector(".gallery-checkbox");if(checkbox){checkbox.classList.remove("fa-check-square");checkbox.classList.add("fa-square");checkbox.setAttribute("selected","false");card.classList.remove("gallery-record-selected")}}_getGroupState(groupId){return this.collapsedGroups.has(groupId)?"collapsed":"expanded"}_isHiddenByCollapsedParent(groupId,excludeSelf=false){const parts=groupId.split(".");while(parts.length>0){const parentId=parts.join(".");if(this.collapsedGroups.has(parentId)){if(excludeSelf&&parentId===groupId){}else{return true}}parts.pop()}return false}_initSubscriptions(){super._initSubscriptions();const viewModelId=this.modelId.toUpperCase();this.subscriptions=this.subscriptions.concat([subscribe("EVT_VIEW_SETUP:"+this.id,(msgData=>this._updateConfig(msgData))),subscribe("EVT_DB_INSERT:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_UPDATE:"+viewModelId,(msgData=>this._updateOneAndReload(msgData))),subscribe("EVT_DB_DELETE:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_INSERT_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_DELETE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_BULK",(msgData=>this._reloadWhenNeeded(msgData,2e3)))]);return this}async _updateOneAndReload(msgData){const sortFields=this.sort.map((sort=>Object.keys(sort)[0]));const filterFields=kiss.db.mongo.getFilterFields(this.filter);let groupHasChanged=false;let sortHasChanged=false;let filterHasChanged=false;let updates=msgData.data;for(let fieldId of Object.keys(updates)){if(this.group.indexOf(fieldId)!=-1)groupHasChanged=true;if(sortFields.indexOf(fieldId)!=-1)sortHasChanged=true;if(filterFields.indexOf(fieldId)!=-1)filterHasChanged=true}this._updateRecord(msgData.id);if(sortHasChanged||filterHasChanged||groupHasChanged){this.reload()}}_updateRecord(recordId){const record=this.collection.getRecord(recordId);const recordNode=document.querySelector(`.gallery-record[recordid="${recordId}"]`);if(recordNode){const replacementNode=document.createElement("div");const recordIndex=recordNode.getAttribute("row");replacementNode.setAttribute("row",recordIndex);replacementNode.classList.add("gallery-record");let isSelected=!(this.selectedRecords.indexOf(record.id)==-1);if(isSelected)replacementNode.classList.add("gallery-record-selected");replacementNode.innerHTML=this._renderRecordAsCard(record,recordIndex,isSelected);recordNode.parentNode.replaceChild(replacementNode,recordNode);replacementNode.setAttribute("recordid",recordId)}}async _updateConfig(newConfig){if(newConfig.hasOwnProperty("showImage"))this.showImage=newConfig.showImage;if(newConfig.hasOwnProperty("imageFieldId"))this.imageFieldId=newConfig.imageFieldId;this._render();let currentConfig;if(this.record){currentConfig=this.record.config}else{currentConfig={showImage:this.showImage,imageFieldId:this.imageFieldId,columns:this.columns}}let config=Object.assign(currentConfig,newConfig);await this.updateConfig({config:config})}_setWidth(){let newWidth=this._computeSize("width");setTimeout((()=>{this.style.width=newWidth;this.gallery.style.width=this.clientWidth.toString()+"px"}),50)}_setHeight(){let newHeight=this._computeSize("height");this.style.height=this.gallery.style.height=newHeight}_getColumnsWidthFromLocalStorage(){const localStorageId="config-view-gallery-"+this.id+"-column-width";const columnWidth=localStorage.getItem(localStorageId);if(!columnWidth)return this.defaultColumnWidth;return Number(columnWidth)}async _dataGroupBy(groupFields){this.group=groupFields;await this.collection.groupBy(groupFields);this._render();await this.updateConfig({group:this.group})}_render(){this._initColumnWidth();this.visibleColumns=this.columns.filter((column=>column.hidden!=true&&column.deleted!=true));this._renderGalleryBody();this._observeCards();return this}_observeCards(){const galleryColumnContainers=this.querySelectorAll(".gallery-group-container");galleryColumnContainers.forEach((container=>{container.onscroll=()=>{if(kiss.global.galleryScrollStop)return;clearTimeout(this.scrollTimeout);this.scrollTimeout=setTimeout((()=>this._renderDetailsOfVisibleCards()),10)}}));this.galleryBodyContainer.onscroll=()=>{clearTimeout(this.scrollTimeout);this.scrollTimeout=setTimeout((()=>this._renderDetailsOfVisibleCards()),10)};this._renderDetailsOfVisibleCards()}_renderDetailsOfVisibleCards(){const _this=this;const collection=this.collection;requestAnimationFrame((()=>{document.querySelectorAll(".gallery-record").forEach((card=>{if(_this._isElementVisible(card)){const isRendered=card.getAttribute("rendered");if(isRendered=="true")return;const recordId=card.getAttribute("recordid");const rowIndex=card.getAttribute("row");const record=collection.getRecord(recordId);let isSelected=!(this.selectedRecords.indexOf(record.id)==-1);if(isSelected)card.classList.add("gallery-record-selected");const cardContent=_this._renderRecordAsCard(record,rowIndex,isSelected);const cardElement=_this.querySelector('.gallery-record[recordid="'+recordId+'"]');cardElement.innerHTML=cardContent;cardElement.setAttribute("rendered","true")}}))}))}_isElementVisible(el){const rect=el.getBoundingClientRect();const windowHeight=window.innerHeight||document.documentElement.clientHeight;const windowWidth=window.innerWidth||document.documentElement.clientWidth;const vertInView=rect.top<=windowHeight&&rect.top+rect.height>=0;const horInView=rect.left<=windowWidth&&rect.left+rect.width>=0;return vertInView&&horInView}_renderGalleryBody(){let cardIndex=0;let gallery="";if(this.collection.group.length===0){this.galleryBody.classList.add("gallery-body-no-group");for(let rowIndex=0;rowIndex<this.collection.records.length;rowIndex++){let record=this.collection.records[rowIndex];cardIndex++;gallery+=this._renderGalleryCardContainer(record,cardIndex);if(rowIndex==this.collection.records.length-1)gallery+="</div>"}if(this.collection.records.length=="0"){this.galleryBodyContainer.classList.add("gallery-body-container-empty")}else{this.galleryBodyContainer.classList.remove("gallery-body-container-empty")}}else{this.galleryBody.classList.remove("gallery-body-no-group");let groupId="";let lastCellType="group";for(let rowIndex=0;rowIndex<this.collection.records.length;rowIndex++){let record=this.collection.records[rowIndex];if(record.$type=="group"&&record.$groupLevel==0){groupId=record.$groupId;cardIndex=0;if(lastCellType=="record"){gallery+="</div>"}lastCellType="group";gallery+=this._renderGalleryGroupContainer(record,rowIndex)}else if(record.$type=="group"){groupId=record.$groupId;const marginSize=groupId.length+"rem";const marginStyle=`style="margin-left: ${marginSize};"`;const value=this._renderGroupValue(record);gallery+='<div class="gallery-group gallery-group-expanded" groupId="'+groupId+'" '+marginStyle+">"+groupId+" - &nbsp;"+value+"</div>"}else{cardIndex++;lastCellType="record";gallery+=this._renderGalleryCardContainer(record,cardIndex,groupId)}if(rowIndex==this.collection.records.length-1){gallery+="</div>"}}if(this.collection.records.length=="0"){this.galleryBodyContainer.classList.add("gallery-body-container-empty")}else{this.galleryBodyContainer.classList.remove("gallery-body-container-empty")}}this.galleryBody.innerHTML=gallery}_getCategoryColor(groupFieldId,columnValue){const field=this.model.getField(groupFieldId);const options=field.options||[];const option=options.find((option=>option.value==columnValue));return option?option.color:"#cccccc"}_renderGalleryGroupContainer(record,rowIndex){const value=this._renderGroupValue(record);return'<div row="'+rowIndex+'" class="gallery-group-container">'+'<div class="gallery-group gallery-group-expanded" groupId="'+record.$groupId+'">'+record.$groupId+" - &nbsp;"+value+"</div>"}_renderGroupValue(record){const groupFieldId=this.group[record.$groupLevel];const field=this.model.getField(groupFieldId);if(field){return this._renderSingleValue(field,record.$name,record)}else{return record.$name}}_renderGalleryCardContainer(record,cardIndex,groupId){return'<div row="'+cardIndex+'" class="gallery-record" groupId="'+(groupId||"")+'" recordid="'+record.id+'"></div>'}_renderRecordAsCard(record,index,isSelected=false){let recordHtml=(this.canSelect?'<span class="gallery-checkbox '+(isSelected?"far fa-check-square":"far fa-square")+'"></span>':"")+'<span class="gallery-record-index">'+index+"</span>";if(this.showImage){const imageFieldId=this.imageFieldId;let images=record[imageFieldId]||[record];if(images&&Array.isArray(images)&&images.length!=0){const thumbSize=this.columnWidth>20?"l":"m";let imageHtml=this._renderCardImage({value:[images[0]],config:{thumbSize:thumbSize}});recordHtml+='<div class="gallery-record-image-container">'+imageHtml+"</div>"}else{recordHtml+='<div class="gallery-record-image-container"><span class="fas fa-archive gallery-record-empty"></span></div>'}}this.columns.filter((column=>column.hidden!==true)).forEach((column=>{let field=this.model.getField(column.id);if(!field)return;if(["password","link"].includes(field.type))return;let value=record[column.id];if(!value&&value!==false&&value!==0)return;let valueHtml=this._renderSingleValue(field,value,record);recordHtml+=`\n                    <div class="gallery-record-field">\n                        <div class="gallery-record-label">${field.label} ${field.unit?`(${field.unit})`:""}</div>\n                        <div class="gallery-record-value">${valueHtml}</div>\n                    </div>\n                `.removeExtraSpaces()}));return recordHtml}_renderCardImage({value:value,config:config={}}){if(!value||value==" "||!Array.isArray(value))return"";let attachmentItems=value.map(((file,i)=>{if(!file.path)return"";let preview;let filePath=kiss.tools.createFileURL(file,config.thumbSize||"s");const fileExtension=file.path.split(".").pop().toLowerCase();if(["jpg","jpeg","png","gif","webp"].indexOf(fileExtension)!=-1){preview=`<img id="${file.id}" class="gallery-record-image" src="${filePath}" loading="lazy"></img>`}else{const{icon:icon,color:color}=kiss.tools.fileToIcon(fileExtension);preview=`<span id="${file.id}" style="color: ${color}" class="fas ${icon} gallery-record-icon"></span>`}return preview})).join("");return attachmentItems}_renderSingleValue(field,value,record,config){const renderer=kiss.fields.renderers[this.model.id][field.id];const type=kiss.fields.getFieldType(field);switch(type){case"date":case"textarea":case"aiTextarea":case"select":case"directory":case"checkbox":case"rating":case"color":case"icon":case"attachment":case"aiImage":case"selectViewColumn":return renderer({value:value,record:record,config:config});case"number":case"slider":return renderer({value:value,record:record,config:{unit:false}});default:return value}}_renderToolbar(){if(this.isToolbarRendered){this._groupUpdateGroupingFields();return}createButton({hidden:!this.canCreateRecord,class:"gallery-create-record",target:"create:"+this.id,text:this.config.createRecordText||this.model.name.toTitleCase(),icon:"fas fa-plus",iconColor:this.color,borderWidth:3,borderRadius:"3.2rem",maxWidth:kiss.screen.isMobile&&kiss.screen.isVertical()?"16rem":null,action:async()=>this.createRecord(this.model)}).render();createButton({hidden:this.showActions===false,target:"actions:"+this.id,tip:txtTitleCase("actions"),icon:"fas fa-bolt",iconColor:this.color,width:"3.2rem",action:()=>this._buildActionMenu()}).render();createButton({hidden:!this.showSetup,target:"setup:"+this.id,tip:txtTitleCase("setup the gallery"),icon:"fas fa-cog",iconColor:this.color,width:"3.2rem",action:()=>this.showSetupWindow()}).render();createButton({hidden:!this.canSelectFields,target:"select:"+this.id,tip:txtTitleCase("#display fields"),icon:"fas fa-bars fa-rotate-90",iconColor:this.color,width:"3.2rem",action:()=>this.showFieldsWindow()}).render();createButton({hidden:!this.canSort,target:"sort:"+this.id,tip:txtTitleCase("to sort"),icon:"fas fa-sort",iconColor:this.color,width:"3.2rem",action:()=>this.showSortWindow()}).render();createButton({hidden:!this.canFilter,target:"filter:"+this.id,tip:txtTitleCase("to filter"),icon:"fas fa-filter",iconColor:this.color,width:"3.2rem",action:()=>this.showFilterWindow()}).render();createButton({hidden:!this.showLayoutButton,target:"layout:"+this.id,tip:{text:txtTitleCase("layout"),minWidth:"10rem"},icon:"fas fa-ellipsis-v",iconColor:this.color,width:"3.2rem",action:()=>this._buildLayoutMenu()}).render();let groupingFields=this._groupGetModelFields({excludeSystemFields:true,excludePluginFields:true});let groupingFieldValues=[];this.collection.group.forEach((fieldId=>{let groupingField=groupingFields.find((field=>field.value==fieldId));if(groupingField)groupingFieldValues.push(groupingField.value)}));createSelect({hidden:!this.canGroup,target:"group:"+this.id,id:"grouping-field:"+this.id,label:txtTitleCase("group by"),multiple:true,allowClickToDelete:true,options:groupingFields,minWidth:"20rem",maxHeight:()=>kiss.screen.current.height-200,optionsColor:this.color,value:groupingFieldValues,styles:{this:"align-items: center;","field-label":"white-space: nowrap;","field-select":"white-space: nowrap;"},events:{change:async function(event){let groupFields=this.getValue();if(groupFields.length>6){let fieldGroupSelect=$(this.id);fieldGroupSelect.value=fieldGroupSelect.getValue().slice(0,6);fieldGroupSelect._renderValues();createDialog({type:"message",title:txtTitleCase("seriously"),icon:"fas fa-exclamation-triangle",message:txtTitleCase("#too many groups"),buttonOKText:txtTitleCase("#understood")});return}let viewId=this.id.split(":")[1];publish("EVT_VIEW_GROUPING:"+viewId,groupFields)}}}).render();this.buttonExpand=createButton({hidden:!this.showGroupButtons||this.collection.group.length===0,target:"expand:"+this.id,tip:txtTitleCase("expand all"),icon:"far fa-plus-square",iconColor:this.color,width:"3.2rem",action:()=>this.expandAll()}).render();this.buttonCollapse=createButton({hidden:!this.showGroupButtons||this.collection.group.length===0,target:"collapse:"+this.id,tip:txtTitleCase("collapse all"),icon:"far fa-minus-square",iconColor:this.color,width:"3.2rem",action:()=>this.collapseAll()}).render();if(!kiss.screen.isMobile){createButton({target:"refresh:"+this.id,tip:txtTitleCase("refresh"),icon:"fas fa-undo-alt",iconColor:this.color,width:"3.2rem",events:{click:()=>this.reload()}}).render()}createButton({hidden:!this.canSearch,target:"search:"+this.id,icon:"fas fa-search",iconColor:this.color,width:"3.2rem",events:{click:()=>this.showSearchBar()}}).render();this.isToolbarRendered=true}async _buildLayoutMenu(){let buttonLeftPosition=$("layout:"+this.id).offsetLeft;let buttonTopPosition=$("layout:"+this.id).offsetTop;createMenu({top:buttonTopPosition,left:buttonLeftPosition,items:[txtTitleCase("cell size"),"-",{icon:"fas fa-circle",iconSize:"0.2rem",text:txtTitleCase("compact"),action:()=>{this.columnWidth=15;this.setColumnWidth(this.columnWidth)}},{icon:"fas fa-circle",iconSize:"0.6rem",text:txtTitleCase("normal"),action:()=>{this.columnWidth=this.defaultColumnWidth;this.setColumnWidth(this.columnWidth)}},{icon:"fas fa-circle",iconSize:"1rem",text:txtTitleCase("medium"),action:()=>{this.columnWidth=25;this.setColumnWidth(this.columnWidth)}},{icon:"fas fa-circle",iconSize:"1.4rem",text:txtTitleCase("tall"),action:()=>{this.columnWidth=30;this.setColumnWidth(this.columnWidth)}},{icon:"fas fa-circle",iconSize:"1.8rem",text:txtTitleCase("very tall"),action:()=>{this.columnWidth=35;this.setColumnWidth(this.columnWidth)}},"-",{icon:"fas fa-undo-alt",text:txtTitleCase("#reset view params"),action:()=>this.resetLocalViewParameters()}]}).render()}};customElements.define("a-gallery",kiss.ui.Gallery);const createGallery=config=>document.createElement("a-gallery").init(config);kiss.ui.Kanban=class Kanban extends kiss.ui.DataComponent{constructor(){super()}init(config){config.autoSize=true;super.init(config);this.showToolbar=config.showToolbar!==false;this.showActions=config.showActions!==false;this.showLayoutButton=config.showLayoutButton!==false;this.canSearch=config.canSearch!==false;this.canSort=config.canSort!==false;this.canFilter=config.canFilter!==false;this.canGroup=config.canGroup!==false;this.canSelectFields=config.canSelectFields!==false;this.actions=config.actions||[];this.buttons=config.buttons||[];this.color=config.color||"#00aaee";this.defaultColumnWidth=28;let id=this.id;this.innerHTML=`<div class="kanban">\n                <div id="kanban-toolbar:${id}" class="kanban-toolbar">\n                    <div id="create:${id}"></div>\n                    <div id="actions:${id}"></div>\n                    <div id="select:${id}"></div>\n                    <div id="sort:${id}"></div>\n                    <div id="filter:${id}"></div>\n                    <div id="group:${id}"></div>\n                    <div id="refresh:${id}"></div>\n                    <div id="search-field:${id}"></div>\n                    <div id="search:${id}"></div>\n                    <div class="spacer"></div>\n                    <div id="layout:${id}"></div>\n                </div>\n\n                <div class="kanban-header-container">\n                    <div id="kanban-header:${id}" class="kanban-header"></div>\n                </div>\n\n                <div class="kanban-body-container">\n                    <div id="kanban-body:${id}" class="kanban-body"></div>\n                </div>\n            </div>`.removeExtraSpaces();this.kanban=this.querySelector(".kanban");this.kanbanToolbar=this.querySelector(".kanban-toolbar");this.kanbanHeaderContainer=this.querySelector(".kanban-header-container");this.kanbanHeader=this.querySelector(".kanban-header");this.kanbanBodyContainer=this.querySelector(".kanban-body-container");this.kanbanBody=this.querySelector(".kanban-body");this._initColumns(config.columns)._initSize(config)._initElementsVisibility()._initEvents()._initSubscriptions();return this}async load(){try{log(`kiss.ui - Kanban ${this.id} - Loading collection <${this.collection.id} (changed: ${this.collection.hasChanged})>`);let currentFilter=this.filter;if(this.currentSearchTerm){currentFilter=this.createSearchFilter(this.currentSearchTerm)}await this.collection.find({filterSyntax:this.filterSyntax,filter:currentFilter,sortSyntax:this.sortSyntax,sort:this.sort,group:this.group,projection:this.projection,groupUnwind:this.groupUnwind},false,false,"TEST");this._renderToolbar()}catch(err){log(err);log(`kiss.ui - Kanban ${this.id} - Couldn't load data properly`)}}moveCardToColumn(recordId,fieldId,value){const record=this.collection.getRecord(recordId);const currentValue=record[fieldId];const color=this._getCategoryColor(fieldId,value);let message;if(value!==undefined&&value!==""){message=txtTitleCase("#move card")+` <span class="fas fa-circle kanban-column-header-icon" style="color: ${color}"></span><b>${value}</b> ?`}else{message=txtTitleCase("#move card")+` <span class="fas fa-circle kanban-column-header-icon" style="color: #cccccc"></span><b>${txtTitleCase("#no category")}</b> ?`}createDialog({title:currentValue+" → "+value,icon:"fas fa-clipboard-check",type:"dialog",message:message,action:async()=>{const loadingId=kiss.loadingSpinner.show();await this.collection.updateOne(recordId,{[fieldId]:value});kiss.loadingSpinner.hide(loadingId);await this.reload();createNotification(txtTitleCase("#card moved")+" "+value)}})}switchToSearchMode(){if(kiss.screen.isMobile){$("create:"+this.id).hide();$("search:"+this.id).hide()}}resetSearchMode(){if(kiss.screen.isMobile){$("create:"+this.id).show();$("search:"+this.id).show()}}async setColor(newColor){this.color=newColor;Array.from(this.kanbanToolbar.children).forEach((item=>{if(item&&item.firstChild&&item.firstChild.type=="button")item.firstChild.setIconColor(newColor)}))}showSortWindow(){let sortButton=$("sort:"+this.id);const box=sortButton.getBoundingClientRect();super.showSortWindow(box.left,box.top+40,this.color)}showFieldsWindow(){let selectionButton=$("select:"+this.id);const box=selectionButton.getBoundingClientRect();super.showFieldsWindow(box.left,box.top+40,this.color)}showFilterWindow(){super.showFilterWindow(null,null,this.color)}updateLayout(){if(this.isConnected){this._setWidth();this._setHeight();this._render()}}setColumnWidth(width){this.columnWidth=width;document.documentElement.style.setProperty("--kanban-column-width",this.columnWidth+"rem");const localStorageId="config-view-kanban-"+this.id+"-column-width";localStorage.setItem(localStorageId,this.columnWidth);this.reload()}async resetColumnsWidth(){this.columnWidth=this.defaultColumnWidth;document.documentElement.style.setProperty("--kanban-column-width",this.columnWidth+"rem");const localStorageId="config-view-kanban-"+this.id+"-column-width";localStorage.removeItem(localStorageId)}_initElementsVisibility(){if(this.showToolbar===false)this.kanbanToolbar.style.display="none";return this}_initSize(config){if(config.width){this._setWidth()}else{this.style.width=this.config.width="100%"}if(config.height){this._setHeight()}else{this.style.height=this.config.height="100%"}return this}_initColumnWidth(config={}){const isMobile=kiss.screen.isMobile;const isPortrait=kiss.screen.isVertical();if(isMobile&&isPortrait){this.columnWidth=kiss.screen.current.width-20;this.columnWidth=kiss.tools.pxToRem(this.columnWidth);document.documentElement.style.setProperty("--kanban-column-width",this.columnWidth+"rem")}else{this.columnWidth=this.columnWidth||config.columnWidth||this._getColumnsWidthFromLocalStorage();document.documentElement.style.setProperty("--kanban-column-width",this.columnWidth+"rem")}}_initEvents(){this.onclick=async event=>{const clickedElement=event.target;const card=clickedElement.closest(".kanban-record");const cardButton=clickedElement.closest(".kanban-record-button");if(cardButton){event.stop();const recordId=card.getAttribute("recordid");const column=card.closest(".kanban-column-container");const columnValue=column.getAttribute("value");const fieldId=column.getAttribute("fieldid");const field=this.model.getField(fieldId);if(!field)return;return createMenu({title:txtTitleCase("#move card"),icon:"fas fa-exchange-alt",items:field.options.filter((option=>option.value!=columnValue)).map((option=>({text:option.value,icon:"fas fa-circle",iconColor:option.color,action:()=>this.moveCardToColumn(recordId,fieldId,option.value)})))}).render()}if(card){const recordId=card.getAttribute("recordid");const record=await this.collection.getRecord(recordId);await this.selectRecord(record)}};return this}_initSubscriptions(){super._initSubscriptions();const viewModelId=this.modelId.toUpperCase();this.subscriptions=this.subscriptions.concat([subscribe("EVT_DB_INSERT:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_UPDATE:"+viewModelId,(msgData=>this._updateOneAndReload(msgData))),subscribe("EVT_DB_DELETE:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_INSERT_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_DELETE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_BULK",(msgData=>this._reloadWhenNeeded(msgData,2e3)))]);return this}async _updateOneAndReload(msgData){const sortFields=this.sort.map((sort=>Object.keys(sort)[0]));const filterFields=kiss.db.mongo.getFilterFields(this.filter);let groupHasChanged=false;let sortHasChanged=false;let filterHasChanged=false;let updates=msgData.data;for(let fieldId of Object.keys(updates)){if(this.group.indexOf(fieldId)!=-1)groupHasChanged=true;if(sortFields.indexOf(fieldId)!=-1)sortHasChanged=true;if(filterFields.indexOf(fieldId)!=-1)filterHasChanged=true}this._updateRecord(msgData.id);if(sortHasChanged||filterHasChanged||groupHasChanged){this.reload()}}_updateRecord(recordId){const record=this.collection.getRecord(recordId);const recordNode=document.querySelector(`.kanban-record[recordid="${recordId}"]`);if(recordNode){const replacementNode=document.createElement("div");const recordIndex=recordNode.getAttribute("row");replacementNode.setAttribute("row",recordIndex);replacementNode.classList.add("kanban-record");replacementNode.innerHTML=this._renderRecordAsCard(record,recordIndex);recordNode.parentNode.replaceChild(replacementNode,recordNode);replacementNode.setAttribute("recordid",recordId)}}_enableDragAndDrop(){let autoScrollInterval;const kanbanContainer=document.querySelector(".kanban-body-container");const scrollSpeed=20;const threshold=100;function autoScroll(mouseX){clearInterval(autoScrollInterval);autoScrollInterval=setInterval((()=>{if(mouseX<kanbanContainer.getBoundingClientRect().left+threshold){requestAnimationFrame((()=>kanbanContainer.scrollLeft=kanbanContainer.scrollLeft-scrollSpeed))}else if(mouseX>kiss.screen.current.width-threshold){requestAnimationFrame((()=>kanbanContainer.scrollLeft=kanbanContainer.scrollLeft+scrollSpeed))}}),10)}const stopAutoScroll=()=>clearInterval(autoScrollInterval);const getColumns=()=>document.querySelectorAll(".kanban-column-container");const resetColumns=()=>getColumns().forEach((column=>column.classList.remove("kanban-column-highlight")));const resetColumn=column=>column.classList.remove("kanban-column-highlight");const highlightColumn=column=>column.classList.add("kanban-column-highlight");const dndEvents={ondragstart:event=>{const kanbanColumn=event.target.closest(".kanban-column-container");kiss.context.draggedValue=kanbanColumn.getAttribute("value");kiss.context.draggedRecordId=event.target.getAttribute("recordid")},ondragover:event=>{event.preventDefault();resetColumns();const kanbanColumn=event.target.closest(".kanban-column-container");if(!kanbanColumn)return;const value=kanbanColumn.getAttribute("value");if(value==kiss.context.draggedValue)return;highlightColumn(kanbanColumn);autoScroll(event.clientX)},ondrop:event=>{event.preventDefault();resetColumns();const kanbanColumn=event.target.closest(".kanban-column-container");if(!kanbanColumn)return;const columnValue=kanbanColumn.getAttribute("value");if(columnValue==kiss.context.draggedValue)return;const recordId=kiss.context.draggedRecordId;const fieldId=kanbanColumn.getAttribute("fieldid");const value=kanbanColumn.getAttribute("value");this.moveCardToColumn(recordId,fieldId,value);stopAutoScroll()},ondragleave:event=>{const kanbanColumn=event.target.closest(".kanban-column-container");if(!kanbanColumn)return;resetColumn(event.target)}};document.querySelectorAll(".kanban-column-container").forEach((kanbanColumn=>{Object.assign(kanbanColumn,dndEvents)}));document.querySelectorAll(".kanban-record").forEach((kanbanCard=>{kanbanCard.draggable=true;kanbanCard.ondragstart=dndEvents.ondragstart;kanbanCard.ondragend=stopAutoScroll}))}_setWidth(){let newWidth=this._computeSize("width");setTimeout((()=>{this.style.width=newWidth;this.kanban.style.width=this.clientWidth.toString()+"px"}),50)}_setHeight(){let newHeight=this._computeSize("height");this.style.height=this.kanban.style.height=newHeight}_getColumnsWidthFromLocalStorage(){const localStorageId="config-view-kanban-"+this.id+"-column-width";const columnWidth=localStorage.getItem(localStorageId);if(!columnWidth)return this.defaultColumnWidth;return Number(columnWidth)}async _dataGroupBy(groupFields){await this.collection.groupBy(groupFields);this._render();this.group=groupFields;await this.updateConfig({group:this.group})}_render(){this._initColumnWidth();this.visibleColumns=this.columns.filter((column=>column.hidden!=true&&column.deleted!=true));this._renderKanbanBody();this._observeCards();this._enableDragAndDrop();return this}_observeCards(){const kanbanColumnContainers=this.querySelectorAll(".kanban-column-container");kanbanColumnContainers.forEach((container=>{container.onscroll=()=>{if(kiss.global.kanbanScrollStop)return;clearTimeout(this.scrollTimeout);this.scrollTimeout=setTimeout((()=>this._renderDetailsOfVisibleCards()),10)}}));this.kanbanBodyContainer.onscroll=()=>{clearTimeout(this.scrollTimeout);this.scrollTimeout=setTimeout((()=>this._renderDetailsOfVisibleCards()),10);this.kanbanHeaderContainer.scrollLeft=this.kanbanBodyContainer.scrollLeft};this._renderDetailsOfVisibleCards()}_renderDetailsOfVisibleCards(){const _this=this;const collection=this.collection;requestAnimationFrame((()=>{document.querySelectorAll(".kanban-record").forEach((card=>{if(_this._isElementVisible(card)){const isRendered=card.getAttribute("rendered");if(isRendered=="true")return;const recordId=card.getAttribute("recordid");const rowIndex=card.getAttribute("row");const record=collection.getRecord(recordId);const cardContent=_this._renderRecordAsCard(record,rowIndex);const cardElement=_this.querySelector('.kanban-record[recordid="'+recordId+'"]');cardElement.innerHTML=cardContent;cardElement.setAttribute("rendered","true")}}))}))}_isElementVisible(el){const rect=el.getBoundingClientRect();const windowHeight=window.innerHeight||document.documentElement.clientHeight;const windowWidth=window.innerWidth||document.documentElement.clientWidth;const vertInView=rect.top<=windowHeight&&rect.top+rect.height>=0;const horInView=rect.left<=windowWidth&&rect.left+rect.width>=0;return vertInView&&horInView}_renderKanbanBody(){let cardIndex=0;let kanbanHeader="";let kanban="";if(this.collection.group.length===0){kanban=`<div class="kanban-help">${txtTitleCase("#kanban help")}</div>`;this.kanbanHeaderContainer.style.display="none";this.kanbanBodyContainer.classList.remove("kanban-body-container-empty")}else{let lastCellType="group";for(let rowIndex=0;rowIndex<this.collection.records.length;rowIndex++){let record=this.collection.records[rowIndex];if(record.$type=="group"&&record.$groupLevel==0){cardIndex=0;if(lastCellType=="record"){kanban+="</div>"}lastCellType="group";kanbanHeader+=this._renderKanbanHeader(record,rowIndex);kanban+=this._renderKanbanColumnContainer(record,rowIndex)}else if(record.$type=="group"){kanban+='<div class="kanban-column-category">'+record.$groupId+" - "+record.$name+"</div>"}else{cardIndex++;lastCellType="record";kanban+=this._renderKanbanCardContainer(record,cardIndex)}if(rowIndex==this.collection.records.length-1){kanban+="</div>"}}if(this.collection.records.length=="0"){this.kanbanBodyContainer.classList.add("kanban-body-container-empty");this.kanbanHeaderContainer.style.display="none"}else{this.kanbanBodyContainer.classList.remove("kanban-body-container-empty");this.kanbanHeaderContainer.style.display="flex"}}this.kanbanHeader.innerHTML=kanbanHeader;this.kanbanBody.innerHTML=kanban}_renderKanbanHeader(record,rowIndex){const color=this._getCategoryColor(this.collection.group[0],record.$name);let row='<div row="'+rowIndex+'" class="kanban-column-header">';if(record.$name!==undefined&&record.$name!==""){row+=`<span class="fas fa-circle kanban-column-header-icon" style="color: ${color}"></span>`;row+=`<div>${record.$name} (${record.$size})</div>`}else{row+=`<span class="fas fa-circle kanban-column-header-icon" style="color: #cccccc"></span>`;row+=`<div>${txtTitleCase("#no category")} (${record.$size})</div>`}row+="</div>";return row}_getCategoryColor(groupFieldId,columnValue){const field=this.model.getField(groupFieldId);const options=field.options||[];const option=options.find((option=>option.value==columnValue));return option?option.color:"#cccccc"}_renderKanbanColumnContainer(record,rowIndex){const groupFieldId=this.group[0];const value=record.$name;return'<div row="'+rowIndex+'" fieldid="'+groupFieldId+'" value="'+value+'" class="kanban-column-container">'}_renderKanbanCardContainer(record,cardIndex){return'<div row="'+cardIndex+'" class="kanban-record" recordid="'+record.id+'"></div>'}_renderRecordAsCard(record,index){let recordHtml='<span class="kanban-record-index">'+index+"</span>";this.columns.filter((column=>column.hidden!==true)).forEach((column=>{let field=this.model.getField(column.id);if(!field)return;if(["password","link"].includes(field.type))return;let value=record[column.id];if(!value&&value!==false&&value!==0)return;let valueHtml=this._renderSingleValue(field,value,record);recordHtml+=`\n                    <div class="kanban-record-field">\n                        <div class="kanban-record-label">${field.label} ${field.unit?`(${field.unit})`:""}</div>\n                        <div class="kanban-record-value">${valueHtml}</div>\n                    </div>\n                `.removeExtraSpaces()}));if(kiss.screen.isMobile){recordHtml+=`\n                <div class="a-button kanban-record-button">\n                    <span class="kanban-record-button-icon fas fa-exchange-alt"></span>\n                    ${txtTitleCase("#move card")}\n                </div>\n            `.removeExtraSpaces()}return recordHtml}_renderSingleValue(field,value,record){const renderer=kiss.fields.renderers[this.model.id][field.id];const type=kiss.fields.getFieldType(field);switch(type){case"date":case"textarea":case"aiTextarea":case"select":case"directory":case"checkbox":case"rating":case"color":case"icon":case"attachment":case"aiImage":case"selectViewColumn":return renderer({value:value,record:record});case"number":case"slider":return renderer({value:value,record:record,config:{unit:false}});default:return value}}_renderToolbar(){if(this.isToolbarRendered){this._groupUpdateGroupingFields();return}createButton({hidden:!this.canCreateRecord,class:"kanban-create-record",target:"create:"+this.id,text:this.config.createRecordText||this.model.name.toTitleCase(),icon:"fas fa-plus",iconColor:this.color,borderWidth:3,borderRadius:"3.2rem",maxWidth:kiss.screen.isMobile&&kiss.screen.isVertical()?"16rem":null,action:async()=>this.createRecord(this.model)}).render();createButton({hidden:this.showActions===false,target:"actions:"+this.id,tip:txtTitleCase("actions"),icon:"fas fa-bolt",iconColor:this.color,width:"3.2rem",action:()=>this._buildActionMenu()}).render();createButton({hidden:!this.canSelectFields,target:"select:"+this.id,tip:txtTitleCase("#display fields"),icon:"fas fa-bars fa-rotate-90",iconColor:this.color,width:"3.2rem",action:()=>this.showFieldsWindow()}).render();createButton({hidden:!this.canSort,target:"sort:"+this.id,tip:txtTitleCase("to sort"),icon:"fas fa-sort",iconColor:this.color,width:"3.2rem",action:()=>this.showSortWindow()}).render();createButton({hidden:!this.canFilter,target:"filter:"+this.id,tip:txtTitleCase("to filter"),icon:"fas fa-filter",iconColor:this.color,width:"3.2rem",action:()=>this.showFilterWindow()}).render();createButton({hidden:!this.showLayoutButton,target:"layout:"+this.id,tip:{text:txtTitleCase("layout"),minWidth:"10rem"},icon:"fas fa-ellipsis-v",iconColor:this.color,width:"3.2rem",action:()=>this._buildLayoutMenu()}).render();let groupingFields=this._groupGetModelFields({excludeSystemFields:true,excludePluginFields:true});let groupingFieldValues=[];this.collection.group.forEach((fieldId=>{let groupingField=groupingFields.find((field=>field.value==fieldId));if(groupingField)groupingFieldValues.push(groupingField.value)}));createSelect({hidden:!this.canGroup,target:"group:"+this.id,id:"grouping-field:"+this.id,label:txtTitleCase("group by"),multiple:true,allowClickToDelete:true,options:groupingFields,minWidth:"20rem",maxHeight:()=>kiss.screen.current.height-200,optionsColor:this.color,value:groupingFieldValues,styles:{this:"align-items: center;","field-label":"white-space: nowrap;","field-select":"white-space: nowrap;"},events:{change:async function(event){let groupFields=this.getValue();if(groupFields.length>6){let fieldGroupSelect=$(this.id);fieldGroupSelect.value=fieldGroupSelect.getValue().slice(0,6);fieldGroupSelect._renderValues();createDialog({type:"message",title:txtTitleCase("seriously"),icon:"fas fa-exclamation-triangle",message:txtTitleCase("#too many groups"),buttonOKText:txtTitleCase("#understood")});return}let viewId=this.id.split(":")[1];publish("EVT_VIEW_GROUPING:"+viewId,groupFields)}}}).render();if(!kiss.screen.isMobile){createButton({target:"refresh:"+this.id,tip:txtTitleCase("refresh"),icon:"fas fa-undo-alt",iconColor:this.color,width:"3.2rem",events:{click:()=>this.reload()}}).render()}createButton({hidden:!this.canSearch,target:"search:"+this.id,icon:"fas fa-search",iconColor:this.color,width:"3.2rem",events:{click:()=>this.showSearchBar()}}).render();this.isToolbarRendered=true}async _buildLayoutMenu(){let buttonLeftPosition=$("layout:"+this.id).offsetLeft;let buttonTopPosition=$("layout:"+this.id).offsetTop;createMenu({top:buttonTopPosition,left:buttonLeftPosition,items:[txtTitleCase("cell size"),"-",{icon:"fas fa-circle",iconSize:"0.2rem",text:txtTitleCase("compact"),action:()=>{this.columnWidth=25;this.setColumnWidth(this.columnWidth)}},{icon:"fas fa-circle",iconSize:"0.6rem",text:txtTitleCase("normal"),action:()=>{this.columnWidth=this.defaultColumnWidth;this.setColumnWidth(this.columnWidth)}},{icon:"fas fa-circle",iconSize:"1rem",text:txtTitleCase("medium"),action:()=>{this.columnWidth=35;this.setColumnWidth(this.columnWidth)}},{icon:"fas fa-circle",iconSize:"1.4rem",text:txtTitleCase("tall"),action:()=>{this.columnWidth=40;this.setColumnWidth(this.columnWidth)}},{icon:"fas fa-circle",iconSize:"1.8rem",text:txtTitleCase("very tall"),action:()=>{this.columnWidth=45;this.setColumnWidth(this.columnWidth)}},"-",{icon:"fas fa-undo-alt",text:txtTitleCase("#reset view params"),action:()=>this.resetLocalViewParameters()}]}).render()}};customElements.define("a-kanban",kiss.ui.Kanban);const createKanban=config=>document.createElement("a-kanban").init(config);kiss.ui.List=class List extends kiss.ui.DataComponent{constructor(){super()}init(config){config.autoSize=true;super.init(config);if(this.record){this.id=this.record.id;this.name=this.record.name;this._initColumns(this.record.config.columns)}else{this.id=config.id||kiss.tools.shortUid();this.name=config.name;this._initColumns(config.columns)}this.showToolbar=config.showToolbar!==false;this.showActions=config.showActions!==false;this.canSearch=config.canSearch!==false;this.canFilter=config.canFilter!==false;this.color=config.color||"#00aaee";this.canCreateRecord=!!config.canCreateRecord;this.actions=config.actions||[];this.buttons=config.buttons||[];let id=this.id;this.innerHTML=`<div id="list-toolbar:${id}" class="list-toolbar">\n                <div id="create:${id}"></div>\n                <div id="actions:${id}"></div>\n                <div id="setup:${id}"></div>\n                <div id="select:${id}"></div>\n                <div id="filter:${id}"></div>\n                <div class="spacer"></div>\n                <div id="title:${id}" class="list-title"></div>\n                <div class="spacer"></div>\n                <div id="pager-index:${id}" class="list-toolbar-pager-index"></div>\n                <div id="pager-mode:${id}"></div>\n                <div id="pager-previous:${id}"></div>\n                <div id="pager-next:${id}"></div>\n                <div id="layout:${id}"></div>\n                <div id="refresh:${id}"></div>\n            </div>\n            <div id="list-body:${id}" class="list-body">`.removeExtraSpaces();this.list=this.querySelector(".list");this.listToolbar=this.querySelector(".list-toolbar");this.listBody=this.querySelector(".list-body");if(this.showToolbar==false)this.listToolbar.style.display="none";this._initEvents();this._initSubscriptions();return this}_initSubscriptions(){super._initSubscriptions();const viewModelId=this.modelId.toUpperCase();this.subscriptions=this.subscriptions.concat([subscribe("EVT_DB_INSERT:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_UPDATE:"+viewModelId,(msgData=>this._updateOneAndReload(msgData))),subscribe("EVT_DB_DELETE:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_INSERT_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_DELETE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_BULK",(msgData=>this._reloadWhenNeeded(msgData,2e3)))])}_initEvents(){this.onclick=async event=>{const clickedElement=event.target;const recordElement=clickedElement.closest(".list-record");if(!recordElement)return;if(recordElement.classList.contains("list-record")){const recordId=recordElement.getAttribute("recordid");const record=await this.collection.getRecord(recordId);await this.selectRecord(record);return event}}}async load(){try{log(`kiss.ui - List ${this.id} - Loading collection <${this.collection.id} (changed: ${this.collection.hasChanged})>`);this.collection.filter=this.filter;this.collection.filterSyntax=this.filterSyntax;await this.collection.find({},true);this._renderToolbar();this._renderBody()}catch(err){log(err);log(`kiss.ui - List ${this.id} - Couldn't load data properly`)}}async reload(){await this.load();this._initColumns();this._render()}updateLayout(){if(this.isConnected){this._render()}}async setColor(newColor){this.color=newColor;Array.from(this.listToolbar.children).forEach((item=>{if(item&&item.firstChild&&item.firstChild.type=="button")item.firstChild.setIconColor(newColor)}));this._render()}_render(){this._renderBody()}_renderBody(){let html;this.collection.records.forEach((record=>{html+=`<div class="list-record" recordid="${record.id}">${record.id}</div>`}));this.listBody.innerHTML=html}_renderSingleValue(field,value,record){const renderer=kiss.fields.renderers[this.model.id][field.id];const type=kiss.fields.getFieldType(field);switch(type){case"number":case"date":case"textarea":case"aiTextarea":case"select":case"directory":case"checkbox":case"slider":case"rating":case"color":case"icon":case"attachment":case"aiImage":case"selectViewColumn":return renderer({value:value,record:record,view:this});default:return value}}async _updateOneAndReload(msgData){const filterFields=kiss.db.mongo.getFilterFields(this.filter);let filterHasChanged=false;let updates=msgData.data;for(let fieldId of Object.keys(updates)){if(filterFields.indexOf(fieldId)!=-1)filterHasChanged=true}this._updateRecord(msgData.id);if(filterHasChanged){this._reloadWhenNeeded(msgData,2e3)}}_updateRecord(recordId){const record=this.collection.getRecord(recordId);const recordNode=document.querySelector(`.list-record[recordid="${recordId}"]`);if(recordNode){const replacementNode=document.createElement("div");replacementNode.classList.add("list-record");replacementNode.style.borderColor=this.model.color;replacementNode.innerHTML="TEST";recordNode.parentNode.replaceChild(replacementNode,recordNode);replacementNode.setAttribute("recordid",recordId)}}_renderToolbar(){if(this.isToolbarRendered)return;this.isToolbarRendered=true;createButton({hidden:!this.canCreateRecord,class:"list-create-record",target:"create:"+this.id,text:this.model.name.toTitleCase(),icon:"fas fa-plus",iconColor:this.color,borderWidth:"3px",borderRadius:"32px",action:async()=>this.createRecord(this.model)}).render();createButton({target:"select:"+this.id,tip:txtTitleCase("#display fields"),icon:"fas fa-bars fa-rotate-90",iconColor:this.color,width:32,action:()=>this.showFieldsWindow()}).render();createButton({hidden:!this.canFilter,target:"filter:"+this.id,tip:txtTitleCase("to filter"),icon:"fas fa-filter",iconColor:this.color,width:32,action:()=>this.showFilterWindow()}).render();createButton({target:"pager-previous:"+this.id,icon:"fas fa-chevron-left",iconColor:this.color,width:32,events:{click:()=>{}}}).render();createButton({target:"pager-next:"+this.id,icon:"fas fa-chevron-right",iconColor:this.color,width:32,events:{click:()=>{}}}).render();if(!kiss.screen.isMobile){createButton({target:"refresh:"+this.id,icon:"fas fa-undo-alt",iconColor:this.color,width:32,events:{click:()=>this.reload()}}).render()}}};customElements.define("a-list",kiss.ui.List);const createList=config=>document.createElement("a-list").init(config);kiss.ui.MapView=class MapView extends kiss.ui.DataComponent{constructor(){super()}init(config){config.autoSize=true;super.init(config);this.showToolbar=config.showToolbar!==false;this.showActions=config.showActions!==false;this.showSetup=config.showSetup!==false;this.canSearch=config.canSearch!==false;this.canFilter=config.canFilter!==false;this.actions=config.actions||[];this.buttons=config.buttons||[];this.color=config.color||"#00aaee";this.defaultColumnWidth=20;this.collapsedGroups=new Set;let id=this.id;this.innerHTML=`<div class="mapview">\n                <div id="mapview-toolbar:${id}" class="mapview-toolbar">\n                    <div id="create:${id}"></div>\n                    <div id="actions:${id}"></div>\n                    <div id="setup:${id}"></div>\n                    <div id="filter:${id}"></div>\n                    <div id="refresh:${id}"></div>\n                    <div id="search-field:${id}"></div>\n                    <div id="search:${id}"></div>\n                </div>\n\n                <div class="mapview-body-container">\n                    <div id="mapview-body:${id}" class="mapview-body"></div>\n                </div>\n            </div>`.removeExtraSpaces();this.mapView=this.querySelector(".mapview");this.mapViewToolbar=this.querySelector(".mapview-toolbar");this.mapViewBodyContainer=this.querySelector(".mapview-body-container");this.mapViewBody=this.querySelector(".mapview-body");this._initMapViewParams(config)._initSize(config)._initElementsVisibility()._initSubscriptions();return this}async load(){try{log(`kiss.ui - Map view ${this.id} - Loading collection <${this.collection.id} (changed: ${this.collection.hasChanged})>`);let currentFilter=this.filter;if(this.currentSearchTerm){currentFilter=this.createSearchFilter(this.currentSearchTerm)}await this.collection.find({filterSyntax:this.filterSyntax,filter:currentFilter});this._renderToolbar()}catch(err){log(err);log(`kiss.ui - Map view ${this.id} - Couldn't load data properly`)}}async filterMarkers(bounds){if(!this.coordinatesField||!this.labelField)return;this.bounds=bounds||this.bounds||await this.map.getBounds();const result=[];const maxResults=this.maxMarkers;for(const record of this.collection.records){const coords=record[this.coordinatesField]?.split(",");if(!coords||coords.length<2)continue;let latitude,longitude;if(this.coordinatesFormat==="longitude,latitude"){longitude=parseFloat(coords[0]);latitude=parseFloat(coords[1])}else{latitude=parseFloat(coords[0]);longitude=parseFloat(coords[1])}if(isNaN(latitude)||isNaN(longitude))continue;if(longitude>=this.bounds.minLongitude&&longitude<=this.bounds.maxLongitude&&latitude>=this.bounds.minLatitude&&latitude<=this.bounds.maxLatitude){result.push({latitude:latitude,longitude:longitude,label:record[this.labelField],recordId:record.id});if(result.length>=maxResults)break}}this.markers=result;this.map.updateMarkers(this.markers)}switchToSearchMode(){if(kiss.screen.isMobile){$("create:"+this.id).hide();$("search:"+this.id).hide();$("expand:"+this.id).hide();$("collapse:"+this.id).hide()}}resetSearchMode(){if(kiss.screen.isMobile){$("create:"+this.id).show();$("search:"+this.id).show();$("expand:"+this.id).show();$("collapse:"+this.id).show()}}async setColor(newColor){this.color=newColor;Array.from(this.mapViewToolbar.children).forEach((item=>{if(item&&item.firstChild&&item.firstChild.type=="button")item.firstChild.setIconColor(newColor)}))}showFilterWindow(){super.showFilterWindow(null,null,this.color)}updateLayout(){if(this.isConnected){this._setWidth();this._setHeight()}}showSetupWindow(){let textFields=this.model.getFieldsByType(["text","mapField"]).filter((field=>!field.deleted)).map((field=>({value:field.id,label:field.label.toTitleCase()})));createPanel({icon:"fas fa-map",title:txtTitleCase("setup the map"),headerBackgroundColor:this.color,modal:true,backdropFilter:true,draggable:true,closable:true,align:"center",verticalAlign:"center",width:"40rem",defaultConfig:{labelPosition:"top",optionsColor:this.color,width:"100%"},items:[{type:"select",id:"map-coordinates-field:"+this.id,label:txtTitleCase("#coordinates field"),options:textFields,maxHeight:()=>kiss.screen.current.height-200,value:this.coordinatesField,events:{change:async function(){let coordinatesField=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{coordinatesField:coordinatesField})}}},{type:"select",id:"map-default-coordinates:"+this.id,label:txtTitleCase("coordinates format"),options:[{value:"longitude,latitude",label:txtTitleCase("longitude")+", "+txtTitleCase("latitude")},{value:"latitude,longitude",label:txtTitleCase("latitude")+", "+txtTitleCase("longitude")}],value:this.coordinatesFormat||"longitude,latitude",events:{change:async function(){let coordinatesFormat=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{coordinatesFormat:coordinatesFormat})}}},{type:"text",id:"map-default-coordinates:"+this.id,label:txtTitleCase("default coordinates"),tip:txtTitleCase("#default coordinates help"),value:this.defaultCoordinates||"",events:{change:async function(){let defaultCoordinates=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{defaultCoordinates:defaultCoordinates})}}},{type:"select",id:"map-label-field:"+this.id,label:txtTitleCase("#label field"),options:textFields,maxHeight:()=>kiss.screen.current.height-200,value:this.labelField,events:{change:async function(){let labelField=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{labelField:labelField})}}},{type:"slider",id:"map-default-zoom:"+this.id,label:txtTitleCase("default zoom level"),min:1,max:19,step:1,value:this.defaultZoom||10,events:{change:async function(){let defaultZoom=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{defaultZoom:defaultZoom})}}},{type:"slider",id:"map-max-markers:"+this.id,label:txtTitleCase("#max markers"),min:0,max:1e3,step:5,value:this.maxMarkers||100,events:{change:async function(){let maxMarkers=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{maxMarkers:maxMarkers})}}}]}).render()}_render(){this.filterMarkers()}async _afterRender(){this._createMap()}async _createMap(){let zoom=this.defaultZoom||10;if(zoom>19)zoom=19;if(zoom<1)zoom=1;let coordinates=this.defaultCoordinates;let longitude,latitude;const regex=/^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/;if(!regex.test(coordinates)){const geoloc=await kiss.tools.getGeolocationFromAddress(coordinates);if(!geoloc)return;longitude=geoloc.longitude;latitude=geoloc.latitude}else{coordinates=coordinates.split(",");if(this.coordinatesFormat==="longitude,latitude"){longitude=parseFloat(coordinates[0]);latitude=parseFloat(coordinates[1])}else{longitude=parseFloat(coordinates[1]);latitude=parseFloat(coordinates[0])}}this.map=createMap({id:"map-for:"+this.id,zoom:zoom,longitude:longitude,latitude:latitude,width:"100%",height:"100%",clickCallback:async(feature,clicked)=>{const recordId=feature.get("recordId");const record=await this.collection.getRecord(recordId);await this.selectRecord(record)}});this.map.style.order=2;this.map.style.flex="1 1 100%";this.mapViewBody.style.width="100%";this.mapViewBody.style.height="100%";this.mapViewBody.appendChild(this.map);this.map.render();return this}_initMapViewParams(config){if(this.record){this.coordinatesField=config.coordinatesField||this.record.config.coordinatesField;this.labelField=config.labelField||this.record.config.labelField;this.defaultCoordinates=config.defaultCoordinates||this.record.config.defaultCoordinates||"55.3895,-20.9906";this.coordinatesFormat=config.coordinatesFormat||this.record.config.coordinatesFormat||"longitude,latitude";this.defaultZoom=config.defaultZoom||this.record.config.defaultZoom;this.maxMarkers=config.maxMarkers||this.record.config.maxMarkers||100}else{this.coordinatesField=config.coordinatesField||this.config.coordinatesField;this.labelField=config.labelField||this.config.labelField;this.defaultCoordinates=config.defaultCoordinates||this.config.defaultCoordinates||"55.3895,-20.9906";this.coordinatesFormat=config.coordinatesFormat||this.config.coordinatesFormat||"longitude,latitude";this.defaultZoom=config.defaultZoom||this.config.defaultZoom;this.maxMarkers=config.maxMarkers||this.config.maxMarkers||100}return this}async _updateConfig(newConfig){if(newConfig.hasOwnProperty("coordinatesField"))this.coordinatesField=newConfig.coordinatesField;if(newConfig.hasOwnProperty("labelField"))this.labelField=newConfig.labelField;if(newConfig.hasOwnProperty("defaultCoordinates"))this.defaultCoordinates=newConfig.defaultCoordinates;if(newConfig.hasOwnProperty("coordinatesFormat"))this.coordinatesFormat=newConfig.coordinatesFormat;if(newConfig.hasOwnProperty("defaultZoom"))this.defaultZoom=newConfig.defaultZoom;if(newConfig.hasOwnProperty("maxMarkers"))this.maxMarkers=newConfig.maxMarkers;this.filterMarkers();let currentConfig;if(this.record){currentConfig=this.record.config}else{currentConfig={coordinatesField:this.coordinatesField,labelField:this.labelField,defaultCoordinates:this.defaultCoordinates,coordinatesFormat:this.coordinatesFormat,defaultZoom:this.defaultZoom,maxMarkers:this.maxMarkers}}let config=Object.assign(currentConfig,newConfig);await this.updateConfig({config:config})}_initElementsVisibility(){if(this.showToolbar===false)this.mapViewToolbar.style.display="none";return this}_initSize(config){if(config.width){this._setWidth()}else{this.style.width=this.config.width="100%"}if(config.height){this._setHeight()}else{this.style.height=this.config.height="100%"}return this}_initSubscriptions(){super._initSubscriptions();this.subscriptions=this.subscriptions.concat([subscribe("EVT_VIEW_SETUP:"+this.id,(msgData=>this._updateConfig(msgData))),subscribe("EVT_MAP_BOUNDS_CHANGED",(msgData=>{if(msgData.mapId.split(":")[1]!==this.id)return;this.filterMarkers(msgData.boundingBox)}))]);return this}_setWidth(){let newWidth=this._computeSize("width");setTimeout((()=>{this.style.width=newWidth;this.mapView.style.width=this.clientWidth.toString()+"px"}),50)}_setHeight(){let newHeight=this._computeSize("height");this.style.height=this.mapView.style.height=newHeight}_renderToolbar(){if(this.isToolbarRendered){return}createButton({hidden:!this.canCreateRecord,class:"map-create-record",target:"create:"+this.id,text:this.config.createRecordText||this.model.name.toTitleCase(),icon:"fas fa-plus",iconColor:this.color,borderWidth:3,borderRadius:"3.2rem",maxWidth:kiss.screen.isMobile&&kiss.screen.isVertical()?"16rem":null,action:async()=>this.createRecord(this.model)}).render();createButton({hidden:this.showActions===false,target:"actions:"+this.id,tip:txtTitleCase("actions"),icon:"fas fa-bolt",iconColor:this.color,width:"3.2rem",action:()=>this._buildActionMenu()}).render();createButton({hidden:!this.showSetup,target:"setup:"+this.id,tip:txtTitleCase("setup the map"),icon:"fas fa-cog",iconColor:this.color,width:"3.2rem",action:()=>this.showSetupWindow()}).render();createButton({hidden:!this.canFilter,target:"filter:"+this.id,tip:txtTitleCase("to filter"),icon:"fas fa-filter",iconColor:this.color,width:"3.2rem",action:()=>this.showFilterWindow()}).render();if(!kiss.screen.isMobile){createButton({target:"refresh:"+this.id,tip:txtTitleCase("refresh"),icon:"fas fa-undo-alt",iconColor:this.color,width:"3.2rem",events:{click:()=>this.reload()}}).render()}createButton({hidden:!this.canSearch,target:"search:"+this.id,icon:"fas fa-search",iconColor:this.color,width:"3.2rem",events:{click:()=>this.showSearchBar()}}).render();this.isToolbarRendered=true}};customElements.define("a-mapview",kiss.ui.MapView);const createMapView=config=>document.createElement("a-mapview").init(config);kiss.ui.Timeline=class Timeline extends kiss.ui.DataComponent{constructor(){super()}init(config){config.autoSize=true;super.init(config);this.showColumnType=!!config.showColumnType;this.showToolbar=config.showToolbar!==false;this.showPagerIndex=config.showPagerIndex!==false;this.showScroller=config.showScroller!==false;this.showActions=config.showActions!==false;this.showSetup=config.showSetup!==false;this.showLayoutButton=config.showLayoutButton!==false;this.showGroupButtons=config.showGroupButtons!==false;this.canSearch=config.canSearch!==false;this.canSort=config.canSort!==false;this.canFilter=config.canFilter!==false;this.canGroup=config.canGroup!==false;this.color=config.color||"#00aaee";this.iconAction=config.iconAction||"far fa-file-alt";this.canSelect=config.canSelect!==false;this.canSelectFields=config.canSelectFields!==false;this.canChangePeriod=config.canChangePeriod!==false;this.actions=config.actions||[];this.defaultRowHeight=4;this.firstColumnWidth=config.firstColumnWidth||10;this.resizerWidth=1.5;this.defaultDayWidth=50;let id=this.id;this.innerHTML=`<div class="timeline">\n                <div id="timeline-toolbar:${id}" class="timeline-toolbar">\n                    <div id="search-field:${id}"></div>\n                    <div id="create:${id}"></div>\n                    <div id="actions:${id}"></div>\n                    <div id="setup:${id}"></div>\n                    <div id="select:${id}"></div>\n                    <div id="sort:${id}"></div>\n                    <div id="filter:${id}"></div>\n                    <div id="group:${id}"></div>\n                    <div id="collapse:${id}"></div>\n                    <div id="expand:${id}"></div>\n                    <div id="refresh:${id}"></div>\n                    <div id="search:${id}"></div>\n                    <div id="hierarchy:${id}"></div>\n                    <div id="explode:${id}"></div>\n                    <div class="spacer"></div>\n                    <div id="pager-index:${id}" class="timeline-toolbar-pager-index"></div>\n                    <div id="pager-mode:${id}"></div>\n                    <div id="pager-previous:${id}"></div>\n                    <div id="pager-next:${id}"></div>\n                    <div id="pager-today:${id}"></div>\n                    <div id="layout:${id}"></div>\n                </div>\n\n                <div class="timeline-header-container">\n                    <div class="timeline-header-1st-column"></div>\n                    <div id="timeline-header:${id}" class="timeline-header"></div>\n                </div>\n\n                <div class="timeline-body-container">\n                    <div class="timeline-body-1st-column"></div>\n                    <div id="timeline-body:${id}" class="timeline-body"></div>\n                </div>\n\n                <div class="timeline-virtual-scroller-container">\n                    <div class="timeline-virtual-scroller"></div>\n                </div>\n            </div>`.removeExtraSpaces();this.timeline=this.querySelector(".timeline");this.timelineToolbar=this.querySelector(".timeline-toolbar");this.timelineHeader=this.querySelector(".timeline-header");this.timelineHeaderContainer=this.querySelector(".timeline-header-container");this.timelineBody=this.querySelector(".timeline-body");this.timelineBodyContainer=this.querySelector(".timeline-body-container");this.timelineHeader1stColumn=this.querySelector(".timeline-header-1st-column");this.timelineBody1stColumn=this.querySelector(".timeline-body-1st-column");this.timelineScrollerContainer=this.querySelector(".timeline-virtual-scroller-container");this.timelineScroller=this.querySelector(".timeline-virtual-scroller");this.timelinePagerIndex=this.querySelector(".timeline-toolbar-pager-index");this._initTexts()._initColumns(config.columns)._initSize(config)._initTimelineParams(config)._initElementsVisibility()._initEvents()._initSubscriptions();return this}async load(){try{log(`kiss.ui - Timeline ${this.id} - Loading collection <${this.collection.id} (changed: ${this.collection.hasChanged})>`);let currentFilter=this.filter;if(this.currentSearchTerm){currentFilter=this.createSearchFilter(this.currentSearchTerm)}await this.collection.find({filterSyntax:this.filterSyntax,filter:currentFilter,sortSyntax:this.sortSyntax,sort:this.sort,group:this.group,projection:this.projection,groupUnwind:this.groupUnwind});this._hideScroller();this._columnsAdjustWidthFromLocalStorage();this.getSelection();this._renderToolbar();this.skip=0;this._setLimit();this.updateLayout()}catch(err){log(`kiss.ui - Timeline ${this.id} - Couldn't load data properly`)}}previous(){let shift=1;if(this.period=="1 year")shift=2;let previousDate=kiss.formula.ADJUST_DATE(this.startDate,0,0,-shift,0,0,0,"date");this.date=new Date(previousDate);return this._render()}next(){let shift=1;if(this.period=="1 year")shift=2;let nextDate=kiss.formula.ADJUST_DATE(this.startDate,0,0,shift,0,0,0,"date");this.date=new Date(nextDate);return this._render()}updateLayout(){if(this.isConnected){this._setWidth();this._setHeight();this._setLimit();this._renderPagerIndex();this._render();this._renderSelectionRestore()}}async setColor(newColor){this.color=newColor;Array.from(this.timelineToolbar.children).forEach((item=>{if(item&&item.firstChild&&item.firstChild.type=="button")item.firstChild.setIconColor(newColor)}))}highlightRecord(recordId){let index=this.goToRecord(recordId);if(index!=-1)this._rowHighlight(index)}goToRecord(recordId){let index=this._rowFindIndex(recordId);if(index!=-1)this.goToIndex(index);return index}goToIndex(index){this.skip=index;this._render()}showSetupWindow(){const dateFields=this.model.getFieldsByType("date").filter((field=>!field.deleted)).map((field=>({value:field.id,label:field.label.toTitleCase()})));const titleFields=this.model.fields.filter((field=>!field.deleted)).map((field=>({value:field.id,label:field.label.toTitleCase()})));const selectFields=this.model.getFieldsByType("select").filter((field=>!field.deleted)).map((field=>({value:field.id,label:field.label.toTitleCase()})));createPanel({icon:"fas fa-align-left",title:txtTitleCase("setup the timeline"),headerBackgroundColor:this.color,modal:true,backdropFilter:true,draggable:true,closable:true,align:"center",verticalAlign:"center",width:"40rem",defaultConfig:{labelPosition:"top",optionsColor:this.color},items:[{type:"select",id:"timeline-startDatefield:"+this.id,label:txtTitleCase("#timeline start date"),options:dateFields,maxHeight:()=>kiss.screen.current.height-200,value:this.startDateField,events:{change:async function(){let startDateField=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{startDateField:startDateField})}}},{type:"select",id:"timeline-endDateField:"+this.id,label:txtTitleCase("#timeline end date"),options:dateFields,maxHeight:()=>kiss.screen.current.height-200,value:this.endDateField,events:{change:async function(){let endDateField=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{endDateField:endDateField})}}},{type:"select",id:"timeline-titleField:"+this.id,label:txtTitleCase("#timeline title field"),options:titleFields,maxHeight:()=>kiss.screen.current.height-200,value:this.titleField,events:{change:async function(){let titleField=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{titleField:titleField})}}},{type:"select",id:"timeline-colorField:"+this.id,label:txtTitleCase("#timeline color field"),options:selectFields,maxHeight:()=>kiss.screen.current.height-200,value:this.colorField,events:{change:async function(){let colorField=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{colorField:colorField})}}},{type:"select",id:"timeline-period:"+this.id,label:txtTitleCase("#timeline period"),options:[{label:"1 "+txtTitleCase("week"),value:"1 week"},{label:"2 "+txtTitleCase("weeks"),value:"2 weeks"},{label:"3 "+txtTitleCase("weeks"),value:"3 weeks"},{label:"1 "+txtTitleCase("month"),value:"1 month"},{label:"2 "+txtTitleCase("months"),value:"2 months"},{label:"3 "+txtTitleCase("months"),value:"3 months"},{label:"4 "+txtTitleCase("months"),value:"4 months"},{label:"6 "+txtTitleCase("months"),value:"6 months"},{label:"1 "+txtTitleCase("year"),value:"1 year"}],value:this.period||"1 month",events:{change:async function(){let period=this.getValue();let viewId=this.id.split(":")[1];publish("EVT_VIEW_SETUP:"+viewId,{period:period})}}}]}).render()}showSortWindow(){let sortButton=$("sort:"+this.id);const box=sortButton.getBoundingClientRect();super.showSortWindow(box.left,box.top+40,this.color)}showFieldsWindow(){let selectionButton=$("select:"+this.id);const box=selectionButton.getBoundingClientRect();super.showFieldsWindow(box.left,box.top+40,this.color)}showFilterWindow(){super.showFilterWindow(null,null,this.color)}setRowHeight(height){this.rowHeight=height;document.documentElement.style.setProperty("--datacomponent-cell-height",this.rowHeight+"rem");document.documentElement.style.setProperty("--datacomponent-group-cell-height",this.rowHeight+"rem");const localStorageId="config-view-timeline-"+this.id+"-row-height";localStorage.setItem(localStorageId,this.rowHeight);this.reload()}switchToSearchMode(){if(kiss.screen.isMobile){$("create:"+this.id).hide();$("search:"+this.id).hide();$("expand:"+this.id).hide();$("collapse:"+this.id).hide()}}resetSearchMode(){if(kiss.screen.isMobile){$("create:"+this.id).show();$("search:"+this.id).show();$("expand:"+this.id).show();$("collapse:"+this.id).show()}}_afterConnected(){super._afterConnected();this._hideScroller();this._renderScroller()}_initTexts(){this.months=[txtTitleCase("january"),txtTitleCase("february"),txtTitleCase("march"),txtTitleCase("april"),txtTitleCase("may"),txtTitleCase("june"),txtTitleCase("july"),txtTitleCase("august"),txtTitleCase("september"),txtTitleCase("october"),txtTitleCase("november"),txtTitleCase("december")];this.weekDays=[txtTitleCase("sunday"),txtTitleCase("monday"),txtTitleCase("tuesday"),txtTitleCase("wednesday"),txtTitleCase("thursday"),txtTitleCase("friday"),txtTitleCase("saturday")];if(kiss.screen.isMobile&&kiss.screen.isVertical()){this.months=this.months.map((month=>month.substring(0,4)+"."))}return this}_initEvents(){let startX;let isDragging=false;const handleMouseMove=e=>{if(isDragging){let currentX=e.clientX;let diffX=currentX-startX;const threshold=Math.max(this.dayWidth,30);if(diffX>threshold){this.previous();startX=currentX}else if(diffX<-threshold){this.next();startX=currentX}}};function handleMouseUp(e){isDragging=false;document.removeEventListener("mousemove",handleMouseMove);document.removeEventListener("mouseup",handleMouseUp)}this.timelineBody.addEventListener("mousedown",(function(e){e.preventDefault();startX=e.clientX;isDragging=true;document.addEventListener("mousemove",handleMouseMove);document.addEventListener("mouseup",handleMouseUp)}));this.timelineHeader1stColumn.onclick=event=>{if(event.target.classList.contains("timeline-header-checkbox")){this.toggleSelection()}};this.timelineHeader1stColumn.onmousedown=event=>{const clickedElement=event.target;if(clickedElement.classList.contains("timeline-column-header-resizer")){this._columnsResizeWithDragAndDrop(event,clickedElement)}};this.onclick=async event=>{const clickedElement=event.target;const clickedParent=clickedElement.parentNode;if(clickedElement.classList.contains("timeline-row-checkbox")){const rowIndex=clickedParent.getAttribute("row");this._rowToggleSelect(rowIndex);return event}if(Array.from(clickedParent.classList).concat(Array.from(clickedElement.classList)).indexOf("timeline-cell-1st")!=-1){const cell=clickedElement.closest("div");const recordId=cell.getAttribute("recordid");const record=await this.collection.getRecord(recordId);await this.selectRecord(record);return event}if(clickedParent.classList.contains("timeline-group-row")){const rowIndex=clickedParent.getAttribute("row");const record=this.collection.records[Number(rowIndex)];const groupId=record.$groupId;const groupLevel=record.$groupLevel;this._groupToggle(groupId,groupLevel,rowIndex);return event}const clickedGroup=clickedElement.closest(".timeline-group");if(clickedGroup){const rowIndex=clickedGroup.getAttribute("row");const record=this.collection.records[Number(rowIndex)];const groupId=record.$groupId;const groupLevel=record.$groupLevel;this._groupToggle(groupId,groupLevel,rowIndex);return event}if(clickedElement.classList.contains("timeline-cell")||clickedParent.classList.contains("timeline-cell")){const row=clickedElement.closest(".timeline-row");const recordId=row.getAttribute("recordid");const record=await this.collection.getRecord(recordId);await this.selectRecord(record);return event}};this.timelineBody.onscroll=()=>{this.timelineHeader.scrollLeft=this.timelineBody.scrollLeft};this.onmousewheel=this.onwheel=event=>{if(!event.target.closest(".timeline-body-container"))return;if(event.wheelDelta>0){this._virtualScrollUp()}else{this._virtualScrollDown()}this._renderScrollerPosition();this._renderPagerIndex()};this.timelineScrollerContainer.onmousedown=event=>{this.preventScroll=false};this.timelineScrollerContainer.onscroll=event=>{if(this.preventScroll==true)return false;window.clearTimeout(this.isScrolling);this.isScrolling=null;this.isScrolling=setTimeout((()=>{let percent=event.target.scrollTop/(this.timelineScroller.offsetHeight-this.timelineBody.offsetHeight);let recordIndex=Math.round((this.collection.count-this.limit)*percent);let newSkip=Math.floor(Math.min(recordIndex,this.collection.records.length-this.limit));if(newSkip!=this.skip){this.skip=Math.max(newSkip,0);this._render()}}),10)};return this}_initSubscriptions(){super._initSubscriptions();const viewModelId=this.modelId.toUpperCase();this.subscriptions=this.subscriptions.concat([subscribe("EVT_VIEW_SETUP:"+this.id,(msgData=>this._updateConfig(msgData))),subscribe("EVT_DB_INSERT:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_UPDATE:"+viewModelId,(msgData=>this._updateOneAndReload(msgData))),subscribe("EVT_DB_DELETE:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData))),subscribe("EVT_DB_INSERT_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_DELETE_MANY:"+viewModelId,(msgData=>this._reloadWhenNeeded(msgData,2e3))),subscribe("EVT_DB_UPDATE_BULK",(msgData=>this._reloadWhenNeeded(msgData,2e3)))]);return this}_initTimelineParams(config){this.date=this.config.date||new Date;if(typeof this.date=="string")this.date=new Date(this.date);if(this.record){this.startDateField=config.startDateField||this.record.config.startDateField;this.endDateField=config.endDateField||this.record.config.endDateField;this.titleField=config.titleField||this.record.config.titleField;this.colorField=config.colorField||this.record.config.colorField;this.period=config.period||this.record.config.period||"1 month"}else{this.startDateField=config.startDateField||this.config.startDateField;this.endDateField=config.endDateField||this.config.endDateField;this.titleField=config.titleField||this.config.titleField;this.colorField=config.colorField||this.config.colorField;this.period=config.period||this.config.period||"1 month"}if(!this.startDateField){let modelDateFields=this.model.getFieldsByType(["date"]);if(modelDateFields.length!=0){this.startDateField=modelDateFields[0].id}else{this.startDateField="createdAt"}}if(!this.endDateField){let modelDateFields=this.model.getFieldsByType(["date"]);if(modelDateFields.length>1){this.endDateField=modelDateFields[1].id}else{this.endDateField="updatedAt"}}if(!this.titleField){let modelTextFields=this.model.getFieldsByType(["text"]);if(modelTextFields.length!=0){this.titleField=modelTextFields[0].id}else{this.titleField="id"}}this.periods={"1 week":7,"2 weeks":14,"3 weeks":21,"1 month":31,"2 months":61,"3 months":92,"4 months":122,"6 months":182,"1 year":365};return this}_initElementsVisibility(){if(this.showToolbar===false)this.timelineToolbar.style.display="none";if(this.showScroller===false)this.timelineScrollerContainer.style.display="none";if(this.showPagerIndex===false)this.timelinePagerIndex.style.display="none";return this}_initSize(config){this._initRowHeight(config);if(config.width){this._setWidth()}else{this.style.width=this.config.width=`calc(100%)`}if(config.height){this._setHeight()}else{this.style.height=this.config.height=`calc(100% - 1rem)`}return this}_initRowHeight(config={}){this.rowHeight=config.rowHeight||this._getRowHeightFromLocalStorage();document.documentElement.style.setProperty("--datacomponent-cell-height",this.rowHeight+"rem");document.documentElement.style.setProperty("--datacomponent-group-cell-height",this.rowHeight+"rem");return this}_initDayWidth(config={}){this.dayWidth=config.dayWidth||this._computeDayWidth();document.documentElement.style.setProperty("--timeline-day-width",this.dayWidth+"px");return this}_setDayWidth(width){this.dayWidth=width;this._render()}_getDayId(day,month,year){return year+"-"+(month+"").padStart(2,"0")+"-"+(day+"").padStart(2,"0")}_computeDayWidth(){return Math.max(this._getBodyWidth()/this.periods[this.period],5)}_getBodyWidth(){return kiss.screen.current.width-this.timelineBody.getBoundingClientRect().left}_getNumberOfDays(){return Math.floor(this._getBodyWidth()/this.dayWidth)}async _updateOneAndReload(msgData){const sortFields=this.sort.map((sort=>Object.keys(sort)[0]));const filterFields=kiss.db.mongo.getFilterFields(this.filter);let groupHasChanged=false;let sortHasChanged=false;let filterHasChanged=false;let updates=msgData.data;for(let fieldId of Object.keys(updates)){if(this.group.indexOf(fieldId)!=-1)groupHasChanged=true;if(sortFields.indexOf(fieldId)!=-1)sortHasChanged=true;if(filterFields.indexOf(fieldId)!=-1)filterHasChanged=true;this._updateRecord(msgData.id)}if(sortHasChanged||filterHasChanged||groupHasChanged){this._reloadWhenNeeded(msgData)}}_updateRecord(recordId){const record=this.collection.getRecord(recordId);const recordNode=document.querySelector(`.timeline-row[recordid="${recordId}"]`);if(recordNode)recordNode.innerHTML=this._renderRowContent(record)}async _updateConfig(newConfig){if(newConfig.hasOwnProperty("startDateField"))this.startDateField=newConfig.startDateField;if(newConfig.hasOwnProperty("endDateField"))this.endDateField=newConfig.endDateField;if(newConfig.hasOwnProperty("titleField"))this.titleField=newConfig.titleField;if(newConfig.hasOwnProperty("colorField"))this.colorField=newConfig.colorField;if(newConfig.hasOwnProperty("period"))this.period=newConfig.period;this._initTexts();this._render();let currentConfig;if(this.record){currentConfig=this.record.config}else{currentConfig={startDateField:this.startDateField,endDateField:this.endDateField,titleField:this.titleField,colorField:this.colorField,period:this.period,columns:this.columns}}let config=Object.assign(currentConfig,newConfig);await this.updateConfig({config:config})}_virtualScrollUp(){if(this.skip==0)return;this.skip-=1;this.lastIndex=Math.min(this.skip+this.limit-1,this.collection.records.length);this.timelineBody.lastChild.remove();this.timelineBody.insertBefore(this._renderRowDiv(this.skip),this.timelineBody.children[0]);this.timelineBody1stColumn.lastChild.remove();this.timelineBody1stColumn.insertBefore(this._renderRowDiv1stColumn(this.skip),this.timelineBody1stColumn.children[0])}_virtualScrollDown(){if(this.lastIndex+1>=this.collection.records.length)return;this.skip+=1;this.lastIndex=Math.min(this.skip+this.limit-1,this.collection.records.length);this.timelineBody.children[0].remove();this.timelineBody.appendChild(this._renderRowDiv(this.lastIndex));this.timelineBody1stColumn.children[0].remove();this.timelineBody1stColumn.appendChild(this._renderRowDiv1stColumn(this.lastIndex))}_setWidth(){let newWidth=this._computeSize("width");setTimeout((()=>{this.style.width=newWidth;this.timeline.style.width=this.clientWidth.toString()+"px"}),50)}_setHeight(){let newHeight=this._computeSize("height");this.style.height=this.timeline.style.height=newHeight}_setLimit(){if(!this.isConnected)return;let tableHeight=this.offsetHeight;let headerHeight=$("timeline-header:"+this.id).offsetHeight;let toolbarHeight=$("timeline-toolbar:"+this.id).offsetHeight;let bodyHeight=tableHeight-toolbarHeight-headerHeight;this.limit=Math.floor(bodyHeight/(kiss.tools.remToPx(this.rowHeight)+1));if(kiss.screen.isMobile)this.limit=this.limit-1}_renderPagerIndex(){if(!this.isConnected)return;if(kiss.screen.isMobile&&kiss.screen.isVertical()){$("pager-index:"+this.id).innerHTML=Math.min(this.collection.count,this.skip+this.limit)+" / "+this.collection.count}else{$("pager-index:"+this.id).innerHTML=this.skip+1+" - "+Math.min(this.collection.count,this.skip+this.limit)+" / "+this.collection.count}}_render(){this.timelineHeader1stColumn.innerHTML="";this.timelineBody1stColumn.innerHTML="";this.visibleColumns=this.columns.filter((column=>column.hidden!=true&&column.deleted!=true));this._initDayWidth(this.config)._columnsSetFirstColumnWidth(this.firstColumnWidth)._renderHeader()._renderHeaderToday()._renderBody();return this}_renderHeader(){let firstCell=document.createElement("div");firstCell.setAttribute("id","header-1stColumn");firstCell.setAttribute("col","-1");firstCell.classList.add("timeline-column-header","timeline-column-header-1st");firstCell.style.width=firstCell.style.minWidth=this.firstColumnWidth+"rem";firstCell.innerHTML=`<span id='toggle-selection' class='timeline-header-checkbox ${this.canSelect?"timeline-header-checkbox-off":""}'></span>`+`<span id='header-resizer-1st-column' class='fas fa-arrows-alt-h timeline-column-header-resizer'></span>`;this.timelineHeader1stColumn.appendChild(firstCell);const numberOfDays=this._getNumberOfDays();const htmlForDays=this._renderHeaderDays(numberOfDays);const htmlForMonths=this._renderHeaderMonths();this.timelineHeader.innerHTML=`\n            <div>\n                <span class="timeline-header-months">\n                    ${htmlForMonths}\n                </span>\n                <span class="timeline-header-days">\n                    ${htmlForDays}\n                </span>\n            </div>`;return this}_renderHeaderDays(max){this.numberOfDays=0;let html="";this.startDate=new Date(this.date);this.startDate.setHours(0,0,0,0);let currentDate=this.startDate;for(let i=1;i<=max;i++){this.numberOfDays++;currentDate=new Date(kiss.formula.ADJUST_DATE(currentDate,0,0,1,0,0,0));const day=currentDate.getDate();const month=currentDate.getMonth();const year=currentDate.getFullYear();const dayId=this._getDayId(day,month+1,year);const currentDay=currentDate.getDay();const dayLetter=this.weekDays[currentDay][0];let dayClass="";if(currentDay==0||currentDay==6)dayClass="timeline-header-weekend";if(this.dayWidth>kiss.tools.remToPx(3)){html+=`<div id="${dayId}" style="min-width: ${this.dayWidth}px" class="timeline-header-day ${dayClass}">\n                    <div>${dayLetter}</div><div>${day}</div>    \n                </div>`}else if(this.dayWidth>kiss.tools.remToPx(2)){html+=`<div id="${dayId}" style="min-width: ${this.dayWidth}px" class="timeline-header-day ${dayClass}">\n                    <div style="font-size: 0.8rem">${day}</div>\n                </div>`}else{html+=`<div id="${dayId}" style="min-width: ${this.dayWidth}px" class="timeline-header-day ${dayClass}">\n                </div>`}}this.endDate=currentDate;return html}_renderHeaderMonths(){let html="";let currentDate=this.startDate;let currentMonth=currentDate.getMonth();let currentYear=currentDate.getFullYear();while(currentDate<=this.endDate){let lastDayOfMonth=new Date(currentYear,currentMonth+1,0);if(lastDayOfMonth>this.endDate)lastDayOfMonth=this.endDate;let daysInMonthDisplayed=(lastDayOfMonth-currentDate)/(1e3*60*60*24)+1;let monthWidth=daysInMonthDisplayed*this.dayWidth;if(monthWidth>120){html+=`<div style="width: ${monthWidth}px; color: ${this.color}" class="timeline-header-month">${this.months[currentMonth]} ${currentYear}</div>`}else if(monthWidth>50){html+=`<div style="width: ${monthWidth}px; color: ${this.color}" class="timeline-header-month">${(currentMonth+1).toString().padStart(2,"0")} / ${currentYear}</div>`}else{html+=`<div style="width: ${monthWidth}px; color: ${this.color}" class="timeline-header-month">${(currentMonth+1).toString().padStart(2,"0")}</div>`}currentDate=new Date(currentYear,currentMonth+1,1);currentMonth=currentDate.getMonth();currentYear=currentDate.getFullYear()}return html}_renderHeaderToday(){let today=(new Date).toISO();let todayCell=$(today);if(!todayCell)return this;todayCell.style.color="#ffffff";todayCell.style.backgroundColor=this.color;return this}_renderRowContent(record){let startDate=record[this.startDateField];let endDate=record[this.endDateField];if(!startDate||!endDate)return"";startDate=new Date(startDate);endDate=new Date(endDate);if(isNaN(startDate)||isNaN(endDate))return"";startDate=startDate.toISO();endDate=endDate.toISO();let recordHtml="";const blockWidth=this._computeBlockWidth(startDate,endDate);if(blockWidth.middle!=0){const blockColor=this._computeBlockColor(record);recordHtml=`<div class="timeline-cell-data" style="background-color: ${blockColor}">\n                    ${this._renderRecord(record).filter((value=>value)).join(" ● ")}\n                </div>`}return`<div class="timeline-cell" style="width: ${blockWidth.start}px;"></div>\n                <div class="timeline-cell" style="width: ${blockWidth.middle}px;">${recordHtml}</div>\n                <div class="timeline-cell" style="width: ${blockWidth.end}px;"></div>`}_renderRecord(record){return this.columns.filter((column=>column.hidden!==true)).map((column=>{let field=this.model.getField(column.id);if(!field)return;if(["attachment","aiImage","password","link"].includes(field.type))return;let value=record[column.id];if(!value&&value!==false&&value!==0)return;let valueHtml=this._renderSingleValue(field,value,record);return valueHtml}))}_renderSingleValue(field,value,record){const renderer=kiss.fields.renderers[this.model.id][field.id];let type=kiss.fields.getFieldType(field);switch(type){case"number":case"date":case"select":case"directory":case"checkbox":case"rating":case"selectViewColumn":return renderer({value:value,record:record});case"textarea":case"richTextField":return renderer({value:value,record:record,config:{nobr:true}});default:return value}}_renderBody(){let table="";let firstColumn="";this.startIndex=Math.max(0,this.skip);this.lastIndex=Math.min(this.skip+this.limit-1,this.collection.records.length);if(this.collection.group.length===0){for(let rowIndex=this.startIndex;rowIndex<this.lastIndex;rowIndex++){let record=this.collection.records[rowIndex];firstColumn+='<div col="-1" row="'+rowIndex+'" recordId="'+record.id+'" class="timeline-cell-1st" style="width: '+this.firstColumnWidth+"rem; min-width: "+this.firstColumnWidth+'rem">';firstColumn+=this._renderRowContent1stColumn(record,rowIndex);firstColumn+="</div>";table+='<div row="'+rowIndex+'" recordId="'+record.id+'" class="timeline-row">';table+=this._renderRowContent(record);table+="</div>"}}else{let nbOfRows=0;for(let rowIndex=this.skip;nbOfRows<this.limit&&rowIndex<this.collection.records.length;rowIndex++){let record=this.collection.records[rowIndex];if(record.$type=="group"){firstColumn+='<div col="-1" row="'+rowIndex+'" class="timeline-group timeline-group-level-'+record.$groupLevel+'" style="width: '+this.firstColumnWidth+"rem; min-width: "+this.firstColumnWidth+'rem">';firstColumn+=this._renderRowGroupContent1stColumn(record);firstColumn+="</div>";table+='<div row="'+rowIndex+'" groupLevel="'+record.$groupLevel+'" class="timeline-group-row">';table+=this._renderRowGroupContent(record);table+="</div>"}else{firstColumn+='<div col="-1" row="'+rowIndex+'" recordId="'+record.id+'" class="timeline-cell-1st" style="width: '+this.firstColumnWidth+"rem; min-width: "+this.firstColumnWidth+'rem">';firstColumn+=this._renderRowContent1stColumn(record,rowIndex);firstColumn+="</div>";table+='<div row="'+rowIndex+'" recordId="'+record.id+'" class="timeline-row">';table+=this._renderRowContent(record);table+="</div>"}nbOfRows++}}this.timelineBody.innerHTML=table;this.timelineBody1stColumn.innerHTML=firstColumn;this._renderPagerIndex();this._renderSelection();this._renderScroller();this._renderEmptyIcon();return this}_renderEmptyIcon(){if(this.collection.records.length=="0"){this.timelineBodyContainer.classList.add("timeline-body-container-empty");this.timelineHeaderContainer.style.display="none"}else{this.timelineBodyContainer.classList.remove("timeline-body-container-empty");this.timelineHeaderContainer.style.display="flex"}}_renderRowDiv(rowIndex){let record=this.collection.records[rowIndex];if(record.$type=="group")return this._renderRowGroupDiv(record,rowIndex);let newRow=document.createElement("div");newRow.setAttribute("row",rowIndex);newRow.setAttribute("recordid",record.id);newRow.classList.add("timeline-row");let isSelected=!(this.selectedRecords.indexOf(record.id)==-1);if(isSelected)newRow.classList.add("timeline-row-selected");newRow.innerHTML=this._renderRowContent(record);return newRow}_renderRowDiv1stColumn(rowIndex){let record=this.collection.records[rowIndex];if(record.$type=="group")return this._renderRowGroupDiv1stColumn(record,rowIndex);let firstCell=document.createElement("div");firstCell.setAttribute("col","-1");firstCell.setAttribute("row",rowIndex);firstCell.setAttribute("recordid",record.id);firstCell.classList.add("timeline-cell-1st");firstCell.style.width=firstCell.style.minWidth=this.firstColumnWidth+"rem";let isSelected=!(this.selectedRecords.indexOf(record.id)==-1);firstCell.innerHTML=this._renderRowContent1stColumn(record,rowIndex,isSelected);return firstCell}_renderRowContent1stColumn(record,rowIndex,isSelected){return(this.canSelect?'<span class="timeline-row-checkbox timeline-row-checkbox-'+(isSelected?"on":"off")+'"></span>':"")+'<span class="timeline-row-number">'+(record.$index+1||Number(rowIndex+1))+" ● </span>"+'<span class="timeline-row-title">'+record[this.titleField]+"</span>"}_renderRowGroupDiv(record,rowIndex){let newRow=document.createElement("div");newRow.setAttribute("row",rowIndex);newRow.classList.add("timeline-group-row");newRow.innerHTML=this._renderRowGroupContent(record);return newRow}_renderRowGroupDiv1stColumn(record,rowIndex){let firstCell=document.createElement("div");firstCell.setAttribute("col","-1");firstCell.setAttribute("row",rowIndex);firstCell.classList.add("timeline-group","timeline-group-level-"+record.$groupLevel);firstCell.style.width=firstCell.style.minWidth=this.firstColumnWidth+"rem";firstCell.innerHTML=this._renderRowGroupContent1stColumn(record);return firstCell}_renderRowGroupContent(record){return'<div class="timeline-group-id">'+record.$groupId+". "+record.$name+"</div>"}_renderRowGroupContent1stColumn(record){let groupFieldId=this.collection.group[record.$groupLevel];let field=this.model.getField(groupFieldId);let groupClass=this.collection.collapsedGroups.includes(record.$groupId)?"timeline-group-collapsed":"timeline-group-expanded";let groupRawValue=record.$name;let groupCellValue=this._renderSingleValue(field,groupRawValue,record);return"<span class='"+groupClass+"'></span>"+groupCellValue+"&nbsp;&nbsp;("+record.$size+")"}_computeBlockColor(record){let colorValue=this.model.color;const colorField=this.colorField?this.model.getField(this.colorField):null;if(colorField){colorValue=record[this.colorField];if(colorField.type=="select"){colorValue=colorField.options.find((option=>option.value==colorValue));colorValue=colorValue?colorValue.color:this.model.color}}return colorValue}_computeBlockWidth(startDate,endDate){const bodyWidth=this.numberOfDays*this.dayWidth;const unit=bodyWidth/this.numberOfDays;const startDifference=kiss.formula.DAYS_DIFFERENCE(this.startDate,startDate);const endDifference=kiss.formula.DAYS_DIFFERENCE(endDate,this.endDate);let startX=startDifference*unit;if(startX<0)startX=0;else if(startX>bodyWidth)startX=bodyWidth;let endX=bodyWidth-endDifference*unit;if(endX<0)endX=0;else if(endX>bodyWidth)endX=bodyWidth;const startBlockWidth=Math.max(Math.floor(startX),0);const middleBlockWidth=Math.max(Math.floor(endX-startX),0);const endBlockWidth=Math.max(Math.floor(bodyWidth-endX),0);return{start:startBlockWidth,middle:middleBlockWidth,end:endBlockWidth}}_renderScroller(){setTimeout((()=>{this.timelineScrollerContainer.style.top=kiss.tools.pxToRem(this.timelineBody.getBoundingClientRect().top)+"rem";this.timelineScrollerContainer.style.left=kiss.tools.pxToRem(this.getBoundingClientRect().right-this.timelineScrollerContainer.offsetWidth)+"rem";this._showScroller()}),50);this.timelineScrollerContainer.style.height=kiss.tools.pxToRem(this.timelineBody.offsetHeight-10)+"rem";this.timelineScroller.style.height=Math.min(this.collection.count*this.rowHeight,1e4)+"rem"}_showScroller(){if(this.showScroller!==false){setTimeout((()=>{this.timelineScrollerContainer.style.visibility="visible"}),0)}}_hideScroller(){this.timelineScrollerContainer.style.visibility="hidden"}_renderScrollerPosition(){let percent=this.skip/(this.collection.records.length-this.limit);let topPosition=Math.round((this.timelineScroller.offsetHeight-this.timelineBody.offsetHeight)*percent);this.preventScroll=true;this.timelineScrollerContainer.scrollTop=topPosition}_renderSelection(){if(!this.selectedRecords)return;this.selectedRecords.forEach((recordId=>{let rowIndexes=this._rowGetAllIndexes(recordId);rowIndexes.forEach((rowIndex=>this._rowSelect(rowIndex)))}))}_renderSelectionRestore(){this.getSelection();this._renderBody()}_renderToolbar(){if(this.isToolbarRendered){this._groupUpdateGroupingFields();return}createButton({hidden:!this.canCreateRecord,class:"timeline-create-record",target:"create:"+this.id,text:this.config.createRecordText||this.model.name.toTitleCase(),icon:"fas fa-plus",iconColor:this.color,borderWidth:3,borderRadius:"3.2rem",maxWidth:kiss.screen.isMobile&&kiss.screen.isVertical()?"16rem":null,action:async()=>this.createRecord(this.model)}).render();createButton({hidden:this.showActions===false,target:"actions:"+this.id,tip:txtTitleCase("actions"),icon:"fas fa-bolt",iconColor:this.color,width:"3.2rem",action:()=>this._buildActionMenu()}).render();createButton({hidden:!this.showSetup,target:"setup:"+this.id,tip:txtTitleCase("setup the timeline"),icon:"fas fa-cog",iconColor:this.color,width:"3.2rem",action:()=>this.showSetupWindow()}).render();createButton({hidden:!this.canSelectFields,target:"select:"+this.id,tip:txtTitleCase("#display fields"),icon:"fas fa-bars fa-rotate-90",iconColor:this.color,width:"3.2rem",action:()=>this.showFieldsWindow()}).render();createButton({hidden:!this.canSort,target:"sort:"+this.id,tip:txtTitleCase("to sort"),icon:"fas fa-sort",iconColor:this.color,width:"3.2rem",action:()=>this.showSortWindow()}).render();createButton({hidden:!this.canFilter,target:"filter:"+this.id,tip:txtTitleCase("to filter"),icon:"fas fa-filter",iconColor:this.color,width:"3.2rem",action:()=>this.showFilterWindow()}).render();createButton({hidden:!this.showLayoutButton,target:"layout:"+this.id,tip:{text:txtTitleCase("layout"),minWidth:"10rem"},icon:"fas fa-ellipsis-v",iconColor:this.color,width:"3.2rem",action:()=>this._buildLayoutMenu()}).render();let groupingFields=this._groupGetModelFields();let groupingFieldValues=[];this.collection.group.forEach((fieldId=>{let groupingField=groupingFields.find((field=>field.value==fieldId));if(groupingField)groupingFieldValues.push(groupingField.value)}));createSelect({hidden:!this.canGroup,target:"group:"+this.id,id:"grouping-field:"+this.id,label:txtTitleCase("group by"),multiple:true,allowClickToDelete:true,options:groupingFields,minWidth:"20rem",maxHeight:()=>kiss.screen.current.height-200,optionsColor:this.color,value:groupingFieldValues,styles:{this:"align-items: center;","field-label":"white-space: nowrap;","field-select":"white-space: nowrap;"},events:{change:async function(event){let groupFields=this.getValue();if(groupFields.length>6){let fieldGroupSelect=$(this.id);fieldGroupSelect.value=fieldGroupSelect.getValue().slice(0,6);fieldGroupSelect._renderValues();createDialog({type:"message",title:txtTitleCase("seriously"),icon:"fas fa-exclamation-triangle",message:txtTitleCase("#too many groups"),buttonOKText:txtTitleCase("#understood")});return}let viewId=this.id.split(":")[1];publish("EVT_VIEW_GROUPING:"+viewId,groupFields)}}}).render();this.buttonExpand=createButton({hidden:!this.showGroupButtons||this.collection.group.length===0,target:"expand:"+this.id,tip:txtTitleCase("expand all"),icon:"far fa-plus-square",iconColor:this.color,width:"3.2rem",action:()=>this.expandAll()}).render();this.buttonCollapse=createButton({hidden:!this.showGroupButtons||this.collection.group.length===0,target:"collapse:"+this.id,tip:txtTitleCase("collapse all"),icon:"far fa-minus-square",iconColor:this.color,width:"3.2rem",action:()=>this.collapseAll()}).render();if(!kiss.screen.isMobile){createButton({target:"refresh:"+this.id,tip:txtTitleCase("refresh"),icon:"fas fa-undo-alt",iconColor:this.color,width:"3.2rem",events:{click:()=>this.reload()}}).render()}createButton({hidden:!this.canSearch,target:"search:"+this.id,icon:"fas fa-search",iconColor:this.color,width:"3.2rem",events:{click:()=>this.showSearchBar()}}).render();if(this.canChangePeriod){let _this=this;createSelect({target:"pager-mode:"+this.id,id:"pager-mode:"+this.id,options:[{label:"1 "+txt("year"),value:"1 year"},{label:"6 "+txt("months"),value:"6 months"},{label:"4 "+txt("months"),value:"4 months"},{label:"3 "+txt("months"),value:"3 months"},{label:"2 "+txt("months"),value:"2 months"},{label:"1 "+txt("month"),value:"1 month"},{label:"3 "+txt("weeks"),value:"3 weeks"},{label:"2 "+txt("weeks"),value:"2 weeks"},{label:"1 "+txt("week"),value:"1 week"}],optionsColor:this.color,value:this.period||"1 month",fieldWidth:"15rem",styles:{this:"align-items: center;","field-label":"white-space: nowrap;","field-select":"white-space: nowrap;"},events:{change:async function(){_this.period=this.getValue();const numberOfDays=_this.periods[_this.period];const bodyWidth=_this._getBodyWidth();const newDayWidth=Math.floor(bodyWidth/numberOfDays);_this._setDayWidth(newDayWidth)}}}).render()}createButton({target:"pager-previous:"+this.id,icon:"fas fa-chevron-left",iconColor:this.color,width:"3.2rem",events:{click:()=>{this.date=new Date(kiss.formula.ADJUST_DATE(this.startDate,0,0,-this.numberOfDays,0,0,0));this._render()}}}).render();createButton({target:"pager-next:"+this.id,icon:"fas fa-chevron-right",iconColor:this.color,width:"3.2rem",events:{click:()=>{this.date=new Date(kiss.formula.ADJUST_DATE(this.startDate,0,0,this.numberOfDays,0,0,0));this._render()}}}).render();const todayButton={target:"pager-today:"+this.id,icon:"fas fa-stop",iconColor:this.color,events:{click:()=>{this.date=new Date;this._render()}}};if(!kiss.screen.isMobile)todayButton.text=txtTitleCase("today");createButton(todayButton).render();this.isToolbarRendered=true}_rowToggleSelect(rowIndex){let checkbox=this._rowGetCheckbox(rowIndex);let recordId=checkbox.parentNode.getAttribute("recordId");let rowIndexes=this._rowGetAllIndexes(recordId);let isSelected=this.selectedRecords.indexOf(recordId)!=-1;if(isSelected){rowIndexes.forEach((rowIndex=>this._rowDeselect(rowIndex)));kiss.selection.delete(this.id,recordId)}else{rowIndexes.forEach((rowIndex=>this._rowSelect(rowIndex)));kiss.selection.insertOne(this.id,recordId)}this.selectedRecords=kiss.selection.get(this.id);return recordId}_rowSelect(rowIndex){let checkbox=this._rowGetCheckbox(rowIndex);if(!checkbox)return;checkbox.classList.add("timeline-row-checkbox-on");checkbox.classList.remove("timeline-row-checkbox-off");let row=this.timelineBody.querySelector('[row="'+rowIndex+'"]');row.classList.add("timeline-row-selected")}_rowDeselect(rowIndex){let checkbox=this._rowGetCheckbox(rowIndex);checkbox.classList.add("timeline-row-checkbox-off");checkbox.classList.remove("timeline-row-checkbox-on");let row=this.timelineBody.querySelector('[row="'+rowIndex+'"]');row.classList.remove("timeline-row-selected")}_rowHighlight(rowIndex){let row=this.querySelector('[row="'+rowIndex+'"]');row.classList.add("timeline-row-selected")}_rowGetCheckbox(rowIndex){return this.timelineBody1stColumn.querySelector('[row="'+rowIndex+'"]').querySelector(".timeline-row-checkbox")}_rowFindIndex(recordId){return this.collection.records.findIndex((record=>record.id==recordId))}_rowGetAllIndexes(recordId){let rows=this.timelineBody.querySelectorAll("div[recordId='"+recordId+"']");if(rows)return Array.from(rows).map((row=>row.getAttribute("row")));else return null}_getRowHeightFromLocalStorage(){const localStorageId="config-view-timeline-"+this.id+"-row-height";const rowHeight=localStorage.getItem(localStorageId);if(!rowHeight)return this.defaultRowHeight;return Number(rowHeight)}_columnsSetWidth(newWidth){localStorage.setItem("config-view-timeline-"+this.id+"-1st-column",newWidth)}_columnsResizeWithDragAndDrop(event,element){let columnMinSize=10;let colIndex=element.parentNode.getAttribute("col");let columnCells=Array.from(this.querySelectorAll("div[col='"+colIndex+"']"));let columnHeader=element.parentNode;let columnHeaderTitle=columnHeader.children[0];columnHeader.mouseStartX=event.x;let currentWidth=columnHeader.clientWidth;let newWidth;document.onmousemove=event=>{let _event=event;setTimeout((()=>{newWidth=kiss.tools.pxToRem(currentWidth+_event.x-columnHeader.mouseStartX);if(newWidth>columnMinSize){columnHeader.style.minWidth=columnHeader.style.width=newWidth+"rem";columnHeaderTitle.style.minWidth=columnHeaderTitle.style.width=newWidth-this.resizerWidth+"rem";columnCells.forEach((cell=>cell.style.width=cell.style.minWidth=newWidth+"rem"));this._columnsSetFirstColumnWidth(newWidth)}}),1)};document.onmouseup=()=>{this._columnsSetWidth(Math.max(columnMinSize,newWidth));document.onmousemove=null;document.onmouseup=null;this._render()}}_columnsSetFirstColumnWidth(newWidth){this.firstColumnWidth=newWidth;this.timelineHeader1stColumn.style.minWidth=newWidth+"rem";this.timelineBody1stColumn.style.minWidth=newWidth+"rem";return this}_columnsAdjustWidthFromLocalStorage(){let localStorageId="config-view-timeline-"+this.id+"-1st-column";let firstColumnWidth=localStorage.getItem(localStorageId);this.firstColumnWidth=firstColumnWidth||this.firstColumnWidth;return this}async _buildLayoutMenu(){let buttonLeftPosition=$("layout:"+this.id).offsetLeft;let buttonTopPosition=$("layout:"+this.id).offsetTop;createMenu({top:buttonTopPosition,left:buttonLeftPosition,items:[txtTitleCase("cell size"),"-",{icon:"fas fa-circle",iconSize:"0.2rem",text:txtTitleCase("compact"),action:()=>{this.rowHeight=3;this.setRowHeight(this.rowHeight)}},{icon:"fas fa-circle",iconSize:"0.6rem",text:txtTitleCase("normal"),action:()=>{this.rowHeight=this.defaultRowHeight;this.setRowHeight(this.rowHeight)}},{icon:"fas fa-circle",iconSize:"1rem",text:txtTitleCase("medium"),action:()=>{this.rowHeight=8;this.setRowHeight(this.rowHeight)}},{icon:"fas fa-circle",iconSize:"1.4rem",text:txtTitleCase("tall"),action:()=>{this.rowHeight=12;this.setRowHeight(this.rowHeight)}},{icon:"fas fa-circle",iconSize:"1.8rem",text:txtTitleCase("very tall"),action:()=>{this.rowHeight=16;this.setRowHeight(this.rowHeight)}},"-",{icon:"fas fa-undo-alt",text:txtTitleCase("#reset view params"),action:()=>this.resetLocalViewParameters()}]}).render()}};customElements.define("a-timeline",kiss.ui.Timeline);const createTimeline=config=>document.createElement("a-timeline").init(config);kiss.ui.TreeList=class TreeList extends kiss.ui.Component{constructor(){super()}init(config){super.init(config);const defaultFolderRenderer=node=>`${node.name}`;const defaultLeafRenderer=node=>`${node.name}`;const buildTreeList=function(tree,fnFolderRenderer,fnLeafRenderer){let html='<ul class="tree">';tree.forEach((node=>{let isFolder=node.items&&node.items.length!=0;if(isFolder==true){html+=`<li id="${node.id||uid()}" class="tree-folder tree-folder-open" onclick="this.getComponent().onFolderClick(event, this)"><div onclick="this.parentNode.switch()">`+fnFolderRenderer(node)+"</div>"}else{html+=`<li id="${node.id||uid()}" class="tree-leaf" onclick="this.getComponent().onLeafClick(event, this)"><div>`+fnLeafRenderer(node)+"</div>"}if(isFolder)html+=buildTreeList(node.items,fnFolderRenderer,fnLeafRenderer);html+="</li>"}));html+="</ul>";return html};this.innerHTML=buildTreeList(config.tree,config.folderRenderer||defaultFolderRenderer,config.leafRenderer||defaultLeafRenderer);return this}};customElements.define("a-treelist",kiss.ui.TreeList);const createTreeList=config=>document.createElement("a-treelist").init(config);HTMLLIElement.prototype.switch=function(){this._toggleClass("tree-folder-open");this._toggleClass("tree-folder-closed");this.children.forEach((function(node){if(node.nodeName=="UL"){if(node.style.display=="none"){node.style.display="block"}else{node.style.display="none"}}}));return this};kiss.ui.Button=class Button extends kiss.ui.Component{constructor(){super()}init(config={}){super.init(config);this.icon=config.icon||"";this.text=config.text||"";this.text=this.text.replaceAll("\n","<br>");this.innerHTML=`\n            ${config.icon?`<span id="button-icon-${this.id}" class="button-icon ${this.icon}"></span>`:""}\n            ${config.text?`<span id="button-text-${this.id}" class="button-text">${this.text}</span>`:""}`.removeExtraSpaces();this.buttonIcon=this.querySelector(".button-icon")||{};this.buttonText=this.querySelector(".button-text")||{};if(config.backgroundColor&&config.backgroundColor2){let gradientDirection=config.gradientDirection||"to right";config.background=`linear-gradient(${gradientDirection}, ${config.backgroundColor}, ${config.backgroundColor2})`}this._setProperties(config,[[["draggable"],[this]],[["display","flex","flexGrow","flexShrink","alignItems","justifyContent","position","float","top","left","right","width","minWidth","maxWidth","height","minHeight","maxHeight","margin","padding","background","backgroundColor","border","borderColor","borderRadius","borderStyle","borderWidth","boxShadow","cursor","zIndex"],[this.style]],[["color","fontSize","fontWeight","textAlign"],[this.buttonText.style]],[["iconSize=fontSize","iconColor=color","iconPadding=padding","iconMargin=margin","iconShadow=textShadow"],[this.buttonIcon.style]]]);this.displayMode="inline-flex";this._assignAction();if(config.iconHover)this._createHoverListener("iconHover",config.iconHover,"_setHoverIcon","_resetIcon");if(config.colorHover)this._createHoverListener("colorHover",config.colorHover,"_setHoverColor","_resetColor");if(config.iconColorHover)this._createHoverListener("iconColorHover",config.iconColorHover,"_setHoverIconColor","_resetIconColor");if(config.iconShadowHover)this._createHoverListener("iconShadowHover",config.iconShadowHover,"_setHoverIconShadow","_resetIconShadow");if(config.boxShadowHover)this._createHoverListener("boxShadowHover",config.boxShadowHover,"_setHoverBoxShadow","_resetBoxShadow");if(config.borderColorHover)this._createHoverListener("borderColorHover",config.borderColorHover,"_setHoverBorderColor","_resetBorderColor");if(config.backgroundColorHover)this._createHoverListener("backgroundColorHover",config.backgroundColorHover,"_setHoverBackgroundColor","_resetBackgroundColor");this.onmouseup=()=>{if(config.colorHover)this._resetColor();if(config.iconColorHover)this._resetIconColor();if(config.iconShadowHover)this._resetIconShadow();if(config.boxShadowHover)this._resetBoxShadow();if(config.borderColorHover)this._resetBorderColor();if(config.backgroundColorHover)this._resetBackgroundColor()};if(config.icon){this.buttonIcon.style.width=config.height?this._computeSize("height"):"var(--button-height)";this.iconPosition=config.iconPosition||"left";const flow={top:"column",left:"row",bottom:"column-reverse",right:"row-reverse"};this.style.flexFlow=flow[this.iconPosition]}return this}setText(text=""){text=text.replaceAll("\n","<br>");this.config.text=text;this.buttonText.innerText=text;return this}setIcon(iconClass){this.config.icon=iconClass;this.icon.split(" ").forEach((className=>this.buttonIcon.classList.remove(className)));this.icon=iconClass;this.icon.split(" ").forEach((className=>this.buttonIcon.classList.add(className)));return this}setColor(color){this.config.color=color;if(this.buttonText&&this.buttonText.style)this.buttonText.style.color=color;return this}setBackgroundColor(color,color2,direction){this.config.backgroundColor=color;if(color2)this.config.backgroundColor2=color2;let bgColor=color;if(color2){let bgDirection="to right";if(direction){this.config.gradientDirection=bgDirection=direction}bgColor=`linear-gradient(${bgDirection}, ${color}, ${color2})`}this.style.background=bgColor;return this}setIconColor(color){this.config.iconColor=color;if(this.config.icon)this.buttonIcon.style.color=color;return this}setBorderColor(color){this.config.borderColor=color;this.style.borderColor=color;return this}setWidth(width,margin){if(!margin){this.config.width=width;this.style.width=this._computeSize("width");return this}this.config.width=`calc(${width} - calc(${margin} * 2))`;this.style.width=this._computeSize("width");this.style.margin=`${this.style.marginTop} ${margin} ${this.style.marginBottom} ${margin}`;return this}setHeight(height){this.config.height=height;this.style.height=this._computeSize("height");return this}disable(){this.disabledAction=this.onclick;this.onclick=null;this.style.cursor="not-allowed"}enable(){if(!this.disabledAction)return;this.onclick=this.disabledAction;this.style.cursor=this.config.cursor||"pointer"}_assignAction(){if(this.config.action){this.canClick=true;this.onclick=function(event){if(!this.canClick)return;this.canClick=false;this.config.action.call(this,event);setTimeout((()=>{this.canClick=true}),this.config.cooldown||0)}}}_createHoverListener(propertyName,propertyValue,setMethod,resetMethod){this[propertyName]=propertyValue;this.addEventListener("mouseenter",this[setMethod]);this.addEventListener("mouseleave",this[resetMethod])}_setHoverColor(){if(!this.buttonText)return;this.currentColor=this.buttonText.style.color;this.buttonText.style.color=this.colorHover}_resetColor(){this.buttonText.style.color=this.currentColor}_setHoverIcon(){if(!this.icon)return;this.currentIcon=this.icon;this.setIcon(this.config.iconHover)}_resetIcon(){this.setIcon(this.currentIcon)}_setHoverIconColor(){if(!this.buttonIcon)return;this.currentIconColor=this.buttonIcon.style.color;this.buttonIcon.style.color=this.iconColorHover}_resetIconColor(){this.buttonIcon.style.color=this.currentIconColor}_setHoverIconShadow(){if(!this.buttonIcon)return;this.currentIconShadow=this.buttonIcon.style.textShadow;this.buttonIcon.style.textShadow=this.iconShadowHover}_resetIconShadow(){this.buttonIcon.style.textShadow=this.currentIconShadow}_setHoverBoxShadow(){this.currentShadow=this.style.boxShadow;this.style.boxShadow=this.boxShadowHover}_resetBoxShadow(){this.style.boxShadow=this.currentShadow}_setHoverBorderColor(){this.currentBorderColor=this.style.borderColor;this.style.borderColor=this.borderColorHover}_resetBorderColor(){this.style.borderColor=this.currentBorderColor}_setHoverBackgroundColor(){this.currentBackgroundColor=this.style.backgroundColor;this.style.backgroundColor=this.backgroundColorHover}_resetBackgroundColor(){this.style.backgroundColor=this.currentBackgroundColor}};customElements.define("a-button",kiss.ui.Button);const createButton=config=>document.createElement("a-button").init(config);kiss.ui.Dialog=class Dialog{constructor(config){const isMobile=kiss.screen.isMobile;const dialogId=config.id||kiss.tools.shortUid();if(typeof config=="string"){config={type:"message",message:config}}const dialogType=config.type||"dialog";if(config.textAlign=="center"){config.message=`<center>${config.message}</center>`}config.message=(config.message||"").replaceAll("\n","<br>");if(config.type=="danger"){config.icon="fas fa-exclamation-triangle";config.headerBackgroundColor="var(--background-red)";config.colorOK="var(--red)";config.colorCancel="var(--green)"}const buttonOK={hidden:config.noOK==true,type:"button",text:config.buttonOKText||txtTitleCase("ok"),icon:config.iconOK===false?false:config.iconOK||"fas fa-check",iconColor:config.colorOK||null,flex:1,styles:{this:config.colorOK?"border-color: "+config.colorOK:""},events:{click:async function(){$(dialogId).validate()}}};const buttonCancel={hidden:dialogType=="message"||config.noCancel==true,type:"button",text:config.buttonCancelText||txtTitleCase("cancel"),icon:config.iconCancel===false?false:config.iconCancel||"fas fa-times",iconColor:config.colorCancel||null,flex:1,styles:{this:config.colorCancel?"border-color: "+config.colorCancel:""},events:{click:function(){this.closest("a-panel").close()}}};let dialogConfig={id:dialogId,class:"panel-dialog",top:config.top||null,left:config.left||null,width:isMobile?"100%":config.width||null,height:isMobile?"100%":config.height||null,borderRadius:isMobile?"0 0 0 0":"",align:"center",verticalAlign:"center",modal:true,backdropFilter:config.backdropFilter,draggable:true,closable:!(config.closable===false),animation:config.animation||null,zIndex:1,header:config.header!==false,title:config.title||"",icon:config.icon||"fas fa-info-circle",headerHeight:config.headerHeight,headerBackgroundColor:config.headerBackgroundColor||"#00aaee",items:[dialogType=="message"||dialogType=="dialog"||dialogType=="danger"?{type:"html",width:"100%",padding:"3.2rem",html:config.message}:null,dialogType=="input"?{id:"input-box-field",type:"text",label:config.message,labelPosition:"top",width:"100%",fieldWidth:"100%",value:config.defaultValue||""}:null,dialogType=="select"?{id:"input-box-field",type:"select",label:config.message,labelPosition:"top",width:"100%",value:config.defaultValue||"",multiple:!!config.multiple,options:config.options||[],allowValuesNotInList:false}:null,dialogType=="directory"?{id:"input-box-field",type:"directory",label:config.message,labelPosition:"top",width:"100%",value:config.defaultValue||"",multiple:!!config.multiple,users:config.users===false?false:true,groups:config.groups===false?false:true,roles:!!config.roles,allowValuesNotInList:false}:null,{layout:"horizontal",margin:"1rem 0 0 0",defaultConfig:{margin:"0.5rem"},items:config.buttonOKPosition=="left"?[buttonOK,buttonCancel]:[buttonCancel,buttonOK]}],events:{onkeydown(event){if(event.key=="Escape"){this.close()}else if(event.key=="Enter"){this.validate()}}},methods:{_afterRender(){if(dialogType=="input"){setTimeout((()=>$("input-box-field").focus()),100)}else{setTimeout((()=>this.panelBody.focus()),100)}},async validate(){if(config.action){const newValue=dialogType=="input"||dialogType=="select"||dialogType=="directory"?$("input-box-field").getValue():true;const result=await config.action(newValue);if(config.autoClose==null||config.autoClose==true||result==true)this.close()}else{this.close()}}}};if(config.methods)Object.assign(dialogConfig.methods,config.methods);if(config.events)Object.assign(dialogConfig.events,config.events);let dialog=createPanel(dialogConfig).render();return dialog}};const createDialog=config=>new kiss.ui.Dialog(config);kiss.ui.Html=class Html extends kiss.ui.Component{constructor(){super()}init(config){super.init(config);this.innerHTML=config.html||"";this._setProperties(config,[[["display","flex","flexFlow","flexFlow","flexWrap","alignItems","justifyContent","textAlign","width","minWidth","maxWidth","height","minHeight","maxHeight","overflow","overflowX","overflowY","padding","margin","position","top","left","right","float","color","fontSize","fontWeight","background","backgroundColor","boxShadow","zIndex","border","borderStyle","borderWidth","borderColor","borderRadius","cursor"],[this.style]]]);return this}setInnerHtml(html){this.config.html=html;this.innerHTML=html;return this}getInnerHtml(){return this.innerHTML}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setHeight(height){this.config.height=height;this.style.height=this._computeSize("height",height);return this}};customElements.define("a-html",kiss.ui.Html);const createHtml=config=>document.createElement("a-html").init(config);kiss.ui.Image=class Image extends kiss.ui.Component{constructor(){super()}init(config){super.init(config);this.alt=config.alt||"";this.caption=config.caption||"";config.src=config.src||this._emptyImage();if(!config.caption){this.innerHTML=`<img id="image-content-${this.id}" ${config.src?'src="'+config.src+'"':""} ${config.alt?`alt="${config.alt}"`:""} class="image-content" loading="lazy">`}else{this.innerHTML=`<figure>\n                    <img id="image-content-${this.id}" ${config.src?'src="'+config.src+'"':""} ${config.alt?`alt="${config.alt}"`:""} class="image-content" loading="lazy">\n                    <figcaption class="image-caption-text">${config.caption}</figcaption>\n                </figure>`.removeExtraSpaces()}kiss.session.setupImg(this.querySelector("img"));this.imageContent=this.querySelector(".image-content");this._setProperties(config,[[["draggable"],[this]],[["minWidth","minHeight","width","height","maxWidth","maxHeight","margin","position","top","left","right","float","boxShadow","zIndex","border","borderStyle","borderWidth","borderColor","borderRadius","background","backgroundColor"],[this.style]],[["minWidth","minHeight","width","height","maxWidth","maxHeight","padding","cursor","objectFit","borderRadius"],[this.imageContent.style]]]);if(config.record)this._bindRecord(config.record);return this}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.imageContent.src=this.initialValue=record[this.id]}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){const newValue=updates[this.id];if(newValue||newValue===0||newValue===""){this.imageContent.src=newValue}}}setValue(newValue,rawUpdate){if(rawUpdate){this.imageContent.src=this.config.src=newValue;return this}if(this.record){this.record.updateFieldDeep(this.id,newValue).then((success=>{if(!success){this.imageContent.src=this.config.src=this.initialValue||""}else{this.initialValue=newValue}}))}else{this.imageContent.src=this.config.src=newValue}return this}getValue(){return this.imageContent.src}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setHeight(height){this.config.height=height;this.style.height=this._computeSize("height",height);return this}updateAltText(alt){this.config.alt=this.alt=alt;this.imageContent.alt=alt;return this}updateCaption(caption){this.config.caption=this.caption=caption;const figcaption=this.querySelector(".image-caption-text");if(figcaption)figcaption.textContent=caption;return this}_emptyImage(){return`data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTQgM0MyLjg5NTQzIDMgMiAzLjg5NTQzIDIgNVYxOUMyIDIwLjEwNDYgMi44OTU0MyAyMSA0IDIxSDIwQzIxLjEwNDYgMjEgMjIgMjAuMTA0NiAyMiAxOVY1QzIyIDMuODk1NDMgMjEuMTA0NiAzIDIwIDNINFpNMjAgNUg0VjE5SDIwVjVaTTcuMjUgOC41Qzc uMjUgOS4xOTAzNiA3LjgwOTY0IDkuNzUgOC41IDkuNzVDOS4xOTAzNiA5Ljc1IDkuNzUgOS4xOTAzNiA5Ljc1IDguNUM5Ljc1IDcuODA5NjQgOS4xOTAzNiA3LjI1IDguNSA3LjI1QzcuODA5NjQgNy4yNSA3LjI1IDcuODA5NjQgNy4yNSA4LjVaTTcuODExNDMgMTUuNDIxOUwxMC41Mjk0IDEyLjI1TDEzLjMxNTUgMTUuNDIxOUwxNS45MzY1IDEyLjY0ODdMMTkuNzUgMTcuMDY0NUg0LjI1T DcuODExNDMgMTUuNDIxOVoiIGZpbGw9ImN1cnJlbnRDb2xvciIvPjwvc3ZnPg==`}};customElements.define("a-image",kiss.ui.Image);const createImage=config=>document.createElement("a-image").init(config);kiss.ui.Menu=class Menu extends kiss.ui.Component{constructor(){super()}init(config){super.init(config);const altClass=config.classModifier||"";let defaultMenuItemRenderer=function(config){const iconSize=config.iconSize?`font-size: ${config.iconSize};`:"";const iconColor=config.iconColor?`color: ${config.iconColor}`:"";const iconStyle=iconSize||iconColor?`style="${iconSize} ${iconColor}"`:"";return`\n                ${typeof config!="string"?`<div class="menu-item ${altClass}">\n                            <span class="menu-item-icon ${altClass}"><i ${iconStyle} class="${config.icon}"></i></span>\n                            <span class="menu-item-text ${altClass}">${config.text}</span>\n                        </div>`:config=="-"?`<div class="menu-separator"></div>`:`<div class="menu-section">${config}</div>`}`.removeExtraSpaces()};this.visibleItems=config.items.filter((item=>item.hidden!=true&&item!=null&&item!=""));this.innerHTML=!kiss.screen.isMobile?"":`\n            <span class="a-menu-mobile-close fas fa-chevron-left" onclick="this.closest('a-menu').close()"></span>\n        `;this.innerHTML+=this.visibleItems.map((item=>{const itemRenderer=item.itemRenderer||defaultMenuItemRenderer;return itemRenderer(item)})).join("");this.style.position="absolute";this.style.display="block";this.style.zIndex=1e4;this.menuItems=this.querySelectorAll(".menu-item, .menu-separator, .menu-section");if(!config.maxHeight)config.maxHeight=()=>kiss.screen.current.height-20;this._setProperties(config,[[["padding","top","left","bottom","right","width","minWidth","maxWidth","height","minHeight","maxHeight","color","background","backgroundColor","border","borderStyle","borderWidth","borderColor","borderRadius","boxShadow","zIndex"],[this.style]],[["itemBackground=background"],Array.from(this.menuItems).map((menuItem=>menuItem.style))]]);if(config.closeOnClick!==false)config.closeOnClick=true;let menu=this;for(let i=0;i<this.menuItems.length;i++){if(typeof menu.visibleItems[i]!="string")this.menuItems[i].onclick=function(event){if(config.closeOnClick)menu.close();menu.visibleItems[i].action(event)}}if(config.closeOnExit!==false)this.onmouseleave=()=>this.close();this.setAnimation(config.animation||{name:"zoomIn",speed:"light"});return this}close(){kiss.views.remove(this.id)}_afterRender(){kiss.tools.moveToViewport(this)}};document.addEventListener("mousedown",(function(event){const menu=document.querySelector("a-menu");if(!menu)return;const rect=menu.getBoundingClientRect();const x=event.clientX;const y=event.clientY;if(x>=rect.left&&x<=rect.right&&y>=rect.top&&y<=rect.bottom)return;const menus=Array.from(document.querySelectorAll("a-menu"));menus.forEach((menu=>menu.close()))}));customElements.define("a-menu",kiss.ui.Menu);const createMenu=config=>document.createElement("a-menu").init(config);kiss.ui.Notification=class Notification{constructor(config){let message=typeof config=="string"?config:config.message||"";message=message.replaceAll("\n","<br>");const notificationConfig={top:config.top===undefined?"10rem":config.top,width:config.width,height:config.height,padding:config.padding,position:"fixed",header:false,class:"a-notification",styles:{this:""},animation:{name:config.setAnimation||"slideInDown",speed:"faster"},items:[{type:"html",width:"100%",html:message}]};if(config.background)notificationConfig.styles.this=`background: ${config.background}; border-color: ${config.background}`;if(config.color)notificationConfig.styles.this+=`; color: ${config.color}`;if(config.fontFamily)notificationConfig.styles.this+=`; font-family: ${config.fontFamily}`;if(config.fontWeight)notificationConfig.styles.this+=`; font-weight: ${config.fontWeight}`;if(config.hasOwnProperty("left")){notificationConfig.left=config.left}else{notificationConfig.align="center"}const notification=createPanel(notificationConfig).render();setTimeout((()=>{notification.setAnimation({name:"fadeOut",speed:"faster",callback:()=>{if(notification)notification.close()}})}),config.duration||2e3);return notification}};const createNotification=config=>new kiss.ui.Notification(config);kiss.ui.Spacer=class Spacer extends kiss.ui.Component{constructor(){super()}init(config){super.init(config);this.style.display="block";this._setProperties(config,[[["display","width","height","flex"],[this.style]]]);return this}};customElements.define("a-spacer",kiss.ui.Spacer);const createSpacer=config=>document.createElement("a-spacer").init(config);kiss.ui.Tip=class Tip{constructor(config){const tipId=uid();const targetElement=config.target;const deltaX=config.deltaX||0;const deltaY=config.deltaY||20;const minWidth=config.minWidth||"5rem";const maxWidth=config.maxWidth||"30rem";const message=config.text.replaceAll("\n","<br>");return createHtml({id:tipId,position:"absolute",display:"block",zIndex:5e4,class:"a-tip",minWidth:minWidth,maxWidth:maxWidth,html:config.textAlign?`<div style="width: 100%; text-align: ${config.textAlign}">${message}</div>`:message,methods:{load(){document.addEventListener("mousemove",this.showTip);targetElement.onmouseenter=()=>this.render();targetElement.onmouseleave=()=>this.hideTip();targetElement._beforeDelete=()=>this.hideTip()},hideTip(){document.removeEventListener("mousemove",this.showTip);this.remove()},detach(){document.removeEventListener("mousemove",this.showTip);targetElement.onmouseenter=null;targetElement.onmouseleave=null;this.remove()},showTip(event){if(!event)return;const element=$(tipId);element.showAt(config.x||event.pageX+deltaX,config.y||event.pageY+deltaY)}}})}};const createTip=config=>new kiss.ui.Tip(config);kiss.ui.Attachment=class Attachment extends kiss.ui.Component{constructor(){super()}init(config={}){super.init(config);this.value=config.value||[];this.multiple=config.multiple===false?false:true;this.readOnly=!!config.readOnly;if(!Array.isArray(this.value))this.value=[];this.innerHTML=`${config.label?`<span id="field-label-${this.id}" class="field-label">\n                    ${this.isLocked()?this.locker:""}\n                    ${config.label||""}\n                    ${this.isRequired()?this.asterisk:""}\n                </span>`:""}\n\n                ${!this.readOnly?`<span class="a-button field-attachment-button field-upload-button">\n                        <span class="fas fa-paperclip field-attachment-icon"></span>\n                        ${config.buttonText||txtTitleCase("attach files")}\n                    </span>`:""}\n                \n                <span class="field-attachment-layout">\n                    <span class="a-button field-attachment-button display-as-list fas fa-th-list"></span>\n                    <span class="a-button field-attachment-button display-as-thumbnails fas fa-th-large"></span>\n                    <span class="a-button field-attachment-button display-as-thumbnails-large fas fa-stop"></span>\n                </span>\n\n                <div class="field-attachment-gallery"></div>\n             `.removeExtraSpaces();this.label=this.querySelector(".field-label");this.fieldValues=this.querySelector(".field-attachment-gallery");this.uploadButton=this.querySelector(".field-upload-button");this.layoutButtons=this.querySelector(".field-attachment-layout");this._setProperties(config,[[["margin","padding"],[this.style]],[["labelColor=color","labelFontSize=fontSize","labelFontWeight=fontWeight","labelAlign=textAlign","labelFlex=flex"],[this.label?.style]]]);this.displayMode="flex";this._initLayout();this.classList.add("a-attachment");if(config.record)this._bindRecord(config.record);setTimeout((()=>this._renderValues()),200);this._initClickEvent();return this}_initClickEvent(){this.onclick=function(event){if(event.target.classList.contains("field-upload-button")){this.showUploadWindow({ACL:this.config.ACL||"private",maxSize:this.config.maxSize||0})}else if(event.target.classList.contains("display-as-list")){this.renderAs("list")}else if(event.target.classList.contains("display-as-thumbnails")){this.renderAs("thumbnails")}else if(event.target.classList.contains("display-as-thumbnails-large")){this.renderAs("thumbnails-large")}}}renderAs(mode){if(mode=="list"){localStorage.removeItem("config-layout-"+this.id);mode=""}else{localStorage.setItem("config-layout-"+this.id,mode);mode="-"+mode}this._initLayout();this._setItemClass("item","field-attachment-item"+mode);this._setItemClass("preview","field-attachment-preview"+mode);this._setItemClass("filename","field-attachment-filename"+mode)}_getItemsByRole(role){return Array.from(this.querySelectorAll(`[role="${role}"]`))}_setItemClass(role,classname){const items=this._getItemsByRole(role);items.forEach((item=>{item.classList.remove("field-attachment-"+role);item.classList.remove("field-attachment-"+role+"-thumbnails");item.classList.remove("field-attachment-"+role+"-thumbnails-large");item.classList.add(classname)}))}_switchClass(fromClass,toClass,large){Array.from(this.querySelectorAll(".field-attachment-item")).forEach((element=>{element.classList.remove(fromClass);element.classList.add(toClass)}))}showUploadWindow(config={}){createFileUploadWindow({modelId:this.record?.model.id,recordId:this.record?.id,fieldId:this.id,ACL:config.ACL||"private",maxSize:config.maxSize||0})}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.value=this.initialValue=record[this.id]}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){const newValue=updates[this.id];if(newValue){this.value=newValue;this._renderValues();if(this.onchange)this.onchange(newValue)}}}setValue(newValues,rawUpdate){newValues=[].concat(newValues);if(rawUpdate)return this._updateValue(newValues,rawUpdate);if(this.record){this.record.updateFieldDeep(this.id,newValues).then((success=>{if(success){this._updateValue(newValues);this.initialValue=newValues}else{this._updateValue(this.initialValue)}}))}else{this._updateValue(newValues)}return this}clearValue(){this.setValue([]);return this}_updateValue(newValues,rawUpdate){this.value=newValues;this._renderValues();if(this.onchange&&!rawUpdate)this.onchange(newValues);return this}getValue(){return this.value||[]}resetValue(){this.value=[];this._renderValues();return this}getLabel(){return this?.label?.innerText||""}setLabel(newLabel){if(!this.label)return;this.config.label=newLabel;this.label.innerText=newLabel;return this}validate(){return true}_initLayout(){this.layout=localStorage.getItem("config-layout-"+this.id);if(!this.layout)this.layout=this.config.layout||""}_renderValues(){if(this.value==""||this.value==null||this.value=="undefined"||this.value[0]==null||this.value[0]==""){this.fieldValues.innerHTML="";this.fieldValues.style.display="none";this.layoutButtons.style.display="none";if(this.uploadButton)this.uploadButton.style.display="inline-flex";return}if(!Array.isArray(this.value))this.value=[this.value];this.fieldValues.innerHTML=this.value.map(((file,i)=>this._renderValue(file,i))).join("");this.fieldValues.style.display="flex";if(this.config.allowLayout!==false){this.layoutButtons.style.display="inline-block"}else{this.layoutButtons.style.display="none"}if(this.multiple===false&&this.getValue().length>0)this.uploadButton.style.display="none";kiss.session.setupDownloadLink(...this.fieldValues.querySelectorAll("a[download]"));kiss.session.setupImg(...this.fieldValues.querySelectorAll("img"))}_renderValue(file,i){if(!file.path)return"";const isPublic=file.accessReaders&&Array.isArray(file.accessReaders)&&file.accessReaders.includes("*");const isOffline=kiss.session.isOffline();const lockIcon=isPublic?"fas fa-lock-open":"fas fa-lock";const layout=this.layout.includes("thumbnails")?"-"+this.layout:"";let preview;let filePath=kiss.tools.createFileURL(file);let fileThumbnail=kiss.tools.createFileURL(file,"m");const fileExtension=file.path.split(".").pop().toLowerCase();if(["jpg","jpeg","png","gif","webp"].indexOf(fileExtension)!=-1){preview=`<img role="preview" public="${isPublic}" class="field-attachment-preview${layout}" src="${fileThumbnail}" loading="lazy"></img>`}else{const{icon:icon,color:color}=kiss.tools.fileToIcon(fileExtension);preview=`<span role="preview" style="color: ${color}" class="fas ${icon} field-attachment-preview${layout}"></span>`}return`\n                <div role="item" class="field-attachment-item${layout}" id="${file.id}" onclick="this.closest('.a-attachment')._previewAttachment(event)">\n                    <div class="field-attachment-preview-container">${preview}</div>\n                    <span role="filename" class="field-attachment-filename${layout}">${file.filename}</span>\n                    <span class="field-attachment-buttons">\n                        <span class="field-attachment-filesize">${file.size.toFileSize()}</span>\n                        <span style="flex:1"></span>\n                        ${this.readOnly||isOffline?"":`<span class="field-attachment-delete fas fa-trash" index="${i}" onclick="$('${this.id}')._deleteFile(event, '${file.id}')"></span>`}\n                        ${this.readOnly||isOffline?"":`<span class="field-attachment-access ${lockIcon}" index="${i}" onclick="$('${this.id}')._switchFileACL(event, '${file.id}')"></span>`}\n                        <a href="${filePath}" download public="${isPublic}" target="_blank"><span class="field-attachment-download far fa-arrow-alt-circle-down"></span></a>\n                    </span>\n                </div>`}_openFileMenu(event,fileId){event.stop();const currentValues=this.getValue();const file=currentValues.get(fileId);const ACL=file.accessReaders.includes("*")?"private":"public";const lockIcon=ACL=="public"?"fas fa-lock-open":"fas fa-lock";createMenu({top:event.clientY-10,left:event.clientX-10,items:[{icon:lockIcon,text:txtTitleCase("#update file ACL",null,{access:txtUpperCase(ACL)}),action:async()=>{const response=await kiss.ajax.request({url:"/updateFileACL",method:"patch",showLoading:true,body:JSON.stringify({modelId:this.modelId,recordId:this.recordId,fieldId:this.id,file:file,ACL:ACL})});if(response.success){const message="<center>"+txtTitleCase("#updating ACL")+"<br><b>"+txtUpperCase(ACL);createNotification({message:message,duration:2e3})}}}]}).render()}_previewAttachment(event){if([...event.target.classList].includes("field-attachment-download"))return;const itemClass=this.layout?".field-attachment-item-"+this.layout:".field-attachment-item";const attachmentId=event.target.closest(itemClass).id;const cellAttachments=this.getValue();if(this.record){createPreviewWindow(cellAttachments,attachmentId,this.record.id,this.id)}else{createPreviewWindow(cellAttachments,attachmentId)}if(this.record){if($("preview-window").panelCustomIcons.children.length>0)return;$("preview-window").addHeaderIcon({hidden:kiss.screen.isMobile&&kiss.screen.isVertical(),icon:"fas fa-columns",tip:txtTitleCase("#preview mode"),action:()=>$("preview-window").switchDisplayMode()})}}async _switchFileACL(event,fileId){event.stop();if(kiss.session.isOffline())return;const currentValues=this.getValue();const file=currentValues.get(fileId);const newACL=file.accessReaders&&Array.isArray(file.accessReaders)&&file.accessReaders.includes("*")?"private":"public";const response=await kiss.ajax.request({url:"/updateFileACL",method:"patch",showLoading:true,body:JSON.stringify({modelId:this.modelId,recordId:this.recordId,fieldId:this.id,file:file,ACL:newACL})});if(response.success){const message="<center>"+txtTitleCase("#updating ACL")+"<br><b>"+txtUpperCase(newACL);createNotification({message:message,duration:2e3})}}_deleteFile(event,fileId){event.stop();if(kiss.session.isOffline())return;createDialog({type:"danger",title:txtTitleCase("deleting a file"),message:txtTitleCase("#warning delete file"),buttonOKPosition:"left",action:async()=>{let currentValues=this.getValue();let newValues=currentValues.removeById(fileId);const fileCollection=kiss.app.collections.file;const loadingId=kiss.loadingSpinner.show();const response=await fileCollection.deleteOne(fileId);if(response.success){this.setValue(newValues)}kiss.loadingSpinner.hide(loadingId)}})}};customElements.define("a-attachment",kiss.ui.Attachment);const createAttachment=config=>document.createElement("a-attachment").init(config);kiss.ui.Checkbox=class Checkbox extends kiss.ui.Component{constructor(){super()}init(config){super.init(config);const id=this.id;config.shape=config.shape||"square";const iconClasses=this.getIconClasses();const defaultIconOn=iconClasses[config.shape]["on"];const defaultIconOff=iconClasses[config.shape]["off"];let isChecked=config.checked||config.value;if(config.record&&config.record[this.id]!==undefined)isChecked=config.record[this.id];this.iconOn=config.iconOn||defaultIconOn;this.iconOff=config.iconOff||defaultIconOff;this.iconColorOn=config.iconColorOn||"#20c933";this.iconColorOff=config.iconColorOff||"#aaaaaa";const defaultIcon=isChecked==true?this.iconOn:this.iconOff;const defaultIconColor=isChecked==true?this.iconColorOn:this.iconColorOff;this.readOnly=!!config.readOnly||!!config.computed;if(this.readOnly)config.disabled=true;this.innerHTML=`${config.label?`<label id="field-label-${id}" for="${id}" class="field-label">\n                    ${this.isLocked()?this.locker:""}\n                    ${config.label||""}\n                    ${this.isRequired()?this.asterisk:""}\n                </label>`:""}\n\n                <span id="" style="color: ${defaultIconColor}" class="field-checkbox-icon ${defaultIcon} ${this.readOnly?"field-checkbox-read-only":""}"></span>\n                <input type="checkbox" id="${id}" name="${id}" ${isChecked?`checked="${isChecked}"`:""} class="field-checkbox" ${config.disabled==true?"disabled":""}>\n            `.removeExtraSpaces();this.label=this.querySelector(".field-label");this.field=this.querySelector(".field-checkbox");this.icon=this.querySelector(".field-checkbox-icon");this._setProperties(config,[[["draggable"],[this]],[["width","height","display","margin","padding","flex"],[this.style]],[["value"],[this.field]],[["fieldWidth=width","height=lineHeight","iconSize=fontSize"],[this.icon.style]],[["labelAlign=textAlign","labelFlex=flex","labelFontSize=fontSize","labelFontWeight=fontWeight","labelColor=color"],[this?.label?.style]]]);this.displayMode="flex";this.style.flexFlow="row";if(config.disabled!=true&&!this.readOnly){this.icon.onclick=()=>{this.field.checked=!this.field.checked;this.setValue(this.field.checked)}}if(config.label){if(config.labelWidth)this.setLabelWidth(config.labelWidth);this.config.labelPosition=config.labelPosition||"left";this.setLabelPosition(config.labelPosition);if(config.disabled!=true)this.label.onclick=this.icon.onclick}this.classList.add("a-field");if(config.record)this._bindRecord(config.record);this._renderValues();return this}getIconClasses(){return{check:{on:"far fa-check-square",off:"far fa-square"},square:{on:"far fa-check-square",off:"far fa-square"},circle:{on:"far fa-check-circle",off:"far fa-circle"},switch:{on:"fas fa-toggle-on",off:"fas fa-toggle-off"},star:{on:"fas fa-star",off:"far fa-star"}}}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.field.checked=this.initialValue=record[this.id]}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){const newValue=updates[this.id];if(newValue||newValue===false){this.field.checked=newValue;this._renderValues()}}}_renderValues(){const newState=this.field.checked;const iconAdd=newState==true?this.iconOn:this.iconOff;const iconRemove=newState==true?this.iconOff:this.iconOn;iconRemove.split(" ").forEach((className=>this.icon.classList.remove(className)));iconAdd.split(" ").forEach((className=>this.icon.classList.add(className)));this.icon.style.color=newState==true?this.iconColorOn:this.iconColorOff}setValue(newState,rawUpdate){if(rawUpdate)return this._updateValue(newState,rawUpdate);if(this.record){this.record.updateFieldDeep(this.id,newState).then((success=>{if(success){this._updateValue(newState)}else{this._updateValue(this.initialValue)}}))}else{this._updateValue(newState)}return this}clearValue(){this.setValue(false);return this}_updateValue(newState,rawUpdate){this.field.checked=newState;this._renderValues();if(!rawUpdate)this.dispatchEvent(new Event("change"));return this}getValue(){return this.field.checked}validate(){return true}toggleValue(){this.setValue(!this.getValue())}getLabel(){return this?.label?.innerText||""}setLabel(newLabel){if(!this.label)return;this.config.label=newLabel;this.label.innerText=newLabel;return this}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setFieldWidth(width){this.config.fieldWidth=width;this.icon.style.width=this._computeSize("fieldWidth",width);return this}setLabelWidth(width){this.config.labelWidth=width;this.label.style.minWidth=this.label.style.maxWidth=this._computeSize("labelWidth");return this}getLabelPosition(){return this.config.labelPosition}setLabelPosition(position){this.config.labelPosition=position;switch(position){case"top":this.style.flexFlow="column";this.style.alignItems="unset";this.icon.style.order=1;break;case"bottom":this.style.flexFlow="column";this.style.alignItems="unset";this.icon.style.order=-1;break;case"right":this.style.flexFlow="row";this.style.alignItems="center";this.icon.style.order=-1;break;default:this.style.flexFlow="row";this.style.alignItems="center";this.icon.style.order=1}return this}setColor(color){this.icon.style.color=color}};customElements.define("a-checkbox",kiss.ui.Checkbox);const createCheckbox=config=>document.createElement("a-checkbox").init(config);kiss.ui.Color=class Color extends kiss.ui.Component{constructor(){super()}init(config){super.init(config);if(config.record&&config.record[this.id])config.value=config.record[this.id];const id=this.id;this.value=config.value||"";this.required=!!config.required;this.readOnly=!!config.readOnly;this.innerHTML=`\n            ${config.label?`<label id="field-label-${this.id}" for="${this.id}" class="field-label">\n                ${this.isLocked()?this.locker:""}\n                ${config.label||""}\n                 ${this.isRequired()?this.asterisk:""}\n            </label>`:""}\n\n            <div class="field-color-container ${config.palette!="default"?" field-color-container-custom ":" field-color-container-standard "} ${config.readOnly?"field-input-read-only":""}">\n                ${config.palette!="default"?`<div class="field-color-palette field-color-palette-custom" style="background-color: ${this.value.trim()}"></div>`:`<input class="field-color-palette field-color-palette-standard" type="color" value=${this.value}>`}\n                ${!config.hideCode?`<input type="text" autocomplete="off" ${this.readOnly?" readonly ":""} class="field-color-input" value="${this.value}"></input>`:""}\n            </div>\n            `.removeExtraSpaces();this.label=this.querySelector(".field-label");this.fieldContainer=this.querySelector(".field-color-container");this.color=this.querySelector(".field-color-palette");this.field=this.querySelector(".field-color-input");if(config.hideCode==true)this.color.style.width=this.color.style.height="100%";this._setProperties(config,[[["draggable"],[this]],[["width","height","flex","display","margin","padding"],[this.style]],[["fieldWidth=width","fieldHeight=height","fieldFlex=flex","border","borderStyle","borderWidth","borderColor","borderRadius","boxShadow"],[this.fieldContainer.style]],[["labelWidth=width","labelAlign=textAlign","labelFlex=flex","labelFontSize=fontSize","labelFontWeight=fontWeight","labelColor=color"],[this.label?.style]],[["borderRadius","colorWidth=minWidth","colorHeight=minHeight"],[this.color.style]]]);this.displayMode="flex";this.style.flexFlow="row";if(config.label){if(config.labelWidth)this.setLabelWidth(config.labelWidth);this.config.labelPosition=config.labelPosition||"left";this.setLabelPosition(config.labelPosition)}if(!this.readOnly&&!config.disabled&&!config.computed&&config.palette!="default"){this.onclick=event=>{const clickedElement=event.target.closest(".field-color-container");if(!clickedElement)return;const picker=createPanel({modal:true,backdropFilter:true,header:false,width:"70.5rem",align:"center",verticalAlign:"center",zIndex:1e3,items:[{type:"colorPicker",value:$(id).getValue(),palette:config.palette||kiss.global.palette,selectorBorderRadius:"3.2rem",height:"10rem",events:{change:function(){let color=this.getValue();$(id).setValue(color);picker.close()}}}]}).render()}}if(this.field){this.field.onchange=event=>{let color=event.target.value;$(id).setValue(color)}}if(config.palette=="default"){if(this.readOnly)this.color.onclick=event=>{event.stop()};this.color.onchange=event=>{let color=event.target.value;$(id).setValue(color)}}if(config.record)this._bindRecord(config.record);this._renderValues();return this}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.value=this.initialValue=record[this.id]}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){this.value=updates[this.id];this._renderValues()}}setValue(color,rawUpdate){if(color==this.getValue())return;if(rawUpdate)return this._updateValue(color,rawUpdate);if(this.record){this.record.updateFieldDeep(this.id,color).then((success=>{if(success){this._updateValue(color);this.initialValue=color}else{this._updateValue(this.initialValue)}}))}else{this._updateValue(color)}this.validate();if(this.config.palette=="default"){this.color.value=color}return this}clearValue(){this.setValue("");return this}_updateValue(color,rawUpdate){this.value=color;this._renderValues();if(!rawUpdate)this.dispatchEvent(new Event("change"));return this}validate(){if(this.isHidden())return true;const isValid=kiss.tools.validateValue(this.type,this.config,this.value);if(isValid){this.setValid()}else{this.setInvalid()}return isValid}setValid(){this.isValid=true;this.fieldContainer.classList.remove("field-input-invalid");return this}setInvalid(){log("kiss.ui - field.setInvalid - Invalid value for the field: "+this.config.label,4);this.isValid=false;this.fieldContainer.classList.add("field-input-invalid");return this}_renderValues(){const color=this.value||"";if(this.field)this.field.value=color;this.color.style.background=color=="#TRANSPARENT"?"transparent":color}getValue(){return this.value}setLabel(newLabel){if(!this.label)return;this.config.label=newLabel;this.label.innerText=newLabel;return this}getLabel(){return this?.label?.innerText||""}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setFieldWidth(width){this.config.fieldWidth=width;this.fieldContainer.style.width=this._computeSize("fieldWidth",width);return this}setLabelWidth(width){this.config.labelWidth=width;this.label.style.minWidth=this.label.style.maxWidth=this._computeSize("labelWidth",width);return this}getLabelPosition(){return this.config.labelPosition}setLabelPosition(position){this.config.labelPosition=position;switch(position){case"top":this.style.flexFlow="column";this.fieldContainer.style.order=1;break;case"bottom":this.style.flexFlow="column";this.fieldContainer.style.order=-1;break;case"right":this.style.flexFlow="row";this.fieldContainer.style.order=-1;break;default:this.style.flexFlow="row";this.fieldContainer.style.order=1}return this}};customElements.define("a-color",kiss.ui.Color);const createColorField=config=>document.createElement("a-color").init(config);kiss.ui.ColorPicker=class ColorPicker extends kiss.ui.Component{constructor(){super()}init(config={}){super.init(config);if(config.record&&config.record[this.id])config.value=config.record[this.id];this.value=config.value;this.icon=config.icon||"fas fa-check";this.iconSize=config.iconSize||"1.6rem";this.selectorSize=config.selectorSize||"3.2rem";this.selectorBorderRadius=config.selectorBorderRadius||"0.5rem";this.columns=config.columns||1e4;this.palette=config.palette||kiss.global.palette;this.autoFocus=config.autoFocus;if(config.record)this._bindRecord(config.record);this.specialId=this.id.replace(new RegExp("-","g"),"_");this.innerHTML=this.palette.map(((color,index)=>`<span id="${this.specialId}:color-#${color}"\n                    class="color-selector"\n                    style=\n                    "\n                        width: ${this.selectorSize};\n                        height: ${this.selectorSize};\n                        line-height: ${this.selectorSize};\n                        font-size: ${this.iconSize};\n                        background-color: #${color};\n                        border-radius: ${this.selectorBorderRadius};\n                    "\n                >\n                ${this.value=="#"+color.toUpperCase()?`<span style="color: #ffffff" class="${this.icon} color-selector-selected"></span>`:""}                \n                </span>${(index+1)%this.columns==0?"<br>":""}`.removeExtraSpaces())).join("");this._setProperties(config,[[["width","minWidth","maxWidth","height","minHeight","maxHeight","margin","padding"],[this.style]]]);this.displayMode="inline-block";this.onclick=event=>{const colorPicker=event.target.closest(".color-selector");if(!colorPicker)return;const color=colorPicker.id.split("-")[1];this.setValue(color);if(config.action)config.action(color)};return this}_afterRender(){if(!this.autoFocus)return;setTimeout((()=>this.focus()),500)}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.value=this.initialValue=record[this.id]}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){this.value=updates[this.id];this._renderValues()}}setValue(color,rawUpdate){if(color.toUpperCase()==this.getValue())return;if(rawUpdate)return this._updateValue(color,rawUpdate);if(this.record){this.record.updateFieldDeep(this.id,color).then((success=>{if(success){this._updateValue(color);this.initialValue=color}else{this._updateValue(this.initialValue)}}))}else{this._updateValue(color)}return this}clearValue(){this.setValue("");return this}_updateValue(color,rawUpdate){this.value=color;this._renderValues();if(!rawUpdate)this.dispatchEvent(new Event("change"));return this}_renderValues(){const color=(this.value||"").toUpperCase();Array.from(this.children).forEach((colorSelector=>{colorSelector.classList.remove("color-selector-selected");colorSelector.innerHTML=""}));let selectedColor=$(this.specialId+":color-"+color);if(!selectedColor)return;selectedColor.innerHTML=`<span style="color: #ffffff" class="${this.icon}"></span>`;selectedColor.classList.add("color-selector-selected")}getValue(){return(this.value||"").toUpperCase()}validate(){return true}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setHeight(height){this.config.height=height;this.style.height=this._computeSize("height",height);return this}focus(){const selectedColor=this.querySelector(".color-selector-selected");if(!selectedColor)return;if(selectedColor)setTimeout((()=>{selectedColor.scrollIntoView({block:"center",behavior:"smooth"})}),1);return this}};customElements.define("a-colorpicker",kiss.ui.ColorPicker);const createColorPicker=config=>document.createElement("a-colorpicker").init(config);kiss.ui.Field=class Field extends kiss.ui.Component{constructor(){super()}init(config){super.init(config);const id=this.id;if(config.record)config.value=config.record[this.id];config.readOnly=!!config.readOnly||!!config.computed;if(this.type!="textarea"&&this.type!="aiTextarea"){this.innerHTML=`\n                ${config.label?`<label id="field-label-${id}" for="${id}" class="field-label">\n                    ${this.isLocked()?this.locker:""}\n                    ${config.label||""} ${config.unit?" ("+config.unit+")":""}\n                    ${this.isRequired()?this.asterisk:""}\n                </label>`:""}\n\n                <input type="${this.type}" id="field-input-${id}" name="${id}" class="field-input ${!!config.readOnly?"field-input-read-only":""}">\n                `.removeExtraSpaces()}else{this.innerHTML=`\n                ${config.label?`<label id="field-label-${id}" for="${id}" class="field-label">\n                    ${this.isLocked()?this.locker:""}\n                    ${config.label||""}\n                    ${this.isRequired()?this.asterisk:""}\n                </label>`:""}\n\n                <textarea id="field-textarea-${id}" name="${id}" class="field-input field-input-textarea ${!!config.readOnly?"field-input-read-only":""}"\n                    ${config.rows?`rows="${config.rows}"`:""}\n                    ${config.cols?`cols="${config.cols}"`:""}\n                >${config.value?config.value:""}</textarea>\n                `.removeExtraSpaces()}this.field=this.querySelector(".field-input");this.label=this.querySelector(".field-label");if(config.max==0)delete config.max;if(config.maxLength==0)delete config.maxLength;this._setProperties(config,[[["draggable"],[this]],[["width","minWidth","height","flex","display","margin","padding","overflow"],[this.style]],[["value","minLength","maxLength","min","max","placeholder","readOnly","disabled","required","autocomplete"],[this.field]],[["color","textAlign","fontSize","fontWeight","lineHeight","fieldWidth=width","fieldHeight=height","fieldPadding=padding","fieldFlex=flex","maxHeight","fontFamily","border","borderStyle","borderWidth","borderColor","borderRadius","boxShadow"],[this.field.style]],[["labelColor=color","labelFontSize=fontSize","labelFontWeight=fontWeight","labelAlign=textAlign","labelFlex=flex"],[this.label?.style]]]);this.displayMode="flex";this.style.flexFlow="row";if(config.label){if(config.labelWidth)this.setLabelWidth(config.labelWidth);this.config.labelPosition=config.labelPosition||"left";this.setLabelPosition(config.labelPosition)}this.classList.add("a-field");this.field.onchange=event=>{const newValue=event.target.value;if(this.validate()){this.setValue(newValue)}};if(config.events){if(config.events.focus)this.field.onfocus=config.events.focus;else if(config.events.onfocus)this.field.onfocus=config.events.onfocus;if(config.events.blur)this.field.onblur=config.events.blur;else if(config.events.onblur)this.field.onblur=config.events.onblur}if(config.type=="number"){this.field.onkeydown=event=>{if(event.key=="ArrowDown"||event.key=="ArrowUp")event.stop()}}else if(config.type=="textarea"&&config.autoGrow){this._initTextareaHeight()}else if(config.type=="text"&&config.computed==true){this.field.onclick=()=>{const value=this.getValue();const urlRegex=new RegExp(`^(http(s?):\\/)?\\/(.)+$`);if(value&&value.match(urlRegex))window.open(value)}}this._initMobileAutoCompose();this.isValid=true;this._initValidationRules();if(config.record)this._bindRecord(config.record);return this}_initMobileAutoCompose(){if(!kiss.screen.isMobile)return;if(!this.label)return;if(this.config.type!="text"&&this.config.type!="number")return;const phoneLabels=["telephone","phone","mobile","tel."];if(!phoneLabels.some((phoneLabel=>this.config.label.toLowerCase().includes(phoneLabel))))return;this.label.onmousedown=()=>window.location.href="tel:"+this.getValue()}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.field.value=this.initialValue=record[this.id]}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){const newValue=updates[this.id];if(newValue||newValue===0||newValue===""){this.field.value=newValue}}}_initValidationRules(){this.required=this.config.required;this.validationRegex=this.config.validationRegex;this.validationType=this.config.validationType;this.validationFormula=this.config.validationFormula;this.field.onkeyup=()=>{this.validate();if(this.config.type=="textarea"&&this.config.autoGrow){this._updateTextareaHeight()}};if(this.required&&this.field.value=="")this.isValid=false}_initTextareaHeight(){this._afterRender=()=>this._updateTextareaHeight()}_updateTextareaHeight(){this.field.style.height=this.field.scrollHeight+"px"}validate(){if(this.isHidden())return true;const isValid=kiss.tools.validateValue(this.type,this.config,this.field.value);if(isValid){this.setValid()}else{this.setInvalid()}return isValid}setValue(newValue,rawUpdate){if(rawUpdate){this.field.value=newValue;return this}if(this.getDataType()=="number"&&newValue!=="")newValue=Number(newValue);if(this.record){this.record.updateFieldDeep(this.id,newValue).then((success=>{if(!success){this.field.value=this.initialValue||""}else{this.initialValue=newValue}}))}else{this.field.value=newValue}if(this.type=="textarea")this.field.scrollTop=this.field.scrollHeight;return this}select(){this.field.select();return this}clearValue(){this.setValue("");return this}getValue(){const fieldType=this.getDataType();if(fieldType=="number"){return Number(this.field.value)}else{return this.field.value||""}}getDataType(){if(this.type=="summary")return this.config.summary.type;if(this.type=="lookup")return this.config.lookup.type;if(this.type=="textarea")return"text";if(this.type=="password")return"text";return this.type}setLabel(newLabel){if(!this.label)return;this.config.label=newLabel;this.label.innerText=newLabel;return this}getLabel(){return this?.label?.innerText||""}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setFieldWidth(width){this.config.fieldWidth=width;this.field.style.width=this._computeSize("fieldWidth",width);return this}setLabelWidth(width){this.config.labelWidth=width;this.label.style.minWidth=this.label.style.maxWidth=this._computeSize("labelWidth",width);return this}getLabelPosition(){return this.config.labelPosition}setLabelPosition(position){this.config.labelPosition=position;switch(position){case"top":this.style.flexFlow="column";this.field.style.order=1;break;case"bottom":this.style.flexFlow="column";this.field.style.order=-1;break;case"right":this.style.flexFlow="row wrap";this.field.style.order=-1;break;default:this.style.flexFlow="row wrap";this.field.style.order=1}return this}setDisplayMode(displayMode="flex"){this.config.display=this.style.display=displayMode}focus(){this.field.focus();return this}blur(){this.field.blur();return this}resetFocus(){this.blur();setTimeout((()=>this.focus()),100)}setValid(){this.isValid=true;this.field.classList.remove("field-input-invalid");return this}setInvalid(){log("kiss.ui - field.setInvalid - Invalid value for the field: "+this.config.label,4);this.isValid=false;this.field.classList.add("field-input-invalid");return this}};customElements.define("a-field",kiss.ui.Field);const createField=config=>document.createElement("a-field").init(config);const createTextField=config=>document.createElement("a-field").init(Object.assign(config,{type:"text"}));const createTextareaField=config=>document.createElement("a-field").init(Object.assign(config,{type:"textarea"}));const createNumberField=config=>document.createElement("a-field").init(Object.assign(config,{type:"number"}));const createDateField=config=>document.createElement("a-field").init(Object.assign(config,{type:"date"}));const createPasswordField=config=>document.createElement("a-field").init(Object.assign(config,{type:"password"}));kiss.ui.Icon=class Icon extends kiss.ui.Component{constructor(){super()}init(config){super.init(config);if(config.record&&config.record[this.id])config.value=config.record[this.id];const id=this.id;this.value=config.value||"";this.required=!!config.required;this.innerHTML=`${config.label?`<label id="field-label-${this.id}" for="${this.id}" class="field-label">\n                ${this.isLocked()?this.locker:""}\n                ${config.label||""}\n                ${this.isRequired()?this.asterisk:""}\n            </label>`:""}\n\n            <div class="field-icon-container ${config.readOnly?"field-input-read-only":""}">\n                <div class="field-icon-palette ${this.value}"></div>\n                ${!config.hideCode?`<input type="text" autocomplete="off" readonly class="field-icon-input" value="${this.value}"></input>`:""}\n            </div>                \n            `.removeExtraSpaces();this.label=this.querySelector(".field-label");this.fieldContainer=this.querySelector(".field-icon-container");this.icon=this.querySelector(".field-icon-palette");this.field=this.querySelector(".field-icon-input");if(config.hideCode==true)this.icon.style.width=this.icon.style.height="100%";this._setProperties(config,[[["draggable"],[this]],[["width","height","flex","display","margin","padding"],[this.style]],[["fieldWidth=width","fieldHeight=height","fieldFlex=flex","border","borderStyle","borderWidth","borderColor","borderRadius","boxShadow"],[this.fieldContainer.style]],[["labelAlign=textAlign","labelFlex=flex","labelFontSize=fontSize","labelFontWeight=fontWeight","labelColor=color"],[this.label?.style]],[["borderRadius","iconSize=fontSize","iconColor=color","iconBackground=background","iconAlign=textAlign","iconPadding=padding"],[this.icon.style]]]);this.displayMode="flex";this.style.flexFlow="row";if(config.label){if(config.labelWidth)this.setLabelWidth(config.labelWidth);this.config.labelPosition=config.labelPosition||"left";this.setLabelPosition(config.labelPosition)}this.readOnly=!!config.readOnly;if(!this.readOnly&&!config.disabled&&!config.computed){this.onclick=event=>{const clickedElement=event.target.closest(".field-icon-container");if(!clickedElement)return;const picker=createPanel({modal:true,header:false,width:"67.5rem",align:"center",verticalAlign:"center",zIndex:1e3,items:[{type:"iconPicker",value:$(id).getValue(),icons:config.icons||kiss.webfonts.all,selectorBorderRadius:"3.2rem",height:"66rem",maxHeight:"calc(100vh - 10rem)",autoFocus:true,events:{change:function(){let icon=this.getValue();$(id).setValue(icon);picker.close()}}}]}).render()}}if(config.record)this._bindRecord(config.record);this._renderValues();return this}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.value=this.initialValue=record[this.id]}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){this.value=updates[this.id];this._renderValues()}}setValue(icon,rawUpdate){if(icon==this.getValue())return;if(rawUpdate)return this._updateValue(icon,rawUpdate);if(this.record){this.record.updateFieldDeep(this.id,icon).then((success=>{if(success){this._updateValue(icon);this.initialValue=icon}else{this._updateValue(this.initialValue)}}))}else{this._updateValue(icon)}this.validate();return this}clearValue(){this.setValue("");return this}_updateValue(icon,rawUpdate){this.value=icon;this._renderValues();if(!rawUpdate)this.dispatchEvent(new Event("change"));return this}validate(){if(this.isHidden())return true;const isValid=kiss.tools.validateValue(this.type,this.config,this.value);if(isValid){this.setValid()}else{this.setInvalid()}return isValid}setValid(){this.isValid=true;this.fieldContainer.classList.remove("field-input-invalid");return this}setInvalid(){log("kiss.ui - field.setInvalid - Invalid value for the field: "+this.config.label,4);this.isValid=false;this.fieldContainer.classList.add("field-input-invalid");return this}_renderValues(){const icon=this.value||"";if(this.field)this.field.value=icon;this.icon.className="";const classList=icon.split(" ").filter((className=>className!=""));this.icon.classList.add("field-icon-palette",...classList)}getValue(){return this.value}setLabel(newLabel){if(!this.label)return;this.config.label=newLabel;this.label.innerText=newLabel;return this}getLabel(){return this?.label?.innerText||""}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setFieldWidth(width){this.config.fieldWidth=width;this.fieldContainer.style.width=this._computeSize("fieldWidth",width);return this}setLabelWidth(width){this.config.labelWidth=width;this.label.style.minWidth=this.label.style.maxWidth=this._computeSize("labelWidth",width);return this}getLabelPosition(){return this.config.labelPosition}setLabelPosition(position){this.config.labelPosition=position;switch(position){case"top":this.style.flexFlow="column";this.fieldContainer.style.order=1;break;case"bottom":this.style.flexFlow="column";this.fieldContainer.style.order=-1;break;case"right":this.style.flexFlow="row";this.fieldContainer.style.order=-1;break;default:this.style.flexFlow="row";this.fieldContainer.style.order=1}return this}};customElements.define("a-icon",kiss.ui.Icon);const createIconField=config=>document.createElement("a-icon").init(config);kiss.ui.IconPicker=class IconPicker extends kiss.ui.Component{constructor(){super()}init(config={}){super.init(config);if(config.record&&config.record[this.id])config.value=config.record[this.id];this.value=config.value;this.iconSize=config.iconSize||"3.2rem";this.selectorSize=config.selectorSize||"5rem";this.selectorBorderRadius=config.selectorBorderRadius||"0.5rem";this.color=config.color||"var(--body)";this.colorSelected=config.colorSelected||"#ffffff";this.backgroundColor=config.backgroundColor||"var(--body-background)";this.backgroundColorSelected=config.backgroundColorSelected||"#00aaee";this.columns=config.columns||1e4;this.autoFocus=config.autoFocus;if(config.record)this._bindRecord(config.record);this.specialId=this.id.replace(new RegExp("-","g"),"_");let icons=config.icons||kiss.webfonts.all;this.innerHTML=icons.map(((font,index)=>`\n                <span id="${this.specialId}:icon-${font}"\n                    class="icon-selector ${font} ${this.value==font?"icon-selector-selected":""}"\n                    style=\n                    "\n                        width: ${this.selectorSize};\n                        height: ${this.selectorSize};\n                        line-height: ${this.selectorSize};\n                        font-size: ${this.iconSize};\n                        color: ${this.color};\n                        background-color: ${this.value==font?this.backgroundColorSelected:this.backgroundColor};\n                        border-radius: ${this.selectorBorderRadius};\n                    "\n                >\n                </span>${(index+1)%this.columns==0?"<br>":""}`.removeExtraSpaces())).join("");this._setProperties(config,[[["width","minWidth","maxWidth","minHeight","height","maxHeight","margin","padding"],[this.style]]]);this.displayMode="inline-block";this.onclick=event=>{const icon=event.target.closest(".icon-selector");if(!icon)return;const iconClass=icon.classList[1]+" "+icon.classList[2];this.setValue(iconClass);if(config.action)config.action(iconClass)};return this}_afterRender(){if(!this.autoFocus)return;setTimeout((()=>this.focus()),500)}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.value=this.initialValue=record[this.id]}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){this.value=updates[this.id];this._renderValues()}}setValue(iconClass,newBackgroundColor,rawUpdate){if(iconClass==this.getValue())return;if(newBackgroundColor===true)rawUpdate=true;if(rawUpdate)return this._updateValue(iconClass,newBackgroundColor,rawUpdate);if(this.record){this.record.updateFieldDeep(this.id,iconClass).then((success=>{if(success){this._updateValue(iconClass,newBackgroundColor);this.initialValue=iconClass}else{this._updateValue(this.initialValue,this.backgroundColorSelected)}}))}else{this._updateValue(iconClass,newBackgroundColor)}return this}clearValue(){this.setValue("");return this}_updateValue(iconClass,newBackgroundColor,rawUpdate){this.value=iconClass;if(newBackgroundColor)this.backgroundColorSelected=newBackgroundColor;this._renderValues();if(!rawUpdate)this.dispatchEvent(new Event("change"));return this}_renderValues(){const iconClass=this.value||"";const newBackgroundColor=this.backgroundColorSelected;Array.from(this.children).forEach((icon=>{icon.classList.remove("icon-selector-selected");icon.style.color=this.color;icon.style.backgroundColor=this.backgroundColor}));let icon=$(this.specialId+":icon-"+iconClass);if(!icon)return;icon.classList.add("icon-selector-selected");icon.style.color=this.colorSelected;icon.style.backgroundColor=newBackgroundColor?newBackgroundColor:this.backgroundColorSelected}setColor(newBackgroundColor){const selectedIcon=this.querySelector(".icon-selector-selected");this.backgroundColorSelected=selectedIcon.style.backgroundColor=newBackgroundColor}getValue(){return this.value}validate(){return true}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setHeight(height){this.config.height=height;this.style.height=this._computeSize("height",height);return this}focus(){const selectedIcon=this.querySelector(".icon-selector-selected");if(!selectedIcon)return;selectedIcon.scrollIntoView({block:"center",behavior:"smooth"});return this}};customElements.define("a-iconpicker",kiss.ui.IconPicker);const createIconPicker=config=>document.createElement("a-iconpicker").init(config);kiss.ui.Rating=class Rating extends kiss.ui.Component{constructor(){super()}init(config){super.init(config);const id=this.id;this.value=Number(config.value)||0;this.max=config.max||5;config.shape=config.shape||"star";const iconClasses=this.getIconClasses();this.icon=iconClasses[config.shape];this.iconColorOn=config.iconColorOn||"#ffd139";this.iconColorOff=config.iconColorOff||"#dddddd";this.readOnly=!!config.readOnly||!!config.computed;if(this.readOnly)config.disabled=true;this.innerHTML=`${config.label?`<label id="field-label-${id}" for="${id}" class="field-label">\n                ${this.isLocked()?this.locker:""}\n                ${config.label||""}\n                ${this.isRequired()?this.asterisk:""}\n            </label>`:""}\n            \n            <span class="field-rating"></span>\n            `.removeExtraSpaces();this.label=this.querySelector(".field-label");this.field=this.querySelector(".field-rating");this._setProperties(config,[[["draggable"],[this]],[["width","height","display","margin","padding","flex"],[this.style]],[["labelAlign=textAlign","labelFlex=flex","labelFontSize=fontSize","labelFontWeight=fontWeight","labelColor=color"],[this?.label?.style]],[["iconSize=fontSize"],[this.field]]]);this.displayMode="flex";this.style.flexFlow="row";if(config.disabled!=true&&!this.readOnly){this.field.onclick=event=>{if(event.target.classList.contains("rating")){const index=event.target.getAttribute("index");this.setValue(Number(index)+1)}}}if(config.label){if(config.labelWidth)this.setLabelWidth(config.labelWidth);this.config.labelPosition=config.labelPosition||"left";this.setLabelPosition(config.labelPosition);if(config.disabled!=true)this.label.onclick=this.field.onclick}if(config.record)this._bindRecord(config.record);this._renderValues();return this}getIconClasses(){return{star:"fas fa-star",heart:"fas fa-heart",thumb:"fas fa-thumbs-up"}}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.value=this.initialValue=record[this.id]}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){const newValue=updates[this.id];if(newValue||newValue===false){this.value=newValue;this._renderValues()}}}_renderValues(){let html="";for(let i=0;i<this.max;i++){const color=i<this.value?this.iconColorOn:this.iconColorOff;html+=`<span class="rating ${this.icon}" style="color: ${color}" index=${i}></span>`}this.field.innerHTML=html}setValue(newValue,rawUpdate){newValue=Number(newValue);if(newValue==this.value)return this;if(rawUpdate)return this._updateValue(newValue,rawUpdate);if(this.record){this.record.updateFieldDeep(this.id,newValue).then((success=>{if(success){this._updateValue(newValue);this.initialValue=newValue}else{this._updateValue(this.initialValue)}}))}else{this._updateValue(newValue)}return this}clearValue(){this.setValue(0);return this}_updateValue(newValue,rawUpdate){this.value=newValue;this._renderValues();this.setValid();if(!rawUpdate)this.dispatchEvent(new Event("change"));return this}getValue(){return Number(this.value)}validate(){if(this.isHidden())return true;const isValid=kiss.tools.validateValue(this.type,this.config,this.value);if(isValid){this.setValid()}else{this.setInvalid()}return isValid}setValid(){this.isValid=true;this.field.classList.remove("field-input-invalid");return this}setInvalid(){log("kiss.ui - field.setInvalid - Invalid value for the field: "+this.config.label,4);this.isValid=false;this.field.classList.add("field-input-invalid");return this}getLabel(){return this?.label?.innerText||""}setLabel(newLabel){if(!this.label)return;this.config.label=newLabel;this.label.innerText=newLabel;return this}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setFieldWidth(width){this.config.fieldWidth=width;this.field.style.width=this._computeSize("fieldWidth",width);return this}setLabelWidth(width){this.config.labelWidth=width;this.label.style.minWidth=this.label.style.maxWidth=this._computeSize("labelWidth");return this}getLabelPosition(){return this.config.labelPosition}setLabelPosition(position){this.config.labelPosition=position;switch(position){case"top":this.style.flexFlow="column";this.style.alignItems="unset";this.field.style.order=1;break;case"bottom":this.style.flexFlow="column";this.style.alignItems="unset";this.field.style.order=-1;break;case"right":this.style.flexFlow="row";this.style.alignItems="center";this.field.style.order=-1;break;default:this.style.flexFlow="row";this.style.alignItems="center";this.field.style.order=1}return this}};customElements.define("a-rating",kiss.ui.Rating);const createRating=config=>document.createElement("a-rating").init(config);kiss.ui.Select=class Select extends kiss.ui.Component{constructor(){super()}init(config={}){super.init(config);const isMobile=kiss.screen.isMobile;this.optionsColor=config.optionsColor;this.readOnly=!!config.readOnly||!!config.computed;this.disabled=!!config.disabled;this.required=!!config.required;this.placeholder=config.placeholder||"";this.autocomplete=config.autocomplete!="off";this.hideInput=config.hideInput!==false;this.multiple=!!config.multiple;this.inputSeparator=config.inputSeparator||",";this.valueSeparator=config.valueSeparator||",";this.stackValues=!!config.stackValues;this.allowValuesNotInList=!!config.allowValuesNotInList;this.allowDuplicates=!!config.allowDuplicates;this.allowClickToDelete=!!config.allowClickToDelete&&this.readOnly!==true;this.allowSwitchOnOff=!!config.allowSwitchOnOff;if(isMobile)this.allowSwitchOnOff=true;this.displayedOptions=[];this.selectedOption=null;this.optionRenderer=config.optionRenderer||null;this.valueRenderer=config.valueRenderer||null;if(config.record&&config.record[this.id])config.value=config.record[this.id];this.value=Array.isArray(config.value)?config.value.map((val=>val)):config.value;if(this.multiple&&!Array.isArray(this.value))this.value=[].concat(this.value);switch(config.template){case"time":this.options=this._generateTimes(config.min||0,config.max||24,config.interval||60,true);break;case"gmt":case"countries":case"... other templates to come":default:if(config.options&&typeof config.options=="function"){this.options=config.options(config.optionsFilter)}else{let sourceOptions=config.options||[];if(config.optionsTranslations&&kiss.language.currentDynamic&&config.optionsTranslations[kiss.language.currentDynamic]){sourceOptions=sourceOptions.map(((option,index)=>{if(typeof option=="object"){let finalOption={label:config.optionsTranslations[kiss.language.currentDynamic][index].value,value:option.value};if(option.color)finalOption.color=option.color;return finalOption}else{return{label:config.optionsTranslations[kiss.language.currentDynamic][index].value,value:option}}}))}this.options=sourceOptions.map((option=>{if(typeof option=="object")return option;return{value:option}}))}this.options.forEach((option=>{if(option.value&&typeof option.value==="string"&&option.value.includes("|")){const optionConfig=option.value.split("|");option.label=optionConfig[0].trim();option.value=optionConfig[1].trim()}}))}this.lastEnteredValue="";this.innerHTML=`${config.label?`<label id="field-label-${this.id}" for="${this.id}" class="field-label">\n                ${this.isLocked()?this.locker:""}\n                ${config.label||""}\n                ${this.isRequired()?this.asterisk:""}\n            </label>`:""}\n\n            <div class="field-select ${!!config.readOnly?"field-input-read-only":""}">\n                <div class="field-select-values"></div>\n            </div>\n            \n            <div class="field-select-options">\n                ${!isMobile?"":`<span class="a-select-mobile-close-container">\n                        <span class="a-select-mobile-close fas fa-chevron-left"></span>\n                        <span class="field-label">${config.label}</span>\n                    </span>`}\n                <input class="field-select-input" type="text" ${this.autocomplete&&!isMobile?"":`style="display: none"`}>\n                <div class="field-select-options-list"></div>\n            </div>\n            `.removeExtraSpaces();this.label=this.querySelector(".field-label");this.field=this.querySelector(".field-select");this.fieldValues=this.querySelector(".field-select-values");this.fieldInput=this.querySelector(".field-select-input");this.optionsWrapper=this.querySelector(".field-select-options");this.optionsList=this.querySelector(".field-select-options-list");this._setProperties(config,[[["draggable"],[this]],[["width","height","display","margin","padding","flex"],[this.style]],[["value","maxLength","min","max","placeholder","readOnly","disabled","required"],[this.field]],[["fieldWidth=width","minWidth","fieldHeight=height","fieldFlex=flex","boxShadow"],[this.field.style]],[["fieldLabelWidth=width","labelAlign=textAlign","labelFlex=flex","labelFontSize=fontSize","labelFontWeight=fontWeight","labelColor=color"],[this.label?.style]],[["fieldWidth=width","minWidth"],[this.optionsWrapper.style]],[["maxHeight"],[this.optionsList.style]],[["placeholder"],[this.fieldInput]]]);this.displayMode="flex";this.style.flexFlow="column";if(config.label){if(config.labelWidth)this.setLabelWidth(config.labelWidth);this.config.labelPosition=config.labelPosition||"left";this.setLabelPosition(config.labelPosition)}if(!this.readOnly&&!this.disabled){this.onmousedown=function(event){event.stop();let classes=event.target.classList;if(classes.contains("field-select-value-delete"))return this._deleteValueByClick(event);if(classes.contains("field-select-value"))return this._showOptions();if(classes.contains("field-select-values"))return this._showOptions();if(classes.contains("field-select-placeholder"))return this._showOptions();if(classes.contains("field-select"))return this._showOptions();if(classes.contains("field-option"))return this._selectOption(event);if(!isMobile)return;const closeHeader=event.target.closest(".a-select-mobile-close-container");if(closeHeader)return this._hideOptions()}}this.classList.add("a-field");this.field.onmouseleave=event=>{if(!kiss.tools.isEventInElement(event,this.optionsWrapper,10))this._hideOptions()};this.optionsWrapper.onmouseleave=event=>{if(document.activeElement.classList.contains("field-select-input")){if(this.fieldInput.value==""){this._hideOptions()}}else{this._hideOptions()}};this.fieldInput.onblur=event=>{this.fieldInput.value="";this._hideOptions()};if(this.autocomplete!="off"){this._manageKeyboard()}if(config.record)this._bindRecord(config.record);this._renderValues();return this}_renderValues(){let isEmpty=false;if(this.multiple){if(this.value&&Array.isArray(this.value)&&this.value.length==0)isEmpty=true}else{if(this.value===undefined||this.value==="")isEmpty=true}if(isEmpty){this.fieldValues.innerHTML=`<span class="field-select-placeholder">${this.placeholder}</span>`||"";this._adjustSizeAndPosition();return}const mapOptions=new Map(this.options.map((option=>[option.value,option])));const htmlSeparator=this.stackValues?"<br>":"";this.fieldValues.innerHTML=[].concat(this.value).filter((value=>value!==""&&value!==undefined&&value!==null)).map((value=>{let option=mapOptions.get(value);if(!option){option={value:value,color:this.defaultColor}}if(!this.valueRenderer){return`<div class="field-select-value" value="${option.value}" ${option.color||this.optionsColor?`style="background: ${option.color||this.optionsColor}"`:""}>\n                            ${option.label||option.value}\n                            ${this.allowClickToDelete==true?`<span class="field-select-value-delete fas fa-times"></span>`:""}\n                        </div>`.removeExtraSpaces()}else{return this.valueRenderer(option,this.record)}})).join(htmlSeparator);this._adjustSizeAndPosition()}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.value=this.multiple?[].concat(record[this.id]):record[this.id];this.initialValue=this.value}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){const newValue=updates[this.id];if(newValue||newValue===0||newValue===""){this.value=newValue;this._renderValues()}}}setValue(newValue,rawUpdate){if(rawUpdate)return this._updateValue(newValue,rawUpdate);this._updateValue(newValue);if(this.record){this.record.updateFieldDeep(this.id,this.value).then((success=>{if(!success){this._updateValue(this.initialValue)}else{this.initialValue=newValue}}))}this.validate();return this}_updateValue(newValue,rawUpdate){this.value=newValue;if(this.multiple){const values=[].concat([...newValue]);this.value=values.filter((value=>value!=""&&value!=undefined&&value!=null))}this._renderValues();if(!rawUpdate)this.dispatchEvent(new Event("change"));return this}clearValue(){if(this.multiple){this.setValue([])}else{this.setValue("")}return this}async addValue(newValue){if((""+newValue).containsHTML()){return}let nextValue;if(this.multiple){nextValue=[].concat(this.value);let switchOff=false;if(this.allowDuplicates!=true&&this._isDuplicate(newValue)==true){if(!this.allowSwitchOnOff){this._resetInputField();return}switchOff=true}if(switchOff){nextValue.remove(newValue)}else{nextValue.push(newValue)}}else{nextValue=newValue}this.setValue(nextValue);this._resetInputField();this.selectedOption=null;this._hideOptions()}validate(){if(this.isHidden())return true;this.setValid();if(this.config.readOnly)return true;if(this.required&&this.isEmpty())this.setInvalid();return this.isValid}setValid(){this.isValid=true;this.field.classList.remove("field-input-invalid");return this}setInvalid(){log("kiss.ui - field.setInvalid - Invalid value for the field: "+this.config.label,4);this.isValid=false;this.field.classList.add("field-input-invalid");return this}disable(){this.disabledAction=this.onmousedown;this.onmousedown=null}enable(){if(!this.disabledAction)return;this.onmousedown=this.disabledAction}isEmpty(){if(this.multiple&&this.getValue().length==0)return true;if(this.getValue()=="")return true;return false}sort(order="asc"){if(order=="desc")this.value.sort().reverse();else this.value.sort();this._renderValues();return this}sortByLabel(order="asc"){const coef=order=="asc"?1:-1;this.value.sort(((a,b)=>{const optionA=this.options.find((option=>option.value==a));const optionB=this.options.find((option=>option.value==b));if(optionA&&optionA.label&&optionB&&optionB.label)return optionA.label.localeCompare(optionB.label)*coef;return-1}));this._renderValues();return this}getValue(){if(this.multiple){const values=[].concat(this.value);return values.filter((value=>value!=""&&value!=undefined&&value!=null))}else{const value=Array.isArray(this.value)?this.value[0]:this.value;return value==undefined?"":value}}getSelection(){const currentValue=this.getValue();if(Array.isArray(currentValue)){return this.options.filter((option=>currentValue.includes(option.value)))}else{return this.options.find((option=>option.value==currentValue))}}resetValue(){this.value=this.multiple?[]:"";this._renderValues();return this}updateOptions(newOptions){if(!newOptions)return;this.options=newOptions;this.options=this.options.map((option=>{if(typeof option=="object")return option;return{value:option}}));this.optionsList.deepDelete(false);this._createOptions();let currentValues=this.getValue();if(Array.isArray(currentValues)){let currentOptionValues=this.options.map((option=>option.value));let newValue=currentValues.filter((value=>currentOptionValues.indexOf(value)!=-1));this.value=newValue}this._renderValues()}getLabel(){return this?.label?.innerText||""}setLabel(newLabel){if(!this.label)return;this.config.label=newLabel;this.label.innerText=newLabel;return this}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setFieldWidth(width){this.config.fieldWidth=width;this.field.style.width=this._computeSize("fieldWidth",width);return this}setLabelWidth(width){this.config.labelWidth=width;this.label.style.minWidth=this.label.style.maxWidth=this._computeSize("labelWidth",width);return this}getLabelPosition(){return this.config.labelPosition}setLabelPosition(position){this.config.labelPosition=position;switch(position){case"top":this.style.flexFlow="column";this.field.style.order=1;break;case"bottom":this.style.flexFlow="column";this.field.style.order=-1;break;case"right":this.style.flexFlow="row";this.field.style.order=-1;break;default:this.style.flexFlow="row";this.field.style.order=1}return this}setMultiple(state=true){this.config.multiple=state;this.multiple=state}setClickToDelete(state=true){this.config.allowClickToDelete=state;this.allowClickToDelete=state}focus(){this.fieldInput.focus();return this}_manageKeyboard(){this.fieldInput.onkeydown=event=>{if(event.key=="Enter")event.preventDefault()};this.fieldInput.onkeyup=event=>{event.stop();let enteredValue=event.target.value;if(event.which==40){this._navigateOptions("down");return}if(event.which==38){this._navigateOptions("up");return}if(event.key=="Backspace"){if(this.lastEnteredValue==""&&this.value&&this.value.length>0){this.lastEnteredValue=enteredValue;let lastValue=this.value[this.value.length-1];this._deleteValue(lastValue);return}}if(event.key=="Enter"||event.key==this.inputSeparator){if(this.selectedOption!=null){this._addValueFromOption(this.selectedOption)}else{let newValue=event.key=="Enter"?enteredValue:enteredValue.slice(0,enteredValue.length-1);if(newValue!=""){if(!this.allowValuesNotInList){let checkedValue=this._findValue(newValue);if(!checkedValue){this._resetInputField();return}this.addValue(checkedValue)}else{this.addValue(newValue)}}}return}this._showOptions(enteredValue);this.lastEnteredValue=enteredValue}}_findValue(value){let option=this.options.find((option=>option.value.toLowerCase()==value.toLowerCase()));return option?option.value:null}async _createOptions(){for(let index=0,length=this.options.length;index<length;index++){let option=this.options[index];let optionElement=document.createElement("div");optionElement.className="field-option";optionElement.setAttribute("value",option.value);optionElement.setAttribute("index",index);if(option.label)optionElement.setAttribute("label",option.label);if(option.color)optionElement.setAttribute("style","border-color:"+option.color);if(option.disabled==true)optionElement.classList.add("field-option-disabled");if(this.optionRenderer){optionElement.innerHTML=this.optionRenderer(option)}else{optionElement.textContent=option.label||option.value}this.optionsList.append(optionElement)}this.displayedOptions=Array.from(this.optionsList.children)}_showOptions(enteredValue){if(this.optionsList.children.length==0)this._createOptions();this.optionsWrapper.style.position="fixed";setTimeout((()=>{this.optionsWrapper.style.display="block";if(this.fieldInput){this.fieldInput.placeholder="";this.fieldInput.focus()}this._filterOptions(enteredValue||"");this._adjustSizeAndPosition()}),100);this.optionsList.onmousewheel=event=>{event.preventDefault();const direction=event.deltaY<0?-1:1;this.optionsList.scrollTop+=direction*50}}_adjustSizeAndPosition(){if(kiss.screen.isMobile){this.optionsWrapper.style.top="1rem";this.optionsWrapper.style.left="1rem";this.optionsWrapper.style.width="calc(100% - 2rem)";this.optionsWrapper.style.height="calc(100% - 2rem)";return}this.optionsWrapper.style.top=this.field.getBoundingClientRect().top+this.field.clientHeight+4+"px";this.optionsWrapper.style.left=this.field.getBoundingClientRect().left+"px";this.optionsWrapper.style.width=this.field.getBoundingClientRect().width+"px";if(this.config.maxHeight){this.optionsWrapper.style.maxHeight=Math.min(this.config.maxHeight,kiss.screen.current.height-20)+"px";this.optionsList.style.maxHeight=Math.min(this.config.maxHeight-55,kiss.screen.current.height-55)+"px"}else{this.optionsWrapper.style.maxHeight=kiss.screen.current.height-20+"px";this.optionsList.style.maxHeight=kiss.screen.current.height-55+"px"}kiss.tools.moveToViewport(this.optionsWrapper)}_hideOptions(){this.optionsWrapper.style.display="none"}_resetInputField(){this.fieldInput.value="";this.fieldInput.focus()}_filterOptions(enteredValue){this.displayedOptions=[];let searchExpression=enteredValue.toLowerCase();let propertyToSearch=this.optionsList.firstChild&&this.optionsList.firstChild.getAttribute("label")?"label":"value";Array.from(this.optionsList.children).forEach((option=>{option.classList.remove("field-option-selected");option.classList.remove("field-option-highlight");if(!option.getAttribute(propertyToSearch).toLowerCase().includes(searchExpression)){option.classList.add("field-option-hidden");return}option.classList.remove("field-option-hidden");const optionValue=option.getAttribute("value");if(this.value&&(this.multiple&&this.value.includes(optionValue)||this.value==optionValue))option.classList.add("field-option-selected");this.displayedOptions.push(option)}));this.selectedOption=null;if(this.displayedOptions.length!=0){this.selectedOption=this.displayedOptions[0];this._highlightOption(this.displayedOptions[0],true)}}_navigateOptions(direction){let currentSelectedOption=this.selectedOption;let index=Array.from(this.displayedOptions).findIndex((node=>node==currentSelectedOption));let nextIndex=direction=="down"?Math.min(index+1,this.displayedOptions.length):Math.max(index-1,0);let newSelectedOption=this.displayedOptions[nextIndex];if(newSelectedOption)this._highlightOption(newSelectedOption,true)}_highlightOption(selectedOption,scroll){if(this.selectedOption)this.selectedOption.classList.remove("field-option-highlight");selectedOption.classList.add("field-option-highlight");this.selectedOption=selectedOption}_selectOption(event,scroll){let newSelectedOption=event.target.closest("div");this.selectedOption=newSelectedOption;this._addValueFromOption(newSelectedOption)}_addValueFromOption(selectedOption){const optionIndex=selectedOption.getAttribute("index");if(!optionIndex)return;const option=this.options[optionIndex];this.addValue(option.value)}_isDuplicate(newValue){return this.value.includes(newValue)}_deleteValueByClick(event){this._hideOptions();let fieldValueElement=event.target.closest("div");let clickedValue=fieldValueElement.getAttribute("value");this._deleteValue(clickedValue);event.stop()}_deleteValue(valueToDelete){let newValue;if(Array.isArray(this.value)){newValue=this.value.filter((value=>value.replace(/\s+/g," ")!=valueToDelete))}else newValue="";this.setValue(newValue)}_generateTimes(from=0,to=24,step=60,colored){from=from<0||from>23?0:from;to=to<=0||to>24?24:to;step=step<=0||step>60?60:step;if(to<=from){from=0;to=24;step=60}const colors={night:"#555555",morning:"#0075FF",midday:"#FFAA00",afternoon:"#87BFFF",dawn:"#8833EE"};const times=[];for(let h=from*60;h<=to*60&&h<1440;h+=step){let value;const hourValue=Math.floor(h/60);const hour=("0"+hourValue).slice(-2);const minutes=("0"+Math.round(h%60)).slice(-2);if(colored){let color;if(hourValue<5)color=colors.night;else if(hourValue<12)color=colors.morning;else if(hourValue<14)color=colors.midday;else if(hourValue<18)color=colors.afternoon;else if(hourValue<20)color=colors.dawn;else color=colors.night;value={value:hour+":"+minutes,color:color}}else{value=hour+":"+minutes}times.push(value)}return times}};customElements.define("a-select",kiss.ui.Select);const createSelect=config=>document.createElement("a-select").init(config);kiss.ui.Slider=class Slider extends kiss.ui.Component{constructor(){super()}init(config){super.init(config);const id=this.id;this.value=Number(config.value)||0;this.min=Number(config.min)||0;this.max=Number(config.max)||100;this.step=Number(config.step)||5;this.readOnly=!!config.readOnly||!!config.computed;if(this.readOnly){this.disabled=true;config.disabled=true}this.innerHTML=`${config.label?`<label id="field-label-${id}" for="${id}" class="field-label">\n                ${this.isLocked()?this.locker:""}\n                ${config.label||""} ${config.unit?" ("+config.unit+")":""}\n                ${this.isRequired()?this.asterisk:""}\n            </label>`:""}\n\n            <span class="field-slider-container">\n                <input class="field-slider" type="range" value="${this.value}" min="${this.min}" max="${this.max}" step="${this.step}" ${this.disabled?"disabled":""}>\n                <span class="field-slider-value">${this.value}</span>\n            </span>\n            `.removeExtraSpaces();this.label=this.querySelector(".field-label");this.field=this.querySelector(".field-slider");this.sliderValue=this.querySelector(".field-slider-value");this._setProperties(config,[[["draggable"],[this]],[["width","height","display","margin","padding","flex"],[this.style]],[["labelAlign=textAlign","labelFlex=flex","labelFontSize=fontSize","labelFontWeight=fontWeight","labelColor=color"],[this?.label?.style]]]);this.displayMode="flex";this.style.flexFlow="row";if(config.disabled!=true&&!this.readOnly){this.field.onchange=event=>this.setValue(Number(event.target.value));this.field.oninput=event=>this.sliderValue.innerHTML=event.target.value}if(config.label){if(config.labelWidth)this.setLabelWidth(config.labelWidth);this.config.labelPosition=config.labelPosition||"left";this.setLabelPosition(config.labelPosition);if(config.disabled!=true)this.label.onclick=this.field.onclick}if(config.record)this._bindRecord(config.record);this._renderValues();return this}getIconClasses(){return{star:"fas fa-star",heart:"fas fa-heart",thumb:"fas fa-thumbs-up"}}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.value=this.initialValue=record[this.id]}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){const newValue=updates[this.id];if(newValue||newValue===false){this.value=newValue;this._renderValues()}}}_renderValues(){this.field.value=this.sliderValue.innerHTML=this.value;return this}setValue(newValue,rawUpdate){newValue=Number(newValue);if(newValue==this.value)return this;if(rawUpdate)return this._updateValue(newValue,rawUpdate);if(this.record){this.record.updateFieldDeep(this.id,newValue).then((success=>{if(success){this._updateValue(newValue);this.initialValue=newValue}else{this._updateValue(this.initialValue)}}))}else{this._updateValue(newValue)}return this}clearValue(){this.setValue(0);return this}_updateValue(newValue,rawUpdate){this.value=newValue;this._renderValues();this.setValid();if(!rawUpdate)this.dispatchEvent(new Event("change"));return this}getValue(){return Number(this.value)}validate(){if(this.isHidden())return true;const isValid=kiss.tools.validateValue(this.type,this.config,this.value);if(isValid){this.setValid()}else{this.setInvalid()}return isValid}setValid(){this.isValid=true;this.field.classList.remove("field-input-invalid");return this}setInvalid(){log("kiss.ui - field.setInvalid - Invalid value for the field: "+this.config.label,4);this.isValid=false;this.field.classList.add("field-input-invalid");return this}getLabel(){return this?.label?.innerText||""}setLabel(newLabel){if(!this.label)return;this.config.label=newLabel;this.label.innerText=newLabel;return this}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setFieldWidth(width){this.config.fieldWidth=width;this.field.style.width=this._computeSize("fieldWidth",width);return this}setLabelWidth(width){this.config.labelWidth=width;this.label.style.minWidth=this.label.style.maxWidth=this._computeSize("labelWidth");return this}getLabelPosition(){return this.config.labelPosition}setLabelPosition(position){this.config.labelPosition=position;switch(position){case"top":this.style.flexFlow="column";this.style.alignItems="unset";this.field.style.order=1;break;case"bottom":this.style.flexFlow="column";this.style.alignItems="unset";this.field.style.order=-1;break;case"right":this.style.flexFlow="row";this.style.alignItems="center";this.field.style.order=-1;break;default:this.style.flexFlow="row";this.style.alignItems="center";this.field.style.order=1}return this}};customElements.define("a-slider",kiss.ui.Slider);const createSlider=config=>document.createElement("a-slider").init(config);const createForm=function(record){if(!record)return;const isStandAlone=kiss.context.ui=="form-view";const model=record.model;const modelId=model.id;const isMobile=kiss.screen.isMobile;const isOwner=kiss.session.isOwner;const isAccountManager=kiss.session.isAccountManager();kiss.context.record=record;if(record&&$(record.id)){return createNotification(txtTitleCase("#record already opened"))}kiss.pubsub.publish("EVT_FORM_OPENED");function computeFormPosition(){if(isMobile){return{top:0,left:0,width:"100%",height:"100%"}}if(model.fullscreen){return{top:"1rem",left:"1rem",width:"calc(100vw - 2rem)",height:"calc(100vh - 2rem)"}}else{if(model.align=="right"){return{top:0,left:()=>kiss.screen.current.width-Math.min(kiss.screen.current.width/3*2,1200),width:()=>Math.min(kiss.screen.current.width/3*2,1200),height:"100%"}}else{const numberOfOpenedRecords=Array.from(document.querySelectorAll(".form-record")).length;return{top:"1rem",left:()=>(kiss.screen.current.width-Math.min(kiss.screen.current.width/3*2,1e3))/2+numberOfOpenedRecords*10,width:()=>Math.min(kiss.screen.current.width/3*2,1200),height:"calc(100vh - 2rem)"}}}}const position=computeFormPosition();const modelName=kiss.language.translateProperty(model,"name");return createPanel({class:"form-record",id:record.id,title:modelName.toTitleCase(),icon:model.icon,headerBackgroundColor:model.color,layout:"horizontal",position:"fixed",modal:!isStandAlone,closable:true,draggable:!isMobile&&!model.fullscreen,expandable:!isMobile&&!model.fullscreen,top:position.top,left:position.left,width:position.width,height:position.height,padding:0,borderRadius:isMobile?"0px 0px 0px 0px":"var(--panel-border-radius)",items:[{hidden:true,class:"form-side-bar",layout:"vertical"},{layout:"vertical",flex:1,items:[{hidden:true,//!isMobile,
id:"mobile-form-exit",type:"button",text:"Back",textAlign:"left",color:"#ffffff",backgroundColor:model.color,icon:"fas fa-chevron-left",iconColor:"#ffffff",height:"5rem",borderRadius:0,action:()=>$(record.id).close()},{class:"form-tabs",display:"inline",defaultConfig:{class:"form-tab"}},{class:"form-panels",multiview:true,layout:"vertical",overflow:"hidden",flex:1}]}],headerIcons:[{hidden:!kiss.session.isAccountManager(),icon:"fas fa-info-circle",action:()=>{if($("record-information"))$("record-information").remove();createPanel({id:"record-information",title:"Record information",icon:"fas fa-info-circle",align:"center",verticalAlign:"center",closable:true,draggable:true,modal:true,items:[{layout:"horizontal",alignItems:"center",items:[{type:"text",label:"Model ID",value:model.id,disabled:true,labelWidth:100,fieldWidth:250},{type:"button",icon:"fas fa-copy",width:32,height:32,action:()=>{kiss.tools.copyTextToClipboard(model.id);createNotification(txtTitleCase("ID copied"))}}]},{layout:"horizontal",alignItems:"center",items:[{type:"text",label:"Record ID",value:record.id,disabled:true,labelWidth:100,fieldWidth:250},{type:"button",icon:"fas fa-copy",width:32,height:32,action:()=>{kiss.tools.copyTextToClipboard(record.id);createNotification(txtTitleCase("ID copied"))}}]}]}).render()}}],events:{close:function(forceClose){if(isStandAlone){kiss.router.navigateTo({ui:kiss.session.defaultViews.home},true)}if(forceClose){kiss.pubsub.publish("EVT_FORM_CLOSED");return true}const isValid=$(record.id).validateContent();if(!isValid)return false;kiss.pubsub.publish("EVT_FORM_CLOSED");return true}},subscriptions:{"EVT_DB_UPDATE:MODEL":async function(msgData){if(msgData.id==modelId)await this.load()},["EVT_DB_UPDATE:"+model.id.toUpperCase()]:async function(msgData){if(msgData.id==record.id){Object.assign(this.record,msgData.data);this.applyHideFormulae()}},EVT_DB_UPDATE_BULK:async function(msgData){const updates=msgData.data;const update=updates.find((update=>update.recordId==record.id));if(update){this.applyHideFormulae()}}},methods:{async load(){let formFeatures=[];let formHeaderFeatures=[];let formFooterFeatures=[];this.record=record;this.activeFeatureIndex=-1;this.canEditModel=await this.checkIfUserCanEditModel();let formPanelFeatures=[createFormContent({record:this.record,editMode:!this.record.isLocked})];if(kiss.app.collections.model){let modelRecord=kiss.app.collections.model.getRecord(modelId);if(modelRecord){let modelFeatures=modelRecord.features||{};this.getActivePlugins(modelFeatures).forEach((plugin=>{if(plugin.admin==true&&!isOwner&&!isAccountManager)return;if(plugin.disabled==true)return;const formSectionTypes=["form-section","form-header","form-footer"];plugin.features.forEach((feature=>{if(!formSectionTypes.includes(feature.type))return;let featureId=kiss.tools.shortUid();let newFeatureView=feature.renderer(this);newFeatureView.classList.add(featureId);newFeatureView.setAttribute("featureId",featureId);if(feature.type=="form-section"){formPanelFeatures=formPanelFeatures.concat(newFeatureView);formFeatures.push({id:featureId,pluginId:plugin.id,icon:plugin.icon,name:plugin.name})}if(feature.type=="form-header"){formHeaderFeatures=formHeaderFeatures.concat(newFeatureView)}if(feature.type=="form-footer"){formFooterFeatures=formFooterFeatures.concat(newFeatureView)}}))}));let tabs=createFormTabBar(this,formFeatures);let formTabs=this.getFormTabs();formTabs.setItems(tabs);const tabElements=formTabs.querySelectorAll(".underline-effect");tabElements.forEach((tab=>tab.style.setProperty("--tab-underline-effect",modelRecord.color)));const modelName=kiss.language.translateProperty(modelRecord,"name");this.setTitle(modelName);this.setIcon(modelRecord.icon);this.setHeaderBackgroundColor(modelRecord.color)}}let formPanels=this.getFormPanels();formPanels.setItems(formPanelFeatures);let formHeader=this.getFormHeader();formHeader.setItems(formHeaderFeatures);let formFooter=this.getFormFooter();formFooter.setItems(formFooterFeatures);let sideMenus=createFormSideBar(this,formFeatures,formHeaderFeatures,formFooterFeatures);let formSideBar=this.getFormSideBar();formSideBar.setItems(sideMenus);this.applyHideFormulae();this.restoreNavigation();this.enableButtonActions()},enableButtonActions(){try{const buttons=this.getFormButtons();const userACL=kiss.session.getACL();buttons.forEach((button=>{const isAuthorized=kiss.tools.intersects(userACL,button.config.accessRead);if(!isAuthorized){button.remove();return}if(button.config.actions&&Array.isArray(button.config.actions)&&button.config.actions.length>0){button.onclick=async function(){let hasError=false;if(this.canClick===false)return;this.canClick=false;setTimeout((()=>{this.canClick=true}),1e3);let clientActions=[];button.config.actions.forEach((action=>{if(action.executionType=="client"){clientActions.push(action)}else if(action.executionType=="both"){const advancedAction=kiss.app.collections.action.getRecord(action.config.actionId);if(advancedAction&&advancedAction.executionType=="client"){clientActions.push(action)}}}));clientActions.forEach((action=>{try{if(action.executionType=="client"){eval(action.config.code)}else if(action.executionType=="both"){const advancedAction=kiss.app.collections.action.getRecord(action.config.actionId);if(!advancedAction)return;if(advancedAction.executionType!="client")return;eval(advancedAction.code)}}catch(err){log.err("Form action has failed to execute:");console.log({id:action.id,type:action.type,error:err.message});hasError=true}}));if(hasError)createNotification(txtTitleCase("#action error"));const response=await kiss.ajax.request({url:"/command/actions/button",method:"post",showLoading:true,body:JSON.stringify({language:kiss.language.current,modelId:model.id,recordId:record.id,buttonId:button.id})});if(response&&response.data&&Array.isArray(response.data)){let hasError=false;response.data.forEach((result=>{if(result.success===false){log.err("Form action has failed to execute:");console.log({id:result.id,type:result.type,index:result.index,error:result.error});hasError=true}}));if(hasError)createNotification(txtTitleCase("#action error"))}}}}))}catch(err){log.err("kiss.ui - Warning: could not enable button actions");log(err)}},async checkIfUserCanEditModel(){if(!kiss.app.collections.model)return false;const modelRecord=kiss.app.collections.model.records.get(model.id);if(!modelRecord)return false;return await kiss.acl.check({action:"update",record:modelRecord})},getActivePlugins(modelFeatures){return kiss.plugins.get().filter((plugin=>{if(!modelFeatures[plugin.id])return false;if(modelFeatures[plugin.id].active==false)return false;return true}))},showFeature(featureId){const modelRecord=kiss.app.collections.model.getRecord(modelId);const modelFeatures=modelRecord.features||{};const activeFeatures=this.getActivePlugins(modelFeatures);const featureIndex=activeFeatures.findIndex((feature=>feature.id==featureId))+1;const animationName=featureIndex>this.activeFeatureIndex?"slideInRight":"slideInLeft";this.activeFeatureIndex=featureIndex;const animation={name:animationName,speed:"faster"};const formFeaturesContainer=this.getFormPanels();formFeaturesContainer.showItemByClass(featureId,animation);if(this.getNavigationMode()=="tabs"){const formTabs=$(record.id).querySelector(".form-tabs");const tabs=formTabs.items;for(let i=0;i<tabs.length;i++)tabs[i].setBorderColor("var(--button-border)");tabs[featureIndex+2].setBorderColor(model.color)}},showAllSections(){const content=this.getFormContent();const formSections=content.querySelectorAll(".a-panel");Array.from(formSections).forEach((panelElement=>$(panelElement.id).show()));this.applyHideFormulae()},showSection(sectionTitle){this.showFeature("form-content");const content=this.getFormContent();const formSections=content.querySelectorAll(".a-panel");Array.from(formSections).forEach((panelElement=>{const panel=$(panelElement.id);if(panel.config.title==sectionTitle){panel.show();panel.expand()}else panel.hide()}))},computeFormPosition(){return computeFormPosition()},getFormContent(){return this.querySelector(".form-content")},getFormSections(){let sections=[];const formContent=this.querySelector(".form-fields");const formItems=Array.from(formContent.children);formItems.forEach((item=>{if(item.items)sections.push(item)}));return sections},getFormTabs(){return this.querySelector(".form-tabs")},getFormSideBar(){return this.querySelector(".form-side-bar")},getFormHeader(){return this.querySelector(".form-header")},getFormFooter(){return this.querySelector(".form-footer")},getFormPanels(){return this.querySelector(".form-panels")},getFormFields(){return this.querySelector(".form-fields")},getFormButtons(){const formContent=this.querySelector(".form-fields");const elements=formContent.getElements();const buttons=elements.filter((element=>element.type=="button"));return buttons},getNavigationMode(){return localStorage.getItem("config-formNavigationMode-"+model.id)},showTabBar(){const tabs=this.getFormTabs();tabs.setAnimation({name:"slideInLeft",speed:"faster"}).show()},hideTabBar(){const tabs=this.getFormTabs();tabs.hide()},showSideBar(){const sideBar=this.getFormSideBar();sideBar.show()},hideSideBar(){const sideBar=this.getFormSideBar();sideBar.hide()},switchNavigation(mode){localStorage.setItem("config-formNavigationMode-"+model.id,mode);if(mode=="left"){this.hideTabBar();this.showSideBar()}else{this.hideSideBar();this.showTabBar();this.showAllSections()}},hideNavigation(){this.hideTabBar();this.hideSideBar()},restoreNavigation(){const navigationMode=localStorage.getItem("config-formNavigationMode-"+model.id);if(navigationMode=="left"){this.hideTabBar();this.showSideBar()}else{this.hideSideBar();this.showTabBar()}},validateContent(){const formContent=this.getFormContent();const isValid=formContent.validate();if(!isValid)return false;return true},applyHideFormulae(){const isDesigner=kiss.router.getRoute().ui=="form-builder";if(isDesigner)return;this.applyHideFormulaeToSections();this.applyHideFormulaeToItems()},applyHideFormulaeToSections(){const sections=this.getFormSections();sections.forEach((section=>{const sectionElement=this.querySelector("#"+section.id.replaceAll(":","\\:"));if(!sectionElement)return;const hideWhen=sectionElement.config.hideWhen;if(!hideWhen)return;const hideFormula=section.config.hideFormula;if(!hideFormula)return;try{const result=kiss.formula.execute(hideFormula,record,model.getActiveFields());const navSectionElement=this.querySelector(("#nav-"+record.id+":"+section.config.originalId).replaceAll(":","\\:"));if(result===true){sectionElement.hide();navSectionElement.hide()}else{sectionElement.show();navSectionElement.show()}}catch(err){log("kiss.ui - Warning: could not hide the section "+section)}}))},applyHideFormulaeToItems(){const formContent=this.getFormContent();const fields=formContent.getFields();const elements=formContent.getElements();const items=fields.concat(elements);items.forEach((item=>{const itemElement=this.querySelector("#"+item.id.replaceAll(":","\\:"));if(!itemElement)return;const hideWhen=itemElement.config.hideWhen;if(!hideWhen)return;const hideFormula=itemElement.config.hideFormula;if(!hideFormula)return;try{kiss.context.record=record;const result=kiss.formula.execute(hideFormula,record,model.getActiveFields());if(result===true)itemElement.hide();else itemElement.show()}catch(err){log("kiss.ui - Warning: could not hide the item "+item)}}))}}}).render()};const createFormActions=function(form,activeFeatures){const record=form.record;const isMobile=kiss.screen.isMobile;const hasFeatures=activeFeatures.length>0;let featureButtons=[];if(kiss.screen.isMobile&&hasFeatures){featureButtons.push({id:"button-form-"+record.id,text:txtTitleCase("form"),icon:"far fa-window-restore",action:()=>form.showFeature("form-content")});activeFeatures.forEach((feature=>{featureButtons.push({id:"button-"+feature.id+"-"+record.id,text:feature.name,icon:feature.icon,action:()=>form.showFeature(feature.pluginId)})}))}let featureMenuItems=[];let hasSeparator=false;activeFeatures.forEach((feature=>{const pluginId=feature.pluginId;const plugin=kiss.plugins.get(pluginId);plugin.features.forEach((feature=>{if(feature.type=="form-menu"){if(!hasSeparator){featureMenuItems.push("-");hasSeparator=true}const menuItem=feature.renderer(form);featureMenuItems.push(menuItem)}}))}));let actions=[];if(kiss.app.customActions&&kiss.app.customActions.length>0){const userACL=kiss.session.getACL();let customActions=kiss.app.customActions.filter((action=>{const isTargetForm=action.type&&action.type.includes("form")&&action.formIds&&(action.formIds.includes(record.model.id)||action.formIds.includes("*"));const isTargetUser=kiss.tools.intersects(userACL,action.accessRead);return isTargetForm&&isTargetUser}));customActions.forEach((action=>{const menuAction={id:action.id,text:action.name,icon:action.icon,iconColor:action.color,action:()=>{eval(action.code)}};actions.push(menuAction)}))}return[...featureButtons,{hidden:!form.canEditModel||isMobile,icon:"fas fa-cog",text:txtTitleCase("form properties"),action:()=>{kiss.context.modelId=record.model.id;kiss.views.show("model-properties")}},{hidden:!form.canEditModel||isMobile,icon:"fas fa-wrench",text:txtTitleCase("edit form"),action:()=>{const form=$(record.id);form.close("remove",true);let areFormsClosed=true;const openedForms=document.querySelectorAll(".form-record");openedForms.forEach((openedForm=>{areFormsClosed=areFormsClosed&&openedForm.close()}));if(!areFormsClosed)return;app.api.openFormDesigner(record.model.id)}},{hidden:!form.canEditModel||isMobile,icon:"fas fa-puzzle-piece",text:txtTitleCase("#edit features")+" <b></b>",action:()=>{kiss.context.modelId=record.model.id;kiss.views.show("model-features")}},{hidden:!form.canEditModel||isMobile,icon:"fas fa-key",text:txtTitleCase("#secure table"),action:()=>{kiss.context.modelId=record.model.id;kiss.views.show("model-access")}},{hidden:!kiss.session.isAccountManager()||kiss.screen.isMobile,text:txtTitleCase("manage advanced actions"),icon:kiss.app.models.action.icon,action:()=>{const setup=kiss.views.show("setup-home");const sections=setup.sections;const actionSection=sections.find((section=>section.id=="advancedActions"));setup.selectModel(actionSection);setup.close()}},...featureMenuItems,form.canEditModel&&!isMobile?"-":"",isMobile?"-":"",{icon:"fas fa-minus-circle",text:txtTitleCase("collapse all sections"),action:()=>form.collapseAll()},{icon:"fas fa-plus-circle",text:txtTitleCase("expand all sections"),action:()=>form.expandAll()},"-",{icon:"fas fa-trash",iconColor:"var(--red)",text:txtTitleCase("delete this record"),action:()=>{createDialog({type:"danger",title:txtTitleCase("delete this record"),message:txtTitleCase("#delete record warning"),buttonOKPosition:"left",action:async()=>{const form=$(record.id);const success=await record.delete(true);if(success){form.close("remove",true)}else{createNotification(txtTitleCase("#error general"))}}})}},{hidden:true,icon:"fas fa-link",text:txtTitleCase("get a link to this document"),action:()=>{kiss.router.updateUrlHash({recordId:record.id});kiss.tools.copyTextToClipboard(window.location.href);createNotification(txtTitleCase("#link copied"))}},actions.length>0?"-":"",...actions]};const createFormContent=function(config){let model,modelItems,record;if(config.record){record=config.record;model=record.model;modelItems=JSON.parse(JSON.stringify(model.items))}else if(config.model){model=config.model;modelItems=config.model.items}const userACL=kiss.session.getACL();const orientation=kiss.screen.getOrientation();function getFormItems(items,editMode){items=items.filter((item=>item!=null&&item.deleted!=true));items.forEach((item=>{if(item.items){if(config.record&&item.accessRead)item.accessRead=item.accessRead.map((entry=>entry!="$creator"?entry:config.record.createdBy));const canRead=kiss.tools.intersects(item.accessRead,userACL)||!item.accessRead;if(!canRead){item.hidden=true}else{if(config.record&&item.accessUpdate)item.accessUpdate=item.accessUpdate.map((entry=>entry!="$creator"?entry:config.record.createdBy));const canUpdate=editMode===false?false:kiss.tools.intersects(item.accessUpdate,userACL)||!item.accessUpdate;item.originalId=item.id;item.id=kiss.tools.shortUid();item.headerBackgroundColor=model.color;item.headerBackgroundColor2=kiss.tools.adjustColor(model.color,-.1);item.items=getFormItems(item.items,canUpdate)}item.title=item.hasOwnProperty("title")?item.title.toTitleCase():"";if(item.colored===false){item.headerColor=model.color;item.headerBorderColor=model.color;item.headerBackgroundColor="transparent";item.headerBackgroundColor2=null;item.iconColor=model.color}}else{if(editMode===false){item.readOnly=true;item.locked=true;item.required=false}else if(item.required){}if(item.type=="summary"){if(item.summary.type=="directory"&&item.summary.operation=="LIST_NAMES")item.type="directory"}else if(item.type=="lookup"){item.type=item.lookup.type||"text";if(item.type=="selectViewColumns")item.type="text"}if(orientation=="vertical"){item.labelPosition="top";item.width="100.00%";item.fieldWidth="100.00%";item.labelWidth="100.00%"}if(item.type=="html"&&record){item.html=item.html.replace(/{(.*?)}/g,((match,tagName)=>{const field=model.getField(tagName);if(field){return record[field.id]}else{return tagName}}))}}}));return items}modelItems=getFormItems(modelItems,config.editMode);return createBlock({class:"form-content",layout:"vertical",overflowY:"auto",flex:1,padding:orientation=="vertical"?"0":"var(--panel-padding)",defaultConfig:{overflow:"unset"},items:[{class:"form-header"},{class:"form-fields",defaultConfig:{width:"100%",labelWidth:"100%",labelPosition:"top"},record:record,items:modelItems},{class:"form-footer"}],methods:{async load(){if(kiss.screen.isMobile)return;const form=this.closest(".form-record");if(form.canEditModel)this.enableFieldDesign()},enableFieldDesign(){const fieldLabels=this.querySelectorAll(".field-label");fieldLabels.forEach((labelElement=>{labelElement.classList.add("field-label-setup");const fieldId=labelElement.parentNode.id;const field=model.getField(fieldId);const isPrimary=field.primary;labelElement.onclick=function(event){createMenu({items:[{text:txtTitleCase("edit field")+" <b>"+field.label+"</b>",icon:"fas fa-edit",action:()=>{kiss.context.dockFieldProperties=false;kiss.router.updateUrlHash({modelId:model.id,fieldId:fieldId});kiss.views.show("model-field")}},{hidden:!kiss.session.isAccountManager(),text:txtTitleCase("copy ID")+` (${fieldId})`,icon:"fas fa-copy",action:()=>{kiss.tools.copyTextToClipboard(fieldId);createNotification(txtTitleCase("ID copied"))}},!isPrimary?"-":"",!isPrimary?{text:txtTitleCase("delete field"),icon:"fas fa-trash",iconColor:"var(--red)",action:()=>{createDialog({type:"danger",title:txtTitleCase("delete an item"),message:txtTitleCase("#delete item warning"),action:async()=>{await model.deleteField(fieldId)}})}}:""]}).render().showAt(event.clientX-10,event.clientY-10)}}))}}})};const createformFeatureDescription=function(name,icon,color,description,instructions,showArrow=true){let html=`\n        ${showArrow===false?"":`<div style="display: flex; flex-flow: row">\n            <div style="flex:1"></div>\n            <div class="form-feature-arrow"><span class="fas fa-arrow-up"></span></div>\n        </div>`}\n\n        <div class="form-feature-description" style="display: flex; flex-flow: row; background-color: ${color}">\n            <div class="form-feature-description-icon" style="flex:1; background-color: ${kiss.tools.adjustColor(color,-.1)}">\n                <span class="${icon}"></span>\n            </div>\n            <div style="flex: 2">\n                <div class="form-feature-description-title">${name}</div>\n                <div class="form-feature-description-text">${description}</div>\n                <div class="form-feature-description-text">${instructions}</div>\n            </div>\n        </div>`;return createHtml({html:html})};const createFormSideBar=function(form,activeFeatures,formHeaderFeatures,formFooterFeatures){const record=form.record;const model=record.model;const headerSections=Array.from(formHeaderFeatures).map((section=>({type:"button",text:section.config.title,textAlign:"left",icon:section.config.icon,margin:"0 0.5rem 1rem 5rem",classes:{this:"form-side-bar-button"},action:()=>form.showSection(section.config.title)})));const sections=model.items.map((section=>{if(section.type!="panel")return"";const sectionTitle=kiss.language.translateProperty(section,"title");return{id:"nav-"+record.id+":"+section.id,type:"button",text:sectionTitle,textAlign:"left",icon:section.icon,margin:"0 0.5rem 1rem 5rem",classes:{this:"form-side-bar-button"},action:()=>form.showSection(sectionTitle)}}));const footerSections=Array.from(formFooterFeatures).map((section=>({type:"button",text:section.config.title,textAlign:"left",icon:section.config.icon,margin:"0 0.5rem 1rem 5rem",classes:{this:"form-side-bar-button"},action:()=>form.showSection(section.config.title)})));let formFeatures=[{layout:"horizontal",margin:"0 0 2rem 0",flexShrink:0,items:[{type:"button",tip:txtTitleCase("#tabs navigation"),icon:"fas fa-columns",classes:{this:"form-side-bar-menu"},action:()=>form.switchNavigation("tabs")},{type:"button",text:txtTitleCase("#action menu"),textAlign:"left",icon:"fas fa-bars",classes:{this:"form-side-bar-menu"},action:function(){createMenu({left:this.getBoundingClientRect().x,top:this.getBoundingClientRect().y,items:createFormActions(form,activeFeatures)}).render()}}]},{id:"button-form-"+record.id,type:"button",text:txtTitleCase("form"),textAlign:"left",icon:"far fa-window-restore",iconColor:model.color,classes:{this:"form-side-bar-button"},action:function(){form.showFeature("form-content");form.showAllSections()}},...headerSections,...sections,...footerSections];activeFeatures.forEach((feature=>{const featureName=kiss.language.translateProperty(feature,"name");let newFeature={id:"button-"+feature.id+"-"+record.id,type:"button",text:featureName,textAlign:"left",icon:feature.icon,iconColor:model.color,classes:{this:"form-side-bar-button"},action:()=>form.showFeature(feature.pluginId)};formFeatures=formFeatures.concat(newFeature)}));return formFeatures};const createFormTabBar=function(form,activeFeatures){const record=form.record;const formTabHeight="var(--form-tab-height)";const formTabFontSize="var(--form-tab-font-size)";const formTabBorderRadius="var(--form-tab-border-radius)";const hasFeatures=activeFeatures.length>0;const isMobile=kiss.screen.isMobile;let formFeatures=[{hidden:isMobile,type:"button",tip:txtTitleCase("#side navigation"),icon:"fas fa-columns",borderWidth:0,borderRadius:"3.2rem",fontSize:formTabFontSize,height:formTabHeight,borderRadius:formTabBorderRadius,backgroundColorHover:"transparent",action:()=>form.switchNavigation("left")},{type:"button",text:isMobile?"":txtTitleCase("#action menu"),icon:"fas fa-bars",borderWidth:0,borderRadius:"3.2rem",fontSize:formTabFontSize,height:formTabHeight,borderRadius:formTabBorderRadius,backgroundColorHover:"transparent",action:function(){createMenu({left:this.getBoundingClientRect().x,top:this.getBoundingClientRect().y,items:createFormActions(form,activeFeatures)}).render()}}];if(hasFeatures){formFeatures.push({id:"button-form-"+record.id,type:"button",text:isMobile?"":txtTitleCase("form"),icon:"far fa-window-restore",fontSize:formTabFontSize,height:formTabHeight,borderRadius:formTabBorderRadius,backgroundColorHover:"transparent",classes:{this:"underline-effect"},action:()=>form.showFeature("form-content")})}activeFeatures.forEach((feature=>{let newFeature={id:"button-"+feature.id+"-"+record.id,type:"button",text:isMobile?"":feature.name,icon:feature.icon,fontSize:formTabFontSize,height:formTabHeight,borderRadius:formTabBorderRadius,backgroundColorHover:"transparent",classes:{this:"underline-effect"},action:()=>form.showFeature(feature.pluginId)};formFeatures=formFeatures.concat(newFeature)}));return formFeatures};const createDataFieldsWindow=function(viewId,color="#00aaee"){const selectWindowId="field-selection-for-"+viewId;return createPanel({id:selectWindowId,title:txtTitleCase("select your fields"),icon:"fas fa-bars fa-rotate-90",headerBackgroundColor:color,maxHeight:()=>kiss.screen.current.height-150,modal:true,closable:true,draggable:true,layout:"vertical",zIndex:10,items:[{id:"field-selection-for-datable:"+viewId,layout:"vertical",overflowY:"auto"},{layout:"horizontal",margin:"10px 0px 0px 0px",overflow:"unset",items:[{type:"button",text:txtTitleCase("hide all"),icon:"fas fa-eye-slash",flex:1,events:{click:function(){let selectionWindow=$(selectWindowId);selectionWindow.toggleAll("hide")}}},{type:"spacer",width:"10px"},{type:"button",text:txtTitleCase("show all"),icon:"fas fa-eye",flex:1,events:{click:function(){let selectionWindow=$(selectWindowId);selectionWindow.toggleAll("show")}}}]}],subscriptions:{"EVT_DB_UPDATE:VIEW":msgData=>{if($(selectWindowId)&&msgData.id==viewId&&msgData.userId!=kiss.session.getUserId())$(selectWindowId).load()},["EVT_VIEW_FIELD_MOVED:"+viewId]:()=>$(selectWindowId).load()},methods:{load:()=>{let checkboxFields=[];$(viewId).getFields().forEach((field=>{if(field.deleted)return;checkboxFields.push({id:"checkbox-"+field.id,type:"checkbox",label:field.title.toTitleCase(),labelWidth:"100%",labelPosition:"right",checked:!field.hidden,shape:"switch",iconSize:"16px",iconColorOn:color,class:"switch-field",draggable:true,events:{click:function(){let fieldId=this.id.split("checkbox-")[1];kiss.pubsub.publish("EVT_VIEW_FIELD_TOGGLED_ONE:"+viewId,fieldId)},ondragstart:function(event){event.stopPropagation();kiss.context.draggedElement=event.target.closest("a-checkbox");kiss.context.dragStartY=event.clientY},ondragover:function(event){event.stop();const dropTarget=event.target.closest("a-checkbox");if(dropTarget.id==kiss.context.draggedElement.id)return;dropTarget.style.minHeight="60px";dropTarget.style.alignItems="unset";dropTarget.style.transition="all 0.1s"},ondragleave:function(event){const dropTarget=event.target.closest("a-checkbox");dropTarget.style.minHeight="26px";dropTarget.style.alignItems="center"},ondrop:function(event){const dropTarget=event.target.closest("a-checkbox");dropTarget.style.minHeight="26px";dropTarget.style.alignItems="center";const sourceFieldId=kiss.context.draggedElement.id.split("checkbox-")[1];const targetFieldId=dropTarget.id.split("checkbox-")[1];publish("EVT_VIEW_FIELD_MOVING:"+viewId,{sourceFieldId:sourceFieldId,targetFieldId:targetFieldId,position:"after"})}}})}));$("field-selection-for-datable:"+viewId).setItems(checkboxFields)},toggleAll:newState=>{let isChecked=newState=="show";$(viewId).getFields().forEach((field=>{if(field.deleted)return;let checkboxId="checkbox-"+field.id;let checkbox=$(checkboxId);checkbox.setValue(isChecked)}));publish("EVT_VIEW_FIELD_TOGGLED_ALL:"+viewId,newState)}}})};const createDataFilter=function(viewId,color,config){let id=kiss.tools.shortUid();let fieldId=config.fieldId||"";let filterOperator=config.operator||"=";let filterDateOperator=config.dateOperator||"exact date";let fieldValue=kiss.tools.isNumber(config.value)?config.value||0:config.value||"";const model=$(viewId).collection.model;const isDynamicModel=kiss.tools.isUid(model.id);let selectFields=model.getFilterableFields().map((field=>{const needsTranslation=field.isSystem||field.isFromPlugin||field.label.startsWith("#")?true:false;return{type:field.type,label:isDynamicModel&&!needsTranslation?field.label.toTitleCase():txtTitleCase(field.label),value:field.id}}));function getFieldId(){const filterField=$("filter-field:"+id);if(filterField)return filterField.getValue()}function getFieldType(fieldId){let fieldConfig=$(viewId).collection.model.getField(fieldId);let type=fieldConfig?fieldConfig.type:"text";if(type=="lookup")type=fieldConfig.lookup.type;if(type=="summary")type=fieldConfig.summary.type;if(type=="lookup")type="text";return type||"text"}function getFilterOperator(){const filterOperator=$("filter-operator:"+id);if(filterOperator)return filterOperator.getValue();return config.operator}function getFilterDateOperator(){const filterDateOperator=$("filter-date-operator:"+id);if(filterDateOperator)return filterDateOperator.getValue();return config.dateOperator}function showFilterDateOperator(){const filterDateOperator=$("filter-date-operator:"+id);if(filterDateOperator)filterDateOperator.show()}function hideFilterDateOperator(){const filterDateOperator=$("filter-date-operator:"+id);if(filterDateOperator)filterDateOperator.hide()}function shouldHideFilterDateOperator(){if(getFieldType(fieldId)!="date")return true;if(getFilterOperator().includes("empty"))return true;return false}function getFilterValue(){const filterValue=$("filter-value:"+id);return filterValue.getValue()}function setFilterValue(value){const filterValue=$("filter-value:"+id);if(filterValue)filterValue.setValue(value)}function showFilterInput(){const filterValue=$("filter-value:"+id);if(filterValue)filterValue.show()}function hideFilterInput(){const filterValue=$("filter-value:"+id);if(filterValue)filterValue.hide()}function updateFilterOperator(fieldId){const filterOperator=$("filter-operator:"+id);const newFilterOperators=generateFilterOperators(fieldId);filterOperator.updateOptions(newFilterOperators);const currentOperator=filterOperator.getValue();const hasOperator=newFilterOperators.findIndex((operator=>operator.value==currentOperator));if(hasOperator==-1)filterOperator.setValue("")}function updateFilterDateOperator(fieldId){const fieldType=getFieldType(fieldId);const filterOperator=getFilterOperator();if(fieldType=="date"&&!filterOperator.includes("empty")){showFilterDateOperator()}else{hideFilterDateOperator()}}function updateFilterInput(fieldId){let field=$("filter-value:"+id);let target=field.target;field.deepDelete();let fieldConfig=buildFilterInput(fieldId);fieldConfig.target=target;let input=fieldConfig.renderer(fieldConfig);input.render();const fieldType=getFieldType(fieldId);const operatorValue=getFilterOperator();const dateOperatorValue=getFilterDateOperator();if(operatorValue.includes("empty")||fieldType=="date"&&dateOperatorValue.includes("today")){setFilterValue("");hideFilterInput()}else{showFilterInput()}}const generateFilterOperators=function(fieldId){let fieldType=getFieldType(fieldId);if(fieldType=="link")fieldType="text";let possibleOperators={text:["=","<>","contains","does not contain","is empty","is not empty"],password:["is empty","is not empty"],textarea:["=","<>","contains","does not contain","is empty","is not empty"],aiTextarea:["=","<>","contains","does not contain","is empty","is not empty"],number:["=","<>","<",">","<=",">=","is empty","is not empty"],rating:["=","<>","<",">","<=",">=","is empty","is not empty"],slider:["=","<>","<",">","<=",">=","is empty","is not empty"],date:["=","<>","<",">","<=",">=","is empty","is not empty"],checkbox:["=","<>","is empty","is not empty"],select:["=","<>","contains","does not contain","is empty","is not empty"],selectViewColumn:["=","<>","contains","does not contain","is empty","is not empty"],selectViewColumns:["=","<>","contains","does not contain","is empty","is not empty"],directory:["contains","does not contain","is empty","is not empty"],summary:["=","<>","<",">","<=",">=","is empty","is not empty"],attachment:["is empty","is not empty"],color:["=","<>","is empty","is not empty"],icon:["=","<>","is empty","is not empty"]}[fieldType];return[{label:"=",value:"="},{label:"<>",value:"<>"},{label:"<",value:"<"},{label:">",value:">"},{label:"<=",value:"<="},{label:">=",value:">="},{label:txtTitleCase("contains"),value:"contains"},{label:txtTitleCase("does not contain"),value:"does not contain"},{label:txtTitleCase("is empty"),value:"is empty"},{label:txtTitleCase("is not empty"),value:"is not empty"}].filter((operator=>possibleOperators.indexOf(operator.value)!=-1))};function buildFilterInput(fieldId){let fieldConfig=$(viewId).collection.model.getField(fieldId);let fieldType=getFieldType(fieldId);let isHidden=filterOperator.includes("empty");let fieldBuilderFunction=createField;let checked=false;let options=[];let optionsFilter;let shape="";let lookup={};let summary={};let roles=[];let unit;let min;let max;switch(fieldType){case"attachment":case"textarea":case"aiTextarea":case"selectViewColumn":case"selectViewColumns":case"link":fieldType="text";break;case"select":options=fieldConfig.options;optionsFilter=fieldConfig.optionsFilter;fieldBuilderFunction=createSelect;break;case"checkbox":shape=fieldConfig.shape;fieldBuilderFunction=createCheckbox;if(fieldValue==true)checked=true;break;case"slider":min=fieldConfig.min||0;max=fieldConfig.max||100;fieldBuilderFunction=createSlider;break;case"rating":shape=fieldConfig.shape||"star";min=fieldConfig.min||0;max=fieldConfig.max||10;color=fieldConfig.iconColorOn;fieldBuilderFunction=createRating;break;case"color":fieldBuilderFunction=createColorField;break;case"icon":fieldBuilderFunction=createIconField;break;case"lookup":lookup=fieldConfig.lookup;break;case"summary":summary=fieldConfig.summary;break;case"directory":roles=["userId"];fieldBuilderFunction=createDirectory;break;case"date":let dateOperator=getFilterDateOperator()||filterDateOperator;if(dateOperator=="days from now"||dateOperator=="days ago"){fieldType="number";unit=txt("days")}else if(dateOperator=="today"){isHidden=true}}return{hidden:isHidden,id:"filter-value:"+id,type:fieldType,label:txtTitleCase("value"),labelPosition:"top",minWidth:"25rem",value:fieldValue,min:min,max:max,unit:unit,checked:checked,draggable:true,allowValuesNotInList:true,renderer:fieldBuilderFunction,options:options,optionsFilter:optionsFilter,optionsColor:color,roles:roles,shape:shape,iconColorOn:color,iconSize:"2rem",lookup:lookup,events:{change:function(event){let rootFilter=event.target.closest(".root-filter");rootFilter.updateFilter()},dragstart:event=>event.preventDefault()}}}let dataFilter=createBlock({id:"filter-"+id,target:config.target,layout:"horizontal",alignItems:"center",draggable:true,class:"filter",items:[{id:"filter-delete:"+id,type:"button",icon:"fas fa-trash",width:"3rem",height:"3rem",events:{click:function(event){let filter=event.target.closest("a-block");let rootFilter=event.target.closest(".root-filter");let doUpdate=filter.getFilter()!=null;filter.deepDelete();if(doUpdate)rootFilter.updateFilter()}}},{id:"filter-field:"+id,type:"select",label:txtTitleCase("where field"),labelPosition:"top",width:"25rem",value:fieldId,options:selectFields,optionsColor:color,events:{change:function(event){const fieldId=getFieldId();updateFilterOperator(fieldId);updateFilterDateOperator(fieldId);updateFilterInput(fieldId);const filter=event.target.closest("a-block");if(filter.getFilter()==null)return;const rootFilter=event.target.closest(".root-filter");rootFilter.updateFilter()}}},{id:"filter-operator:"+id,type:"select",label:txtTitleCase("operator"),labelPosition:"top",width:"15rem",autocomplete:"off",value:filterOperator,options:generateFilterOperators(fieldId),optionsColor:color,events:{change:function(event){const fieldId=getFieldId();updateFilterDateOperator(fieldId);updateFilterInput(fieldId);const filter=event.target.closest("a-block");if(filter.getFilter()==null)return;const rootFilter=event.target.closest(".root-filter");rootFilter.updateFilter()}}},{hidden:shouldHideFilterDateOperator(),id:"filter-date-operator:"+id,type:"select",label:txtTitleCase("comparison"),labelPosition:"top",width:"15rem",autocomplete:"off",value:filterDateOperator,options:[{label:txtTitleCase("exact date"),value:"exact date"},{label:txtTitleCase("today"),value:"today"},{label:txtTitleCase("days from now"),value:"days from now"},{label:txtTitleCase("days ago"),value:"days ago"}],optionsColor:color,events:{change:function(event,value){const fieldId=getFieldId();updateFilterInput(fieldId);const filter=event.target.closest("a-block");if(filter.getFilter()==null)return;const rootFilter=event.target.closest(".root-filter");rootFilter.updateFilter()}}},buildFilterInput(fieldId)],events:{dragstart:function(event){kiss.context.draggedElement=event.target}},methods:{getFilter:function(){const filterFieldId=getFieldId();const filterFieldType=getFieldType(filterFieldId);const filterOperator=getFilterOperator();const filterDateOperator=getFilterDateOperator();const filterValue=getFilterValue();if(filterFieldId===""||filterOperator===""||filterValue===""&&!filterOperator.includes("empty")&&!filterDateOperator.includes("today"))return null;return{type:"filter",id:this.id,fieldId:filterFieldId,fieldType:filterFieldType,operator:filterOperator,dateOperator:filterDateOperator,value:filterValue}}}});return dataFilter};const createDataFilterGroup=function(viewId,color,config){let id=config.id||kiss.tools.shortUid();let filterContentId="group-"+id;let target=config.target||null;let isRootFilter=config.isRootFilter||false;let groupOperator=config.operator||"and";let canAddGroup=config.canAddGroup||false;let canDeleteGroup=config.canDeleteGroup||false;let filterGroup=createBlock({id:"filter-group-"+id,target:target,layout:"horizontal",alignItems:"center",classes:{this:"filter-group"+(isRootFilter?" root-filter":"")},items:[{layout:"horizontal",alignItems:"center",minWidth:"12.8rem",items:[{hidden:!canAddGroup,id:"filter-group-add:"+id,type:"button",icon:"fas fa-plus",width:"3rem",height:"3rem",tip:{text:txtTitleCase("add a subgroup"),deltaX:0,deltaY:20},events:{click:function(){let filterGroup=this.closest(".filter-group");filterGroup.addFilterGroup({target:filterContentId,canDeleteGroup:true})}}},{hidden:!canDeleteGroup,id:"filter-group-delete:"+id,type:"button",icon:"fas fa-trash",width:"3rem",height:"3rem",events:{click:function(event){let rootFilter=this.closest(".root-filter");$("filter-group-"+id).deepDelete();rootFilter.updateFilter()}}},{id:"filter-group-operator:"+id,type:"select",autocomplete:"off",width:"8rem",value:groupOperator,options:[{label:txtTitleCase("and"),value:"and"},{label:txtTitleCase("or"),value:"or"}],optionsColor:"#00aaee",events:{change:function(event){let rootFilter=this.closest(".root-filter");rootFilter.updateFilter()}}}]},{class:"filter-group-content",layout:"vertical",items:[{id:"group-"+id,flex:1,class:"filter-group-items",filters:[]},{type:"spacer",height:"1rem"},{type:"button",text:txtTitleCase("add a filter"),icon:"fas fa-plus",width:"15rem",height:"3rem",events:{click:function(){let filterGroup=this.closest(".filter-group");filterGroup.addFilter({fieldId:"",operator:"=",value:""})}}},{type:"spacer",height:"1rem"}],events:{dragenter:function(event){this.classList.add("filter-group-dragover")},dragover:function(event){event.preventDefault()},dragleave:function(event){if(kiss.tools.isEventInElement(event,this))return;this.classList.remove("filter-group-dragover")},ondrop:function(event){event.stop();kiss.views.removeAndCacheNode(kiss.context.draggedElement.id);kiss.context.draggedElement.render(filterContentId);let rootFilter=event.target.closest(".root-filter");rootFilter.updateFilter()}}}],methods:{toggleDeleteGroupButton:function(visible){let deleteGroupButton=$("filter-group-delete:"+id);return visible?deleteGroupButton.show():deleteGroupButton.hide()},addFilters:function(filters){if(!filters)return;filters.forEach((filterConfig=>{if(filterConfig){if(filterConfig.type=="filter"){this.addFilter(filterConfig)}else{this.addFilterGroup(filterConfig)}}}))},addFilter:function(config){config.target=filterContentId;createDataFilter(viewId,color,config).render()},addFilterGroup:function(config){config.target=filterContentId;config.canDeleteGroup=true;createDataFilterGroup(viewId,color,config).render()},getFilters:function(){let operator=$("filter-group-operator:"+id).getValue();let filterGroup=this.querySelector(".filter-group-items");let filters=[];Array.from(filterGroup.children).forEach((filter=>{if(filter.id.indexOf("filter-group")!=-1){let newGroupFilter=filter.getFilters();if(newGroupFilter==null)return null;filters.push(filter.getFilters())}else{filters.push(filter.getFilter())}}));if(filters.length==0)return null;if(filters.length==1)return filters[0];return{type:"group",id:this.id,operator:operator,filters:filters}},updateFilter(){let newFilterConfig=this.getFilters()||{};kiss.pubsub.publish("EVT_VIEW_FILTERING:"+viewId,newFilterConfig)}}}).render();if(config.filters)filterGroup.addFilters(config.filters);return filterGroup};const createDataFilterWindow=function(viewId,color="#00aaee"){const filterWindowId="filter-selection-for-"+viewId;let filterWindow=createPanel({id:filterWindowId,title:txtTitleCase("filter your data"),icon:"fas fa-filter",headerBackgroundColor:color,minWidth:"80rem",modal:true,draggable:true,closable:true,maxHeight:()=>kiss.screen.current.height-100,align:"center",verticalAlign:"center",overflowY:"auto",zIndex:10,items:[{id:"query-builder-"+viewId}],methods:{load:function(){let fields=$(viewId).collection.model.getFields();let filterGroup={isRootFilter:true,canAddGroup:true,id:viewId,target:"query-builder-"+viewId,fields:fields};let filter=$(viewId).filter||{};if(Object.keys(filter).length!=0){if(filter.type=="filter"){filterGroup.filters=[filter]}else{filterGroup.operator=filter.operator;filterGroup.filters=filter.filters}}createDataFilterGroup(viewId,color,filterGroup)}}});return filterWindow};const createDataSort=function(viewId,fieldId,sortDirection,sortIndex,sortFields,color){return createBlock({class:"data-sorter",layout:"horizontal",alignItems:"center",items:[{id:"sort-delete-for-view-"+viewId+"-index:"+sortIndex,type:"html",width:"20px",html:`<span class="fa fa-times data-sorter-delete"></span>`,events:{click:event=>{let sortIndex=event.target.closest("a-html").id.split(":")[1];kiss.pubsub.publish("EVT_VIEW_SORTING:"+viewId,{sortAction:"remove",sortIndex:sortIndex})}}},{id:"sort-field-for-view-"+viewId+"-index:"+sortIndex,type:"select",label:sortIndex==0?txtTitleCase("sort by"):txt("then by"),width:"50rem",fieldWidth:"30rem",labelWidth:"20rem",labelPosition:"left",value:[fieldId],multiple:false,options:sortFields,optionsColor:color,events:{change:async event=>{let sortDirectionId=event.target.id.replace("field","direction");let sortDirection=$(sortDirectionId).getValue();if(sortDirection=="")sortDirection="asc";kiss.pubsub.publish("EVT_VIEW_SORTING:"+viewId,{sortFieldName:event.target.value,sortDirection:sortDirection,sortIndex:event.target.id.split(":")[1]})}}},{id:"sort-direction-for-view-"+viewId+"-index:"+sortIndex,type:"checkbox",label:txtTitleCase("inverse order"),labelWidth:"20rem",labelPosition:"right",checked:sortDirection=="desc",shape:"switch",iconSize:"2rem",iconColorOn:color,events:{change:async event=>{let isChecked=event.target.getValue();let sortDirection=isChecked?"desc":"asc";let sortFieldId=event.target.id.replace("direction","field");let fieldName=$(sortFieldId).getValue();if(fieldName=="")return;kiss.pubsub.publish("EVT_VIEW_SORTING:"+viewId,{sortFieldName:fieldName,sortDirection:sortDirection,sortIndex:event.target.id.split(":")[1]})}}}]})};const createDataSortWindow=function(viewId,color="#00aaee"){const sortWindowId="sort-selection-for-"+viewId;const sortListId="sort-list-for-"+viewId;const sortFieldId="sort-create-for-view-"+viewId;let sortWindow=createPanel({id:sortWindowId,title:txtTitleCase("sort your data"),icon:"fas fa-sort",headerBackgroundColor:color,modal:true,closable:true,draggable:true,zIndex:10,maxHeight:()=>kiss.screen.current.height-100,align:"center",verticalAlign:"center",overflowY:"auto",layout:"vertical",items:[{id:sortListId,layout:"vertical"},{layout:"horizontal",items:[{id:sortFieldId,type:"select",label:txtTitleCase("select a field to sort by"),width:"50rem",fieldWidth:"30rem",labelWidth:"20rem",labelPosition:"left",margin:"0 0 0 3rem",multiple:false,events:{change:async event=>{kiss.pubsub.publish("EVT_VIEW_SORTING:"+viewId,{viewId:viewId,sortFieldName:event.target.value,sortDirection:"asc",sortIndex:$(viewId).sort.length});$(sortFieldId).resetValue()}}}]}],subscriptions:{"EVT_DB_UPDATE:VIEW":msgData=>{if($(sortWindowId)&&msgData.id==viewId&&msgData.userId!=kiss.session.getUserId())$(sortWindowId).load()},["EVT_VIEW_SORTED:"+viewId]:()=>$(sortWindowId).load()},methods:{load:function(){this.renderExistingOptions()},renderExistingOptions:function(){this.resetExistingOptions();let sortIndex=0;const remainingSortFields=this.getRemainingSortFields();let currentSortConfig=$(viewId).sort||[];currentSortConfig.forEach((sortOption=>{let sortField=Object.keys(sortOption)[0];let sortDirection=sortOption[sortField];createDataSort(viewId,sortField,sortDirection,sortIndex,remainingSortFields,color).render("sort-list-for-"+viewId);sortIndex++}));const sortField=$(sortFieldId);sortField._hideOptions();sortField.updateOptions(remainingSortFields)},resetExistingOptions:()=>$("sort-list-for-"+viewId).deepDelete(false),getRemainingSortFields:function(){const currentSortConfig=$(viewId).sort||[];const currentSortFields=currentSortConfig.map((sortField=>Object.keys(sortField)[0]));let remainingSortFields=[];const model=$(viewId).collection.model;const isDynamicModel=kiss.tools.isUid(model.id);const fields=model.getSortableFields();for(let i=0,length=fields.length;i<length;i++){const field=fields[i];const disabled=!(field.deleted!=true&&currentSortFields.indexOf(field.id)==-1);const needsTranslation=field.isSystem||field.isFromPlugin||field.label.startsWith("#")?true:false;remainingSortFields.push({label:isDynamicModel&&!needsTranslation?field.label.toTitleCase():txtTitleCase(field.label),value:field.id,disabled:disabled})}return remainingSortFields}}});return sortWindow};const createRecordSelectionWindow=function(model,fieldId,records,selectRecord,datatableConfig){if(Array.isArray(records)&&records.length==0)return;const isMobile=kiss.screen.isMobile;let tempModel={};let tempCollection;const useMemory=records?true:false;const tempDatatableId=kiss.tools.shortUid();if(!selectRecord){selectRecord=async function(record){if(kiss.session.isOffline()){let tempRecord=await kiss.db.findOne(model.id,record.id);record=model.create(tempRecord)}createForm(record);this.closest("a-panel").close()}}let responsiveOptions;if(isMobile){responsiveOptions={expandable:false,width:"100%",height:"100%",top:0,left:0,borderRadius:"0 0 0 0",padding:0}}else{responsiveOptions={width:()=>"calc(100vw - 2rem)",height:()=>"calc(100vh - 2rem)"}}createPanel({modal:true,closable:true,title:"<b>"+model.namePlural+"</b>",icon:model.icon,headerBackgroundColor:model.color,display:"flex",layout:"vertical",align:"center",verticalAlign:"center",autoSize:true,background:"var(--body-background)",padding:0,...responsiveOptions,items:[{id:tempDatatableId,flex:1,layout:"vertical"}],events:{onclose:function(){tempCollection.destroy(useMemory)}},methods:{async _afterRender(){if(records&&kiss.session.isOffline()){Object.assign(tempModel,model);tempModel.id=kiss.tools.uid();tempModel=new kiss.data.Model(tempModel)}else{tempModel=model}let viewRecord=kiss.app.collections.view.records.find((view=>view.fieldId==fieldId));let filter={};let sort=[{[model.getPrimaryKeyField().id]:"asc"}];if(viewRecord){if(viewRecord.sort){sort=viewRecord.sort}if(viewRecord.filter){filter=viewRecord.filter}}tempCollection=new kiss.data.Collection({id:"temp_"+uid(),mode:useMemory?"memory":kiss.db.mode,model:tempModel,sort:sort,filter:filter});if(records)await tempCollection.insertMany(records);if(!viewRecord){viewRecord=kiss.app.models.view.create({id:kiss.tools.uid(),type:"datatable",fieldId:fieldId,modelId:model.id,filter:{},sort:[],projection:{},group:[],config:{columns:model.getFieldsAsColumns()},authenticatedCanRead:true});await viewRecord.save()}let config={id:"datatable-"+tempDatatableId,fieldId:fieldId,type:"datatable",collection:tempCollection,record:viewRecord,autoSize:true,showHeader:true,showToolbar:true,showActions:false,showLinks:false,canEdit:false,canAddField:false,canEditField:false,canCreateRecord:false,color:model.color,canSelectFields:isMobile?false:true,canSort:isMobile?false:true,canFilter:isMobile?false:true,canGroup:isMobile?false:true,showGroupButtons:isMobile?false:true,showLayoutButton:isMobile?false:true,showScroller:isMobile?false:true,methods:{selectRecord:selectRecord}};if(datatableConfig)Object.assign(config,datatableConfig);const datatable=createDatatable(config);setTimeout((()=>$(tempDatatableId).setItems([datatable])),50)}}}).render()};const createFileLibraryWindow=async function(config={}){const{type:type="images",actions:actions,callback:callback}=config;let filter={};if(type=="images"){filter={type:"group",operator:"and",filters:[{type:"filter",fieldId:"filename",operator:"is not empty"},{type:"filter",fieldId:"mimeType",operator:"contains",value:"image/"}]}}else{filter={type:"filter",fieldId:"filename",operator:"is not empty"}}const fileCollection=kiss.app.collections.file;await fileCollection.find({filter:filter,sort:[{createdAt:"desc"}]});const library=createGallery({id:"file-library",canCreateRecord:false,showSetup:false,showActions:true,canSearch:false,collection:fileCollection,actions:actions||[],methods:{selectRecord:function(record){if(typeof callback==="function"){callback(record)}}}});createPanel({id:"file-library-window",title:txtTitleCase("file library"),icon:"fas fa-paperclip",modal:true,closable:true,autoSize:true,width:"calc(100vw - 2rem)",height:"calc(100vh - 2rem)",align:"center",verticalAlign:"center",items:[library]}).render()};const createPreviewWindow=function(files,fileId,recordId,fieldId){const isOpenedFromRecord=recordId?true:false;const previewWindow=$("preview-window");let showOnTheSide=localStorage.getItem("config-side-preview")=="true";if(isOpenedFromRecord){if(previewWindow){if(previewWindow.config.recordId==recordId){const isSameField=fieldId==previewWindow.config.fieldId;if(isSameField){previewWindow.openPreview(fileId);return}else{showOnTheSide=previewWindow.showOnTheSide;previewWindow.close()}}else{previewWindow.close()}}}else{if(previewWindow)previewWindow.close()}const disableNavigation=files.length<2||kiss.screen.isMobile&&kiss.screen.isVertical();const createThumbnail=function(file){const fileType=file.filename.split(".").pop().toLowerCase();let viewHtml="";let previewHtml="";let filePath=kiss.tools.createFileURL(file);filePath=filePath.replaceAll("\\","/");if(["jpg","jpeg","jfif","png","gif","webp"].includes(fileType)){viewHtml=`<img class="preview-item" src="${filePath}" loading="lazy">`;previewHtml=`<img class="preview-thumbnail" src="${kiss.tools.createFileURL(file,"s")}" loading="lazy">`}else if(fileType=="pdf"){viewHtml=`<iframe width=100% height=100% frameborder=0 border=0 cellspacing=0 src="${filePath}"/>`;previewHtml=`<span style="color: #ff0000" class="fas fa-file-pdf preview-thumbnail"></span>`}else{const{icon:icon,color:color}=kiss.tools.fileToIcon(fileType);viewHtml=`<span style="color: ${color}" class="fas ${icon} preview-item preview-item-icon"></span>\n                        <div class="preview-not-available">\n                            ${txtTitleCase("#no preview")+" "+fileType}\n                        </div>`;previewHtml=`<span style="color: ${color}" class="fas ${icon} preview-thumbnail"></span>`}return createHtml({id:"preview-file-"+file.id,html:previewHtml,display:"inline-block",class:"preview-thumbnail-item",events:{click:function(){this.select().openPreview()}},methods:{openPreview(){if(kiss.context.fileId==file.id)return;kiss.context.fileId=file.id;$("preview-content").setInnerHtml(viewHtml);$("preview-window").setTitle(file.filename+" ("+file.size.toFileSize()+")");$("preview-window").currentPreview=file.id;const iframe=$("preview-content").querySelector("iframe");if(iframe){iframe.addEventListener("load",(async()=>{try{const bodyContent=iframe.contentDocument.body.innerText;try{const json=JSON.parse(bodyContent);if(json&&json.error){if(json.code===498){if(!await kiss.session.getNewToken()){log("previewWindow - Unable to get a new token to preview the file.");return}let src=iframe.src;iframe.src="";iframe.src=src}}}catch(err){return}}catch(err){}}))}return this},select(){const previewItemElements=$("preview-window").querySelectorAll(".preview-thumbnail");const previewItems=[...previewItemElements];previewItems.forEach((item=>item.classList.remove("preview-thumbnail-selected")));this.querySelector(".preview-thumbnail").classList.add("preview-thumbnail-selected");return this}}})};return createPanel({id:"preview-window",recordId:recordId,fieldId:fieldId,modal:true,closable:true,icon:"fas fa-search",headerHeight:50,headerBackgroundColor:"#555555",background:"#000000",animation:"fadeIn",autoSize:true,position:"absolute",top:showOnTheSide?0:10,left:showOnTheSide?()=>kiss.screen.current.width/2:10,width:showOnTheSide?()=>kiss.screen.current.width/2:()=>kiss.screen.current.width-20+"px",height:showOnTheSide?()=>kiss.screen.current.height:()=>kiss.screen.current.height-20+"px",padding:0,layout:"vertical",items:[{id:"preview-content-container",layout:"horizontal",items:[{hidden:disableNavigation,id:"preview-content-previous",class:"preview-navigation",layout:"vertical",items:[{type:"spacer",flex:1},{type:"html",flex:0,html:`<span class="fas fa-chevron-left preview-navigation-button"></span>`,events:{click:()=>$("preview-window").openPreviousPreview()}},{type:"spacer",flex:1}]},{id:"preview-content",width:"100%",height:()=>{if(disableNavigation)return kiss.screen.getHeightMinus(80)+"px";return kiss.screen.getHeightMinus(160)+"px"},class:"preview-item-container"},{hidden:disableNavigation,id:"preview-content-next",class:"preview-navigation",layout:"vertical",items:[{type:"spacer",flex:1},{type:"html",flex:0,html:`<span class="fas fa-chevron-right preview-navigation-button"></span>`,events:{click:()=>$("preview-window").openNextPreview()}},{type:"spacer",flex:1}]}]},{hidden:disableNavigation,id:"preview-thumbnails",class:"preview-thumbnails-container",items:files.filter((file=>file.path)).map(createThumbnail)}],events:{onclick:function(){if(disableNavigation)this.close()},mousewheel:function(event){if(disableNavigation)return;if(event.wheelDelta<0)this.openNextPreview();else this.openPreviousPreview()},keydown:function(event){if(event.key=="Escape")$("preview-window").close();if(disableNavigation)return;if(event.key=="ArrowRight")return this.openNextPreview();if(event.key=="ArrowLeft")return this.openPreviousPreview()},close:function(){if($("preview-window"))$("preview-window").resetFormPosition();delete kiss.context.fileId}},subscriptions:{EVT_FORM_OPENED:function(){this.close()},EVT_FORM_CLOSED:function(){this.close()}},methods:{load(){this.openPreview(fileId);if(showOnTheSide){this.showFormOnTheSide();this.showPreviewOnTheSide()}},openPreview(fileId){const thumbnail=$("preview-file-"+fileId);thumbnail.select().openPreview();setTimeout((()=>thumbnail.scrollIntoView({block:"center",inline:"center",behavior:"smooth"})),200)},openNextPreview(){const currentPreviewId=$("preview-window").currentPreview;let previewIndex=files.findIndex((item=>item.id==currentPreviewId));previewIndex++;if(previewIndex>=files.length)previewIndex=0;const newPreviewId=files[previewIndex].id;$("preview-window").openPreview(newPreviewId)},openPreviousPreview(){const currentPreviewId=$("preview-window").currentPreview;let previewIndex=files.findIndex((item=>item.id==currentPreviewId));previewIndex--;if(previewIndex<0)previewIndex=files.length-1;const newPreviewId=files[previewIndex].id;$("preview-window").openPreview(newPreviewId)},switchDisplayMode(){if(this.showOnTheSide!=true){this.showPreviewOnTheSide();this.showFormOnTheSide()}else{this.resetPreviewPosition();this.resetFormPosition()}},showPreviewOnTheSide(){this.showOnTheSide=true;localStorage.setItem("config-side-preview",true);$("preview-window").hideMask().setWidth((()=>kiss.screen.current.width/2)).setHeight((()=>kiss.screen.current.height)).setTop((()=>0)).setLeft((()=>kiss.screen.current.width/2))},showFormOnTheSide(){if($(recordId)){$(recordId).setWidth((()=>kiss.screen.current.width/2)).setHeight((()=>kiss.screen.current.height)).setTop((()=>0)).setLeft((()=>0))}},resetPreviewPosition(){this.showOnTheSide=false;localStorage.setItem("config-side-preview",false);$("preview-window").showMask().setWidth((()=>kiss.screen.current.width-20)).setHeight((()=>kiss.screen.current.height-20)).setTop(10).setLeft(10)},resetFormPosition(){if($(recordId)){const newFormPosition=$(recordId).computeFormPosition();$(recordId).setWidth(newFormPosition.width).setHeight(newFormPosition.height).setTop(newFormPosition.top).setLeft(newFormPosition.left)}}}}).render()};const createFileUploadBox=function(ACL="private",multiple=true){const BOX_COM_SELECT="https://app.box.com/js/static/select";const BOX_COM_PICKER="https://cdn01.boxcdn.net/platform/elements/13.0.0/en-US/picker";const BOX_COM_PICKER_CSS="https://cdn01.boxcdn.net/platform/elements/13.0.0/en-US/picker";const boxClientID="s4mkchshoxquwjquomli1dneiwysp2oa";const boxAuthenticationUrl=`https://www.box.com/api/oauth2/authorize?client_id=${boxClientID}&response_type=code&state=${kiss.session.getUserId()}&redirect_uri=${encodeURIComponent(window.location.origin+"/boxConnect")}`;const checkTokenUrl="https://api.box.com/2.0/folders/0?fields=id&limit=1&offset=0";const logoUrl=kiss.global.absolutePath?kiss.global.absolutePath+"/client/pickaform/resources/img/logo 32x32.png":"./resources/img/logo 32x32.png";let filePicker;return createBlock({id:"file-upload-box",flex:1,layout:"vertical",items:[{hidden:true,type:"html",html:`<input id="field-upload-box" type="file" ${multiple?"multiple":""}>`},{id:"upload-box-gallery",layout:"vertical",alignItems:"center",overflow:"auto",flex:1,class:"upload-gallery",items:[{id:"upload-box-gallery-help",type:"html",margin:"auto",html:txtTitleCase("#upload drive help",null,{drive:"Box"})+`<br>`+`<center><button class="a-button box-authentication-button" onclick="$('file-upload-box').connect()">${txtTitleCase("connect to your %drive account",null,{drive:"Box"})}</button></center>`},{id:"upload-box-gallery-items",class:"upload-gallery-items"},{id:"upload-box-picker",hidden:true,class:"upload-box-picker"}]},{layout:"horizontal",class:"upload-button-bar",defaultConfig:{height:36,margin:"0px 0px 0px 10px"},items:[{type:"spacer",flex:1},{hidden:true,id:"upload-box-button",type:"button",text:txtTitleCase("Upload"),icon:"fas fa-upload",iconColor:"#ffffff",iconColorHover:"#000000",color:"#ffffff",colorHover:"#000000",backgroundColor:"#00aaee",backgroundColorHover:"#ffffff",action:()=>$("file-upload").upload("box",(function(){$("upload-box-picker").show();$("upload-box-gallery-help").hide()}))},{hidden:true,id:"upload-box-ACL",type:"checkbox",iconColorOn:"var(--blue)",iconOff:"fas fa-lock",iconOn:"fas fa-lock-open",width:32,value:ACL=="private"?false:true}]}],subscriptions:{EVT_BOX_CODE:msgData=>{localStorage.setItem("api-boxAccessToken",msgData.token);$("file-upload-box").showBoxFilePicker()}},methods:{_afterShow:function(){let boxAccessToken=localStorage.getItem("api-boxAccessToken");if(!boxAccessToken)return;fetch(checkTokenUrl,{method:"get",headers:{Authorization:"Bearer "+boxAccessToken}}).then((()=>{this.showBoxFilePicker()})).catch((()=>{}))},connect(){const height=800,width=500;const y=window.top.outerHeight/2+window.top.screenY-height/2;const x=window.top.outerWidth/2+window.top.screenX-width/2;const win=window.open(boxAuthenticationUrl,"BoxLogin",`location,toolbar=no,menubar=no,fullscreen=no,`+`height=${height}px,width=${width}px,top=${y},left=${x}`);const timer=setInterval((()=>{try{win.document}catch(err){return}if(!window.localStorage.getItem("api-boxAccessToken"))return;if(win.closed)this.showBoxFilePicker();else{win.addEventListener("beforeunload",(()=>{if(window.localStorage.getItem("api-boxAccessToken")){this.showBoxFilePicker()}}));win.close()}clearInterval(timer)}),500);return win},async showBoxFilePicker(){if(!window.Box){const loadingId=kiss.loadingSpinner.show();await kiss.loader.loadScript(BOX_COM_SELECT);await kiss.loader.loadScript(BOX_COM_PICKER);await kiss.loader.loadStyle(BOX_COM_PICKER_CSS);kiss.loadingSpinner.hide(loadingId)}const FilePicker=Box.FilePicker;$("upload-box-gallery-help").hide();$("upload-box-gallery-items").innerHTML=" ";if(filePicker){$("upload-box-picker").show();return}filePicker=new FilePicker({container:".upload-box-picker"});let boxAccessToken=localStorage.getItem("api-boxAccessToken");filePicker.show("0",boxAccessToken,{container:".upload-box-picker",canUpload:false,canCreateNewFolder:false,canSetShareAccess:false,logoUrl:logoUrl});$("upload-box-picker").show();filePicker.addListener("choose",(function(items){$("upload-box-picker").hide();kiss.ajax.request({url:"/boxFileDetail",method:"post",body:JSON.stringify({items:items,token:boxAccessToken})}).then((async response=>{let files=response.result.map((file=>({data:{result:file.fileData,status:"success"},name:file.name})));files.forEach((file=>$("file-upload").previewBase64File(file.data,file.name,"box")))}))}));filePicker.addListener("cancel",(function(){$("upload-box-gallery-help").show();$("upload-box-picker").hide()}))}}})};kiss.app.defineView({id:"box-session",renderer:function(id,target){return createPanel({id:id,target:target,title:txtTitleCase("box.com"),icon:"fas fa-box",draggable:true,align:"center",verticalAlign:"center",items:[{type:"html",html:txt("<center>Thank you!<br>Your Box session has been restored.<br></center>"),padding:"50px"}],methods:{load:()=>{window.close()}}})}});const createFileUploadDropbox=function(ACL="private",multiple=true){const DROPBOX_SRC="https://www.dropbox.com/static/api/2/dropins";const DROPBOX_ID="dropboxjs";const DROPBOX_APP_KEY="hfxz6unvbi6tfyp";const dropBoxOptions={success:function(files){$("file-upload-dropbox").downloadFilesFromDropbox(files)},cancel:function(){log("Attach file request cancelled by the user")},linkType:"direct",multiselect:multiple,sizeLimit:1024*1024*8};return createBlock({id:"file-upload-dropbox",flex:1,layout:"vertical",items:[{hidden:true,type:"html",html:`<input id="field-upload-dropbox" type="file" ${multiple?"multiple":""}>`},{id:"upload-dropbox-gallery",layout:"vertical",alignItems:"center",overflow:"auto",flex:1,class:"upload-gallery",items:[{id:"upload-dropbox-gallery-help",type:"html",margin:"auto",html:txtTitleCase("#upload drive help",null,{drive:"Dropbox"})+`<br>`+`<center><div id="dropbox-btn" class="upload-dropbox-button"></div></center>`},{id:"upload-dropbox-gallery-items",class:"upload-gallery-items"}]},{layout:"horizontal",class:"upload-button-bar",defaultConfig:{height:36,margin:"0px 0px 0px 10px"},items:[{type:"spacer",flex:1},{hidden:true,id:"upload-dropbox-button",type:"button",text:txtTitleCase("Upload"),icon:"fas fa-upload",iconColor:"#ffffff",iconColorHover:"#000000",color:"#ffffff",colorHover:"#000000",backgroundColor:"#00aaee",backgroundColorHover:"#ffffff",action:()=>$("file-upload").upload("dropbox")},{hidden:true,id:"upload-dropbox-ACL",type:"checkbox",iconColorOn:"var(--blue)",iconOff:"fas fa-lock",iconOn:"fas fa-lock-open",width:32,value:ACL=="private"?false:true}]}],methods:{_afterShow:async function(){if(!window.Dropbox){const loadingId=kiss.loadingSpinner.show();await kiss.loader.loadScript(DROPBOX_SRC,{id:DROPBOX_ID,"data-app-key":DROPBOX_APP_KEY});kiss.loadingSpinner.hide(loadingId)}const dropBoxButton=Dropbox.createChooseButton(dropBoxOptions);$("dropbox-btn").appendChild(dropBoxButton)},downloadFilesFromDropbox(filesData){filesData.forEach((fileData=>this.downloadFileFromDropbox(fileData)))},async downloadFileFromDropbox(fileObject){const fileName=fileObject.link.split("/").pop();kiss.ajax.request({url:"/urlToBase64",method:"post",showLoading:true,body:JSON.stringify({url:fileObject.link})}).then((async data=>$("file-upload").previewBase64File(data,fileName,"dropbox"))).catch((err=>console.log("File upload: ",err)))}}})};const createFileUploadGoogleDrive=function(ACL="private",multiple=true){const GOOGLE_AUTH_SRC="https://accounts.google.com/gsi/client";const GOOGLE_DRIVE_SRC="https://apis.google.com/js/api";const scope="https://www.googleapis.com/auth/drive.readonly";const appId="pickaform-apps-1668670210366";const client_id="325367213155-k97e6u17n0jq2185f8gnju04qs4afos3.apps.googleusercontent.com";let tokenClient;let accessToken=null;let pickerInitialized=false;let driveInitialized=false;let gisInitialized=false;function apiLoaded(){gapi.load("picker",onPickerApiLoad);gapi.load("client",onClientLoaded)}function onPickerApiLoad(){pickerInitialized=true}function onClientLoaded(){gapi.client.load("drive","v2",onDriveApiLoad)}function onDriveApiLoad(){driveInitialized=true}function gisLoaded(){tokenClient=google.accounts.oauth2.initTokenClient({client_id:client_id,scope:scope,callback:""});gisInitialized=true}return createBlock({id:"file-upload-googledrive",flex:1,layout:"vertical",items:[{hidden:true,type:"html",html:`<input id="field-upload-googledrive" type="file" ${multiple?"multiple":""}>`},{id:"upload-googledrive-gallery",layout:"vertical",alignItems:"center",overflow:"auto",flex:1,class:"upload-gallery",items:[{id:"upload-googledrive-gallery-help",type:"html",margin:"auto",html:txtTitleCase("#upload drive help",null,{drive:"Google Drive"})+`<br>`+`<center><button class="a-button box-authentication-button" onclick="$('file-upload-googledrive').connect()">${txtTitleCase("connect to your %drive account",null,{drive:"Google Drive"})}</button></center>`},{id:"upload-googledrive-gallery-items",class:"upload-gallery-items"}]},{layout:"horizontal",class:"upload-button-bar",defaultConfig:{height:36,margin:"0px 0px 0px 10px"},items:[{type:"spacer",flex:1},{hidden:true,id:"upload-googledrive-button",type:"button",text:txtTitleCase("Upload"),icon:"fas fa-upload",iconColor:"#ffffff",iconColorHover:"#000000",color:"#ffffff",colorHover:"#000000",backgroundColor:"#00aaee",backgroundColorHover:"#ffffff",action:()=>$("file-upload").upload("googledrive")},{hidden:true,id:"upload-googledrive-ACL",type:"checkbox",iconColorOn:"var(--blue)",iconOff:"fas fa-lock",iconOn:"fas fa-lock-open",width:32,value:ACL=="private"?false:true}]}],methods:{_afterShow:async function(){if(!window.google){const loadingId=kiss.loadingSpinner.show();await kiss.loader.loadScript(GOOGLE_AUTH_SRC,{autoAddExtension:false});await kiss.loader.loadScript(GOOGLE_DRIVE_SRC);kiss.loadingSpinner.hide(loadingId)}apiLoaded();gisLoaded()},showPicker(){const view=new google.picker.DocsView(google.picker.ViewId.DOCS);const mimeTypeArray=["image/png","image/jpeg","image/jpg","application/msword","application/pdf","text/xml","application/vnd.ms-excel","text/plain","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint"];view.setIncludeFolders(true).setSelectFolderEnabled(false).setMimeTypes(mimeTypeArray);const picker=(new google.picker.PickerBuilder).enableFeature(google.picker.Feature.NAV_HIDDEN).enableFeature(google.picker.Feature.MULTISELECT_ENABLED).setOAuthToken(accessToken).setAppId(appId).addView(view).setCallback(this.pickerCallback).build();picker.setVisible(true)},connect(){this.createPicker()},createPicker(){tokenClient.callback=async response=>{if(response.error!==undefined)throw response;accessToken=response.access_token;this.showPicker()};if(accessToken===null){tokenClient.requestAccessToken({prompt:"consent"})}else{tokenClient.requestAccessToken({prompt:""})}},async pickerCallback(data){if(data.action==google.picker.Action.PICKED){let allDocumentData=await Promise.all(data.docs.map((async doc=>await $("file-upload-googledrive").getFilesObject(doc))));$("file-upload").fileSetter(allDocumentData,"googledrive");$("file-upload").previewFiles(allDocumentData,"googledrive")}},async getFilesObject(files){let res=await window.gapi.client.drive.files.get({fileId:files.id,alt:"media"});const dataUrl="data:"+res.headers["Content-Type"]+";base64,"+window.btoa(res.body);return $("file-upload").dataURLtoFile(dataUrl,files.name)}}})};const createFileUploadInstagram=function(ACL="private",multiple=true){const instagramOption={baseUrl:"https://api.instagram.com/oauth/authorize",clientId:"3985518578229875",redirectUrl:"https://449abdd7f2cf.ngrok.io/instagramOauth",nextPage:"",images:[]};return createBlock({id:"file-upload-instagram",flex:1,layout:"vertical",items:[{hidden:true,type:"html",html:`<input id="field-upload-instagram" type="file" ${multiple?"multiple":""}>`},{id:"upload-instagram-gallery",layout:"vertical",alignItems:"center",overflow:"auto",flex:1,class:"upload-gallery",items:[{id:"upload-instagram-gallery-help",type:"html",margin:"auto",html:txtTitleCase("#upload drive help",null,{drive:"Instagram"})+`<br>`+`<center><button class="a-button box-authentication-button" onclick="$('file-upload-instagram').connect()">${txtTitleCase("connect to your %drive account",null,{drive:"Instagram"})}</button></center>`},{hidden:true,id:"upload-instagram-preview-items",class:"upload-preview-items"},{id:"upload-instagram-gallery-items",class:"upload-gallery-items"}]},{layout:"horizontal",class:"upload-button-bar",defaultConfig:{height:36,margin:"0px 0px 0px 10px"},items:[{type:"spacer",flex:1},{hidden:true,id:"load-instagram-button",type:"button",text:txtTitleCase("Load more files"),icon:"fas fa-plus",iconColorHover:"#00aaee",action:event=>$("file-upload-instagram").loadMoreFiles(event)},{hidden:true,id:"add-instagram-button",type:"button",text:txtTitleCase("Add files from Instagram"),icon:"fas fa-plus",iconColorHover:"#00aaee",action:event=>$("file-upload-instagram").addImagesFromInstagram(event)},{hidden:true,id:"upload-instagram-button",type:"button",text:txtTitleCase("Upload"),icon:"fas fa-upload",iconColor:"#ffffff",iconColorHover:"#000000",color:"#ffffff",colorHover:"#000000",backgroundColor:"#00aaee",backgroundColorHover:"#ffffff",action:()=>$("file-upload").upload("instagram")},{hidden:true,id:"upload-instagram-ACL",type:"checkbox",iconColorOn:"var(--blue)",iconOff:"fas fa-lock",iconOn:"fas fa-lock-open",width:32,value:ACL=="private"?false:true}]}],subscriptions:{EVT_INSTAGRAM_CODE:msgData=>{localStorage.setItem("api-instagramAccessToken",msgData.token);$("file-upload-instagram").getInstagramFeeds()}},methods:{connect(){let boxAccessToken=localStorage.getItem("api-instagramAccessToken");if(!boxAccessToken)return window.open("https://api.instagram.com/oauth/authorize?client_id="+instagramOption.clientId+"&scope=user_profile,user_media&response_type=code&state="+kiss.session.getUserId()+"&redirect_uri="+instagramOption.redirectUrl,"_blank");$("file-upload-instagram").getInstagramFeeds()},getInstagramFeeds(){let instagramAccessToken=localStorage.getItem("api-instagramAccessToken");fetch("/instagramMedia",{method:"post",body:JSON.stringify({access_token:instagramAccessToken})}).then((response=>response.json())).then((response=>{if(response.result){const dataset=response.result.data;if(response.result.paging&&response.result.paging.next){instagramOption.nextPage=response.result.paging.next;$("load-instagram-button").show()}dataset.map((i=>instagramOption.images.push(i)));$("upload-instagram-preview-items").show();$("add-instagram-button").show();$("upload-instagram-gallery-items").hide();const preview=instagramOption.images.map(this.buildImagePreview).join("");$("upload-instagram-preview-items").setInnerHtml(preview);$("upload-instagram-gallery-help").hide()}})).catch((err=>("Something went wrong please check and try again.",err)))},buildImagePreview(file){if(file.media_type=="VIDEO"){return`<video controls src="${file.media_url}" class="upload-preview-item" onclick="$('file-upload-instagram').selectImagePreview(event)"><source src="${file.media_url}"></video>`}else{return`<img src="${file.media_url}" class="upload-preview-item" onclick="$('file-upload-instagram').selectImagePreview(event)" loading="lazy">`}},selectImagePreview(event){const image=event.target;image.classList.toggle("upload-instagram-item-selected")},addImagesFromInstagram(event){event.preventDefault();const token=kiss.session.getToken();const selectedImages=document.querySelectorAll(".upload-instagram-item-selected");const images=[...selectedImages].map((image=>{var fileName=image.getAttribute("src").split("/").pop();fileName=fileName.split("?")[0];return{image:image.getAttribute("src"),name:fileName}}));kiss.ajax.request({url:"/multiUrlToBase64",method:"post",showLoading:true,body:JSON.stringify({url:images})}).then((async response=>{$("upload-instagram-preview-items").hide();$("add-instagram-button").hide();$("upload-instagram-gallery-items").show();allDocumentData=response.result;allDocumentData.forEach((data=>$("file-upload").previewBase64File({result:data.fileData,status:"success"},data.name,"instagram")))})).catch((err=>("Error occured ",err)))},loadMoreFiles(event){event.preventDefault();fetch(instagramOption.nextPage,{method:"get"}).then((response=>response.json())).then((response=>{const dataset=response.data;paging=response.paging;if(response.paging&&response.paging.next){instagramOption.nextPage=response.paging.next;$("load-instagram-button").show()}else{instagramOption.nextPage="";$("load-instagram-button").hide()}dataset.map((i=>instagramOption.images.push(i)));const preview=instagramOption.images.map(this.buildImagePreview).join("");$("upload-instagram-preview-items").setInnerHtml(preview)})).catch((err=>("Something went wrong please check and try again.",err)))}}})};kiss.app.defineView({id:"instagram-session",renderer:function(id,target){return createPanel({id:id,target:target,title:txtTitleCase("instagram.com"),icon:"fas fa-instagram",draggable:true,align:"center",verticalAlign:"center",items:[{type:"html",html:txt("<center>Thank you!<br>Your instagram session has been restored.<br>You can close this page.</center>"),padding:"50px"}]})}});const createFileUploadLink=function(ACL="private",multiple=true){return createBlock({id:"file-upload-link",flex:1,layout:"vertical",items:[{hidden:true,type:"html",html:`<input id="field-upload-link" type="file" ${multiple?"multiple":""}>`},{id:"upload-link-gallery",layout:"vertical",alignItems:"center",overflow:"auto",flex:1,class:"upload-gallery",items:[{id:"upload-link-gallery-help",type:"html",margin:"auto",html:txtTitleCase("#upload link help")},{id:"upload-link-gallery-items",class:"upload-gallery-items"}]},{layout:"horizontal",class:"upload-button-bar",defaultConfig:{height:36,margin:"0px 0px 0px 10px"},items:[{id:"upload-link-url",type:"text",placeholder:txtTitleCase("enter an URL here"),padding:"0px",fieldWidth:300},{type:"button",text:txtTitleCase("add file from URL"),icon:"fas fa-link",iconColorHover:"#00aaee",action:function(event){$("file-upload-link").downloadFileFromUrl(event);$("upload-link-url").setValue("")}},{type:"spacer",flex:1},{hidden:true,id:"upload-link-button",type:"button",text:txtTitleCase("upload"),icon:"fas fa-upload",iconColor:"#ffffff",iconColorHover:"#000000",color:"#ffffff",colorHover:"#000000",backgroundColor:"#00aaee",backgroundColorHover:"#ffffff",action:()=>$("file-upload").upload("link")},{hidden:true,id:"upload-link-ACL",type:"checkbox",iconColorOn:"var(--blue)",iconOff:"fas fa-lock",iconOn:"fas fa-lock-open",width:32,value:ACL=="private"?false:true}]}],methods:{downloadFileFromUrl(event){event.preventDefault();const ImageUrl=$("upload-link-url").getValue();if(!ImageUrl)return;const fileName=ImageUrl.split("/").pop();kiss.ajax.request({url:"/urlToBase64",method:"post",showLoading:true,body:JSON.stringify({url:ImageUrl})}).then((async data=>$("file-upload").previewBase64File(data,fileName,"link"))).catch((err=>console.log("File upload: ",err)))}}})};const createFileUploadLocal=function(ACL="private",multiple=true){return createBlock({id:"file-upload-local",flex:1,layout:"vertical",items:[{hidden:true,type:"html",html:`<input id="field-upload-local" type="file" ${multiple?"multiple":""} onchange="$('file-upload').previewFiles(this.files, 'local')">`},{id:"upload-local-gallery",layout:"vertical",overflow:"auto",alignItems:"center",flex:1,class:"upload-gallery",items:[{id:"upload-local-gallery-help",type:"html",display:"flex",flexFlow:"column",alignItems:"center",justifyContent:"flex-end",flex:1,html:kiss.screen.isMobile?txtTitleCase("#upload local help mobile"):txtTitleCase("#upload local help")},{id:"upload-local-gallery-items",class:"upload-gallery-items"}],events:{dragover:function(e){e.preventDefault();this.classList.add("upload-gallery-dragover")},dragleave:function(){this.classList.remove("upload-gallery-dragover")},drop:function(e){e.preventDefault();this.classList.remove("upload-gallery-dragover");$("file-upload-local").handleDrop(e)}}},{layout:kiss.screen.isMobile?"vertical":"horizontal",class:"upload-button-bar",defaultConfig:{margin:"10px 10px 0px 0px",iconColorHover:"#00aaee"},items:[{type:"spacer",flex:1},{type:"button",text:txtTitleCase("select files to upload"),icon:"fas fa-file-alt",action:()=>$("field-upload-local").click()},{layout:"horizontal",width:"100%",items:[{hidden:true,id:"upload-local-button",type:"button",text:txtTitleCase("Upload"),icon:"fas fa-upload",iconColor:"#ffffff",iconColorHover:"#000000",color:"#ffffff",colorHover:"#000000",backgroundColor:"#00aaee",backgroundColorHover:"#ffffff",flex:1,action:()=>$("file-upload").upload("local")},{hidden:true,id:"upload-local-ACL",type:"checkbox",tip:txtTitleCase("#upload security mode"),iconColorOn:"var(--blue)",iconOff:"fas fa-lock",iconOn:"fas fa-lock-open",width:50,value:ACL=="private"?false:true}]}]}],methods:{handleDrop:function(event){const files=event.dataTransfer.files;$("field-upload-local").files=files;$("file-upload").previewFiles(files,"local")}}})};const createFileUploadOneDrive=function(ACL="private",multiple=true){const oneDriveOption={clientId:"9f2e6664-61f3-412b-b1ea-5aa4c7411876",action:"download",multiSelect:true,redirectUri:window.location.host+"/fake",openInNewWindow:true,advanced:{queryParameters:"select=id,name,size,file,folder,photo,@microsoft.graph.downloadUrl"},success:function(files){$("file-upload-onedrive").downloadFilesFromOneDrive(files.value)}};return createBlock({id:"file-upload-onedrive",flex:1,layout:"vertical",items:[{hidden:true,type:"html",html:`<input id="field-upload-onedrive" type="file" ${multiple?"multiple":""}>`},{id:"upload-onedrive-gallery",layout:"vertical",alignItems:"center",overflow:"auto",flex:1,class:"upload-gallery",items:[{id:"upload-onedrive-gallery-help",type:"html",margin:"auto",html:txtTitleCase("#upload drive help",null,{drive:"One Drive"})+`<br>`+`<center><button class="a-button box-authentication-button" onclick="$('file-upload-onedrive').connect()">${txtTitleCase("connect to your %drive account",null,{drive:"One Drive"})}</button></center>`},{id:"upload-onedrive-gallery-items",class:"upload-gallery-items"}]},{layout:"horizontal",class:"upload-button-bar",defaultConfig:{height:36,margin:"0px 0px 0px 10px"},items:[{type:"spacer",flex:1},{hidden:true,id:"upload-onedrive-button",type:"button",text:txtTitleCase("Upload"),icon:"fas fa-upload",iconColor:"#ffffff",iconColorHover:"#000000",color:"#ffffff",colorHover:"#000000",backgroundColor:"#00aaee",backgroundColorHover:"#ffffff",action:()=>$("file-upload").upload("onedrive")},{hidden:true,id:"upload-onedrive-ACL",type:"checkbox",iconColorOn:"var(--blue)",iconOff:"fas fa-lock",iconOn:"fas fa-lock-open",width:32,value:ACL=="private"?false:true}]}],methods:{async connect(){const ONE_DRIVE_SRC="https://js.live.net/v7.0/OneDrive";if(!window.OneDrive){const loadingId=kiss.loadingSpinner.show();await kiss.loader.loadScript(ONE_DRIVE_SRC);kiss.loadingSpinner.hide(loadingId)}setTimeout((()=>OneDrive.open(oneDriveOption)),500)},downloadFilesFromOneDrive(filesData){let selectedImage=[];for(let files of filesData){selectedImage.push({image:files["@microsoft.graph.downloadUrl"],thumb:files.thumbnails[0].medium["url"],name:files.name})}kiss.ajax.request({url:"/multiUrlToBase64",method:"post",showLoading:true,body:JSON.stringify({url:selectedImage})}).then((async response=>{allDocumentData=response.result;allDocumentData.forEach((data=>$("file-upload").previewBase64File({result:data.fileData,status:"success"},data.name,"onedrive")))})).catch((err=>("Error occured ",err)))}}})};const createFileUploadTakePhoto=function(ACL="private",multiple=true){return createBlock({id:"file-upload-takephoto",flex:1,layout:"vertical",items:[{hidden:true,type:"html",html:`<input id="field-upload-takephoto" type="file" ${multiple?"multiple":""}>`},{id:"upload-takephoto-gallery",layout:"vertical",alignItems:"center",overflow:"auto",flex:1,class:"upload-gallery",items:[{id:"upload-takephoto-gallery-help",type:"html",margin:"auto",html:txtTitleCase("#upload webcam help")},{id:"upload-takephoto"},{id:"upload-takephoto-preview-items",class:"upload-preview-items"},{id:"upload-takephoto-gallery-items",class:"upload-gallery-items"}]},{layout:"horizontal",class:"upload-button-bar",defaultConfig:{height:36,margin:"0px 0px 0px 10px"},items:[{type:"spacer",flex:1},{type:"button",text:txtTitleCase("open webcam"),icon:"fas fa-camera",iconColorHover:"#00aaee",action:async function(){$("upload-takephoto-gallery-help").hide();await $("file-upload-takephoto").connect();$("upload-takephoto").show();$("upload-takephoto-gallery-items").hide()}},{type:"button",text:txtTitleCase("#take photo"),icon:"fas fa-plus",iconColorHover:"#00aaee",action:async function(){await $("file-upload-takephoto").addImagesFromWebConnect();$("upload-takephoto").hide();$("upload-takephoto-gallery-items").show("")}},{hidden:true,id:"upload-takephoto-button",type:"button",text:txtTitleCase("Upload"),icon:"fas fa-upload",iconColor:"#ffffff",iconColorHover:"#000000",color:"#ffffff",colorHover:"#000000",backgroundColor:"#00aaee",backgroundColorHover:"#ffffff",action:()=>$("file-upload").upload("takephoto")},{hidden:true,id:"upload-takephoto-ACL",type:"checkbox",iconColorOn:"var(--blue)",iconOff:"fas fa-lock",iconOn:"fas fa-lock-open",width:32,value:ACL=="private"?false:true}]}],methods:{async connect(){if(!window.Webcam){const loadingId=kiss.loadingSpinner.show();await kiss.loader.loadScript("./resources/webcam/webcam.min");kiss.loadingSpinner.hide(loadingId)}Webcam.set({width:450,height:400,image_format:"jpeg",jpeg_quality:90});Webcam.attach($("upload-takephoto"))},async addImagesFromWebConnect(){if(!window.Webcam){const loadingId=kiss.loadingSpinner.show();await kiss.loader.loadScript("./resources/webcam/webcam.min");kiss.loadingSpinner.hide(loadingId)}Webcam.snap((function(data_uri){Webcam.reset($("upload-takephoto"));$("file-upload").previewBase64File({result:data_uri,status:"success"},Date.now()+"capture.jpeg","takephoto")}))}}})};const createFileUploadWebSearch=function(ACL="private",multiple=true){return createBlock({id:"file-upload-websearch",flex:1,layout:"vertical",items:[{hidden:true,type:"html",html:`<input id="field-upload-websearch" type="file" ${multiple?"multiple":""}>`},{id:"upload-websearch-gallery",layout:"vertical",alignItems:"center",overflow:"auto",flex:1,class:"upload-gallery",items:[{id:"upload-websearch-gallery-help",type:"html",margin:"auto",html:txtTitleCase("#upload web search help")},{id:"upload-websearch-preview-items",class:"upload-preview-items"},{id:"upload-websearch-gallery-items",class:"upload-gallery-items"}]},{layout:"horizontal",class:"upload-button-bar",defaultConfig:{height:36,margin:"0px 0px 0px 10px"},items:[{id:"upload-websearch-url",type:"text",placeholder:txtTitleCase("enter your search term and press Enter"),padding:"0px",fieldWidth:300,events:{onkeypress:function(event){if(event.key=="Enter"){$("file-upload-websearch").downloadFileFromWebSearch(event);$("upload-websearch-preview-items").show();$("upload-websearch-gallery-items").hide();$("upload-websearch-url").setValue("")}}}},{type:"button",text:txtTitleCase("add images from Web search"),icon:"fas fa-plus",iconColorHover:"#00aaee",action:event=>$("file-upload-websearch").addImagesFromWebSearch(event)},{type:"spacer",flex:1},{hidden:true,id:"upload-websearch-button",type:"button",text:txtTitleCase("upload"),icon:"fas fa-upload",iconColor:"#ffffff",iconColorHover:"#000000",color:"#ffffff",colorHover:"#000000",backgroundColor:"#00aaee",backgroundColorHover:"#ffffff",action:()=>$("file-upload").upload("websearch")},{hidden:true,id:"upload-websearch-ACL",type:"checkbox",iconColorOn:"var(--blue)",iconOff:"fas fa-lock",iconOn:"fas fa-lock-open",width:32,value:ACL=="private"?false:true}]}],methods:{async downloadFileFromWebSearch(event){event.preventDefault();const search=$("upload-websearch-url").getValue();if(!search)return;$("upload-websearch-gallery").showLoading();try{const response=await kiss.ajax.request({url:"/googleImageSearch",method:"post",body:JSON.stringify({search:search})});if(!response)return;console.log(response);const webImages=(response.result||[]).map((item=>({url:item.link,thumbnail:item.image.thumbnailLink,snippet:item.title,context:item.image.contextLink})));const preview=webImages.map(this.buildImagePreview).join("");$("upload-websearch-preview-items").setInnerHtml(preview)}catch(err){log("kiss.fileUpload.googleWebSearch - Error while trying to upload file: ",4,err)}finally{$("upload-websearch-gallery").hideLoading();$("upload-websearch-gallery-help").hide()}},buildImagePreview(file){return`<img src="${file.thumbnail}" fullSizeImage="${file.url}" class="upload-preview-item" onclick="$('file-upload-websearch').selectImagePreview(event)" loading="lazy">`},selectImagePreview(event){const image=event.target;image.classList.toggle("upload-preview-item-selected")},addImagesFromWebSearch(event){event.preventDefault();const selectedImages=document.querySelectorAll(".upload-preview-item-selected");const images=[...selectedImages].map((image=>({image:image.getAttribute("fullSizeImage"),thumb:image.src})));kiss.ajax.request({url:"/multiUrlToBase64",method:"post",body:JSON.stringify({url:images})}).then((async response=>{$("upload-websearch-preview-items").hide();$("upload-websearch-gallery-items").show();$("upload-websearch-button").show();let files=response.result.map(((file,i)=>{let fileExtension=file.fileData.split(";")[0].split("/")[1];return{data:{result:file.fileData,status:"success"},name:"WebImage_"+i+"."+fileExtension}}));files.forEach((file=>$("file-upload").previewBase64File(file.data,file.name,"websearch")))}))}}})};const createFileUploadWindow=function(config={}){const ACL=config.ACL||"private";const multiple=config.multiple===false?false:true;const uploadServices={local:txtTitleCase("my device"),link:txtTitleCase("link (URL)"),websearch:txtTitleCase("web search"),dropbox:txtTitleCase("dropbox"),box:txtTitleCase("box"),googledrive:txtTitleCase("google drive"),onedrive:txtTitleCase("one Drive"),instagram:txtTitleCase("instagram"),takephoto:txtTitleCase("take photo")};return createPanel({id:"file-upload",title:txtTitleCase("upload files"),headerBackgroundColor:kiss.context.application?kiss.context.application.color:"#00aaee",modal:true,backdropFilter:true,draggable:true,closable:true,align:"center",verticalAlign:"center",class:kiss.screen.isMobile?"upload-window-mobile":"upload-window",layout:"vertical",items:[{hidden:kiss.screen.isMobile,layout:"horizontal",alignItems:"center",minHeight:"5rem",defaultConfig:{margin:"0 1rem 0 0",iconColorHover:"#00aaee"},items:[{id:"upload-method-button",type:"button",text:txtTitleCase("choose your upload method"),icon:"fas fa-chevron-down",iconPosition:"right",action:()=>{if($("upload-method-menu"))return;const buttonBox=$("upload-method-button").getBoundingClientRect();createMenu({id:"upload-method-menu",top:buttonBox.top+kiss.tools.remToPx(4),left:buttonBox.left,width:()=>$("upload-method-button").getBoundingClientRect().width,items:[{text:uploadServices.local,icon:"fas fa-paperclip",action:()=>$("file-upload").displayService("file-upload-local")},{text:uploadServices.link,icon:"fas fa-link",action:()=>$("file-upload").displayService("file-upload-link")},{type:"button",text:uploadServices.websearch,icon:"fas fa-search",action:()=>$("file-upload").displayService("file-upload-websearch")},{type:"button",text:uploadServices.box,icon:"fas fa-box",action:()=>$("file-upload").displayService("file-upload-box")},{type:"button",text:uploadServices.dropbox,icon:"fab fa-dropbox",action:()=>$("file-upload").displayService("file-upload-dropbox")},{type:"button",text:uploadServices.onedrive,icon:"fas fa-cloud",action:()=>$("file-upload").displayService("file-upload-onedrive")},{type:"button",text:uploadServices.googledrive,icon:"fab fa-google-drive",action:()=>$("file-upload").displayService("file-upload-googledrive")},{type:"button",text:uploadServices.instagram,icon:"fab fa-instagram",action:()=>$("file-upload").displayService("file-upload-instagram")},{type:"button",text:uploadServices.takephoto,icon:"fas fa-camera",action:()=>$("file-upload").displayService("file-upload-takephoto")}]}).render()}},{id:"upload-method-title",type:"html",class:"upload-method-title",html:uploadServices.local}]},{id:"file-upload-services",layout:"vertical",width:"100%",class:"upload-gallery-container",multiview:true,items:[createFileUploadLocal(ACL,multiple),createFileUploadGoogleDrive(ACL,multiple),createFileUploadLink(ACL,multiple),createFileUploadDropbox(ACL,multiple),createFileUploadBox(ACL,multiple),createFileUploadWebSearch(ACL,multiple),createFileUploadOneDrive(ACL,multiple),createFileUploadInstagram(ACL,multiple),createFileUploadTakePhoto(ACL,multiple)]}],events:{onclose:()=>{if($("upload-method-menu"))kiss.views.remove("upload-method-menu");kiss.pubsub.publish("EVT_FILE_UPLOAD_CLOSED")}},methods:{displayService(uploadServiceType){$("file-upload-services").showItemById(uploadServiceType);$("upload-method-title").setInnerHtml(uploadServices[uploadServiceType.split("-")[2]])},fileSetter(data,uploadServiceType){let objHidden=document.getElementById("field-upload-"+uploadServiceType);const dt=new DataTransfer;for(let i=0;i<data.length;i++){const file=data[i];dt.items.add(file);objHidden.files=dt.files}},upload(uploadServiceType,callback){if(kiss.session.isOffline())return kiss.tools.featureNotAvailable();const formData=new FormData;const input=$("field-upload-"+uploadServiceType);if(input.files.length==0){return createNotification(txtTitleCase("please add a file before uploading..."))}let totalSize=0;for(const file of input.files)totalSize+=file.size;if(config.maxSize&&totalSize>config.maxSize){return createNotification(txtTitleCase("#warning file size")+" "+config.maxSize.toFileSize())}for(let i=0;i<input.files.length;i++){formData.append("files",input.files[i])}const ACLSwitch=$("upload-"+uploadServiceType+"-ACL");let ACLValue=ACLSwitch?ACLSwitch.getValue():"private";ACLValue=ACLValue===true?"public":"private";formData.append("ACL",ACLValue);kiss.ajax.request({method:"post",url:`/upload/${config.modelId}/${config.recordId}/${config.fieldId}`,contentType:"multipart/form-data",showLoading:true,body:formData}).then((data=>{$("upload-"+uploadServiceType+"-gallery-help").show();$("upload-"+uploadServiceType+"-gallery-items").innerHTML=" ";const dt=new DataTransfer;input.files=dt.files;$("upload-"+uploadServiceType+"-button").hide();$("upload-"+uploadServiceType+"-ACL").hide();if(callback)callback(data);else if(config.callback)config.callback(data);kiss.pubsub.publish("EVT_FILE_UPLOADED",{modelId:config.modelId,recordId:config.recordId,fieldId:config.fieldId,uploadServiceType:uploadServiceType,data:data});$("file-upload").close()})).catch((err=>{log("kiss.ui - File upload with service <"+uploadServiceType+"> failed:",4,err)}))},previewBase64File(data,fileName,uploadServiceType){if(data.status=="success"){const dt=new DataTransfer;const input=$("field-upload-"+uploadServiceType);const files=input.files;for(let i=0;i<files.length;i++){let file=files[i];dt.items.add(file);input.files=dt.files}let dataUrl=data.result;let fileData=$("file-upload").dataURLtoFile(dataUrl,fileName);dt.items.add(fileData);input.files=dt.files;const btnUploadText=txtTitleCase("upload %n file(s)",null,{n:input.files.length});$("upload-"+uploadServiceType+"-button").setText(btnUploadText).show();$("upload-"+uploadServiceType+"-ACL").show();$("file-upload").previewFile(fileData,input.files.length-1,uploadServiceType)}},previewFiles:function(files,uploadServiceType){$("upload-"+uploadServiceType+"-gallery-items").innerHTML=" ";files=[...files];files.forEach(((file,i)=>{$("file-upload").previewFile(file,i,uploadServiceType)}));const btnUploadText=txtTitleCase("upload %n file(s)",null,{n:files.length});$("upload-"+uploadServiceType+"-button").setText(btnUploadText);if(files.length>0){$("upload-"+uploadServiceType+"-button").show();$("upload-"+uploadServiceType+"-ACL").show()}const ACLSwitch=$("upload-"+uploadServiceType+"-ACL");if(ACLSwitch)ACLSwitch.show()},previewFile:function(file,i,uploadServiceType){$("upload-"+uploadServiceType+"-gallery-help").hide();const extension=file.name.split(".").pop();const reader=new FileReader;reader.readAsDataURL(file);reader.onloadend=function(){let thumbnail=$("file-upload").getFileUploadThumbnail(extension,reader.result);$("upload-"+uploadServiceType+"-gallery-items").innerHTML+=`\n                        <div class="upload-item">\n                            <span class="upload-thumbnail-container">${thumbnail}</span>\n                            <span class="upload-filename">${file.name}</span>\n                            <span class="upload-filesize">${file.size.toFileSize()}</span>\n                            <span class="upload-delete fas fa-times" index="${i}" onclick="$('file-upload').deleteFile(this, '${uploadServiceType}')"></span>\n                        </div>\n                    `.removeExtraSpaces()}},dataURLtoFile(dataUrl,filename){let arr=dataUrl.split(","),mime=arr[0].match(/:(.*?);/)[1],bstr=atob(arr[1]),n=bstr.length,u8arr=new Uint8Array(n);while(n--){u8arr[n]=bstr.charCodeAt(n)}return new File([u8arr],filename,{type:mime})},deleteFile:function(element,uploadServiceType){const index=element.getAttribute("index");const dt=new DataTransfer;const input=$("field-upload-"+uploadServiceType);const files=input.files;for(let i=0;i<files.length;i++){let file=files[i];if(index!=i)dt.items.add(file);input.files=dt.files}$("file-upload").previewFiles(input.files,uploadServiceType);if(input.files.length==0){$("upload-"+uploadServiceType+"-gallery-help").show();$("upload-"+uploadServiceType+"-button").hide();$("upload-"+uploadServiceType+"-ACL").hide()}else{$("upload-"+uploadServiceType+"-button").show();$("upload-"+uploadServiceType+"-ACL").show()}},getFileUploadThumbnail(fileType,encodedImage){switch(fileType.toLowerCase()){case"jpg":case"jpeg":case"png":case"gif":case"webp":return`<img class="upload-thumbnail" src="${encodedImage}">`;default:const{icon:icon,color:color}=kiss.tools.fileToIcon(fileType.toLowerCase());return`<span style="color: ${color}" class="fas ${icon} upload-thumbnail"></span>`}}}}).render()};kiss.app.defineView({id:"authentication-error",renderer:function(id,target){let msgCode=kiss.router.getRoute().msgCode;if(!msgCode)msgCode="#authentication error";const errorMessage=txtTitleCase(msgCode);return createBlock({id:id,target:target,fullscreen:true,layout:"horizontal",items:[{type:"view",id:"common-matrix"},{type:"panel",icon:"fas fa-exclamation-triangle",headerBackgroundColor:"var(--background-red)",modal:true,draggable:true,align:"center",verticalAlign:"center",layout:"vertical",items:[{type:"html",html:errorMessage,padding:"32px"},{type:"button",icon:"fas fa-times",flex:1,text:"OK",action:()=>kiss.router.navigateTo("authentication-login",true)}]}]})}});kiss.app.defineView({id:"authentication-invite",renderer:function(id,target){return createPanel({id:id,target:target,title:txtTitleCase("invite a new user"),icon:"fas fa-user-plus",headerBackgroundColor:"var(--background-blue)",modal:true,draggable:true,backdropFilter:true,position:"absolute",width:"50rem",align:"center",verticalAlign:"center",items:[{type:"text",id:"email",label:txtUpperCase("email"),width:"100%",labelPosition:"top",required:true,validationType:"email",methods:{load:function(){setTimeout((()=>this.focus()),50)}}},{layout:"horizontal",margin:"2rem 0 0 0",items:[{type:"button",icon:"fa fa-paper-plane",text:txtTitleCase("send the invitation"),iconColor:"#00aaee",flex:1,action:async()=>{let fieldEmail=$("email");if(!fieldEmail.isValid)return;let email=fieldEmail.getValue();const response=await kiss.ajax.request({url:"/invite",method:"post",showLoading:true,body:JSON.stringify({email:email,language:kiss.language.current})});if(response.code===403){return createDialog({message:txtTitleCase(response.error),noCancel:true})}if(response.error){createNotification({message:txtTitleCase(response.error)})}else{createNotification({message:txtTitleCase("invitation sent for")+" "+email});if($("directory-users"))$("directory-users").close();$(id).close()}}}]}]})}});kiss.app.defineView({id:"authentication-login",renderer:function(id,target){let loginMethods=kiss.router.getRoute().lm;if(!loginMethods)loginMethods=kiss.session.getLoginMethods();const allLoginButtons=kiss.session.getLoginMethodTypes().slice(1).map((loginMethod=>({type:"button",alias:loginMethod.alias,text:loginMethod.text,icon:loginMethod.icon,action:async()=>{const serverEnvironment=await kiss.session.getServerEnvironment();if(serverEnvironment=="docker"){return createNotification(txtTitleCase("#feature not available"))}$("login").showLoading({fullscreen:true,spinnerSize:"12.8rem"});let acceptInvitationOf=kiss.context.acceptInvitationOf||"";if(acceptInvitationOf)acceptInvitationOf="?acceptInvitationOf="+acceptInvitationOf;document.location=loginMethod.callback+acceptInvitationOf}})));const loginButtons=Array.from(loginMethods).map((loginMethodAlias=>allLoginButtons.find((button=>button.alias==loginMethodAlias))));const hasInternalLogin=loginMethods.includes("i");const hasExternalLogin=loginMethods.includes("g");const username=kiss.router.getRoute().username;const password=kiss.router.getRoute().password;let redirectTo=kiss.context.redirectTo||{ui:kiss.session.defaultViews.home};delete kiss.context.redirectTo;if(kiss.context.modelId&&kiss.context.recordId){redirectTo={ui:"form-view",modelId:kiss.context.modelId,recordId:kiss.context.recordId};delete kiss.context.recordId}let layoutParams={};if(kiss.screen.isMobile){layoutParams={position:"fixed",top:0,left:0,width:"100%",height:()=>kiss.screen.current.height,minHeight:()=>kiss.screen.current.height,borderRadius:"0px 0px 0px 0px",draggable:false}}else{layoutParams={width:"80rem",align:"center",verticalAlign:"center",draggable:true}}return createBlock({id:id,target:target,items:[{id:"login-page",fullscreen:true,layout:"horizontal",overflow:"auto",items:[{flex:1,background:"var(--background-blue)"},{type:"view",id:"common-matrix"}]},{height:"100%",items:[{hidden:!kiss.app.logo,position:"absolute",top:0,left:0,type:"image",src:kiss.app.logo,alt:"Logo"},{id:"login",type:"panel",headerBackgroundColor:"var(--background-blue)",layout:"horizontal",overflowY:"auto",...layoutParams,headerButtons:kiss.templates.authLanguageButtons(),items:[{hidden:!hasInternalLogin,flex:1,class:"auth-block",overflow:"hidden",defaultConfig:{width:"100%",fieldWidth:"100%",labelPosition:"top",padding:0},items:[{type:"text",id:"username",label:txtTitleCase("email"),required:true,validationType:"email",value:username},{type:"password",id:"password",label:txtTitleCase("password"),value:password,events:{keydown:event=>{if(event.key=="Enter"){$("login").login()}}}},{type:"button",icon:"fa fa-check",text:txtTitleCase("login"),iconColor:"#00aaee",height:"4rem",margin:"2rem 0",action:()=>$("login").login()},{type:"html",html:`\n                                            <div class="auth-reset-password">${txtTitleCase("forgot password?")}</div>\n                                        `,events:{click:()=>$("login").requestPasswordReset()}},{hidden:kiss.screen.isMobile,type:"html",html:`\n                                            <div class="auth-create-account">${txtTitleCase("#no account")}</div>\n                                        `,events:{click:()=>kiss.router.navigateTo({ui:"authentication-register",lm:loginMethods},true)}}]},{hidden:!hasInternalLogin||!hasExternalLogin,id:"auth-login-separator",class:"auth-separator",layout:"vertical",items:[{type:"spacer",flex:1},{type:"html",class:"auth-separator-text",html:txtUpperCase("or")},{type:"spacer",flex:1}]},{hidden:!hasExternalLogin,id:"auth-login-external",flex:1,class:"auth-block",layout:"vertical",justifyContent:"center",defaultConfig:{margin:"0.5rem",colorHover:"#00aaee",backgroundColorHover:"#ffffff",iconSize:"2rem",iconColorHover:"#00aaee",height:"4rem"},items:loginButtons.concat({hidden:hasInternalLogin,type:"html",html:`<div class="auth-create-account">${txtTitleCase("#no account")}</div>`,events:{click:()=>kiss.router.navigateTo({ui:"authentication-register",lm:loginMethods},true)}})}],methods:{async load(){const token=kiss.router.getRoute().token;if(token){this.hide();const success=await kiss.session.login({token:token});if(success){await kiss.router.navigateTo(redirectTo,true)}else{$("login").setAnimation("shakeX")}}else{this.adjustToScreen()}},async login(){const fieldUsername=$("username");const fieldPassword=$("password");if(fieldUsername.isValid&&fieldPassword.isValid){const success=await kiss.session.login({username:fieldUsername.getValue(),password:fieldPassword.getValue()});if(kiss.context.accountId&&kiss.context.accountId!=kiss.session.getAccountId()){kiss.router.updateUrlHash(redirectTo,true);log.info("kiss.session - Switching to account "+kiss.context.accountId);return kiss.session.switchAccount(kiss.context.accountId)}if(success){await kiss.router.navigateTo(redirectTo,true)}else{$("login").setAnimation("shakeX")}}else{$("login").setAnimation("shakeX")}},async requestPasswordReset(){const fieldUsername=$("username");if(!fieldUsername.isValid){createNotification(txtTitleCase("#email missing"));return}await kiss.ajax.request({url:"/requestPasswordReset",method:"post",showLoading:true,body:JSON.stringify({username:fieldUsername.getValue(),language:kiss.language.current})});createDialog({type:"message",message:txtTitleCase("#password reset request")})},adjustToScreen(){if(!$("authentication-login"))return;if(kiss.screen.isVertical()){$("common-matrix").hide();$("login").config.width="38rem";$("panel-body-login").style.flexFlow="column";$("auth-login-separator").style.flexFlow="row"}else{$("common-matrix").show();$("login").config.width="76rem";$("panel-body-login").style.flexFlow="row";$("auth-login-separator").style.flexFlow="column"}if(kiss.screen.isMobile){$("login").config.width="100%";$("login").config.height="100%"}}},subscriptions:{EVT_WINDOW_RESIZED:function(){this.adjustToScreen()}}}]}]})}});kiss.app.defineView({id:"authentication-register",renderer:function(id,target){const userEmail=kiss.router.getRoute().email;const pendingUserId=kiss.router.getRoute().userId;let loginMethods=kiss.router.getRoute().lm;if(!loginMethods)loginMethods=kiss.session.getLoginMethods();const allLoginButtons=kiss.session.getLoginMethodTypes().slice(1).map((loginMethod=>({type:"button",alias:loginMethod.alias,text:loginMethod.text,icon:loginMethod.icon,action:async()=>{const serverEnvironment=await kiss.session.getServerEnvironment();if(serverEnvironment=="docker"){return createNotification(txtTitleCase("#feature not available"))}document.location=loginMethod.callback}})));const loginButtons=Array.from(loginMethods).map((loginMethodAlias=>allLoginButtons.find((button=>button.alias==loginMethodAlias))));const hasInternalLogin=loginMethods.includes("i");const hasExternalLogin=loginMethods.includes("g");let layoutParams={};if(kiss.screen.isMobile){layoutParams={position:"fixed",top:0,left:0,width:"100%",height:()=>kiss.screen.current.height,minHeight:()=>kiss.screen.current.height,borderRadius:"0px 0px 0px 0px",draggable:false}}else{layoutParams={width:"80rem",align:"center",verticalAlign:"center",draggable:true}}return createBlock({id:id,target:target,items:[{id:"register-page",fullscreen:true,layout:"horizontal",overflow:"auto",items:[{flex:1,background:"var(--background-blue)"},{id:"welcome-image",flex:1,type:"image",position:"absolute",top:0,left:"50%",minWidth:"100%",height:"100%",objectFit:"cover",src:"./resources/img/registration.jpg",alt:"Registration"}]},{height:"100%",items:[{hidden:!kiss.app.logo,position:"absolute",top:0,left:0,type:"image",src:kiss.app.logo,alt:"Logo"},{id:"register",type:"panel",headerBackgroundColor:"var(--background-blue)",layout:"horizontal",overflowY:"auto",...layoutParams,headerButtons:kiss.templates.authLanguageButtons(),items:[{hidden:!hasInternalLogin,flex:1,class:"auth-block",defaultConfig:{width:"100%",fieldWidth:"100%",labelPosition:"top",padding:"0.2rem 0"},items:[{type:"text",id:"firstName",placeholder:txtTitleCase("first name"),required:true},{type:"text",id:"lastName",placeholder:txtTitleCase("last name"),required:true},{hidden:pendingUserId?true:false,type:"text",id:"company",placeholder:txtTitleCase("company")},{hidden:pendingUserId?true:false,type:"text",id:"telephone",placeholder:txtTitleCase("telephone")},{type:"text",id:"email",placeholder:txtTitleCase("email"),required:true,validationType:"email",value:userEmail},{type:"password",id:"password",placeholder:txtTitleCase("password"),required:true},{type:"password",id:"passwordConfirmation",placeholder:txtTitleCase("password confirmation"),required:true},{layout:"horizontal",margin:"1rem 0 0 0",items:[{type:"button",icon:"fa fa-check",text:txtTitleCase("register"),iconColor:"#00aaee",flex:1,height:"4rem",action:async function(){let fieldFirstName=$("firstName");let fieldLastName=$("lastName");let fieldEmail=$("email");let fieldPassword=$("password");let fieldPasswordConfirmation=$("passwordConfirmation");fieldFirstName.validate();fieldLastName.validate();fieldEmail.validate();fieldPassword.validate();fieldPasswordConfirmation.validate();if(fieldFirstName.isValid&&fieldLastName.isValid&&fieldEmail.isValid&&fieldPassword.isValid&&fieldPasswordConfirmation.isValid){let firstName=fieldFirstName.getValue();let lastName=fieldLastName.getValue();let email=fieldEmail.getValue();let password=fieldPassword.getValue();let passwordConfirmation=fieldPasswordConfirmation.getValue();if(password!=passwordConfirmation){createNotification(txtTitleCase("#password don't match"));return $("register").setAnimation("shakeX")}kiss.ajax.request({url:"/register",method:"post",body:JSON.stringify({userId:pendingUserId,firstName:firstName,lastName:lastName,language:kiss.language.current,email:email,password:password,passwordConfirmation:passwordConfirmation})}).then((response=>{if(response.error){$("register").setAnimation("shakeX")}else{$("register").showWelcome()}})).catch((err=>{$("register").setAnimation("shakeX")}))}else{$("register").setAnimation("shakeX")}}}]},{hidden:kiss.screen.isMobile,type:"html",html:`<div class="auth-create-account">${txtTitleCase("#already an account")}</div>`,events:{click:()=>kiss.router.navigateTo({ui:"authentication-login",lm:loginMethods},true)}}]},{hidden:!hasInternalLogin||!hasExternalLogin,id:"auth-separator",class:"auth-separator",layout:"vertical",items:[{type:"spacer",flex:1},{type:"html",class:"auth-separator-text",html:txtUpperCase("or")},{type:"spacer",flex:1}]},{hidden:!hasExternalLogin,flex:1,class:"auth-block",layout:"vertical",justifyContent:"center",defaultConfig:{margin:"0.5rem",colorHover:"#00aaee",backgroundColorHover:"#ffffff",iconSize:"2rem",iconColorHover:"#00aaee",height:"4rem"},items:loginButtons.concat({hidden:hasInternalLogin,type:"html",html:`<div class="auth-create-account">${txtTitleCase("#already an account")}</div>`,events:{click:()=>kiss.router.navigateTo({ui:"authentication-login",lm:loginMethods},true)}})}],methods:{load:function(){this.adjustToScreen();const error=kiss.router.getRoute().error;if(error){createDialog({type:"danger",message:txtTitleCase(error),noCancel:true})}},showWelcome(){$("register").hide();createPanel({type:"panel",title:txtUpperCase("welcome onboard"),icon:"fas fa-handshake",headerBackgroundColor:"var(--background-blue)",position:"absolute",width:()=>"min(calc(100vw - 10rem), 60rem)",align:"center",verticalAlign:"center",items:[{type:"html",html:"<center>"+txtTitleCase("#thanks for registration")+"</center>",padding:"3.2rem"}]}).render()},adjustToScreen:()=>{if(kiss.context.ui!="authentication-register")return;if(kiss.screen.isVertical()){$("welcome-image").hide();$("register").config.width=kiss.screen.isMobile?"32remx":"38rem";$("panel-body-register").style.flexFlow="column";$("auth-separator").style.flexFlow="row"}else{$("welcome-image").show();$("register").config.width="76rem";$("panel-body-register").style.flexFlow="row";$("auth-separator").style.flexFlow="column"}}},subscriptions:{EVT_WINDOW_RESIZED:function(){this.adjustToScreen()}}}]}]})}});kiss.app.defineView({id:"authentication-reset-password",renderer:function(id,target){let layoutParams={};if(kiss.screen.isMobile){layoutParams={position:"fixed",top:0,left:0,width:"100%",height:()=>kiss.screen.current.height,minHeight:()=>kiss.screen.current.height,borderRadius:"0px 0px 0px 0px",draggable:false}}else{layoutParams={width:"50rem",align:"center",verticalAlign:"center",draggable:true}}return createBlock({id:id,target:target,items:[{fullscreen:true,layout:"horizontal",overflow:"auto",items:[{flex:1,background:"var(--background-blue)"},{id:"welcome-image",flex:1,class:"auth-welcome"}]},{height:"100%",items:[{hidden:!kiss.app.logo,position:"absolute",top:0,left:0,type:"image",src:kiss.app.logo,alt:"Logo"},{id:"password-reset",type:"panel",title:txtTitleCase("password reset"),icon:"fas fa-recycle",headerBackgroundColor:"var(--background-blue)",layout:"horizontal",...layoutParams,headerButtons:kiss.screen.isMobile?[]:kiss.templates.authLanguageButtons(),items:[{flex:1,class:"auth-block",defaultConfig:{width:"100%",labelPosition:"top"},items:[{type:"password",id:"password",label:txtUpperCase("new password"),required:true},{type:"password",id:"passwordConfirmation",label:txtUpperCase("new password confirmation"),required:true},{layout:"horizontal",margin:"1rem 0 0 0",items:[{type:"button",icon:"fa fa-check",text:txtTitleCase("change password"),iconColor:"#00aaee",flex:1,events:{click:async function(){let fieldPassword=$("password");let fieldPasswordConfirmation=$("passwordConfirmation");fieldPassword.validate();fieldPasswordConfirmation.validate();if(fieldPassword.isValid&&fieldPasswordConfirmation.isValid){let password=fieldPassword.getValue();let passwordConfirmation=fieldPasswordConfirmation.getValue();if(password!=passwordConfirmation){createNotification(txtTitleCase("#password don't match"));return $("password-reset").setAnimation("shakeX")}await kiss.ajax.request({url:"/resetPassword",method:"post",body:JSON.stringify({token:kiss.router.getRoute().token,password:password,language:kiss.language.current})});kiss.router.navigateTo({ui:"authentication-login"},true)}else{$("password-reset").setAnimation("shakeX")}}}}]}]}],methods:{load:function(){this.adjustToScreen()},adjustToScreen:()=>{if(kiss.context.ui!="authentication-reset-password")return;if(kiss.screen.current.ratio<1){$("welcome-image").hide()}else{$("welcome-image").show()}}},subscriptions:{EVT_WINDOW_RESIZED:function(){this.adjustToScreen()}}}]}]})}});kiss.templates.authLanguageButtons=()=>kiss.language.available.map((language=>({text:language.code.toUpperCase(),icon:"fas fa-globe",height:"3.2rem",fontSize:"1.1rem",margin:"0 0.5rem 0 0",color:"#ffffff",iconColor:"#ffffff",backgroundColor:"transparent",borderWidth:0,action:()=>kiss.language.set(language.code)})));kiss.app.defineView({id:"common-matrix",renderer:function(id,target){return createBlock({id:id,target:target,layout:"vertical",height:"100%",flex:1,items:[{type:"html",flex:1,html:`<canvas id="matrix-effect"></canvas>`}],subscriptions:{EVT_WINDOW_RESIZED:function(){if(this.isConnected)this.load()}},methods:{load(){const rootStyles=getComputedStyle(document.documentElement);const matrixBackground=rootStyles.getPropertyValue("--body-background").trim()||"#ffffff";const matrixColor=rootStyles.getPropertyValue("--body-alt").trim()||"#cccccc";kiss.tools.wait(1e3).then((()=>{clearInterval(kiss.global.matrix);const canvas=$("matrix-effect");if(!canvas)return;const ctx=canvas.getContext("2d");const w=canvas.width=$(id).offsetWidth;const h=canvas.height=$(id).offsetHeight;const cols=Math.floor(w/20)+1;const ypos=Array(cols).fill(0);ctx.fillStyle=matrixBackground;ctx.fillRect(0,0,w,h);function matrix(){ctx.fillStyle=matrixBackground+"11";ctx.fillRect(0,0,w,h);ctx.fillStyle=matrixColor;ctx.font="15pt monospace";ypos.forEach(((y,ind)=>{const text=String.fromCharCode(Math.random()*1e3);const x=ind*20;ctx.fillText(text,x,y);if(y>100+Math.random()*1e4)ypos[ind]=0;else ypos[ind]=y+20}))}kiss.global.matrix=setInterval(matrix,25)}))},_afterDisconnected(){clearInterval(kiss.global.matrix)}}})}});kiss.data.Collection=class{constructor(config){this.id=config.id||uid();this.mode=config.mode||kiss.db.mode;this.db=kiss.db[this.mode];this.model=config.model;this.modelId=this.model.id;this.modelName=this.model.name;log(`kiss.data.Collection - Defining collection ${this.id} for <${this.modelName}> in mode <${this.mode}>`);this.isMaster=config.isMaster||false;this.masterCollection=this.isMaster?this:kiss.app.collections[this.modelId];this.records=config.records||[];this.isLoaded=false;this.showLoadingSpinner=config.showLoadingSpinner===false?false:true;this.filter=config.filter||{};this.filterSyntax=config.filterSyntax||"normalized";this.sort=config.sort||[];this.sortSyntax=config.sortSyntax||"normalized";this.projection={};this.group=config.group||[];this.groupUnwind=config.groupUnwind||false;this._initSubscriptions();this.hooks={beforeInsert:[],afterInsert:[],beforeUpdate:[],afterUpdate:[],beforeDelete:[],afterDelete:[]};kiss.app.collections[this.id]=this;return this}init(config){if(config.mode)this.setMode(config.mode);if(config.model)this.model=config.model;if(config.records)this.records=config.records;if(config.filter)this.filter=config.filter;if(config.filterSyntax)this.filterSyntax=config.filterSyntax;if(config.sort)this.sort=config.sort;if(config.sortSyntax)this.sortSyntax=config.sortSyntax;if(config.projection)this.projection=config.projection||{};if(config.group)this.group=config.group||[];if(config.groupUnwind!==undefined)this.groupUnwind=config.groupUnwind;return this}_initSubscriptions(){this.subscriptions=[subscribe("EVT_DB_INSERT:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.dbMode!=this.mode)return;this._insertOne(msgData.data)})),subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.dbMode!=this.mode)return;this._updateOne(msgData.id,msgData.data)})),subscribe("EVT_DB_DELETE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.dbMode!=this.mode)return;this._deleteOne(msgData.id)})),subscribe("EVT_DB_UPDATE_BULK",(msgData=>{if(msgData.dbMode!=this.mode)return;msgData.data.forEach((operation=>{if(operation.modelId==this.modelId){this._updateOne(operation.recordId,operation.updates)}}))})),subscribe("EVT_DB_INSERT_MANY:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.dbMode!=this.mode)return;this.reload()}),`Collection.insertMany / Model: ${this.model.name}`),subscribe("EVT_DB_DELETE_MANY:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.dbMode!=this.mode)return;this.reload()}),`Collection.deleteMany / Model: ${this.model.name}`)]}destroy(deleteInMemoryDb){this.subscriptions.forEach((subscriptionId=>kiss.pubsub.unsubscribe(subscriptionId)));if(this.mode=="memory"&&kiss.db.mode!="memory"||deleteInMemoryDb){this.db.deleteCollection(this.modelId)}delete kiss.app.collections[this.id];delete this}clone(mode){const clonedCollection=new kiss.data.Collection({id:uid(),mode:this.mode,model:this.model,records:this.records,filter:this.filter,filterSyntax:this.filterSyntax,sort:this.sort,sortSyntax:this.sortSyntax,projection:this.projection,group:this.group,groupUnwind:this.groupUnwind});clonedCollection.isLoaded=this.isLoaded;clonedCollection._initSubscriptions();log(`kiss.data.Collection - Cloning collection ${this.model.name} (${clonedCollection.id}) in mode ${mode||this.mode}...`);return clonedCollection}setMode(mode){this.mode=mode;this.db=kiss.db[mode]}addHook(hookType,callback){if(["beforeInsert","beforeUpdate","beforeDelete","afterInsert","afterUpdate","afterDelete"].includes(hookType))this.hooks[hookType].push(callback);return this}_hookInsert(type,record){let event=type+"Insert";if(this.hooks[event].length!=0){this.hooks[event].forEach((hook=>{hook(record)}))}}_hookUpdate(type,recordId,update){let event=type+"Update";if(this.hooks[event].length!=0){this.hooks[event].forEach((hook=>{hook(recordId,update)}))}}_hookDelete(type,recordId){let event=type+"Delete";if(this.hooks[event].length!=0){this.hooks[event].forEach((hook=>{hook(recordId)}))}}_insertOne(record){const existingRecord=this.records.get(record.id);if(existingRecord){log("kiss.data.Collection - _insertOne rejected because it violates the unique constraint",4);return}this._hookInsert("before",record);const newRecord=this.model.create(record);this.records.push(newRecord);this.hasChanged=true;this._hookInsert("after",record)}_updateOne(recordId,update){this._hookUpdate("before",recordId,update);let groupId;if(this.groupUnwind!==true){let record=this.records.get(recordId);if(record){Object.assign(record,update);groupId=record.$groupId}if(this.group.length>0){Object.values(this.cachedRecords).forEach((collapsedGroupRecords=>{let record=collapsedGroupRecords.get(recordId);if(record){Object.assign(record,update);groupId=record.$groupId}}))}}else{this.records.forEach((record=>{if(record.id==recordId)Object.assign(record,update)}));if(this.group.length>0){Object.values(this.cachedRecords).forEach((collapsedGroupRecords=>{collapsedGroupRecords.forEach((record=>{if(record.id==recordId)Object.assign(record,update)}))}))}}if(groupId){this._groupUpdateAggregations(groupId)}this.hasChanged=true;this._hookUpdate("after",recordId,update)}_deleteOne(recordId){this._hookDelete("before",recordId);this.records=this.records.filter((record=>record.id!=recordId));if(this.group.length>0){Object.values(this.cachedRecords).forEach((collapsedGroupRecords=>{collapsedGroupRecords=collapsedGroupRecords.filter((record=>record.id!=recordId))}))}this.hasChanged=true;this._hookDelete("after",recordId)}async insertMany(records){return await this.db.insertMany(this.modelId,records)}async insertOne(record){return await this.db.insertOne(this.modelId,record)}async updateOne(recordId,update){return await this.db.updateOne(this.modelId,recordId,update)}async deleteOne(recordId,sendToTrash){return await this.db.deleteOne(this.modelId,recordId,sendToTrash)}async updateMany(query,update){return await this.db.updateMany(this.modelId,query,update)}async deleteMany(query,sendToTrash){await this.db.deleteMany(this.modelId,query,sendToTrash)}async insertFakeRecords(numberOfRecords){return await kiss.db.insertFakeRecords(this.modelId,this.model.getFields(),numberOfRecords)}async deleteFakeRecords(){await kiss.db.deleteFakeRecords(this.modelId)}async find(query={},nocache,nospinner){let loadingId;try{if(query.sort&&this.sort&&JSON.stringify(query.sort)!=JSON.stringify(this.sort)){this.hasChanged=true}else if(query.filter&&this.filter&&JSON.stringify(query.filter)!=JSON.stringify(this.filter)){this.hasChanged=true}else if(query.group&&this.group&&JSON.stringify(query.group)!=JSON.stringify(this.group)){this.hasChanged=true}if(this.isLoaded&&this.hasChanged==false&&nocache!=true){log(`kiss.data.Collection - find - ${this.id} (${this.mode}) - Got ${this.records.length} record(s) from CACHE`,2);return this.records}if(this.isLoading&&!this.hasChanged){this.records=await new Promise(((resolve,reject)=>{const subscriptionId=subscribe("EVT_COLLECTION_LOADED:"+this.id,(msgData=>{kiss.pubsub.unsubscribe(subscriptionId);resolve(msgData)}))}));log(`kiss.data.Collection - find - ${this.id} (${this.mode}) - Got ${this.records.length} record(s) from PUBSUB`,2);return this.records}log(`kiss.data.Collection - find - ${this.id} (${this.mode})`);if(this.showLoadingSpinner&&nospinner!=true)loadingId=kiss.loadingSpinner.show();this.isLoading=true;this.isLoaded=false;this.hasChanged=false;this.cachedRecords=[];this.filterSyntax="normalized";this.sortSyntax="normalized";this.filter={};this.sort=this.filterSyntax=="mongo"?{}:[];this.group=[];this.projection={};this.skip=0;this.limit=0;if(query.filterSyntax)this.filterSyntax=query.filterSyntax;if(query.filter)this.filter=query.filter;if(query.sortSyntax)this.sortSyntax=query.sortSyntax;if(query.sort)this.sort=query.sort;if(query.group)this.group=query.group;if(query.groupUnwind)this.groupUnwind=query.groupUnwind;if(query.projection)this.projection=query.projection;if(query.skip)this.skip=query.skip;if(query.limit)this.limit=query.limit;let search={operation:"search",filter:this.filter,filterSyntax:this.filterSyntax||"normalized",sort:this.sort,sortSyntax:this.sortSyntax||"normalized",group:this.group,groupUnwind:this.groupUnwind,projection:this.projection,skip:this.skip,limit:this.limit};if(this.group.length!=0){this.collapsedGroups=[];this.groupedRecords=await this.db.find(this.modelId,search,this.mode);this.groupedRecords=this.groupedRecords.map((record=>this.model.create(record)));this.groupedRecords=this._groupBy(this.groupedRecords,this.group,this.groupUnwind);this._groupBuildHierarchy()}else{this.records=await this.db.find(this.modelId,search,this.mode);this.records=this.records.map((record=>this.model.create(record)));this.count=this.records.length}this.hasChanged=false;this.isLoading=false;this.isLoaded=true;publish("EVT_COLLECTION_LOADED:"+this.id,this.records);log(`kiss.data.Collection - find - ${this.id} (${this.mode}) - Got ${this.records.length} record(s) from DATABASE`,2);if(this.showLoadingSpinner&&nospinner!=true)kiss.loadingSpinner.hide(loadingId);return this.records}catch(err){this.isLoaded=false;this.isLoading=false;this.hasChanged=false;if(this.showLoadingSpinner&&nospinner!=true)kiss.loadingSpinner.hide(loadingId);return this.records}}async reload(){log(`kiss.data.Collection - reload ${this.model.name} - ${this.id} (${this.mode})`);this.isLoaded=false;this.isLoading=false;this.hasChanged=true;let noCache=true;this.records=[];await this.find({filterSyntax:this.filterSyntax,filter:this.filter,sortSyntax:this.sortSyntax,sort:this.sort,group:this.group,projection:this.projection,groupUnwind:this.groupUnwind},noCache);this.isLoaded=true;this.isLoading=false;this.hasChanged=false;return this}async findOne(recordId,nocache){log(`kiss.data.Collection - findOne ${this.model.name} - ${this.id} - Record: ${recordId}`);let record;if(this.isLoaded&&!this.hasChanged&&!nocache){log(`kiss.data.Collection - returning cached record`);record=this.records.get(recordId)}if(!record){log(`kiss.data.Collection - retrieving record from db`);let recordData=await this.db.findOne(this.modelId,recordId);if(!recordData)return false;record=this.model.create(recordData)}return record}async findById(recordIds,sort=[],sortSyntax="normalized",nocache){log(`kiss.data.Collection - findById ${this.model.name} - ${this.id} - Records: ${recordIds}`);let records=[];let missingRecordIds=[...recordIds];if(this.isLoaded&&!this.hasChanged&&!nocache){log(`kiss.data.Collection - returning cached records`);while(recordIds.length>0){let recordId=recordIds.pop();let record=this.records.get(recordId);if(record){records.push(record);missingRecordIds.pop()}}if(missingRecordIds.length==0)return records}if(missingRecordIds.length>0){log(`kiss.data.Collection - retrieving missing records from db`);let missingRecords=await this.db.findById(this.modelId,missingRecordIds,sort,sortSyntax);if(!missingRecords)return false;records=records.concat(missingRecords);records=records.map((record=>this.model.create(record)));return records}}getRecord(recordId){return this.records.get(recordId)}async filterBy(filterConfig){this.filter=filterConfig;this.hasChanged=true;await this.find({filterSyntax:this.filterSyntax,filter:this.filter,sortSyntax:this.sortSyntax,sort:this.sort,group:this.group,projection:this.projection,groupUnwind:this.groupUnwind});return this.records}async sortBy(sortConfig){this.sort=sortConfig;this.hasChanged=true;await this.find({filterSyntax:this.filterSyntax,filter:this.filter,sortSyntax:this.sortSyntax,sort:this.sort,group:this.group,projection:this.projection,groupUnwind:this.groupUnwind});return this.records}async groupBy(groupFields){this.group=groupFields.length!=0?groupFields:[];this.hasChanged=true;await this.find({filterSyntax:this.filterSyntax,filter:this.filter,sortSyntax:this.sortSyntax,sort:this.sort,group:this.group,projection:this.projection,groupUnwind:this.groupUnwind});return this.records}groupExpandAll(){this.collapsedGroups=[];this.cachedRecords={};this._groupBuildHierarchy()}groupCollapseAll(){this.collapsedGroups=[];this.cachedRecords={};this._groupBuildHierarchy(true)}_groupBy(records,fieldIds,groupUnwind){switch(fieldIds.length){case 1:return this._groupBy1Field(records,fieldIds,groupUnwind);break;case 2:return this._groupBy2Fields(records,fieldIds,groupUnwind);break;case 3:return this._groupBy3Fields(records,fieldIds,groupUnwind);break;case 4:return this._groupBy4Fields(records,fieldIds,groupUnwind);break;case 5:return this._groupBy5Fields(records,fieldIds,groupUnwind);break;case 6:return this._groupBy6Fields(records,fieldIds,groupUnwind);break}}_groupBy1Field(records,fieldIds,groupUnwind){const fieldId=fieldIds[0];const groupField=this.model.getField(fieldId);if(groupField.multiple){return this._groupBy1UnwoundField(records,fieldIds)}return records.reduce(((map,record)=>{let value=record[fieldId];if(Array.isArray(value))value=value[0];return map.set(value,[...map.get(value)||[],record])}),new Map)}_proxifier(record){let groupId=null;return new Proxy(record,{set(target,prop,value){if(prop=="$groupId"){groupId=value;return true}target[prop]=value;return true},get(target,prop){if(prop=="$groupId")return groupId;else return target[prop]}})}_groupBy1UnwoundField(records,fieldIds){const fieldId=fieldIds[0];return records.reduce(((map,record)=>{[].concat(record[fieldId]).forEach((value=>{map.set(value,[...map.get(value)||[],this._proxifier(record)])}));return map}),new Map)}_groupBy2Fields(records,fieldIds){let map=new Map;records.forEach((record=>{let groupLevel1=record[fieldIds[0]];if(Array.isArray(groupLevel1))groupLevel1=groupLevel1[0];let groupLevel2=record[fieldIds[1]];if(Array.isArray(groupLevel2))groupLevel2=groupLevel2[0];if(!map.get(groupLevel1))map.set(groupLevel1,new Map);map.get(groupLevel1).set(groupLevel2,[...map.get(groupLevel1).get(groupLevel2)||[],record])}));return map}_groupBy3Fields(records,fieldIds){let map=new Map;records.forEach((record=>{let groupLevel1=record[fieldIds[0]];if(Array.isArray(groupLevel1))groupLevel1=groupLevel1[0];let groupLevel2=record[fieldIds[1]];if(Array.isArray(groupLevel2))groupLevel2=groupLevel2[0];let groupLevel3=record[fieldIds[2]];if(Array.isArray(groupLevel3))groupLevel3=groupLevel3[0];if(!map.get(groupLevel1))map.set(groupLevel1,new Map);if(!map.get(groupLevel1).get(groupLevel2))map.get(groupLevel1).set(groupLevel2,new Map);map.get(groupLevel1).get(groupLevel2).set(groupLevel3,[...map.get(groupLevel1).get(groupLevel2).get(groupLevel3)||[],record])}));return map}_groupBy4Fields(records,fieldIds){let map=new Map;records.forEach((record=>{let groupLevel1=record[fieldIds[0]];if(Array.isArray(groupLevel1))groupLevel1=groupLevel1[0];let groupLevel2=record[fieldIds[1]];if(Array.isArray(groupLevel2))groupLevel2=groupLevel2[0];let groupLevel3=record[fieldIds[2]];if(Array.isArray(groupLevel3))groupLevel3=groupLevel3[0];let groupLevel4=record[fieldIds[3]];if(Array.isArray(groupLevel4))groupLevel4=groupLevel4[0];if(!map.get(groupLevel1))map.set(groupLevel1,new Map);if(!map.get(groupLevel1).get(groupLevel2))map.get(groupLevel1).set(groupLevel2,new Map);if(!map.get(groupLevel1).get(groupLevel2).get(groupLevel3))map.get(groupLevel1).get(groupLevel2).set(groupLevel3,new Map);map.get(groupLevel1).get(groupLevel2).get(groupLevel3).set(groupLevel4,[...map.get(groupLevel1).get(groupLevel2).get(groupLevel3).get(groupLevel4)||[],record])}));return map}_groupBy5Fields(records,fieldIds){let map=new Map;records.forEach((record=>{let groupLevel1=record[fieldIds[0]];if(Array.isArray(groupLevel1))groupLevel1=groupLevel1[0];let groupLevel2=record[fieldIds[1]];if(Array.isArray(groupLevel2))groupLevel2=groupLevel2[0];let groupLevel3=record[fieldIds[2]];if(Array.isArray(groupLevel3))groupLevel3=groupLevel3[0];let groupLevel4=record[fieldIds[3]];if(Array.isArray(groupLevel4))groupLevel4=groupLevel4[0];let groupLevel5=record[fieldIds[4]];if(Array.isArray(groupLevel5))groupLevel5=groupLevel5[0];if(!map.get(groupLevel1))map.set(groupLevel1,new Map);if(!map.get(groupLevel1).get(groupLevel2))map.get(groupLevel1).set(groupLevel2,new Map);if(!map.get(groupLevel1).get(groupLevel2).get(groupLevel3))map.get(groupLevel1).get(groupLevel2).set(groupLevel3,new Map);if(!map.get(groupLevel1).get(groupLevel2).get(groupLevel3).get(groupLevel4))map.get(groupLevel1).get(groupLevel2).get(groupLevel3).set(groupLevel4,new Map);map.get(groupLevel1).get(groupLevel2).get(groupLevel3).get(groupLevel4).set(groupLevel5,[...map.get(groupLevel1).get(groupLevel2).get(groupLevel3).get(groupLevel4).get(groupLevel5)||[],record])}));return map}_groupBy6Fields(records,fieldIds){let map=new Map;records.forEach((record=>{let groupLevel1=record[fieldIds[0]];if(Array.isArray(groupLevel1))groupLevel1=groupLevel1[0];let groupLevel2=record[fieldIds[1]];if(Array.isArray(groupLevel2))groupLevel2=groupLevel2[0];let groupLevel3=record[fieldIds[2]];if(Array.isArray(groupLevel3))groupLevel3=groupLevel3[0];let groupLevel4=record[fieldIds[3]];if(Array.isArray(groupLevel4))groupLevel4=groupLevel4[0];let groupLevel5=record[fieldIds[4]];if(Array.isArray(groupLevel5))groupLevel5=groupLevel5[0];let groupLevel6=record[fieldIds[5]];if(Array.isArray(groupLevel6))groupLevel6=groupLevel6[0];if(!map.get(groupLevel1))map.set(groupLevel1,new Map);if(!map.get(groupLevel1).get(groupLevel2))map.get(groupLevel1).set(groupLevel2,new Map);if(!map.get(groupLevel1).get(groupLevel2).get(groupLevel3))map.get(groupLevel1).get(groupLevel2).set(groupLevel3,new Map);if(!map.get(groupLevel1).get(groupLevel2).get(groupLevel3).get(groupLevel4))map.get(groupLevel1).get(groupLevel2).get(groupLevel3).set(groupLevel4,new Map);if(!map.get(groupLevel1).get(groupLevel2).get(groupLevel3).get(groupLevel4).get(groupLevel5))map.get(groupLevel1).get(groupLevel2).get(groupLevel3).get(groupLevel4).set(groupLevel5,new Map);map.get(groupLevel1).get(groupLevel2).get(groupLevel3).get(groupLevel4).get(groupLevel5).set(groupLevel6,[...map.get(groupLevel1).get(groupLevel2).get(groupLevel3).get(groupLevel4).get(groupLevel5).get(groupLevel6)||[],record])}));return map}_groupBuildHierarchy(collapsed){this.records=[];this.recordIndex=0;this.numberFields=this.model.getFields().filter((field=>kiss.tools.isNumericField(field)));this.levelIndex=[];this._groupParse(this.groupedRecords,{},0,collapsed);this.count=this.records.length}_groupUpdateAggregations(groupId){const numberFieldIds=this.numberFields.map((field=>field.id));const groups=this.records.filter((record=>record.$type=="group"));const visibleRecords=this.records.filter((record=>record.$groupId==groupId));groups.forEach((group=>{numberFieldIds.forEach((fieldId=>{}))}))}_groupParse(group,parentGroupData,groupLevel,collapsed){this.levelIndex[groupLevel]=0;group.forEach(((subgroup,key,map)=>{this.levelIndex[groupLevel]+=1;const groupId=this.levelIndex.slice(0,groupLevel+1).join(".");group.get(key).groupId=groupId;const subGroupData={$type:"group",$groupLevel:groupLevel,$groupId:groupId,$size:subgroup.length,$name:key};if(!collapsed||groupLevel==0){this.records.push(subGroupData)}else{this.cachedRecords[parentGroupData.$groupId]=(this.cachedRecords[parentGroupData.$groupId]||[]).concat(subGroupData)}if(collapsed)this.collapsedGroups.push(groupId);if(subgroup instanceof Map){const deeperSubGroup=this._groupParse(subgroup,subGroupData,groupLevel+1,collapsed);parentGroupData.$size=(parentGroupData.$size||0)+deeperSubGroup.$size;this.numberFields.forEach((field=>{const parentSum=parentGroupData[field.id]?(parentGroupData[field.id].sum||0)+deeperSubGroup[field.id].sum:deeperSubGroup[field.id].sum;parentGroupData[field.id]={sum:parentSum,avg:parentSum/parentGroupData.$size}}))}else{parentGroupData.$size=(parentGroupData.$size||0)+subgroup.length;this.numberFields.forEach((field=>{const sum=subgroup.reduce(((sum,record)=>sum+(Number(record[field.id])||0)),0);subGroupData[field.id]={sum:sum,avg:sum/subgroup.length};const parentSum=parentGroupData[field.id]?(parentGroupData[field.id].sum||0)+sum:sum;parentGroupData[field.id]={sum:parentSum,avg:parentSum/parentGroupData.$size}}));subgroup.forEach((record=>{record.$groupId=groupId+".";record.$index=this.recordIndex++}));if(!collapsed){this.records.push(...subgroup)}else{this.cachedRecords[groupId]=subgroup}}}));return parentGroupData}groupExpand(groupId,rowIndex){this.collapsedGroups.remove(groupId);let recordsToInsert=this.cachedRecords[groupId];this.records.splice(Number(rowIndex)+1,0,...recordsToInsert);let index=0;this.records.forEach((record=>{if(record.$type!="group")record.$index=index++}));this.count=this.records.length}groupCollapse(groupId){let recordsKept=[];let recordsCached=[];let groupIdToSearch=groupId+".";this.records.forEach((record=>{if(!record.$groupId.startsWith(groupIdToSearch)){recordsKept.push(record)}else{recordsCached.push(record)}}));this.records=recordsKept;this.cachedRecords[groupId]=recordsCached;let index=0;this.records.forEach((record=>{if(record.$type!="group")record.$index=index++}));this.count=this.records.length;this.collapsedGroups.push(groupId)}};kiss.data.Model=class{constructor(config){this.mode=config.mode||kiss.db.mode;this.db=kiss.db[this.mode];this.id=config.id||this.namePlural||this.name||uid();this.accountId=config.accountId;this.name=(config.name||this.id).toTitleCase();this.namePlural=(config.namePlural||this.id).toTitleCase();this.nameTranslations=config.nameTranslations||{};this.namePluralTranslations=config.namePluralTranslations||{};this.icon=config.icon||"fas fa-th";this.color=config.color||"#00aaee";this.backgroundColor=config.backgroundColor||"#ffffff";this.fullscreen=!!config.fullscreen;this.align=config.align||"center";this.tags=config.tags||[];this.domains=config.domains||[];this.methods=config.methods||{};this.features=config.features;this.splitBy=config.splitBy;this.acl=kiss.tools.isUid(this.id)&&kiss.app.models.dynamicModel?kiss.app.models.dynamicModel.acl:config.acl;this.acl=this.acl||{};this.authenticatedCanCreate=config.authenticatedCanCreate;this.authenticatedCanRead=config.authenticatedCanRead;this.authenticatedCanUpdate=config.authenticatedCanUpdate;this.authenticatedCanDelete=config.authenticatedCanDelete;this.ownerCanManage=config.ownerCanManage;this.accessCreate=config.accessCreate;this.accessRead=config.accessRead;this.accessUpdate=config.accessUpdate;this.accessDelete=config.accessDelete;this.accessManage=config.accessManage;this.public=!!config.public;this.publicFormWidth=config.publicFormWidth;this.publicFormMargin=config.publicFormMargin;this.publicFormHeader=config.publicFormHeader;this.publicEmailTo=config.publicEmailTo;this.publicFormActionId=config.publicFormActionId;if(config.applicationId)this.applicationId=config.applicationId;if(config.templateId)this.templateId=config.templateId;kiss.app.models[this.id]=this;this._initItems(config.items)._initFields()._initElements()._initACLFields()._initComputedFields();this._initRecordFactory();if(kiss.isClient){this._initMasterCollection()._initSubscriptions()}if(kiss.isServer){this._initAcceptedFields()}return this}create(recordData,inherit){return new this.recordFactory(recordData,inherit)}createFromLabels(record){let newRecord={};Object.keys(record).forEach((fieldLabel=>{const field=this.getFieldByLabel(fieldLabel);const value=record[fieldLabel];newRecord[field.id]=value}));return this.create(newRecord)}async checkPermission(action){const record=kiss.app.collections.model.records.get(this.id);const hasPermission=await kiss.acl.check({action:action,record:record});if(!hasPermission){createNotification(txtTitleCase("#not authorized"));return false}return true}_initItems(items){if(kiss.isClient){this._initClientItems(items)}else{this._initServerItems(items)}return this}_initFields(){const modelFields=this.getFields();const featureFields=this.getFeatureFields();const systemFields=this.getSystemFields();this.fields=modelFields.concat(featureFields).concat(systemFields);if(kiss.isClient){this.fields.forEach((field=>{if(field.label&&field.label.startsWith("#")){field.label=txtTitleCase(field.label)}kiss.fields.setRenderer(this,field)}))}return this}_initElements(items){this.elements=this.getElements(items);return this}_initACLFields(){if(kiss.isClient)return this;this.aclFields=this.fields.filter((field=>field.isACL));if(this.aclFields.length>0)kiss.acl.addFields(this,this.aclFields);return this}_initComputedFields(){this.computedFields=[];const fields=this.getActiveFields();fields.forEach((field=>{field.dependencies=[];field.deepDependencies=[];if(field.computed){field.formulaSourceFields=[];field.formulaSourceFieldIds=[]}}));for(let i=0;i<fields.length;i++){let field=fields[i];if(field.computed){this.computedFields.push(field.id);field.formulaSourceFields=kiss.tools.findTags(field.formula);field.formulaSourceFieldIds=field.formulaSourceFields.map((sourceFieldName=>{let sourceField;const fieldIndex=Number(sourceFieldName);const isFieldIndex=Number.isInteger(fieldIndex);if(isFieldIndex){sourceField=fields[fieldIndex]}else{sourceField=this.getFieldByLabel(sourceFieldName)}if(sourceField){sourceField.dependencies.push(field.id);sourceField.dependencies=sourceField.dependencies.unique();return sourceField.id}else{return sourceFieldName}})).unique()}}this._initFieldsFormulaExecutionOrder();this._initFieldsDeepDependencies();return this._checkFieldsCyclicDependencies()}_initFieldsFormulaExecutionOrder(){let dependencies={};let inDegree={};for(let field of this.fields){if(field.computed){dependencies[field.id]=new Set(field.dependencies||[]);inDegree[field.id]=0}}for(let fieldId in dependencies){for(let dep of dependencies[fieldId]){if(!(dep in inDegree)){inDegree[dep]=0}inDegree[dep]++}}let queue=Object.keys(inDegree).filter((fieldId=>inDegree[fieldId]===0));let orderedFields=[];while(queue.length>0){let fieldId=queue.shift();orderedFields.push(fieldId);if(dependencies[fieldId]){dependencies[fieldId].forEach((dep=>{inDegree[dep]--;if(inDegree[dep]===0)queue.push(dep)}))}}this.orderedComputedFields=orderedFields.filter((fieldId=>{let field=this.getField(fieldId);return field.computed}));return this}_initFieldsDeepDependencies(){const getDeepDependencies=(fieldId,visited=new Set)=>{if(visited.has(fieldId))return[];visited.add(fieldId);let field=this.getField(fieldId);if(!field||!field.dependencies)return[];let deepDeps=new Set(field.dependencies);for(let dep of field.dependencies){let subDeps=getDeepDependencies(dep,visited);subDeps.forEach((d=>deepDeps.add(d)))}return Array.from(deepDeps)};this.fields.forEach((field=>field.deepDependencies=getDeepDependencies(field.id)));return this}_checkFieldsCyclicDependencies(){let computedFields=this.fields.filter((field=>!field.deleted&&field.computed&&field.deepDependencies&&Array.isArray(field.deepDependencies)&&field.deepDependencies.length>0));for(let field of computedFields){if(field.deepDependencies.includes(field.id)){this.hasCyclicDependencies=true;log.warn(`kiss.data.Model - Cyclic dependency detected in model <${this.name}> (${this.id}) on field <${field.label}> (${field.id})`);return field.id}}this.hasCyclicDependencies=false;return false}_initAcceptedFields(){const defaultAcceptedFields=["id","createdAt","createdBy","updatedAt","updatedBy","deletedAt","deletedBy","accessRead","accessUpdate","accessDelete","accessManage"];const acceptedFields=this.fields.map((field=>field.id));this.acceptedFields=defaultAcceptedFields.concat(acceptedFields);return this}_initClientItems(items,read,update){if(!items)return[];const userACL=kiss.session.getACL();items=items.filter((item=>item!=null));items.forEach((item=>{if(!item.id)item.id=kiss.tools.shortUid();if(item.items){const canRead=kiss.tools.intersects(item.accessRead,userACL)||!item.accessRead;const canUpdate=kiss.tools.intersects(item.accessUpdate,userACL)||!item.accessUpdate;item.acl=item.acl||{};item.acl.read=!!canRead;item.acl.update=!!canUpdate;this._initClientItems(item.items,canRead,canUpdate)}else{item.acl=item.acl||{};item.acl.read=read;item.acl.update=update;if(item.type=="select"){if(!item.options)return;item.options=item.options.map((option=>{if(typeof option=="object")return option;return{value:option}}))}}}));this.items=items;return this}_initServerItems(items){if(!items)return[];items=items.filter((item=>item!=null));items.forEach((item=>{if(!item.id)item.id=kiss.tools.shortUid();if(item.items){this._initServerItems(item.items)}else{if(item.type=="select"){if(!item.options)return;item.options=item.options.map((option=>{if(typeof option=="object")return option;return{value:option}}))}}}));this.items=items;return this}_initRecordFactory(){this.recordFactory=kiss.data.RecordFactory(this.id);return this}_initMasterCollection(){this.collection=new kiss.data.Collection({id:this.id,mode:this.mode,model:this,isMaster:true,sortSyntax:"normalized",sort:[{[this.getPrimaryKeyField().id]:"asc"}]});return this}_initSubscriptions(){const modelId=this.id.toUpperCase();this.subscriptions=[subscribe("EVT_DB_UPDATE:MODEL",(msgData=>{if(this.id==msgData.id){Object.assign(this,msgData.data);if(msgData.data.hasOwnProperty("items")){this._initItems(this.items);this._initFields()}}})),subscribe("EVT_DB_UPDATE_BULK",(msgData=>{if(msgData.data&&msgData.data[0]&&msgData.data[0].modelId=="model"&&msgData.data[0].recordId==this.id){Object.assign(this,msgData.data[0].updates)}})),subscribe("EVT_DB_INSERT:"+modelId,this._notifyUser),subscribe("EVT_DB_UPDATE:"+modelId,this._notifyUser),subscribe("EVT_DB_DELETE:"+modelId,this._notifyUser),subscribe("EVT_DB_UPDATE_BULK",(msgData=>{let isUpdated=false;for(let operation of msgData.data){if(operation.modelId==this.id){isUpdated=true;break}}if(isUpdated)this._notifyUser(msgData)}))];return this}async addField(config,sectionId){if(!config.id)config.id=kiss.tools.shortUid();if(!this.hasSections()){this.items.push(config)}else{if(!sectionId){const lastSection=this.items[this.items.length-1];lastSection.items.push(config)}else{this.items.find((section=>section.id==sectionId)).items.push(config)}}this._initFields();this._initElements();this._initComputedFields();await this._saveItems();if(kiss.session.isOffline()){this._defineRelationships()}if(config.computed){await this.updateFieldFormula(config.id)}await this.syncViewsWithModelFields();kiss.context.addFieldToSectionId=null;return config}getField(fieldId){if(!fieldId)return null;const field=this.fields.find((field=>field.id==fieldId));if(field)return field;return this.getFieldByLabel(fieldId)}getFieldId(fieldLabel){const field=this.getFieldByLabel(fieldLabel);return field?field.id:null}getFieldByLabel(fieldLabel){const fields=this.fields.filter((field=>!field.deleted));let field=fields.find((field=>field.label&&field.label.toLowerCase()==fieldLabel.toLowerCase()));if(field)return field;field=fields.find((field=>field.id.toLowerCase()==fieldLabel.toLowerCase()));return field}getFieldType(field){if(field.type=="lookup"){return field.lookup.type}else if(field.type=="summary"){return field.summary.type}else{return field.type||"text"}}getFieldLabel(field){let fieldLabel;if(!field.label){fieldLabel=txtTitleCase(field.id)}else if(field.label.startsWith("#")){fieldLabel=txtTitleCase(field.label)}else if(field.label&&field.labelTranslations){fieldLabel=field.labelTranslations[kiss.language.currentDynamic];fieldLabel=fieldLabel?fieldLabel.toTitleCase():field.label.toTitleCase()}else{fieldLabel=field.label.toTitleCase()}return fieldLabel}getPrimaryKeyField(){const fields=this.fields;const primaryKeyField=fields.find((field=>field.primary==true));if(primaryKeyField)return primaryKeyField;return fields[0]}getLinkField(foreignModelId){const fields=this.fields;for(let field of fields){if(field.type=="link"){if(field.link.modelId==foreignModelId)return field}}return null}async updateField(fieldId,config,shouldUpdateFormula){this._updateItemInTree(this,fieldId,config);this._initFields();this._initElements();this._initComputedFields();await this._saveItems();if(kiss.session.isOffline()){this._defineRelationships()}if(shouldUpdateFormula){await this.updateFieldFormula(fieldId)}await this.syncViewsWithModelFields();return true}async updateFieldFormula(){if(kiss.session.isOffline()){await kiss.data.relations.updateAllDeep(this.id)}else{await kiss.ajax.request({showLoading:true,url:"/updateAllDeep",method:"post",body:JSON.stringify({modelId:this.id})})}}_checkFormula(formula){const tags=kiss.tools.findTags(formula);let errorFields=[];tags.forEach((fieldLabel=>{const field=this.getFieldByLabel(fieldLabel);if(kiss.tools.isNumber(fieldLabel))return;if(!field)errorFields.push(fieldLabel)}));return errorFields}_checkFormulaCyclicDependencies(label,formula){let errorFields=[];const tags=kiss.tools.findTags(formula);tags.forEach((tag=>{const tagField=this.getFieldByLabel(tag);if(!tagField)return;if(!tagField.formula)return;let fieldFormula=tagField.formula;if(tag==label)fieldFormula=formula;const tagFieldTags=kiss.tools.findTags(fieldFormula);if(tagFieldTags.includes(label))errorFields.push(tagField.label)}));return errorFields}async deleteField(fieldId){let field=this.getField(fieldId);if(!field)field=this.getElement(fieldId);if(!field){log("kiss.data.Model - deleteField: could not find the item to delete",3);return false}if(field.primary==true){log("kiss.data.Model - deleteField: could not delete primary field",3);return false}if(field.type=="html"||field.type=="image"||field.type=="button"){return this.deleteElement(fieldId)}log(`kiss.data.Model - deleteField: ${fieldId} / ${field.label}`);field.deleted=true;await this.updateField(fieldId,field);this._initFields();return true}getFields(containerItems){const fieldTypes=kiss.global.fieldTypes.map((type=>type.value));let fields=[];let items=containerItems||this.items||[];items=items.filter((item=>item!=null));items.forEach((item=>{if(fieldTypes.indexOf(item.type)!=-1||item.dataType!=null){fields.push(item)}else{if(item.items){fields.push(this.getFields(item.items))}}}));return fields.flat()}getSystemFields(){return[{id:"createdAt",label:"#createdAt",type:"date",dataType:Date,isSystem:true,readOnly:true,hidden:true,acl:{update:false}},{id:"createdBy",label:"#createdBy",type:"directory",dataType:Date,isSystem:true,readOnly:true,hidden:true,acl:{update:false}},{id:"updatedAt",label:"#updatedAt",type:"date",dataType:Date,isSystem:true,readOnly:true,hidden:true,acl:{update:false}},{id:"updatedBy",label:"#updatedBy",type:"directory",dataType:Date,isSystem:true,readOnly:true,hidden:true,acl:{update:false}},{id:"deletedAt",label:"#deletedAt",type:"date",dataType:Date,isSystem:true,readOnly:true,hidden:true,acl:{update:false}},{id:"deletedBy",label:"#deletedBy",type:"directory",dataType:Date,isSystem:true,readOnly:true,hidden:true,acl:{update:false}}]}getFeatureFields(){if(kiss.isServer)return[];let featureFields=[];if(this.features){Object.keys(this.features).filter((featureId=>this.features[featureId].active)).forEach((featureId=>{const plugin=kiss.plugins.get(featureId);if(!plugin)return;const texts=plugin.texts||{};if(plugin&&plugin.fields){plugin.fields.forEach((field=>{field.isFromPlugin=true;field.pluginId=featureId;field.label=txtTitleCase(field.label,texts);featureFields.push(field)}))}}))}return featureFields}getFieldsAsColumns(){let columns=this.fields.filter((field=>field.label)).map((field=>{if(field.deleted)return null;let columnConfig={id:field.id,type:this.getFieldType(field),title:this.getFieldLabel(field)};if(field.isFromPlugin){columnConfig.isFromPlugin=true;columnConfig.pluginId=field.pluginId;columnConfig.title=txtTitleCase(field.label)}if(field.isSystem){columnConfig.isSystem=true;columnConfig.title=txtTitleCase(field.label);columnConfig.hidden=field.hidden!==false}return columnConfig})).filter((column=>column!=null));return columns}getFieldsAsOptions(types){const isDynamicModel=kiss.tools.isUid(this.id);if(!Array.isArray(types))types=[types];if(types.length==0)return[];const fields=this.getFieldsByType(types);if(fields.length==0)return[];return fields.filter((field=>!field.deleted)).map((field=>({value:field.id,label:isDynamicModel&&!field.isSystem?field.label.toTitleCase():txtTitleCase(field.label),isFromPlugin:!!field.isFromPlugin})))}getActiveFields(){return this.fields.filter((field=>!field.deleted))}getFieldsByType(types){const fields=this.fields;if(!Array.isArray(types))types=[types];if(types.length>0){return fields.filter((field=>{if(field.type=="lookup"){return types.includes(field.lookup.type)}else if(field.type=="summary"){return types.includes(field.summary.type)}else{return types.includes(field.type)}}))}}getSortableFields(){return this.fields.filter((field=>field.type!="password"&&field.type!="link"&&field.type!="attachment"&&field.label&&field.deleted!=true&&field.multiple!=true))}getGroupableFields(){return this.fields.filter((field=>field.type!="password"&&field.type!="link"&&field.type!="attachment"&&field.label&&field.deleted!=true&&field.multiple!=true&&!field.isSystem))}getFilterableFields(){return this.fields.filter((field=>field.type!="link"&&field.label&&field.deleted!=true))}getFormulaFields(){return this.fields.filter((field=>field.type!="link"&&field.type!="attachment"&&field.label&&field.deleted!=true&&field.isSystem!=true&&field.isFromPlugin!=true))}getUpdatableFields(){return this.fields.filter((field=>field.deleted!=true&&field.isSystem!=true&&field.computed!=true&&!field.sourceFor&&field.type!="lookup"&&field.type!="summary"&&field.type!="attachment"&&field.type!="password"&&field.type!="selectViewColumn"&&field.type!="selectViewColumns"&&field.type!="link"&&field.type!="aiImage"))}getElement(elementId){return this.elements.find((element=>element.id==elementId))}getElements(containerItems){const elementTypes=["html","button","image"];let elements=[];let items=containerItems||this.items||[];items=items.filter((item=>item!=null));items.forEach((item=>{if(elementTypes.indexOf(item.type)!=-1||item.dataType!=null){elements.push(item)}else{if(item.items){elements.push(this.getElements(item.items))}}}));return elements.flat()}async deleteElement(elementId){let element=this.getElement(elementId);if(!element)return false;this._deleteItemFromTree(this,elementId,element);await this._saveItems();this._initElements();return true}getSection(sectionId){let section=this.items.find((section=>section.id==sectionId));if(section)return section;return this.getSectionByTitle(sectionId)}getSectionByTitle(sectionTitle){let section=this.items.find((section=>section.title&&section.title.toLowerCase()==sectionTitle.toLowerCase()));if(section)return section;section=this.items.find((section=>section.id.toLowerCase()==sectionTitle.toLowerCase()));return section}hasSections(){const modelSections=this.items.filter((item=>item.type=="panel"));return modelSections.length>0}getSections(){let sections=[];let items=this.items||[];items=items.filter((item=>item!=null));items.forEach((item=>{if(item.items)sections.push(item)}));return sections}async createFirstSection(config){const newSectionId=kiss.tools.shortUid();const newSection={id:newSectionId,type:"panel",icon:config.icon||"far fa-file-alt",title:config.title||"Section",collapsible:true,collapsed:config.collapsed,colored:config.colored,acl:config.acl,items:this.items};this.items=[newSection];await this._saveItems();this._initItems(this.items);this._initFields();this._initElements();return newSectionId}async createSection(config,breakItemId){const sections=this.items;let breakIndex;let sectionIndex;sections.forEach(((section,index)=>{const itemIndex=section.items.findIndex((item=>item.id==breakItemId));if(itemIndex!=-1){breakIndex=itemIndex;sectionIndex=index}}));if(breakIndex==0)return false;const fieldsInPreviousSection=sections[sectionIndex].items.slice(0,breakIndex);const fieldsInNewSection=sections[sectionIndex].items.slice(breakIndex);sections[sectionIndex].items=fieldsInPreviousSection;const newSectionId=kiss.tools.shortUid();const newSection={id:newSectionId,type:"panel",icon:config.icon||"far fa-file-alt",title:config.title||"Section",collapsible:true,collapsed:config.collapsed,colored:config.colored,accessRead:config.accessRead,accessUpdate:config.accessUpdate,acl:config.acl,items:fieldsInNewSection};sections.splice(sectionIndex+1,0,newSection);this.items=sections;await this._saveItems();this._initItems(this.items);this._initFields();this._initElements();return newSectionId}isFirstItemInSection(itemId){if(!this.hasSections())return false;let breakIndex;const sections=this.items;sections.forEach(((section,index)=>{const itemIndex=section.items.findIndex((item=>item.id==itemId));if(itemIndex!=-1){breakIndex=itemIndex}}));if(breakIndex===0)return true;return false}async updateSection(sectionId,newSectionConfig){this._updateItemInTree(this,sectionId,newSectionConfig);await this._saveItems();this._initItems(this.items);this._initFields();this._initElements()}async deleteSection(sectionId){for(let i=0;i<this.items.length;i++){const section=this.items[i];if(section.id==sectionId){const fieldsToMove=section.items;let previousSection=this.items[i-1];let nextSection=this.items[i+1];if(i==0){if(nextSection){nextSection.items.splice(0,0,...fieldsToMove);this.items.splice(i,1)}else{this.items=fieldsToMove}}else{previousSection.items.splice(previousSection.items.length,0,...fieldsToMove);this.items.splice(i,1)}await this._saveItems();this._initItems(this.items);this._initFields();this._initElements();return true}}}async moveSection(sectionId,direction){const fromIndex=this.items.findIndex((section=>section.id==sectionId));if(fromIndex==-1)return false;const toIndex=direction=="down"?fromIndex+1:fromIndex-1;const tempSection=this.items[fromIndex];this.items[fromIndex]=this.items[toIndex];this.items[toIndex]=tempSection;await this._saveItems();return true}async _saveItems(){if(!Array.isArray(this.items))return;if(this.items.length==0)return;const modelRecord=kiss.app.collections.model.getRecord(this.id);await modelRecord.update({items:this.items})}exportAsJSON(){let items;const hasSections=this.items[0].items?true:false;if(hasSections){items=this.items.map((section=>{section.items=section.items.filter((item=>!item.deleted)).map(this._sanitizeFieldProperties);section.accessRead=["*"];section.accessUpdate=["*"];return section}))}else{items=this.items.filter((item=>!item.deleted)).map(this._sanitizeFieldProperties)}return{id:this.id,name:this.name,namePlural:this.namePlural,language:kiss.language.current,icon:this.icon,color:this.color,fullscreen:!!this.fullscreen,items:items,features:this.features,authenticatedCanCreate:true,authenticatedCanRead:true,authenticatedCanUpdate:true,authenticatedCanDelete:true,ownerCanManage:true,accessCreate:[],accessRead:[],accessUpdate:[],accessDelete:[],accessManage:[]}}_sanitizeFieldProperties(field){delete field.acl;delete field.formulaSourceFields;delete field.formulaSourceFieldIds;if(field.type=="lookup"||field.type=="summary")delete field.formula;delete field.sourceFor;if(field.type=="link")delete field.link.model;delete field.target;let exportedField={};Object.keys(field).sortAlpha().forEach((property=>exportedField[property]=field[property]));return exportedField}_updateItemInTree(node,itemId,config){if(node.id==itemId){Object.assign(node,config)}else if(node.items){for(let i=0;i<node.items.length;i++){this._updateItemInTree(node.items[i],itemId,config)}}}_deleteItemFromTree(node,itemId){if(node.items){for(let i=0;i<node.items.length;i++){if(node.items[i].id===itemId){node.items.splice(i,1);return true}else if(this._deleteItemFromTree(node.items[i],itemId)){return true}}}return false}getViews(){const viewCollection=kiss.app.collections.view;if(!viewCollection)return;const viewRecords=viewCollection.records;const modelViews=viewRecords.filter((view=>view.modelId==this.id));return modelViews}getViewsByUser(userId){const views=this.getViews();const userACL=kiss.directory.getUserACL(userId);if(kiss.session.isOwner)return views;if(kiss.session.isAccountManager())return views;return views.filter((view=>!!view.authenticatedCanRead==true||kiss.tools.intersects(view.accessRead,userACL)||view.createdBy==userId))}async syncViewsWithModelFields(){const viewsToUpdate=this.getViews();for(let viewRecord of viewsToUpdate){await viewRecord.syncWithModelFields()}}async generateLinksToModel({foreignModelId:foreignModelId,sourceLinkFieldId:sourceLinkFieldId,sourceFieldId:sourceFieldId,foreignLinkFieldId:foreignLinkFieldId,foreignFieldId:foreignFieldId}){const localCollection=this.collection;const foreignCollection=kiss.app.collections[foreignModelId];const localRecords=await localCollection.find({},true);const foreignRecords=await foreignCollection.find({},true);let links=[];localRecords.forEach((localRecord=>{foreignRecords.forEach((foreignRecord=>{let localValue=localRecord[sourceFieldId];if(localValue==foreignRecord[foreignFieldId]&&localValue!==""&&localValue!==undefined){links.push({id:kiss.tools.uid(),mX:this.id,rX:localRecord.id,fX:sourceLinkFieldId,mY:foreignModelId,rY:foreignRecord.id,fY:foreignLinkFieldId,auto:true})}}))}));return links}async deleteLinksToModel(foreignModelId){const query={$or:[{mX:this.id,mY:foreignModelId,auto:true},{mY:this.id,mX:foreignModelId,auto:true}]};await kiss.app.collections.link.deleteMany(query)}async connectToModel(foreignModelId,fieldSetup){const foreignModel=kiss.app.models[foreignModelId];const foreignLinkFields=foreignModel.getFieldsByType("link");log("kiss.data.Model - Connecting model "+this.name+" to model "+foreignModel.name);let foreignLinkFieldId=null;let existingLinkField=null;let foreignLinkFieldConfig={};foreignLinkFields.forEach((linkField=>{if(linkField.link.modelId==this.id)existingLinkField=linkField}));if(existingLinkField!=null){log("kiss.data.Model - connectToModel: updating existing link in the foreign model "+foreignModel.name,2);delete existingLinkField.deleted;existingLinkField.link.field=fieldSetup.label;existingLinkField.link.fieldId=fieldSetup.id;existingLinkField.deleted=false;existingLinkField.hidden=false;await foreignModel.updateField(existingLinkField.id,existingLinkField);foreignLinkFieldId=existingLinkField.id}else{log("kiss.data.Model - connectToModel: adding a new link field in the foreign model "+foreignModel.name,2);foreignLinkFieldConfig={id:kiss.tools.shortUid(),label:this.namePlural,type:"link",display:"inline-flex",width:"100%",fieldWidth:"100%",labelWidth:"100%",labelPosition:"top",labelAlign:"left",link:{model:this.name,modelId:this.id,field:fieldSetup.label,fieldId:fieldSetup.id}};await foreignModel.addField(foreignLinkFieldConfig);foreignLinkFieldId=foreignLinkFieldConfig.id;log("kiss.data.Model - Foreign link field config:",2,foreignLinkFieldConfig)}fieldSetup.deleted=fieldSetup.hidden=false;fieldSetup.link.fieldId=foreignLinkFieldId;await this.updateField(fieldSetup.id,fieldSetup);this._defineRelationships();foreignModel._defineRelationships();return foreignLinkFieldConfig}_defineRelationships(){const modelProblems=[];this.sourceFor=this.sourceFor||[];const fields=this.fields.filter((field=>!field.deleted));fields.filter((field=>field.type=="link")).forEach((field=>{try{let targetLinkModel=kiss.app.getModel(field.link.modelId||field.link.model);if(!targetLinkModel){throw new Error("Model not found")}if(!field.link.modelId){field.link.modelId=targetLinkModel.id;delete field.link.model}let targetLinkField=targetLinkModel.getField(field.link.fieldId||field.link.field);if(!targetLinkField){throw new Error("Symmetric link field not found in the foreign model")}field.link.fieldId=targetLinkField.id;let hasMany=field.multiple;let toModel=hasMany?targetLinkModel.namePlural:targetLinkModel.name}catch(err){field.type="text";modelProblems.push(`kiss.data.Model - The link field <${this.name+" / "+field.label}> points to a foreign model or a foreign link field that can't be found`)}}));fields.filter((field=>field.type=="lookup")).forEach((field=>{try{let lookupLinkField=this.getField(field.lookup.linkId||field.lookup.link);let lookupLinkedModel=kiss.app.models[lookupLinkField.link.modelId];if(!lookupLinkedModel)throw new Error("Model not found");let lookupSourceField=lookupLinkedModel.getField(field.lookup.fieldId||field.lookup.field);lookupLinkedModel.sourceFor=(lookupLinkedModel.sourceFor||[]).concat(this.id).unique();field.computed=true;if(!field.lookup.linkId){field.lookup.linkId=lookupLinkField.id;delete field.lookup.link}if(!field.lookup.fieldId){field.lookup.fieldId=lookupSourceField.id;delete field.lookup.field}field.lookup.type=lookupSourceField.type;if(field.lookup.type=="number")field.precision=lookupSourceField.precision;lookupSourceField.sourceFor=lookupSourceField.sourceFor||[];let newSource={modelId:this.id,modelName:this.name,fieldId:field.id,fieldName:field.label,type:"lookup"};if(!lookupSourceField.sourceFor.includesObject(newSource))lookupSourceField.sourceFor.push(newSource);lookupSourceField.sourceFor=lookupSourceField.sourceFor.uniqueObject("fieldId")}catch(err){field.type="text";modelProblems.push(`kiss.data.Model - The lookup field <${this.name+" / "+field.label}> points to a model that can't be found`)}}));fields.filter((field=>field.type=="summary")).forEach((field=>{try{let summaryLinkField=this.getField(field.summary.linkId||field.summary.link);let summaryLinkModel=kiss.app.models[summaryLinkField.link.modelId];if(!summaryLinkModel)throw new Error("Model not found");let summaryField=summaryLinkModel.getField(field.summary.field||field.summary.fieldId);summaryLinkModel.sourceFor=(summaryLinkModel.sourceFor||[]).concat(this.id).unique();field.computed=true;if(!field.summary.linkId){field.summary.linkId=summaryLinkField.id;delete field.summary.link}if(!field.summary.fieldId){field.summary.fieldId=summaryField.id;delete field.summary.field}field.summary.type=summaryField.type;if(field.summary.type=="number")field.precision=summaryField.precision;summaryField.sourceFor=summaryField.sourceFor||[];let newSource={modelId:this.id,modelName:this.name,fieldId:field.id,fieldName:field.label,type:"summary"};if(!summaryField.sourceFor.includesObject(newSource))summaryField.sourceFor.push(newSource);summaryField.sourceFor=summaryField.sourceFor.uniqueObject("fieldId")}catch(err){field.type="text";modelProblems.push(`kiss.data.Model - The summary field <${this.name+" / "+field.label}> points to a model that can't be found`)}}));this.sourceFor=this.sourceFor.unique();modelProblems.forEach((warning=>log(warning)));return this}_notifyUser(msgData){if(msgData.userId==kiss.session.getUserId())return;let msgEvent;let object;if(msgData.channel=="EVT_DB_UPDATE_BULK"){msgEvent=txtTitleCase("#msg update");object="#some data"}else{const event=msgData.channel.split(":")[0];const modelId=msgData.channel.split(":")[1];if(event.includes("INSERT"))msgEvent=txtTitleCase("#msg insert");else if(event.includes("UPDATE"))msgEvent=txtTitleCase("#msg update");else if(event.includes("DELETE"))msgEvent=txtTitleCase("#msg delete");if(kiss.tools.isUid(modelId.toLowerCase()))object="#a record";else if(modelId=="VIEW")object="#a view";else if(modelId=="MODEL")object="#a model";else object="#some data"}createNotification({message:txtTitleCase(msgEvent,null,{user:kiss.directory.getEntryName(msgData.userId),object:txt(object)}),top:()=>kiss.screen.current.height-50,left:10,height:"40px",padding:"0px",animation:"slideInUp",duration:4e3})}};kiss.data.RecordFactory=function(modelId){const Record=class{constructor(recordData,inherit){this.model=kiss.app.models[modelId];this.db=this.model.db;if(!recordData||inherit){this.id=uid();this.createdAt=(new Date).toISOString();this.createdBy=kiss.session.getUserId();this._initDefaultValues();this._computeFields()}else{this.id=recordData.id||uid();Object.assign(this,recordData)}if(inherit)Object.assign(this,recordData);return this}_initDefaultValues(){this.model.getFields().forEach((field=>{let defaultValue=field.value;if(defaultValue===0){this[field.id]=defaultValue;return}if(defaultValue&&typeof defaultValue=="string"){if(defaultValue.includes("today+")||defaultValue.includes("today-")){const daysFromNow=Number(field.value.split("today")[1]);if(!isNaN(daysFromNow)){let newDate=(new Date).addDays(daysFromNow);defaultValue=newDate.toISO()}}else{defaultValue=defaultValue.replace("username",kiss.session.getUserId()).replace("today",(new Date).toISO()).replace("now",kiss.tools.getTime()).replace("unid",kiss.tools.shortUid().toUpperCase()).replace("{YYYY}",(new Date).getFullYear()).replace("{MM}",((new Date).getMonth()+1).toString().padStart(2,"0")).replace("{DD}",(new Date).getDate().toString().padStart(2,"0")).replace("{hh}",(new Date).getHours().toString().padStart(2,"0")).replace("{mm}",(new Date).getMinutes().toString().padStart(2,"0")).replace("{ss}",(new Date).getSeconds().toString().padStart(2,"0")).replace("{XX}",String.fromCharCode(65+Math.random()*26|0)+String.fromCharCode(65+Math.random()*26|0)).replace("{NN}",(Math.floor(Math.random()*100)+"").padStart(2,"0"))}this[field.id]=defaultValue}else if(defaultValue){this[field.id]=defaultValue}}));return this}async checkPermission(action){const hasPermission=await kiss.acl.check({action:action,record:this});if(!hasPermission){createNotification(txtTitleCase("#not authorized"));return false}return true}hasChanged(data){if(!data)data=this.getSanitizedData();const currentState=JSON.stringify(data);if(currentState==this.lastState)return false;this.lastState=currentState;return true}getSanitizedData(){const data={id:this.id};this.model.fields.forEach((field=>{data[field.id]=this[field.id]}));return data}async save(){let loadingId;try{log("kiss.data.Record - Saving "+this.id);const data=this.getSanitizedData();const permission=await this.checkPermission("create");if(!permission)return false;loadingId=kiss.loadingSpinner.show();const response=await this.db.insertOne(this.model.id,data);kiss.loadingSpinner.hide(loadingId);if(response.error){log("kiss.data.Record - save - Error: "+response.error,4);return false}return true}catch(err){log("kiss.data.Record - save - Error:",4,err);kiss.loadingSpinner.hide(loadingId)}}async duplicate(config={}){const linksToDuplicate=config.linksToDuplicate||[];const linksToMaintain=config.linksToMaintain||[];const resetPluginFields=config.resetPluginFields!=undefined?config.resetPluginFields:true;let loadingId;try{const permission=await this.checkPermission("create");if(!permission)return false;loadingId=kiss.loadingSpinner.show();const data=this.getSanitizedData();data.id=kiss.tools.uid();data.createdAt=(new Date).toISOString();data.createdBy=kiss.session.getUserId();const attachmentFields=this.model.getFieldsByType("attachment");attachmentFields.forEach((field=>{data[field.id]=[]}));if(resetPluginFields){const pluginFields=this.model.fields.filter((field=>field.isFromPlugin));pluginFields.forEach((field=>{delete data[field.id]}))}const response=await this.db.insertOne(this.model.id,data);if(response.error){log("kiss.data.Record - duplicate - Error: "+response.error,4);kiss.loadingSpinner.hide(loadingId);return false}let newChildren=[];let newLinks=[];let linkFields=this.model.getFieldsByType("link").filter((field=>!field.deleted));for(let linkField of linkFields){const foreignLinkFieldId=linkField.link.fieldId;const foreignModelId=linkField.link.modelId;if(linksToDuplicate.includes(linkField.id)){const foreignRecords=await this.getLinkedRecordsFrom(linkField.id);for(let foreignRecord of foreignRecords){foreignRecord.id=kiss.tools.uid();foreignRecord.createdAt=(new Date).toISOString();foreignRecord.createdBy=kiss.session.getUserId();const attachmentFields=kiss.app.models[foreignModelId].getFieldsByType("attachment");attachmentFields.forEach((field=>{foreignRecord[field.id]=[]}));if(resetPluginFields){const pluginFields=kiss.app.models[foreignModelId].fields.filter((field=>field.isFromPlugin));pluginFields.forEach((field=>{delete foreignRecord[field.id]}))}newChildren.push(foreignRecord);const linkInfos={id:kiss.tools.uid(),mX:this.model.id,rX:data.id,fX:linkField.id,mY:foreignModelId,rY:foreignRecord.id,fY:foreignLinkFieldId,accountId:kiss.session.currentAccountId,createdAt:(new Date).toISOString(),createdBy:kiss.session.getUserId()};newLinks.push(linkInfos)}}else if(linksToMaintain.includes(linkField.id)){const foreignRecords=await this.getLinkedRecordsFrom(linkField.id);for(let foreignRecord of foreignRecords){const linkInfos={id:kiss.tools.uid(),mX:this.model.id,rX:data.id,fX:linkField.id,mY:foreignModelId,rY:foreignRecord.id,fY:foreignLinkFieldId,accountId:kiss.session.currentAccountId,createdAt:(new Date).toISOString(),createdBy:kiss.session.getUserId()};newLinks.push(linkInfos)}}const foreignCollection=kiss.app.collections[foreignModelId];if(newChildren.length>0){log.info("kiss.data.Record - duplicate - Inserting new children");await foreignCollection.insertMany(newChildren)}}const linkCollection=kiss.app.collections.link;if(newLinks.length>0){log.info("kiss.data.Record - duplicate - Inserting new links");await linkCollection.insertMany(newLinks)}kiss.loadingSpinner.hide(loadingId);return data.id}catch(err){log("kiss.data.Record - duplicate - Error:",4,err);kiss.loadingSpinner.hide(loadingId)}}async getLinkedRecordsFrom(fieldId){return await kiss.data.relations.getLinkedRecordsFrom(this.model.id,this.id,fieldId)}async read(){let record=await this.db.findOne(this.model.id,this.id);Object.assign(this,record);return this}async update(update,silent){let loadingId;try{log("kiss.data.Record - update "+this.id,0,update);if(!silent)loadingId=kiss.loadingSpinner.show();if(!this.hasChanged(update)){log("kiss.data.Record - update - Record didn't change, exit!");if(!silent)kiss.loadingSpinner.hide(loadingId);return true}const permission=await this.checkPermission("update");if(!permission){kiss.loadingSpinner.hide(loadingId);return false}if(!update)update=this.getSanitizedData();Object.assign(this,update);const response=await this.db.updateOne(this.model.id,this.id,update);if(!silent)kiss.loadingSpinner.hide(loadingId);return response}catch(err){log("kiss.data.Record - update - Error:",4,err);if(!silent)kiss.loadingSpinner.hide(loadingId);return false}}async updateDeep(update){let loadingId;try{log(`kiss.data.Record - updateDeep ${this.id} / ${update}`);loadingId=kiss.loadingSpinner.show();const permission=await this.checkPermission("update");if(!permission){kiss.loadingSpinner.hide(loadingId);return false}const response=await this.db.updateOneDeep(this.model.id,this.id,update);kiss.loadingSpinner.hide(loadingId);if(response)return true}catch(err){log("kiss.data.Record - updateDeep - Error:",4,err);kiss.loadingSpinner.hide(loadingId);return false}}async updateFieldDeep(fieldId,value){let loadingId;try{log(`kiss.data.Record - updateFieldDeep ${this.id} / ${fieldId} / ${value}`);loadingId=kiss.loadingSpinner.show();const permission=await this.checkPermission("update");if(!permission){kiss.loadingSpinner.hide(loadingId);return false}const validation=await this.checkValidationRules(fieldId,value);if(!validation){kiss.loadingSpinner.hide(loadingId);return false}const field=this.model.getField(fieldId);if(field&&field.type!="attachment"&&field.type!="aiImage"&&kiss.tools.isUid(this.model.id)){kiss.undoRedo.addOperation({id:uid(),action:"updateField",createdAt:new Date,createdBy:kiss.session.getUserId(),modelId:this.model.id,recordId:this.id,fieldId:fieldId,oldValue:this[fieldId],newValue:value})}const response=await this.db.updateOneDeep(this.model.id,this.id,{[fieldId]:value});kiss.loadingSpinner.hide(loadingId);if(response)return true}catch(err){log("kiss.data.Record - updateFieldDeep - Error:",4,err);kiss.loadingSpinner.hide(loadingId);return false}}async checkValidationRules(fieldId,value){const field=this.model.getField(fieldId);if(!field){log(`kiss.data.Record - checkValidationRules - Field ${fieldId} not found`);return true}if(!field.validationFunction)return true;const result=await field.validationFunction(value);return!!result}async delete(sendToTrash){let loadingId;try{log("kiss.data.Record - delete "+this.id);loadingId=kiss.loadingSpinner.show();const permission=await this.checkPermission("delete");if(!permission){kiss.loadingSpinner.hide(loadingId);return false}if(kiss.tools.isUid(this.model.id)){kiss.undoRedo.addOperation({id:uid(),action:"deleteRecord",createdAt:new Date,createdBy:kiss.session.getUserId(),modelId:this.model.id,recordId:this.id})}const response=await this.db.deleteOne(this.model.id,this.id,sendToTrash);kiss.loadingSpinner.hide(loadingId);return response}catch(err){log("kiss.data.Record - update - Error:",4,err);kiss.loadingSpinner.hide(loadingId);return false}}get(fieldId){const field=this.model.getField(fieldId);if(!field)return this[fieldId];return this[field.id]}async linkTo(foreignRecord,localLinkFieldId,foreignLinkFieldId){let loadingId;try{log(`kiss.data.Record - linkTo ${this.id} / ${foreignRecord.id}`);loadingId=kiss.loadingSpinner.show();const linkModel=kiss.app.models.link;const linkInfos={id:kiss.tools.uid(),mX:this.model.id,rX:this.id,fX:localLinkFieldId,mY:foreignRecord.model.id,rY:foreignRecord.id,fY:foreignLinkFieldId};const newLink=linkModel.create(linkInfos);await newLink.save();await this.db.updateLink(linkInfos);kiss.loadingSpinner.hide(loadingId)}catch(err){log("kiss.data.Record - linkTo - Error:",4,err);kiss.loadingSpinner.hide(loadingId)}}async deleteLink(linkId){let loadingId;try{log(`kiss.data.Record - deleteLink ${this.id} / ${linkId}`);loadingId=kiss.loadingSpinner.show();const linkModel=kiss.app.models.link;const linkRecord=await linkModel.collection.findOne(linkId);const linkInfos=await linkRecord.getData();const result=await linkRecord.delete();if(!result){kiss.loadingSpinner.hide(loadingId);return false}await this.db.updateLink(linkInfos);kiss.loadingSpinner.hide(loadingId);return result}catch(err){log("kiss.data.Record - linkTo - Error:",4,err);kiss.loadingSpinner.hide(loadingId)}}async getData(config={},skipIds,accountId){const recordData={id:this.id};const modelId=this.model.id;const skipModelIds=Array.isArray(skipIds)?skipIds:[];skipModelIds.push(modelId);config.linksDepth=config.linksDepth!=undefined?config.linksDepth:1;const depth=config.linksDepth-1;const newConfig=Object.assign({},config,{linksDepth:depth});let fields=this.model.fields.filter((field=>!field.deleted));if(config.projection){fields=fields.filter((field=>config.projection.includes(field.id)||config.projection.includes(field.label)))}for(let field of fields){const fieldLabel=config.useLabels==true?field.label:field.id||field.label;if(field.type=="link"){if(config.includeLinks==true&&depth>=0){const linkedModelId=field.link.modelId;if(!skipModelIds.includes(linkedModelId)){let sort;if(config.sortLinks)sort=await this._getLinkFieldSortConfig(linkedModelId,field.id);const links=await kiss.data.relations.getLinksAndRecords(modelId,this.id,field.id,sort);const linkedRecords=links.map((link=>link.record));const connectedRecords=[];for(let linkData of linkedRecords){const linkedRecord=kiss.app.models[linkedModelId].create(linkData);const linkedRecordData=await linkedRecord.getData(newConfig,skipModelIds,accountId);connectedRecords.push(linkedRecordData)}recordData[fieldLabel]=connectedRecords}}else{recordData[fieldLabel]=[]}}else{let value=this[field.id];if(value!==""&&config.numberAsText&&(field.type=="number"||field.type=="lookup"&&field.lookup.type=="number"||field.type=="summary"&&field.summary.type=="number")){const precision=field.precision!=undefined?field.precision:2;value=Number(value).round(precision).toFixed(precision)}else if(config.convertNames&&field.type=="directory"){if(kiss.isClient){value=!value?[]:kiss.directory.getEntryNames([].concat(value))}else{value=!value?[]:kiss.directory.getEntryNames(accountId,[].concat(value))}}else if(field.exporter&&typeof field.exporter==="function"){value=field.exporter(value)}if(value==undefined)value="";recordData[fieldLabel]=value}}return recordData}async _getLinkFieldSortConfig(modelId,fieldId){const viewRecord=await kiss.db.findOne("view",{modelId:modelId,fieldId:fieldId});if(viewRecord&&viewRecord.sort)return viewRecord.sort;return null}getFiles(){const attachmentFields=this.model.getFieldsByType("attachment").filter((field=>!field.deleted));return attachmentFields.filter((field=>this[field.id]!==undefined)).map((field=>this[field.id])).flat()}getRawData(){return kiss.tools.snapshot(this)}_computeFields_v1_deprecated(updatedFieldId,depth=0){if(depth>10)return;depth++;for(let computedFieldId of this.model.computedFields){const computedField=this.model.getField(computedFieldId);const computedFieldCurrentValue=this[computedField.id];if(computedFieldId!=updatedFieldId&&computedField.type!="lookup"&&computedField.type!="summary"&&(!updatedFieldId||computedField.formulaSourceFieldIds.includes(updatedFieldId))){let newComputedFieldValue=this._computeField(computedField);if(newComputedFieldValue!==undefined&&newComputedFieldValue!==computedFieldCurrentValue){this[computedField.id]=newComputedFieldValue;this._computeFields(computedField.id,depth)}}}}_computeFields(){if(this.model.hasCyclicDependencies){log.warn("kiss.data.Record - _computeFields - The model fields have cyclic dependencies, the computed fields will not be computed.");return}for(let fieldId of this.model.orderedComputedFields){const field=this.model.getField(fieldId);if(field.type=="lookup"||field.type=="summary")continue;const newValue=this._computeField(field);if(newValue===undefined)continue;if(kiss.tools.isNumericField(field)&&isNaN(newValue))continue;this[fieldId]=newValue}}_computeField(field){try{let newValue=kiss.formula.execute(field.formula,this,this.model.getActiveFields(),field);return newValue}catch(err){log.err("kiss.data - Record.computeField - Error:",err);return""}}};const model=kiss.app.models[modelId];Object.keys(model.methods).forEach((methodName=>{Record.prototype[methodName]=model.methods[methodName]}));return Record};kiss.data.relations={async connectModels(modelIdA,modelIdB,cardinality){const modelA=kiss.app.models[modelIdA];const modelB=kiss.app.models[modelIdB];const linkIdA=kiss.tools.shortUid();const linkIdB=kiss.tools.shortUid();const cardinalityA=cardinality[0];const cardinalityB=cardinality[1];let linkFieldA={id:linkIdA,type:"link",label:cardinalityB=="N"?modelB.namePlural:modelB.name,multiple:cardinalityB=="N"?true:false,link:{modelId:modelIdB,fieldId:linkIdB}};let linkFieldB={id:linkIdB,type:"link",label:cardinalityA=="N"?modelA.namePlural:modelA.name,multiple:cardinalityA=="N"?true:false,link:{modelId:modelIdA,fieldId:linkIdA}};const modelAlinks=modelA.getFieldsByType("link");const modelBlinks=modelB.getFieldsByType("link");linkAtoB=[];modelAlinks.forEach((field=>{if(field.link.modelId==modelB.id)linkAtoB.push(field)}));linkBtoA=[];modelBlinks.forEach((field=>{if(field.link.modelId==modelA.id)linkBtoA.push(field)}));let AhasLinkToB=linkAtoB.length>0;let BhasLinkToA=linkBtoA.length>0;if(AhasLinkToB){linkFieldA=linkAtoB[0];linkFieldA.label=cardinalityB=="N"?modelB.namePlural:modelB.name;linkFieldA.multiple=cardinalityB=="N"?true:false}if(BhasLinkToA){linkFieldB=linkBtoA[0];linkFieldB.label=cardinalityA=="N"?modelA.namePlural:modelA.name;linkFieldB.multiple=cardinalityA=="N"?true:false}await Promise.all([AhasLinkToB?modelA.updateField(linkFieldA.id,linkFieldA):modelA.addField(linkFieldA),BhasLinkToA?modelB.updateField(linkFieldB.id,linkFieldB):modelB.addField(linkFieldB)])},update(modelId){const model=kiss.app.models[modelId];if(model){model._defineRelationships()}},async updateOneDeep(model,record,update,userId){const cacheId=kiss.tools.uid();kiss.cache[cacheId]={};kiss.cache[cacheId].deletedRecords=[];try{const transaction=new kiss.data.Transaction({userId:userId});await kiss.data.relations.computeTransactionToUpdate(model,record,update,transaction,cacheId);const operations=await transaction.process();delete kiss.cache[cacheId];return operations}catch(err){log.err("kiss.dataRelations - updateOneDeep - Error:",err);return[]}},async updateManyDeep(modelId,ids){try{const model=kiss.app.models[modelId];const transaction=new kiss.data.Transaction;const records=await kiss.db.findById(modelId,ids);const cacheId="cache-"+kiss.tools.uid();await kiss.data.relations.buildCache(cacheId,modelId,records);for(const record of records){await kiss.data.relations.computeTransactionToUpdate(model,record,null,transaction,cacheId)}const operations=await transaction.process();delete kiss.cache[cacheId];return operations}catch(err){log.err("kiss.dataRelations - updateManyDeep - Error:",err);return[]}},async updateAllDeep(modelId){try{const model=kiss.app.models[modelId];const transaction=new kiss.data.Transaction;const records=await kiss.db.find(modelId,{});const cacheId="cache-"+kiss.tools.uid();await kiss.data.relations.buildCache(cacheId,modelId,records);for(const record of records){await kiss.data.relations.computeTransactionToUpdate(model,record,null,transaction,cacheId)}const operations=await transaction.process();delete kiss.cache[cacheId];return operations}catch(err){log.err("kiss.dataRelations - updateAllDeep - Error:",err);return[]}},async buildCache(cacheId,modelId){kiss.cache[cacheId]={};kiss.cache[cacheId].deletedRecords=[];setTimeout((()=>{log.ack("kiss.data.relations - Cleaning cache "+cacheId);delete kiss.cache[cacheId]}),60*1e3);if(!cacheId.startsWith("cache"))return;const model=kiss.app.models[modelId];const accountId=model.accountId;const modelsToExplore=Object.values(kiss.app.models).filter((model=>model.accountId==accountId));const connectedModelsToCache=kiss.data.relations.getConnectedModels(modelId,modelsToExplore,[model.id]);const modelsToCache=[model].concat(connectedModelsToCache);let count=0;for(let modelToCache of modelsToCache){kiss.cache[cacheId][modelToCache.id]={};const records=await kiss.db.find(modelToCache.id,{});records.forEach((record=>{count++;kiss.cache[cacheId][modelToCache.id][record.id]=record}))}},getConnectedModels(modelId,modelsToExplore,exploredModels){let connectedModels=modelsToExplore.filter((model=>!exploredModels.includes(model.id)&&model.sourceFor&&model.sourceFor.includes(modelId)));if(connectedModels.length==0)return[];exploredModels=exploredModels.concat(connectedModels.map((model=>model.id)));for(let connectedModel of connectedModels){let deeperModels=kiss.data.relations.getConnectedModels(connectedModel.id,modelsToExplore,exploredModels);connectedModels=connectedModels.concat(deeperModels)}return connectedModels},async buildSmartCache(cacheId,modelId,records){kiss.cache[cacheId]={};kiss.cache[cacheId].deletedRecords=[];setTimeout((()=>{if(kiss.cache[cacheId]){log("kiss.data.relations - Cleaning cache "+cacheId);delete kiss.cache[cacheId]}}),60*1e3);if(!cacheId.startsWith("cache"))return;let links=[];let exploredNodes=[];for(const record of records){const recordLinks=kiss.data.relations.getRelationTree(modelId,record.id,exploredNodes);links=links.concat(recordLinks);exploredNodes=links.map((link=>link.recordId)).unique()}const linksByModel=links.reduce(((map,link)=>{map[link.modelId]=map[link.modelId]||{};map[link.modelId][link.recordId]=0;return map}),{});for(modelId of Object.keys(linksByModel)){if(kiss.app.models[modelId]){const cachedRecords=await kiss.db.findById(modelId,Object.keys(linksByModel[modelId]));kiss.cache[cacheId][modelId]={};cachedRecords.forEach((record=>{kiss.cache[cacheId][modelId][record.id]=record}))}}},getRelationTree(modelId,recordId,exploredNodes=[],depth=0){const model=kiss.app.models[modelId];if(!model)return[];exploredNodes.push(recordId);let nodeLinks=kiss.data.relations.getLinks(modelId,recordId);nodeLinks=nodeLinks.filter((link=>{const foreignModel=kiss.app.models[link.modelId];if(!foreignModel)return false;return!exploredNodes.includes(link.recordId)&&foreignModel.sourceFor.includes(modelId)}));let allLinks=[];for(link of nodeLinks){exploredNodes.push(link.recordId);const foreignLinks=kiss.data.relations.getRelationTree(link.modelId,link.recordId,exploredNodes,exploredLinks,depth);exploredNodes=exploredNodes.concat(foreignLinks.map((foreignLink=>foreignLink.recordId)));allLinks=allLinks.concat(foreignLinks)}allLinks=allLinks.concat(nodeLinks).concat({modelId:modelId,recordId:recordId});return allLinks},async updateLink(linkRecord,userId){let recordX;let recordY;const{mX:mX,rX:rX,mY:mY,rY:rY}=linkRecord;const modelX=kiss.app.models[mX];const modelY=kiss.app.models[mY];if(kiss.isServer){recordX=await kiss.db.findOne(mX,{_id:rX});recordY=await kiss.db.findOne(mY,{_id:rY})}else{recordX=await kiss.db.findOne(mX,rX);recordY=await kiss.db.findOne(mY,rY)}const cacheId=kiss.tools.uid();kiss.cache[cacheId]={};kiss.cache[cacheId].deletedRecords=[];const transaction=new kiss.data.Transaction({userId:userId});await kiss.data.relations.computeTransactionToUpdate(modelX,recordX,null,transaction,cacheId);await kiss.data.relations.computeTransactionToUpdate(modelY,recordY,null,transaction,cacheId);const operations=await transaction.process();delete kiss.cache[cacheId];return operations},async updateForeignRecords(modelId,recordId){const cacheId=kiss.tools.uid();kiss.cache[cacheId]={};kiss.cache[cacheId].deletedRecords=[];const transaction=new kiss.data.Transaction;await kiss.data.relations.computeTransactionToUpdateForeignRecords(modelId,recordId,transaction,cacheId);const operations=await transaction.process();delete kiss.cache[cacheId];return operations},async updateForeignRecordsForMultipleRecords(modelId,ids){const cacheId=kiss.tools.uid();kiss.cache[cacheId]={};kiss.cache[cacheId].deletedRecords=[];const transaction=new kiss.data.Transaction;for(recordId of ids){await kiss.data.relations.computeTransactionToUpdateForeignRecords(modelId,recordId,transaction,cacheId)}const operations=await transaction.process();delete kiss.cache[cacheId];return operations},async computeTransactionToUpdateForeignRecords(modelId,recordId,transaction,cacheId){const model=kiss.app.models[modelId];const linkFields=model.fields.filter((field=>field.type=="link"));for(const linkField of linkFields){const foreignModel=kiss.app.models[linkField.link.modelId];const foreignRecords=await kiss.data.relations.getLinkedRecordsFrom(modelId,recordId,linkField.id,transaction,cacheId);for(const foreignRecord of foreignRecords){await kiss.data.relations.computeTransactionToUpdate(foreignModel,foreignRecord,null,transaction,cacheId)}}},async computeTransactionToUpdate(model,record,update,transaction,cacheId,depth=0){if(depth>10)return;let recordUpdates={};if(update){Object.assign(record,update);recordUpdates=update}recordUpdates=await kiss.data.relations._computeFields(model,record,update,recordUpdates,0,transaction,cacheId);Object.keys(recordUpdates).forEach((property=>{if(recordUpdates[property]==undefined)delete recordUpdates[property]}));if(Object.keys(recordUpdates).length==0)return;transaction.addOperation({modelId:model.id,recordId:record.id,updates:recordUpdates});if(!kiss.global.ops)kiss.global.ops=0;kiss.global.ops++;let foreignModelTargetFields={};Object.keys(recordUpdates).forEach((updatedFieldId=>{const field=model.getField(updatedFieldId);if(field&&field.sourceFor){field.sourceFor.forEach((source=>{foreignModelTargetFields[source.modelId]=foreignModelTargetFields[source.modelId]||[];foreignModelTargetFields[source.modelId].push(source.fieldId)}))}}));for(const foreignModelId of Object.keys(foreignModelTargetFields)){const foreignModel=kiss.app.models[foreignModelId];const fieldsToUpdateInForeignRecord=foreignModelTargetFields[foreignModelId];const linkField=model.getLinkField(foreignModelId);if(linkField){const foreignRecordsToUpdate=await kiss.data.relations.getLinkedRecordsFrom(model.id,record.id,linkField.id,transaction,cacheId);for(const foreignRecord of foreignRecordsToUpdate){for(const foreignFieldId of fieldsToUpdateInForeignRecord){const foreignField=foreignModel.getField(foreignFieldId);const newForeignRecordValue=await kiss.data.relations._computeField(foreignModel,foreignRecord,foreignField,transaction,cacheId);let foreignFieldUpdate={};foreignFieldUpdate[foreignFieldId]=newForeignRecordValue;depth++;await kiss.data.relations.computeTransactionToUpdate(foreignModel,foreignRecord,foreignFieldUpdate,transaction,cacheId,depth);depth--}}}}},async _computeFields(model,record,update=null,changes={},depth=0,transaction,cacheId){Object.assign(record,update);let updateAllFields=false;let impactedFieldIds=[];if(update!=null){Object.keys(update).forEach((fieldId=>{let field=model.getField(fieldId);if(!field)return;impactedFieldIds=impactedFieldIds.concat(field.deepDependencies)}))}else{updateAllFields=true}for(let fieldId of model.orderedComputedFields){if(updateAllFields||impactedFieldIds.includes(fieldId)){const field=model.getField(fieldId);const newValue=await this._computeField(model,record,field,transaction,cacheId);if(newValue===undefined)continue;if(kiss.tools.isNumericField(field)&&isNaN(newValue))continue;if(newValue!==record[fieldId]){record[fieldId]=changes[fieldId]=newValue}}}return changes},async _computeField(model,record,field,transaction,cacheId){try{let newValue;switch(field.type){case"lookup":newValue=await kiss.data.relations._computeLookupField(model.id,record.id,field.id,transaction,cacheId);break;case"summary":newValue=await kiss.data.relations._computeSummaryField(model.id,record.id,field.id,transaction,cacheId);break;default:newValue=kiss.formula.execute(field.formula,record,model.getActiveFields(),field)}return newValue}catch(err){}},async _computeLookupField(modelId,recordId,fieldId,transaction,cacheId){const model=kiss.app.models[modelId];const field=model.getField(fieldId);const foreignRecords=await kiss.data.relations.getLinkedRecordsFrom(modelId,recordId,field.lookup.linkId,transaction,cacheId);if(foreignRecords.length==0)return"";if(foreignRecords.length==1)return foreignRecords[0][field.lookup.fieldId];return kiss.data.relations._summarizeField(foreignRecords,field.lookup.fieldId,"LIST")},async _computeSummaryField(modelId,recordId,fieldId,transaction,cacheId){const model=kiss.app.models[modelId];let field=model.getField(fieldId);const foreignRecords=await kiss.data.relations.getLinkedRecordsFrom(modelId,recordId,field.summary.linkId,transaction,cacheId);if(foreignRecords.length==0){if(field.summary.type=="number")return 0;return""}return kiss.data.relations._summarizeField(foreignRecords,field.summary.fieldId,field.summary.operation,field.precision)},_summarizeField(records,fieldId,operation,precision){let values=[];records.forEach((record=>{if(record)values.push(record[fieldId])}));if(operation=="CONCATENATE"||operation=="LIST"||operation=="LIST_NAMES"){return kiss.formula[operation](...values)}else{if(precision)return Number(kiss.formula[operation](...values).toFixed(precision));return Number(kiss.formula[operation](...values))}},async getLinkedRecordsFrom(modelId,recordId,linkFieldId,transaction,cacheId){if(!cacheId){cacheId=kiss.tools.uid();await kiss.data.relations.buildCache(cacheId)}else if(cacheId.startsWith("cache")){return await kiss.data.relations.getLinkedRecordsFromCache(modelId,recordId,linkFieldId,transaction,cacheId)}const links=kiss.data.relations.getLinksFromField(modelId,recordId,linkFieldId);if(links.length==0){return[]}const foreignModelId=links[0].modelId;const ids=links.map((link=>link.recordId)).filter((recordId=>!kiss.cache[cacheId].deletedRecords.includes(recordId)));let records=[];let remainingIds=[];ids.forEach((id=>{if(kiss.cache[cacheId][id]){records.push(kiss.cache[cacheId][id])}else{remainingIds.push(id)}}));let dbRecords=[];if(remainingIds.length>0){dbRecords=await kiss.db.findById(foreignModelId,remainingIds);dbRecords.forEach((record=>{kiss.cache[cacheId][record.id]=record}));if(links.length!=dbRecords.length){const foundRecordIds=dbRecords.map((record=>record.id));links.forEach((link=>{if(!foundRecordIds.includes(link.recordId)){kiss.cache[cacheId].deletedRecords=(kiss.cache[cacheId].deletedRecords||[]).concat(link.recordId)}}))}}records=records.concat(dbRecords);if(transaction){records=kiss.data.relations._patchRecordsFromTransactionCache(foreignModelId,records,transaction)}return records},async getLinkedRecordsFromCache(modelId,recordId,linkFieldId,transaction,cacheId){const links=kiss.data.relations.getLinksFromField(modelId,recordId,linkFieldId);if(links.length==0){return[]}const foreignModelId=links[0].modelId;const ids=links.map((link=>link.recordId));let records=[];if(kiss.cache[cacheId][foreignModelId]){let missingCount=0;ids.forEach((id=>{const cachedRecord=kiss.cache[cacheId][foreignModelId][id];if(cachedRecord){records.push(cachedRecord)}else{missingCount++}}))}else{}if(transaction){records=kiss.data.relations._patchRecordsFromTransactionCache(foreignModelId,records,transaction)}return records},getLinksFromField(modelId,recordId,linkFieldId){const model=kiss.app.models[modelId];const accountId=model.accountId;const foreignLinkField=model.getField(linkFieldId);if(!foreignLinkField)return[];const foreignLinkFieldId=foreignLinkField.link.fieldId;const linkModel=kiss.app.models.link;let links;if(kiss.isClient){links=linkModel.collection.records}else{links=kiss.global.links[accountId]||[]}const left=links.filter((link=>link.mX==modelId&&link.rX==recordId&&link.fX==linkFieldId)).map((link=>({linkId:link.id,modelId:link.mY,recordId:link.rY})));const right=links.filter((link=>link.mY==modelId&&link.rY==recordId&&link.fX==foreignLinkFieldId)).map((link=>({linkId:link.id,modelId:link.mX,recordId:link.rX})));const join=[].concat(left.concat(right));return join},async deleteLinksFromRecords({req:req,records:records}){const linkIds=kiss.data.relations.getLinksFromRecords(records);if(linkIds.length==0)return;await kiss.db.deleteMany("links"+req.targetCollectionSuffix,{_id:{$in:linkIds}});const accountId=req.token.currentAccountId;const countBeforeDeletion=kiss.global.links[accountId].length;kiss.global.links[accountId]=kiss.global.links[accountId].filter((link=>!linkIds.includes(link.id)));const deleteLinks=countBeforeDeletion-kiss.global.links[accountId].length;log.info(`kiss.data.relations - ${req.token.userId} deleted ${deleteLinks} link(s)`)},getLinksFromRecords(records){let linkIds=[];records.forEach((record=>{let links=kiss.data.relations.getLinks(record.sourceModelId,record.id);linkIds=linkIds.concat(links.map((link=>link.linkId)))}));return linkIds},getLinks(modelId,recordId){const model=kiss.app.models[modelId];if(!model)return[];let links;if(kiss.isClient){const linkModel=kiss.app.models.link;links=linkModel.collection.records}else{const accountId=model.accountId;links=kiss.global.links[accountId]||[]}const left=links.filter((link=>link.mX==modelId&&link.rX==recordId)).map((link=>({linkId:link.id,modelId:link.mY,recordId:link.rY})));const right=links.filter((link=>link.mY==modelId&&link.rY==recordId)).map((link=>({linkId:link.id,modelId:link.mX,recordId:link.rX})));const join=[].concat(left.concat(right));return join},async getLinksAndRecords(modelId,recordId,fieldId,sort,sortSyntax="normalized"){try{const model=kiss.app.models[modelId];const field=model.getField(fieldId);const foreignModel=kiss.app.models[field.link.modelId];let links=kiss.data.relations.getLinksFromField(modelId,recordId,fieldId);const ids=links.map((link=>link.recordId));const records=await kiss.db.findById(foreignModel.id,ids,sort,sortSyntax);return records.map((record=>{const link=links.find((link=>link.recordId==record.id));return Object.assign(link,{record:record})}))}catch(err){return[]}},_patchRecordsFromTransactionCache(modelId,records,transaction){records.forEach((record=>{transaction.operations.every((operation=>{if(operation.modelId==modelId&&operation.recordId==record.id){Object.assign(record,operation.updates);return false}return true}))}));return records}};kiss.data.Transaction=class{constructor(config={}){this.id=config.id||kiss.tools.uid();this.operations=config.operations||[];this.dbMode=config.dbMode;this.userId=config.userId;return this}addOperation(operation){this.operations.push(operation);return this}async process(){if(this.operations.length==0){return[]}let groupedOperations={};this.operations.forEach((operation=>{const modelId=operation.modelId;const recordId=operation.recordId;groupedOperations[modelId]=groupedOperations[modelId]||{};groupedOperations[modelId][recordId]=groupedOperations[modelId][recordId]||{};Object.assign(groupedOperations[modelId][recordId],operation.updates)}));let flatOperations=[];Object.keys(groupedOperations).forEach((modelId=>{const modelOperations=groupedOperations[modelId];Object.keys(modelOperations).forEach((recordId=>{const recordOperations=modelOperations[recordId];if(Object.keys(recordOperations).length==0)return;if(this.userId){recordOperations.updatedAt=(new Date).toISOString();recordOperations.updatedBy=this.userId}flatOperations.push({modelId:modelId,recordId:recordId,updates:recordOperations})}))}));let success;if(flatOperations.length==1){const operation=flatOperations[0];if(kiss.isClient){success=await kiss.db.updateOne(operation.modelId,operation.recordId,operation.updates)}else{success=await kiss.db.updateOne(operation.modelId,{_id:operation.recordId},operation.updates)}}else{success=await kiss.db.updateBulk(flatOperations)}if(!success){this._rollback();return[]}else{this._commit();return flatOperations}}_commit(){}_rollback(){}};kiss.formula={LEN:text=>{if(!text)return 0;if(Array.isArray(text))return text.length;if(typeof text=="string")return text.length;return 0},LEN_TYPES:["string"],LEN_HELP:`LEN( {{field}} )\n        The length of a TEXT field, or the number of elements in a MULTI-VALUE field`,LEFT:(text,n)=>n>0?text.slice(0,n):"",LEFT_TYPES:["string"],LEFT_HELP:`LEFT( {{field}}, 3)\n        The left part of a TEXT field`,RIGHT:(text,n)=>n>0?text.slice(-n):"",RIGHT_TYPES:["string"],RIGHT_HELP:`RIGHT( {{field}}, 3)\n        The right part of a TEXT field`,MIDDLE:(text,from,to)=>text.slice(from,to),MIDDLE_TYPES:["string"],MIDDLE_HELP:`MIDDLE( {{field}}, 4, 8)\n        The middle part of a TEXT field`,STRLEFT:(text,separator)=>text.split(separator)[0],STRLEFT_TYPES:["string"],STRLEFT_HELP:`STRLEFT( {{field}}, "@")\n        The part of a TEXT field at the left of a given string`,STRRIGHT:(text,separator)=>text.split(separator).pop(),STRRIGHT_TYPES:["string"],STRRIGHT_HELP:`STRRIGHT( {{field}}, "@")\n        The part of a TEXT field at the right of a given string`,UPPERCASE:text=>text.toUpperCase(),UPPERCASE_TYPES:["string"],UPPERCASE_HELP:`UPPERCASE( {{field}})\n        Returns a TEXT field in uppercase`,LOWERCASE:text=>text.toLowerCase(),LOWERCASE_TYPES:["string"],LOWERCASE_HELP:`LOWERCASE( {{field}} )\n        Returns a TEXT field in lowercase`,TITLECASE:text=>text.toTitleCase(),TITLECASE_TYPES:["string"],TITLECASE_HELP:`TITLECASE( {{field}} )\n        Returns a TEXT field in titlecase`,REPLACE:(text,oldText,newText)=>text.replaceAll(oldText,newText),REPLACE_TYPES:["string"],REPLACE_HELP:`REPLACE( {{field}}, "New York", "Paris")\n        Replaces one string with another inside a TEXT field`,SLUG:text=>kiss.tools.generateSlug(text),SLUG_TYPES:["string"],SLUG_HELP:`SLUG( {{field}} )\n        Transforms a TEXT field into a slug. Ex: "my-article-about-this"`,CONCATENATE:(...strings)=>strings.filter((string=>string)).join(""),CONCATENATE_TYPES:["string"],CONCATENATE_HELP:`CONCATENATE( {{field1}}, " - ", {{field2}} )\n        Concatenate multiple TEXT fields or texts together`,CONTAINS:(string,value)=>string.includes(value),CONTAINS_TYPES:["boolean"],CONTAINS_HELP:`CONTAINS( {{field}}, "San")\n        Returns true if a TEXT field contains the given string`,TRIM:string=>string.trim(),TRIM_TYPES:["string"],TRIM_HELP:`TRIM( {{field}} )\n        Returns "Hello !" if a TEXT field contains "  Hello   !  "`,MIN:(...numbers)=>Math.min(...numbers),MIN_TYPES:["number"],MIN_HELP:`MIN( {{field1}}, {{field2}}, ... )\n        The min value of multiple NUMBER fields`,MAX:(...numbers)=>Math.max(...numbers),MAX_TYPES:["number"],MAX_HELP:`MAX( {{field1}}, {{field2}}, ... )\n        The max value of multiple NUMBER fields`,AVERAGE:(...numbers)=>kiss.formula.SUM(...numbers)/numbers.length,AVERAGE_TYPES:["number"],AVERAGE_HELP:`AVERAGE( {{field1}}, {{field2}}, ... )\n        The average value of multiple NUMBER fields`,ROUND:(number,precision)=>number.round(precision),ROUND_TYPES:["number"],ROUND_HELP:`ROUND( {{field}}, 3)\n        The rounded value of a NUMBER field`,ABS:number=>Math.abs(number),ABS_TYPES:["number"],ABS_HELP:`ABS( {{field}} )\n        The absolute value of a NUMBER field`,CEILING:(number,significance=1)=>Math.ceil(number/significance)*significance,CEILING_TYPES:["number"],CEILING_HELP:`CEILING( {{field}}, 0.1)\n        The nearest integer multiple of significance that is greater than or equal to the value`,FLOOR:(number,significance=1)=>Math.floor(number/significance)*significance,FLOOR_TYPES:["number"],FLOOR_HELP:`FLOOR( {{field}}, 0.1)\n        The nearest integer multiple of significance that is less than or equal to the value`,SQRT:number=>Math.sqrt(number),SQRT_TYPES:["number"],SQRT_HELP:`SQRT( {{field}} )\n        The square root of a NUMBER field`,POWER:(number,power)=>Math.pow(number??0,power??1),POWER_TYPES:["number"],POWER_HELP:`POW( {{field}}, 2)\n        Raise a NUMBER field to the specified power`,LOG:(number,base=10)=>Math.log(number)/Math.log(base),LOG_TYPES:["number"],LOG_HELP:`LOG( {{field}}, 2)\n        The logarithm of a NUMBER field in the specified base`,MOD:(number,divisor)=>number%divisor,MOD_TYPES:["number"],MOD_HELP:`MOD( {{field}}, 2)\n        The modulus operation of a NUMBER field`,PI:()=>Math.PI,PI_TYPES:["number"],PI_HELP:`PI()\n        PI number: 3.1415927...`,COS:number=>Math.cos(number),COS_TYPES:["number"],COS_HELP:`COS( {{field}} )\n        The cosinus of a NUMBER field`,SIN:number=>Math.sin(number),SIN_TYPES:["number"],SIN_HELP:`SIN( {{field}} )\n        The sinus of a NUMBER field`,TAN:number=>Math.tan(number),TAN_TYPES:["number"],TAN_HELP:`TAN( {{field}} )\n        The tangent of a NUMBER field`,YEAR:strDateISO=>strDateISO.substring(0,4),YEAR_TYPES:["date"],YEAR_HELP:`YEAR( {{field}} )\n        The year of a DATE field`,MONTH:strDateISO=>strDateISO.substring(5,7),MONTH_TYPES:["date"],MONTH_HELP:`MONTH( {{field}} )\n        The month of a DATE field`,WEEK:strDateISO=>new Date(strDateISO).getWeek(),WEEK_TYPES:["date"],WEEK_HELP:`WEEK( {{field}} )\n        The week number of a DATE field (according to ISO-8601)`,DAY:strDateISO=>strDateISO.substring(8,10),DAY_TYPES:["date"],DAY_HELP:`DAY( {{field}} )\n        The day of a DATE field`,YEAR_MONTH:strDateISO=>strDateISO.substring(0,7),YEAR_MONTH_TYPES:["date"],YEAR_MONTH_HELP:`YEAR_MONTH( {{field}} )\n        The year and month of a DATE field, like "2020-07"`,TIME_DIFFERENCE:(fromISODate,toISODate,unit="d")=>{try{const fromDate=new Date(fromISODate);const toDate=new Date(toISODate);let coef;switch(unit){case"d":coef=1e3*60*60*24;break;case"h":coef=1e3*60*60;break;case"mn":coef=1e3*60;break;case"s":coef=1e3;case"ms":coef=1}return Math.round((toDate.getTime()-fromDate.getTime())/coef)}catch(err){return 0}},TIME_DIFFERENCE_TYPES:["date"],TIME_DIFFERENCE_HELP:`TIME_DIFFERENCE( {{field1}}, {{field2}}, "h")\n        The time difference between 2 DATE fields, using the given unit (d, h, mn, s, or ms)`,DAYS_DIFFERENCE:(fromISODate,toISODate)=>kiss.formula.TIME_DIFFERENCE(fromISODate,toISODate,"d"),DAYS_DIFFERENCE_TYPES:["date"],DAYS_DIFFERENCE_HELP:`DAYS_DIFFERENCE( {{field1}}, {{field2}} )\n        The number of days between 2 DATE fields`,HOURS_DIFFERENCE:(fromISODate,toISODate)=>kiss.formula.TIME_DIFFERENCE(fromISODate,toISODate,"h"),HOURS_DIFFERENCE_TYPES:["date"],HOURS_DIFFERENCE_HELP:`HOURS_DIFFERENCE( {{field1}}, {{field2}} )\n        The number of hours between 2 DATE fields`,ADJUST_DATE(date,years=0,months=0,days=0,hours=0,minutes=0,seconds=0,format="ISO"){let newDate=date?new Date(date):new Date;newDate.setUTCSeconds(newDate.getUTCSeconds()+seconds);newDate.setUTCMinutes(newDate.getUTCMinutes()+minutes);newDate.setUTCHours(newDate.getUTCHours()+hours);newDate.setUTCDate(newDate.getUTCDate()+days);newDate.setUTCMonth(newDate.getUTCMonth()+months);newDate.setUTCFullYear(newDate.getUTCFullYear()+years);if(format=="ISO")return newDate.toISO();return newDate},ADJUST_DATE_TYPES:["date"],ADJUST_DATE_HELP:`ADJUST_DATE( {{field}}, 0, 1, 0, 0, 0, 0)\n        Adjust a DATE field by the number of given years, months, days, hours, minutes and seconds, and output the result like "2023-01-01"`,ADJUST_DATE_AND_TIME(date,years=0,months=0,days=0,hours=0,minutes=0,seconds=0,format="ISO"){let newDate=date?new Date(date):new Date;newDate.setFullYear(newDate.getFullYear()+years);newDate.setMonth(newDate.getMonth()+months);newDate.setDate(newDate.getDate()+days);newDate.setHours(newDate.getHours()+hours);newDate.setMinutes(newDate.getMinutes()+minutes);newDate.setSeconds(newDate.getSeconds()+seconds);if(format=="ISO")return newDate.toISODateTime();return newDate},ADJUST_DATE_AND_TIME_TYPES:["date"],ADJUST_DATE_AND_TIME_HELP:`ADJUST_DATE_AND_TIME( {{field}}, 0, 0, 1, 12, 30, 0)\n        Adjust a DATE field by the number of given years, months, days, hours, minutes and seconds, and output the result like "2023-01-01 12:30:00"`,FORMAT_DATE:(date,format)=>{try{if(!date)return"";if(typeof date=="string")date=new Date(date);const pad=n=>n<10?"0"+n:n;let year=date.getFullYear();let month=pad(date.getMonth()+1);let day=pad(date.getDate());let hour=pad(date.getHours());let minute=pad(date.getMinutes());let second=pad(date.getSeconds());return format.replace(/yyyy/g,year).replace(/yy/g,year.toString().substring(2,4)).replace(/mm/g,month).replace(/dd/g,day).replace(/hh/g,hour).replace(/MM/g,minute).replace(/ss/g,second)}catch(err){return""}},FORMAT_DATE_TYPES:["date"],FORMAT_DATE_HELP:`FORMAT_DATE( DATE, "yyyy-mm-dd"), or FORMAT_DATE( DATE, "yyyy-mm-dd hh:MM")\n        Convert a date to a formatted string. Usefull to display dates in a specific format, or to set another date field using ISO, like "2023-01-01"`,SUM:(...numbers)=>numbers.reduce(((a,b)=>Number(a||0)+Number(b||0)),0),SUM_TYPES:["number"],SUM_HELP:`SUM( {{field1}}, {{field2}}, ... )\n        The sum of multiple NUMBER fields`,LENGTH:text=>{if(!text)return 0;if(Array.isArray(text))return text.length;if(typeof text=="string")return text.length;return 0},LENGTH_TYPES:["string","array"],LENGTH_HELP:`LENGTH( {{field}} )\n        The length of a TEXT field, or the number of elements in a MULTI-VALUE field`,NTH:(array,index)=>{if(!array)return"";if(Array.isArray(array)||typeof array=="string")return array[index];return""},NTH_TYPES:["string","array"],NTH_HELP:`NTH( {{field}} )\n        The nth element of a MULTI-VALUE field`,JOIN:(array,separator)=>array.join(separator),JOIN_TYPES:["array"],JOIN_HELP:`JOIN( {{field}}, " & ")\n        Transform a MULTI-VALUE field into a text with separators`,ARRAY:(...values)=>values,ARRAY_TYPES:["array"],ARRAY_HELP:`ARRAY( "a", "b", "c" )\n        Transform a list of values into an array, to feed MULTI-VALUE fields`,ELEMENT:(array,index)=>{if(Array.isArray(array)==false)return false;if(index<0||index>=array.length)return false;return array[index]},ELEMENT_TYPES:["array"],ELEMENT_HELP:`ELEMENT( ARRAY( "a", "b", "c" ), 1 )\n        Get the nth element of an array, or false if not found. Index starts at zero`,INDEX_OF:(array,item)=>array.indexOf(item),INDEX_OF_TYPES:["array"],INDEX_OF_HELP:`INDEX_OF( ARRAY( "a", "b", "c" ), "c" )\n        Get the index of an item in an array. Returns -1 if not found`,IS_EMPTY:value=>{if(value===0)return false;if(typeof value==="string"&&value.trim()==="")return true;if(!value)return true;if(Array.isArray(value)&&value.length==0)return true;return false},IS_EMPTY_TYPES:["boolean"],IS_EMPTY_HELP:`IS_EMPTY( {{field}} )\n        Returns true if the field is empty`,IS_NOT_EMPTY:value=>!kiss.formula.IS_EMPTY(value),IS_NOT_EMPTY_TYPES:["boolean"],IS_NOT_EMPTY_HELP:`IS_NOT_EMPTY( {{field}} )\n        Returns true if the field is not empty`,IF_EMPTY_USE:(value,valueIfEmpty)=>{if(Array.isArray(value)){return value.length>0?value:valueIfEmpty}if(value&&typeof value==="object"){return Object.keys(value).length>0?value:valueIfEmpty}return Boolean(value)?value:valueIfEmpty},IF_EMPTY_USE_TYPES:["boolean"],IF_EMPTY_USE_HELP:`IF_EMPTY_USE( {{field}}, valueIfEmpty )\n        Returns the field value if the field is not empty, or the valueIfEmpty if the field is empty`,IF:(...params)=>{try{if(params.length<3||params.length%2==0)return false;for(let i=0;i<=params.length-2;i=i+2){if(params[i]==true)return params[i+1]}return params[params.length-1]}catch(err){return false}},IF_TYPES:["boolean"],IF_HELP:`IF( {{field}} == 100, "Good", {{field}} > 50, "OK", "Poor" )\n        Returns the value where the test is true, or defaults to the last value`,IS_WORKFLOW_STEP:stepName=>{const stepId=kiss.context.record["workflow-stepId"];if(!stepId)return false;const step=kiss.global.workflowSteps[stepId];if(!step)return false;return step.name==stepName},IS_WORKFLOW_STEP_TYPES:["boolean"],IS_WORKFLOW_STEP_HELP:`IS_WORKFLOW_STEP("Analysis")\n        Returns true if the given workflow step name is the active one. Useful to show/hide form fields or sections depending on the workflow step.`,IS_WORKFLOW_STARTED:()=>{const stepId=kiss.context.record["workflow-stepId"];return!!stepId},IS_WORKFLOW_STARTED_TYPES:["boolean"],IS_WORKFLOW_STARTED_HELP:`IS_WORKFLOW_STARTED()\n        Returns true if a workflow has started. Useful to show/hide form fields or sections depending on the workflow status.`,UID:()=>kiss.tools.uid(),UID_TYPES:["string"],UID_HELP:`UID()\n        A unique ID like "01844399-988f-7974-a68f-92d35fc702cc"`,SHORT_ID:()=>kiss.tools.shortUid().toUpperCase(),SHORT_ID_TYPES:["string"],SHORT_ID_HELP:`SHORT_ID()\n        A short ID like "A84F007X"`,system:["system","hideWhen","execute","_parser","COUNT","COUNT_EMPTY","COUNT_NON_EMPTY","LIST","LIST_NAMES","SPLIT","TODAY","TIME","NOW"],hideWhen:["IS_WORKFLOW_STEP","IS_WORKFLOW_STARTED"],COUNT:(...items)=>items.length,COUNT_EMPTY:(...items)=>{const empty=items.filter((item=>item===undefined||item===""||Array.isArray(item)&&item.length==0));return empty.length},COUNT_NON_EMPTY:(...items)=>{const nonEmpty=items.filter((item=>item!==undefined&&item!==""||Array.isArray(item)&&item.length!=0));return nonEmpty.length},LIST:(...strings)=>strings.filter((string=>string!==undefined&&string!="")).unique().join(", "),LIST_NAMES:(...names)=>names.filter((name=>name!==undefined&&name!="")).flat().unique(),SPLIT:(text,separator)=>text.split(separator),TODAY:()=>(new Date).toISO(),TIME:()=>(new Date).toISOString().substring(11,16),NOW:()=>(new Date).toISOString().substring(0,19).replace("T"," "),execute(formula,record,fields=undefined,field){try{if(!this._parser){this._parser=new kiss.lib.formula.Parser({availableFunctions:this})}const normalizedRecord={};const propertiesList=fields.map((({id:id,label:label})=>{normalizedRecord[label]=record[id];normalizedRecord[id]=record[id];return label}));return this._parser.parse(formula,normalizedRecord,propertiesList)}catch(err){console.error("kiss.formula.execute - error: ",err);console.log("AccountId: "+record.accountId);console.log("Formula: "+formula)}}};const CHAR_OPEN_PARENTHESIS="(";const CHAR_CLOSING_PARENTHESIS=")";const CHAR_OPEN_CURLY_BRACKET="{";const CHAR_CLOSE_CURLY_BRACKET="}";const CHAR_NEWLINE="\n";const CHAR_CARRIAGE_RETURN="\r";const CHAR_TAB="\t";const CHAR_SPACE=" ";const CHAR_BACKSLASH="\\";const CHAR_COMMA=",";const CHAR_SINGLE_QUOTE="'";const CHAR_DOUBLE_QUOTE='"';const PARENTHESIS_TYPE={CUSTOM_FUNCTION:"customFunction",EXPRESSION:"expression"};kiss.lib.formula.Parser=class Parser{_operators;_functions;_callStack;_lastChar;_currentChar;_currentSymbol;_currentPosition;_currentOperator;_currentRecord;_currentRecordPropertiesList;_chainedBackslashes;_openString={singleQuote:false,doubleQuote:false};_openCurlyBracket=0;_parenthesisStack=[];_finalResult;constructor({availableFunctions:availableFunctions={},operators:operators=null}={}){this._functions=availableFunctions??{};this._operators=operators||new kiss.lib.formula.ParserOperators;this._reset()}_parseError(message){const currentPosition=this._currentPosition;this._reset();throw new Error(`Formula parsing error: ${currentPosition}<- ${message}`)}_peekCallStack(){return this._callStack[this._callStack.length-1]}_parseSymbol(symbol){const record=this._currentRecord;const propertiesList=this._currentRecordPropertiesList??Object.keys(record);switch(symbol.toLowerCase()){case"null":return null;case"true":return true;case"false":return false;case"undefined":return undefined;case"nan":return NaN;case"positive_infinity":return Number.POSITIVE_INFINITY;case"negative_infinity":return Number.NEGATIVE_INFINITY}if(symbol.startsWith("{{")&&symbol.endsWith("}}")){const tag=symbol.slice(2,-2);if(tag in record){return record[tag]}else{const tagToInt=Number.parseInt(tag);if(!Number.isNaN(tagToInt)&&propertiesList[tagToInt]in record){return record[propertiesList[tagToInt]]}else{this._reset();throw new Error(`Field '${tag}' not found in the provided record.`)}}}if(symbol.match(/\./)){return Number.parseFloat(symbol)}else if(symbol.match(/,/)){return Number.parseFloat(symbol.replaceAll(",","."))}else if(symbol.match(/[0-9.]+n$/)){return BigInt(symbol.slice(0,-1))}else if(symbol.startsWith("\\x")){return Number.parseInt(symbol.slice(2),16)}else if(symbol.startsWith("\\b")){return Number.parseInt(symbol.slice(2),2)}else if(symbol.startsWith("\\o")){return Number.parseInt(symbol.slice(2),8)}return Number(symbol)}_pushValueToStack(value){const lastStep=this._peekCallStack();if(lastStep&&lastStep.expression){if(typeof lastStep.operators.unaryToApply==="function"){lastStep.arguments.push(lastStep.operators.unaryToApply(value));lastStep.operators.unaryToApply=null}else{lastStep.arguments.push(value)}}else if(lastStep&&lastStep.maxArguments<lastStep.arguments.length&&!lastStep.closed){lastStep.arguments.push(value)}else{this._callStack.push({operand:true,functionToCall:this._operators.identity,maxArguments:1,arguments:[value]})}}_addCurrentSymbolToStack(){if(!this._currentSymbol){return}this._pushValueToStack(this._parseSymbol(this._currentSymbol));this._currentSymbol=""}_addCurrentOperatorToExpression(){if(!this._currentOperator){return}const lastStep=this._peekCallStack();if(lastStep?.expression){if(lastStep.operators.isPreModifier(this._currentOperator)){const operator=this._operators.parseOperator("unary.preModifier",this._currentOperator);const lastOperand=lastStep.arguments.pop();lastStep.arguments.push(this._operators.unary.preModifier[operator](lastOperand));this._currentOperator="";return}else if(lastStep.operators.isUnary(this._currentOperator)){const operator=this._operators.parseOperator("unary.postModifier",this._currentOperator);lastStep.operators.unaryToApply=this._operators.unary.postModifier[operator];this._currentOperator="";return}lastStep.arguments.push(this._operators.parseOperator("binary",this._currentOperator));this._currentOperator=""}}_closeCurrentExpression(){const lastStep=this._peekCallStack();if(lastStep?.expression){this._popStack();return true}}_applyPostModifier(){const lastStep=this._peekCallStack();if(lastStep?.postModifier){this._popStack()}}_popStack(){let step;let argumentsToInject=[];this._addCurrentSymbolToStack();while((step=this._callStack.pop())?.operand){argumentsToInject.push(step.functionToCall(...step.arguments))}if(this._callStack.length===0){if(argumentsToInject.length===1){this._finalResult=argumentsToInject.pop();return}else if(step?.expression){this._finalResult=step.functionToCall(...step.arguments);return}}if(!step){return}const{functionToCall:functionToCall,arguments:functionArguments,closed:closed,maxArguments:maxArguments}=step;const intermediateResult=functionToCall(...functionArguments,...closed?[]:argumentsToInject.reverse());step=this._peekCallStack();if(this._callStack.length===0){this._finalResult=intermediateResult}else if(step){if(step.expression){this._pushValueToStack(intermediateResult)}else if(!(maxArguments===1&&step.closed&&functionArguments.length===0)){this._callStack.push({operand:true,functionToCall:this._operators.identity,maxArguments:1,arguments:[intermediateResult]})}}else{this._parseError("Unexpected closing parenthesis (have it been properly opened?)")}if(closed){this._callStack.push(...argumentsToInject.map((argument=>({operand:true,functionToCall:this._operators.identity,maxArguments:1,arguments:[argument]}))))}}_getLastFunctionStep(){let i=this._callStack.length-1;while(this._callStack[i]?.operand||this._callStack[i]?.expression){i--}if(i<0){return null}return this._callStack[i]}_getLastCustomFunctionStep(){let i=this._callStack.length-1;while(!this._callStack[i]?.customFunction&&i>=0){i--}if(i<0){return null}return this._callStack[i]}_createExpression(...startingExpressionMembers){const expression={expression:true,functionToCall:this._operators.expression.bind(this._operators),arguments:startingExpressionMembers,operators:{unaryToApply:null,isUnary:symbol=>{const lastElement=expression.arguments[expression.arguments.length-1];return this._operators.isAnOperatorString(symbol)&&(expression.arguments.length===0||this._operators.isAnOperator(lastElement))},isPreModifier:symbol=>{const lastExpressionMember=expression.arguments[expression.arguments.length-1];return expression.arguments.length>0&&symbol in this._operators.symbols.unary.preModifier&&!this._operators.isAnOperator(lastExpressionMember)}}};return expression}_applyCurrentOperator(char=null){if(!this._currentOperator){return}if(char&&this._operators.isAnOperatorCandidate(this._currentOperator+char)){this._currentOperator+=char}const lastStep=this._peekCallStack();if(!lastStep?.expression){if(lastStep?.operand){this._callStack.splice(this._callStack.length-1,1);this._callStack.push(this._createExpression(...lastStep.arguments))}else{this._callStack.push(this._createExpression())}}this._addCurrentSymbolToStack();this._addCurrentOperatorToExpression()}_getAllOperandsUntilLastCustomFunction(){const operands=[];const lastFunction=this._getLastCustomFunctionStep();if(!lastFunction){return operands}for(let i=this._callStack.length-1;i>=0;i--){const step=this._callStack[i];if(step.operand){operands.push(step)}else break}return operands}_closeLastCustomFunction(){if(this._peekCallStack()?.expression){return}if(this._parenthesisStack[this._parenthesisStack.length-1]===PARENTHESIS_TYPE.EXPRESSION){return}const lastFunction=this._getLastCustomFunctionStep();if(!lastFunction){return}if(lastFunction.customFunction&&!lastFunction.closed){const operands=this._getAllOperandsUntilLastCustomFunction();lastFunction.arguments.push(...operands.map((operand=>operand.functionToCall(...operand.arguments))));operands.forEach((()=>this._callStack.pop()));lastFunction.closed=true;this._popStack()}}_parse(formula,record,propertiesList){formula=`(${formula})`;this._currentRecord=record;this._currentRecordPropertiesList=propertiesList;for(const char of formula){this._currentChar=char;this._currentPosition+=char;if(char!==CHAR_BACKSLASH){if(this._lastChar===CHAR_BACKSLASH&&this._chainedBackslashes%2!==0){if(char===CHAR_DOUBLE_QUOTE||char===CHAR_SINGLE_QUOTE){this._currentSymbol+=char;this._lastChar=char;this._chainedBackslashes=0;continue}}this._chainedBackslashes=0}if((this._openString.singleQuote||this._openString.doubleQuote)&&char!==CHAR_BACKSLASH){if(this._openString.singleQuote&&char!==CHAR_SINGLE_QUOTE||this._openString.doubleQuote&&char!==CHAR_DOUBLE_QUOTE){this._currentSymbol+=char;this._lastChar=char;continue}}if(this._openCurlyBracket===2&&char!==CHAR_CLOSE_CURLY_BRACKET){this._currentSymbol+=char;this._lastChar=char;continue}else if(this._openCurlyBracket===1&&char!==CHAR_OPEN_CURLY_BRACKET&&char!==CHAR_CLOSE_CURLY_BRACKET){this._parseError("Invalid character here. An opened curly bracket must be immediately"+" followed by another one to get a valid tag !")}switch(char){case CHAR_OPEN_PARENTHESIS:this._applyCurrentOperator();if(this._currentSymbol){let funcName=this._currentSymbol.toUpperCase();if(funcName in this._functions){this._callStack.push({functionToCall:this._functions[funcName],arguments:[],customFunction:true})}else{this._parseError(`Unknown function ${funcName}`)}this._parenthesisStack.push(PARENTHESIS_TYPE.CUSTOM_FUNCTION);this._currentSymbol=""}else{const lastStep=this._peekCallStack();if(lastStep?.expression){const previousStep=this._callStack[this._callStack.length-2];if(previousStep&&previousStep.maxArguments===1){this._callStack.splice(this._callStack.length-2,1);this._callStack.push(this._createExpression(...previousStep.arguments))}else{this._callStack.push(this._createExpression())}}else{this._callStack.push({maxArguments:1,functionToCall:this._operators.identity,arguments:[]})}this._parenthesisStack.push(PARENTHESIS_TYPE.EXPRESSION)}break;case CHAR_CLOSING_PARENTHESIS:this._applyPostModifier();this._applyCurrentOperator();this._addCurrentSymbolToStack();if(!this._closeCurrentExpression()){this._popStack()}else{this._closeLastCustomFunction()}this._parenthesisStack.pop();break;case CHAR_COMMA:this._applyPostModifier();const callStackStep=this._getLastFunctionStep();if("maxArguments"in callStackStep&&callStackStep.arguments.length+1>callStackStep.maxArguments){this._parseError(`Expected ')' but found ','`)}this._applyCurrentOperator(null,true);this._addCurrentSymbolToStack();this._closeCurrentExpression();const lastStep=this._peekCallStack();if(lastStep?.operand){const lastFunction=this._getLastFunctionStep();if(lastFunction?.customFunction||lastFunction.maxArguments===1){lastFunction.arguments.push(...lastStep.arguments);this._callStack.pop();const lastStackStep=this._peekCallStack();const penultimateStackStep=this._callStack[this._callStack.length-2];if(lastStackStep.maxArguments===1&&penultimateStackStep.customFunction){penultimateStackStep.arguments.push(lastFunction.arguments[0]);this._callStack.pop()}}}break;case CHAR_TAB:case CHAR_NEWLINE:case CHAR_CARRIAGE_RETURN:case CHAR_SPACE:this._applyCurrentOperator();break;case CHAR_BACKSLASH:this._applyCurrentOperator();this._chainedBackslashes++;if(this._openString.singleQuote||this._openString.doubleQuote){if(this._lastChar===CHAR_BACKSLASH){if(this._chainedBackslashes%2===0){this._currentSymbol+=char}}}else{if(this._lastChar!==CHAR_BACKSLASH){this._currentSymbol+=char}else{this._parseError("Unexpected character \\: outside strings, double backslashes are forbidden.")}}break;case CHAR_SINGLE_QUOTE:case CHAR_DOUBLE_QUOTE:let stringClosed=false;if(char===CHAR_DOUBLE_QUOTE){if(this._openString.doubleQuote){if(this._lastChar!==CHAR_BACKSLASH){this._openString.doubleQuote=false}else{if(this._chainedBackslashes%2===0){this._openString.doubleQuote=false}else{this._currentSymbol+=char}}stringClosed=!this._openString.doubleQuote}else{this._openString.doubleQuote=true}}else{if(this._openString.singleQuote){if(this._lastChar!==CHAR_BACKSLASH){this._openString.singleQuote=false}else{if(this._chainedBackslashes%2===0){this._openString.singleQuote=false}else{this._currentSymbol+=char}}stringClosed=!this._openString.singleQuote}else{this._openString.singleQuote=true}}if(stringClosed){this._pushValueToStack(this._currentSymbol);this._currentSymbol=""}break;case CHAR_OPEN_CURLY_BRACKET:if(this._openCurlyBracket===0){this._addCurrentSymbolToStack()}this._currentSymbol+=char;this._openCurlyBracket++;break;case CHAR_CLOSE_CURLY_BRACKET:this._currentSymbol+=char;if(this._openCurlyBracket===0){this._parseError("Unexpected closing bracket !")}this._openCurlyBracket--;if(this._openCurlyBracket%2===0){this._applyCurrentOperator()}break;default:this._applyPostModifier();if(this._currentOperator){if(this._operators.isAnOperatorCandidate(this._currentOperator+char)){this._currentOperator+=char;break}else if(this._operators.isAnOperatorCandidate(char)){this._addCurrentOperatorToExpression();this._currentOperator=char;break}}else if(this._operators.isAnOperatorCandidate(char)){this._currentOperator=char;break}this._applyCurrentOperator();this._currentSymbol+=char;break}this._lastChar=char}this._applyCurrentOperator();if(this._currentSymbol){this._addCurrentSymbolToStack();this._popStack()}while(this._callStack.length>0){this._popStack()}const finalResult=this._finalResult;this._reset();return finalResult}parse(formula,record,propertiesList=undefined){try{return this._parse(formula,record,propertiesList)}catch(err){this._reset();throw err}}_reset(){this._callStack=[];this._lastChar="";this._currentChar="";this._currentRecord={};this._currentSymbol="";this._currentPosition="";this._currentOperator="";this._openCurlyBracket=0;this._currentRecordPropertiesList=[];this._chainedBackslashes=0;this._parenthesisStack=[];this._openString={singleQuote:false,doubleQuote:false};this._finalResult=undefined}};kiss.lib.formula.ParserOperators=class ParserOperators{symbols={unary:{preModifier:{"!":Symbol("!")},postModifier:{"~":Symbol("~"),"!":Symbol("!"),"-":Symbol("-")}},binary:{"+":Symbol("+"),"-":Symbol("-"),"/":Symbol("/"),"%":Symbol("%"),"*":Symbol("*"),"|":Symbol("|"),"&":Symbol("&"),"^":Symbol("^"),"&&":Symbol("&&"),"||":Symbol("||"),"<":Symbol("<"),"<=":Symbol("<="),">":Symbol(">"),">=":Symbol(">="),"??":Symbol("??"),"==":Symbol("=="),"!=":Symbol("!="),"!==":Symbol("!=="),"===":Symbol("===")}};unary={preModifier:{[this.symbols.unary.preModifier["!"]]:operand=>{let isPositive=operand>=0;operand=Math.abs(operand);let result=operand;if(operand===0||operand===1){return 1}while(operand>1){operand--;result*=operand}return isPositive?result:-result}},postModifier:{[this.symbols.unary.postModifier["~"]]:operand=>~operand,[this.symbols.unary.postModifier["!"]]:operand=>!operand,[this.symbols.unary.postModifier["-"]]:operand=>-operand}};binary={[this.symbols.binary["+"]]:(leftOperand,rightOperand)=>leftOperand+rightOperand,[this.symbols.binary["-"]]:(leftOperand,rightOperand)=>leftOperand-rightOperand,[this.symbols.binary["/"]]:(leftOperand,rightOperand)=>leftOperand/rightOperand,[this.symbols.binary["%"]]:(leftOperand,rightOperand)=>leftOperand%rightOperand,[this.symbols.binary["*"]]:(leftOperand,rightOperand)=>leftOperand*rightOperand,[this.symbols.binary["|"]]:(leftOperand,rightOperand)=>leftOperand|rightOperand,[this.symbols.binary["&"]]:(leftOperand,rightOperand)=>leftOperand&rightOperand,[this.symbols.binary["^"]]:(leftOperand,rightOperand)=>leftOperand^rightOperand,[this.symbols.binary["&&"]]:(leftOperand,rightOperand)=>leftOperand&&rightOperand,[this.symbols.binary["||"]]:(leftOperand,rightOperand)=>leftOperand||rightOperand,[this.symbols.binary["<"]]:(leftOperand,rightOperand)=>leftOperand<rightOperand,[this.symbols.binary["<="]]:(leftOperand,rightOperand)=>leftOperand<=rightOperand,[this.symbols.binary[">"]]:(leftOperand,rightOperand)=>leftOperand>rightOperand,[this.symbols.binary[">="]]:(leftOperand,rightOperand)=>leftOperand>=rightOperand,[this.symbols.binary["??"]]:(leftOperand,rightOperand)=>leftOperand??rightOperand,[this.symbols.binary["=="]]:(leftOperand,rightOperand)=>leftOperand==rightOperand,[this.symbols.binary["!="]]:(leftOperand,rightOperand)=>leftOperand!=rightOperand,[this.symbols.binary["==="]]:(leftOperand,rightOperand)=>leftOperand===rightOperand,[this.symbols.binary["!=="]]:(leftOperand,rightOperand)=>leftOperand!==rightOperand};precedence={[this.symbols.binary["*"]]:150,[this.symbols.binary["/"]]:150,[this.symbols.binary["%"]]:150,[this.symbols.binary["+"]]:140,[this.symbols.binary["-"]]:140,[this.symbols.binary["<"]]:120,[this.symbols.binary["<="]]:120,[this.symbols.binary[">"]]:120,[this.symbols.binary[">="]]:120,[this.symbols.binary["=="]]:110,[this.symbols.binary["!="]]:110,[this.symbols.binary["==="]]:110,[this.symbols.binary["!=="]]:110,[this.symbols.binary["&"]]:100,[this.symbols.binary["^"]]:90,[this.symbols.binary["|"]]:80,[this.symbols.binary["&&"]]:70,[this.symbols.binary["||"]]:60,[this.symbols.binary["??"]]:50};operatorCandidates={};constructor({operators:operators={}}={}){Object.entries(operators).forEach((([operatorName,operatorDefinition])=>{const{precedence:precedence=10,type:type="binary",operation:operation}=operatorDefinition;const errorHeader=`Operator "${operatorName}" definition error: `;if(!operatorName){throw new TypeError(`${errorHeader}An empty string is not a valid operator name`)}if(!Number.isInteger(precedence)){throw new TypeError(`${errorHeader}Invalid preference for operator "${operatorName}". Expecting integer, got ${typeof precedence}`)}if(!(typeof operation!=="function")){throw new TypeError(`${errorHeader}Operation must be a function`)}const operatorSymbol=Symbol(operatorName);switch(type){case"binary":this.symbols.binary[operatorName]=operatorSymbol;this.binary[operatorSymbol]=operation;this.precedence[operatorSymbol]=precedence;break;case"unary.postModifier":this.symbols.unary.postModifier[operatorName]=operatorSymbol;this.unary.postModifier[operatorSymbol]=operation;this.precedence[operatorSymbol]=precedence;break;case"unary.preModifier":this.symbols.unary.preModifier[operatorName]=operatorSymbol;this.unary.preModifier[operatorSymbol]=operation;this.precedence[operatorSymbol]=precedence;break;default:throw new TypeError(`Unsupported operator type ${type}. Allowed: 'binary', 'unary.preModifier', 'unary.postModifier'`)}}));const operatorKeys=new Set([...Object.keys(this.symbols.unary.preModifier),...Object.keys(this.symbols.unary.postModifier),...Object.keys(this.symbols.binary)]);for(const operatorKey of operatorKeys){this.operatorCandidates[operatorKey]=true;const split=operatorKey.split("");let derived="";while(split.length){derived+=split.shift();this.operatorCandidates[derived]=true}}}_infixToPostfix(infix){const output=[];const operators=[];for(let token of infix){if(this.isAnOperator(token)){while(operators.length&&this.precedence[operators[operators.length-1]]>=this.precedence[token]){output.push(operators.pop())}operators.push(token)}else{output.push(token)}}while(operators.length){output.push(operators.pop())}return output}identity(res,...rest){if(rest.length>0){throw new Error("Formula execution error: an identity operator can`t accept more than one argument.")}return res}expression(...args){if(args.length===1){return args[0]}const postfix=this._infixToPostfix(args);const stack=[];for(let token of postfix){if(token in this.binary){const b=stack.pop();const a=stack.pop();stack.push(this.binary[token](a,b))}else{stack.push(token)}}return stack[0]}isAnOperator(symbol){return symbol in this.unary.postModifier||symbol in this.unary.preModifier||symbol in this.binary}isAnOperatorCandidate(candidate){return candidate in this.operatorCandidates}isAnOperatorString(operator){return operator in this.symbols.unary.postModifier||operator in this.symbols.unary.preModifier||operator in this.symbols.binary}parseOperator(type,candidate){if(!this.isAnOperatorCandidate(candidate)){throw new TypeError(`${candidate} is not a valid operator!`)}switch(type){case"binary":return this.symbols.binary[candidate];case"unary.preModifier":return this.symbols.unary.preModifier[candidate];case"unary.postModifier":return this.symbols.unary.postModifier[candidate];default:throw new TypeError(`Unsupported operator type ${type}. Allowed: 'binary', 'unary.preModifier', 'unary.postModifier`)}}};kiss.addToModule("global",{tokens:{},refreshTokens:{},ajaxRetries:0,ajaxMaxRetries:3,models:[],viewTypes:[{name:"datatable",icon:"fas fa-th-list",description:"#datatable view"},{name:"calendar",icon:"far fa-calendar",description:"#calendar view"},{name:"kanban",icon:"fab fa-trello",description:"#kanban view"},{name:"timeline",icon:"fas fa-align-left",description:"#timeline view"},{name:"gallery",icon:"fas fa-image",description:"#gallery view"},{name:"map",icon:"fas fa-map",description:"#map view"},{name:"chart",icon:"fas fa-chart-line",description:"#chart view"},{name:"dashboard",icon:"fas fa-tachometer-alt",description:"#dashboard view"}],getViewIcon(type){const view=this.viewTypes.find((v=>v.name==type));if(view)return view.icon;return"fas fa-th-list"},chartTypes:[{name:"bar",icon:"fas fa-chart-bar"},{name:"line",icon:"fas fa-chart-line"},{name:"pie",icon:"fas fa-chart-pie"},{name:"doughnut",icon:"fab fa-osi"},{name:"number",icon:"fas fa-hashtag"}],getChartIcon(type){const chart=this.chartTypes.find((c=>c.name==type));if(chart)return chart.icon;return"fas fa-chart-line"},fieldTypes:[{value:"text",label:"text",icon:"fas fa-font",dataType:"text"},{value:"textarea",label:"paragraph",icon:"fas fa-comment-dots",dataType:"text"},{value:"richTextField",label:"rich text",icon:"fas fa-align-left",dataType:"text"},{value:"aiTextarea",label:"AI paragraph",icon:"far fa-lightbulb",dataType:"text"},{value:"number",label:"number",icon:"fas fa-hashtag",dataType:"number"},{value:"date",label:"date",icon:"fas fa-calendar",dataType:"date"},{value:"time",label:"time",icon:"fas fa-clock",dataType:"text"},{value:"select",label:"#select",icon:"fas fa-mouse-pointer",dataType:"text"},{value:"selectViewColumn",label:"#select view column",icon:"fas fa-th-list",dataType:"text"},{value:"selectViewColumns",label:"#select view columns",icon:"fas fa-table",dataType:"text"},{value:"checkbox",label:"checkbox",icon:"fas fa-check-square",dataType:"boolean"},{value:"attachment",label:"attachment",icon:"fas fa-paperclip"},{value:"aiImage",label:"AI image",icon:"fas fa-images"},{value:"directory",label:"collaborators",icon:"fas fa-users"},{value:"slider",label:"slider",icon:"fas fa-sliders-h"},{value:"rating",label:"rating",icon:"fas fa-star"},{value:"color",label:"color",icon:"fas fa-palette"},{value:"colorPicker",label:"color picker",icon:"fas fa-palette"},{value:"icon",label:"icon",icon:"far fa-heart"},{value:"iconPicker",label:"icon picker",icon:"far fa-heart"},{value:"password",label:"password",icon:"fas fa-key"},{value:"codeEditor",label:"code editor",icon:"fas fa-code"},{value:"mapField",label:"map field",icon:"fas fa-map"},{value:"link",label:"link to another table",icon:"fas fa-link"},{value:"lookup",label:"lookup a value on linked records",icon:"fas fa-eye"},{value:"summary",label:"summarize data from linked records",icon:"fas fa-calculator"}],elementTypes:[{value:"html",label:"HTML",icon:"fas fa-bars"},{value:"image",label:"image",icon:"fas fa-image"},{value:"button",label:"button",icon:"fas fa-square"}],componentCount:0,palette:["00CCEE","00AAEE","0075FF","0088CC","004499","007766","008833","00AA99","55CC00","88CC00","FFD139","FFAA00","F77D05","B22222","CC0055","ED3757","EE00AA","CC0088","8833EE","772288","77DDEE","77CCEE","429AFF","66AACC","447799","537772","528866","6FAAA4","91CC66","C3E673","EACD64","FFD480","CCA266","B25959","CC6690","FF8080","EE77CC","AD77EE","7B68EE","815F88","BEDBE0","B4DDED","87BFFF","A1BDCC","6B8699","6E8777","899E91","8AA8A4","BACCAD","D0D8BC","E2D7A1","FFE6B5","D8C4A8","B28C8C","DA9BB5","FFBBBB","F5BCE5","C6ADE3","ABA2E1","B19AB5","FFFFFF","BBBBBB","999999","777777","555555","000000"]});String.prototype.containsHTML=function(){if(this.valueOf()==="<>")return false;const regex=/<(?:.|\n)*?>/gm;return regex.test(this)};String.prototype.escapeHtml=function(){return this.replace(/&/g,"&#38;").replace(/"/g,"&#34;").replace(/'/g,"&#39;").replace(/</g,"&#60;")};String.prototype.isSafe=function(){return/^[^<>]*$/.test(this)||/[\w\d]|[^\>\<]/.test(this)};String.prototype.removeExtraSpaces=function(){return this.replace(/\s+/g," ")};String.prototype.toTitleCase=function(){return this.charAt(0).toUpperCase()+this.substring(1)};String.prototype.isNumeric=function(){return!isNaN(parseFloat(this))&&isFinite(this)};String.prototype.hashCode=function(){let hash=0;let chr;if(this.length===0)return hash;for(let i=0;i<this.length;i++){chr=this.charCodeAt(i);hash=hash*31+chr;hash|=0}return hash};String.prototype.rightString=function(substring){let index=this.indexOf(substring);return index===-1?"":this.slice(index+substring.length)};String.prototype.leftString=function(substring){let index=this.indexOf(substring);return index===-1?"":this.slice(0,index)};Date.prototype.toISO=function(){return this.toISOString().split("T")[0]};Date.prototype.toISODateTime=function(){return this.toISO()+" "+this.toLocaleTimeString()};Date.prototype.addDays=function(days){let date=new Date(this.valueOf());date.setDate(date.getDate()+days);return date};Date.prototype.toTime=function(){let hours=this.getHours().toString().padStart(2,"0");let minutes=this.getMinutes().toString().padStart(2,"0");return`${hours}:${minutes}`};Date.prototype.getWeek=function(dowOffset=1){let newYear=new Date(this.getFullYear(),0,1);let day=newYear.getDay()-dowOffset;day=day>=0?day:day+7;let dayNum=Math.floor((this.getTime()-newYear.getTime()-(this.getTimezoneOffset()-newYear.getTimezoneOffset())*6e4)/864e5)+1;let weekNum;if(day<4){weekNum=Math.floor((dayNum+day-1)/7)+1;if(weekNum>52){nYear=new Date(this.getFullYear()+1,0,1);nDay=nYear.getDay()-dowOffset;nDay=nDay>=0?nDay:nDay+7;weekNum=nDay<4?1:53}}else{weekNum=Math.floor((dayNum+day-1)/7)}return weekNum};Number.prototype.round=function(precision){return+(Math.round(this+"e+"+precision)+"e-"+precision)};Number.prototype.toFileSize=function(){let fileSizeMb=Math.round(this/1024/1024);if(fileSizeMb>0)return fileSizeMb+" MB";let fileSizeKb=Math.round(this/1024);if(fileSizeKb>0)return fileSizeKb+" kB";return this+" B"};Number.prototype.format=function(precision){return this.toLocaleString(undefined,{minimumFractionDigits:precision,maximumFractionDigits:precision})};Number.prototype.pad=function(width){if(typeof width!=="number")return this;return String(this).padStart(width,"0")};Array.prototype.swap=function(idx1,idx2){const tmp=this[idx1];this[idx1]=this[idx2];this[idx2]=tmp;return this};Array.prototype.unique=function(){let arr=[];for(let i=0;i<this.length;i++){if(!arr.includes(this[i]))arr.push(this[i])}return arr};Array.prototype.uniqueObjectId=function(){const ids=this.map((o=>o.id));return this.filter((({id:id},index)=>!ids.includes(id,index+1)))};Array.prototype.uniqueObject=function(propertyName){return this.filter(((item,index,self)=>index===self.findIndex((element=>element[propertyName]===item[propertyName]))))};Array.prototype.intersect=function(otherArray){return this.filter((item=>otherArray.includes(item)))};Array.prototype.remove=function(item){let index=this.indexOf(item);if(index!=-1)this.splice(index,1);return this};Array.prototype.get=function(itemId){return this.find((item=>item.id===itemId))};Array.prototype.sortBy=function(propertyName){return this.sort((function(a,b){if(a[propertyName]<=b[propertyName])return-1;return 1}))};Array.prototype.sortAlpha=function(){return this.sort(((a,b)=>a.localeCompare(b)))};Array.prototype.removeById=function(itemId){const index=this.findIndex((item=>item.id==itemId));if(index>-1)this.splice(index,1);return this};Array.prototype.includesObject=function(object){return JSON.stringify(this).indexOf(JSON.stringify(object))!=-1};Event.prototype.stop=function(){this.stopPropagation();this.preventDefault()};if(kiss.isClient){Element.prototype.deepDelete=function(deleteRoot){while(this.firstElementChild)this.lastElementChild.deepDelete();if(deleteRoot!==false){if(this.subscriptions&&this.subscriptions.length!=0)this.subscriptions.forEach((subscriptionId=>kiss.pubsub.unsubscribe(subscriptionId)));if(this.isContainer)kiss.screen.getResizeObserver().unobserve(this);if(this.mask)this.mask.deepDelete();if(this._beforeDelete)this._beforeDelete();if(this.parentNode)this.parentNode.removeChild(this)}}}kiss.addToModule("tools",{shortUid(size=8){size--;const alphabet="aAbBcCdDeEfFgGhHiIjJkKlLmMnNoOpPqQrRsStTuUvVwWxXyYzZ0123456789";let id=alphabet[Math.random()*52|0];while(size--)id+=alphabet[Math.random()*62|0];return id},nanoId(t=21){return crypto.getRandomValues(new Uint8Array(t)).reduce(((t,e)=>t+=(e&=63)<36?e.toString(36):e<62?(e-26).toString(36).toUpperCase():e<63?"_":"-"),"")},isUid(str){const RFC4122=/\b[0-9a-f]{8}\b-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-\b[0-9a-f]{12}\b/;if(str.match(RFC4122))return true;return false},isCustomModel(modelId){if(kiss.tools.isUid(modelId))return true;return false},hasAuditTrail(modelId){const model=kiss.app.models[modelId];if(!model.features)return false;if(!model.features["form-feature-audit"])return false;if(model.features["form-feature-audit"].active==true)return true;return false},isNumericField(field){const fieldType=field.type;return["number","rating","slider"].includes(fieldType)||fieldType=="lookup"&&["number","rating","slider"].includes(field.lookup.type)||fieldType=="summary"&&["number","rating","slider"].includes(field.summary.type)},isNumber(n){return!isNaN(parseFloat(n))&&isFinite(n)},isISODate(text,dateOnly=false){const isoRegex=dateOnly?/^\d{4}-\d{2}-\d{2}$/:/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?Z$/;return isoRegex.test(text)},intersects(array1,array2){const intersection=kiss.tools.intersection(array1,array2);return intersection.length>0},intersection(array1,array2){if(!array1||!array2)return[];return array1.filter((item=>array2.includes(item)))},daysBetweenDates(dateA,dateB){const timeDifference=Math.abs(dateA.getTime()-dateB.getTime());return Math.floor(timeDifference/(3600*24*1e3))},findTags(sourceText){let regex=new RegExp("{{(.*?)}}","g");let text,tags=[];while(text=regex.exec(sourceText))tags.push(text[0].substring(2,text[0].length-2));return tags.unique()},getTime(displaySseconds){const now=new Date;const hours=now.getHours().pad(2);const minutes=now.getMinutes().pad(2);const seconds=now.getSeconds().pad(2);return hours+":"+minutes+(displaySseconds?":"+seconds:"")},wait(ms=500){return new Promise((resolve=>setTimeout(resolve,ms)))},throttle(delay,fn){let lastCall=0;return function(...args){const now=(new Date).getTime();if(now-lastCall<delay)return;lastCall=now;return fn(...args)}},memoize(func){const cache={};return input=>{log("MEMOIZED:"+input);if(cache[input])log("!MEMOIZED: sent cached result!");return cache[input]||(cache[input]=func(input))}},distanceInKm(lat1,lon1,lat2,lon2){const earthRadius=6371;const dLat=kiss.tools.degToRad(lat2-lat1);const dLon=kiss.tools.degToRad(lon2-lon1);const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(kiss.tools.degToRad(lat1))*Math.cos(kiss.tools.degToRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));const distance=earthRadius*c;return distance},degToRad(degrees){return degrees*Math.PI/180},isInRange(geolocationA,geolocationB,rangeInKm){const distance=kiss.tools.distanceInKm(geolocationA.latitude,geolocationA.longitude,geolocationB.latitude,geolocationB.longitude);return distance<=rangeInKm},validateValue(dataType,config,value){if(config.readOnly)return true;if(config.required&&(value==""||value==undefined))return false;if(dataType=="rating"&&config.required&&value===0)return false;if(value=="")return true;switch(dataType){case"text":case"textarea":case"aiTextarea":case"password":return kiss.tools.validateText(config,value);case"number":return kiss.tools.validateNumber(config,value)}return true},validateNumber(config,value){value=Number(value);if(config.hasOwnProperty("min")&&config.min!==undefined&&config.min!==0&&value<config.min||config.hasOwnProperty("max")&&config.max!==undefined&&config.max!==0&&value>config.max){return false}if(config.precision==0&&!Number.isInteger(value)){return false}return true},validateText(config,value){if(kiss.tools.validateTextLength(config,value)==false)return false;switch(config.validationType){case"alpha":if(!value.match(kiss.tools.regex.alpha))return false;break;case"alphanumeric":if(!value.match(kiss.tools.regex.alphanumeric))return false;break;case"email":if(!value.match(kiss.tools.regex.email))return false;break;case"url":if(!value.match(kiss.tools.regex.url))return false;break;case"ip":if(!value.match(kiss.tools.regex.ip))return false;break;case"regex":if(!config.validationRegex)return true;const regex=kiss.tools.createRegexFromString(config.validationRegex);if(!value.match(regex))return false}if(value.containsHTML()&&config.allowHTML!==true)return false;return true},createRegexFromString(input){let regexBody;let regexFlags;const regexDelimiterPattern=/^\/(.+)\/([gimsuy]*)$/;if(regexDelimiterPattern.test(input)){const parts=input.match(regexDelimiterPattern);regexBody=parts[1];regexFlags=parts[2]}else{regexBody=input;regexFlags=""}return new RegExp(regexBody,regexFlags)},convertHtmlToPlainText(html){html=html.replace(/<br\s*\/?>/gi,"\n");html=html.replace(/<\/p>/gi,"\n");var tempDiv=document.createElement("div");tempDiv.innerHTML=html;return tempDiv.textContent||tempDiv.innerText||""},validateTextLength(config,value){if(config.hasOwnProperty("minLength")&&value.length<config.minLength||config.hasOwnProperty("maxLength")&&config.maxLength>0&&value.length>config.maxLength){return false}return true},regex:{alpha:new RegExp(`^[a-zA-Z_]+$`),alphanumeric:new RegExp(`^[a-zA-Z0-9]([a-zA-Z0-9_])+$`),email:new RegExp(`^\\s*([\\w.%+-]+@[\\w.-]+\\.[a-zA-Z]{2,})(\\s*,\\s*[\\w.%+-]+@[\\w.-]+\\.[a-zA-Z]{2,})*\\s*$`),url:new RegExp(`^(http(s?):\\/)?\\/(.)+$`),ip:new RegExp(`^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$`)},generateSlug(text){return text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")},generateBreadcrumb(items){let breadcrumb='<nav aria-label="breadcrumb"><div itemscope="itemscope" itemtype="http://schema.org/BreadcrumbList" class="breadcrumb"><div class="container">';for(let i=0;i<items.length;i++){let item=items[i];let li=`<span itemprop="itemListElement" itemscope="itemscope" itemtype="http://schema.org/ListItem" class="breadcrumb-item${i===items.length-1?" active":""}">`;if(item.url){li+=`<a href="${item.url}" itemprop="item"><span itemprop="name">${item.label}</span> <meta itemprop="position" content="${i+1}"></a>`}else{li+=`<span itemprop="name">${item.label}</span> <meta itemprop="position" content="${i+1}">`}li+="</span>";breadcrumb+=li}breadcrumb+="</div></div></nav>"}});kiss.app.defineModel({id:"account",name:"Account",namePlural:"Accounts",icon:"fas fa-home",color:"#00aaee",items:[{primary:true,id:"owner",dataType:String},{isACL:true,id:"managers",dataType:Array},{id:"planId",dataType:String},{id:"planUsers",dataType:String},{id:"planApps",dataType:String},{id:"stripeCustomerId",dataType:String},{id:"stripeSubscriptionId",dataType:String},{id:"periodStart",dataType:String},{id:"periodEnd",dataType:String},{id:"status",dataType:String},{id:"createdAt",dataType:String},{id:"collaborators",dataType:Array},{id:"invited",dataType:Array},{id:"smtp",dataType:Object}],acl:{permissions:{create:[{isCreator:true}],update:[{isSupportTeam:true}],delete:[{isDeleter:true}]},validators:{async isCreator(){return false},async isSupportTeam({req:req}){const userId=kiss.isServer?req.token.userId:kiss.session.getUserId();if(userId.split("@")[1]==="pickaform.com")return true;return false},async isDeleter(){return false}}}});kiss.app.defineModel({id:"apiClient",name:"API client",namePlural:"API clients",icon:"fas fa-plug",color:"#ffaa00",items:[{id:"accountId",dataType:String},{id:"name",label:"#name",dataType:String},{id:"token",label:"token",readOnly:true,dataType:String},{id:"expiration",label:"expiration",readOnly:true,dataType:Date}],acl:{permissions:{create:[{isOwner:true},{isManager:true}],read:[{isOwner:true},{isManager:true}],update:[{isOwner:true},{isManager:true}],delete:[{isOwner:true},{isManager:true}]},validators:{async isOwner({req:req}){return kiss.isServer?req.token.isOwner:kiss.session.isAccountOwner()},async isManager({req:req}){return kiss.isServer?req.token.isManager:kiss.session.isAccountManager()}}}});kiss.app.defineModel({id:"file",splitBy:"account",name:"File",namePlural:"Files",icon:"fas fa-file",color:"#00aaee",items:[{id:"filename",label:"#name",dataType:String},{id:"mimeType",label:"#mime type",dataType:String},{id:"size",label:"#size",type:"number",dataType:Number},{id:"userId",dataType:String},{id:"accountId",dataType:String},{id:"modelId",dataType:String},{id:"type",dataType:String},{id:"path",dataType:String},{id:"downloadPath",dataType:String},{id:"fieldname",dataType:String},{id:"originalname",dataType:String},{id:"encoding",dataType:String},{id:"accessReaders",dataType:Array},{id:"destination",dataType:String}]});kiss.app.defineModel({id:"group",name:"Group",namePlural:"Groups",icon:"fas fa-users",color:"#00aaee",items:[{id:"name",dataType:String},{id:"description",dataType:String},{id:"icon",dataType:String},{id:"color",dataType:String},{id:"users",dataType:[String],isACL:true}],acl:{permissions:{create:[{isOwner:true},{isManager:true}],update:[{isOwner:true},{isManager:true}],delete:[{isOwner:true},{isManager:true}]},validators:{async isOwner({req:req}){return kiss.isServer?req.token.isOwner:kiss.session.isAccountOwner()},async isManager({req:req}){return kiss.isServer?req.token.isManager:kiss.session.isAccountManager()}}}});kiss.app.defineModel({id:"link",splitBy:"account",name:"Link",namePlural:"Links",icon:"fas fa-link",color:"#00aaee",items:[{id:"mX",dataType:String},{id:"rX",dataType:String},{id:"fX",dataType:String},{id:"mY",dataType:String},{id:"rY",dataType:String},{id:"fY",dataType:String},{id:"auto",dataType:Boolean}],acl:{permissions:{create:[{isCreator:true}],update:[{isUpdater:true}],delete:[{isDeleter:true}]},validators:{async isCreator({req:req,record:record}){if(kiss.isServer){if(Array.isArray(req.body)){req.path_0=req.body[0].mX;req.path_1=req.body[0].rX}else{req.path_0=req.body.mX;req.path_1=req.body.rX}return await kiss.acl.check({action:"update",req:req})}else{const modelId=record.mX;const recordId=record.rX;const linkedRecord=await kiss.app.collections[modelId].findOne(recordId);return await kiss.acl.check({action:"update",record:linkedRecord})}},async isUpdater(){return false},async isDeleter({req:req,record:record}){if(kiss.isServer){req.path_0=record.mX;req.path_1=record.rX;return await kiss.acl.check({action:"update",req:req})}else{const modelId=record.mX;const recordId=record.rX;const linkedRecord=await kiss.app.collections[modelId].findOne(recordId);return await kiss.acl.check({action:"update",record:linkedRecord})}}}}});kiss.app.defineModel({id:"trash",splitBy:"account",name:"Trash",namePlural:"Trashes",icon:"fas fa-trash",color:"#8833ee",items:[{id:"sourceModelId",label:"model",dataType:String},{id:"name",label:"name",dataType:String},{id:"icon",label:"icon",type:"icon",dataType:String},{id:"color",label:"color",type:"color",dataType:String},{id:"deletedAt",label:"#deletedAt",type:"data",dataType:Date},{id:"deletedBy",label:"#deletedBy",type:"directory",dataType:[String]}],acl:{permissions:{update:[{isUpdater:true}],delete:[{isOwner:true},{isManager:true},{isRestorer:true}]},validators:{async isOwner({req:req}){return kiss.isServer?req.token.isOwner:kiss.session.isAccountOwner()},async isManager({req:req}){return kiss.isServer?req.token.isManager:kiss.session.isAccountManager()},async isUpdater(){return false},async isRestorer({req:req,record:record}){const userId=kiss.isClient?kiss.session.getUserId():req.token.userId;return record.deletedBy==userId}}}});kiss.app.defineModel({id:"user",name:"User",namePlural:"Users",icon:"fas fa-user",color:"#00aaee",items:[{id:"accountId",dataType:String},{id:"email",primary:true,dataType:String},{id:"firstName",dataType:String},{id:"lastName",dataType:String},{id:"name",dataType:String},{id:"active",dataType:Boolean},{id:"loginType",dataType:String},{id:"socialId",dataType:String},{id:"sessionToken",dataType:String},{id:"password",dataType:String},{id:"language",dataType:String},{id:"isCollaboratorOf",dataType:Array},{id:"invitedBy",dataType:Array},{id:"currentAccountId",dataType:String}],acl:{permissions:{create:[{isOwner:true,quotaNotExceeded:true},{isManager:true,quotaNotExceeded:true}],update:[{isOwner:true},{isManager:true},{isConnectedUser:true}],delete:[{isOwner:true},{isManager:true}]},validators:{async isOwner({req:req}){return kiss.isServer?req.token.isOwner:kiss.session.isAccountOwner()},async isManager({req:req}){return kiss.isServer?req.token.isManager:kiss.session.isAccountManager()},async quotaNotExceeded(){if(kiss.isClient){const currentNumberOfUsers=kiss.app.collections.user.records.length;const allowedNumberOfUsers=Number(kiss.session.account.planUsers);if(currentNumberOfUsers>=allowedNumberOfUsers)return false;return true}},async isConnectedUser({req:req,record:record}){const userId=kiss.isServer?req.token.userId:kiss.session.getUserId();if(userId==record.email)return true;return false}}}});kiss.app.defineModel({id:"view",name:"View",namePlural:"Views",icon:"fas fa-table",color:"#ed3757",items:[{id:"createdAt",label:"#createdAt",type:"date",dataType:Date,acl:{update:false}},{primary:true,id:"name",label:"#name",type:"text",dataType:String},{id:"nameTranslations",dataType:Object},{id:"description",dataType:String},{id:"applicationIds",dataType:[String]},{id:"modelId",label:"#form",dataType:String,acl:{update:false}},{id:"fieldId",dataType:String,acl:{update:false}},{id:"type",dataType:String},{id:"filter",dataType:Object,value:{}},{id:"sort",dataType:[Object],value:[]},{id:"projection",dataType:Object,value:{}},{id:"group",dataType:[String]},{id:"config",dataType:Object},{id:"authenticatedCanRead",label:"#authenticatedCanRead",type:"checkbox",shape:"switch",iconColorOn:"#20c933",dataType:Boolean},{id:"accessRead",label:"#accessRead",type:"directory",multiple:true,dataType:[String],isACL:true},{id:"ownerCanUpdate",label:"#ownerCanUpdate",type:"checkbox",shape:"switch",iconColorOn:"#20c933",dataType:Boolean},{id:"accessUpdate",label:"#accessUpdate",type:"directory",multiple:true,dataType:[String],isACL:true},{id:"canCreateRecord",label:"#show create button",type:"checkbox",shape:"switch",iconColorOn:"#20c933",dataType:Boolean}],acl:{permissions:{create:[{isOwner:true},{isManager:true},{isModelDesigner:true},{isPrivateView:true}],read:[{isViewOwner:true},{authenticatedCanRead:true},{isViewReader:true}],update:[{isOwner:true},{isManager:true},{isViewOwner:true},{isViewDesigner:true},{isModelDesigner:true}],delete:[{isOwner:true},{isManager:true},{isViewOwner:true},{isViewDesigner:true},{isModelDesigner:true}]},validators:{async isOwner({req:req}){return kiss.isServer?req.token.isOwner:kiss.session.isAccountOwner()},async isManager({req:req}){return kiss.isServer?req.token.isManager:kiss.session.isAccountManager()},async isPrivateView({req:req,record:record}){const userId=kiss.isServer?req.token.userId:kiss.session.getUserId();if(record.accessUpdate.includes(userId))return true;return false},async isViewOwner({req:req,record:record}){const userId=kiss.isServer?req.token.userId:kiss.session.getUserId();if(record.createdBy==userId)return true;return false},async isViewDesigner({userACL:userACL,record:record}){if(record.ownerCanUpdate==true)return false;if(record.accessUpdate==undefined)return false;if(kiss.tools.intersects(userACL,record.accessUpdate))return true;return false},async isModelDesigner({userACL:userACL,req:req,record:record}){let model;const modelId=record.modelId;if(kiss.isServer){model=await kiss.db.findOne("model",{_id:modelId})}else{model=await kiss.app.collections.model.findOne(modelId)}if(!model)return false;if(model.ownerCanManage==true)return false;if(model.accessManage==undefined)return false;if(kiss.tools.intersects(userACL,model.accessManage))return true;return false},async authenticatedCanRead({record:record}){return!!record.authenticatedCanRead},async isViewReader({userACL:userACL,record:record}){if(record.accessRead&&kiss.tools.intersects(userACL,record.accessRead))return true}}},methods:{getCollection(){let collection=kiss.app.collections[this.id];if(!collection){collection=new kiss.data.Collection({id:this.id,model:kiss.app.models[this.modelId],sort:this.sort,filter:this.filter,group:this.group,projection:this.projection})}return collection},async syncWithModelFields(){const model=kiss.app.models[this.modelId];if(this.filter)this.filter=this._sanitizeFilters(this.filter);if(this.sort)this.sort=this.sort.filter((sortOption=>{const field=model.getField(Object.keys(sortOption)[0]);if(!field)return false;if(field.deleted)return false;return true}));if(this.group)this.group=this.group.filter((groupFieldId=>{const field=model.getField(groupFieldId);if(!field)return false;if(field.deleted)return false;return true}));if(this.type=="datatable"){model.getFields().forEach((field=>{let column=this.config.columns.get(field.id);if(column){column.type=model.getFieldType(field);column.title=field.label;if(column.title.startsWith("#"))column.title=txtTitleCase(column.title);column.title=column.title.toTitleCase();column.deleted=!!field.deleted}else{if(field.label&&field.type&&!field.deleted){this.config.columns.push({id:field.id,type:model.getFieldType(field),title:field.label.toTitleCase(),hidden:field.type=="link"?true:false})}}}));await this.update({config:this.config},true)}if(this.type=="calendar"){}if(this.type=="kanban"){}if(this.type=="gallery"){}},_sanitizeFilters(filter){if(!filter)return;if(filter.type=="filter"){const model=kiss.app.models[this.modelId];let filterField=model.getField(filter.fieldId);if(filterField&&filterField.deleted!=true)return filter;return null}else if(filter.type=="group"){let newFilters=[];filter.filters.forEach((filterConfig=>{let cleanedFilter=this._sanitizeFilters(filterConfig);if(cleanedFilter)newFilters.push(cleanedFilter)}));filter.filters=newFilters;return filter}},async rename(){let model=kiss.app.models[this.modelId];createDialog({type:"input",title:txtTitleCase("rename this view"),icon:model.icon,headerBackgroundColor:model.color,width:600,message:txtUpperCase("enter the view name"),defaultValue:this.name,buttonOKText:txtTitleCase("validate the new name"),autoClose:false,backdropFilter:true,action:async viewName=>{if(viewName==""){createNotification(txtTitleCase("a view must have a name"));return false}await this.update({name:viewName});return true}})},async duplicate(isPrivate=false){let model=kiss.app.models[this.modelId];createDialog({type:"input",title:txtTitleCase("duplicate this view"),icon:"fas fa-copy",headerBackgroundColor:model.color,width:600,message:txtUpperCase("enter the view name"),buttonOKText:txtTitleCase("create the new view"),autoClose:false,backdropFilter:true,action:async viewName=>{if(viewName==""){createNotification(txtTitleCase("a view must have a name"));return false}const newView=kiss.app.models.view.create(this);newView.id=uid();newView.name=viewName?viewName:newView.name+" "+txt("(copy)");newView.authenticatedCanRead=isPrivate?false:true;newView.accessRead=isPrivate?[kiss.session.getUserId()]:[];newView.ownerCanUpdate=isPrivate?false:true;newView.accessUpdate=isPrivate?[kiss.session.getUserId()]:[];await newView.save();kiss.router.navigateTo({viewId:newView.id});return true}})},async remove(){let application=await kiss.app.collections.application.findOne(kiss.context.applicationId);let model=kiss.app.models[this.modelId];let message=`<center>\n                ${txtTitleCase("#delete view message")}\n                <br><br>\n                <b>${model.namePlural.toTitleCase()} / ${this.name.toTitleCase()}</b>\n                </center>`;createDialog({type:"danger",title:txtTitleCase("delete the view"),message:message,width:600,buttonOKText:txtTitleCase("delete the view"),buttonOKPosition:"left",closable:false,autoClose:false,action:async()=>{await this.delete();let firstView=await application.getFirstView(this.modelId);if(!firstView)return true;kiss.router.navigateTo({viewId:firstView.id,viewType:firstView.type});kiss.app.models[this.modelId].lastOpenedView={type:firstView.type,id:firstView.id};return true}})}}});
//# sourceMappingURL=kissjs.min.js.map