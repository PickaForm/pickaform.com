kiss.ux.RichTextField=class RichTextField extends kiss.ui.Component{constructor(){super()}init(config={}){super.init(config);this.isQuillInitialized=false;this.useCDN=config.useCDN===false&&!kiss.session.isOffline()?false:true;this.readOnly=!!config.readOnly;this.disabled=!!config.disabled;this.required=!!config.required;this.innerHTML=`\n            ${config.label?`<label id="field-label-${this.id}" for="${this.id}" class="field-label">\n                ${this.isLocked()?this.locker:""}\n                ${config.label||""}\n                ${this.isRequired()?this.asterisk:""}\n            </label>`:""}\n            <div id="container-${this.id}" class="field-richtext"></div>\n        `;this.label=this.querySelector(".field-label");this.field=this.querySelector(".field-richtext");this._setProperties(config,[[["draggable"],[this]],[["flex","flexFlow","width","minWidth","height","minHeight","flex","display","margin","padding"],[this.style]],[["fieldWidth=width","fieldHeight=height","maxHeight","fieldPadding=padding","boxShadow"],[this.field.style]],[["fontSize","labelAlign=textAlign","labelFlex=flex","labelFontSize=fontSize","labelFontWeight=fontWeight","labelColor=color"],[this.label?.style]]]);this.displayMode="flex";this.style.flexFlow="row";if(config.label){if(config.labelWidth)this.setLabelWidth(config.labelWidth);this.config.labelPosition=config.labelPosition||"left";this.setLabelPosition(config.labelPosition)}this.theme=config.theme||"bubble";this.toolbar1=config.toolbar1||["clean",{header:1},{header:2},{header:3},{header:4}];this.toolbar2=config.toolbar2||["bold","italic","underline",{color:[]}];this.toolbar3=config.toolbar3||[{list:"ordered"},{list:"bullet"},{list:"check"}];this.toolbar4=config.toolbar4||["blockquote","code-block","link"];return this}async _afterRender(){if(window.Quill){this._initRichTextField()}else{await this._initRichTextEditor();this._initRichTextField()}if(this.config.record){this._bindRecord(this.config.record)}else if(this.config.value){this.richTextField.clipboard.dangerouslyPasteHTML(this.config.value)}if(this.readOnly||this.disabled){this.richTextContainer.classList.add("field-richtext-read-only");this.richTextField.disable();return}this.isFirstFocus=true;this.richTextField.root.onfocus=()=>{this.focused=true;if(!this.isFirstFocus)return;this.isFirstFocus=false;this.previousValue=this.getValue();this.dispatchEvent(new Event("focus"))};this.richTextField.root.onblur=()=>{if(!this.focused)return;this.focused=false;if(!this._isInsideEditor()){this.isFirstFocus=true;this.dispatchEvent(new Event("blur"));const newValue=this.getValue();if(this.previousValue==newValue)return;if(this.validate()){this.setValue(newValue,true)}}};this.richTextField.on("text-change",(()=>{this.validate()}));this.richTextField.on("editor-change",(()=>{this._adjustToolbarPosition.call(this)}))}async _initRichTextEditor(){if(this.useCDN===false){await kiss.loader.loadScript("../../kissjs/client/ux/richTextField/richTextField_quill");await kiss.loader.loadStyle("../../kissjs/client/ux/richTextField/richTextField_quill."+this.theme)}else{await kiss.loader.loadScript("https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill");await kiss.loader.loadStyle("https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill."+this.theme)}}_initRichTextField(){if(this.richTextField)return;this.richTextField=new Quill("#container-"+this.id,{theme:this.theme,modules:{toolbar:[this.toolbar1,this.toolbar2,this.toolbar3,this.toolbar4]}});this.richTextToolbar=this.querySelector(".ql-toolbar");this.richTextContainer=this.querySelector(".ql-container");this.isQuillInitialized=true;this._initSelectionObserver();if(this.config.imageWithCaption){this._initImageWithCaption();this._initImageWithCaptionClick();this._addCreationButton()}}_initSelectionObserver(){this.richTextField.root.addEventListener("click",(()=>{const currentSelection=this.richTextField.getSelection();this.currentSelectionIndex=(currentSelection||{}).index||0}))}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.initialValue=record[this.id];this.richTextField.clipboard.dangerouslyPasteHTML(this.initialValue)}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){const newValue=updates[this.id];if(newValue||newValue===0||newValue===""){this.richTextField.clipboard.dangerouslyPasteHTML(newValue)}}}async setValue(newValue,fromBlurEvent){await kiss.tools.waitUntil((()=>this.isQuillInitialized),50,5e3);if(this.record){this.record.updateFieldDeep(this.id,newValue).then((success=>{if(!success){this.richTextField.clipboard.dangerouslyPasteHTML(this.initialValue||"")}}))}else{if(!fromBlurEvent){this.richTextField.clipboard.dangerouslyPasteHTML(newValue)}}return this}getValue(){return this.richTextField.getSemanticHTML()}clearValue(){this.setValue("");return this}validate(){this.setValid();if(this.config.readOnly)return true;if(this.required&&this.isEmpty())this.setInvalid();return this.isValid}focus(){this.richTextField.focus();return this}blur(){this.richTextField.blur();return this}resetFocus(){this.blur();setTimeout((()=>this.focus()),100)}setValid(){this.isValid=true;this.richTextContainer.classList.remove("field-richtext-invalid");return this}setInvalid(){log("kiss.ui - field.setInvalid - Invalid value for the field: "+this.config.label,4);this.isValid=false;this.richTextContainer.classList.add("field-richtext-invalid");return this}isEmpty(){const value=this.getValue();const regex=/^(\s*<p>\s*<\/p>\s*)+$/;return regex.test(value)}setLabel(newLabel){if(!this.label)return;this.config.label=newLabel;this.label.innerText=newLabel;return this}getLabel(){return this?.label?.innerText||""}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setFieldWidth(width){this.config.fieldWidth=width;this.field.style.width=this._computeSize("fieldWidth",width);return this}setLabelWidth(width){this.config.labelWidth=width;this.label.style.width=this.label.style.maxWidth=this._computeSize("labelWidth",width);return this}getLabelPosition(){return this.config.labelPosition}setLabelPosition(position){this.config.labelPosition=position;switch(position){case"top":this.style.flexFlow="column";this.field.style.order=1;break;case"bottom":this.style.flexFlow="column";this.field.style.order=-1;break;case"right":this.style.flexFlow="row";this.field.style.order=-1;break;default:this.style.flexFlow="row";this.field.style.order=1}return this}_isInsideEditor(){const{x:x,y:y}=kiss.screen.mousePosition;const editorRect=this.richTextField.root.getBoundingClientRect();const isInsideEditor=x>=editorRect.left&&x<=editorRect.right&&y>=editorRect.top&&y<=editorRect.bottom;if(isInsideEditor)return true;const toolbarRect=this.richTextToolbar.getBoundingClientRect();const isInsideToolbar=x>=toolbarRect.left&&x<=toolbarRect.right&&y>=toolbarRect.top&&y<=toolbarRect.bottom;if(isInsideToolbar)return true;return false}_adjustToolbarPosition(){setTimeout((()=>{const tooltip=document.querySelector(".ql-tooltip");if(!tooltip)return;const componentBounds=this.getBoundingClientRect();const tooltipWidth=tooltip.offsetWidth;let left=componentBounds.width/2-tooltipWidth/2;if(left<0)left=10;if(left+tooltipWidth>window.innerWidth)left=window.innerWidth-tooltipWidth-10;tooltip.style.left=left+"px"}),5)}_initImageWithCaption(){const BlockEmbed=window.Quill.import("blots/block/embed");class ImageFigureBlot extends BlockEmbed{static create(value){const node=super.create();const figure=document.createElement("figure");const img=document.createElement("img");img.setAttribute("src",value.src);if(value.alt)img.setAttribute("alt",value.alt);const caption=document.createElement("figcaption");caption.innerText=value.caption||"";caption.classList.add("ql-caption");figure.appendChild(img);figure.appendChild(caption);node.appendChild(figure);return node}static value(node){const img=node.querySelector("img");if(!img)return null;const figcaption=node.querySelector("figcaption");return{src:img.getAttribute("src"),alt:img.getAttribute("alt"),caption:figcaption?figcaption.innerText:""}}}ImageFigureBlot.blotName="imagefigure";ImageFigureBlot.tagName="div";window.Quill.register(ImageFigureBlot)}_initImageWithCaptionClick(){this.richTextField.root.addEventListener("click",(event=>{const figure=event.target.closest("figure");if(!figure)return;const img=figure.querySelector("img");const currentImg=img.getAttribute("src")||"";const currentAlt=img.getAttribute("alt")||"";const figcaption=figure.querySelector("figcaption");const currentCaption=figcaption?.innerText||"";this._insertImageFromURL({mode:"update",figure:figure,img:img,src:currentImg,alt:currentAlt,figcaption:figcaption,caption:currentCaption})}))}_addCreationButton(){const toolbar=this.richTextField.getModule("toolbar");const toolbarContainer=toolbar.container;const customButton=document.createElement("div");customButton.innerHTML="<span class='fas fa-plus ql-toolbar-extension'></span>";const group=document.createElement("span");group.classList.add("ql-formats");group.appendChild(customButton);toolbarContainer.appendChild(group);customButton.addEventListener("click",(event=>{createMenu({items:[txtTitleCase("images"),"-",{icon:"fas fa-globe",text:txtTitleCase("#image from url"),action:()=>this._insertImageFromURL({})},{icon:"fas fa-download",text:txtTitleCase("#image from download"),action:()=>this._insertImageFromDownload()},{icon:"fas fa-th",text:txtTitleCase("#image from library"),action:()=>this._insertImageFromLibrary()},{hidden:true,icon:"fas fa-search",text:txtTitleCase("#image from unsplash"),action:()=>this._insertImageFromUnsplash()},"-",txtTitleCase("other"),"-",{icon:"fas fa-paperclip",text:txtTitleCase("#file attachment"),action:()=>this._insertAttachment()},{icon:"fas fa-square",text:txtTitleCase("#integrate button"),action:()=>this._insertButton()}]}).render().showAt(event.clientX-10,event.clientY-10)}))}_insertImageFromDownload(){const _this=this;createFileUploadWindow({modelId:_this.modelId,multiple:false,maxSize:5*1024*1024,ACL:"public",callback:data=>{_this._insertImageFromURL({mode:"create",src:"/"+data[0].path.replaceAll("\\","/"),alt:data[0].filename,caption:data[0].filename})}})}_insertImageFromLibrary(){createFileLibraryWindow({callback:file=>{if(!file||!file.filename)return;if(file.mimeType.startsWith("image/")){this._insertImageFromURL({mode:"create",src:kiss.tools.createFileURL(file),alt:file.filename,caption:file.filename});$("file-library-window").close()}}})}_insertImageFromUnsplash(){}_insertAttachment(){}_insertButton(){}_insertImageFromURL({mode:mode,figure:figure="",img:img="",src:src="",alt:alt="",figcaption:figcaption="",caption:caption=""}){const _this=this;createPanel({id:"image-caption-panel",title:txtTitleCase("image properties"),icon:"fas fa-image",modal:true,draggable:true,closable:true,align:"center",verticalAlign:"center",width:"40rem",defaultConfig:{labelPosition:"top",width:"100%",fieldWidth:"100%",margin:"1rem 0rem",events:{keydown:event=>{if(event.key==="Enter"){event.preventDefault();$("image-caption-panel").ok()}}}},items:[{id:"image-src-input",type:"text",label:txtTitleCase("image url"),value:src,validationType:"url",required:true,readOnly:mode==="create"},{id:"image-alt-input",type:"text",label:txtTitleCase("alternative text"),value:alt,required:true},{id:"image-caption-input",type:"text",label:txtTitleCase("caption"),value:caption,required:true},{layout:"horizontal",items:[{hidden:mode!=="update",type:"button",text:txtTitleCase("delete"),icon:"fas fa-trash",iconColor:"var(--red)",margin:"0 0.5rem 0 0",flex:1,action:()=>$("image-caption-panel").delete()},{type:"button",text:txtTitleCase("validate"),icon:"fas fa-check",iconColor:"var(--green)",flex:1,action:()=>$("image-caption-panel").ok()}]}],methods:{delete(){const wrapper=figure.closest("div");if(wrapper&&wrapper.parentNode){wrapper.parentNode.removeChild(wrapper)}$("image-caption-panel").close()},ok(){const panel=$("image-caption-panel");if(!panel.validate())return;const newSrc=$("image-src-input").getValue();const newAlt=$("image-alt-input").getValue();const newCaption=$("image-caption-input").getValue();if(mode==="update"){if(!newSrc)return;img.setAttribute("src",newSrc);img.setAttribute("alt",newAlt);figcaption.innerText=newCaption}else{_this.addImageWithCaption({src:newSrc,alt:newAlt,caption:newCaption})}panel.close()}}}).render()}addImageWithCaption({src:src,alt:alt="",caption:caption=""}){if(!src)return;const index=this.currentSelectionIndex||0;this.richTextField.insertEmbed(index,"imagefigure",{src:src,alt:alt,caption:caption});this.richTextField.setSelection(index+1)}};customElements.define("a-richtextfield",kiss.ux.RichTextField);const createRichTextField=config=>document.createElement("a-richtextfield").init(config);kiss.ux.CodeEditor=class CodeEditor extends kiss.ui.Component{constructor(){super()}init(config){super.init(config);this.useCDN=config.useCDN===false&&!kiss.session.isOffline()?false:true;this.innerHTML=`\n            ${config.label?`<label id="field-label-${this.id}" for="${this.id}" class="field-label">\n                ${this.isLocked()?this.locker:""}\n                ${config.label||""}\n                ${this.isRequired()?this.asterisk:""}\n            </label>`:""}\n\n            <div id="editor-for:${this.id}" class="code-editor"></div>\n            `.removeExtraSpaces();this.label=this.querySelector(".field-label");this.field=this.querySelector(".code-editor");this._setProperties(config,[[["draggable"],[this]],[["width","minWidth","height","flex","display","margin"],[this.style]],[["fieldWidth=width","fieldHeight=height","maxHeight","fieldFlex=flex","boxShadow","border","borderStyle","borderWidth","borderColor","borderRadius"],[this.field.style]],[["labelAlign=textAlign","labelFlex=flex","labelFontSize=fontSize","labelFontWeight=fontWeight","labelColor=color"],[this.label?.style]]]);this.displayMode="flex";this.style.flexFlow="row";this.field.style.display="none";if(config.label){if(config.labelWidth)this.setLabelWidth(config.labelWidth);this.config.labelPosition=config.labelPosition||"left";this.setLabelPosition(config.labelPosition)}return this}async _initCodeEditor(){if(this.useCDN===false){await kiss.loader.loadScript("../../kissjs/client/ux/codeEditor/ace")}else{await kiss.loader.loadScript("https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.0/ace")}}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;if(record[this.id]){this.initialValue=record[this.id];this.editor.setValue(this.initialValue)}this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+this.modelId.toUpperCase(),(msgData=>{if(msgData.modelId==this.modelId&&msgData.id==this.recordId){const updates=msgData.data;this._updateField(updates)}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==this.modelId&&operation.recordId==this.recordId){const updates=operation.updates;this._updateField(updates)}}))})));return this}_updateField(updates){if(this.id in updates){const newValue=updates[this.id];if(newValue||newValue===0||newValue===""){this.editor.setValue(newValue)}}}async _afterRender(){if(!window.ace){await this._initCodeEditor()}this.editor=ace.edit("editor-for:"+this.id,{selectionStyle:"text"});this.editor.setOptions({autoScrollEditorIntoView:true,copyWithEmptySelection:false,showPrintMargin:false,fontSize:"var(--field-font-size)",showFoldWidgets:false});this.editor.renderer.setShowGutter(this.config.showMargin==false?false:true);this.editor.session.setMode("ace/mode/javascript");this.editor.setTheme("ace/theme/monokai");this.editor.session.setUseWorker(false);this.editor.on("focus",(()=>{this.previousValue=this.editor.getValue();this.dispatchEvent(new Event("focus"))}));this.editor.on("blur",(()=>{const newValue=this.editor.getValue();if(newValue!=this.previousValue)this.hasChanged=true;else this.hasChanged=false;this.dispatchEvent(new Event("blur"))}));this.editor.session.on("change",(()=>{this.dispatchEvent(new Event("change"))}));if(this.config.record){this._bindRecord(this.config.record)}else if(this.config.value){this.editor.setValue(this.config.value)}if(this.config.hideHorizontalScrollbar==true){this.classList.add("no-scrollbar-h")}if(this.config.hideVerticalScrollbar==true){this.classList.add("no-scrollbar-v")}this.field.style.display="block";setTimeout((()=>{this.editor.resize()}),50)}async setValue(newValue,fromBlurEvent){await kiss.tools.waitUntil((()=>this.editor),50,5e3);if(this.record){this.record.updateFieldDeep(this.id,newValue).then((success=>{if(!success)this.editor.setValue(this.initialValue||"")}))}else{if(!fromBlurEvent){this.editor.setValue(newValue)}}return this}getValue(){if(!this.editor)return"";return this.editor.getValue()}validate(){return true}insert(text){const cursorPosition=this.editor.getCursorPosition();this.editor.session.insert(cursorPosition,text);this.editor.focus();return this}focus(){this.editor.focus();return this}blur(){this.editor.blur();return this}clearSelection(){this.editor.clearSelection();return this}setLabel(newLabel){if(!this.label)return;this.config.label=newLabel;this.label.innerText=newLabel;return this}getLabel(){return this?.label?.innerText||""}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width",width);return this}setFieldWidth(width){this.config.fieldWidth=width;this.field.style.width=this._computeSize("fieldWidth",width);return this}setLabelWidth(width){this.config.labelWidth=width;this.label.style.width=this.label.style.maxWidth=this._computeSize("labelWidth",width);return this}getLabelPosition(){return this.config.labelPosition}setLabelPosition(position){this.config.labelPosition=position;switch(position){case"top":this.style.flexFlow="column";this.field.style.order=1;break;case"bottom":this.style.flexFlow="column";this.field.style.order=-1;break;case"right":this.style.flexFlow="row";this.field.style.order=-1;break;default:this.style.flexFlow="row";this.field.style.order=1}return this}};customElements.define("a-codeeditor",kiss.ux.CodeEditor);const createCodeEditor=config=>document.createElement("a-codeeditor").init(config);kiss.ux.AiTextarea=class AiTextarea extends kiss.ui.Field{constructor(){super()}init(config={}){config.type="aiTextarea";super.init(config);this.label.appendChild(this._createAIButton());return this}_createAIButton(){const color=this.config.iconColorOn||"#00aaee";let lastParams=localStorage.getItem("config-ai-paragraph")||"{}";lastParams=JSON.parse(lastParams);return createButton({icon:"far fa-lightbulb",iconSize:"1.6rem",iconColor:color,height:"1.7rem",margin:"0 0 0 0.5rem",padding:"0.2rem 0",borderWidth:0,boxShadow:"none",iconColorHover:"#ffffff",backgroundColorHover:color,action:event=>{event.stop();createPanel({id:"AI-panel",title:txtTitleCase("your AI assistant"),icon:"far fa-lightbulb",headerBackgroundColor:color,modal:true,closable:true,draggable:true,width:"50rem",align:"center",verticalAlign:"center",events:{close:forceClose=>{if(forceClose)return true;if($("prompt").getValue()!=""){createDialog({type:"danger",message:txtTitleCase("are you sure you want to cancel your input?"),buttonOKPosition:"left",action:()=>$("AI-panel").close("remove",true)});return false}}},defaultConfig:{labelPosition:"top",width:"100%"},items:[{layout:"horizontal",defaultConfig:{flex:1,labelPosition:"top"},items:[{id:"who",type:"select",label:txtTitleCase("AI profile"),value:this.config?.ai?.who||lastParams.who||"-",allowValuesNotInList:true,options:[{label:txtTitleCase("no profile"),value:"-",color:"var(--green)"},{label:txtTitleCase("sales rep"),value:"sales manager",color:"var(--red)"},{label:txtTitleCase("HR manager"),value:"hr manager",color:"var(--purple)"},{label:txtTitleCase("marketing manager"),value:"marketing manager",color:"var(--blue)"},{label:txtTitleCase("product manager"),value:"product manager",color:"var(--orange)"}]},{id:"what",type:"select",label:txtTitleCase("task"),value:this.config?.ai?.what||lastParams.what||"-",allowValuesNotInList:true,options:[{label:txtTitleCase("free"),value:"-",color:"var(--green)"},{label:txtTitleCase("draft a blog post"),value:"draft a blog post"},{label:txtTitleCase("summup a text"),value:"summup a text"},{label:txtTitleCase("convert to Tweet"),value:"convert to Tweet"},{label:txtTitleCase("write an email"),value:"write an email"},{label:txtTitleCase("create user persona"),value:"create user persona"},{label:txtTitleCase("create job description"),value:"create job description"}]}]},{layout:"horizontal",defaultConfig:{flex:1,labelPosition:"top"},items:[{id:"tone",type:"select",label:txtTitleCase("tone to use"),value:this.config?.ai?.tone||lastParams.tone||"casual",allowValuesNotInList:true,options:[{label:txtTitleCase("casual"),value:"casual",color:"var(--green)"},{label:txtTitleCase("formal"),value:"formal",color:"var(--orange)"},{label:txtTitleCase("humour"),value:"humour",color:"var(--red)"},{label:txtTitleCase("ironic"),value:"ironic",color:"var(--purple)"}]},{id:"goal",type:"select",label:txtTitleCase("goal"),value:this.config?.ai?.goal||lastParams.goal||"-",allowValuesNotInList:true,options:[{label:txtTitleCase("none"),value:"-",color:"var(--green)"},{label:txtTitleCase("inform"),value:"inform",color:"var(--blue)"},{label:txtTitleCase("persuade"),value:"persuade",color:"var(--purple)"},{label:txtTitleCase("inspire"),value:"inspire",color:"var(--red)"}]}]},{layout:"horizontal",defaultConfig:{flex:1,labelPosition:"top"},items:[{id:"max_tokens",label:txtTitleCase("response max length"),type:"number",value:Math.min(this.config?.ai?.max_tokens||lastParams.max_tokens||1e3,2e3)||1e3,max:2e3},{id:"temperature",label:txtTitleCase("creativity"),type:"slider",min:0,max:100,value:this.config?.ai?.temperature||lastParams.temperature||50}]},{id:"prompt",type:"textarea",label:txtTitleCase("#AI prompt instructions"),required:true,value:lastParams.prompt||"",rows:10},{type:"button",text:txtTitleCase("generate content..."),icon:"fas fa-bolt",iconColor:"var(--orange)",margin:"2rem 0 0 0",height:"4rem",action:async()=>{if(kiss.session.isOffline()){return kiss.tools.featureNotAvailable()}if(!$("AI-panel").validate()){return}localStorage.setItem("config-ai-paragraph",JSON.stringify($("AI-panel").getData()));const data=$("AI-panel").getData();const prompt=this._preparePrompt(data);const temperature=Number((data.temperature/100).toFixed(2));const result=await this._executePrompt(prompt,temperature,data.max_tokens);if(!result.success){createDialog({type:"danger",message:txtTitleCase("#openAI error"),noCancel:true});return}await this.setValue(result.data);$("AI-panel").close("remove",true)}}]}).setAnimation({name:"jackInTheBox",speed:"fast"}).render()}})}_preparePrompt({who:who,what:what,tone:tone,goal:goal,prompt:prompt}){const language=kiss.language.current=="fr"?"french":"english";let instructions="";if(who!="-")instructions+=`You are a ${who}. `;if(goal!="-")instructions+=`The goal is to ${goal} the reader. `;if(tone!="-")instructions+=`The tone must be ${tone}. `;if(what!="-")instructions+=`You have to ${what}. `;instructions+=`Your answer must be in ${language}. `;instructions+=`Data to process using previous requirements: ${prompt}`;return instructions}async _executePrompt(prompt,temperature=.5,max_tokens=2e3){return await kiss.ajax.request({url:"/command/openai/createCompletion",method:"post",showLoading:true,timeout:3*60*1e3,body:JSON.stringify({prompt:prompt,temperature:temperature,max_tokens:max_tokens})})}};customElements.define("a-aitextarea",kiss.ux.AiTextarea);const createAiTextareaField=config=>document.createElement("a-aitextarea").init(config);kiss.ux.AiImage=class AiImage extends kiss.ui.Attachment{constructor(){super()}init(config={}){config.type="aiImage";config.buttonText=txtTitleCase("generate an image");super.init(config);return this}_initClickEvent(){this.onclick=function(event){if(event.target.classList.contains("field-upload-button")){this.showPromptWindow()}else if(event.target.classList.contains("display-as-list")){this.renderAs("list")}else if(event.target.classList.contains("display-as-thumbnails")){this.renderAs("thumbnails")}else if(event.target.classList.contains("display-as-thumbnails-large")){this.renderAs("thumbnails-large")}}}showPromptWindow(){const localStorageId="config-ai-image-prompt-"+this.id;createPanel({id:"AI-panel",title:txtTitleCase("#image generator"),icon:"fas fa-images",modal:true,closable:true,draggable:true,width:"50rem",align:"center",verticalAlign:"center",events:{close:forceClose=>{if(forceClose)return true;if($("prompt").getValue()!=""){createDialog({type:"danger",message:txtTitleCase("are you sure you want to cancel your input?"),buttonOKPosition:"left",action:()=>$("AI-panel").close("remove",true)});return false}}},defaultConfig:{labelPosition:"top",width:"100%"},items:[{id:"size",type:"select",label:txtTitleCase("image format"),value:"1792x1024",allowValuesNotInList:true,options:[{value:"1024x1024",label:txtTitleCase("square")},{value:"1792x1024",label:txtTitleCase("landscape")},{value:"1024x1792",label:txtTitleCase("portrait")}]},{id:"prompt",type:"textarea",label:txtTitleCase("#AI image instructions"),required:true,rows:10,value:localStorage.getItem(localStorageId)},{type:"button",text:txtTitleCase("generate image..."),icon:"fas fa-bolt",iconColor:"var(--orange)",margin:"2rem 0 0 0",height:"4rem",action:async()=>{if(kiss.session.isOffline()){return kiss.tools.featureNotAvailable()}if(!$("AI-panel").validate()){return}const data=$("AI-panel").getData();const result=await this._executePrompt({prompt:data.prompt,size:data.size});localStorage.setItem(localStorageId,data.prompt);if(!result.success){createDialog({type:"danger",message:txtTitleCase("#openAI error"),noCancel:true});return}$("AI-panel").close("remove",true)}}]}).setAnimation({name:"jackInTheBox",speed:"fast"}).render()}async _executePrompt({prompt:prompt,size:size}){return await kiss.ajax.request({url:"/command/openai/createImageToField",method:"post",showLoading:true,timeout:3*60*1e3,body:JSON.stringify({modelId:this.record.model.id,recordId:this.record.id,fieldId:this.id,prompt:prompt,size:size})})}};customElements.define("a-aiimage",kiss.ux.AiImage);const createAiImageField=config=>document.createElement("a-aiimage").init(config);kiss.ux.Map=class Map extends kiss.ui.Component{constructor(){super()}init(config={}){config.width=config.width||300;config.height=config.height||225;this.zoom=config.zoom||10;this.longitude=config.longitude;this.latitude=config.latitude;this.address=config.address;this.markers=config.markers||[];this.showMarker=config.showMarker===false?false:true;this.canSelectLayer=config.canSelectLayer===false?false:true;this.useCDN=config.useCDN===false?false:true;this.clickCallBack=config.clickCallback||null;super.init(config);this._setProperties(config,[[["display","flex","position","top","left","width","height","margin","padding","background","backgroundColor","borderColor","borderRadius","borderStyle","borderWidth","boxShadow"],[this.style]]]);return this}async _afterRender(){if(window.ol){this._initMap()}else{await this._initOpenLayers();this._initMap()}}async _initOpenLayers(){if(this.useCDN===false){await kiss.loader.loadScript("../../kissjs/client/ux/map/map_ol");await kiss.loader.loadStyle("../../kissjs/client/ux/map/map_ol")}else{await kiss.loader.loadScript("https://cdn.jsdelivr.net/npm/ol@v10.0.0/dist/ol");await kiss.loader.loadStyle("https://cdn.jsdelivr.net/npm/ol@v10.0.0/ol")}}_initMap(){this.map=new ol.Map({layers:[new ol.layer.Tile({source:new ol.source.OSM}),new ol.layer.Tile({visible:false,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"})})],view:new ol.View({zoom:this.zoom})});this.map.setTarget(this.id);this._initIconStyle();if(this.longitude&&this.latitude){this.setGeolocation({longitude:this.longitude,latitude:this.latitude})}else if(this.address){this.setAddress(this.address)}else if(this.markers.length>0){const firstMarker=this.markers[0];this.showMarker=false;this.setGeolocation({longitude:firstMarker.longitude,latitude:firstMarker.latitude});this.addMarkers(this.markers)}this._observeBoundingBox();this.clicked;this.map.on("click",(evt=>{const coordinate=evt.coordinate;const lonLat=ol.proj.toLonLat(coordinate);this.clicked={longitude:lonLat[0],latitude:lonLat[1]};console.log("kiss.ux - Map clicked at:",this.clicked);this.map.forEachFeatureAtPixel(evt.pixel,(feature=>{if(this.clickCallBack){this.clickCallBack(feature,this.clicked)}}))}));if(this.canSelectLayer)this._addLayerSelectionButton()}_addLayerSelectionButton(){setTimeout((()=>{const buttonSelectLayer=createButton({class:"mapview-button",width:"2rem",height:"2rem",icon:"fas fa-map",iconSize:"0.9rem",action:()=>this.selectMapLayer()}).render();this.map.getViewport().appendChild(buttonSelectLayer)}),500)}selectMapLayer(){const _this=this;createPanel({title:txtTitleCase("select map layer"),draggable:true,modal:true,align:"center",verticalAlign:"center",layout:"vertical",animation:{name:"zoomIn",speed:"faster"},defaultConfig:{type:"button",margin:"0.5rem"},items:[{text:txtTitleCase("default map"),action:()=>_this.switchToDefaultView(),icon:"far fa-map"},{text:txtTitleCase("satellite view"),icon:"fas fa-space-shuttle",action:()=>_this.switchToSatteliteView()}]}).render()}switchToSatteliteView(){this.map.getLayers().forEach((layer=>{if(layer.getSource()instanceof ol.source.OSM){layer.setVisible(false)}else if(layer.getSource()instanceof ol.source.XYZ){layer.setVisible(true)}}))}switchToDefaultView(){this.map.getLayers().forEach((layer=>{if(layer.getSource()instanceof ol.source.OSM){layer.setVisible(true)}else if(layer.getSource()instanceof ol.source.XYZ){layer.setVisible(false)}}))}async setAddress(address){const geoloc=await kiss.tools.getGeolocationFromAddress(address);if(!geoloc)return;this.longitude=geoloc.longitude;this.latitude=geoloc.latitude;this.setGeolocation({longitude:this.longitude,latitude:this.latitude});return{longitude:this.longitude,latitude:this.latitude}}setGeolocation(geoloc){try{this.longitude=geoloc.longitude;this.latitude=geoloc.latitude;const newLonLat=[this.longitude,this.latitude];const newCenter=ol.proj.fromLonLat(newLonLat);this.map.getView().setCenter(newCenter);if(this.showMarker)this.addGeoMarker(this.longitude,this.latitude);return this}catch(err){return this}}async addGeoMarker(longitude,latitude){await this._waitForMap();const position=ol.proj.fromLonLat([longitude,latitude]);const iconFeature=new ol.Feature({geometry:new ol.geom.Point(position)});iconFeature.setStyle(this.iconStyle);const vectorLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[iconFeature]})});this.map.addLayer(vectorLayer);return this}async addMarkers(markers=[]){await this._waitForMap();const features=markers.map((marker=>{const coord=ol.proj.fromLonLat([marker.longitude,marker.latitude]);const feature=new ol.Feature({geometry:new ol.geom.Point(coord)});if(marker.label){feature.setStyle([this.iconStyle,this._getMarkerLabel(marker.label)]);if(marker.recordId){feature.set("recordId",marker.recordId)}}else{feature.setStyle(this.iconStyle)}return feature}));this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:features})});this.map.addLayer(this.markerLayer);return this}updateMarkers(markers=[]){if(this.markerLayer){this.map.removeLayer(this.markerLayer)}this.addMarkers(markers);return this}setZoom(zoom){this.zoom=zoom;this.map.getView().setZoom(zoom);return this}setWidth(width){this.style.width=width;return this}setHeight(height){this.style.height=height;return this}async getBounds(){await this._waitForMap();const extent=this.map.getView().calculateExtent(this.map.getSize());const bounds=ol.proj.transformExtent(extent,"EPSG:3857","EPSG:4326");this.boundingBox={minLongitude:bounds[0],minLatitude:bounds[1],maxLongitude:bounds[2],maxLatitude:bounds[3]};return this.boundingBox}_initIconStyle(){this.iconStyle=new ol.style.Style({text:new ol.style.Text({font:'900 24px "Font Awesome 5 Free"',text:"",fill:new ol.style.Fill({color:"#ff0000"}),offsetY:-12})})}_getMarkerLabel(label){return new ol.style.Style({text:new ol.style.Text({font:"14px sans-serif",text:label||"",fill:new ol.style.Fill({color:"#ffffff"}),stroke:new ol.style.Stroke({color:"#000000",width:2}),offsetY:-30,textAlign:"center"})})}_observeBoundingBox(){this.map.on("moveend",(async()=>{await this.getBounds();kiss.pubsub.publish("EVT_MAP_BOUNDS_CHANGED",{mapId:this.id,boundingBox:this.boundingBox})}))}async _waitForMap(){await kiss.tools.waitUntil((()=>this.map!==undefined),100,5e3)}};customElements.define("a-map",kiss.ux.Map);const createMap=config=>document.createElement("a-map").init(config);kiss.ux.MapField=class MapField extends kiss.ui.Field{constructor(){super()}init(config={}){config.type="mapField";config.autoSize=true;super.init(config);this.style.flexFlow="row wrap";this._observeKeys();return this}async _afterRender(){await this._createMap();if(this.config.mapRatio&&!this.config.mapHeight){this._adjustMapRatio()}if(this.config.value){this._setMapValue(this.config.value)}this._addExpandButton()}async _createMap(){let zoom=this.config.zoom||10;if(zoom>19)zoom=19;if(zoom<1)zoom=1;this.map=createMap({zoom:this.config.zoom,width:this.config.width,height:this.config.mapHeight});this.map.style.order=2;this.map.style.flex="1 1 100%";this.appendChild(this.map);this.map.render()}_waitForOpenLayers(maxAttempts=50){let attempts=0;return new Promise(((resolve,reject)=>{function checkOpenLayers(){if(typeof ol!=="undefined"){resolve()}else if(attempts<maxAttempts){attempts++;setTimeout(checkOpenLayers,100)}else{reject(new Error("Could not load openLayers library"))}}checkOpenLayers()}))}_adjustMapRatio(){this.mapRatio=this.config.mapRatio;if(typeof this.mapRatio=="string"){const mapRatio=eval(this.mapRatio);this.mapRatio=isNaN(mapRatio)?4/3:mapRatio}setTimeout((()=>{const width=this.getBoundingClientRect().width;this.map.setHeight(width/this.mapRatio+"px")}),50)}_updateField(updates){if(this.id in updates){const newValue=updates[this.id];if(newValue||newValue===0||newValue===""){this.field.value=newValue;this._setMapValue(newValue)}}}_addExpandButton(){setTimeout((()=>{const fieldMap=this.map;const mapExpandButton=document.createElement("button");mapExpandButton.innerHTML="⛶";mapExpandButton.classList.add("a-mapfield-button");fieldMap.map.getViewport().appendChild(mapExpandButton);mapExpandButton.onclick=()=>this.expandMap()}),500)}_observeKeys(){const _this=this;this.field.onkeydown=function(e){if(e.key==="Enter"){_this._setMapValue(_this.field.value)}}}_setMapValue(input){const geoloc=kiss.tools.isGeolocation(input);if(geoloc){this.map.setGeolocation(geoloc)}else{this.map.setAddress(input)}}expandMap(){let map=createMap({width:"100%",height:"100%",longitude:this.map.longitude,latitude:this.map.latitude,zoom:this.map.zoom});createPanel({title:this.config.label,closable:true,position:"absolute",top:0,left:0,padding:0,width:"100%",height:"100%",items:[map]}).render();return this}setAddress(address){this.map.setAddress(address)}setGeolocation(geoloc){this.map.setGeolocation(geoloc)}};customElements.define("a-mapfield",kiss.ux.MapField);const createMapField=config=>document.createElement("a-mapfield").init(config);kiss.ux.QrCode=class QrCode extends kiss.ui.Component{constructor(){super()}init(config={}){super.init(config);this.innerHTML=`<div class="qrcode-image"></div>`;this.QRCodeImage=this.querySelector(".qrcode-image");this.style.display="inline-block";this._setProperties(config,[[["width","height"],[this.style]]]);return this}async _afterRender(){if(!window.QRCode){await kiss.loader.loadScript("../../kissjs/client/ux/qrcode/qrcode.lib")}const correctLevels={L:1,M:0,Q:3,H:2};new QRCode(this.QRCodeImage,{text:this.config.text,width:this.config.width||"100",height:this.config.height||"100",correctLevel:correctLevels[this.config.correctLevel]||0})}};customElements.define("a-qrcode",kiss.ux.QrCode);const createQRCode=config=>document.createElement("a-qrcode").init(config);kiss.ux.Chart=class UxChart extends kiss.ui.Component{constructor(){super()}init(config={}){config.type="chart";config.width=config.width||"30rem";config.height=config.height||"22.5rem";this.chartType=config.chartType;this.data=config.data;this.options=config.options;this.plugins=config.plugins||[];this.useCDN=config.useCDN===false&&!kiss.session.isOffline()?false:true;this.useDataLabels=config.useDataLabels||false;this.useMoment=config.useMoment||false;super.init(config);this.innerHTML=`<canvas id="chart-${this.id}"></canvas>`;this.chartContainer=this.querySelector("canvas");this.style.display="flex";this.style.alignItems="center";this.style.justifyContent="center";this.style.overflow="hidden";this.chartContainer.style.flex=1;this._setProperties(config,[[["flex","position","top","left","width","height","margin","padding","background","backgroundColor","borderColor","borderRadius","borderStyle","borderWidth","boxShadow"],[this.style]]]);return this}async _afterRender(){await this._initChartJS({useDataLabels:this.useDataLabels,useMoment:this.useMoment});this._initChart()}async _initChartJS({useDataLabels:useDataLabels,useMoment:useMoment}={}){await this._initChartJSCore();if(useDataLabels)await this._initDataLabels();if(useMoment)await this._initMoment()}async _initChartJSCore(){if(window.Chart)return;if(this.useCDN===false){await kiss.loader.loadScript("../../kissjs/client/ux/chart/chartjs")}else{await kiss.loader.loadScript("https://cdn.jsdelivr.net/npm/chart")}}async _initDataLabels(){if(typeof ChartDataLabels!=="undefined")return;if(this.useCDN===false){await kiss.loader.loadScript("../../kissjs/client/ux/chart/chartjs-plugin-datalabels")}else{await kiss.loader.loadScript("https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels",{autoAddExtension:false})}Chart.register(ChartDataLabels)}async _initMoment(){if(window.moment)return;if(this.useCDN===false){await kiss.loader.loadScript("../../kissjs/client/ux/chart/chartjs-moment");await kiss.loader.loadScript("../../kissjs/client/ux/chart/chartjs-moment-adapter")}else{await kiss.loader.loadScript("https://cdn.jsdelivr.net/npm/moment/min/moment-with-locales.min");await kiss.loader.loadScript("https://cdn.jsdelivr.net/npm/chartjs-adapter-moment",{autoAddExtension:false})}window.moment.locale(kiss.language.current||"en")}_initChart(){this.chart=new Chart(this.chartContainer,{type:this.chartType,data:this.data,options:this.options,plugins:this.plugins})}async refresh({chartType:chartType,data:data,options:options,useDataLabels:useDataLabels,useMoment:useMoment,width:width,height:height}){if(!this.chart)return;this.setWidth(width);this.setHeight(height);const shouldRegenerate=chartType!=this.chartType||useDataLabels!=this.useDataLabels;if(shouldRegenerate){this.chart.destroy();this.chartType=chartType;await this._initChartJS({useDataLabels:useDataLabels,useMoment:useMoment});this.chart=new Chart(this.chartContainer,{type:this.chartType,data:data,options:options,plugins:this.plugins})}else{Object.assign(this.chart.data,data);Object.assign(this.chart.options,options);this.chart.update()}}destroy(){this.chart.destroy()}update(){this.chart.update()}reset(){this.chart.reset()}resize(width,height){this.style.width=width+"px";this.style.height=height+"px"}toBase64Image(type,quality){return this.chart.toBase64Image(type,quality)}downloadBase64Image({type:type,quality:quality,filename:filename}={}){const link=document.createElement("a");link.href=this.toBase64Image(type||"image/jpg",quality||1);link.download=filename||"chart.jpg";document.body.appendChild(link);link.click();document.body.removeChild(link)}setWidth(width){this.config.width=width;this.style.width=this._computeSize("width");return this}setHeight(height){this.config.height=height;this.style.height=this._computeSize("height");return this}};customElements.define("a-chart",kiss.ux.Chart);const createChart=config=>document.createElement("a-chart").init(config);kiss.ux.Directory=class Directory extends kiss.ui.Select{constructor(){super()}init(config={}){config.multiple=!!config.multiple;config.optionRenderer=this.optionRenderer;config.allowDuplicates=false;config.allowClickToDelete=true;config.maxHeight=kiss.screen.isMobile?"calc(100% - 3.2rem)":"42rem";this.showUsers=config.users!==false;this.showGroups=config.groups!==false;this.showRoles=Array.isArray(config.roles)&&config.roles.length>0;this.showApiClients=config.apiClients===true;this.roles=config.roles||[];this.types={user:"fas fa-user directory-user-icon",group:"fas fa-user-friends directory-group-icon",role:"fas fa-key directory-role-icon",api:"fas fa-plug directory-role-icon"};this.displayAsCards=config.displayAsCards;this.nameOrder=config.nameOrder||"lastName";this.sortBy=config.sortBy||"lastName";this.sortOrder=config.sortOrder||"asc";this.readOnly=!!config.readOnly||!!config.computed;super.init(config);if(!this.readOnly){this.onclick=function(event){event.stop();const classes=event.target.classList;if(classes.contains("field-select-value-delete"))return this._deleteValueByClick(event);else if(classes.contains("field-select-value"))return this._showOptions();else if(classes.contains("field-select-values"))return this._showOptions();else if(classes.contains("field-select"))return this._showOptions();else if(classes.contains("field-select-input"))return this._showOptions();else if(classes.contains("directory-item-initials"))return this._showOptions();else if(classes.contains("directory-item-title"))return this._showOptions();else if(classes.contains("directory-item-subtitle"))return this._showOptions();else if(classes.contains("field-option"))return this._selectOption(event)}}return this}_renderValues(){this._loadOptions();let isEmpty=false;if(this.multiple){if(this.value&&Array.isArray(this.value)&&this.value.length==0)isEmpty=true}else{if(this.value===undefined||this.value==="")isEmpty=true}if(isEmpty){this.fieldValues.innerHTML="";this._adjustSizeAndPosition();return}let renderer=this.displayAsCards?this._renderValueAsCard.bind(this):this._renderValue.bind(this);let htmlSeparator=this.stackValues?"<br>":"";this.fieldValues.innerHTML=[].concat(this.value).filter((value=>value!=""&&value!=undefined&&value!=null)).map((value=>{let option=this.options.find((option=>option.value==value));if(option)return renderer(option);if(this.allowValuesNotInList)return renderer({label:value,value:value})})).join(htmlSeparator);this._adjustSizeAndPosition()}_renderValue(option){return`\n            <div class="field-select-value" value="${option.value}" ${option.color||this.optionsColor?`style="background: ${option.color||this.optionsColor}"`:""}>\n                ${option.label||option.value}\n                ${this.allowClickToDelete==true?`<span class="field-select-value-delete fas fa-times"></span>`:""}\n            </div>\n        `.removeExtraSpaces()}_renderValueAsCard(option){let initials=kiss.directory.getUserInitials(option);let userColor=kiss.directory.getEntryColor(option.value);return`\n            <div class="field-select-value directory-item" value="${option.value}">\n                <span class="directory-item-initials" style="background: ${userColor}">${initials}</span>\n                <div class="directory-item-infos">\n                    <span class="directory-item-title">${option.label}</span>\n                    <span class="directory-item-subtitle">${option.value}</span>\n                </div>\n                ${this.allowClickToDelete==true?`<span class="field-select-value-delete fas fa-times"></span>`:""}\n            </div>\n        `.removeExtraSpaces()}async _createOptions(){await this._loadOptions();super._createOptions()}_loadOptions(){if(this.isLoaded)return;this.options=[];if(this.showRoles){kiss.directory._initRoles();this.options=this.options.concat(this.roles.map((roleId=>kiss.directory.roles[roleId])))}if(this.showUsers!=false)this.options=this.options.concat(this.getUsers());if(this.showGroups==true)this.options=this.options.concat(this.getGroups());if(this.showApiClients==true)this.options=this.options.concat(this.getApiClients());this.isLoaded=true}getUsers(){return kiss.directory.getUsers({sortBy:this.sortBy,sortOrder:this.sortOrder,nameOrder:this.nameOrder,onlyActiveUsers:true}).map((user=>({type:"user",label:user.name,firstName:user.firstName,lastName:user.lastName,value:user.email})))}getGroups(){return kiss.directory.getGroups(this.sortOrder).map((group=>({type:"group",label:group.name,value:group.id})))}getApiClients(){return kiss.directory.getApiClients().map((client=>({type:"api",label:client.name,value:client.id})))}optionRenderer(option){return`<span class="${this.types[option.type]} field-option-icon" style="color: #00aaee"></span>${option.label}`}};customElements.define("a-directory",kiss.ux.Directory);const createDirectory=config=>document.createElement("a-directory").init(config);kiss.ux.Link=class Link extends kiss.ui.Select{constructor(){super()}init(config={}){this.readOnly=!!config.readOnly;this.canCreateRecord=config.canCreateRecord;this.canLinkRecord=config.canLinkRecord;this.canDeleteLinks=config.canDeleteLinks;this.foreignModel=kiss.app.models[config.link.modelId];this.foreignCollection=this.foreignModel?.collection||{};this.sort=[];this.linkModel=kiss.app.models.link;this.linkCollection=this.linkModel.collection;super.init(config);this.onclick=this._handleClick;this._showOptions=()=>{};return this}_handleClick(event){const classes=event.target.classList;if(classes.contains("field-link-value-delete")){if(!this.readOnly){const fieldValueElement=event.target.closest("div");const linkId=fieldValueElement.getAttribute("linkId");return this._deleteLink(linkId)}}const item=event.target.closest(".field-link-value");if(item){const clickedItem=event.target.closest(".field-link-value");const recordId=clickedItem.getAttribute("recordId");return this._openRecord(recordId)}const button=event.target.closest(".a-button");if(button){if(button.classList.contains("field-link-button-link"))return this._linkForeignRecords();if(button.classList.contains("field-link-button-add"))return this._createAndLink();if(button.classList.contains("field-link-button-expand"))return this._showForeignRecords()}if(event.target.closest(".field-link-buttons")&&this.canLinkRecord&&!this.readOnly){this._linkForeignRecords()}}_bindRecord(record){this.record=record;this.modelId=record.model.id;this.recordId=record.id;const foreignModelId=this.foreignModel.id;this.subscriptions.push(subscribe("EVT_DB_UPDATE:"+foreignModelId.toUpperCase(),(msgData=>{if(msgData.modelId==foreignModelId){const recordIds=this.links.map((link=>link.recordId));if(recordIds.includes(msgData.id)){this._renderValues()}}})));this.subscriptions.push(subscribe("EVT_DB_DELETE:"+foreignModelId.toUpperCase(),(msgData=>{if(msgData.modelId==foreignModelId){const recordIds=this.links.map((link=>link.recordId));if(recordIds.includes(msgData.id)){this._renderValues()}}})));this.subscriptions.push(subscribe("EVT_DB_UPDATE_BULK",(msgData=>{let shouldUpdate=false;const recordIds=this.links.map((link=>link.recordId));const operations=msgData.data;operations.forEach((operation=>{if(operation.modelId==foreignModelId&&recordIds.includes(operation.recordId))shouldUpdate=true}));if(shouldUpdate){this._renderValues()}})));this.subscriptions.push(subscribe("EVT_DB_INSERT:LINK",(msgData=>{if(msgData.data.rX==this.record.id||msgData.data.rY==this.record.id){this._renderValues()}})));this.subscriptions.push(subscribe("EVT_DB_DELETE:LINK",(msgData=>{const recordIds=this.links.map((link=>link.linkId));if(recordIds.includes(msgData.id)){this._renderValues()}})));return this}getValue(){return this.links||[]}async _createAndLink(){if(!this.multiple&&this.links.length>0){return createNotification(txtTitleCase("#only one link"))}let newForeignRecordData={};let newForeignRecord;if(!this.config.inherit){newForeignRecord=this.foreignModel.create()}else{const model=kiss.app.models[this.modelId];const sharedFields=model.fields.filter((fX=>this.foreignModel.fields.find((fY=>fX.label==fY.label&&!fX.deleted&&!fY.deleted&&!fX.isSystem&&!fX.isFromPlugin))));sharedFields.forEach((field=>{const foreignField=this.foreignModel.getFieldByLabel(field.label);newForeignRecordData[foreignField.id]=this.record[field.id]}));newForeignRecord=this.foreignModel.create(newForeignRecordData,true)}await newForeignRecord.save();createForm(newForeignRecord);await this.record.linkTo(newForeignRecord,this.id,this.config.link.fieldId);this._renderValues()}async _deleteLink(linkId){createDialog({title:txtTitleCase("delete a link"),type:"dialog",message:txtTitleCase("#delete link"),colorOK:"var(--red)",colorCancel:"var(--green)",action:async()=>{const success=await this.record.deleteLink(linkId);if(!success)return;this._renderValues();this.dispatchEvent(new Event("change"))}})}async _openRecord(recordId){const link=this.links.find((linkInfo=>linkInfo.record.id==recordId));const record=this.foreignModel.create(link.record);createForm(record)}async _showForeignRecords(){const foreignRecords=this.links.map((link=>link.record));createRecordSelectionWindow(this.foreignModel,this.id,foreignRecords,null,{canSelect:false})}async _linkRecord(record){if(record.id==kiss.context.record.id)return;createDialog({title:txtTitleCase("#connect records"),message:txtTitleCase("#connect confirmation"),icon:"fas fa-link",action:async()=>{const linkField=$(this.config.fieldId);const success=await linkField._addLink(record);if(!success)return createNotification(txtTitleCase("#record already linked"));linkField.setValid();this.closest("a-panel").close()}})}async _linkForeignRecords(){if(!this.multiple&&this.links.length>0){return createNotification(txtTitleCase("#only one link"))}createRecordSelectionWindow(this.foreignModel,this.id,null,this._linkRecord,{iconAction:"fas fa-link",canSelect:false})}async _addLink(foreignRecord){if(this.links.map((link=>link.recordId)).includes(foreignRecord.id))return false;await this.record.linkTo(foreignRecord,this.id,this.config.link.fieldId);this._renderValues();this.dispatchEvent(new Event("change"));return true}_getViewConfig(){const viewRecord=kiss.app.collections.view.records.find((view=>view.modelId==this.foreignModel.id&&view.fieldId==this.id));if(viewRecord&&!this.viewId){this.viewId=viewRecord.id;this.subscriptions.push(kiss.pubsub.subscribe("EVT_DB_UPDATE:VIEW",(msgData=>{if(msgData.id!=this.viewId)return;if(msgData.data.sort)this._renderValues();if(msgData.data.config&&msgData.data.config.columns)this._renderValues()})))}this.sort=viewRecord?viewRecord.sort:this.sort;return viewRecord?viewRecord.config.columns:[]}async _loadLinks(){if(!this.record){this.links=[];return}this.links=await kiss.data.relations.getLinksAndRecords(this.record.model.id,this.record.id,this.id,this.sort)}async _renderValues(){const viewConfig=this._getViewConfig();await this._loadLinks();const linkButtonId=kiss.tools.shortUid();const hasLinks=this.links.length!=0;const canLinkOtherRecords=hasLinks&&this.multiple!=true?false:true;const showAddButton=this.record&&!this.readOnly&&this.canCreateRecord!==false&&canLinkOtherRecords;const showLinkButton=!this.readOnly&&this.canLinkRecord!==false&&canLinkOtherRecords;const showExpandButton=this.multiple&&hasLinks;const showButtons=showAddButton||showLinkButton||showExpandButton;const linkButtons=!showButtons?"":`\n            <div class="field-link-buttons">\n                ${showAddButton?`<div id="${linkButtonId}" class="a-button field-link-button field-link-button-add"><span class="button-icon fas fa-plus"></span><span class="button-text">${txtTitleCase("new")}</span></div>`:""}\n                ${showLinkButton?`<div class="a-button field-link-button field-link-button-link"><span class="button-icon fas fa-link"></span><span class="button-text">${txtTitleCase("#select link")}</span></div>`:""}\n                ${showExpandButton?`<div class="a-button field-link-button field-link-button-expand"><span class="button-icon fas fa-table"></span><span class="button-text">${txtTitleCase("display as table")}</span></div>`:""}\n            </div>`.removeExtraSpaces();if(!this.record||!hasLinks){this.fieldValues.innerHTML=linkButtons;return}let htmlSeparator=this.stackValues?"<br>":"";const isCompact=this.config.linkStyle=="compact";const displayLabels=!["compact","no labels"].includes(this.config.linkStyle);let fields=this.foreignModel.getActiveFields();let fieldsToDisplay=fields;if(isCompact){const primaryKeyField=this.foreignModel.getPrimaryKeyField();fieldsToDisplay=[primaryKeyField||fields[0]]}else{if(viewConfig.length>0){fieldsToDisplay=viewConfig.filter((column=>column.hidden!=true)).map((column=>fieldsToDisplay.find((field=>field.id==column.id)))).filter((field=>field))}}const badge=isCompact?"":`<div class="field-link-item-badge" style="background: ${this.foreignModel.color}">\n                            <span class="${this.foreignModel.icon}"></span>\n                        </div>`;this.fieldValues.innerHTML=linkButtons+this.links.map((recordInfo=>`<div class="field-link-value ${isCompact?"field-link-value-compact":""}" recordId="${recordInfo.recordId}" linkId="${recordInfo.linkId}" style="border-color: ${this.foreignModel.color}">\n                            ${badge}\n                            <div class="field-link-record" id="field-link-record:${recordInfo.recordId}">\n                                ${this._renderSingleValue(recordInfo.record,fieldsToDisplay,displayLabels)}\n                            </div>\n                            ${this.readOnly||!this.canDeleteLinks?"":`<span class="field-link-value-delete fas fa-times"></span>`}\n                        </div>`.removeExtraSpaces())).join(htmlSeparator)}_renderSingleValue(record,fieldsToDisplay,displayLabels){return fieldsToDisplay.map((field=>{if(field.isSystem)return"";if(field.type=="link")return"";let value=record[field.id];const htmlLabel=displayLabels?`<div class="field-link-item-label">${field.label}</div>`:"";const htmlValue=kiss.fields.renderers[this.foreignModel.id][field.id]({field:field,value:value,record:record});return`<div class="field-link-item">\n                ${htmlLabel}\n                <div class="field-link-item-value">${htmlValue}</div>\n            </div>`})).join("")}async _loadOptions(){if(!this.foreignCollection||!this.config.link.modelId){this.options=[];return}const options=await this.foreignCollection.find();this.options=options.map((record=>record.id))}};customElements.define("a-link",kiss.ux.Link);const createLink=config=>document.createElement("a-link").init(config);kiss.ux.WizardPanel=class WizardPanel extends kiss.ui.Panel{constructor(){super()}init(config){config.id=config.id||"cmp-"+(kiss.global.componentCount++).toString();this.id=config.id;this.currentPage=0;this.numberOfPages=config.items.length;this.pageValidation=!!config.pageValidation;this._initButtons(config);config.items=this._initStructure(config);super.init(config);this._updateTitle();this.classList.add("a-panel");return this}_initHeaderClickEvent(){this.panelHeader.onclick=function(event){const element=event.target;let panel=element.closest("a-wizardpanel");if(element.classList.contains("panel-button-close")){panel.close()}else if(element.classList.contains("panel-button-expand")){panel.maximize(20)}else if(element.classList.contains("panel-button-expand-collapse")||element.classList.contains("panel-header-collapsible")){panel.expandCollapse()}else if((element.classList.contains("panel-title")||element.classList.contains("panel-icon"))&&panel.config.collapsible===true&&panel.config.draggable!==true){panel.expandCollapse()}}}_initStructure(config){const items=[{id:this.id+"-pages",multiview:true,items:config.items},{type:"spacer",flex:1},{id:this.id+"-buttons",layout:"horizontal",defaultConfig:{type:"button",margin:"1rem 0.5rem 0 0",height:"4rem",flex:1},items:[this.buttonCancel,this.numberOfPages>1?this.buttonNext:this.buttonOK]}];return items}_initButtons(config){this.buttonCancel={hidden:config.closable===false,icon:"fas fa-times",text:txtTitleCase("cancel"),action:function(){this.closest("a-wizardpanel").close()}};this.buttonPrevious={icon:"fas fa-chevron-left",text:txtTitleCase("previous"),action:function(){this.closest("a-wizardpanel").previous()}};this.buttonNext={icon:"fas fa-chevron-right",iconPosition:"right",text:txtTitleCase("next"),action:function(){this.closest("a-wizardpanel").next()}};this.buttonOK={icon:"fas fa-check",text:config.actionText||"OK",action:()=>{if(this.pageValidation&&!this.validatePage())return;if(config.action){config.action.bind(this)()}else{this.close()}}}}_updateButtons(){let buttons;if(this.currentPage==0){buttons=[this.buttonCancel,this.numberOfPages>1?this.buttonNext:this.buttonOK]}else if(this.currentPage==this.numberOfPages-1){buttons=[this.buttonPrevious,this.buttonOK]}else{buttons=[this.buttonPrevious,this.buttonNext]}$(this.id+"-buttons").setItems(buttons)}_updateTitle(){this.setTitle(this.currentPage+1+"/"+this.numberOfPages+(this.config.title?" - "+this.config.title:""))}validatePage(pageIndex){this.pages=$(this.id+"-pages").children;if(!this.pages)return true;const currentPage=this.pages[pageIndex||this.currentPage];return currentPage.validate?currentPage.validate():true}next(){if(this.pageValidation&&!this.validatePage())return;this.currentPage++;this._updateButtons();this._updateTitle();$(this.id+"-pages").showItem(this.currentPage,{name:"slideInRight",speed:"faster"});$(this.id).updateLayout()}previous(){this.currentPage--;this._updateButtons();this._updateTitle();$(this.id+"-pages").showItem(this.currentPage,{name:"slideInLeft",speed:"faster"});$(this.id).updateLayout()}};customElements.define("a-wizardpanel",kiss.ux.WizardPanel);const createWizardPanel=config=>document.createElement("a-wizardpanel").init(config);kiss.ux.SelectViewColumn=class SelectViewColumn extends kiss.ui.Select{constructor(){super()}init(config={}){super.init(config);this.viewId=config.viewId;this.fieldId=config.fieldId;return this}async _createOptions(){await this._loadOptions();super._createOptions()}async _loadOptions(){if(this.isLoaded)return;this.options=[];const viewRecord=kiss.app.collections.view.records.find((view=>view.id==this.viewId));const collection=viewRecord.getCollection();await collection.find();this.options=collection.records;if(collection.group.length>0){this.options=this.options.filter((record=>!record.$type))}this.options=this.options.filter((record=>!!record[this.fieldId]));this.options=this.options.map((record=>{const fieldValue=record[this.fieldId];return{value:Array.isArray(fieldValue)?fieldValue[0]:fieldValue}}));this.options=this.options.uniqueObject("value");this.options=this.options.sortBy("value");this.isLoaded=true}};customElements.define("a-selectviewcolumn",kiss.ux.SelectViewColumn);kiss.ux.SelectViewColumns=class SelectViewColumns extends kiss.ui.Select{constructor(){super()}init(config={}){super.init(config);this.viewId=config.viewId;this.collectionId=config.collectionId;this.fieldId=config.fieldId[0];this.otherFieldIds=config.fieldId.slice(1);this.allowValuesNotInList=!!config.allowValuesNotInList;this.onclick=this._handleClick;this._showOptions=()=>{};return this}async _handleClick(event){if(event.target.classList.contains("field-label"))return;this._showView()}async _showView(){const _this=this;let collection,columns,sort,filter,group,viewRecord;if(this.viewId){viewRecord=await kiss.app.collections.view.findOne(this.viewId);this.viewModel=kiss.app.models[viewRecord.modelId];collection=this.viewModel.collection;columns=this.viewModel.getFieldsAsColumns();sort=viewRecord.sort;filter=viewRecord.filter;group=viewRecord.group}else if(this.collectionId){collection=kiss.app.collections[this.collectionId];this.viewModel=kiss.app.models[collection.modelId];columns=this.viewModel.getFieldsAsColumns();sort=[];filter={};group=[]}else{return}const datatable=createDatatable({collection:this.viewModel.collection,sort:sort,filter:filter,group:group,canEdit:false,canSelect:false,canAddField:false,canEditField:false,canCreateRecord:this.allowValuesNotInList,showActions:false,columns:columns,color:this.viewModel.color,height:()=>"calc(100vh - 25rem)",methods:{selectRecord:async function(record){await _this.setValue(record);this.closest("a-panel").close()},async createRecord(model){const record=model.create();const success=await record.save();if(!success)return;createForm(record)}}});createPanel({modal:true,closable:true,title:"<b>"+this.viewModel.namePlural+"</b>",icon:this.viewModel.icon,headerBackgroundColor:this.viewModel.color,display:"flex",layout:"vertical",width:()=>"calc(100vw - 20rem)",height:()=>"calc(100vh - 20rem)",align:"center",verticalAlign:"center",autoSize:true,items:[datatable]}).render()}async setValue(record){let model=this.record.model;let mapping=this.otherFieldIds.map((viewFieldId=>{let label=this.viewModel.getField(viewFieldId).label;let localField=model.getFieldByLabel(label)||{};return{label:label,id:localField.id,viewFieldId:viewFieldId}})).filter((map=>map.id));let update={};update[this.id]=record[this.fieldId];mapping.forEach((map=>{let localField=model.getField(map.id)||{};let recordValue=record[map.viewFieldId];if(kiss.tools.isNumericField(localField)){recordValue=parseFloat(recordValue);if(isNaN(recordValue))recordValue=0}else if(localField.type==="checkbox"){recordValue=!!recordValue}if(recordValue===undefined)recordValue="";update[map.id]=recordValue}));await this.record.updateDeep(update);return this}formatValue(value){if(kiss.tools.isNumericField(this)){recordValue=parseFloat(recordValue);if(isNaN(recordValue))recordValue=0}else if(this.type==="checkbox"){recordValue=!!recordValue}if(recordValue===undefined)recordValue=""}};customElements.define("a-selectviewcolumns",kiss.ux.SelectViewColumns);
//# sourceMappingURL=kissjs.ux.min.js.map